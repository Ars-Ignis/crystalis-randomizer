import { Maze } from './maze.js';
import { GOA1_SCREENS, write2d } from './spec.js';
import { Dir } from './types.js';
import { Flag } from '../rom/location.js';
import { hex } from '../rom/util.js';
import { Monster } from '../rom/monster.js';
export function shuffleGoa1(rom, random, attempts = 1500) {
    extendGoaScreens(rom);
    const loc = rom.locations.goaFortressKelbesque;
    const w = loc.width;
    const h = loc.height;
    OUTER: for (let attempt = 0; attempt < attempts; attempt++) {
        const maze = new Maze(random, h, w, GOA1_SCREENS);
        const entrance = ((h - 1) << 4 | random.nextInt(w));
        const boss = random.nextInt(w);
        const entranceTile = entrance << 8 | 0x02;
        const exitTiles = [(boss + 32) << 8 | 0x01, (boss + 32) << 8 | 0x03];
        function fixed(pos, value) {
            maze.set(pos, value, { force: true });
        }
        fixed(entrance, 0xf0f1);
        fixed(entrance - 1, 0x00f0);
        fixed(entrance + 1, 0xf000);
        fixed(boss, 0xfff0);
        fixed(boss - 1, 0x0ff0);
        fixed(boss + 1, 0xff00);
        fixed(boss + 16, 0xf1ff);
        fixed(boss + 15, 0x00ff);
        fixed(boss + 17, 0xf00f);
        if (!maze.connect(entrance, Dir.UP, boss + 16, Dir.DOWN)) {
            continue OUTER;
        }
        if (maze.get((boss + 32)) === 0x0101 ||
            maze.get((entrance - 16)) === 0x0101)
            continue OUTER;
        for (let i = 0; i < 10 && maze.density() < 0.65; i++) {
            if (maze.addLoop())
                i = 0;
        }
        if (maze.density() < 0.45)
            continue OUTER;
        if (!check())
            continue OUTER;
        for (const [pos, scr] of maze) {
            if (scr === 0x0101 && maze.get((pos + 16)) === 0x0101) {
                const order = random.shuffle([0, 16]);
                if (!tryFlag((pos + order[0]), 131072) &&
                    !tryFlag((pos + order[1]), 131072)) {
                    continue OUTER;
                }
            }
        }
        for (const [pos, alt] of random.shuffle([...maze.alternates()])) {
            tryFlag(pos, alt);
        }
        maze.fillAll({ edge: 0 });
        function check() {
            const traversal = maze.traverse();
            const main = traversal.get(entranceTile);
            if (!main)
                return false;
            if (!exitTiles.filter(t => main.has(t)).length)
                return false;
            if (main.size < 0.8 * traversal.size)
                return false;
            return true;
        }
        function tryFlag(pos, mod = 65536) {
            const prev = maze.get(pos);
            if (prev == null)
                throw new Error(`Cannot flag empty screen ${hex(pos)}`);
            maze.replace(pos, (prev | mod));
            if (check())
                return true;
            maze.replace(pos, prev);
            return false;
        }
        loc.moveScreen(0x06, boss);
        loc.moveScreen(0x83, entrance);
        maze.write(loc, new Set());
        const monsterPlacer = loc.monsterPlacer(random);
        for (const spawn of loc.spawns) {
            if (!spawn.isMonster())
                continue;
            const monster = rom.objects[spawn.monsterId];
            if (!(monster instanceof Monster))
                continue;
            const pos = monsterPlacer(monster);
            if (pos == null) {
                console.error(`no valid location for ${hex(monster.id)} in ${hex(loc.id)}`);
                spawn.used = false;
                continue;
            }
            else {
                spawn.screen = pos >>> 8;
                spawn.tile = pos & 0xff;
            }
        }
        if (rom.spoiler)
            rom.spoiler.addMaze(loc.id, loc.name, maze.show());
        return;
    }
    throw new Error(`unable to shuffle goa1 after ${attempts} attempts`);
}
export function extendGoaScreens(rom) {
    for (const t of [0x8c, 0xa4, 0xa8]) {
        const ts = rom.tileset(t);
        ts.alternates[0x19] = 0x19;
        ts.alternates[0x1b] = 0x1b;
    }
    rom.swapMetatiles([0xa4, 0x8c], [0x2b, [0x19, 0xc5], ~0xc6], [0xba, [0x1b, 0xc5], ~0xc4]);
    rom.swapMetatiles([0xa8], [[0x17, 0x54], ~0x19], [[0x18, 0x58], ~0x1b]);
    rom.swapMetatiles([0x88], [0x19, ~0xc5], [0x1b, ~0xc5]);
    const w = [[0x19, 0x19], [0x1b, 0x1b]];
    write2d(rom.screens[0xe0].tiles, 0x61, w);
    write2d(rom.screens[0xe1].tiles, 0x6d, w);
    write2d(rom.screens[0xe2].tiles, 0x91, w);
    write2d(rom.screens[0xe3].tiles, 0x9d, w);
    write2d(rom.screens[0xe4].tiles, 0x41, w);
    write2d(rom.screens[0xe4].tiles, 0x8d, w);
    write2d(rom.screens[0xe5].tiles, 0x61, w);
    write2d(rom.screens[0xe5].tiles, 0xad, w);
    write2d(rom.screens[0xe6].tiles, 0x0d, w);
    write2d(rom.screens[0xe6].tiles, 0xd1, w);
    write2d(rom.screens[0xe7].tiles, 0x01, w);
    write2d(rom.screens[0xe7].tiles, 0x0d, w);
    write2d(rom.screens[0xe8].tiles, 0xd1, w);
    write2d(rom.screens[0xe8].tiles, 0xdd, w);
    rom.locations[0xa9].flags.push(Flag.of({ screen: 0x10, flag: 0x2ef }), Flag.of({ screen: 0x20, flag: 0x2ef }), Flag.of({ screen: 0x21, flag: 0x2ef }), Flag.of({ screen: 0x24, flag: 0x2ef }), Flag.of({ screen: 0x25, flag: 0x2ef }), Flag.of({ screen: 0x30, flag: 0x2ef }), Flag.of({ screen: 0x31, flag: 0x2ef }), Flag.of({ screen: 0x33, flag: 0x2ef }), Flag.of({ screen: 0x34, flag: 0x2ef }), Flag.of({ screen: 0x41, flag: 0x2ef }), Flag.of({ screen: 0x54, flag: 0x2ef }), Flag.of({ screen: 0x62, flag: 0x2ef }), Flag.of({ screen: 0x64, flag: 0x2ef }), Flag.of({ screen: 0x72, flag: 0x2ef }), Flag.of({ screen: 0x74, flag: 0x200 }));
    rom.locations.waterfallCave3.tileset = 0x88;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL21hemUvZ29hLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDL0IsT0FBTyxFQUFDLFlBQVksRUFBRSxPQUFPLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDaEQsT0FBTyxFQUFDLEdBQUcsRUFBVyxNQUFNLFlBQVksQ0FBQztBQUd6QyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDeEMsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUUxQyxNQUFNLFVBQVUsV0FBVyxDQUFDLEdBQVEsRUFBRSxNQUFjLEVBQUUsUUFBUSxHQUFHLElBQUk7SUFFbkUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdEIsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQztJQUMvQyxNQUFNLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO0lBQ3BCLE1BQU0sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFJckIsS0FBSyxFQUNMLEtBQUssSUFBSSxPQUFPLEdBQUcsQ0FBQyxFQUFFLE9BQU8sR0FBRyxRQUFRLEVBQUUsT0FBTyxFQUFFLEVBQUU7UUFDbkQsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFHbEQsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBUSxDQUFDO1FBQzNELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxP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akMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBVSxDQUFDO0lBQ2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQVExQyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQzFCLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLENBQUMsQ0FBQztJQUsxQyxHQUFHLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0FBQzlDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01hemV9IGZyb20gJy4vbWF6ZS5qcyc7XG5pbXBvcnQge0dPQTFfU0NSRUVOUywgd3JpdGUyZH0gZnJvbSAnLi9zcGVjLmpzJztcbmltcG9ydCB7RGlyLCBQb3MsIFNjcn0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQge1JhbmRvbX0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtGbGFnfSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHtoZXh9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7TW9uc3Rlcn0gZnJvbSAnLi4vcm9tL21vbnN0ZXIuanMnO1xuXG5leHBvcnQgZnVuY3Rpb24gc2h1ZmZsZUdvYTEocm9tOiBSb20sIHJhbmRvbTogUmFuZG9tLCBhdHRlbXB0cyA9IDE1MDApOiB2b2lkIHtcbiAgLy8gTk9URTogYWxzbyBuZWVkIHRvIG1vdmUgZW5lbWllcy4uLlxuICBleHRlbmRHb2FTY3JlZW5zKHJvbSk7XG4gIGNvbnN0IGxvYyA9IHJvbS5sb2NhdGlvbnMuZ29hRm9ydHJlc3NLZWxiZXNxdWU7XG4gIGNvbnN0IHcgPSBsb2Mud2lkdGg7XG4gIGNvbnN0IGggPSBsb2MuaGVpZ2h0O1xuXG4gIC8vIFRPRE8gLSBjb25zaWRlciBiaWdnZXIgaWNvbnM/ICfilJjilZHilJRcXG7ilZDilazilZBcXG7ilJDilZHilIwnIG9yICfilJjilIPilJRcXG7ilIHilYvilIFcXG7ilJDilIPilIwnID8/XG5cbiAgT1VURVI6XG4gIGZvciAobGV0IGF0dGVtcHQgPSAwOyBhdHRlbXB0IDwgYXR0ZW1wdHM7IGF0dGVtcHQrKykge1xuICAgIGNvbnN0IG1hemUgPSBuZXcgTWF6ZShyYW5kb20sIGgsIHcsIEdPQTFfU0NSRUVOUyk7XG5cbiAgICAvLyBQbGFjZSB0aGUgZW50cmFuY2UgYXQgdGhlIGJvdHRvbSwgYm9zcyBhdCB0b3AuXG4gICAgY29uc3QgZW50cmFuY2UgPSAoKGggLSAxKSA8PCA0IHwgcmFuZG9tLm5leHRJbnQodykpIGFzIFBvcztcbiAgICBjb25zdCBib3NzID0gcmFuZG9tLm5leHRJbnQodykgYXMgUG9zO1xuXG4gICAgY29uc3QgZW50cmFuY2VUaWxlID0gZW50cmFuY2UgPDwgOCB8IDB4MDI7XG4gICAgY29uc3QgZXhpdFRpbGVzID0gWyhib3NzICsgMzIpIDw8IDggfCAweDAxLCAoYm9zcyArIDMyKSA8PCA4IHwgMHgwM107XG5cbiAgICBmdW5jdGlvbiBmaXhlZChwb3M6IG51bWJlciwgdmFsdWU6IG51bWJlcikge1xuICAgICAgbWF6ZS5zZXQocG9zIGFzIFBvcywgdmFsdWUgYXMgU2NyLCB7Zm9yY2U6IHRydWV9KTsgLy8gTk9URTogbm8gY2hlY2sgT09CXG4gICAgfVxuXG4gICAgZml4ZWQoZW50cmFuY2UsIDB4ZjBmMSk7XG4gICAgZml4ZWQoZW50cmFuY2UgLSAxLCAweDAwZjApO1xuICAgIGZpeGVkKGVudHJhbmNlICsgMSwgMHhmMDAwKTtcbiAgICBmaXhlZChib3NzLCAweGZmZjApO1xuICAgIGZpeGVkKGJvc3MgLSAxLCAweDBmZjApO1xuICAgIGZpeGVkKGJvc3MgKyAxLCAweGZmMDApO1xuICAgIGZpeGVkKGJvc3MgKyAxNiwgMHhmMWZmKTtcbiAgICBmaXhlZChib3NzICsgMTUsIDB4MDBmZik7XG4gICAgZml4ZWQoYm9zcyArIDE3LCAweGYwMGYpO1xuXG4gICAgLy8gY29uc29sZS5sb2coYGluaXRpYWxcXG4ke21hemUuc2hvdygpfWApO1xuXG4gICAgLy8gbWFrZSB0aGUgaW5pdGlhbCBwYXRoIGZyb20gdGhlIGVudHJhbmNlIHRvIHRoZSBib3NzXG4gICAgaWYgKCFtYXplLmNvbm5lY3QoZW50cmFuY2UgYXMgUG9zLCBEaXIuVVAsIGJvc3MgKyAxNiBhcyBQb3MsIERpci5ET1dOKSkge1xuICAgICAgY29udGludWUgT1VURVI7XG4gICAgfVxuICAgIC8vIGRvbid0IGFsbG93IGEgZGlyZWN0IGZvcndhcmQgZW50cmFuY2VcbiAgICBpZiAobWF6ZS5nZXQoKGJvc3MgKyAzMikgYXMgUG9zKSA9PT0gMHgwMTAxIHx8XG4gICAgICAgIG1hemUuZ2V0KChlbnRyYW5jZSAtIDE2KSBhcyBQb3MpID09PSAweDAxMDEpIGNvbnRpbnVlIE9VVEVSO1xuICAgIC8vY29uc29sZS5sb2coJ2ZpcnN0JywgbWF6ZS5zaG93KCkpO1xuXG4gICAgLy8gYWRkIGFuIGV4dHJhIHBhdGggdW50aWwgd2UgZmFpbCAxMCB0aW1lc1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTAgJiYgbWF6ZS5kZW5zaXR5KCkgPCAwLjY1OyBpKyspIHtcbiAgICAgIGlmIChtYXplLmFkZExvb3AoKSkgaSA9IDA7XG4gICAgfVxuICAgIC8vY29uc29sZS5sb2coYGxvb3BcXG4ke21hemUuc2hvdygpfWApO1xuXG4gICAgLy8gRW5zdXJlIGEgbWluaW11bSBkZW5zaXR5XG4gICAgaWYgKG1hemUuZGVuc2l0eSgpIDwgMC40NSkgY29udGludWUgT1VURVI7XG5cbiAgICAvLyBOb3cgc3RhcnQgYWRkaW5nIHdhbGxzIGFuZCBlbnN1cmUgdGhlIG1hemUgaXMgY29tcGxldGVhYmxlLlxuICAgIC8vIEluIHBhcnRpY3VsYXIsIHdlIG5lZWQgdG8gY29udmVydCBzb21lIG9mIHRoZSB2ZXJ0aWNhbCBoYWxsd2F5c1xuICAgIC8vIGludG8gZWl0aGVyIHN0YWlyd2F5cyBvciBkZWFkIGVuZHMuXG4gICAgLy8gVGhlIGJhc2ljIHN0cmF0ZWd5IGF0IHRoaXMgcG9pbnQgaXMgdG8gbWFrZSB0aGUgbWFwIGFzIG9wZW4gYXNcbiAgICAvLyBwb3NzaWJsZSwgY291bnQgdGhlIG51bWJlciBvZiByZWFjaGFibGUgdGlsZXMsIGFuZCB0aGVuIGFkZFxuICAgIC8vIHdhbGxzIHVudGlsIHdlIGNhbid0IGRvIHNvIGFueSBtb3JlIHdpdGhvdXQgbWFraW5nIHNvbWVcbiAgICAvLyBwcmV2aW91c2x5LXJlYWNoYWJsZSB0aWxlIHVucmVhY2hhYmxlLiAgQXQgdGhhdCBwb2ludCwgdHJ5IGV2ZXJ5XG4gICAgLy8gd2FsbCBvbmNlIG1vcmUgYW5kIHRoZW4gcXVpdC5cblxuICAgIGlmICghY2hlY2soKSkgY29udGludWUgT1VURVI7XG5cbiAgICAvLyBGaW5kIGFueSB2ZXJ0aWNhbGx5LWFkamFjZW50IDAxMDEgYW5kIHRyeSB0byBtYWtlIHRoZW0gaW50byAyMDEwMVxuICAgIGZvciAoY29uc3QgW3Bvcywgc2NyXSBvZiBtYXplKSB7XG4gICAgICBpZiAoc2NyID09PSAweDAxMDEgJiYgbWF6ZS5nZXQoKHBvcyArIDE2KSBhcyBQb3MpID09PSAweDAxMDEpIHtcbiAgICAgICAgY29uc3Qgb3JkZXIgPSByYW5kb20uc2h1ZmZsZShbMCwgMTZdKTtcbiAgICAgICAgaWYgKCF0cnlGbGFnKChwb3MgKyBvcmRlclswXSkgYXMgUG9zLCAweDJfMDAwMCkgJiZcbiAgICAgICAgICAgICF0cnlGbGFnKChwb3MgKyBvcmRlclsxXSkgYXMgUG9zLCAweDJfMDAwMCkpIHtcbiAgICAgICAgICBjb250aW51ZSBPVVRFUjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFRyeSBhbGwgcG9zc2libGUgYWx0ZXJuYXRlcywgc2tpcHBpbmcgYW55IHRoYXQgZG9uJ3Qgd29yay5cbiAgICAvLyBUT0RPIC0gaXMgaXQgZXZlciBwb3NzaWJsZSB0aGF0IGNvbWluZyBiYWNrIHRvIG9uZSBsYXRlciBfd2lsbF8gd29yaz9cbiAgICAvLyAgICAgIC0tLT4gbWF5YmUsIGRlcGVuZGluZyBvbiBob3cgdGhleSdyZSBhcnJhbmdlZC4gIEluIG91ciBjYXNlLFxuICAgIC8vICAgICAgICAgICAwMTAxID0+IDEyMzlhYjsgMTAxMDEgPT4gMTJhYjsgMjAxMDEgPT4gMTM5YjsgMzAxMDEgPT4gMzlcbiAgICAvLyAgICAgICAgICAgc28gMCAtPiAxIC0+IDMgTUlHSFQgb3BlbiBhIHBhdGgsIGJ1dCAyIHNob3VsZCBoYXZlIHBhc3NlZC4uLj9cblxuICAgIGZvciAoY29uc3QgW3BvcywgYWx0XSBvZiByYW5kb20uc2h1ZmZsZShbLi4ubWF6ZS5hbHRlcm5hdGVzKCldKSkge1xuICAgICAgdHJ5RmxhZyhwb3MsIGFsdCk7XG4gICAgfVxuXG4gICAgbWF6ZS5maWxsQWxsKHtlZGdlOiAwfSk7XG5cbiAgICBmdW5jdGlvbiBjaGVjaygpOiBib29sZWFuIHtcbiAgICAgIGNvbnN0IHRyYXZlcnNhbCA9IG1hemUudHJhdmVyc2UoKTtcbiAgICAgIC8vKHdpbmRvdyBhcyBhbnkpLlRSQVYgPSB0cmF2ZXJzYWw7XG5cbiAgICAgIGNvbnN0IG1haW4gPSB0cmF2ZXJzYWwuZ2V0KGVudHJhbmNlVGlsZSk7XG4gICAgICBpZiAoIW1haW4pIHJldHVybiBmYWxzZTtcbiAgICAgIGlmICghZXhpdFRpbGVzLmZpbHRlcih0ID0+IG1haW4uaGFzKHQpKS5sZW5ndGgpIHJldHVybiBmYWxzZTtcbiAgICAgIGlmIChtYWluLnNpemUgPCAwLjggKiB0cmF2ZXJzYWwuc2l6ZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdHJ5RmxhZyhwb3M6IFBvcywgbW9kID0gMHgxXzAwMDApOiBib29sZWFuIHtcbiAgICAgIGNvbnN0IHByZXYgPSBtYXplLmdldChwb3MpO1xuICAgICAgaWYgKHByZXYgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZmxhZyBlbXB0eSBzY3JlZW4gJHtoZXgocG9zKX1gKTtcbiAgICAgIG1hemUucmVwbGFjZShwb3MsIChwcmV2IHwgbW9kKSBhcyBTY3IpO1xuICAgICAgaWYgKGNoZWNrKCkpIHJldHVybiB0cnVlO1xuICAgICAgbWF6ZS5yZXBsYWNlKHBvcywgcHJldik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgbG9jLm1vdmVTY3JlZW4oMHgwNiwgYm9zcyk7XG4gICAgbG9jLm1vdmVTY3JlZW4oMHg4MywgZW50cmFuY2UpO1xuXG4gICAgbWF6ZS53cml0ZShsb2MsIG5ldyBTZXQoKSk7XG5cbiAgICBjb25zdCBtb25zdGVyUGxhY2VyID0gbG9jLm1vbnN0ZXJQbGFjZXIocmFuZG9tKTtcbiAgICBmb3IgKGNvbnN0IHNwYXduIG9mIGxvYy5zcGF3bnMpIHtcbiAgICAgIGlmICghc3Bhd24uaXNNb25zdGVyKCkpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgbW9uc3RlciA9IHJvbS5vYmplY3RzW3NwYXduLm1vbnN0ZXJJZF07XG4gICAgICBpZiAoIShtb25zdGVyIGluc3RhbmNlb2YgTW9uc3RlcikpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgcG9zID0gbW9uc3RlclBsYWNlcihtb25zdGVyKTtcbiAgICAgIGlmIChwb3MgPT0gbnVsbCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBubyB2YWxpZCBsb2NhdGlvbiBmb3IgJHtoZXgobW9uc3Rlci5pZCl9IGluICR7aGV4KGxvYy5pZCl9YCk7XG4gICAgICAgIHNwYXduLnVzZWQgPSBmYWxzZTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzcGF3bi5zY3JlZW4gPSBwb3MgPj4+IDg7XG4gICAgICAgIHNwYXduLnRpbGUgPSBwb3MgJiAweGZmO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGNvbnNvbGUubG9nKGBzdWNjZXNzIGFmdGVyICR7YXR0ZW1wdH0gYXR0ZW1wdHNgKTtcbiAgICAvLyBjb25zb2xlLmxvZyhtYXplLnNob3coKSk7XG4gICAgaWYgKHJvbS5zcG9pbGVyKSByb20uc3BvaWxlci5hZGRNYXplKGxvYy5pZCwgbG9jLm5hbWUsIG1hemUuc2hvdygpKTtcbiAgICByZXR1cm47XG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoYHVuYWJsZSB0byBzaHVmZmxlIGdvYTEgYWZ0ZXIgJHthdHRlbXB0c30gYXR0ZW1wdHNgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4dGVuZEdvYVNjcmVlbnMocm9tOiBSb20pIHtcbiAgLy8gUExBTjpcbiAgLy8gdGlsZXNldCBhNCw4YzogbW92ZSAxOSwxYiAtPiAyYixiYVxuICAvLyB0aWxlc2V0IGE4OiAgICBtb3ZlIDE5LDFiIC0+IDE3LDE4XG4gIC8vIHRpbGVzZXQgODg6ICAgIG1vdmUgYzUgLT4gMTksMWJcbiAgLy8gICAgIDE3LDE4IHVzZWQgaW4gODgsIHdoaWNoIHNoYXJlcyBhIGxvdCB3aXRoIGE4LCBidXRcbiAgLy8gICAgIG5vIDg4IG1hcHMgaGF2ZSBhbnkgMTksMWIgc28gdGhleSdsbCBuZXZlciBzZWUgY29uZmxpY3RpbmcgMTcsMThcbiAgLy8gY2hhbmdlIHRoZSA4OCB1c2VycyBvZiBlMSxlMiAoaHlkcmEpIHRvIHRpbGVzZXQgYTggd2l0aCBwYXQxPTJhIHRvIGF2b2lkXG4gIC8vIGNvbmZsaWN0PyAgdGhlIGNvc3QgaXMgb25lIHdhbGwgdGhhdCBkb2Vzbid0IGZpdCBpbiBxdWl0ZSBhcyB3ZWxsLlxuICAvLyBUaGlzIGZyZWVzIHVwIDE5LDFiIHRvIGFic29yYiBjNi9jNCB3aXRoIGFsdHMgb2YgYzVcbiAgXG4gIGZvciAoY29uc3QgdCBvZiBbMHg4YywgMHhhNCwgMHhhOF0pIHsgLy8gZ2V0IGFyb3VuZCBjaGVja1xuICAgIGNvbnN0IHRzID0gcm9tLnRpbGVzZXQodCk7XG4gICAgdHMuYWx0ZXJuYXRlc1sweDE5XSA9IDB4MTk7XG4gICAgdHMuYWx0ZXJuYXRlc1sweDFiXSA9IDB4MWI7XG4gIH1cbiAgcm9tLnN3YXBNZXRhdGlsZXMoWzB4YTQsIDB4OGNdLFxuICAgICAgICAgICAgICAgICAgICBbMHgyYiwgWzB4MTksIDB4YzVdLCB+MHhjNl0sXG4gICAgICAgICAgICAgICAgICAgIFsweGJhLCBbMHgxYiwgMHhjNV0sIH4weGM0XSk7XG4gIHJvbS5zd2FwTWV0YXRpbGVzKFsweGE4XSxcbiAgICAgICAgICAgICAgICAgICAgW1sweDE3LCAweDU0XSwgfjB4MTldLFxuICAgICAgICAgICAgICAgICAgICBbWzB4MTgsIDB4NThdLCB+MHgxYl0pO1xuICByb20uc3dhcE1ldGF0aWxlcyhbMHg4OF0sXG4gICAgICAgICAgICAgICAgICAgIFsweDE5LCB+MHhjNV0sXG4gICAgICAgICAgICAgICAgICAgIFsweDFiLCB+MHhjNV0pO1xuXG4gIC8vIFNjcmVlbnMgdGhhdCBjYW4gbm93IGJlIG9wZW5lZCBvciBzaHV0ICgqIG1lYW5zIGN1cnJlbnRseSBzaHV0KTpcbiAgLy8gICBlMCwgZTEqLCBlMiwgZTMqLCBlNCwgZTUsIGU2LCBlNywgZTgqKlxuICAvLyBXZSBuZWVkIHRvIHBpY2sgd2hpY2ggd2FsbChzKSBhcmUgdG9nZ2xlZC4uLlxuICBcbiAgY29uc3QgdyA9IFtbMHgxOSwgMHgxOV0sIFsweDFiLCAweDFiXV0gYXMgY29uc3Q7XG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlMF0udGlsZXMsIDB4NjEsIHcpOyAvLyBvcGVuIHVwICh3aWRlKSwgcmlnaHQgKHZhbmlsbGEgb3BlbilcbiAgd3JpdGUyZChyb20uc2NyZWVuc1sweGUxXS50aWxlcywgMHg2ZCwgdyk7IC8vIG9wZW4gdXAgKHdpZGUpLCBsZWZ0ICh2YW5pbGxhIHNodXQpXG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlMl0udGlsZXMsIDB4OTEsIHcpOyAvLyBvcGVuIGRvd24gKHdpZGUpLCByaWdodCAodmFuaWxsYSBvcGVuKVxuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTNdLnRpbGVzLCAweDlkLCB3KTsgLy8gb3BlbiBkb3duICh3aWRlKSwgbGVmdCAodmFuaWxsYSBzaHV0KVxuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTRdLnRpbGVzLCAweDQxLCB3KTsgLy8gc3RhaXJzXG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlNF0udGlsZXMsIDB4OGQsIHcpO1xuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTVdLnRpbGVzLCAweDYxLCB3KTsgLy8gaG9yaXpvbnRhbCB3YWxsXG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlNV0udGlsZXMsIDB4YWQsIHcpO1xuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTZdLnRpbGVzLCAweDBkLCB3KTsgLy8gZm91ci13YXkgcGFzc2FnZXNcbiAgd3JpdGUyZChyb20uc2NyZWVuc1sweGU2XS50aWxlcywgMHhkMSwgdyk7XG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlN10udGlsZXMsIDB4MDEsIHcpOyAvLyBjb3JuZXJzIHVwIHRvcFxuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTddLnRpbGVzLCAweDBkLCB3KTtcbiAgd3JpdGUyZChyb20uc2NyZWVuc1sweGU4XS50aWxlcywgMHhkMSwgdyk7IC8vIGNvcm5lcnMgb24gYm90dG9tXG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlOF0udGlsZXMsIDB4ZGQsIHcpO1xuXG4gIC8vIFRvIG1haW50YWluIGN1cnJlbnQgYmVoYXZpb3Igd2UgbmVlZCB0byBwdXNoIGZsYWdzIGZvciBhbGwgdGhlXG4gIC8vIHNjcmVlbnMgdGhhdCBuZWVkIHRvIGJlICpvcGVuKi5cblxuICAvLyBOT1RFOiBhZnRlciB0ZXN0aW5nLCBvbmx5IG5vcm1hbGx5LW9wZW4gdGlsZXMgbmVlZCBmbGFncy4uLj9cbiAgLy8gICAtIGp1c3QgbWFrZSBhIGxpc3QgYW5kIGl0ZXJhdGUgb3ZlciBcblxuICByb20ubG9jYXRpb25zWzB4YTldLmZsYWdzLnB1c2goXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MTAsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MjAsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MjEsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MjQsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MjUsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MzAsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MzEsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MzMsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4MzQsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4NDEsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4NTQsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4NjIsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4NjQsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4NzIsIGZsYWc6IDB4MmVmfSksXG4gICAgICBGbGFnLm9mKHtzY3JlZW46IDB4NzQsIGZsYWc6IDB4MjAwfSkpO1xuXG4gIC8vIFRoaXMgZGVmYXVsdHMgdG8gYTgsIGJ1dCB0aGF0IGRvZXNuJ3Qgd29yayBmb3Igd2lkZSBzY3JlZW5zLlxuICAvLyBXZSBzaG91bGQgbWFrZSBzdXJlIHRoaXMgZG9lc24ndCBicmVhayBwYXJ0aXRpb25zIGZvciBtdXNpY1xuICAvLyBhbmQvb3IgcGFsZXR0ZSBzaHVmZmxlcy5cbiAgcm9tLmxvY2F0aW9ucy53YXRlcmZhbGxDYXZlMy50aWxlc2V0ID0gMHg4ODtcbn1cbiJdfQ==