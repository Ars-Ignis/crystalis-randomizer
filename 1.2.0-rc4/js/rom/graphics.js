import { DefaultMap } from '../util.js';
import { ACTION_SCRIPTS, Monster } from './monster.js';
import { Constraint } from './constraint.js';
export class Graphics {
    constructor(rom) {
        this.rom = rom;
        this.monsterConstraints = new Map();
        this.npcConstraints = new Map();
        this.allSpritePalettes = new Set();
        const allSpawns = new DefaultMap(() => []);
        for (const l of rom.locations) {
            if (!l.used)
                continue;
            for (let i = 0; i < l.spawns.length; i++) {
                const s = l.spawns[i];
                if (!s.used)
                    continue;
                if (s.isMonster()) {
                    allSpawns.get(s.monsterId).push([l, i, s]);
                }
                else if (s.isNpc() || s.isBoss()) {
                    allSpawns.get(~s.id).push([l, i, s]);
                }
            }
        }
        for (const [m, spawns] of allSpawns) {
            if (m < 0) {
                const npc = rom.npcs[~m];
                const metaspriteIds = [npc.data[3]];
                const metasprite = rom.metasprites[metaspriteIds[0]];
                if (!metasprite)
                    throw new Error(`bad NPC: ${~m}`);
                if (npc.data[2] === 0xd0)
                    metaspriteIds.push(0xc0);
                const offset = npc.data[2] < 0x80 ? npc.data[2] & 0x70 : 0;
                let constraint = this.computeConstraint(metaspriteIds, spawns, true, offset);
                if (~m === 0x5f)
                    constraint = constraint.ignorePalette();
                this.npcConstraints.set(~m, constraint);
            }
            else {
                let constraint = Constraint.ALL;
                const parent = this.rom.objects[m];
                if (!(parent instanceof Monster)) {
                    throw new Error(`expected monster: ${parent} from ${spawns}`);
                }
                for (const obj of allObjects(rom, parent)) {
                    const action = ACTION_SCRIPTS.get(obj.action);
                    const metaspriteFn = action && action.metasprites || (() => [obj.metasprite]);
                    const child = this.computeConstraint(metaspriteFn(obj), spawns, obj.id === m, obj.data[1]);
                    const meet = constraint.meet(child);
                    if (!meet)
                        throw new Error(`Bad meet for ${m} with ${obj.id}`);
                    if (meet)
                        constraint = meet;
                }
                this.monsterConstraints.set(parent.id, constraint);
                parent.constraint = constraint;
            }
        }
    }
    getMonsterConstraint(locationId, monsterId) {
        const c = this.monsterConstraints.get(monsterId) || Constraint.NONE;
        if ((locationId & 0x58) === 0x58)
            return c;
        const m = this.rom.objects[monsterId].goldDrop;
        if (!m)
            return c;
        return c.meet(Constraint.COIN) || Constraint.NONE;
    }
    getNpcConstraint(locationId, npcId) {
        const c = this.npcConstraints.get(npcId) || Constraint.NONE;
        if (locationId === 0x1e && npcId === 0x60) {
            return c.meet(Constraint.STOM_FIGHT);
        }
        else if (locationId === 0xa0 && npcId === 0xc9) {
            return c.meet(Constraint.GUARDIAN_STATUE);
        }
        return c;
    }
    shufflePalettes(random) {
        const pal = [...this.allSpritePalettes];
        for (const [k, c] of this.monsterConstraints) {
            this.monsterConstraints.set(k, c.shufflePalette(random, pal));
        }
        for (const [k, c] of this.npcConstraints) {
            this.npcConstraints.set(k, c.shufflePalette(random, pal));
        }
    }
    configure(location, spawn) {
        if (!spawn.used)
            return;
        const c = spawn.isMonster() ? this.monsterConstraints.get(spawn.monsterId) :
            spawn.isNpc() ? this.npcConstraints.get(spawn.id) :
                spawn.isChest() ? (spawn.id < 0x70 ? Constraint.TREASURE_CHEST :
                    Constraint.MIMIC) :
                    undefined;
        if (!c)
            return;
        if (c.shift === 3 || c.float.length >= 2) {
            throw new Error(`don't know what to do with two floats`);
        }
        else if (!c.float.length) {
            spawn.patternBank = Number(c.shift === 2);
        }
        else if (c.float[0].has(location.spritePatterns[0])) {
            spawn.patternBank = 0;
        }
        else if (c.float[0].has(location.spritePatterns[1])) {
            spawn.patternBank = 1;
        }
        else if (spawn.isMonster()) {
            throw new Error(`no matching pattern bank`);
        }
    }
    computeConstraint(metaspriteIds, spawns, shiftable, offset = 0) {
        const patterns = new Set();
        const palettes = new Set();
        for (const metasprite of metaspriteIds.map(s => this.rom.metasprites[s])) {
            for (const p of metasprite.palettes()) {
                palettes.add(p);
            }
            for (const p of metasprite.patternBanks(offset)) {
                patterns.add(p);
            }
        }
        shiftable = shiftable && patterns.size == 1 && [...patterns][0] === 2;
        const locs = new Map();
        for (const [l, , spawn] of spawns) {
            locs.set(spawn.patternBank && shiftable ? ~l.id : l.id, spawn);
        }
        let child = undefined;
        for (let [l, spawn] of locs) {
            const loc = this.rom.locations[l < 0 ? ~l : l];
            for (const pal of palettes) {
                if (pal > 1)
                    this.allSpritePalettes.add(loc.spritePalettes[pal - 2]);
            }
            const c = Constraint.fromSpawn(palettes, patterns, loc, spawn, shiftable);
            child = child ? child.join(c) : c;
            if (!shiftable && spawn.patternBank)
                child = child.shifted();
        }
        if (!child)
            throw new Error(`Expected child to appear`);
        return child;
    }
}
function* allObjects(rom, parent) {
    yield parent;
    const repl = parent.spawnedReplacement();
    if (repl)
        yield* allObjects(rom, repl);
    const child = parent.spawnedChild();
    if (child)
        yield* allObjects(rom, child);
    if (parent.id === 0x50)
        yield rom.objects[0x5f];
    if (parent.id === 0x53)
        yield rom.objects[0x69];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL2dyYXBoaWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFFdEMsT0FBTyxFQUFDLGNBQWMsRUFBRSxPQUFPLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDckQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBUTNDLE1BQU0sT0FBTyxRQUFRO0lBT25CLFlBQXFCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBTHJCLHVCQUFrQixHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQ25ELG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFFdkQsc0JBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUtwQyxNQUFNLFNBQVMsR0FDWCxJQUFJLFVBQVUsQ0FBb0QsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFaEYsS0FBSyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQzdCLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSTtnQkFBRSxTQUFTO1lBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJO29CQUFFLFNBQVM7Z0JBQ3RCLElBQUksQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO29CQUNqQixTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFF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LENBQUMsT0FBTyxDQUFDLElBQUksQ0FBWSxDQUFDO0FBQzdELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RGVmYXVsdE1hcH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5pbXBvcnQge0xvY2F0aW9uLCBTcGF3bn0gZnJvbSAnLi9sb2NhdGlvbi5qcyc7XG5pbXBvcnQge0FDVElPTl9TQ1JJUFRTLCBNb25zdGVyfSBmcm9tICcuL21vbnN0ZXIuanMnO1xuaW1wb3J0IHtDb25zdHJhaW50fSBmcm9tICcuL2NvbnN0cmFpbnQuanMnO1xuaW1wb3J0IHtSYW5kb219IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLy8gVGhpcyBhY3R1YWxseSBhcHBlYXJzIHRvIGJlIG1vcmUgb2YgYSBHcmFwaGljc0NvbnN0cmFpbnRzIGNsYXNzP1xuLy8gICAtIG1heWJlIGRvbid0IHN0b3JlIHRoZSBjb25zdHJhaW50cyBvbiBNb25zdGVyP1xuXG5leHBvcnQgY2xhc3MgR3JhcGhpY3Mge1xuXG4gIHByaXZhdGUgbW9uc3RlckNvbnN0cmFpbnRzID0gbmV3IE1hcDxudW1iZXIsIENvbnN0cmFpbnQ+KCk7XG4gIHByaXZhdGUgbnBjQ29uc3RyYWludHMgPSBuZXcgTWFwPG51bWJlciwgQ29uc3RyYWludD4oKTtcblxuICBhbGxTcHJpdGVQYWxldHRlcyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tKSB7XG4gICAgLy8gSXRlcmF0ZSBvdmVyIGxvY2F0aW9ucy9zcGF3bnMgdG8gYnVpbGQgbXVsdGltYXAgb2Ygd2hlcmUgbW9uc3RlcnMgYXBwZWFyLlxuICAgIC8vIFBvc3RpdmUga2V5cyBhcmUgbW9uc3RlcnMsIG5lZ2F0aXZlIGtleXMgYXJlIE5QQ3MuXG4gICAgY29uc3QgYWxsU3Bhd25zID1cbiAgICAgICAgbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBBcnJheTxyZWFkb25seSBbTG9jYXRpb24sIG51bWJlciwgU3Bhd25dPj4oKCkgPT4gW10pO1xuXG4gICAgZm9yIChjb25zdCBsIG9mIHJvbS5sb2NhdGlvbnMpIHtcbiAgICAgIGlmICghbC51c2VkKSBjb250aW51ZTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbC5zcGF3bnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgcyA9IGwuc3Bhd25zW2ldO1xuICAgICAgICBpZiAoIXMudXNlZCkgY29udGludWU7XG4gICAgICAgIGlmIChzLmlzTW9uc3RlcigpKSB7XG4gICAgICAgICAgYWxsU3Bhd25zLmdldChzLm1vbnN0ZXJJZCkucHVzaChbbCwgaSwgc10pO1xuICAgICAgICB9IGVsc2UgaWYgKHMuaXNOcGMoKSB8fCBzLmlzQm9zcygpKSB7XG4gICAgICAgICAgYWxsU3Bhd25zLmdldCh+cy5pZCkucHVzaChbbCwgaSwgc10pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIC8vIEZvciBlYWNoIG1vbnN0ZXIsIGRldGVybWluZSB3aGljaCBwYXR0ZXJucyBhbmQgcGFsZXR0ZXMgYXJlIHVzZWQuXG4gICAgZm9yIChjb25zdCBbbSwgc3Bhd25zXSBvZiBhbGxTcGF3bnMpIHtcbiAgICAgIC8vIFRPRE8gLSBmb2xkIGludG8gcGF0Y2guc2h1ZmZsZU1vbnN0ZXJzXG4gICAgICAvL2lmIChtID09PSAwKSBjb250aW51ZTsgLy8gdXNlZCB0byBzdXBwcmVzcyBidWdneSBzdHJheSBzcGF3bnNcbiAgICAgIGlmIChtIDwgMCkgeyAvLyBOUENcbiAgICAgICAgY29uc3QgbnBjID0gcm9tLm5wY3Nbfm1dO1xuICAgICAgICBjb25zdCBtZXRhc3ByaXRlSWRzID0gW25wYy5kYXRhWzNdXTtcbiAgICAgICAgY29uc3QgbWV0YXNwcml0ZSA9IHJvbS5tZXRhc3ByaXRlc1ttZXRhc3ByaXRlSWRzWzBdXTtcbiAgICAgICAgaWYgKCFtZXRhc3ByaXRlKSB0aHJvdyBuZXcgRXJyb3IoYGJhZCBOUEM6ICR7fm19YCk7XG4gICAgICAgIC8vIEhhcmRjb2RlIGV4Y2VwdGlvbiBmb3IganVtcGluZyBtYW4gKGFjdGlvbiBzY3JpcHQgJDUwKVxuICAgICAgICBpZiAobnBjLmRhdGFbMl0gPT09IDB4ZDApIG1ldGFzcHJpdGVJZHMucHVzaCgweGMwKTtcbiAgICAgICAgLy8gQ29tcHV0ZSBjb25zdHJhaW50XG4gICAgICAgIGNvbnN0IG9mZnNldCA9IG5wYy5kYXRhWzJdIDwgMHg4MCA/IG5wYy5kYXRhWzJdICYgMHg3MCA6IDA7XG4gICAgICAgIGxldCBjb25zdHJhaW50ID1cbiAgICAgICAgICAgIHRoaXMuY29tcHV0ZUNvbnN0cmFpbnQobWV0YXNwcml0ZUlkcywgc3Bhd25zLCB0cnVlLCBvZmZzZXQpO1xuICAgICAgICAvLyBUT0RPIC0gYmV0dGVyIHdheSBzdHJlYW1saW5lIHRoaXMuLi4/ICh0b3JuZWwgb24gc2FicmUpXG4gICAgICAgIGlmICh+bSA9PT0gMHg1ZikgY29uc3RyYWludCA9IGNvbnN0cmFpbnQuaWdub3JlUGFsZXR0ZSgpO1xuICAgICAgICB0aGlzLm5wY0NvbnN0cmFpbnRzLnNldCh+bSwgY29uc3RyYWludCk7XG4gICAgICB9IGVsc2UgeyAvLyBtb25zdGVyXG4gICAgICAgIGxldCBjb25zdHJhaW50ID0gQ29uc3RyYWludC5BTEw7XG4gICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMucm9tLm9iamVjdHNbbV07XG4gICAgICAgIGlmICghKHBhcmVudCBpbnN0YW5jZW9mIE1vbnN0ZXIpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBleHBlY3RlZCBtb25zdGVyOiAke3BhcmVudH0gZnJvbSAke3NwYXduc31gKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IG9iaiBvZiBhbGxPYmplY3RzKHJvbSwgcGFyZW50KSkge1xuICAgICAgICAgIGNvbnN0IGFjdGlvbiA9IEFDVElPTl9TQ1JJUFRTLmdldChvYmouYWN0aW9uKTtcbiAgICAgICAgICBjb25zdCBtZXRhc3ByaXRlRm46IChtOiBNb25zdGVyKSA9PiByZWFkb25seSBudW1iZXJbXSA9XG4gICAgICAgICAgICAgIGFjdGlvbiAmJiBhY3Rpb24ubWV0YXNwcml0ZXMgfHwgKCgpID0+IFtvYmoubWV0YXNwcml0ZV0pO1xuICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5jb21wdXRlQ29uc3RyYWludChtZXRhc3ByaXRlRm4ob2JqKSwgc3Bhd25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouaWQgPT09IG0sIG9iai5kYXRhWzFdKTtcbiAgICAgICAgICBjb25zdCBtZWV0ID0gY29uc3RyYWludC5tZWV0KGNoaWxkKTtcbiAgICAgICAgICBpZiAoIW1lZXQpIHRocm93IG5ldyBFcnJvcihgQmFkIG1lZXQgZm9yICR7bX0gd2l0aCAke29iai5pZH1gKTtcbiAgICAgICAgICBpZiAobWVldCkgY29uc3RyYWludCA9IG1lZXQ7XG4gICAgICAgICAgLy8gVE9ETyAtIGVsc2UgZXJyb3I/IHdhcm4/XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tb25zdGVyQ29uc3RyYWludHMuc2V0KHBhcmVudC5pZCwgY29uc3RyYWludCk7XG4gICAgICAgIHBhcmVudC5jb25zdHJhaW50ID0gY29uc3RyYWludDsgIC8vIGZvciBkZWJ1Z2dpbmdcbiAgICAgIH1cbiAgICB9ICAgIFxuICB9XG5cbiAgZ2V0TW9uc3RlckNvbnN0cmFpbnQobG9jYXRpb25JZDogbnVtYmVyLCBtb25zdGVySWQ6IG51bWJlcik6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IGMgPSB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cy5nZXQobW9uc3RlcklkKSB8fCBDb25zdHJhaW50Lk5PTkU7XG4gICAgaWYgKChsb2NhdGlvbklkICYgMHg1OCkgPT09IDB4NTgpIHJldHVybiBjO1xuICAgIGNvbnN0IG0gPSB0aGlzLnJvbS5vYmplY3RzW21vbnN0ZXJJZF0uZ29sZERyb3A7XG4gICAgaWYgKCFtKSByZXR1cm4gYztcbiAgICByZXR1cm4gYy5tZWV0KENvbnN0cmFpbnQuQ09JTikgfHwgQ29uc3RyYWludC5OT05FO1xuICB9XG5cbiAgZ2V0TnBjQ29uc3RyYWludChsb2NhdGlvbklkOiBudW1iZXIsIG5wY0lkOiBudW1iZXIpOiBDb25zdHJhaW50IHtcbiAgICBjb25zdCBjID0gdGhpcy5ucGNDb25zdHJhaW50cy5nZXQobnBjSWQpIHx8IENvbnN0cmFpbnQuTk9ORTtcbiAgICBpZiAobG9jYXRpb25JZCA9PT0gMHgxZSAmJiBucGNJZCA9PT0gMHg2MCkge1xuICAgICAgLy8gVE9ETzogY2hhbmdlIHRoaXMgdG8gYWN0dWFsbHkgbG9vayBhdCB0aGUgbG9jYXRpb24ncyB0cmlnZ2Vycz9cbiAgICAgIHJldHVybiBjLm1lZXQoQ29uc3RyYWludC5TVE9NX0ZJR0hUKTtcbiAgICB9IGVsc2UgaWYgKGxvY2F0aW9uSWQgPT09IDB4YTAgJiYgbnBjSWQgPT09IDB4YzkpIHtcbiAgICAgIHJldHVybiBjLm1lZXQoQ29uc3RyYWludC5HVUFSRElBTl9TVEFUVUUpO1xuICAgIH1cbiAgICByZXR1cm4gYztcbiAgfVxuXG4gIHNodWZmbGVQYWxldHRlcyhyYW5kb206IFJhbmRvbSk6IHZvaWQge1xuICAgIGNvbnN0IHBhbCA9IFsuLi50aGlzLmFsbFNwcml0ZVBhbGV0dGVzXTtcbiAgICBmb3IgKGNvbnN0IFtrLCBjXSBvZiB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cykge1xuICAgICAgdGhpcy5tb25zdGVyQ29uc3RyYWludHMuc2V0KGssIGMuc2h1ZmZsZVBhbGV0dGUocmFuZG9tLCBwYWwpKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBbaywgY10gb2YgdGhpcy5ucGNDb25zdHJhaW50cykge1xuICAgICAgdGhpcy5ucGNDb25zdHJhaW50cy5zZXQoaywgYy5zaHVmZmxlUGFsZXR0ZShyYW5kb20sIHBhbCkpO1xuICAgIH1cbiAgfVxuXG4gIGNvbmZpZ3VyZShsb2NhdGlvbjogTG9jYXRpb24sIHNwYXduOiBTcGF3bikge1xuICAgIGlmICghc3Bhd24udXNlZCkgcmV0dXJuO1xuICAgIGNvbnN0IGMgPSBzcGF3bi5pc01vbnN0ZXIoKSA/IHRoaXMubW9uc3RlckNvbnN0cmFpbnRzLmdldChzcGF3bi5tb25zdGVySWQpIDpcbiAgICAgICAgc3Bhd24uaXNOcGMoKSA/IHRoaXMubnBjQ29uc3RyYWludHMuZ2V0KHNwYXduLmlkKSA6XG4gICAgICAgIHNwYXduLmlzQ2hlc3QoKSA/IChzcGF3bi5pZCA8IDB4NzAgPyBDb25zdHJhaW50LlRSRUFTVVJFX0NIRVNUIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbnN0cmFpbnQuTUlNSUMpIDpcbiAgICAgICAgdW5kZWZpbmVkO1xuICAgIGlmICghYykgcmV0dXJuO1xuICAgIGlmIChjLnNoaWZ0ID09PSAzIHx8IGMuZmxvYXQubGVuZ3RoID49IDIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgZG9uJ3Qga25vdyB3aGF0IHRvIGRvIHdpdGggdHdvIGZsb2F0c2ApO1xuICAgIH0gZWxzZSBpZiAoIWMuZmxvYXQubGVuZ3RoKSB7XG4gICAgICBzcGF3bi5wYXR0ZXJuQmFuayA9IE51bWJlcihjLnNoaWZ0ID09PSAyKTtcbiAgICB9IGVsc2UgaWYgKGMuZmxvYXRbMF0uaGFzKGxvY2F0aW9uLnNwcml0ZVBhdHRlcm5zWzBdKSkge1xuICAgICAgc3Bhd24ucGF0dGVybkJhbmsgPSAwO1xuICAgIH0gZWxzZSBpZiAoYy5mbG9hdFswXS5oYXMobG9jYXRpb24uc3ByaXRlUGF0dGVybnNbMV0pKSB7XG4gICAgICBzcGF3bi5wYXR0ZXJuQmFuayA9IDE7XG4gICAgfSBlbHNlIGlmIChzcGF3bi5pc01vbnN0ZXIoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBubyBtYXRjaGluZyBwYXR0ZXJuIGJhbmtgKTtcbiAgICB9XG4gIH1cblxuICBjb21wdXRlQ29uc3RyYWludChtZXRhc3ByaXRlSWRzOiByZWFkb25seSBudW1iZXJbXSxcbiAgICAgICAgICAgICAgICAgICAgc3Bhd25zOiBTcGF3bnMsXG4gICAgICAgICAgICAgICAgICAgIHNoaWZ0YWJsZTogYm9vbGVhbixcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gMCk6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IHBhdHRlcm5zID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgY29uc3QgcGFsZXR0ZXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBmb3IgKGNvbnN0IG1ldGFzcHJpdGUgb2YgbWV0YXNwcml0ZUlkcy5tYXAocyA9PiB0aGlzLnJvbS5tZXRhc3ByaXRlc1tzXSkpIHtcbiAgICAgIC8vIFdoaWNoIHBhbGV0dGUgYW5kIHBhdHRlcm4gYmFua3MgYXJlIHJlZmVyZW5jZWQ/XG4gICAgICBmb3IgKGNvbnN0IHAgb2YgbWV0YXNwcml0ZS5wYWxldHRlcygpKSB7XG4gICAgICAgIHBhbGV0dGVzLmFkZChwKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgcCBvZiBtZXRhc3ByaXRlLnBhdHRlcm5CYW5rcyhvZmZzZXQpKSB7XG4gICAgICAgIHBhdHRlcm5zLmFkZChwKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBvYmoudXNlZFBhbGV0dGVzID0gWy4uLnBhbGV0dGVzXTtcbiAgICAvLyBvYmoudXNlZFBhdHRlcm5zID0gWy4uLnBhdHRlcm5zXTtcblxuICAgIC8vIElmIG9ubHkgdGhpcmQtYmFuayBwYXR0ZXJucyBhcmUgdXNlZCwgdGhlbiB0aGUgbWV0YXNwcml0ZSBjYW4gYmVcbiAgICAvLyBzaGlmdGVkIHRvIGZvdXJ0aCBiYW5rIHdoZW4gbmVjZXNzYXJ5LiAgVGhpcyBpcyBvbmx5IHRydWUgZm9yIE5QQ1xuICAgIC8vIHNwYXducy4gIEFkIGhvYyBzcGF3bnMgY2Fubm90IGJlIHNoaWZ0ZWQgKHlldD8pLlxuICAgIHNoaWZ0YWJsZSA9IHNoaWZ0YWJsZSAmJiBwYXR0ZXJucy5zaXplID09IDEgJiYgWy4uLnBhdHRlcm5zXVswXSA9PT0gMjtcblxuICAgIC8vIElmIHRoZSBzcGF3biBzZXRzIHBhdHRlcm5CYW5rIHRoZW4gd2UgbmVlZCB0byBpbmNyZW1lbnQgZWFjaCBwYXR0ZXJuLlxuICAgIC8vIFdlIGhhdmUgdGhlIGZyZWVkb20gdG8gc2V0IHRoaXMgdG8gZWl0aGVyLCBkZXBlbmRpbmcuXG4gICAgY29uc3QgbG9jcyA9IG5ldyBNYXA8bnVtYmVyLCBTcGF3bj4oKTtcbiAgICBmb3IgKGNvbnN0IFtsLCAsIHNwYXduXSBvZiBzcGF3bnMpIHtcbiAgICAgIGxvY3Muc2V0KHNwYXduLnBhdHRlcm5CYW5rICYmIHNoaWZ0YWJsZSA/IH5sLmlkIDogbC5pZCwgc3Bhd24pO1xuICAgIH1cblxuICAgIC8vIFRPRE8gLSBDb25zdHJhaW50QnVpbGRlclxuICAgIC8vICAgLS0ga2VlcHMgdHJhY2sgb25seSBvZiByZWxldmFudCBmYWN0b3JzLCBpbiBhIGpvaW4uXG4gICAgLy8gICAgICAtLT4gbm8gbWVldGluZyBpbnZvbHZlZCFcbiAgICBsZXQgY2hpbGQgPSB1bmRlZmluZWQ7XG5cbiAgICBmb3IgKGxldCBbbCwgc3Bhd25dIG9mIGxvY3MpIHtcbiAgICAgIGNvbnN0IGxvYyA9IHRoaXMucm9tLmxvY2F0aW9uc1tsIDwgMCA/IH5sIDogbF07XG4gICAgICBmb3IgKGNvbnN0IHBhbCBvZiBwYWxldHRlcykge1xuICAgICAgICBpZiAocGFsID4gMSkgdGhpcy5hbGxTcHJpdGVQYWxldHRlcy5hZGQobG9jLnNwcml0ZVBhbGV0dGVzW3BhbCAtIDJdKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGMgPSBDb25zdHJhaW50LmZyb21TcGF3bihwYWxldHRlcywgcGF0dGVybnMsIGxvYywgc3Bhd24sIHNoaWZ0YWJsZSk7XG4gICAgICBjaGlsZCA9IGNoaWxkID8gY2hpbGQuam9pbihjKSA6IGM7XG4gICAgICBpZiAoIXNoaWZ0YWJsZSAmJiBzcGF3bi5wYXR0ZXJuQmFuaykgY2hpbGQgPSBjaGlsZC5zaGlmdGVkKCk7XG5cbiAgICAgIC8vIC0tLSBoYW5kbGUgc2hpZnRzIGJldHRlci4uLj8gc3VwcG9zZSBlLmcuIG11bHRpcGxlIHBhbDInc1xuICAgICAgLy8gICAgLT4gd2Ugd2FudCB0byBqb2luIHRoZW0gLSB3aWxsIGhhdmUgbXVsdGlwbGUgc2hpZnRhYmxlcy4uLlxuICAgICAgLy9jb25zdHJhaW50ID0gY29uc3RyYWludC5cbiAgICB9XG5cbiAgICAvLyBJZiB3ZSdyZSBzaGlmdGFibGUsIHNhdmUgdGhlIHNldCBvZiBwb3NzaWJsZSBzaGlmdCBiYW5rc1xuICAgIGlmICghY2hpbGQpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgY2hpbGQgdG8gYXBwZWFyYCk7XG4gICAgLy8gaWYgKGNoaWxkLmZsb2F0Lmxlbmd0aCA9PT0gMSkge1xuICAgIC8vICAgcGFyZW50LnNoaWZ0UGF0dGVybnMgPSBuZXcgU2V0KGNoaWxkLmZsb2F0WzBdKTtcbiAgICAvLyB9XG4gICAgcmV0dXJuIGNoaWxkO1xuICB9XG59XG5cbmZ1bmN0aW9uKiBhbGxPYmplY3RzKHJvbTogUm9tLCBwYXJlbnQ6IE1vbnN0ZXIpOiBJdGVyYWJsZTxNb25zdGVyPiB7XG4gIHlpZWxkIHBhcmVudDtcbiAgY29uc3QgcmVwbCA9IHBhcmVudC5zcGF3bmVkUmVwbGFjZW1lbnQoKTtcbiAgaWYgKHJlcGwpIHlpZWxkKiBhbGxPYmplY3RzKHJvbSwgcmVwbCk7XG4gIGNvbnN0IGNoaWxkID0gcGFyZW50LnNwYXduZWRDaGlsZCgpO1xuICBpZiAoY2hpbGQpIHlpZWxkKiBhbGxPYmplY3RzKHJvbSwgY2hpbGQpO1xuICAvLyBUT0RPIC0gdGhlc2UgZG9uJ3QgbWFrZSBzZW5zZSB0byBwdXQgaW4gc3Bhd25lZFJlcGxhY2VtZW50IGJlY2F1c2VcbiAgLy8gd2UgZG9uJ3Qgd2FudCB0byBvdmVyLWluZmxhdGUgcmVkIHNsaW1lcyBkdWUgdG8gZ2lhbnQgcmVkIHNsaW1lcydcbiAgLy8gZGlmZmljdWx0eSwgc2luY2UgbW9zdCBmb2xrcyB3aWxsIG5ldmVyIGhhdmUgdG8gZGVhbCB3aXRoIHRoYXQuXG4gIC8vIEJ1dCB3ZSBkbyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZXkgZ2V0IFwidW4tZmxvYXRlZFwiIHNpbmNlIHRoZVxuICAvLyByZXBsYWNlbWVudCBzcGF3biB3aWxsIG5vdCBzaGFyZSB0aGUgc2FtZSAzODA6MjAgKGZvciBub3cpLlxuICBpZiAocGFyZW50LmlkID09PSAweDUwKSB5aWVsZCByb20ub2JqZWN0c1sweDVmXSBhcyBNb25zdGVyOyAvLyBibHVlIHNsaW1lXG4gIGlmIChwYXJlbnQuaWQgPT09IDB4NTMpIHlpZWxkIHJvbS5vYmplY3RzWzB4NjldIGFzIE1vbnN0ZXI7IC8vIHJlZCBzbGltZVxufVxuXG50eXBlIFNwYXducyA9IFJlYWRvbmx5QXJyYXk8cmVhZG9ubHkgW0xvY2F0aW9uLCBudW1iZXIsIFNwYXduXT47XG4iXX0=