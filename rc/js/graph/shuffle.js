import { Bits } from '../bits.js';
import { seq } from '../rom/util.js';
import { iters } from '../util.js';
class GenericFill {
    constructor() {
        this.slots = [];
        this.items = [];
    }
    set(slot, item) {
        if (this.slots[slot] != null)
            throw new Error(`already filled slot ${slot}`);
        if (this.items[item] != null)
            throw new Error(`already filled item ${item}`);
        this.slots[slot] = item;
        this.items[item] = slot;
    }
    hasSlot(slot) {
        return this.slots[slot] != null;
    }
    hasItem(item) {
        return this.items[item] != null;
    }
}
function expandFill(g, f) {
    const out = new GenericFill();
    for (let i = g.fixed; i < g.items.length; i++) {
        const s = f.items[i];
        out.set(g.slots[s].item, g.items[i].item);
    }
    return out;
}
export function newFill() {
    return new GenericFill();
}
export function traverse(graph, fill, has) {
    has = Bits.clone(has);
    const reachable = new Set();
    const queue = new Set();
    for (let i = 0; i < graph.slots.length; i++) {
        if (graph.graph[i] == null) {
            console.dir(graph);
            throw new Error(`adding bad node ${i} (${graph.slots[i].name}) from slot`);
        }
        queue.add(i);
    }
    for (const n of queue) {
        queue.delete(n);
        if (reachable.has(n))
            continue;
        const needed = graph.graph[n];
        if (needed == null)
            throw new Error(`not in graph: ${n}`);
        for (let i = 0, len = needed.length; i < len; i++) {
            if (!Bits.containsAll(has, needed[i]))
                continue;
            reachable.add(n);
            const item = n < graph.fixed ? n : fill.slots[n];
            if (item != null) {
                has = Bits.with(has, item);
                for (const j of graph.unlocks[item] || []) {
                    if (graph.graph[j] == null) {
                        console.dir(graph);
                        throw new Error(`adding bad node ${j} from unlock ${item}`);
                    }
                    queue.add(j);
                }
            }
            break;
        }
    }
    return reachable;
}
export function traverseFill(graph, fill) {
    const items = [];
    for (const i of graph.items) {
        if (i.item != null)
            items[i.item] = i.index;
    }
    const slots = [];
    for (const s of graph.slots) {
        if (s.item != null && fill.slots[s.item] != null) {
            slots[s.index] = items[fill.slots[s.item]];
        }
    }
    const out = [];
    let has = Bits.of();
    const reachable = new Set();
    const queue = new Set();
    for (let i = 0; i < graph.slots.length; i++) {
        queue.add(i);
    }
    for (const n of queue) {
        queue.delete(n);
        if (reachable.has(n))
            continue;
        const needed = graph.graph[n];
        for (let i = 0, len = needed.length; i < len; i++) {
            if (!Bits.containsAll(has, needed[i]))
                continue;
            out.push([n, ...Bits.bits(needed[i])]);
            reachable.add(n);
            const item = n < graph.fixed ? n : slots[n];
            if (item != null) {
                has = Bits.with(has, item);
                for (const j of graph.unlocks[item] || []) {
                    queue.add(j);
                }
            }
            break;
        }
    }
    return out;
}
var Type;
(function (Type) {
    Type[Type["EMPTY"] = 0] = "EMPTY";
    Type[Type["MIMIC"] = 1] = "MIMIC";
    Type[Type["CONSUMABLE"] = 2] = "CONSUMABLE";
    Type[Type["KEY"] = 3] = "KEY";
    Type[Type["BOSS_DROP"] = 4] = "BOSS_DROP";
    Type[Type["NPC"] = 5] = "NPC";
    Type[Type["MAGIC"] = 6] = "MAGIC";
    Type[Type["TRIGGER"] = 7] = "TRIGGER";
})(Type || (Type = {}));
export class ShuffleRules {
    constructor(rom, flags) {
        this.rom = rom;
        this.pools = new Map();
        const triggers = new Set([0x41, 0x42, 0x46]);
        const chests = new Set();
        const bossDrops = new Set();
        for (const l of rom.locations) {
            if (!l.used)
                continue;
            for (const s of l.spawns) {
                if (s.isInvisible()) {
                    bossDrops.add(s.id);
                }
                else if (s.isChest()) {
                    if (l.bossId() != null) {
                        bossDrops.add(s.id);
                    }
                    else {
                        chests.add(s.id);
                    }
                }
            }
        }
        for (const b of rom.bosses) {
            if (b.drop != null)
                bossDrops.add(b.drop);
        }
        this.slotTypes = seq(0x7c, i => {
            if (triggers.has(i))
                return Type.TRIGGER;
            if (i >= 0x70)
                return Type.MIMIC;
            if (i <= 0x48 && i >= 0x41)
                return Type.MAGIC;
            const item = rom.items[i];
            if (chests.has(i))
                return item && item.unique ? Type.KEY : Type.CONSUMABLE;
            if (bossDrops.has(i))
                return Type.BOSS_DROP;
            return item && item.unique ? Type.NPC : Type.EMPTY;
        });
        const poolFlags = flags.get('S') || [];
        for (let i = 0; i < poolFlags.length; i++) {
            const flag = poolFlags[i];
            if (/c/.test(flag)) {
                this.pools.set(Type.CONSUMABLE, i + 1);
            }
            if (/t/.test(flag)) {
                this.pools.set(Type.MIMIC, i + 1);
            }
            if (/k/.test(flag)) {
                this.pools.set(Type.KEY, i + 1);
                this.pools.set(Type.BOSS_DROP, i + 1);
                this.pools.set(Type.NPC, i + 1);
            }
            if (/m/.test(flag)) {
                this.pools.set(Type.MAGIC, i + 1);
                this.pools.set(Type.TRIGGER, i + 1);
            }
        }
    }
    fits(slot, item) {
        if (slot === item)
            return true;
        const slotType = this.slotTypes[slot] || Type.EMPTY;
        const slotPool = this.pools.get(slotType);
        if (slotPool == null)
            return false;
        if (requiresChest(item) && slotType >= Type.BOSS_DROP)
            return false;
        let itemPool;
        if (item >= 0x70) {
            if (slotType > Type.KEY)
                return false;
            itemPool = this.pools.get(Type.MIMIC);
        }
        else if (item <= 0x48 && item >= 0x41) {
            itemPool = this.pools.get(Type.MAGIC);
        }
        else if (item < 0x41 && this.rom.items[item].unique) {
            itemPool = this.pools.get(Type.KEY);
        }
        else if (this.pools.get(Type.CONSUMABLE) == null &&
            this.slotTypes[item] === Type.BOSS_DROP) {
            itemPool = this.pools.get(Type.BOSS_DROP);
        }
        else {
            if (slotType === Type.TRIGGER)
                return false;
            itemPool = this.pools.get(Type.CONSUMABLE);
        }
        if (itemPool == null)
            return false;
        if (slotPool === itemPool)
            return true;
        return (itemPool === this.pools.get(Type.CONSUMABLE));
    }
    shouldShuffle(id) {
        return this.pools.get(this.slotTypes[id] || 0) != null;
    }
    isEarly(slot) {
        const slotType = this.slotTypes[slot] || Type.EMPTY;
        if (slotType >= Type.TRIGGER)
            return true;
        const pool = this.pools.get(slotType);
        const consumablePool = this.pools.get(Type.CONSUMABLE);
        const mimicPool = this.pools.get(Type.MIMIC);
        return pool !== consumablePool && pool !== mimicPool;
    }
}
export class AssumedFill {
    constructor(rom, flags) {
        this.rom = rom;
        this.flags = flags;
        this.shuffleRules = new ShuffleRules(rom, flags);
    }
    fits(slot, item) {
        return this.shuffleRules.fits(slot, item);
    }
    items(graph, random) {
        const arr = [];
        for (const item of graph.items) {
            if (item.item == null)
                continue;
            let count = 1;
            if (item.item === 0x00 || item.item === 0x01)
                count = 5;
            if (item.item === 0x02)
                count = 10;
            if (item.item === 0x03 || item.item === 0x48)
                count = 15;
            for (let i = 0; i < count; i++)
                arr.push(item.index);
        }
        random.shuffle(arr);
        return arr;
    }
    async shuffle(graph, random, progress, attempts = 2000) {
        if (progress)
            progress.addTasks(Math.floor(attempts / 100));
        for (let attempt = 0; attempt < attempts; attempt++) {
            if (progress && (attempt % 100 === 99)) {
                await new Promise(requestAnimationFrame);
                progress.addCompleted(1);
            }
            const items = this.items(graph, random);
            let has = Bits.from(new Set(items));
            const fill = new GenericFill();
            const itemIndex = new Map();
            const slotIndex = new Map();
            const nonShuffledItems = [];
            for (let i = graph.fixed; i < graph.items.length; i++) {
                const id = graph.items[i].item;
                if (id == null)
                    continue;
                itemIndex.set(id, i);
                if (!this.shuffleRules.shouldShuffle(id))
                    nonShuffledItems.push(id);
            }
            for (let s = graph.fixed; s < graph.slots.length; s++) {
                const id = graph.slots[s].item;
                if (id != null)
                    slotIndex.set(id, s);
            }
            for (const id of nonShuffledItems) {
                const i = itemIndex.get(id);
                const s = slotIndex.get(id);
                if (s == null || i == null)
                    continue;
                fill.set(s, i);
                has = Bits.without(has, i);
            }
            if (this.flags.guaranteeSword()) {
                const sword = random.nextInt(4);
                const i = itemIndex.get(sword);
                const s = slotIndex.get(0);
                if (i != null && s != null && !fill.hasSlot(s) && !fill.hasItem(i)) {
                    fill.set(s, i);
                    has = Bits.without(has, i);
                }
            }
            if (!this.fillInternal(graph, random, fill, items, has, Math.floor(attempt / 5)))
                continue;
            const final = traverse(graph, fill, Bits.of());
            if (final.size !== graph.slots.length) {
                console.error('unexpected size mismatch!', final, graph);
                continue;
            }
            const out = this.fill(graph, expandFill(graph, fill), random);
            if (out == null)
                continue;
            if (progress)
                progress.addCompleted(Math.floor((attempts - attempt) / 100));
            return out;
        }
        return null;
    }
    fillInternal(graph, random, fill, items, has, backSteps) {
        for (let bit = items.pop(); bit != null; bit = items.pop()) {
            if (!Bits.has(has, bit))
                continue;
            const itemId = graph.items[bit].item;
            if (itemId == null)
                throw new Error(`bad item: ${Object.entries(graph.items[bit])}`);
            has = Bits.without(has, bit);
            const reachable = [...traverse(graph, fill, has)];
            random.shuffle(reachable);
            let found = false;
            for (const slot of reachable) {
                const slotId = graph.slots[slot].item;
                if (slotId == null)
                    continue;
                if (!fill.hasSlot(slot) && this.fits(slotId, itemId)) {
                    fill.set(slot, bit);
                    found = true;
                    break;
                }
            }
            if (found)
                continue;
            if (backSteps-- > 0) {
                for (const slot of reachable) {
                    const slotId = graph.slots[slot].item;
                    if (slotId == null)
                        continue;
                    if (this.fits(slotId, itemId)) {
                        const previousItem = fill.slots[slot];
                        fill.slots[slot] = fill.items[previousItem] = undefined;
                        has = Bits.with(has, previousItem);
                        items.push(previousItem);
                        random.shuffle(items);
                        fill.set(slot, bit);
                        found = true;
                        break;
                    }
                }
                if (found)
                    continue;
            }
            return false;
        }
        return true;
    }
    fill(graph, fill, random) {
        const validItems = new Set();
        for (const slot of graph.slots) {
            if (slot.item != null)
                validItems.add(slot.item);
        }
        const uniques = [];
        const consumables = [];
        const mimics = [];
        const earlySlots = [];
        const otherSlots = [];
        for (let i = 0; i < 0x7c; i++) {
            if (i < 0x70 && !validItems.has(i)) {
                if (fill.hasSlot(i) !== fill.hasItem(i))
                    console.error('MISMATCH', i);
                continue;
            }
            if (!fill.hasSlot(i) && !fill.hasItem(i) && !this.shuffleRules.shouldShuffle(i)) {
                fill.set(i, i);
                continue;
            }
            if (!fill.hasSlot(i)) {
                if (this.shuffleRules.isEarly(i)) {
                    earlySlots.push(i);
                }
                else {
                    otherSlots.push(i);
                }
            }
            if (!fill.hasItem(i)) {
                if (i <= 0x48 && this.rom.items[i].unique) {
                    uniques.push(i);
                }
                else if (i < 0x70) {
                    consumables.push(i);
                }
                else {
                    mimics.push(i);
                }
            }
        }
        random.shuffle(earlySlots);
        random.shuffle(otherSlots);
        random.shuffle(uniques);
        random.shuffle(consumables);
        for (const item of iters.concat(uniques, mimics, consumables)) {
            let found = false;
            for (const slots of [earlySlots, otherSlots]) {
                if (found)
                    break;
                for (const slot of slots) {
                    if (this.fits(slot, item)) {
                        fill.set(slot, item);
                        found = true;
                        slots.splice(slots.indexOf(slot), 1);
                        break;
                    }
                }
            }
            if (!found) {
                return null;
            }
        }
        return fill;
    }
}
function requiresChest(id) {
    return id === 0x14 || id === 0x1b || id === 0x1c || id === 0x26;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9ncmFwaC9zaHVmZmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFJaEMsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFtRWpDLE1BQU0sV0FBVztJQUFqQjtRQUVFLFVBQUssR0FBZ0IsRUFBRSxDQUFDO1FBRXhCLFVBQUssR0FBZ0IsRUFBRSxDQUFDO0lBZ0IxQixDQUFDO0lBZEMsR0FBRyxDQUFDLElBQU8sRUFBRSxJQUFPO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM3RSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsdUJBQXVCLElBQUksRUFBRSxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFPO1FBQ2IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztJQUNsQyxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQU87UUFDYixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0lBQ2xDLENBQUM7Q0FDRjtBQU9ELFNBQVMsVUFBVSxDQUFDLENBQVEsRUFBRSxDQUFZO0lBQ3hDLE1B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QUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLENBQUMsRUFBRTtZQUs3RCxJQUFJLEtBQUssR0FBRyxLQUFLLENBQUM7WUFDbEIsS0FBSyxNQUFNLEtBQUssSUFBSSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsRUFBRTtnQkFDNUMsSUFBSSxLQUFLO29CQUFFLE1BQU07Z0JBQ2pCLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO29CQUN4QixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBYSxFQUFFO3dCQUNyQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQzt3QkFDckIsS0FBSyxHQUFHLElBQUksQ0FBQzt3QkFDYixLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7d0JBQ3JDLE1BQU07cUJBQ1A7aUJBQ0Y7YUFDRjtZQUNELElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBRVYsT0FBTyxJQUFJLENBQUM7YUFDYjtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUFFRCxTQUFTLGFBQWEsQ0FBQyxFQUFVO0lBQy9CLE9BQU8sRUFBRSxLQUFLLElBQUksSUFBSSxFQUFFLEtBQUssSUFBSSxJQUFJLEVBQUUsS0FBSyxJQUFJLElBQUksRUFBRSxLQUFLLElBQUksQ0FBQztBQUNsRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQmFzaWMgZ3JhcGggc2h1ZmZsZSBhbGdvcml0aG1cbmltcG9ydCB7Qml0c30gZnJvbSAnLi4vYml0cy5qcyc7XG5pbXBvcnQge0ZsYWdTZXR9IGZyb20gJy4uL2ZsYWdzZXQuanMnO1xuaW1wb3J0IHtSYW5kb219IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7c2VxfSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQge2l0ZXJzfSBmcm9tICcuLi91dGlsLmpzJztcblxuZXhwb3J0IGludGVyZmFjZSBTaHVmZmxlIHtcbiAgc2h1ZmZsZShncmFwaDogR3JhcGgsXG4gICAgICAgICAgcmFuZG9tOiBSYW5kb20sXG4gICAgICAgICAgcHJvZ3Jlc3M/OiBQcm9ncmVzc1RyYWNrZXIsXG4gICAgICAgICAgYXR0ZW1wdHM/OiBudW1iZXIpOiBQcm9taXNlPEZpbGwgfCBudWxsPjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgUHJvZ3Jlc3NUcmFja2VyIHtcbiAgYWRkVGFza3ModGFza3M6IG51bWJlcik6IHZvaWQ7XG4gIGFkZENvbXBsZXRlZCh0YXNrczogbnVtYmVyKTogdm9pZDtcbn1cblxuZXhwb3J0IHR5cGUgU2xvdEluZGV4ID0gbnVtYmVyICYge19fc2xvdEluZGV4X186IG5ldmVyfTtcbmV4cG9ydCB0eXBlIEl0ZW1JbmRleCA9IG51bWJlciAmIHtfX2l0ZW1JbmRleF9fOiBuZXZlcn07XG5leHBvcnQgdHlwZSBTbG90SWQgPSBudW1iZXIgJiB7X19zbG90SWRfXzogbmV2ZXJ9O1xuZXhwb3J0IHR5cGUgSXRlbUlkID0gbnVtYmVyICYge19faXRlbUlkX186IG5ldmVyfTtcblxuZXhwb3J0IHR5cGUgS2V5ZWQ8X0ssIFY+ID0gQXJyYXk8Vj47XG5leHBvcnQgdHlwZSBSZWFkb25seUtleWVkPF9LLCBWPiA9IFJlYWRvbmx5QXJyYXk8Vj47XG5cbi8vIGRlY2xhcmUgY29uc3QgczogU2xvdEluZGV4O1xuLy8gZGVjbGFyZSBjb25zdCBpOiBJdGVtSW5kZXg7XG4vLyBjb25zdCBhOiBLZXllZDxTbG90SW5kZXgsIEl0ZW1JbmRleD4gPSBbXTtcbi8vIGNvbnN0IHggPSBhW3NdO1xuLy8gY29uc3QgW10gPSBbcywgaSwgYSwgeF07XG5cbmV4cG9ydCBpbnRlcmZhY2UgTm9kZSB7XG4gIGl0ZW0/OiBudW1iZXI7IC8vIG9ubHkgc2V0IGZvciBsZWdpdCBpdGVtcy9zbG90c1xuICBuYW1lOiAgc3RyaW5nO1xuICBjb25kaXRpb246IG51bWJlcjsgLy8gZmxhZy9jb25kaXRpb24gbnVtYmVyIGZvciB0cmFja2luZyB0aGlzIG5vZGUgKGUuZy4gMHgyNDggZm9yIGZsaWdodClcbiAgaW5kZXg6IG51bWJlcjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgU2xvdE5vZGUgZXh0ZW5kcyBOb2RlIHtcbiAgaXRlbT86IFNsb3RJZDtcbiAgaW5kZXg6IFNsb3RJbmRleDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgSXRlbU5vZGUgZXh0ZW5kcyBOb2RlIHtcbiAgaXRlbT86IEl0ZW1JZDtcbiAgaW5kZXg6IEl0ZW1JbmRleDtcbn1cblxuLy8gdHlwZSBLZXllZDxLLCBWPiA9IEFycmF5PFY+OyAvLyAmIHtfX2tleWVkX186IChrOiBLKSA9PiBWLCBfX3dyaXRlYWJsZV9fOiBuZXZlcn07XG4vLyB0eXBlIFJlYWRvbmx5S2V5ZWQ8SywgVj4gPSBSZWFkb25seUFycmF5PFY+OyAvLyAmIHtfX2tleWVkX186IChrOiBLKSA9PiBWfTtcbi8vIGZ1bmN0aW9uIEtleWVkPEssIFY+KGE6IFZbXSk6IEtleWVkPEssIFY+IHsgcmV0dXJuIGEgYXMgYW55OyB9XG4vLyBuYW1lc3BhY2UgS2V5ZWQge1xuLy8gICAvLyBleHBvcnQgY29uc3QgdG9BcnJheTogezxLLCBWPihhOiBLZXllZDxLLCBWPik6IEFycmF5PFY+LFxuLy8gICAvLyAgICAgICAgICAgICAgICAgICAgICAgIDxLLCBWPihhOiBSZWFkb25seUtleWVkPEssIFY+KTogUmVhZG9ubHlBcnJheTxWPn0gPSAoYTogYW55KSA9PiBhO1xuLy8gICBleHBvcnQgZnVuY3Rpb24gZ2V0PEssIFY+KGE6IFJlYWRvbmx5S2V5ZWQ8SywgVj4sIGs6IEspOiBWIHtcbi8vICAgICByZXR1cm4gKGEgYXMgYW55KVtrXTtcbi8vICAgfVxuLy8gICBleHBvcnQgZnVuY3Rpb24gc2V0PEssIFY+KGE6IEtleWVkPEssIFY+LCBrOiBLLCB2OiBWKTogdm9pZCB7XG4vLyAgICAgKGEgYXMgYW55KVtrXSA9IHY7XG4vLyAgIH1cbi8vIH1cblxuZXhwb3J0IGludGVyZmFjZSBHcmFwaCB7XG4gIHJlYWRvbmx5IGZpeGVkOiBudW1iZXI7ICAvLyBpbmRleCBiZWZvcmUgd2hpY2ggc2xvdHMgJiBkZXBzIGFyZSB0aGUgc2FtZT9cbiAgcmVhZG9ubHkgc2xvdHM6IFJlYWRvbmx5S2V5ZWQ8U2xvdEluZGV4LCBTbG90Tm9kZT47XG4gIHJlYWRvbmx5IGl0ZW1zOiBSZWFkb25seUtleWVkPEl0ZW1JbmRleCwgSXRlbU5vZGU+O1xuICAvKiogTWFwIGZyb20gbG9jYXRpb24gdG8gRE5GIG9mIGl0ZW1zIHJlcXVpcmVkIHRvIHJlYWNoLiAqL1xuICByZWFkb25seSBncmFwaDogUmVhZG9ubHlLZXllZDxTbG90SW5kZXgsIHJlYWRvbmx5IEJpdHNbXT47XG4gIC8qKiBNYXAgZnJvbSBpdGVtIHRvIGxvY2F0aW9ucyB0aGF0IG1heSBub3cgYmUgcmVhY2hhYmxlLiAqL1xuICByZWFkb25seSB1bmxvY2tzOiBSZWFkb25seUtleWVkPEl0ZW1JbmRleCwgcmVhZG9ubHkgU2xvdEluZGV4W10+O1xuICByZWFkb25seSByb206IFJvbTtcbn1cblxuY2xhc3MgR2VuZXJpY0ZpbGw8UyBleHRlbmRzIG51bWJlciwgSSBleHRlbmRzIG51bWJlcj4ge1xuICAvKiogTWFwcyBsb2NhdGlvbiB0byBpdGVtLiAqL1xuICBzbG90czogS2V5ZWQ8UywgST4gPSBbXTtcbiAgLyoqIE1hcHMgaXRlbSB0byBsb2NhdGlvbi4gKi9cbiAgaXRlbXM6IEtleWVkPEksIFM+ID0gW107XG5cbiAgc2V0KHNsb3Q6IFMsIGl0ZW06IEkpIHtcbiAgICBpZiAodGhpcy5zbG90c1tzbG90XSAhPSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYGFscmVhZHkgZmlsbGVkIHNsb3QgJHtzbG90fWApO1xuICAgIGlmICh0aGlzLml0ZW1zW2l0ZW1dICE9IG51bGwpIHRocm93IG5ldyBFcnJvcihgYWxyZWFkeSBmaWxsZWQgaXRlbSAke2l0ZW19YCk7XG4gICAgdGhpcy5zbG90c1tzbG90XSA9IGl0ZW07XG4gICAgdGhpcy5pdGVtc1tpdGVtXSA9IHNsb3Q7XG4gIH1cblxuICBoYXNTbG90KHNsb3Q6IFMpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zbG90c1tzbG90XSAhPSBudWxsO1xuICB9XG5cbiAgaGFzSXRlbShpdGVtOiBJKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXRlbXNbaXRlbV0gIT0gbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgdHlwZSBGaWxsID0gR2VuZXJpY0ZpbGw8U2xvdElkLCBJdGVtSWQ+O1xuLy9leHBvcnQgY29uc3QgRmlsbDoge25ldygpOiBGaWxsfSA9IEdlbmVyaWNGaWxsO1xuZXhwb3J0IHR5cGUgSW5kZXhGaWxsID0gR2VuZXJpY0ZpbGw8U2xvdEluZGV4LCBJdGVtSW5kZXg+O1xuXG4vKiogQ29udmVydHMgYW4gSW5kZXhGaWxsIHRvIGEgZnVsbCBGaWxsLiAqL1xuZnVuY3Rpb24gZXhwYW5kRmlsbChnOiBHcmFwaCwgZjogSW5kZXhGaWxsKTogRmlsbCB7XG4gIGNvbnN0IG91dCA9IG5ldyBHZW5lcmljRmlsbDxTbG90SWQsIEl0ZW1JZD4oKTtcbiAgZm9yIChsZXQgaSA9IGcuZml4ZWQ7IGkgPCBnLml0ZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgczogU2xvdEluZGV4ID0gZi5pdGVtc1tpXTtcbiAgICBvdXQuc2V0KGcuc2xvdHNbc10uaXRlbSEsIGcuaXRlbXNbaV0uaXRlbSEpO1xuICB9XG4gIHJldHVybiBvdXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBuZXdGaWxsPFMgZXh0ZW5kcyBudW1iZXIsIEkgZXh0ZW5kcyBudW1iZXI+KCk6IEdlbmVyaWNGaWxsPFMsIEk+IHtcbiAgcmV0dXJuIG5ldyBHZW5lcmljRmlsbCgpO1xufVxuXG5cbi8qKiBAcmV0dXJuIFRoZSBzZXQgb2YgcmVhY2hhYmxlIHNsb3RzLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRyYXZlcnNlKGdyYXBoOiBHcmFwaCwgZmlsbDogSW5kZXhGaWxsLCBoYXM6IEJpdHMpOiBTZXQ8U2xvdEluZGV4PiB7XG4gIC8vIE5PVEU6IHdlIGNhbid0IHVzZSBpc0FycmF5IGJlY2F1c2UgdGhlIG5vbi1iaWdpbnQgcG9seWZpbGwgSVMgYW4gYXJyYXlcbiAgaGFzID0gQml0cy5jbG9uZShoYXMpO1xuICBjb25zdCByZWFjaGFibGUgPSBuZXcgU2V0PFNsb3RJbmRleD4oKTtcbiAgY29uc3QgcXVldWUgPSBuZXcgU2V0PFNsb3RJbmRleD4oKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBncmFwaC5zbG90cy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChncmFwaC5ncmFwaFtpXSA9PSBudWxsKSB7Y29uc29sZS5kaXIoZ3JhcGgpO3Rocm93IG5ldyBFcnJvcihgYWRkaW5nIGJhZCBub2RlICR7aX0gKCR7Z3JhcGguc2xvdHNbaV0ubmFtZX0pIGZyb20gc2xvdGApO31cbiAgICBxdWV1ZS5hZGQoaSBhcyBTbG90SW5kZXgpO1xuICB9XG4gIGZvciAoY29uc3QgbiBvZiBxdWV1ZSkge1xuICAgIHF1ZXVlLmRlbGV0ZShuKTtcbiAgICBpZiAocmVhY2hhYmxlLmhhcyhuKSkgY29udGludWU7XG4gICAgLy8gY2FuIHdlIHJlYWNoIGl0P1xuICAgIGNvbnN0IG5lZWRlZCA9IGdyYXBoLmdyYXBoW25dO1xuICAgIGlmIChuZWVkZWQgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBub3QgaW4gZ3JhcGg6ICR7bn1gKTtcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gbmVlZGVkLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBpZiAoIUJpdHMuY29udGFpbnNBbGwoaGFzLCBuZWVkZWRbaV0pKSBjb250aW51ZTtcbiAgICAgIHJlYWNoYWJsZS5hZGQobik7XG4gICAgICBjb25zdCBpdGVtID0gbiA8IGdyYXBoLmZpeGVkID8gbiA6IGZpbGwuc2xvdHNbbl07XG4gICAgICBpZiAoaXRlbSAhPSBudWxsKSB7XG4gICAgICAgIGhhcyA9IEJpdHMud2l0aChoYXMsIGl0ZW0pO1xuICAgICAgICBmb3IgKGNvbnN0IGogb2YgZ3JhcGgudW5sb2Nrc1tpdGVtXSB8fCBbXSkge1xuICAgICAgICAgIGlmIChncmFwaC5ncmFwaFtqXSA9PSBudWxsKSB7Y29uc29sZS5kaXIoZ3JhcGgpO3Rocm93IG5ldyBFcnJvcihgYWRkaW5nIGJhZCBub2RlICR7an0gZnJvbSB1bmxvY2sgJHtpdGVtfWApO31cbiAgICAgICAgICBxdWV1ZS5hZGQoaik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVhY2hhYmxlO1xufVxuXG4vLyBUT0RPIC0gdGhpcyBpcyBhIGxvdCBvZiBjb3B5IHBhc3RhLCB3ZSBzaG91bGQgY29uc29saWRhdGUhXG4vKiogQ29weSBvZiB0cmF2ZXJzZSBidXQgb3V0cHV0cyBhIGh1bWFuLXJlYWRhYmxlIHBhdGguICovXG5leHBvcnQgZnVuY3Rpb24gdHJhdmVyc2VGaWxsKGdyYXBoOiBHcmFwaCwgZmlsbDogRmlsbCk6IG51bWJlcltdW10ge1xuICBjb25zdCBpdGVtcyA9IFtdO1xuICBmb3IgKGNvbnN0IGkgb2YgZ3JhcGguaXRlbXMpIHtcbiAgICBpZiAoaS5pdGVtICE9IG51bGwpIGl0ZW1zW2kuaXRlbV0gPSBpLmluZGV4O1xuICB9XG4gIGNvbnN0IHNsb3RzID0gW107XG4gIGZvciAoY29uc3QgcyBvZiBncmFwaC5zbG90cykge1xuICAgIGlmIChzLml0ZW0gIT0gbnVsbCAmJiBmaWxsLnNsb3RzW3MuaXRlbV0gIT0gbnVsbCkge1xuICAgICAgc2xvdHNbcy5pbmRleF0gPSBpdGVtc1tmaWxsLnNsb3RzW3MuaXRlbV1dO1xuICAgIH1cbiAgfVxuICBjb25zdCBvdXQgPSBbXTtcblxuICBsZXQgaGFzID0gQml0cy5vZigpXG4gIGNvbnN0IHJlYWNoYWJsZSA9IG5ldyBTZXQ8U2xvdEluZGV4PigpO1xuICBjb25zdCBxdWV1ZSA9IG5ldyBTZXQ8U2xvdEluZGV4PigpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGdyYXBoLnNsb3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgcXVldWUuYWRkKGkgYXMgU2xvdEluZGV4KTtcbiAgfVxuICBmb3IgKGNvbnN0IG4gb2YgcXVldWUpIHtcbiAgICBxdWV1ZS5kZWxldGUobik7XG4gICAgaWYgKHJlYWNoYWJsZS5oYXMobikpIGNvbnRpbnVlO1xuICAgIC8vIGNhbiB3ZSByZWFjaCBpdD9cbiAgICBjb25zdCBuZWVkZWQgPSBncmFwaC5ncmFwaFtuXTtcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gbmVlZGVkLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBpZiAoIUJpdHMuY29udGFpbnNBbGwoaGFzLCBuZWVkZWRbaV0pKSBjb250aW51ZTtcbiAgICAgIG91dC5wdXNoKFtuLCAuLi5CaXRzLmJpdHMobmVlZGVkW2ldKV0pO1xuICAgICAgcmVhY2hhYmxlLmFkZChuKTtcbiAgICAgIGNvbnN0IGl0ZW0gPSBuIDwgZ3JhcGguZml4ZWQgPyBuIDogc2xvdHNbbl07XG4gICAgICBpZiAoaXRlbSAhPSBudWxsKSB7XG4gICAgICAgIGhhcyA9IEJpdHMud2l0aChoYXMsIGl0ZW0pO1xuICAgICAgICBmb3IgKGNvbnN0IGogb2YgZ3JhcGgudW5sb2Nrc1tpdGVtXSB8fCBbXSkge1xuICAgICAgICAgIHF1ZXVlLmFkZChqKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIHJldHVybiBvdXQ7XG59XG5cbi8vIFNodWZmbGUgbW9kZXM6XG4vLyAgMS4ga2V5IGl0ZW0gc2h1ZmZsZSBTayh0KVxuLy8gIDIuIGZ1bGwgc2h1ZmZsZSBTZih0KVxuLy8gRm9yIG5vdyB3ZSBwcm94eSBhIGZldyB0aGluZ3MgZm9yIHRoaXMuLi5cblxuLy8gU2xvdCBwcm9wZXJ0aWVzOlxuLy8gIDEuIGNvbnN1bWFibGUgb3Iga2V5XG4vLyAgMi4gY2hlc3QgKGluY2wuIGJvc3MgZHJvcHMsIG1heSBiZSBjb25zdW1hYmxlKVxuLy8gIDMuIHRyaWdnZXIgKGFsd2F5cyBrZXksIG11c3QgYmUga2V5KVxuLy8gIDQuIG1pbWljXG5cbi8vIFJ1bGVzOlxuLy8gIC0gSWYga2V5IHNodWZmbGUgdGhlbiBpbml0aWFsIGZpbGwgaWdub3JlcyBhbGwgbm9uLWtleSBzbG90c1xuLy8gIC0gSWYgdHJhcCBzaHVmZmxlIG9mZiB0aGVuIGlnbm9yZSBtaW1pYyBzbG90c1xuLy8gIC0gQ29uc3VtYWJsZXMgbWF5IG5vdCBnbyBpbnRvIHRyaWdnZXJzXG4vLyAgLSBNaW1pY3MgbWF5IG5vdCBnbyBpbnRvIG5wY3MsIHRyaWdnZXJzLCBvciBib3NzIGRyb3BzLlxuLy8gIC0gV2UgdHJlYXQgaW52aXNpYmxlIGNoZXN0cyBsaWtlIGJvc3MgZHJvcHMuXG5cbmVudW0gVHlwZSB7XG4gIEVNUFRZID0gMCxcbiAgTUlNSUMgPSAxLFxuICBDT05TVU1BQkxFID0gMixcbiAgS0VZID0gMyxcbiAgQk9TU19EUk9QID0gNCxcbiAgTlBDID0gNSxcbiAgTUFHSUMgPSA2LFxuICBUUklHR0VSID0gNyxcbn1cblxuZXhwb3J0IGNsYXNzIFNodWZmbGVSdWxlcyB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2xvdFR5cGVzOiBSZWFkb25seUtleWVkPFNsb3RJZCB8IEl0ZW1JZCwgVHlwZSB8IHVuZGVmaW5lZD47XG4gIHByaXZhdGUgcmVhZG9ubHkgcG9vbHMgPSBuZXcgTWFwPFR5cGUsIG51bWJlcj4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJvbTogUm9tLCBmbGFnczogRmxhZ1NldCkge1xuICAgIGNvbnN0IHRyaWdnZXJzID0gbmV3IFNldChbMHg0MSwgMHg0MiwgMHg0Nl0pO1xuICAgIGNvbnN0IGNoZXN0cyA9IG5ldyBTZXQoKTtcbiAgICBjb25zdCBib3NzRHJvcHMgPSBuZXcgU2V0KCk7XG4gICAgZm9yIChjb25zdCBsIG9mIHJvbS5sb2NhdGlvbnMpIHtcbiAgICAgIGlmICghbC51c2VkKSBjb250aW51ZTtcbiAgICAgIGZvciAoY29uc3QgcyBvZiBsLnNwYXducykge1xuICAgICAgICBpZiAocy5pc0ludmlzaWJsZSgpKSB7XG4gICAgICAgICAgYm9zc0Ryb3BzLmFkZChzLmlkKTtcbiAgICAgICAgfSBlbHNlIGlmIChzLmlzQ2hlc3QoKSkge1xuICAgICAgICAgIGlmIChsLmJvc3NJZCgpICE9IG51bGwpIHtcbiAgICAgICAgICAgIC8vIE5vbi1kcm9wIGNoZXN0cyBvbiBib3NzIHNjcmVlbnMgYWxzbyBkb24ndCB3b3JrIGZvciBtaW1pY3MsXG4gICAgICAgICAgICAvLyBzbyBjb3VudCB0aG9zZSBjaGVzdHMgYXMgYm9zcyBkcm9wcywgdG9vIChlLmcuIHN0b3JtIGJyYWNlbGV0KVxuICAgICAgICAgICAgYm9zc0Ryb3BzLmFkZChzLmlkKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2hlc3RzLmFkZChzLmlkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCBiIG9mIHJvbS5ib3NzZXMpIHtcbiAgICAgIGlmIChiLmRyb3AgIT0gbnVsbCkgYm9zc0Ryb3BzLmFkZChiLmRyb3ApO1xuICAgIH1cblxuICAgIHRoaXMuc2xvdFR5cGVzID0gc2VxKDB4N2MsIGkgPT4ge1xuICAgICAgaWYgKHRyaWdnZXJzLmhhcyhpKSkgcmV0dXJuIFR5cGUuVFJJR0dFUjtcbiAgICAgIGlmIChpID49IDB4NzApIHJldHVybiBUeXBlLk1JTUlDO1xuICAgICAgaWYgKGkgPD0gMHg0OCAmJiBpID49IDB4NDEpIHJldHVybiBUeXBlLk1BR0lDO1xuICAgICAgY29uc3QgaXRlbSA9IHJvbS5pdGVtc1tpXTtcbiAgICAgIGlmIChjaGVzdHMuaGFzKGkpKSByZXR1cm4gaXRlbSAmJiBpdGVtLnVuaXF1ZSA/IFR5cGUuS0VZIDogVHlwZS5DT05TVU1BQkxFO1xuICAgICAgaWYgKGJvc3NEcm9wcy5oYXMoaSkpIHJldHVybiBUeXBlLkJPU1NfRFJPUDtcbiAgICAgIHJldHVybiBpdGVtICYmIGl0ZW0udW5pcXVlID8gVHlwZS5OUEMgOiBUeXBlLkVNUFRZO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcG9vbEZsYWdzID0gZmxhZ3MuZ2V0KCdTJykgfHwgW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb29sRmxhZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGZsYWcgPSBwb29sRmxhZ3NbaV07XG4gICAgICBpZiAoL2MvLnRlc3QoZmxhZykpIHtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5DT05TVU1BQkxFLCBpICsgMSk7XG4gICAgICB9XG4gICAgICBpZiAoL3QvLnRlc3QoZmxhZykpIHtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5NSU1JQywgaSArIDEpO1xuICAgICAgfVxuICAgICAgaWYgKC9rLy50ZXN0KGZsYWcpKSB7XG4gICAgICAgIHRoaXMucG9vbHMuc2V0KFR5cGUuS0VZLCBpICsgMSk7XG4gICAgICAgIHRoaXMucG9vbHMuc2V0KFR5cGUuQk9TU19EUk9QLCBpICsgMSk7XG4gICAgICAgIHRoaXMucG9vbHMuc2V0KFR5cGUuTlBDLCBpICsgMSk7XG4gICAgICB9XG4gICAgICBpZiAoL20vLnRlc3QoZmxhZykpIHtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5NQUdJQywgaSArIDEpO1xuICAgICAgICB0aGlzLnBvb2xzLnNldChUeXBlLlRSSUdHRVIsIGkgKyAxKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmaXRzKHNsb3Q6IFNsb3RJZCwgaXRlbTogSXRlbUlkKTogYm9vbGVhbiB7XG4gICAgLy8gVmFuaWxsYSBwbGFjZW1lbnQgaXMgYWx3YXlzIGxlZ2FsLlxuICAgIGlmIChzbG90IGFzIG51bWJlciA9PT0gaXRlbSkgcmV0dXJuIHRydWU7XG4gICAgY29uc3Qgc2xvdFR5cGUgPSB0aGlzLnNsb3RUeXBlc1tzbG90XSB8fCBUeXBlLkVNUFRZO1xuICAgIGNvbnN0IHNsb3RQb29sID0gdGhpcy5wb29scy5nZXQoc2xvdFR5cGUpO1xuICAgIGlmIChzbG90UG9vbCA9PSBudWxsKSByZXR1cm4gZmFsc2U7XG4gICAgLy8gU3BlY2lhbCBoYW5kbGluZyB0byBwcmV2ZW50IG9wZWxzIGFuZCB1bmlxdWUgYXJtb3JzIG9uIE5QQ3MuXG4gICAgaWYgKHJlcXVpcmVzQ2hlc3QoaXRlbSkgJiYgc2xvdFR5cGUgPj0gVHlwZS5CT1NTX0RST1ApIHJldHVybiBmYWxzZTtcbiAgICAvLyBUT0RPIC0gYWNjb3VudCBmb3IgbmV3IE1BR0lDIHR5cGUgYW5kIHVzZSBwb29scyBpbnN0ZWFkIVxuICAgIGxldCBpdGVtUG9vbDtcbiAgICBpZiAoaXRlbSA+PSAweDcwKSB7XG4gICAgICAvLyBNaW1pY3MgLSBjYW4gbmV2ZXIgc2hvdyB1cCBleGNlcHQgaW4gbm9uLWJvc3MtZHJvcCBjaGVzdHMuXG4gICAgICBpZiAoc2xvdFR5cGUgPiBUeXBlLktFWSkgcmV0dXJuIGZhbHNlO1xuICAgICAgaXRlbVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLk1JTUlDKTtcbiAgICB9IGVsc2UgaWYgKGl0ZW0gPD0gMHg0OCAmJiBpdGVtID49IDB4NDEpIHtcbiAgICAgIC8vIE1hZ2ljcyAtIGNhbiBiZSBhbnl3aGVyZS5cbiAgICAgIGl0ZW1Qb29sID0gdGhpcy5wb29scy5nZXQoVHlwZS5NQUdJQyk7XG4gICAgfSBlbHNlIGlmIChpdGVtIDwgMHg0MSAmJiB0aGlzLnJvbS5pdGVtc1tpdGVtXS51bmlxdWUpIHtcbiAgICAgIC8vIFVuaXF1ZSBpdGVtIC0gY2FuIGJlIGFueXdoZXJlLlxuICAgICAgaXRlbVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLktFWSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBvb2xzLmdldChUeXBlLkNPTlNVTUFCTEUpID09IG51bGwgJiZcbiAgICAgICAgICAgICAgIHRoaXMuc2xvdFR5cGVzW2l0ZW1dID09PSBUeXBlLkJPU1NfRFJPUCkge1xuICAgICAgLy8gSWYgY29uc3VtYWJsZXMgYXJlICpub3QqIHNodWZmbGVkIHRoZW4gYWxsIGJvc3MgZHJvcHNcbiAgICAgIC8vIG5lZWQgdG8gYmUgdHJlYXRlZCBhcyBrZXkgaXRlbXMsIG5vdCBjb25zdW1hYmxlcy5cbiAgICAgIGl0ZW1Qb29sID0gdGhpcy5wb29scy5nZXQoVHlwZS5CT1NTX0RST1ApXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIENvbnN1bWFibGVzIC0gY2Fubm90IGJlIG9uIGFuIE5QQywgTWFnaWMsIG9yIFRyaWdnZXIuXG4gICAgICBpZiAoc2xvdFR5cGUgPT09IFR5cGUuVFJJR0dFUikgcmV0dXJuIGZhbHNlO1xuICAgICAgaXRlbVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLkNPTlNVTUFCTEUpO1xuICAgIH1cbiAgICBpZiAoaXRlbVBvb2wgPT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xuXG4gICAgLy8gTm8gaGFyZCBibG9ja2VyLCBzbyBjaGVjayBmb3Igc2FtZSBwb29sLlxuICAgIGlmIChzbG90UG9vbCA9PT0gaXRlbVBvb2wpIHJldHVybiB0cnVlO1xuXG4gICAgLy8gRGlmZmVyZW50IHBvb2xzLCBidXQgd2UgbmVlZCB0byBzaHVmZmxlIHNvbWUgY29uc3VtYWJsZXNcbiAgICAvLyBpbnRvIGtleSBpdGVtIHNsb3RzIG9jY2FzaW9uYWxseS5cbiAgICByZXR1cm4gKGl0ZW1Qb29sID09PSB0aGlzLnBvb2xzLmdldChUeXBlLkNPTlNVTUFCTEUpKTtcblxuICAvLyAgICAgaWYgKCF0aGlzLnNodWZmbGVGdWxsKSByZXR1cm4gc2xvdFR5cGUgPj0gVHlwZS5LRVk7XG4gIC8vICAgICBpZiAoIXRoaXMuc2h1ZmZsZVRyYXBzKSByZXR1cm4gc2xvdFR5cGUgIT09IFR5cGUuTUlNSUM7XG4gIC8vICAgICByZXR1cm4gdHJ1ZTtcbiAgLy8gICB9XG4gIC8vICAgLy8gQ29uc3VtYWJsZVxuICAvLyAgIC8vIGlmICh1bmlxdWVzTGVmdCAmJiBzbG90VHlwZSA+IFR5cGUuQ09OU1VNQUJMRSkgcmV0dXJuIGZhbHNlO1xuICAvLyAgIGlmICghdGhpcy5zaHVmZmxlVHJhcHMpIHJldHVybiBzbG90VHlwZSAhPT0gVHlwZS5NSU1JQztcbiAgLy8gICByZXR1cm4gc2xvdFR5cGUgIT09IFR5cGUuVFJJR0dFUjtcblxuXG4gIC8vIC8vIG1pbWljXG4gIC8vICAgICBpZiAoIXRoaXMuc2h1ZmZsZVRyYXBzKSByZXR1cm4gc2xvdFR5cGUgPT09IFR5cGUuTUlNSUM7XG4gIC8vICAgICBpZiAoIXRoaXMuc2h1ZmZsZUZ1bGwpIHJldHVybiBzbG90VHlwZSA8PSBUeXBlLkNPTlNVTUFCTEU7XG4gIC8vICAgICByZXR1cm4gc2xvdFR5cGUgPD0gVHlwZS5LRVk7XG5cbiAgfVxuXG4gIHNob3VsZFNodWZmbGUoaWQ6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnBvb2xzLmdldCh0aGlzLnNsb3RUeXBlc1tpZF0gfHwgMCkgIT0gbnVsbDtcbiAgfVxuXG4gIGlzRWFybHkoc2xvdDogU2xvdElkKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2xvdFR5cGUgPSB0aGlzLnNsb3RUeXBlc1tzbG90XSB8fCBUeXBlLkVNUFRZO1xuXG4gICAgLy8gRWFybHkgc2xvdHM6XG4gICAgLy8gIC0gVHJpZ2dlciBzbG90cyBhcmUgYWx3YXlzIGVhcmx5LCBmb3IgYWxsIGZsYWdzLCBzaW5jZSB0aGV5IGNhbm5vdCBnZXRcbiAgICAvLyAgICBjb25zdW1hYmxlcyAob3IgbWltaWNzKS5cbiAgICAvLyAgLSBUT0RPIC0gY29uc2lkZXIgYSBjb21wcm9taXNlIGZ1bGwtc2h1ZmZsZSBmbGFnL21vZGUgd2hlcmUgTlBDcyBkb24ndFxuICAgIC8vICAgIGV2ZXIgaGF2ZSBjb25zdW1hYmxlcy5cbiAgICAvLyAgLSBPdGhlcndpc2UgYW55IHNsb3QgdHlwZSB0aGF0IGRvZXMgbm90IHNodWZmbGUgdy8gY29uc3VtYWJsZXMgbmVlZHNcbiAgICAvLyAgICB0byBiZSBlYXJseS5cblxuICAgIGlmIChzbG90VHlwZSA+PSBUeXBlLlRSSUdHRVIpIHJldHVybiB0cnVlO1xuICAgIGNvbnN0IHBvb2wgPSB0aGlzLnBvb2xzLmdldChzbG90VHlwZSk7XG4gICAgY29uc3QgY29uc3VtYWJsZVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLkNPTlNVTUFCTEUpO1xuICAgIGNvbnN0IG1pbWljUG9vbCA9IHRoaXMucG9vbHMuZ2V0KFR5cGUuTUlNSUMpO1xuICAgIHJldHVybiBwb29sICE9PSBjb25zdW1hYmxlUG9vbCAmJiBwb29sICE9PSBtaW1pY1Bvb2w7XG5cbiAgICAvLyByZXR1cm4gc2xvdFR5cGUgPiAoZnVsbFNodWZmbGUgPyBUeXBlLk5QQyA6IFR5cGUuQ09OU1VNQUJMRSk7XG4gIH1cbn1cblxuXG4vLyBUT0RPIC0gcHVsbCBvdXQgYSBiYXNlIGNsYXNzIHdpdGggZml0cywgZXRjLlxuZXhwb3J0IGNsYXNzIEFzc3VtZWRGaWxsIGltcGxlbWVudHMgU2h1ZmZsZSB7XG4gIC8vIFRPRE8gLSBvdGhlciBjb25maWd1cmF0aW9uP1xuXG4gIHJlYWRvbmx5IHNodWZmbGVSdWxlczogU2h1ZmZsZVJ1bGVzO1xuIFxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJvbTogUm9tLFxuICAgICAgICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGZsYWdzOiBGbGFnU2V0KSB7XG4gICAgdGhpcy5zaHVmZmxlUnVsZXMgPSBuZXcgU2h1ZmZsZVJ1bGVzKHJvbSwgZmxhZ3MpO1xuICAgIC8vIEZpcnN0IGNvbXB1dGUgYSB0YWJsZSBvZiBhbGxvd2VkIGxvY2F0aW9ucywgYW5kIHdoZXRoZXIgaXRlbXMgYXJlIHVuaXF1ZS5cblxuICAgIC8vIEZvciBlYWNoIHNsb3QsIGZpZ3VyZSBvdXQgKGEpIGlzIGl0IGEgY2hlc3QgKG9yIG1pbWljKSwgKGIpIGlzIGl0IGEgdHJpZ2dlciBzcXVhcmUuXG4gICAgLy8gSWYgbmVpdGhlciB0aGVuIGl0J3MgYW4gTlBDIG9yIGJvc3Nkcm9wLlxuXG4gIH1cblxuICBwcml2YXRlIGZpdHMoc2xvdDogU2xvdElkLCBpdGVtOiBJdGVtSWQgLyogLCB1bmlxdWVzTGVmdDogYm9vbGVhbiAqLyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnNodWZmbGVSdWxlcy5maXRzKHNsb3QsIGl0ZW0pO1xuICB9XG5cbiAgLy8gTm90ZTogZHVwbGljYXRlcyBhcmUgYWxsb3dlZC5cbiAgcHJvdGVjdGVkIGl0ZW1zKGdyYXBoOiBHcmFwaCwgcmFuZG9tOiBSYW5kb20pOiBJdGVtSW5kZXhbXSB7XG4gICAgY29uc3QgYXJyID0gW107XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGdyYXBoLml0ZW1zKSB7XG4gICAgICBpZiAoaXRlbS5pdGVtID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgbGV0IGNvdW50ID0gMTtcbiAgICAgIGlmIChpdGVtLml0ZW0gPT09IDB4MDAgfHwgaXRlbS5pdGVtID09PSAweDAxKSBjb3VudCA9IDU7XG4gICAgICBpZiAoaXRlbS5pdGVtID09PSAweDAyKSBjb3VudCA9IDEwO1xuICAgICAgaWYgKGl0ZW0uaXRlbSA9PT0gMHgwMyB8fCBpdGVtLml0ZW0gPT09IDB4NDgpIGNvdW50ID0gMTU7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIGFyci5wdXNoKGl0ZW0uaW5kZXgpO1xuICAgIH1cbiAgICByYW5kb20uc2h1ZmZsZShhcnIpO1xuICAgIHJldHVybiBhcnI7XG4gIH1cblxuICBhc3luYyBzaHVmZmxlKGdyYXBoOiBHcmFwaCxcbiAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbiAgICAgICAgICAgICAgICBwcm9ncmVzcz86IFByb2dyZXNzVHJhY2tlcixcbiAgICAgICAgICAgICAgICBhdHRlbXB0czogbnVtYmVyID0gMjAwMCk6IFByb21pc2U8RmlsbCB8IG51bGw+IHtcbiAgICBpZiAocHJvZ3Jlc3MpIHByb2dyZXNzLmFkZFRhc2tzKE1hdGguZmxvb3IoYXR0ZW1wdHMgLyAxMDApKTtcbiAgICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8IGF0dGVtcHRzOyBhdHRlbXB0KyspIHtcbiAgICAgIC8vIGVuc3VyZSBVSSB1cGRhdGVzXG4gICAgICBpZiAocHJvZ3Jlc3MgJiYgKGF0dGVtcHQgJSAxMDAgPT09IDk5KSkge1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXF1ZXN0QW5pbWF0aW9uRnJhbWUpO1xuICAgICAgICBwcm9ncmVzcy5hZGRDb21wbGV0ZWQoMSk7XG4gICAgICB9XG4gICAgICBjb25zdCBpdGVtcyA9IHRoaXMuaXRlbXMoZ3JhcGgsIHJhbmRvbSk7XG4gICAgICBsZXQgaGFzID0gQml0cy5mcm9tKG5ldyBTZXQoaXRlbXMpKTtcbiAgICAgIGNvbnN0IGZpbGw6IEluZGV4RmlsbCA9IG5ldyBHZW5lcmljRmlsbCgpO1xuXG4gICAgICAvLyBJbml0aWFsaXplIGZpbGwgd2l0aCBub24tc2h1ZmZsZWQgaXRlbXMuXG4gICAgICBjb25zdCBpdGVtSW5kZXggPSBuZXcgTWFwPEl0ZW1JZCB8IFNsb3RJZCwgSXRlbUluZGV4PigpO1xuICAgICAgY29uc3Qgc2xvdEluZGV4ID0gbmV3IE1hcDxJdGVtSWQgfCBTbG90SWQsIFNsb3RJbmRleD4oKTtcbiAgICAgIGNvbnN0IG5vblNodWZmbGVkSXRlbXM6IEl0ZW1JZFtdID0gW107XG4gICAgICBmb3IgKGxldCBpID0gZ3JhcGguZml4ZWQgYXMgSXRlbUluZGV4OyBpIDwgZ3JhcGguaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgaWQgPSBncmFwaC5pdGVtc1tpXS5pdGVtO1xuICAgICAgICBpZiAoaWQgPT0gbnVsbCkgY29udGludWU7XG4gICAgICAgIGl0ZW1JbmRleC5zZXQoaWQsIGkpO1xuICAgICAgICBpZiAoIXRoaXMuc2h1ZmZsZVJ1bGVzLnNob3VsZFNodWZmbGUoaWQpKSBub25TaHVmZmxlZEl0ZW1zLnB1c2goaWQpO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGxldCBzID0gZ3JhcGguZml4ZWQgYXMgU2xvdEluZGV4OyBzIDwgZ3JhcGguc2xvdHMubGVuZ3RoOyBzKyspIHtcbiAgICAgICAgY29uc3QgaWQgPSBncmFwaC5zbG90c1tzXS5pdGVtO1xuICAgICAgICBpZiAoaWQgIT0gbnVsbCkgc2xvdEluZGV4LnNldChpZCwgcyk7XG4gICAgICB9XG5cbiAgICAgIGZvciAoY29uc3QgaWQgb2Ygbm9uU2h1ZmZsZWRJdGVtcykge1xuICAgICAgICBjb25zdCBpID0gaXRlbUluZGV4LmdldChpZCk7XG4gICAgICAgIGNvbnN0IHMgPSBzbG90SW5kZXguZ2V0KGlkKTtcbiAgICAgICAgaWYgKHMgPT0gbnVsbCB8fCBpID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgICBmaWxsLnNldChzLCBpKTtcbiAgICAgICAgaGFzID0gQml0cy53aXRob3V0KGhhcywgaSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmZsYWdzLmd1YXJhbnRlZVN3b3JkKCkpIHtcbiAgICAgICAgLy8gcGljayBhIHN3b3JkIGF0IHJhbmRvbSBhbmQgcHV0IGl0IGluIHNsb3QgMFxuICAgICAgICBjb25zdCBzd29yZCA9IHJhbmRvbS5uZXh0SW50KDQpIGFzIEl0ZW1JZDtcbiAgICAgICAgY29uc3QgaSA9IGl0ZW1JbmRleC5nZXQoc3dvcmQpO1xuICAgICAgICBjb25zdCBzID0gc2xvdEluZGV4LmdldCgwIGFzIFNsb3RJZCk7IC8vIGVsZGVyIG5vcm1hbGwgZ2l2ZXMgc3dvcmQgb2Ygd2luZFxuICAgICAgICBpZiAoaSAhPSBudWxsICYmIHMgIT0gbnVsbCAmJiAhZmlsbC5oYXNTbG90KHMpICYmICFmaWxsLmhhc0l0ZW0oaSkpIHtcbiAgICAgICAgICBmaWxsLnNldChzLCBpKTtcbiAgICAgICAgICBoYXMgPSBCaXRzLndpdGhvdXQoaGFzLCBpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBUT0RPOiBpZiBleGl0cyBzaHVmZmxlZCB0aGVuIGZpbmQgYSBzbG90IGluIHplcm8tc3BoZXJlLlxuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMuZmlsbEludGVybmFsKGdyYXBoLCByYW5kb20sIGZpbGwsIGl0ZW1zLCBoYXMsIE1hdGguZmxvb3IoYXR0ZW1wdCAvIDUpKSkgY29udGludWU7XG5cbiAgICAgIGNvbnN0IGZpbmFsID0gdHJhdmVyc2UoZ3JhcGgsIGZpbGwsIEJpdHMub2YoKSk7XG4gICAgICBpZiAoZmluYWwuc2l6ZSAhPT0gZ3JhcGguc2xvdHMubGVuZ3RoKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ3VuZXhwZWN0ZWQgc2l6ZSBtaXNtYXRjaCEnLCBmaW5hbCwgZ3JhcGgpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG91dCA9IHRoaXMuZmlsbChncmFwaCwgZXhwYW5kRmlsbChncmFwaCwgZmlsbCksIHJhbmRvbSk7XG4gICAgICBpZiAob3V0ID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgaWYgKHByb2dyZXNzKSBwcm9ncmVzcy5hZGRDb21wbGV0ZWQoTWF0aC5mbG9vcigoYXR0ZW1wdHMgLSBhdHRlbXB0KSAvIDEwMCkpO1xuICAgICAgcmV0dXJuIG91dDtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcm90ZWN0ZWQgZmlsbEludGVybmFsKGdyYXBoOiBHcmFwaCxcbiAgICAgICAgICAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICBmaWxsOiBJbmRleEZpbGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXM6IEl0ZW1JbmRleFtdLFxuICAgICAgICAgICAgICAgICAgICAgICAgIGhhczogQml0cyxcbiAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrU3RlcHM6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGZvciAobGV0IGJpdDogSXRlbUluZGV4IHwgdW5kZWZpbmVkID0gaXRlbXMucG9wKCk7IGJpdCAhPSBudWxsOyBiaXQgPSBpdGVtcy5wb3AoKSkge1xuICAgICAgaWYgKCFCaXRzLmhhcyhoYXMsIGJpdCkpIGNvbnRpbnVlOyAvLyBpdGVtIGFscmVhZHkgcGxhY2VkOiBza2lwXG4gICAgICBjb25zdCBpdGVtSWQgPSBncmFwaC5pdGVtc1tiaXRdLml0ZW07XG4gICAgICBpZiAoaXRlbUlkID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgYmFkIGl0ZW06ICR7T2JqZWN0LmVudHJpZXMoZ3JhcGguaXRlbXNbYml0XSl9YCk7XG4gICAgICBoYXMgPSBCaXRzLndpdGhvdXQoaGFzLCBiaXQpO1xuICAgICAgY29uc3QgcmVhY2hhYmxlID0gWy4uLnRyYXZlcnNlKGdyYXBoLCBmaWxsLCBoYXMpXTtcbiAgICAgIHJhbmRvbS5zaHVmZmxlKHJlYWNoYWJsZSk7XG4gICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAoY29uc3Qgc2xvdCBvZiByZWFjaGFibGUpIHtcbiAgICAgICAgY29uc3Qgc2xvdElkID0gZ3JhcGguc2xvdHNbc2xvdF0uaXRlbTtcbiAgICAgICAgaWYgKHNsb3RJZCA9PSBudWxsKSBjb250aW51ZTtcbiAgICAgICAgaWYgKCFmaWxsLmhhc1Nsb3Qoc2xvdCkgJiYgdGhpcy5maXRzKHNsb3RJZCwgaXRlbUlkIC8qLCB0cnVlKi8pKSB7IC8vIHNsb3QgIT09IHRoaXMud2luICYmXG4gICAgICAgICAgZmlsbC5zZXQoc2xvdCwgYml0KTtcbiAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChmb3VuZCkgY29udGludWU7XG4gICAgICBpZiAoYmFja1N0ZXBzLS0gPiAwKSB7XG4gICAgICAgIC8vIHRha2UgYSBiYWNrIHN0ZXAuXG4gICAgICAgIGZvciAoY29uc3Qgc2xvdCBvZiByZWFjaGFibGUpIHtcbiAgICAgICAgICBjb25zdCBzbG90SWQgPSBncmFwaC5zbG90c1tzbG90XS5pdGVtO1xuICAgICAgICAgIGlmIChzbG90SWQgPT0gbnVsbCkgY29udGludWU7XG4gICAgICAgICAgaWYgKHRoaXMuZml0cyhzbG90SWQsIGl0ZW1JZCkpIHtcbiAgICAgICAgICAgIGNvbnN0IHByZXZpb3VzSXRlbSA9IGZpbGwuc2xvdHNbc2xvdF07XG4gICAgICAgICAgICBmaWxsLnNsb3RzW3Nsb3RdID0gZmlsbC5pdGVtc1twcmV2aW91c0l0ZW1dID0gdW5kZWZpbmVkIGFzIGFueTtcbiAgICAgICAgICAgIGhhcyA9IEJpdHMud2l0aChoYXMsIHByZXZpb3VzSXRlbSk7XG4gICAgICAgICAgICBpdGVtcy5wdXNoKHByZXZpb3VzSXRlbSk7XG4gICAgICAgICAgICByYW5kb20uc2h1ZmZsZShpdGVtcyk7XG4gICAgICAgICAgICBmaWxsLnNldChzbG90LCBiaXQpO1xuICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChmb3VuZCkgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyBUT0RPIC0gaXQgbG9va3MgbGlrZSB3ZSdyZSBwbGFjaW5nIHJhbmRvbSBpdGVtcyBpbiBtYWdpYyBzbG90cyB3aGVuIFNtIGlzIG9mZj8hP1xuICAgICAgLy8gICAgIC0tLS0+IGZpZ3VyZSBvdXQgd2hhdCB3YXMgcGxhY2VkIGluIGl0cyBzcG90P1xuICAgICAgLy8gY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHBsYWNlIGtleSBpdGVtICR7aXRlbUlkfTogYXZhaWxhYmxlICR7cmVhY2hhYmxlLm1hcChzID0+IGdyYXBoLnNsb3RzW3NdLml0ZW0pfWApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKiBGaWxzIHRoZSByZW1haW5pbmcgc2xvdHMgd2l0aCBub24tcHJvZ3Jlc3Npb24gaXRlbXMuICovXG4gIHByaXZhdGUgZmlsbChncmFwaDogR3JhcGgsIGZpbGw6IEZpbGwsIHJhbmRvbTogUmFuZG9tKTogRmlsbCB8IG51bGwge1xuICAgIC8vIEZpZ3VyZSBvdXQgd2hhdCBzdGlsbCBuZWVkcyB0byBiZSBmaWxsZWQuICBXaWxsIGJlIG1vc3RsdSBjb25zdW1hYmxlcyBvciBtaW1pY3MuXG4gICAgLy8gU3RhcnQgd2l0aCB1bmlxdWUgaXRlbXMgc2luY2Ugd2UgaGF2ZSBydWxlcyB0byBwcmV2ZW50IHB1dHRpbmcgdW5pcXVlcyBpbiBub24tdW5pcXVlXG4gICAgLy8gc2xvdHMgKGlmIHRoZSBmbGFnIGlzIHNldCkgYnV0IG5vdCB2aWNlIHZlcnNhLlxuICAgIGNvbnN0IHZhbGlkSXRlbXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBmb3IgKGNvbnN0IHNsb3Qgb2YgZ3JhcGguc2xvdHMpIHtcbiAgICAgIGlmIChzbG90Lml0ZW0gIT0gbnVsbCkgdmFsaWRJdGVtcy5hZGQoc2xvdC5pdGVtKTtcbiAgICB9XG5cbiAgICBjb25zdCB1bmlxdWVzOiBJdGVtSWRbXSA9IFtdO1xuICAgIGNvbnN0IGNvbnN1bWFibGVzOiBJdGVtSWRbXSA9IFtdO1xuICAgIGNvbnN0IG1pbWljczogSXRlbUlkW10gPSBbXTtcbiAgICAvLyBlYXJseVNsb3RzIGFyZSBmaWxsZWQgZmlyc3QsIGlmIHRoZXkncmUgbm9uLWVtcHR5LlxuICAgIGNvbnN0IGVhcmx5U2xvdHM6IFNsb3RJZFtdID0gW107XG4gICAgY29uc3Qgb3RoZXJTbG90czogU2xvdElkW10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMCBhcyBTbG90SWQgJiBJdGVtSWQ7IGkgPCAweDdjOyBpKyspIHtcbiAgICAgIGlmIChpIDwgMHg3MCAmJiAhdmFsaWRJdGVtcy5oYXMoaSkpIHtcbiAgICAgICAgaWYgKGZpbGwuaGFzU2xvdChpKSAhPT0gZmlsbC5oYXNJdGVtKGkpKSBjb25zb2xlLmVycm9yKCdNSVNNQVRDSCcsaSk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKCFmaWxsLmhhc1Nsb3QoaSkgJiYgIWZpbGwuaGFzSXRlbShpKSAmJiAhdGhpcy5zaHVmZmxlUnVsZXMuc2hvdWxkU2h1ZmZsZShpKSkge1xuICAgICAgICBmaWxsLnNldChpLCBpKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoIWZpbGwuaGFzU2xvdChpKSkge1xuICAgICAgICBpZiAodGhpcy5zaHVmZmxlUnVsZXMuaXNFYXJseShpKSkge1xuICAgICAgICAgIGVhcmx5U2xvdHMucHVzaChpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdGhlclNsb3RzLnB1c2goaSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghZmlsbC5oYXNJdGVtKGkpKSB7XG4gICAgICAgIGlmIChpIDw9IDB4NDggJiYgdGhpcy5yb20uaXRlbXNbaV0udW5pcXVlKSB7XG4gICAgICAgICAgdW5pcXVlcy5wdXNoKGkpO1xuICAgICAgICB9IGVsc2UgaWYgKGkgPCAweDcwKSB7XG4gICAgICAgICAgY29uc3VtYWJsZXMucHVzaChpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtaW1pY3MucHVzaChpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByYW5kb20uc2h1ZmZsZShlYXJseVNsb3RzKTtcbiAgICByYW5kb20uc2h1ZmZsZShvdGhlclNsb3RzKTtcbiAgICByYW5kb20uc2h1ZmZsZSh1bmlxdWVzKTtcbiAgICByYW5kb20uc2h1ZmZsZShjb25zdW1hYmxlcyk7XG5cbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlcnMuY29uY2F0KHVuaXF1ZXMsIG1pbWljcywgY29uc3VtYWJsZXMpKSB7XG4gICAgICAvLyBUcnkgdG8gcGxhY2UgdGhlIGl0ZW0sIHN0YXJ0aW5nIHdpdGggZWFybGllcyBmaXJzdC5cbiAgICAgIC8vIE1pbWljcyBjb21lIGJlZm9yZSBjb25zdW1hYmxlcyBiZWNhdXNlIHRoZXJlJ3MgZmV3ZXIgcGxhY2VzIHRoZXkgY2FuIGdvLlxuICAgICAgLy8gU2luY2Uga2V5IHNsb3RzIGFyZSBhbGxvd2VkIHRvIGNvbnRhaW4gY29uc3VtYWJsZXMgKGV2ZW4gaW4gZnVsbCBzaHVmZmxlKSxcbiAgICAgIC8vIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgdGhlIHVuaXF1ZXMgZ28gaW50byB0aG9zZSBzbG90cyBmaXJzdC5cbiAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgICAgZm9yIChjb25zdCBzbG90cyBvZiBbZWFybHlTbG90cywgb3RoZXJTbG90c10pIHtcbiAgICAgICAgaWYgKGZvdW5kKSBicmVhaztcbiAgICAgICAgZm9yIChjb25zdCBzbG90IG9mIHNsb3RzKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZml0cyhzbG90LCBpdGVtIC8qLCBmYWxzZSovKSkge1xuICAgICAgICAgICAgZmlsbC5zZXQoc2xvdCwgaXRlbSk7XG4gICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICBzbG90cy5zcGxpY2Uoc2xvdHMuaW5kZXhPZihzbG90KSwgMSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgLy8gY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGZpbGwgZXh0cmEgaXRlbSAke2l0ZW19LiBTbG90czogJHtlYXJseVNsb3RzfSwgJHtvdGhlclNsb3RzfWApO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZpbGw7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVxdWlyZXNDaGVzdChpZDogSXRlbUlkKTogYm9vbGVhbiB7XG4gIHJldHVybiBpZCA9PT0gMHgxNCB8fCBpZCA9PT0gMHgxYiB8fCBpZCA9PT0gMHgxYyB8fCBpZCA9PT0gMHgyNjtcbn1cblxuLy8gZXhwb3J0IGNsYXNzIEZvcndhcmRGaWxsIGV4dGVuZHMgQXNzdW1lZEZpbGwge1xuLy8gICBwcm90ZWN0ZWQgZmlsbEludGVybmFsKGdyYXBoOiBHcmFwaCxcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxsOiBJbmRleEZpbGwsXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXM6IEl0ZW1JbmRleFtdLFxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgIGhhczogQml0cyk6IGJvb2xlYW4ge1xuLy8gICAgIHdoaWxlICghQml0cy5lbXB0eShoYXMpKSB7XG4vLyAgICAgICAvLyBXaGF0J3MgcmVhY2hhYmxlIHdpdGggbm90aGluZz9cbi8vICAgICAgIGNvbnN0IHJlYWNoYWJsZSA9IFsuLi50cmF2ZXJzZShncmFwaCwgZmlsbCwgQml0cy5vZigpKV07XG4vLyAgICAgICAvLyBXaGF0IGFyZSB0aGUgaW1tZWRpYXRlIGJsb2Nrcz8hPyBOZWVkIHRvIGFkZCBhbiBBUEkgdG8gZ2V0IHRoZXNlP1xuLy8gICAgICAgLy8gVHJhbnNsYXRlIHJlYWNoYWJibGUgaW50byBhIFwiaGFzXCJcbi8vICAgICAgIGxldCBnZXR0YWJsZSA9IEJpdHMuZnJvbShcbi8vICAgICAgICAgICByZWFjaGFibGUubWFwKHMgPT4gcyA8IGdyYXBoLmZpeGVkID8gcyA6IGZpbGwuc2xvdHNbc10pLmZpbHRlcihpID0+IGkpKTtcbi8vICAgICAgIGxldCB1bmxvY2tzID0gbmV3IFNldDxJdGVtSW5kZXg+KCk7XG4vLyAgICAgICBjb25zdCB1bmxvY2tzMiA9IG5ldyBTZXQ8SXRlbUluZGV4PigpO1xuLy8gICAgICAgZm9yIChsZXQgcyA9IDAgYXMgU2xvdEluZGV4OyBzIDwgZ3JhcGguZ3JhcGgubGVuZ3RoOyBzKyspIHtcbi8vICAgICAgICAgZm9yIChjb25zdCByb3V0ZSBvZiBncmFwaC5ncmFwaFtzXSkge1xuLy8gICAgICAgICAgIGNvbnN0IGJpdHMgPSBCaXRzLmJpdHMoQml0cy5kaWZmZXJlbmNlKHJvdXRlLCBnZXR0YWJsZSkpIGFzIEl0ZW1JbmRleFtdO1xuLy8gICAgICAgICAgIGlmIChiaXRzLmxlbmd0aCA9PT0gMSkgdW5sb2Nrcy5hZGQoYml0c1swXSk7XG4vLyAgICAgICAgICAgaWYgKGJpdHMubGVuZ3RoID09PSAyKSB7XG4vLyAgICAgICAgICAgICB1bmxvY2tzMi5hZGQoYml0c1swXSk7XG4vLyAgICAgICAgICAgICB1bmxvY2tzMi5hZGQoYml0c1sxXSk7XG4vLyAgICAgICAgICAgICAvLyBUT0RPIC0gbXVsdGltYXAsIGFuZCB0aGVuIGdvIHdpdGggaXRlbSB0aGF0J3MgbGVhc3QgZXZlbnRmdWxcbi8vICAgICAgICAgICB9XG4vLyAgICAgICAgIH0gICAgICAgIFxuLy8gICAgICAgfVxuXG4vLyAgICAgICAvLyBQaWNrIGFuIHVubG9ja2FibGUgYW5kIGEgc2xvdC5cbi8vICAgICAgIGNvbnN0IGFsbEl0ZW1zID0gWy4uLih1bmxvY2tzLnNpemUgPyB1bmxvY2tzIDogdW5sb2NrczIpXTtcbi8vICAgICAgIGNvbnN0IGl0ZW0gPSBhbGxJdGVtc1tyYW5kb20ubmV4dEludChhbGxJdGVtcy5sZW5ndGgpXTtcbiAgICAgIFxuLy8gICAgIC8vICAgcmFuZG9tLnNodWZmbGUocmVhY2hhYmxlKTtcbi8vICAgICAvLyAgIGxldCBmb3VuZCA9IGZhbHNlO1xuLy8gICAgIC8vICAgZm9yIChjb25zdCBzbG90IG9mIHJlYWNoYWJsZSkge1xuLy8gICAgIC8vICAgICBjb25zdCBzbG90SWQgPSBncmFwaC5zbG90c1tzbG90XS5pdGVtO1xuLy8gICAgIC8vICAgICBpZiAoc2xvdElkID09IG51bGwpIGNvbnRpbnVlO1xuLy8gICAgIC8vICAgICBpZiAoIWZpbGwuaGFzU2xvdChzbG90KSAmJiB0aGlzLmZpdHMoc2xvdElkLCBpdGVtSWQgLyosIHRydWUqLykpIHsgLy8gc2xvdCAhPT0gdGhpcy53aW4gJiZcbi8vICAgICAvLyAgICAgICBmaWxsLnNldChzbG90LCBiaXQpO1xuLy8gICAgIC8vICAgICAgIGZvdW5kID0gdHJ1ZTtcbi8vICAgICAvLyAgICAgICBicmVhaztcbi8vICAgICAvLyAgICAgfVxuLy8gICAgIC8vICAgfVxuLy8gICAgIC8vICAgaWYgKCFmb3VuZCkge1xuXG4vLyAgICAgLy8gICAgIC8vIFRPRE8gLSBpdCBsb29rcyBsaWtlIHdlJ3JlIHBsYWNpbmcgcmFuZG9tIGl0ZW1zIGluIG1hZ2ljIHNsb3RzIHdoZW4gU20gaXMgb2ZmPyE/XG4vLyAgICAgLy8gICAgIC8vICAgICAtLS0tPiBmaWd1cmUgb3V0IHdoYXQgd2FzIHBsYWNlZCBpbiBpdHMgc3BvdD9cblxuLy8gICAgIC8vICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gcGxhY2Uga2V5IGl0ZW0gJHtpdGVtSWR9OiBhdmFpbGFibGUgJHtyZWFjaGFibGUubWFwKHMgPT4gZ3JhcGguc2xvdHNbc10uaXRlbSl9YCk7XG4vLyAgICAgLy8gICAgIHJldHVybiBmYWxzZTtcbi8vICAgICAvLyAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgXG4vLyAgICAgLy8gfVxuXG5cbi8vICAgICBmb3IgKGxldCBiaXQ6IEl0ZW1JbmRleCB8IHVuZGVmaW5lZCA9IGl0ZW1zLnBvcCgpOyBiaXQgIT0gbnVsbDsgYml0ID0gaXRlbXMucG9wKCkpIHtcbi8vICAgICAgIGlmICghQml0cy5oYXMoaGFzLCBiaXQpKSBjb250aW51ZTsgLy8gaXRlbSBhbHJlYWR5IHBsYWNlZDogc2tpcFxuLy8gICAgICAgY29uc3QgaXRlbUlkID0gZ3JhcGguaXRlbXNbYml0XS5pdGVtO1xuLy8gICAgICAgaWYgKGl0ZW1JZCA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYGJhZCBpdGVtOiAke09iamVjdC5lbnRyaWVzKGdyYXBoLml0ZW1zW2JpdF0pfWApO1xuLy8gICAgICAgaGFzID0gQml0cy53aXRob3V0KGhhcywgYml0KTtcbi8vICAgICAgIGNvbnN0IHJlYWNoYWJsZSA9IFsuLi50cmF2ZXJzZShncmFwaCwgZmlsbCwgaGFzKV07XG4vLyAgICAgICByYW5kb20uc2h1ZmZsZShyZWFjaGFibGUpO1xuLy8gICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4vLyAgICAgICBmb3IgKGNvbnN0IHNsb3Qgb2YgcmVhY2hhYmxlKSB7XG4vLyAgICAgICAgIGNvbnN0IHNsb3RJZCA9IGdyYXBoLnNsb3RzW3Nsb3RdLml0ZW07XG4vLyAgICAgICAgIGlmIChzbG90SWQgPT0gbnVsbCkgY29udGludWU7XG4vLyAgICAgICAgIGlmICghZmlsbC5oYXNTbG90KHNsb3QpICYmIHRoaXMuZml0cyhzbG90SWQsIGl0ZW1JZCAvKiwgdHJ1ZSovKSkgeyAvLyBzbG90ICE9PSB0aGlzLndpbiAmJlxuLy8gICAgICAgICAgIGZpbGwuc2V0KHNsb3QsIGJpdCk7XG4vLyAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuLy8gICAgICAgICAgIGJyZWFrO1xuLy8gICAgICAgICB9XG4vLyAgICAgICB9XG4vLyAgICAgICBpZiAoIWZvdW5kKSB7XG5cbi8vICAgICAgICAgLy8gVE9ETyAtIGl0IGxvb2tzIGxpa2Ugd2UncmUgcGxhY2luZyByYW5kb20gaXRlbXMgaW4gbWFnaWMgc2xvdHMgd2hlbiBTbSBpcyBvZmY/IT9cbi8vICAgICAgICAgLy8gICAgIC0tLS0+IGZpZ3VyZSBvdXQgd2hhdCB3YXMgcGxhY2VkIGluIGl0cyBzcG90P1xuXG4vLyAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBwbGFjZSBrZXkgaXRlbSAke2l0ZW1JZH06IGF2YWlsYWJsZSAke3JlYWNoYWJsZS5tYXAocyA9PiBncmFwaC5zbG90c1tzXS5pdGVtKX1gKTtcbi8vICAgICAgICAgcmV0dXJuIGZhbHNlO1xuLy8gICAgICAgfVxuLy8gICAgIH1cbi8vICAgICByZXR1cm4gdHJ1ZTtcbi8vICAgfVxuLy8gfVxuIl19