import { TileEffects } from './tileeffects.js';
import { UnionFind } from '../unionfind.js';
import { DefaultMap } from '../util.js';
export class MapScreen {
    constructor(screen, tileset) {
        this.screen = screen;
        this.tileset = tileset;
        this.partition = new Map();
        this.partitions = [];
        const graph = new UnionFind();
        const effects = tileset.effects().effects;
        const scr = screen.id << 8;
        function walkable(tile) {
            const override = OVERRIDE.get(tile | scr);
            if (override != null)
                return override;
            let mt = screen.tiles[tile];
            let effect = effects[mt];
            if (mt < 0x20 && effect & TileEffects.ALTERNATIVE) {
                effect = effects[mt = tileset.alternates[mt]];
            }
            return !(effect & (TileEffects.NO_WALK | TileEffects.IMPASSIBLE));
        }
        for (let y = 0; y < 0xf; y++) {
            for (let x = 0; x < 0x10; x++) {
                const t = y << 4 | x;
                if (!walkable(t))
                    continue;
                if (y && walkable(t - 16))
                    graph.union([t, t - 16]);
                if (x && walkable(t - 1))
                    graph.union([t, t - 1]);
            }
        }
        for (const set of graph.sets()) {
            let partition = null;
            for (const t of set) {
                if (!isPerimeter(t) && t !== 0x88)
                    continue;
                if (!partition)
                    this.partitions.push(partition = new Set());
                partition.add(t);
                this.partition.set(t, this.partitions.length - 1);
            }
        }
        const edges = [0, 0, 0, 0];
        for (let i = 15; i >= 0; i--) {
            for (let j = 0; j < 4; j++) {
                edges[j] <<= 1;
                const tile = j < 2 ? (!j ? i : i << 4 | 0xf) : j === 2 ? 0xe0 | i : i << 4;
                if (this.partition.has(tile))
                    edges[j] |= 1;
            }
        }
        this.edges = edges;
    }
}
function isPerimeter(t) {
    const col = t & 0x0f;
    const row = t & 0xf0;
    return !row || row === 0xe0 || !col || col === 0xf;
}
const OVERRIDE = new Map([
    ...rows([
        [0x7200, 0b0000111111110000],
        [0x72e0, 0b0000111111110000],
        [0x73e0, 0b0000111111110000],
        [0x9b00, 0b0000001111000000],
        [0x9be0, 0b0000001111000000],
        [0xfde0, 0b0000111111110000],
    ]),
    ...cols([
        [0x7c00, 0],
        [0x7c0f, 0],
    ])
]);
function* rows(rows) {
    for (const [base, bits] of rows) {
        for (let i = 0; i < 16; i++) {
            yield [base | i, Boolean(bits & (1 << i))];
        }
    }
}
function* cols(cols) {
    for (const [base, bits] of cols) {
        for (let i = 0; i < 15; i++) {
            yield [base | i << 4, Boolean(bits & (1 << i))];
        }
    }
}
export class MapBuilder {
    constructor(tileset, availableScreens, random, height, width) {
        this.tileset = tileset;
        this.random = random;
        this.height = height;
        this.width = width;
        this.screens = [];
        this.edges = new DefaultMap(() => new Set());
        this.eligible = [];
        this.constraints = [];
        this.inBounds = new Set();
        for (const scr of availableScreens) {
            for (let dir = 0; dir < 4; dir++) {
                const edge = tileset.screens[scr].edges[dir];
                this.edges.get(dir | edge << 2).add(scr);
            }
        }
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                this.inBounds.add(y << 4 | x);
            }
        }
    }
    isInBounds(pos) {
        return pos >= 0 && (pos >>> 4) < this.height && (pos & 0xf) < this.width;
    }
    reset() {
        this.eligible = [];
        this.constraints = [];
        for (const i of this.inBounds) {
            if (this.screens[i] < 0) {
            }
            else {
                this.screens[i] = undefined;
                delete this.constraints[i];
            }
        }
        for (const pos of this.inBounds) {
            this.initConstraints(pos);
        }
    }
    initConstraints(pos) {
        delete this.constraints[pos];
        for (let dir of Dir) {
            const n = pos + DELTA[dir];
            if (this.inBounds.has(n)) {
                let s = this.screens[n];
                if (s == null)
                    continue;
                s = s < 0 ? ~s : s;
                this.addConstraint(pos, dir, this.tileset.screens[s].edges[dir ^ 2]);
            }
            else {
                this.addConstraint(pos, dir, 0);
            }
        }
    }
    addConstraint(scr, dir, edge) {
        if (!this.inBounds.has(scr) || this.screens[scr] != null)
            return;
        let constraints = this.constraints[scr];
        if (!constraints) {
            this.constraints[scr] = constraints = [];
            this.eligible.push(scr);
        }
        constraints[dir] = edge;
    }
    deleteConstraint(scr, dir) {
        let constraints = this.constraints[scr];
        if (!constraints)
            return;
        delete constraints[dir];
        for (let i = constraints.length - 1; i >= 0; i--) {
            if (constraints[i] != null) {
                return;
            }
        }
        const index = this.eligible.findIndex(x => x != null);
        if (index >= 0)
            this.eligible.splice(index, 1);
    }
    fill(backtracks) {
        let pos;
        while ((pos = this.findEmpty()) != null && backtracks >= 0) {
            const scr = this.pickScreen(pos);
            if (scr != null) {
                this.setScreen(pos, scr);
            }
            else {
                this.deleteOneNeighbor(pos);
                backtracks--;
            }
        }
        return pos == null;
    }
    findEmpty() {
        const screens = this.random.shuffle([...this.inBounds]);
        for (const pos of screens) {
            if (this.screens[pos] == null && (this.constraints[pos] || []).some(x => x != null))
                return pos;
        }
        return undefined;
    }
    deleteSomeScreens() {
        const filled = [];
        for (const pos of this.inBounds) {
            if (this.screens[pos] >= 0) {
                filled.push(pos);
            }
        }
        this.random.shuffle(filled);
        const count = 1 + this.random.nextInt(filled.length - 1);
        for (const pos of filled.slice(0, count)) {
            this.deleteScreen(pos);
        }
    }
    traverse() {
        const uf = new UnionFind();
        for (const pos of this.inBounds) {
            let scr = this.screens[pos];
            const parts = this.tileset.screens[scr < 0 ? ~scr : scr].partitions.map(part => [...part].map(t => {
                t = pos << 8 | t;
                if ((t & 0xf0) === 0xe0)
                    t += 0x20;
                if ((t & 0x0f) === 0x0f)
                    t += 0x01;
                return t;
            }));
            for (const part of parts) {
                uf.union(part);
            }
        }
        const sets = uf.sets();
        const map = new Map();
        for (let i = 0; i < sets.length; i++) {
            for (const tile of sets[i]) {
                map.set(tile, i);
            }
        }
        return map;
    }
    deleteOneNeighbor(pos) {
        const dirs = this.random.shuffle([...Dir]);
        for (const dir of dirs) {
            const neighbor = pos + DELTA[dir];
            if (!this.inBounds.has(neighbor) ||
                !(this.screens[neighbor] >= 0))
                continue;
            this.deleteScreen(neighbor);
            return;
        }
        throw new Error(`Could not find a neighbor to delete!`);
    }
    pickScreen(pos) {
        let screens;
        const constraints = this.constraints[pos];
        for (let dir = 0; dir < constraints.length; dir++) {
            const edge = constraints[dir];
            if (edge == null)
                continue;
            const set = this.edges.get(dir | edge << 2);
            ;
            screens = !screens ? set : intersect(screens, set);
        }
        if (!screens || !screens.size)
            return undefined;
        const eligible = [...screens];
        return this.random.pick(eligible);
    }
    setScreen(pos, scr) {
        if (this.screens[pos] != null)
            throw new Error('screen already set');
        this.screens[pos] = scr;
        delete this.constraints[pos];
        const edges = this.tileset.screens[scr].edges;
        for (const dir of Dir) {
            const neighbor = pos + DELTA[dir];
            this.addConstraint(neighbor, opposite(dir), edges[dir]);
        }
    }
    deleteScreen(pos) {
        const previous = this.screens[pos];
        this.screens[pos] = undefined;
        if (previous == null)
            return;
        if (previous < 0)
            throw new Error(`Cannot delete fixed screen`);
        for (const dir of Dir) {
            const neighbor = pos + DELTA[dir];
            if (!this.inBounds.has(neighbor))
                continue;
            this.deleteConstraint(neighbor, opposite(dir));
        }
        this.initConstraints(pos);
    }
}
const Dir = [0, 1, 2, 3];
const DELTA = [-16, 1, 16, -1];
function opposite(d) {
    return (d ^ 2);
}
function intersect(xs, ys) {
    const out = new Set();
    for (const x of xs) {
        if (ys.has(x))
            out.add(x);
    }
    return out;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwc2NyZWVuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3JvbS9tYXBzY3JlZW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLGtCQUFrQixDQUFDO0FBRzdDLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBRXRDLE1BQU0sT0FBTyxTQUFTO0lBT3BCLFlBQXFCLE1BQWMsRUFBVyxPQUFnQjtRQUF6QyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVcsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUxyRCxjQUFTLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7UUFDdEMsZUFBVSxHQUF1QixFQUFFLENBQUM7UUFLM0MsTUFBTSxLQUFLLEdBQUcsSUFBSSxTQUFTLEVBQVUsQ0FBQztRQUN0QyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDO1FBQzFDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzNCLFNBQVMsUUFBUSxDQUFDLElBQVk7WUFDNUIsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDMUMsSUFBSSxRQUFRLElBQUksSUFBSTtnQkFBRSxPQUFPLFFBQVEsQ0FBQztZQUN0QyxJQUFJLEVBQUUsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN6QixJQUFJLEVBQUUsR0FBRyxJQUFJLElBQUksTUFBTSxHQUFHLFdBQVcsQ0FBQyxXQUFXLEVBQUU7Z0JBQ2pELE1BQU0sR0FBRyxPQUFPLENBQUMsRUFBRSxHQUFHLE9B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TUFBTSxRQUFRLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO2dCQUFFLFNBQVM7WUFDM0MsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUNoRDtRQUNELElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDNUIsQ0FBQztDQTJCRjtBQUdELE1BQU0sR0FBRyxHQUFtQixDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBVSxDQUFDO0FBQ2xELE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBVSxDQUFDO0FBT3hDLFNBQVMsUUFBUSxDQUFDLENBQU07SUFDdEIsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQVEsQ0FBQztBQUN4QixDQUFDO0FBQ0QsU0FBUyxTQUFTLENBQUksRUFBZSxFQUFFLEVBQVU7SUFDL0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQUssQ0FBQztJQUN6QixLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUNsQixJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUMzQjtJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U2NyZWVufSBmcm9tICcuL3NjcmVlbi5qcyc7XG5pbXBvcnQge1RpbGVFZmZlY3RzfSBmcm9tICcuL3RpbGVlZmZlY3RzLmpzJztcbmltcG9ydCB7VGlsZXNldH0gZnJvbSAnLi90aWxlc2V0LmpzJztcbmltcG9ydCB7UmFuZG9tfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHtVbmlvbkZpbmR9IGZyb20gJy4uL3VuaW9uZmluZC5qcyc7XG5pbXBvcnQge0RlZmF1bHRNYXB9IGZyb20gJy4uL3V0aWwuanMnO1xuXG5leHBvcnQgY2xhc3MgTWFwU2NyZWVuIHtcblxuICByZWFkb25seSBwYXJ0aXRpb24gPSBuZXcgTWFwPG51bWJlciwgbnVtYmVyPigpO1xuICByZWFkb25seSBwYXJ0aXRpb25zOiBBcnJheTxTZXQ8bnVtYmVyPj4gPSBbXTtcblxuICByZWFkb25seSBlZGdlczogcmVhZG9ubHkgbnVtYmVyW107IC8vIDQgZWxlbXM6IHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdFxuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHNjcmVlbjogU2NyZWVuLCByZWFkb25seSB0aWxlc2V0OiBUaWxlc2V0KSB7XG4gICAgY29uc3QgZ3JhcGggPSBuZXcgVW5pb25GaW5kPG51bWJlcj4oKTsgLy8gYWxsIHRpbGVzXG4gICAgY29uc3QgZWZmZWN0cyA9IHRpbGVzZXQuZWZmZWN0cygpLmVmZmVjdHM7XG4gICAgY29uc3Qgc2NyID0gc2NyZWVuLmlkIDw8IDg7XG4gICAgZnVuY3Rpb24gd2Fsa2FibGUodGlsZTogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICBjb25zdCBvdmVycmlkZSA9IE9WRVJSSURFLmdldCh0aWxlIHwgc2NyKTtcbiAgICAgIGlmIChvdmVycmlkZSAhPSBudWxsKSByZXR1cm4gb3ZlcnJpZGU7XG4gICAgICBsZXQgbXQgPSBzY3JlZW4udGlsZXNbdGlsZV07XG4gICAgICBsZXQgZWZmZWN0ID0gZWZmZWN0c1ttdF07XG4gICAgICBpZiAobXQgPCAweDIwICYmIGVmZmVjdCAmIFRpbGVFZmZlY3RzLkFMVEVSTkFUSVZFKSB7XG4gICAgICAgIGVmZmVjdCA9IGVmZmVjdHNbbXQgPSB0aWxlc2V0LmFsdGVybmF0ZXNbbXRdXTtcbiAgICAgIH1cbiAgICAgIC8vIE5PVEU6IHRoaXMgaW5jbHVkZXMgcGl0c1xuICAgICAgcmV0dXJuICEoZWZmZWN0ICYgKFRpbGVFZmZlY3RzLk5PX1dBTEsgfCBUaWxlRWZmZWN0cy5JTVBBU1NJQkxFKSk7XG4gICAgfVxuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgMHhmOyB5KyspIHtcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgMHgxMDsgeCsrKSB7XG4gICAgICAgIGNvbnN0IHQgPSB5IDw8IDQgfCB4O1xuICAgICAgICBpZiAoIXdhbGthYmxlKHQpKSBjb250aW51ZTtcbiAgICAgICAgaWYgKHkgJiYgd2Fsa2FibGUodCAtIDE2KSkgZ3JhcGgudW5pb24oW3QsIHQgLSAxNl0pO1xuICAgICAgICBpZiAoeCAmJiB3YWxrYWJsZSh0IC0gMSkpIGdyYXBoLnVuaW9uKFt0LCB0IC0gMV0pO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBMb29rIGF0IHBlcmltZXRlciBhbmQgY2VudGVyXG4gICAgZm9yIChjb25zdCBzZXQgb2YgZ3JhcGguc2V0cygpKSB7XG4gICAgICBsZXQgcGFydGl0aW9uID0gbnVsbDtcbiAgICAgIGZvciAoY29uc3QgdCBvZiBzZXQpIHtcbiAgICAgICAgaWYgKCFpc1BlcmltZXRlcih0KSAmJiB0ICE9PSAweDg4KSBjb250aW51ZTtcbiAgICAgICAgaWYgKCFwYXJ0aXRpb24pIHRoaXMucGFydGl0aW9ucy5wdXNoKHBhcnRpdGlvbiA9IG5ldyBTZXQ8bnVtYmVyPigpKTtcbiAgICAgICAgcGFydGl0aW9uLmFkZCh0KTtcbiAgICAgICAgdGhpcy5wYXJ0aXRpb24uc2V0KHQsIHRoaXMucGFydGl0aW9ucy5sZW5ndGggLSAxKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZWRnZXMgPSBbMCwgMCwgMCwgMF07XG4gICAgZm9yIChsZXQgaSA9IDE1OyBpID49IDA7IGktLSkge1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA0OyBqKyspIHtcbiAgICAgICAgZWRnZXNbal0gPDw9IDE7XG4gICAgICAgIGNvbnN0IHRpbGUgPSBqIDwgMiA/ICghaiA/IGkgOiBpIDw8IDQgfCAweGYpIDogaiA9PT0gMiA/IDB4ZTAgfCBpIDogaSA8PCA0O1xuICAgICAgICBpZiAodGhpcy5wYXJ0aXRpb24uaGFzKHRpbGUpKSBlZGdlc1tqXSB8PSAxO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmVkZ2VzID0gZWRnZXM7XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNQZXJpbWV0ZXIodDogbnVtYmVyKTogYm9vbGVhbiB7XG4gIGNvbnN0IGNvbCA9IHQgJiAweDBmO1xuICBjb25zdCByb3cgPSB0ICYgMHhmMDtcbiAgcmV0dXJuICFyb3cgfHwgcm93ID09PSAweGUwIHx8ICFjb2wgfHwgY29sID09PSAweGY7XG59XG5cbi8vIG92ZXJyaWRlIHRoZSB3YWxrYWJsZSB0aWxlIG1hc2sgZm9yIHRoZSBib3R0b20gb2Ygc29tZSBzY3JlZW5zXG5jb25zdCBPVkVSUklERSA9IG5ldyBNYXA8bnVtYmVyLCBib29sZWFuPihbXG4gIC4uLnJvd3MoW1xuICAgIFsweDcyMDAsIDBiMDAwMDExMTExMTExMDAwMF0sIC8vIGlnbm9yZSBnYXJnb3lsZXNcbiAgICBbMHg3MmUwLCAwYjAwMDAxMTExMTExMTAwMDBdLCAvLyBpZ25vcmUgZ2FyZ295bGVzXG4gICAgWzB4NzNlMCwgMGIwMDAwMTExMTExMTEwMDAwXSwgLy8ga2VsYmVzcXVlIDIgY2VudGVyIGRlYWQgZW5kXG4gICAgWzB4OWIwMCwgMGIwMDAwMDAxMTExMDAwMDAwXSwgLy8gZGVhZCBlbmRcbiAgICBbMHg5YmUwLCAwYjAwMDAwMDExMTEwMDAwMDBdLCAvLyBkZWFkIGVuZFxuICAgIFsweGZkZTAsIDBiMDAwMDExMTExMTExMDAwMF0sIC8vIGlnbm9yZSBzdGFpcnNcbiAgXSksXG4gIC4uLmNvbHMoW1xuICAgIFsweDdjMDAsIDBdLCAvLyBzd2FtcCBidWcgc2NyZWVuIG1hdGNoZXMgc29saWQgd2FsbCByaWdodC9sZWZ0XG4gICAgWzB4N2MwZiwgMF0sIC8vIChzYW1lKVxuICBdKV0pO1xuXG5mdW5jdGlvbiogcm93cyhyb3dzOiBJdGVyYWJsZTxyZWFkb25seSBbbnVtYmVyLCBudW1iZXJdPik6IEl0ZXJhYmxlPFtudW1iZXIsIGJvb2xlYW5dPiB7XG4gIGZvciAoY29uc3QgW2Jhc2UsIGJpdHNdIG9mIHJvd3MpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyspIHtcbiAgICAgIHlpZWxkIFtiYXNlIHwgaSwgQm9vbGVhbihiaXRzICYgKDEgPDwgaSkpXTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24qIGNvbHMoY29sczogSXRlcmFibGU8cmVhZG9ubHkgW251bWJlciwgbnVtYmVyXT4pOiBJdGVyYWJsZTxbbnVtYmVyLCBib29sZWFuXT4ge1xuICBmb3IgKGNvbnN0IFtiYXNlLCBiaXRzXSBvZiBjb2xzKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxNTsgaSsrKSB7XG4gICAgICB5aWVsZCBbYmFzZSB8IGkgPDwgNCwgQm9vbGVhbihiaXRzICYgKDEgPDwgaSkpXTtcbiAgICB9XG4gIH1cbn1cblxuLy8gLy8gcHJldGVuZCBcIndhbGthYmxlXCIgdGlsZXMgb24gZGVhZCBlbmQgc2NyZWVuc1xuLy8gY29uc3QgT1ZFUlJJREUxID0gbmV3IE1hcDxudW1iZXIsIGJvb2xlYW4+KFtcbi8vICAgLy8gaGVscCBtYXRjaCBuYXJyb3cgZG9vciA/XG4vLyAgIFsweDlhZTYsIHRydWVdLFxuLy8gICBbMHg5YWU5LCB0cnVlXSxcbi8vICAgLy8gdmVydGljYWwgZGVhZCBlbmRcbi8vICAgWzB4OWJlNiwgdHJ1ZV0sXG4vLyAgIFsweDliZTcsIHRydWVdLFxuLy8gICBbMHg5YmU4LCB0cnVlXSxcbi8vICAgWzB4OWJlOSwgdHJ1ZV0sXG4vLyBdKTtcblxuZXhwb3J0IGNsYXNzIE1hcEJ1aWxkZXIge1xuICAvKiogUG9zaXRpdmUgaXMgdGVtcG9yYXJ5LCBvbmVzIGNvbXBsZW1lbnQgaXMgcGVybWFuZW50LiAqL1xuICBzY3JlZW5zOiBBcnJheTxudW1iZXIgfCB1bmRlZmluZWQ+ID0gW107XG4gIC8qKiBTY3JlZW4gSURzIHRoYXQgY2FuIGJlIHVzZWQsIGJ5IGNvbnN0cmFpbnQgKGRpciB8IGVkZ2UgPDwgMikuICovXG4gIHByaXZhdGUgcmVhZG9ubHkgZWRnZXMgPSBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigoKSA9PiBuZXcgU2V0KCkpO1xuICAvKiogU2NyZWVuIGluZGljZXMgKHBvcykgdGhhdCBoYXZlIGF0IGxlYXN0IG9uZSBub24tZW1wdHkgY29uc3RyYWludC4gKi9cbiAgcHJpdmF0ZSBlbGlnaWJsZTogbnVtYmVyW10gPSBbXTtcbiAgLyoqIEFsbCBjb25zdHJhaW50cywgaW5kZXhlZCBieSBbcG9zXVtkaXJdLiAqL1xuICBwcml2YXRlIGNvbnN0cmFpbnRzOiBudW1iZXJbXVtdID0gW107XG4gIC8qKiBTZXQgb2YgYWxsIHVuLWJvdW5kcyBzY3JlZW4gcG9zaXRpb25zLiAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGluQm91bmRzID0gbmV3IFNldDxudW1iZXI+KCk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgdGlsZXNldDogVGlsZXNldCxcbiAgICAgICAgICAgICAgYXZhaWxhYmxlU2NyZWVuczogbnVtYmVyW10sXG4gICAgICAgICAgICAgIHJlYWRvbmx5IHJhbmRvbTogUmFuZG9tLFxuICAgICAgICAgICAgICByZWFkb25seSBoZWlnaHQ6IG51bWJlcixcbiAgICAgICAgICAgICAgcmVhZG9ubHkgd2lkdGg6IG51bWJlcikge1xuICAgIGZvciAoY29uc3Qgc2NyIG9mIGF2YWlsYWJsZVNjcmVlbnMpIHtcbiAgICAgIGZvciAobGV0IGRpciA9IDA7IGRpciA8IDQ7IGRpcisrKSB7XG4gICAgICAgIGNvbnN0IGVkZ2UgPSB0aWxlc2V0LnNjcmVlbnNbc2NyXS5lZGdlc1tkaXJdO1xuICAgICAgICB0aGlzLmVkZ2VzLmdldChkaXIgfCBlZGdlIDw8IDIpLmFkZChzY3IpO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGxldCB5ID0gMDsgeSA8IGhlaWdodDsgeSsrKSB7XG4gICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHdpZHRoOyB4KyspIHtcbiAgICAgICAgdGhpcy5pbkJvdW5kcy5hZGQoeSA8PCA0IHwgeCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqIENoZWNrcyB3aGV0aGVyIHRoZSBnaXZlbiBzY3JlZW4gcG9zaXRpb24gaXMgaW5jbHVkZWQgaW4gdGhpcyBtYXAuICovXG4gIGlzSW5Cb3VuZHMocG9zOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gcG9zID49IDAgJiYgKHBvcyA+Pj4gNCkgPCB0aGlzLmhlaWdodCAmJiAocG9zICYgMHhmKSA8IHRoaXMud2lkdGg7XG4gIH1cblxuICAvKiogUmVzZXQgc2NyZWVucywgZWxpZ2libGUsIGFuZCBjb25zdHJhaW50cy4gKi9cbiAgcmVzZXQoKTogdm9pZCB7XG4gICAgLy8gQ2xlYXIgZXZlcnl0aGluZyBvdXQgZXhjZXB0IGZpeGVkIHNjcmVlbnMuXG4gICAgdGhpcy5lbGlnaWJsZSA9IFtdO1xuICAgIHRoaXMuY29uc3RyYWludHMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGkgb2YgdGhpcy5pbkJvdW5kcykge1xuICAgICAgaWYgKHRoaXMuc2NyZWVuc1tpXSBhcyBudW1iZXIgPCAwKSB7XG4gICAgICAgIC8vIGZpeGVkLCBkbyBub3RoaW5nLlxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zY3JlZW5zW2ldID0gdW5kZWZpbmVkO1xuICAgICAgICBkZWxldGUgdGhpcy5jb25zdHJhaW50c1tpXTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gSW5pdGlhbGl6ZSBjb25zdHJhaW50cy5cbiAgICBmb3IgKGNvbnN0IHBvcyBvZiB0aGlzLmluQm91bmRzKSB7XG4gICAgICB0aGlzLmluaXRDb25zdHJhaW50cyhwb3MpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBJbml0aWFsaXplcyBjb25zdHJhaW50cyBmb3IgYSBzaW5nbGUgbWFwIHNjcmVlbiwgYmFzZWQgb24gY3VycmVudCBtYXAuICovXG4gIGluaXRDb25zdHJhaW50cyhwb3M6IG51bWJlcik6IHZvaWQge1xuICAgIGRlbGV0ZSB0aGlzLmNvbnN0cmFpbnRzW3Bvc107XG4gICAgZm9yIChsZXQgZGlyIG9mIERpcikge1xuICAgICAgY29uc3QgbiA9IHBvcyArIERFTFRBW2Rpcl07XG4gICAgICBpZiAodGhpcy5pbkJvdW5kcy5oYXMobikpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzLnNjcmVlbnNbbl07XG4gICAgICAgIGlmIChzID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgICBzID0gcyA8IDAgPyB+cyA6IHM7XG4gICAgICAgIHRoaXMuYWRkQ29uc3RyYWludChwb3MsIGRpciwgdGhpcy50aWxlc2V0LnNjcmVlbnNbc10uZWRnZXNbZGlyIF4gMl0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gb3V0IG9mIGJvdW1kc1xuICAgICAgICB0aGlzLmFkZENvbnN0cmFpbnQocG9zLCBkaXIsIDApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIGFkZENvbnN0cmFpbnRcblxuICAvLyAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zY3JlZW5zLmxlbmd0aDsgaSsrKSB7XG5cbiAgLy8gICAgIGNvbnN0IHkgPSBpID4+IDQ7XG4gIC8vICAgICBjb25zdCB4ID0gaSAmIDB4ZjtcbiAgLy8gICAgIGxldCBzID0gdGhpcy5zY3JlZW5zW2ldO1xuICAvLyAgICAgY29uc3Qgb3V0T2ZCb3VuZHMgPSAhdGhpcy5pc0luQm91bmRzKGkpO1xuICAvLyAgICAgaWYgKHMgPCAwIHx8IG91dE9mQm91bmRzKSB7XG4gIC8vICAgICAgIC8vIEZpeGVkIHNjcmVlbiBvciBvdXQgb2YgYm91bmRzLlxuICAgICAgICBcbiAgLy8gICAgIH0gZWxzZSB7XG4gIC8vICAgICAgIC8vIEluIGJvdW5kcyBzY3JlZW4sIG5lZWRzIHRvIGJlIGNsZWFyZWRcbiAgLy8gICAgICAgdGhpcy5zY3JlZW5zW2ldID0gdW5kZWZpbmVkO1xuICAvLyAgICAgICB0aGlzLmNvbnN0cmFpbnRzW2ldID0gW107XG4gIC8vICAgICAgIGZvciAobGV0IGRpciA9IDA7IGRpciA8IDQ7IGRpcisrKSB7XG4gIC8vICAgICAgICAgY29uc3QgbmVpZ2hib3IgPSBpICsgREVMVEFbZGlyXTtcbiAgLy8gICAgICAgICBpZiAodGhpcy5pc0luQm91bmRzKG5laWdoYm9yKSkge1xuICAvLyAgICAgICAgICAgY29uc3QgbmVpZ2hib3JTY3JlZW4gPSB0aGlzLnNjcmVlbnNbbmVpZ2hib3JdO1xuICAvLyAgICAgICAgICAgaWYgKG5laWdoYm9yU2NyZWVuICE9IG51bGwgJiYgbmVpZ2hib3JTY3JlZW4gPCAwKSB7XG4gIC8vICAgICAgICAgICAgIGNvbnN0IGVkZ2UgPSB0aGlzLnRpbGVzZXQuc2NyZWVuc1t+bmVpZ2hib3JTY3JlZW5dLmVkZ2VzW2RpciBeIDJdO1xuICAvLyAgICAgICAgICAgICB0aGlzLmFkZENvbnN0cmFpbnQoaSwgZGlyIGFzIERpciwgZWRnZSk7XG4gIC8vICAgICAgICAgICB9XG4gIC8vICAgICAgICAgfSBlbHNlIHtcbiAgLy8gICAgICAgICAgIHRoaXMuYWRkQ29uc3RyYWludChpLCBkaXIgYXMgRGlyLCAwKTtcbiAgLy8gICAgICAgICB9XG4gIC8vICAgICAgIH1cbiAgLy8gICAgIH1cbiAgLy8gICB9XG4gIC8vIH1cblxuICAvKiogQWRkcyBhIGNvbnN0cmFpbnQsIG9wdGlvbmFsbHkgbWFya2luZyB0aGUgc2NyZWVuIGFzIGVsaWdpYmxlLiAqL1xuICBhZGRDb25zdHJhaW50KHNjcjogbnVtYmVyLCBkaXI6IERpciwgZWRnZTogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmluQm91bmRzLmhhcyhzY3IpIHx8IHRoaXMuc2NyZWVuc1tzY3JdICE9IG51bGwpIHJldHVybjtcbiAgICBsZXQgY29uc3RyYWludHMgPSB0aGlzLmNvbnN0cmFpbnRzW3Njcl07XG4gICAgaWYgKCFjb25zdHJhaW50cykge1xuICAgICAgdGhpcy5jb25zdHJhaW50c1tzY3JdID0gY29uc3RyYWludHMgPSBbXTtcbiAgICAgIHRoaXMuZWxpZ2libGUucHVzaChzY3IpO1xuICAgIH1cbiAgICBjb25zdHJhaW50c1tkaXJdID0gZWRnZTtcbiAgfVxuXG4gIC8qKiBEZWxldGVzIGEgY29uc3RyYWludCwgb3B0aW9uYWxseSBtYXJraW5nIHRoZSBzY3JlZW4gYXMgaW5lbGlnaWJsZS4gKi9cbiAgZGVsZXRlQ29uc3RyYWludChzY3I6IG51bWJlciwgZGlyOiBEaXIpOiB2b2lkIHtcbiAgICBsZXQgY29uc3RyYWludHMgPSB0aGlzLmNvbnN0cmFpbnRzW3Njcl07XG4gICAgaWYgKCFjb25zdHJhaW50cykgcmV0dXJuO1xuICAgIC8vIGFzc2VydChjb25zdHJhaW50cyk7XG4gICAgZGVsZXRlIGNvbnN0cmFpbnRzW2Rpcl07XG4gICAgZm9yIChsZXQgaSA9IGNvbnN0cmFpbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBpZiAoY29uc3RyYWludHNbaV0gIT0gbnVsbCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5lbGlnaWJsZS5maW5kSW5kZXgoeCA9PiB4ICE9IG51bGwpO1xuICAgIGlmIChpbmRleCA+PSAwKSB0aGlzLmVsaWdpYmxlLnNwbGljZShpbmRleCwgMSk7XG4gIH1cblxuICAvKiogUmV0dXJucyBhbiBhcnJheSBpZiB0aGUgZmlsbCBzdWNjZWVkZWQuICovXG4gIGZpbGwoYmFja3RyYWNrczogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgLy8gUGxhbjogUGljayBhIHJhbmRvbSB1bmZpbGxlZCBzcG90LCBmaW5kIGEgc2NyZWVuIHRoYXQgZml0cy5cbiAgICAvLyBJZiBub25lIGZpdHMsIHBpY2sgYSByYW5kb20gb25lIHRoYXQgZml0cyB3aXRoIG5vbi1yZW1vdmFibGVcbiAgICAvLyBuZWlnaGJvcnMuICBSZW1vdmUgYW55IGNvbmZsaWN0cy4gIENoZWNrIGZvciBhIHNvbHV0aW9uLiAgSWZcbiAgICAvLyBub25lIGV4aXN0cywgdHJ5IGFnYWluLlxuICAgIC8vIHRoaXMuZmlsbENvbnN0cmFpbnRzKCk7XG4gICAgLy8gdGhpcy5maW5kVW5maWxsZWQoKTtcblxuICAgIC8vIE5vdyBsb29wIHdoaWxlIHRoZXJlJ3MgYW55dGhpbmcgdW5maWxsZWQsIG9yIGZvciBXKkgqMTAwIGl0ZXJzXG4gICAgbGV0IHBvczogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICAgIHdoaWxlICgocG9zID0gdGhpcy5maW5kRW1wdHkoKSkgIT0gbnVsbCAvKiBlbGlnaWJsZS5sZW5ndGggKi8gJiYgYmFja3RyYWNrcyA+PSAwKSB7XG4gICAgICAvLyBFYWNoIGF0dGVtcHQ6IHBpY2sgYW4gdW5maWxsZWQgdGlsZSB0aGF0IG5laWdoYm9ycyBzb21ldGhpbmcgZmlsbGVkLlxuICAgICAgLy90aGlzLmVuc3VyZUVsaWdpYmxlKCk7XG4gICAgICAvL2NvbnN0IGluZGV4ID0gdGhpcy5yYW5kb20ubmV4dEludCh0aGlzLmVsaWdpYmxlLmxlbmd0aCk7XG4gICAgICAvL2NvbnN0IHBvcyA9IHRoaXMuZWxpZ2libGVbaW5kZXhdO1xuICAgICAgY29uc3Qgc2NyID0gdGhpcy5waWNrU2NyZWVuKHBvcyk7XG4gICAgICBpZiAoc2NyICE9IG51bGwpIHtcbiAgICAgICAgLy8gZm91bmQgYSBzY3JlZW46IHNldCBpdCBhbmQgc3BsaWNlIGVsaWdpYmxlXG4gICAgICAgIC8vdGhpcy5lbGlnaWJsZS5zcGxpY2UoaW5kZXgpO1xuICAgICAgICB0aGlzLnNldFNjcmVlbihwb3MsIHNjcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBubyBzY3JlZW4gZml0OiByZW1vdmUgYSBuZWlnaGJvclxuICAgICAgICB0aGlzLmRlbGV0ZU9uZU5laWdoYm9yKHBvcyk7XG4gICAgICAgIGJhY2t0cmFja3MtLTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcG9zID09IG51bGw7IC8vICF0aGlzLmVsaWdpYmxlLmxlbmd0aDtcbiAgfVxuXG4gIGZpbmRFbXB0eSgpOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHNjcmVlbnMgPSB0aGlzLnJhbmRvbS5zaHVmZmxlKFsuLi50aGlzLmluQm91bmRzXSk7XG4gICAgZm9yIChjb25zdCBwb3Mgb2Ygc2NyZWVucykge1xuICAgICAgLy9pZiAodGhpcy5zY3JlZW5zW3Bvc10gPT0gbnVsbCAmJiB0aGlzLmNvbnN0cmFpbnRzW3Bvc10pIHJldHVybiBwb3M7XG4gICAgICBpZiAodGhpcy5zY3JlZW5zW3Bvc10gPT0gbnVsbCAmJiAodGhpcy5jb25zdHJhaW50c1twb3NdIHx8IFtdKS5zb21lKHggPT4geCAhPSBudWxsKSkgcmV0dXJuIHBvcztcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGRlbGV0ZVNvbWVTY3JlZW5zKCk6IHZvaWQge1xuICAgIGNvbnN0IGZpbGxlZCA9IFtdO1xuICAgIGZvciAoY29uc3QgcG9zIG9mIHRoaXMuaW5Cb3VuZHMpIHtcbiAgICAgIGlmICh0aGlzLnNjcmVlbnNbcG9zXSBhcyBudW1iZXIgPj0gMCkge1xuICAgICAgICBmaWxsZWQucHVzaChwb3MpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnJhbmRvbS5zaHVmZmxlKGZpbGxlZCk7XG4gICAgY29uc3QgY291bnQgPSAxICsgdGhpcy5yYW5kb20ubmV4dEludChmaWxsZWQubGVuZ3RoIC0gMSk7XG4gICAgZm9yIChjb25zdCBwb3Mgb2YgZmlsbGVkLnNsaWNlKDAsIGNvdW50KSkge1xuICAgICAgdGhpcy5kZWxldGVTY3JlZW4ocG9zKTtcbiAgICB9XG4gICAgLy8gaWYgKCF0aGlzLmVsaWdpYmxlLmxlbmd0aCkge1xuICAgIC8vICAgLy8gY2hlY2sgdHJhdmVyc2FiaWxpdHkuICBpZiBub3QgdHJhdmVyc2libGUgdGhlbiBwaWNrIG9uZSByZXBsYWNlbWVudFxuICAgIC8vICAgLy8gYmFzZWQgb24gYSBzaW5nbGUgY29uc3RyYWludCwgaWdub3JpbmcgdGhlIHJlc3QgYW5kIHJlbW92aW5nIGFueSB0aGF0XG4gICAgLy8gICAvLyBhcmUgaW5jb21wYXRpYmxlLlxuICAgIC8vICAgaWYgKHRoaXMuY2FuVHJhdmVyc2UodGlsZXMpKSB7XG4gICAgLy8gICAgIHJldHVybiBzZXEodGhpcy5oZWlnaHQsIHkgPT4gc2VxKHRoaXMud2lkdGgsIHggPT4gdGhpcy5zY3JlZW5zW3kgPDwgNCB8IHhdISkpO1xuICAgIC8vICAgfVxuICAgIC8vIH1cbiAgICAvLyBjb25zdCBiaXRzID0gdGhpcy5yYW5kb20uYml0R2VuZXJhdG9yKCk7XG4gICAgLy8gZm9yIChjb25zdCBwb3Mgb2YgdGhpcy5pbkJvdW5kcykge1xuICAgIC8vICAgaWYgKHRoaXMuc2NyZWVuc1twb3NdIGFzIG51bWJlciA+IDAgJiYgYml0cygpKSB7XG4gICAgLy8gICAgIHRoaXMuZGVsZXRlU2NyZWVuKHBvcyk7XG4gICAgLy8gICB9XG4gICAgLy8gfVxuICAgIC8vIGlmICghdGhpcy5lbGlnaWJsZS5sZW5ndGgpIHRoaXMucmVzZXQoKTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIFRyYXZlcnNlcyB0aGUgY3VycmVudCBtYXAsIHJldHVybmluZyB0aGUgcGFydGl0aW9uIG1hcC4gIEFsbCBrZXlzIHRvIHRoaXNcbiAgICogbWFwIHdpbGwgYmUgZWl0aGVyIFwib25cIiBhbiBlZGdlIChlaXRoZXIgc3ViLXNjcmVlbiB4IG9yIHkgd2lsbCBiZSAwLCBlLmcuXG4gICAqICQ0MzBjIGlzIGFuIGVkZ2UsICQzM2VjICh0aGUgYWRqYWNlbnQgdGlsZSBvbiB0aGUgYm90dG9tIGVkZ2Ugb2YgdGhlIGFib3ZlXG4gICAqIHNjcmVlbikgaXMgbm90LlxuICAgKi9cbiAgdHJhdmVyc2UoKTogTWFwPG51bWJlciwgbnVtYmVyPiB7XG4gICAgY29uc3QgdWYgPSBuZXcgVW5pb25GaW5kPG51bWJlcj4oKTtcbiAgICBmb3IgKGNvbnN0IHBvcyBvZiB0aGlzLmluQm91bmRzKSB7XG4gICAgICBsZXQgc2NyID0gdGhpcy5zY3JlZW5zW3Bvc10gYXMgbnVtYmVyO1xuICAgICAgY29uc3QgcGFydHMgPSB0aGlzLnRpbGVzZXQuc2NyZWVuc1tzY3IgPCAwID8gfnNjciA6IHNjcl0ucGFydGl0aW9ucy5tYXAoXG4gICAgICAgIHBhcnQgPT4gWy4uLnBhcnRdLm1hcCh0ID0+e1xuICAgICAgICAgIHQgPSBwb3MgPDwgOCB8IHQ7XG4gICAgICAgICAgaWYgKCh0ICYgMHhmMCkgPT09IDB4ZTApIHQgKz0gMHgyMDtcbiAgICAgICAgICBpZiAoKHQgJiAweDBmKSA9PT0gMHgwZikgdCArPSAweDAxO1xuICAgICAgICAgIHJldHVybiB0O1xuICAgICAgICB9KSk7XG4gICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGFydHMpIHtcbiAgICAgICAgdWYudW5pb24ocGFydCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHNldHMgPSB1Zi5zZXRzKCk7XG4gICAgY29uc3QgbWFwID0gbmV3IE1hcDxudW1iZXIsIG51bWJlcj4oKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNldHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGZvciAoY29uc3QgdGlsZSBvZiBzZXRzW2ldKSB7XG4gICAgICAgIG1hcC5zZXQodGlsZSwgaSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBtYXA7XG4gIH1cblxuICAvKiogUGlja3MgYSByYW5kb20gbmVpZ2hib3IgdG8gZGVsZXRlLiAqL1xuICBkZWxldGVPbmVOZWlnaGJvcihwb3M6IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IGRpcnMgPSB0aGlzLnJhbmRvbS5zaHVmZmxlKFsuLi5EaXJdKTtcbiAgICBmb3IgKGNvbnN0IGRpciBvZiBkaXJzKSB7XG4gICAgICBjb25zdCBuZWlnaGJvciA9IHBvcyArIERFTFRBW2Rpcl07XG4gICAgICBpZiAoIXRoaXMuaW5Cb3VuZHMuaGFzKG5laWdoYm9yKSB8fFxuICAgICAgICAgICEodGhpcy5zY3JlZW5zW25laWdoYm9yXSBhcyBudW1iZXIgPj0gMCkpIGNvbnRpbnVlO1xuICAgICAgdGhpcy5kZWxldGVTY3JlZW4obmVpZ2hib3IpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIGEgbmVpZ2hib3IgdG8gZGVsZXRlIWApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdpdmVuIGEgc2NyZWVuIHBvc2l0aW9uIHdpdGggYXQgbGVhc3Qgb25lIGNvbnN0cmFpbnQsIGZpbmQgYSB2YWxpZCBzY3JlZW5cbiAgICogdG8gZmlsbCBpbnRvIGl0LCBhbmQgZmlsbCBpdCBpbi4gIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLlxuICAgKi9cbiAgcGlja1NjcmVlbihwb3M6IG51bWJlcik6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgLy8gR2l2ZW4gYXQgbGVhc3Qgb25lIGNvbnN0cmFpbnQgLSBmaW5kIGl0IGFuZCBzdG9yZSBvcHRpb25zIGhlcmUuXG4gICAgLy8gVW5kZWZpbmVkIGlzIHVuY29uc3RyYWluZWQuXG4gICAgbGV0IHNjcmVlbnM6IFNldDxudW1iZXI+IHwgdW5kZWZpbmVkO1xuICAgIC8vIExvb2sgYXQgdGhlIGNvbnN0cmFpbnRzLlxuICAgIGNvbnN0IGNvbnN0cmFpbnRzID0gdGhpcy5jb25zdHJhaW50c1twb3NdO1xuICAgIGZvciAobGV0IGRpciA9IDA7IGRpciA8IGNvbnN0cmFpbnRzLmxlbmd0aDsgZGlyKyspIHtcbiAgICAgIGNvbnN0IGVkZ2UgPSBjb25zdHJhaW50c1tkaXJdO1xuICAgICAgaWYgKGVkZ2UgPT0gbnVsbCkgY29udGludWU7XG4gICAgICBjb25zdCBzZXQgPSB0aGlzLmVkZ2VzLmdldChkaXIgfCBlZGdlIDw8IDIpOztcbiAgICAgIHNjcmVlbnMgPSAhc2NyZWVucyA/IHNldCA6IGludGVyc2VjdChzY3JlZW5zLCBzZXQpO1xuICAgIH1cbiAgICAvLyBzY3JlZW5zIG5vdyBoYXMgYWxsIHBvc3NpYmxlIHNjcmVlbiBJRHNcbiAgICBpZiAoIXNjcmVlbnMgfHwgIXNjcmVlbnMuc2l6ZSkgcmV0dXJuIHVuZGVmaW5lZDsgLy8gdW5hYmxlLCBuZWVkIHRvIGJhY2t0cmFjaz9cbiAgICBjb25zdCBlbGlnaWJsZSA9IFsuLi5zY3JlZW5zXTtcbiAgICByZXR1cm4gdGhpcy5yYW5kb20ucGljayhlbGlnaWJsZSk7XG4gIH1cblxuICAvKiogU2V0cyB0aGUgc2NyZWVuIGF0IHRoZSBnaXZlbiBwb3NpdGlvbiwgdXBkYXRpbmcgY29uc3RyYWludHMuICovXG4gIHNldFNjcmVlbihwb3M6IG51bWJlciwgc2NyOiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5zY3JlZW5zW3Bvc10gIT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdzY3JlZW4gYWxyZWFkeSBzZXQnKTtcbiAgICB0aGlzLnNjcmVlbnNbcG9zXSA9IHNjcjtcbiAgICBkZWxldGUgdGhpcy5jb25zdHJhaW50c1twb3NdO1xuICAgIGNvbnN0IGVkZ2VzID0gdGhpcy50aWxlc2V0LnNjcmVlbnNbc2NyXS5lZGdlcztcbiAgICAvLyBhZGQgY29uc3RyYWludHMgdG8gbmVpZ2hib3JzXG4gICAgZm9yIChjb25zdCBkaXIgb2YgRGlyKSB7XG4gICAgICBjb25zdCBuZWlnaGJvciA9IHBvcyArIERFTFRBW2Rpcl07XG4gICAgICAvL2lmICghdGhpcy5pbkJvdW5kcy5oYXMobmVpZ2hib3IpIHx8IHRoaXMuc2NyZWVuc1tuZWlnaGJvcl0gIT0gbnVsbCkgY29udGludWU7XG4gICAgICB0aGlzLmFkZENvbnN0cmFpbnQobmVpZ2hib3IsIG9wcG9zaXRlKGRpciksIGVkZ2VzW2Rpcl0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBEZWxldGVzIHRoZSBzY3JlZW4gYXQgdGhlIGdpdmVuIHBvc2l0aW9uLiAqL1xuICBkZWxldGVTY3JlZW4ocG9zOiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCBwcmV2aW91cyA9IHRoaXMuc2NyZWVuc1twb3NdO1xuICAgIHRoaXMuc2NyZWVuc1twb3NdID0gdW5kZWZpbmVkO1xuICAgIGlmIChwcmV2aW91cyA9PSBudWxsKSByZXR1cm47XG4gICAgaWYgKHByZXZpb3VzIDwgMCkgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZGVsZXRlIGZpeGVkIHNjcmVlbmApO1xuICAgIGZvciAoY29uc3QgZGlyIG9mIERpcikge1xuICAgICAgY29uc3QgbmVpZ2hib3IgPSBwb3MgKyBERUxUQVtkaXJdO1xuICAgICAgaWYgKCF0aGlzLmluQm91bmRzLmhhcyhuZWlnaGJvcikpIGNvbnRpbnVlO1xuICAgICAgdGhpcy5kZWxldGVDb25zdHJhaW50KG5laWdoYm9yLCBvcHBvc2l0ZShkaXIpKTtcbiAgICB9XG4gICAgdGhpcy5pbml0Q29uc3RyYWludHMocG9zKTtcbiAgfVxuXG4gIC8vIHByaXZhdGUgcGlja0VtcHR5KCk6IG51bWJlciB7XG4gIC8vICAgd2hpbGUgKHRydWUpIHtcbiAgLy8gICAgIGxldCBwb3M7XG4gIC8vICAgICBpZiAodGhpcy51bmZpbGxlZC5zaXplID4gNCkge1xuICAvLyAgICAgICBjb25zdCB5eCA9IHRoaXMucmFuZG9tLm5leHRJbnQodGhpcy53aWR0aCAqIHRoaXMuaGVpZ2h0KTtcbiAgLy8gICAgICAgY29uc3QgeSA9IE1hdGguZmxvb3IoeXggLyB0aGlzLndpZHRoKTtcbiAgLy8gICAgICAgY29uc3QgeCA9IHl4ICUgdGhpcy53aWR0aDtcbiAgLy8gICAgICAgcG9zID0geSA8PCA0IHwgeDtcbiAgLy8gICAgIH0gZWxzZSB7XG4gIC8vICAgICAgIHBvcyA9IHRoaXMucmFuZG9tLnBpY2soWy4uLnRoaXMudW5maWxsZWRdKTtcbiAgLy8gICAgIH1cbiAgLy8gICAgIC8vIENoZWNrIGlmIGl0J3MgdW5maWxsZWQuXG4gIC8vICAgICBpZiAoIXRoaXMudW5maWxsZWQuaGFzKHBvcykpIGNvbnRpbnVlO1xuICAvLyAgICAgLy8gQ2hlY2sgdGhhdCBhdCBsZWFzdCBvbmUgbmVpZ2hib3IgaXMgZmlsbGVkIG9yIHdlJ3JlIG9uIHRoZSBlZGdlLlxuICAvLyAgICAgY29uc3Qgcm93ID0gKHBvcyAmIDB4ZjApID4+PiA0O1xuICAvLyAgICAgY29uc3QgY29sID0gcG9zICYgMHgwZjtcbiAgLy8gICAgIGlmICghcm93IHx8ICFjb2wpIHJldHVybiBwb3M7XG4gIC8vICAgICBpZiAocm93ID09PSB0aGlzLmhlaWdodCAtIDEpIHJldHVybiBwb3M7XG4gIC8vICAgICBpZiAoY29sID09PSB0aGlzLndpZHRoIC0gMSkgcmV0dXJuIHBvcztcbiAgLy8gICAgIGlmICghdGhpcy51bmZpbGxlZC5oYXMocG9zIC0gMSkpIHJldHVybiBwb3M7XG4gIC8vICAgICBpZiAoIXRoaXMudW5maWxsZWQuaGFzKHBvcyAtIDE2KSkgcmV0dXJuIHBvcztcbiAgLy8gICAgIGlmICghdGhpcy51bmZpbGxlZC5oYXMocG9zICsgMSkpIHJldHVybiBwb3M7XG4gIC8vICAgICBpZiAoIXRoaXMudW5maWxsZWQuaGFzKHBvcyArIDE2KSkgcmV0dXJuIHBvcztcbiAgLy8gICB9XG4gIC8vIH1cbn1cblxudHlwZSBEaXIgPSAwIHwgMSB8IDIgfCAzO1xuY29uc3QgRGlyOiByZWFkb25seSBEaXJbXSA9IFswLCAxLCAyLCAzXSBhcyBjb25zdDtcbmNvbnN0IERFTFRBID0gWy0xNiwgMSwgMTYsIC0xXSBhcyBjb25zdDtcbi8vIGNvbnN0IEVER0U6IFJlYWRvbmx5QXJyYXk8KGluZGV4OiBudW1iZXIpID0+IG51bWJlcj4gPSBbXG4vLyAgIGkgPT4gaSxcbi8vICAgaSA9PiBpIDw8IDQgfCAweGYsXG4vLyAgIGkgPT4gMHhlMCB8IGksXG4vLyAgIGkgPT4gaSA8PCA0LFxuLy8gXTtcbmZ1bmN0aW9uIG9wcG9zaXRlKGQ6IERpcik6IERpciB7XG4gIHJldHVybiAoZCBeIDIpIGFzIERpcjtcbn1cbmZ1bmN0aW9uIGludGVyc2VjdDxUPih4czogSXRlcmFibGU8VD4sIHlzOiBTZXQ8VD4pOiBTZXQ8VD4ge1xuICBjb25zdCBvdXQgPSBuZXcgU2V0PFQ+KCk7XG4gIGZvciAoY29uc3QgeCBvZiB4cykge1xuICAgIGlmICh5cy5oYXMoeCkpIG91dC5hZGQoeCk7XG4gIH1cbiAgcmV0dXJuIG91dDtcbn1cblxuIl19