import { hex } from './util.js';
function page(addr) {
    return addr >>> 13;
}
class Chunk {
    constructor(start, end) {
        this.start = start;
        this.end = end;
        this.page = page(start);
        if (page(end - 1) !== this.page)
            throw new Error('Chunk spans pages');
        this.pos = start;
    }
    free() {
        return this.end - this.pos;
    }
    find(data, rom) {
        for (let i = this.start; i <= this.pos - data.length; i++) {
            let found = true;
            for (let j = 0; j < data.length; j++) {
                if (rom[i + j] !== data[j]) {
                    found = false;
                    break;
                }
            }
            if (found)
                return i;
        }
        return -1;
    }
}
export class Writer {
    constructor(rom, chr) {
        this.rom = rom;
        this.chr = chr;
        this.chunks = [];
        this.writes = [];
        this.promises = [];
        this.free = [];
    }
    alloc(start, end) {
        while (page(end - 1) > page(start)) {
            const boundary = (page(start) + 1) << 13;
            this.addChunk(new Chunk(start, boundary - 1));
            start = boundary;
        }
        this.addChunk(new Chunk(start, end));
    }
    addChunk(c) {
        this.chunks.push(c);
        this.free[c.page] = (this.free[c.page] || 0) + c.free();
    }
    async write(data, start, end, name) {
        const startPage = page(start);
        const endPage = page(end - 1);
        const p = new Promise((resolve, reject) => {
            this.writes.push({ data, resolve, reject, startPage, endPage, name });
        });
        this.promises.push(p.catch(() => { }));
        return p;
    }
    async commit() {
        while (this.writes.length) {
            const writes = this.writes;
            this.writes = [];
            const promises = this.promises;
            this.promises = [];
            writes.sort((a, b) => ((a.endPage - a.startPage) - (b.endPage - b.startPage)) ||
                (b.data.length - a.data.length));
            for (const write of writes) {
                const address = this.find(write);
                if (address >= 0) {
                    write.resolve(address);
                }
                else {
                    this.writeOne(write);
                }
            }
            await Promise.all(promises);
            await 0;
            await 0;
            await 0;
        }
    }
    find({ data, startPage, endPage }) {
        for (const chunk of this.chunks) {
            if (chunk.page < startPage || chunk.page > endPage)
                continue;
            const found = chunk.find(data, this.rom);
            if (found >= 0)
                return found;
        }
        return -1;
    }
    writeOne(write) {
        for (const chunk of this.chunks) {
            if (chunk.page < write.startPage || chunk.page > write.endPage)
                continue;
            if (chunk.free() < write.data.length)
                continue;
            this.rom.subarray(chunk.pos, chunk.pos + write.data.length).set(write.data);
            write.resolve(chunk.pos);
            this.free[chunk.page] -= write.data.length;
            chunk.pos += write.data.length;
            return;
        }
        console.log(`${write.name}: WRITE FAILED ${write.data.length} bytes: ${Array.from(write.data, hex).join(' ')}`);
        write.reject(new Error(`Could not find sufficient chunk in ${hex(write.startPage)}..${hex(write.endPage)} to write ${write.name}: ${write.data}`));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JpdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3JvbS93cml0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFPLEdBQUcsRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUVwQyxTQUFTLElBQUksQ0FBQyxJQUFZO0lBQ3hCLE9BQU8sSUFBSSxLQUFLLEVBQUUsQ0FBQztBQUNyQixDQUFDO0FBRUQsTUFBTSxLQUFLO0lBSVQsWUFBcUIsS0FBYSxFQUFXLEdBQVc7UUFBbkMsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUFXLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDdEQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDO0lBQ25CLENBQUM7SUFFRCxJQUFJO1FBQ0YsT0FBTyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDN0IsQ0FBQztJQUdELElBQUksQ0FBQyxJQUFrQixFQUFFLEdBQWU7UUFDdEMsS0FBSyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDekQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ2pCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNwQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENB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aW9uIHBhZ2UoYWRkcjogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIGFkZHIgPj4+IDEzO1xufVxuXG5jbGFzcyBDaHVuayB7XG4gIHBhZ2U6IG51bWJlcjtcbiAgcG9zOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgc3RhcnQ6IG51bWJlciwgcmVhZG9ubHkgZW5kOiBudW1iZXIpIHtcbiAgICB0aGlzLnBhZ2UgPSBwYWdlKHN0YXJ0KTtcbiAgICBpZiAocGFnZShlbmQgLSAxKSAhPT0gdGhpcy5wYWdlKSB0aHJvdyBuZXcgRXJyb3IoJ0NodW5rIHNwYW5zIHBhZ2VzJyk7XG4gICAgdGhpcy5wb3MgPSBzdGFydDtcbiAgfVxuXG4gIGZyZWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuZW5kIC0gdGhpcy5wb3M7XG4gIH1cblxuICAvKiogUmV0dXJucyB0aGUgYWRkcmVzcyAoPj0gMCkgaWYgZm91bmQsIG9yIC0xIGlmIG5vdCBmb3VuZC4gKi9cbiAgZmluZChkYXRhOiBEYXRhPG51bWJlcj4sIHJvbTogVWludDhBcnJheSk6IG51bWJlciB7XG4gICAgZm9yIChsZXQgaSA9IHRoaXMuc3RhcnQ7IGkgPD0gdGhpcy5wb3MgLSBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgZm91bmQgPSB0cnVlO1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBkYXRhLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGlmIChyb21baSArIGpdICE9PSBkYXRhW2pdKSB7XG4gICAgICAgICAgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGZvdW5kKSByZXR1cm4gaTtcbiAgICB9XG4gICAgLy8gY29uc29sZS5sb2coYGNvdWxkIG5vdCBmaW5kICR7ZGF0YS5tYXAoeD0+eC50b1N0cmluZygxNikpfWApO1xuICAgIHJldHVybiAtMTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgV3JpdGUge1xuICByZWFkb25seSBkYXRhOiBEYXRhPG51bWJlcj47XG4gIHJlYWRvbmx5IHJlc29sdmU6IChhZGRyZXNzOiBudW1iZXIpID0+IHZvaWQ7XG4gIHJlYWRvbmx5IHJlamVjdDogKGVycjogdW5rbm93bikgPT4gdm9pZDtcbiAgcmVhZG9ubHkgc3RhcnRQYWdlOiBudW1iZXI7XG4gIHJlYWRvbmx5IGVuZFBhZ2U6IG51bWJlcjsgLy8gaW5jbHVzaXZlXG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbn1cblxuLy8gdHlwZSBEYXRhID0gVWludDhBcnJheSB8IG51bWJlcltdO1xuXG5leHBvcnQgY2xhc3MgV3JpdGVyIHtcblxuICAvL3ByaXZhdGUgd3JpdGluZyA9IGZhbHNlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgY2h1bmtzOiBDaHVua1tdID0gW107XG4gIHByaXZhdGUgd3JpdGVzOiBXcml0ZVtdID0gW107XG4gIHByaXZhdGUgcHJvbWlzZXM6IFByb21pc2U8dW5rbm93bj5bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogVWludDhBcnJheSwgcmVhZG9ubHkgY2hyOiBVaW50OEFycmF5KSB7fVxuXG4gIHByaXZhdGUgZnJlZTogbnVtYmVyW10gPSBbXTtcblxuICAvLyBUT0RPOiBtb3ZlKCk/XG5cbiAgLyoqIE5vdGU6IHN0YXJ0IGFuZCBlbmQgcGFnZXMgbXVzdCBiZSB0aGUgc2FtZSEgICdlbmQnIGlzIGV4Y2x1c2l2ZS4gKi9cbiAgYWxsb2Moc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIpIHtcbiAgICB3aGlsZSAocGFnZShlbmQgLSAxKSA+IHBhZ2Uoc3RhcnQpKSB7XG4gICAgICBjb25zdCBib3VuZGFyeSA9IChwYWdlKHN0YXJ0KSArIDEpIDw8IDEzO1xuICAgICAgdGhpcy5hZGRDaHVuayhuZXcgQ2h1bmsoc3RhcnQsIGJvdW5kYXJ5IC0gMSkpO1xuICAgICAgc3RhcnQgPSBib3VuZGFyeTtcbiAgICB9XG4gICAgdGhpcy5hZGRDaHVuayhuZXcgQ2h1bmsoc3RhcnQsIGVuZCkpO1xuICB9XG5cbiAgYWRkQ2h1bmsoYzogQ2h1bmspIHtcbiAgICB0aGlzLmNodW5rcy5wdXNoKGMpO1xuICAgIHRoaXMuZnJlZVtjLnBhZ2VdID0gKHRoaXMuZnJlZVtjLnBhZ2VdIHx8IDApICsgYy5mcmVlKCk7XG4gIH1cblxuICAvLyBUT0RPOiBjb25zaWRlciByZW5hbWluZyB0aGlzIHRvIHF1ZXVlKCkgb3IgcGxhbigpIG9yIHNvbWV0aGluZz9cbiAgYXN5bmMgd3JpdGUoZGF0YTogRGF0YTxudW1iZXI+LCBzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlciwgbmFtZTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAvL2lmICh0aGlzLndyaXRpbmcpIGNvbnNvbGUubG9nKGBMYXRlIHdyaXRlOiAke25hbWV9YCk7XG4gICAgY29uc3Qgc3RhcnRQYWdlID0gcGFnZShzdGFydCk7XG4gICAgY29uc3QgZW5kUGFnZSA9IHBhZ2UoZW5kIC0gMSk7XG4gICAgY29uc3QgcCA9IG5ldyBQcm9taXNlPG51bWJlcj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy53cml0ZXMucHVzaCh7ZGF0YSwgcmVzb2x2ZSwgcmVqZWN0LCBzdGFydFBhZ2UsIGVuZFBhZ2UsIG5hbWV9KTtcbiAgICB9KTtcbiAgICB0aGlzLnByb21pc2VzLnB1c2gocC5jYXRjaCgoKSA9PiB7fSkpO1xuICAgIHJldHVybiBwO1xuICB9XG5cbiAgYXN5bmMgY29tbWl0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vdGhpcy53cml0aW5nID0gdHJ1ZTtcbiAgICB3aGlsZSAodGhpcy53cml0ZXMubGVuZ3RoKSB7XG4gICAgICBjb25zdCB3cml0ZXMgPSB0aGlzLndyaXRlcztcbiAgICAgIHRoaXMud3JpdGVzID0gW107XG4gICAgICBjb25zdCBwcm9taXNlcyA9IHRoaXMucHJvbWlzZXM7XG4gICAgICB0aGlzLnByb21pc2VzID0gW107XG4gICAgICB3cml0ZXMuc29ydChcbiAgICAgICAgICAoYSwgYikgPT4gKChhLmVuZFBhZ2UgLSBhLnN0YXJ0UGFnZSkgLSAoYi5lbmRQYWdlIC0gYi5zdGFydFBhZ2UpKSB8fFxuICAgICAgICAgIChiLmRhdGEubGVuZ3RoIC0gYS5kYXRhLmxlbmd0aCkpO1xuICAgICAgZm9yIChjb25zdCB3cml0ZSBvZiB3cml0ZXMpIHtcbiAgICAgICAgY29uc3QgYWRkcmVzcyA9IHRoaXMuZmluZCh3cml0ZSk7XG4gICAgICAgIGlmIChhZGRyZXNzID49IDApIHtcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKGAke3dyaXRlLm5hbWV9OiBvdmVybGFwcyBhdCAke2hleChhZGRyZXNzKX1gKTtcbiAgICAgICAgICB3cml0ZS5yZXNvbHZlKGFkZHJlc3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMud3JpdGVPbmUod3JpdGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7XG4gICAgICAvLyBOT1RFOiBUaGlzIGlzIHByZXR0eSBiYWQgLSBob3cgY2FuIHdlIHRlbGwgd2hlbiBhbGwgdGhlIGNvbnN0aXR1ZW50XG4gICAgICAvLyBwcm9taXNlcyBhcmUgYWN0dWFsbHkgYWRkZWQ/Pz9cbiAgICAgIGF3YWl0IDA7XG4gICAgICBhd2FpdCAwO1xuICAgICAgYXdhaXQgMDtcbiAgICB9XG4gICAgLy90aGlzLndyaXRpbmcgPSBmYWxzZTtcbiAgICAvLyBjb25zb2xlLmxvZyhgRmluaXNoZWQgd3JpdGluZyAkJHt0aGlzLnN0YXJ0LnRvU3RyaW5nKDE2KX0uLiQke3RoaXMucG9zLnRvU3RyaW5nKDE2KVxuICAgIC8vICAgICAgICAgICAgICB9LiAgJHt0aGlzLmVuZCAtIHRoaXMucG9zfSBieXRlcyBmcmVlYCk7XG4gICAgLy8gVE9ETyAtIHN1bW1hcml6ZSBhbGwgZnJlZSBjaHVua3M/Pz9cbiAgICAvLyAgIC0tIGZlZWQgZnJlZSBjaHVuayBnaXZlbiBwYWdlIGludG8gZGVmaW5lIGZvciBhc3NlbWJsZXI/XG4gIH1cblxuICBwcml2YXRlIGZpbmQoe2RhdGEsIHN0YXJ0UGFnZSwgZW5kUGFnZX06IFdyaXRlKTogbnVtYmVyIHtcbiAgICBmb3IgKGNvbnN0IGNodW5rIG9mIHRoaXMuY2h1bmtzKSB7XG4gICAgICBpZiAoY2h1bmsucGFnZSA8IHN0YXJ0UGFnZSB8fCBjaHVuay5wYWdlID4gZW5kUGFnZSkgY29udGludWU7XG4gICAgICBjb25zdCBmb3VuZCA9IGNodW5rLmZpbmQoZGF0YSwgdGhpcy5yb20pO1xuICAgICAgaWYgKGZvdW5kID49IDApIHJldHVybiBmb3VuZDtcbiAgICB9XG4gICAgcmV0dXJuIC0xO1xuICB9XG5cbiAgcHJpdmF0ZSB3cml0ZU9uZSh3cml0ZTogV3JpdGUpIHtcbiAgICAvLyBmaW5kIGEgY2h1bmsgd2l0aCBlbm91Z2ggc3BhY2UgdG8gZml0IHRoZSBkYXRhLlxuICAgIGZvciAoY29uc3QgY2h1bmsgb2YgdGhpcy5jaHVua3MpIHtcbiAgICAgIGlmIChjaHVuay5wYWdlIDwgd3JpdGUuc3RhcnRQYWdlIHx8IGNodW5rLnBhZ2UgPiB3cml0ZS5lbmRQYWdlKSBjb250aW51ZTtcbiAgICAgIGlmIChjaHVuay5mcmVlKCkgPCB3cml0ZS5kYXRhLmxlbmd0aCkgY29udGludWU7XG4gICAgICAvLyBsb29rcyBsaWtlIGl0IGZpdHMhXG4gICAgICB0aGlzLnJvbS5zdWJhcnJheShjaHVuay5wb3MsIGNodW5rLnBvcyArIHdyaXRlLmRhdGEubGVuZ3RoKS5zZXQod3JpdGUuZGF0YSk7XG4gICAgICB3cml0ZS5yZXNvbHZlKGNodW5rLnBvcyk7XG4gICAgICB0aGlzLmZyZWVbY2h1bmsucGFnZV0gLT0gd3JpdGUuZGF0YS5sZW5ndGg7XG4gICAgICAvLyBjb25zb2xlLmxvZyhgJHt3cml0ZS5uYW1lfTogd3JpdGluZyAke3dyaXRlLmRhdGEubGVuZ3RofSBieXRlcyBhdCAke1xuICAgICAgLy8gICAgICAgICAgICAgIGhleChjaHVuay5wb3MpfTogJHtBcnJheS5mcm9tKHdyaXRlLmRhdGEsIGhleCkuam9pbignICcpfSB8IEZSRUUgJHtcbiAgICAgIC8vICAgICAgICAgICAgICB0aGlzLmZyZWUubWFwKCh2Om51bWJlcixrOm51bWJlcik9PmAke2hleCgyKmspfToke3Z9YCkuam9pbignLycpfWApO1xuICAgICAgY2h1bmsucG9zICs9IHdyaXRlLmRhdGEubGVuZ3RoO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGNvbnNvbGUubG9nKGBMT09LSU5HIEZPUiBDSFVOSzogJHt3cml0ZS5kYXRhLmxlbmd0aH0gYnl0ZXMgaW4gJHtoZXgod3JpdGUuc3RhcnRQYWdlKVxuICAgIC8vICAgICAgICAgICAgICAgICAgfS4uJHtoZXgod3JpdGUuZW5kUGFnZSl9YCk7XG4gICAgLy8gZm9yIChjb25zdCBjaHVuayBvZiB0aGlzLmNodW5rcykge1xuICAgIC8vICAgaWYgKGNodW5rLnBhZ2UgPCB3cml0ZS5zdGFydFBhZ2UgfHwgY2h1bmsucGFnZSA+IHdyaXRlLmVuZFBhZ2UpIHtcbiAgICAvLyAgICAgY29uc29sZS5sb2coYHdyb25nIHBhZ2U6ICR7aGV4KGNodW5rLnBvcyl9Li4ke2hleChjaHVuay5lbmQpfSAtPiAke2hleChjaHVuay5wYWdlKX1gKTsgY29udGludWU7XG4gICAgLy8gICB9XG4gICAgLy8gICBpZiAoY2h1bmsuZnJlZSgpIDwgd3JpdGUuZGF0YS5sZW5ndGgpIHtcbiAgICAvLyAgICAgY29uc29sZS5sb2coYG5vdCBlbm91Z2ggZnJlZTogJHtoZXgoY2h1bmsucG9zKX0uLiR7aGV4KGNodW5rLmVuZCl9IC0+ICR7Y2h1bmsuZnJlZSgpfWApOyBjb250aW51ZTtcbiAgICAvLyAgIH1cbiAgICAvLyB9XG4gICAgLy9jb25zb2xlLmxvZyh0aGlzLmNodW5rcyk7XG4gICAgY29uc29sZS5sb2coYCR7d3JpdGUubmFtZX06IFdSSVRFIEZBSUxFRCAke3dyaXRlLmRhdGEubGVuZ3RofSBieXRlczogJHtcbiAgICAgICAgICAgICAgICAgQXJyYXkuZnJvbSh3cml0ZS5kYXRhLCBoZXgpLmpvaW4oJyAnKX1gKTtcbiAgICB3cml0ZS5yZWplY3QoXG4gICAgICAgIG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgc3VmZmljaWVudCBjaHVuayBpbiAke2hleCh3cml0ZS5zdGFydFBhZ2UpXG4gICAgICAgICAgICAgICAgICAgICAgIH0uLiR7aGV4KHdyaXRlLmVuZFBhZ2UpfSB0byB3cml0ZSAke3dyaXRlLm5hbWV9OiAke3dyaXRlLmRhdGF9YCkpO1xuICB9XG59XG4iXX0=