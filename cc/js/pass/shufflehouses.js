import { Metalocation } from '../rom/metalocation.js';
import { DefaultMap } from '../util.js';
const HOUSE_ICON = 0x06;
const TALL_HOUSE_ICON = 0x21;
const icons = new Map([
    ['pawn', 0x36],
    ['inn', 0x37],
    ['armor', 0x38],
    ['tool', 0x39],
    ['tavern', 0x3b],
]);
const shops = new Set(['inn', 'armor', 'tool', 'pawn']);
const compat = new Set([...shops, 'house', 'tavern']);
export function shuffleHouses(rom, flags, random) {
    var _a, _b, _c;
    const { locations: { Nadare, Portoa_PalaceEntrance, } } = rom;
    const byType = new DefaultMap(() => []);
    const byLocPos = new DefaultMap(() => []);
    const screens = new DefaultMap(() => new Set());
    for (const location of rom.locations) {
        if (!location.used)
            continue;
        if (location.data.houseType == null)
            continue;
        for (const [pos, type, spec] of location.meta.exits()) {
            if (type === 'edge:bottom' || shops.has(location.data.houseType) ||
                (location.meta.tileset === rom.metatilesets.fortress &&
                    type === 'stair:down')) {
                const house = {
                    type: location.data.houseType,
                    inside: [location.id << 8 | pos, type],
                    outside: spec,
                };
                let locpos = spec[0];
                byLocPos.get(locpos).push(house);
                byType.get(location.data.houseType).push(house);
                const screen = rom.locations[locpos >>> 8].screens[(locpos >>> 4) & 0xf][locpos & 0xf];
                screens.get(screen).add(locpos);
            }
        }
    }
    const secondPass = new Map();
    const firstPass = new Map();
    for (const [scr, locposs] of random.ishuffle(screens)) {
        if (locposs.size >= 2 || scr === 0x64) {
            firstPass.set(scr, locposs);
        }
        else {
            secondPass.set(scr, locposs);
        }
    }
    const hasInn = new Set();
    const inns = byType.get('inn');
    for (const [, locposs] of [...firstPass, ...secondPass]) {
        const map = new Map();
        let first = true;
        for (const locpos of locposs) {
            for (const house of byLocPos.get(locpos)) {
                let eligible = first && compat.has(house.type) ?
                    [...compat].map(t => byType.get(t)) :
                    [byType.get((_a = map.get(house.outside[1])) !== null && _a !== void 0 ? _a : house.type)];
                eligible = eligible.filter(x => x.length);
                const allowInn = [...locposs].every(lp => !hasInn.has(lp >>> 8));
                if (!allowInn && eligible.length > 1) {
                    eligible = eligible.filter(x => x !== inns);
                }
                else if (allowInn && eligible.some(x => x === inns)) {
                    eligible = [inns];
                }
                const replacement = random.pickAndRemove(...eligible);
                if (replacement.type === 'inn') {
                    for (const lp of locposs) {
                        hasInn.add(lp >>> 8);
                    }
                }
                map.set(house.outside[1], replacement.type);
                if (rom.spoiler) {
                    rom.spoiler.addHouse(replacement.inside[0] >>> 8, house.outside[0] >>> 8);
                }
                Metalocation.connect(rom, house.outside, replacement.inside);
                if (!first)
                    continue;
                if (icons.get(house.type) === icons.get(replacement.type))
                    continue;
                const outside = rom.locations[house.outside[0] >>> 8];
                if (outside === Nadare || outside === Portoa_PalaceEntrance)
                    continue;
                const exits = Metalocation.findExitTiles(rom, house.outside);
                if (exits.length > 1)
                    continue;
                let coord = exits[0] - 0x20;
                if ((exits[0] & 0xf0) < 0x20)
                    coord -= 0x0f10;
                const pos = coord >> 8;
                const tile = coord & 0xff;
                const icon = (_b = icons.get(replacement.type)) !== null && _b !== void 0 ? _b : (((_c = outside.meta.get(pos).data.tallHouses) === null || _c === void 0 ? void 0 : _c.includes(tile)) ?
                    TALL_HOUSE_ICON : HOUSE_ICON);
                rom.screens[outside.screens[pos >> 4][pos & 0xf]].tiles[tile] = icon;
            }
            first = false;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZWhvdXNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9wYXNzL3NodWZmbGVob3VzZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBOEJBLE9BQU8sRUFBVyxZQUFZLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUk5RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBUXhDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQztBQUN4QixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUM7QUFDN0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQW9CO0lBQ3ZDLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztJQUNkLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQztJQUNiLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQztJQUNmLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztJQUNkLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQztDQUNqQixDQUFDLENBQUM7QUFFSCxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBWSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDbkUsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQVksQ0FBQyxHQUFHLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUVqRSxNQUFNLFVBQVUsYUFBYSxDQUFDLEdBQVEsRUFBRSxLQUFjLEVBQUUsTUFBYzs7SUFDcEUsTUFBTSxFQUFDLFNBQVMsRUFBRSxFQUNoQixNQUFNLEVBQUUscUJBQXFCLEdBQzlCLEVBQUMsR0FBRyxHQUFHLENBQUM7SUFFVCxNQUFNLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBcUIsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDNUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxVQUFVLENBQWtCLEdBQUcsRUFBRSxDQUFD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Q0FBQyxHQUFHLElBQUksQ0FBQztnQkFDNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxJQUFJO29CQUFFLEtBQUssSUFBSSxNQUFNLENBQUM7Z0JBQzlDLE1BQU0sR0FBRyxHQUFHLEtBQUssSUFBSSxDQUFDLENBQUM7Z0JBQ3ZCLE1BQU0sSUFBSSxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUM7Z0JBQzFCLE1BQU0sSUFBSSxTQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxtQ0FDdEMsQ0FBQyxPQUFBLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLDBDQUFFLFFBQVEsQ0FBQyxJQUFJLEdBQUUsQ0FBQztvQkFDdkQsZUFBZSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDakMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQ3RFO1lBQ0QsS0FBSyxHQUFHLEtBQUssQ0FBQztTQUNmO0tBQ0Y7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU2h1ZmZsZSBob3VzZS9zaG9wL3NoZWQvcGFsYWNlIGVudHJhbmNlcy5cbi8vIFRoaXMgaXMgdHJpY2t5IGZvciBhIG51bWJlciBvZiByZWFzb25zLiAgV2UgbmVlZCB0byBwYXkgYXR0ZW50aW9uIHRvXG4vLyBrZWVwIHRoZSByaWdodCBpY29uIGFib3ZlIGVhY2ggZG9vciwgd2hpY2ggaXMgZXh0cmEgdHJpY2t5IGZvciB0aGVcbi8vICh2YW5pbGxhKSA1IHNjcmVlbnMgdGhhdCBzaGFyZSB0d28gdG93bnMuICBUaGlzIGNhbiBiZSBtaXRpZ2F0ZWQgYnlcbi8vIGV4cGFuZGluZyB0aGUgc2NyZWVuIHNwYWNlIGludG8gdGhlIGV4dHJhIFJPTSBhcmVhLCBidXQgaXQncyBuaWNlIHRvXG4vLyBzdGlsbCB3b3JrIHdpdGhvdXQgdGhhdC5cblxuLy8gTk9URTogSXQncyBwb3NzaWJsZSB0aGF0IHdlIHNodWZmbGUgYWxsIHRoZSBzcGhlcmUtMCBjaGVja3MgYXdheSBmcm9tXG4vLyBMZWFmLiAgSWYgdGhlcmUncyBubyBleHRyYSBwYXNzYWdlIHRoZW4gd2UgbWF5IGVuZCB1cCB3aXRoIGFuIGltcG9zc2libGVcbi8vIHNodWZmbGUuICBJbiB0aGF0IGNhc2UsIHdlIG5lZWQgdG8gZmluZCBhIHdheSB0byByZWdyb3VwLiAgRm9yIG5vdywgdGhlXG4vLyBlYXNpZXN0IG9wdGlvbiBtYXkgYmUgdG8gbGVhdmUgdGhvc2UgdHdvIGhvdXNlcyBvdXQgb2YgdGhlIHNodWZmbGUuLi5cblxuXG4vLyBOT1RFOiB0aGVyZSdzIGEgYnVnIHdoZW4gZW50cmFuY2VzIGFyZSBvdXQgb2Ygb3JkZXJcbi8vICAgLSB3YXJwIHRvIHRvd25zIGNvbWVzIG91dCBvZiBkb29yXG4vLyAgIC0gYm9hdCBicm9rZW4gaWYgbm90IGVudHJhbmNlIDAgKGUuZy4gbGlnaHRob3VzZSBvciBib2F0IGhvdXNlKVxuLy8gLT4gbWlnaHQgYmUgbmljZSB0byBmaXggYm9hdCwgYnV0IGdlbmVyYWxseSB3ZSd2ZSBoYWQgYWxsIHNvcnRzIG9mXG4vLyAgICBpc3N1ZXMgZnJvbSBlbnRyYW5jZSByZW9yZGVyaW5nIC0gd2Ugc2hvdWxkIHRyeSB0byBmaXggaXQgc29cbi8vICAgIHRoYXQgdGhlIGVudHJhbmNlIHR5cGVzIGFyZSBwcmVzZXJ2ZWQgYXMgbXVjaCBhcyBwb3NzaWJsZVxuLy8gICAgKGkuZS4gZWRnZS9kaXJlY3Rpb24gdnMgZG9vciwgZXRjKVxuLy8gICAtIGNhbiB3ZSBkZWZlciB0aGUgZGVjaXNpb24gb2Ygd2hpY2ggZW50cmFuY2UgbnVtYmVyIHRvIHVzZVxuLy8gICAgIHVudGlsIGEgbGl0dGxlIGxhdGVyLCBhbmQganVzdCBpbmRpcmVjdCBpdCBmb3IgYSB3aGlsZT9cbi8vICAgLSBpZiBtYXplIHNodWZmbGUgaXMgb24sIGl0IGNvdWxkIGJlIGhhcmQgdG8gZmlndXJlIG91dCB3aGljaFxuLy8gICAgIGlzIHdoaWNoPyBleGNlcHQgd2UgZG8ga25vdyB0aGUgZXhpdCB0eXBlcyBhbmQgdGhlIG51bWJlclxuLy8gICAgIGJlZm9yZSB3ZSBhc3NpZ24gYW55dGhpbmcuLi4gc28gbWFrZSBhIG1hcHBpbmcgYW5kIHRoZW4gZmlsbFxuLy8gICAgIGluIGFueSBnYXBzLlxuXG5cbmltcG9ydCB7UmFuZG9tfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0V4aXRTcGVjLCBNZXRhbG9jYXRpb259IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHtIb3VzZVR5cGV9IGZyb20gJy4uL3JvbS9sb2NhdGlvbi5qcyc7XG5pbXBvcnQge0Nvbm5lY3Rpb25UeXBlfSBmcm9tICcuLi9yb20vbWV0YXNjcmVlbmRhdGEuanMnO1xuaW1wb3J0IHtGbGFnU2V0fSBmcm9tICcuLi9mbGFnc2V0LmpzJztcbmltcG9ydCB7IERlZmF1bHRNYXAgfSBmcm9tICcuLi91dGlsLmpzJztcblxuaW50ZXJmYWNlIEhvdXNlIHtcbiAgdHlwZTogSG91c2VUeXBlO1xuICBpbnNpZGU6IEV4aXRTcGVjO1xuICBvdXRzaWRlOiBFeGl0U3BlYztcbn1cblxuY29uc3QgSE9VU0VfSUNPTiA9IDB4MDY7XG5jb25zdCBUQUxMX0hPVVNFX0lDT04gPSAweDIxO1xuY29uc3QgaWNvbnMgPSBuZXcgTWFwPEhvdXNlVHlwZSwgbnVtYmVyPihbXG4gIFsncGF3bicsIDB4MzZdLFxuICBbJ2lubicsIDB4MzddLFxuICBbJ2FybW9yJywgMHgzOF0sXG4gIFsndG9vbCcsIDB4MzldLFxuICBbJ3RhdmVybicsIDB4M2JdLFxuXSk7XG5cbmNvbnN0IHNob3BzID0gbmV3IFNldDxIb3VzZVR5cGU+KFsnaW5uJywgJ2FybW9yJywgJ3Rvb2wnLCAncGF3biddKTtcbmNvbnN0IGNvbXBhdCA9IG5ldyBTZXQ8SG91c2VUeXBlPihbLi4uc2hvcHMsICdob3VzZScsICd0YXZlcm4nXSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBzaHVmZmxlSG91c2VzKHJvbTogUm9tLCBmbGFnczogRmxhZ1NldCwgcmFuZG9tOiBSYW5kb20pIHtcbiAgY29uc3Qge2xvY2F0aW9uczoge1xuICAgIE5hZGFyZSwgUG9ydG9hX1BhbGFjZUVudHJhbmNlLFxuICB9fSA9IHJvbTtcbiAgLy8gRmlyc3Qgb3JkZXIgb2YgYnVzaW5lc3M6IGNvbGxlY3QgYWxsIHRoZSBjb25uZWN0aW9ucy5cbiAgY29uc3QgYnlUeXBlID0gbmV3IERlZmF1bHRNYXA8SG91c2VUeXBlLCBIb3VzZVtdPigoKSA9PiBbXSk7XG4gIGNvbnN0IGJ5TG9jUG9zID0gbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBIb3VzZVtdPigoKSA9PiBbXSk7IC8vIGtleTogTG9jUG9zXG4gIGNvbnN0IHNjcmVlbnMgPSBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigoKSA9PiBuZXcgU2V0KCkpOyAvLyBTY3JJZCAtPiBMb2NQb3NcbiAgZm9yIChjb25zdCBsb2NhdGlvbiBvZiByb20ubG9jYXRpb25zKSB7XG4gICAgaWYgKCFsb2NhdGlvbi51c2VkKSBjb250aW51ZTtcbiAgICBpZiAobG9jYXRpb24uZGF0YS5ob3VzZVR5cGUgPT0gbnVsbCkgY29udGludWU7XG4gICAgLy8gUHJldmVudCBpbXBvc3NpYmxlIHNodWZmbGVzIGJ5IGVuc3VyaW5nIGl0ZW1zIGluIHNwaGVyZS0wXG4gICAgLy8gTm90ZTogaWYgd2UgaGF2ZSB0aGUgR0JDIGNhdmUsIHdlIGNvdWxkIHBvdGVudGlhbGx5IGxldCB0aGVzZVxuICAgIC8vIGhvdXNlcyBmbG9hdCwgc2luY2Ugd2UncmUgZ3VhcmFudGVlZCB0d28gZXh0cmEgY2hlY2tzICh0aG91Z2hcbiAgICAvLyBtaW1pY3MgYXJlIHNodWZmbGVkIGVhcmx5IG5vdywgc28gdGhhdCBjb3VsZCBzdGlsbCBjYXVzZSBhIHByb2JsZW0pLlxuICAgIC8vaWYgKGxvY2F0aW9uID09PSBMZWFmX0VsZGVySG91c2UgfHwgbG9jYXRpb24gPT09IExlYWZfU3R1ZGVudEhvdXNlKSBjb250aW51ZTtcbiAgICAvLyBUaGVyZSdzIHNvbWV0aGluZyBnbGl0Y2h5IGFib3V0IHRoaXMgb25lIC0gd2hlbiB3ZSBlbWVyZ2UsXG4gICAgLy8gdGhlIHNjcmVlbiBzY3JvbGxzIGFuZCBsb2Nrcy5cbiAgICAvL2lmIChsb2NhdGlvbiA9PT0gQm9hdEhvdXNlKSBjb250aW51ZTtcblxuICAgIC8vIEZvciBub24tc2hvcHMsIGZpbmQgdGhlIGJvdHRvbSBlZGdlXG4gICAgZm9yIChjb25zdCBbcG9zLCB0eXBlLCBzcGVjXSBvZiBsb2NhdGlvbi5tZXRhLmV4aXRzKCkpIHtcbiAgICAgIGlmICh0eXBlID09PSAnZWRnZTpib3R0b20nIHx8IHNob3BzLmhhcyhsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSkgfHxcbiAgICAgICAgIChsb2NhdGlvbi5tZXRhLnRpbGVzZXQgPT09IHJvbS5tZXRhdGlsZXNldHMuZm9ydHJlc3MgJiZcbiAgICAgICAgICB0eXBlID09PSAnc3RhaXI6ZG93bicpKSB7XG4gICAgICAgIGNvbnN0IGhvdXNlOiBIb3VzZSA9IHtcbiAgICAgICAgICB0eXBlOiBsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSxcbiAgICAgICAgICBpbnNpZGU6IFtsb2NhdGlvbi5pZCA8PCA4IHwgcG9zLCB0eXBlXSxcbiAgICAgICAgICBvdXRzaWRlOiBzcGVjLFxuICAgICAgICB9O1xuICAgICAgICBsZXQgbG9jcG9zID0gc3BlY1swXTtcbiAgICAgICAgLy8gQ2hlY2sgb3V0c2lkZSBzcGVjIGZvciBzaHlyb24uLi5cbiAgICAgICAgLy8gaWYgKGxvY2F0aW9uID09PSBTaHlyb24gJiZcbiAgICAgICAgLy8gICAgIChsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSA9PT0gJ2FybW9yJyB8fFxuICAgICAgICAvLyAgICAgIGxvY2F0aW9uLmRhdGEuaG91c2VUeXBlID09PSAndG9vbCcpKSB7XG4gICAgICAgIC8vICAgbG9jcG9zIC09IDB4MTA7IC8vIGljb24gaXMgYWN0dWFsbHkgb24gcHJldmlvdXMgc2NyZWVuXG4gICAgICAgIC8vIH1cbiAgICAgICAgYnlMb2NQb3MuZ2V0KGxvY3BvcykucHVzaChob3VzZSk7XG4gICAgICAgIGJ5VHlwZS5nZXQobG9jYXRpb24uZGF0YS5ob3VzZVR5cGUpLnB1c2goaG91c2UpO1xuICAgICAgICBjb25zdCBzY3JlZW4gPSByb20ubG9jYXRpb25zW2xvY3BvcyA+Pj4gOF0uc2NyZWVuc1sobG9jcG9zID4+PiA0KSAmIDB4Zl1bbG9jcG9zICYgMHhmXTtcbiAgICAgICAgc2NyZWVucy5nZXQoc2NyZWVuKS5hZGQobG9jcG9zKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBUd28gcGFzc2VzOiAxLiBvbmx5IGhhbmRsZSBvdmVybG9hZGVkIHNjcmVlbnM7IDIuIGFsbCB0aGUgcmVzdC5cbiAgY29uc3Qgc2Vjb25kUGFzcyA9IG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKTtcbiAgY29uc3QgZmlyc3RQYXNzID0gbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpO1xuICBmb3IgKGNvbnN0IFtzY3IsIGxvY3Bvc3NdIG9mIHJhbmRvbS5pc2h1ZmZsZShzY3JlZW5zKSkge1xuICAgIC8vIE5PVEU6IHN0dWRlbnQvYnJva2FoYW5hIHNob3VsZCBiZSBpbiBmaXJzdCBwYXNzLlxuICAgIGlmIChsb2Nwb3NzLnNpemUgPj0gMiB8fCBzY3IgPT09IDB4NjQpIHtcbiAgICAgIGZpcnN0UGFzcy5zZXQoc2NyLCBsb2Nwb3NzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2Vjb25kUGFzcy5zZXQoc2NyLCBsb2Nwb3NzKTtcbiAgICB9XG4gIH1cbiAgY29uc3QgaGFzSW5uID0gbmV3IFNldDxudW1iZXI+KCk7XG4gIGNvbnN0IGlubnMgPSBieVR5cGUuZ2V0KCdpbm4nKTtcbiAgZm9yIChjb25zdCBbLCBsb2Nwb3NzXSBvZiBbLi4uZmlyc3RQYXNzLCAuLi5zZWNvbmRQYXNzXSkge1xuICAgIC8vY29uc29sZS5sb2coYHNodWZmbGluZyBzY3JlZW4gJHtzY3IudG9TdHJpbmcoMTYpfTogJHtbLi4ubG9jcG9zc10ubWFwKGw9PmwudG9TdHJpbmcoMTYpKS5qb2luKCcsJyl9YCk7XG4gICAgY29uc3QgbWFwID0gbmV3IE1hcDxDb25uZWN0aW9uVHlwZSwgSG91c2VUeXBlPigpO1xuICAgIGxldCBmaXJzdCA9IHRydWU7XG4gICAgZm9yIChjb25zdCBsb2Nwb3Mgb2YgbG9jcG9zcykge1xuICAgICAgZm9yIChjb25zdCBob3VzZSBvZiBieUxvY1Bvcy5nZXQobG9jcG9zKSkge1xuICAgICAgICBsZXQgZWxpZ2libGUgPSBmaXJzdCAmJiBjb21wYXQuaGFzKGhvdXNlLnR5cGUpID9cbiAgICAgICAgICBbLi4uY29tcGF0XS5tYXAodCA9PiBieVR5cGUuZ2V0KHQpKSA6XG4gICAgICAgICAgW2J5VHlwZS5nZXQobWFwLmdldChob3VzZS5vdXRzaWRlWzFdKSA/PyBob3VzZS50eXBlKV07XG4gICAgICAgIGVsaWdpYmxlID0gZWxpZ2libGUuZmlsdGVyKHggPT4geC5sZW5ndGgpO1xuICAgICAgICAvLyBBdm9pZCBtb3JlIHRoYW4gb25lIGlubiBwZXIgdG93biwgc2luY2UgdGhhdCdzIGxhbWUuXG4gICAgICAgIC8vIEFsc28sIHBsYWNlIGlubnMgZmlyc3Qgc28gYXMgdG8gbW9zdCBldmVubHkgZGlzdHJpYnV0ZSB0aGVtLlxuICAgICAgICBjb25zdCBhbGxvd0lubiA9IFsuLi5sb2Nwb3NzXS5ldmVyeShscCA9PiAhaGFzSW5uLmhhcyhscCA+Pj4gOCkpO1xuICAgICAgICBpZiAoIWFsbG93SW5uICYmIGVsaWdpYmxlLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICBlbGlnaWJsZSA9IGVsaWdpYmxlLmZpbHRlcih4ID0+IHggIT09IGlubnMpO1xuICAgICAgICB9IGVsc2UgaWYgKGFsbG93SW5uICYmIGVsaWdpYmxlLnNvbWUoeCA9PiB4ID09PSBpbm5zKSkge1xuICAgICAgICAgIGVsaWdpYmxlID0gW2lubnNdO1xuICAgICAgICB9XG4gICAgICAgIC8vIE5PVEU6IGlmIHN0dWRlbnQgaXMgc3RheWluZyBwdXQgdGhlbiBkb24ndCBzaHVmZmxlIGJyb2thaGFuYSB0byBhIG5vbi1ob3VzZVxuICAgICAgICAvLyBUT0RPIC0gYmV0dGVyIGNvbmRpdGlvbiwgcGFydGljdWxhcmx5IGlmIHdlIF9kb18gc2h1ZmZsZSBzdHVkZW50IG9yIGlmIHdlIHNwbGl0IHNjcmVlbnNcbiAgICAgICAgLy8gaWYgKChob3VzZS5vdXRzaWRlWzBdID4+PiA4KSA9PT0gR29hX0hvdXNlLmlkICYmIGJ5VHlwZS5nZXQoJ2hvdXNlJykubGVuZ3RoKSB7XG4gICAgICAgIC8vICAgZWxpZ2libGUgPSBbYnlUeXBlLmdldCgnaG91c2UnKV07XG4gICAgICAgIC8vIH1cbiAgICAgICAgLy8gVE9ETyAtIGFsc28gY29uc2lkZXIgcHJldmVudGluZyBtdWx0aXBsZSBpbm5zIGluIHRoZSBzYW1lIHRvd24/XG4gICAgICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gcmFuZG9tLnBpY2tBbmRSZW1vdmUoLi4uZWxpZ2libGUpO1xuICAgICAgICBpZiAocmVwbGFjZW1lbnQudHlwZSA9PT0gJ2lubicpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGxwIG9mIGxvY3Bvc3MpIHtcbiAgICAgICAgICAgIGhhc0lubi5hZGQobHAgPj4+IDgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBtYXAuc2V0KGhvdXNlLm91dHNpZGVbMV0sIHJlcGxhY2VtZW50LnR5cGUpO1xuICAgICAgICBpZiAocm9tLnNwb2lsZXIpIHtcbiAgICAgICAgICByb20uc3BvaWxlci5hZGRIb3VzZShyZXBsYWNlbWVudC5pbnNpZGVbMF0gPj4+IDgsIGhvdXNlLm91dHNpZGVbMF0gPj4+IDgpO1xuICAgICAgICB9XG4gICAgICAgIC8vIE1ha2UgdGhlIGNvbm5lY3Rpb25cbiAgICAgICAgLy9jb25zb2xlLmxvZyhgY29ubmVjdCAke3JvbS5sb2NhdGlvbnNbaG91c2Uub3V0c2lkZVswXT4+PjhdLm5hbWV9ICR7aG91c2Uub3V0c2lkZVswXS50b1N0cmluZygxNil9ICR7aG91c2Uub3V0c2lkZVsxXX0gLS0gJHtyb20ubG9jYXRpb25zW3JlcGxhY2VtZW50Lmluc2lkZVswXT4+PjhdLm5hbWV9ICR7cmVwbGFjZW1lbnQuaW5zaWRlWzBdLnRvU3RyaW5nKDE2KX0gJHtyZXBsYWNlbWVudC5pbnNpZGVbMV19YCk7XG4gICAgICAgIE1ldGFsb2NhdGlvbi5jb25uZWN0KHJvbSwgaG91c2Uub3V0c2lkZSwgcmVwbGFjZW1lbnQuaW5zaWRlKTtcbiAgICAgICAgLy8gUmVwbGFjZSB0aGUgaWNvblxuICAgICAgICBpZiAoIWZpcnN0KSBjb250aW51ZTtcbiAgICAgICAgaWYgKGljb25zLmdldChob3VzZS50eXBlKSA9PT0gaWNvbnMuZ2V0KHJlcGxhY2VtZW50LnR5cGUpKSBjb250aW51ZTtcbiAgICAgICAgY29uc3Qgb3V0c2lkZSA9IHJvbS5sb2NhdGlvbnNbaG91c2Uub3V0c2lkZVswXSA+Pj4gOF07XG4gICAgICAgIGlmIChvdXRzaWRlID09PSBOYWRhcmUgfHwgb3V0c2lkZSA9PT0gUG9ydG9hX1BhbGFjZUVudHJhbmNlKSBjb250aW51ZTtcbiAgICAgICAgY29uc3QgZXhpdHMgPSBNZXRhbG9jYXRpb24uZmluZEV4aXRUaWxlcyhyb20sIGhvdXNlLm91dHNpZGUpO1xuICAgICAgICBpZiAoZXhpdHMubGVuZ3RoID4gMSkgY29udGludWU7XG4gICAgICAgIGxldCBjb29yZCA9IGV4aXRzWzBdIC0gMHgyMDtcbiAgICAgICAgaWYgKChleGl0c1swXSAmIDB4ZjApIDwgMHgyMCkgY29vcmQgLT0gMHgwZjEwOyAvLyBmdW5ueSB2ZXJ0aWNhbCBtYXRoXG4gICAgICAgIGNvbnN0IHBvcyA9IGNvb3JkID4+IDg7XG4gICAgICAgIGNvbnN0IHRpbGUgPSBjb29yZCAmIDB4ZmY7XG4gICAgICAgIGNvbnN0IGljb24gPSBpY29ucy5nZXQocmVwbGFjZW1lbnQudHlwZSkgPz9cbiAgICAgICAgICAob3V0c2lkZS5tZXRhLmdldChwb3MpLmRhdGEudGFsbEhvdXNlcz8uaW5jbHVkZXModGlsZSkgP1xuICAgICAgICAgICBUQUxMX0hPVVNFX0lDT04gOiBIT1VTRV9JQ09OKTtcbiAgICAgICAgcm9tLnNjcmVlbnNbb3V0c2lkZS5zY3JlZW5zW3BvcyA+PiA0XVtwb3MgJiAweGZdXS50aWxlc1t0aWxlXSA9IGljb247XG4gICAgICB9XG4gICAgICBmaXJzdCA9IGZhbHNlO1xuICAgIH1cbiAgfVxufVxuIl19