import { Bits } from '../bits.js';
import { hex } from '../rom/util.js';
import { Keyed, ArrayMap, MutableArrayBiMap, iters, spread } from '../util.js';
import { die } from '../assert.js';
export class Graph {
    constructor(worlds) {
        var _a;
        this.worlds = worlds;
        const provided = new Set();
        const required = new Set();
        const slots = new Map();
        const items = new Map();
        for (let i = 0; i < worlds.length; i++) {
            const world = worlds[i];
            const worldId = i << 24;
            for (const [providedId, requirement] of world.requirements) {
                provided.add(worldId | providedId);
                for (const route of requirement) {
                    for (const cond of route) {
                        required.add(worldId | cond);
                    }
                }
            }
            for (const [itemId, info] of world.items) {
                items.set((worldId | itemId), info);
            }
            for (const [slotId, info] of world.slots) {
                slots.set((worldId | slotId), info);
            }
        }
        this.itemInfos = new Map(items);
        this.slotInfos = new Map(slots);
        this.progression = new Set(required);
        for (const item of items.keys())
            required.add(item);
        const common = new Set();
        const extraProvides = new Set();
        const extraRequires = new Set();
        for (const check of required) {
            (provided.has(check) ? common : extraRequires).add(check);
        }
        for (const check of provided) {
            if (!required.has(check))
                extraProvides.add(check);
        }
        this.common = common.size;
        this.slots = new ArrayMap([...common, ...extraProvides]);
        this.items = new ArrayMap([...common, ...extraRequires]);
        const graph = [];
        const unlocks = [];
        for (let i = 0; i < worlds.length; i++) {
            const worldId = i << 24;
            for (const [slot, req] of worlds[i].requirements) {
                const slotIndex = this.slots.index((worldId | slot));
                if (slotIndex == null) {
                    throw new Error(`Provided a non-slot? ${hex(slot)}`);
                }
                for (const cs of req) {
                    const is = [...cs].map(c => { var _a; return _a = this.items.index((worldId | c)), (_a !== null && _a !== void 0 ? _a : die()); });
                    (graph[slotIndex] || (graph[slotIndex] = [])).push(Bits.from(is));
                    for (const i of is) {
                        (unlocks[i] || (unlocks[i] = new Set())).add(slotIndex);
                    }
                }
            }
        }
        for (let i = 0; i < this.slots.length; i++) {
            if (!graph[i] || !graph[i].length) {
                const id = (_a = this.slots.get(i), (_a !== null && _a !== void 0 ? _a : NaN));
                const name = this.checkName(id);
                console.error(`Nothing provided $${hex(id)}: ${name} (index ${i})`);
            }
        }
        this.graph = new Keyed(graph);
        this.unlocks = new Keyed(unlocks.map(spread));
    }
    async shuffle(flagset, random, attempts = 20, progress, spoiler) {
        if (progress)
            progress.addTasks(Math.floor(attempts / 100));
        for (let attempt = 0; attempt < attempts; attempt++) {
            if (progress && (attempt % 100 === 99)) {
                progress.addCompleted(1);
                await new Promise(requestAnimationFrame);
            }
            const fill = new MutableArrayBiMap();
            this.prefill(fill, random);
            const indexFill = this.compressFill(fill);
            const items = this.itemPool(indexFill.values(), random);
            let has = Bits.from(new Set(items));
            const backtracks = Math.floor(attempt / 5);
            if (!this.fillInternal(indexFill, items, has, random, flagset, backtracks)) {
                continue;
            }
            const path = spoiler ? [] : undefined;
            const final = this.traverse(i => indexFill.get(i), Bits.of(), path);
            if (spoiler && path) {
                for (const [target, ...deps] of path) {
                    if (target < this.common || indexFill.has(target)) {
                        spoiler.addCheck(this.slots.get(target), deps.map(d => this.items.get(d)));
                    }
                }
            }
            if (final.size !== this.slots.length) {
                const ns = (si) => this.checkName(this.slots.get(si));
                const missing = new Set([...this.slots].map(x => x[0]));
                for (const s of final)
                    missing.delete(s);
                console.error(`Initial fill never filled slots:
  ${[...missing].map(ns).sort().join('\n  ')}`, final, this);
                continue;
            }
            this.expandFill(indexFill, fill);
            const out = this.fillNonProgression(fill, flagset, random);
            if (out == null)
                continue;
            if (progress) {
                progress.addCompleted(Math.floor((attempts - attempt) / 100));
            }
            if (spoiler) {
                for (const [slot, item] of fill) {
                    const name = this.checkName(slot).replace(/^[0-9a-f]{3} /, '');
                    spoiler.addSlot(slot, name, item);
                }
            }
            return out;
        }
        return null;
    }
    fillInternal(fill, items, has, random, flagset, backsteps) {
        var _a;
        const fixed = new Set(fill.keys());
        for (let bit = items.pop(); bit != null; bit = items.pop()) {
            if (!Bits.has(has, bit))
                continue;
            const itemInfo = this.itemInfoFromIndex(bit);
            has = Bits.without(has, bit);
            const reachable = this.expandReachable(this.traverse(i => fill.get(i), has), flagset);
            random.shuffle(reachable);
            let found = false;
            const checked = new Set(fill.keys());
            for (const slot of reachable) {
                if (checked.has(slot))
                    continue;
                checked.add(slot);
                const slotInfo = this.slotInfoFromIndex(slot);
                if (!slotInfo || !this.fits(slotInfo, itemInfo, flagset))
                    continue;
                fill.set(slot, bit);
                found = true;
                break;
            }
            if (found)
                continue;
            checked.clear();
            if (backsteps-- > 0) {
                for (const slot of reachable) {
                    if (checked.has(slot) || !fill.has(slot) || fixed.has(slot))
                        continue;
                    checked.add(slot);
                    const slotInfo = this.slotInfoFromIndex(slot);
                    if (!slotInfo || !this.fits(slotInfo, itemInfo, flagset))
                        continue;
                    const previousItem = (_a = fill.replace(slot, bit), (_a !== null && _a !== void 0 ? _a : die()));
                    has = Bits.with(has, previousItem);
                    items.push(previousItem);
                    random.shuffle(items);
                    found = true;
                    break;
                }
                if (found)
                    continue;
            }
            return false;
        }
        return true;
    }
    expandReachable(slots, flagset) {
        const out = [];
        for (const slot of slots) {
            const info = this.slotInfoFromIndex(slot);
            if (!info || flagset.preserveUniqueChecks() && !info.unique)
                continue;
            addCopies(out, slot, info.weight || 1);
        }
        return out;
    }
    itemPool(exclude, random) {
        const excludeSet = new Set(exclude);
        const arr = [];
        for (const [id, info] of this.itemInfos) {
            const index = this.items.index(id);
            if (index == null)
                continue;
            if (!this.progression.has(id))
                continue;
            if (excludeSet.has(index))
                continue;
            addCopies(arr, index, info.weight || 1);
        }
        return random.shuffle(arr);
    }
    fits(slot, item, flagset) {
        if (flagset.preserveUniqueChecks() &&
            item.unique && !slot.unique) {
            return false;
        }
        const preventLoss = item.preventLoss || slot.preventLoss;
        if (slot.lossy && item.losable && preventLoss)
            return false;
        return true;
    }
    fillNonProgression(fill, flagset, random) {
        const itemPasses = [[], [], []];
        const slotPasses = [[], []];
        for (const [itemId, info] of this.itemInfos) {
            if (fill.hasValue(itemId))
                continue;
            let index = 2;
            if (info.losable && info.preventLoss)
                index = 1;
            if (flagset.preserveUniqueChecks() && info.unique)
                index = 0;
            itemPasses[index].push(itemId);
        }
        for (const [slotId, info] of this.slotInfos) {
            if (fill.has(slotId))
                continue;
            const index = info.lossy && info.preventLoss ? 0 : 1;
            slotPasses[index].push(slotId);
        }
        for (const pass of [...itemPasses, ...slotPasses]) {
            random.shuffle(pass);
        }
        const n = (si) => this.checkName(si);
        const sc = iters.count(iters.concat(...slotPasses));
        const ic = iters.count(iters.concat(...itemPasses));
        if (ic > sc) {
            console.log(`Slots ${sc}:\n  ${[...iters.concat(...slotPasses)].map(n).join('\n  ')}`);
            console.log(`Items ${ic}:\n  ${[...iters.concat(...itemPasses)].map(n).join('\n  ')}`);
            throw new Error(`Too many items`);
        }
        for (const item of iters.concat(...itemPasses)) {
            let found = false;
            for (const slots of [...slotPasses]) {
                if (found)
                    break;
                for (let i = 0; i < slots.length; i++) {
                    if (this.fits(this.slotInfos.get(slots[i]), this.itemInfos.get(item), flagset)) {
                        fill.set(slots[i], item);
                        found = true;
                        slots.splice(i, 1);
                        break;
                    }
                }
            }
            if (!found) {
                console.log(`Slots:\n  ${[...iters.concat(...slotPasses)].map(n).join('\n  ')}`);
                console.error(`REROLL: Could not place item ${n(item)}`);
                return null;
            }
        }
        return new Map(fill);
    }
    traverse(fill, has, path) {
        has = Bits.clone(has);
        const reachable = new Set();
        const queue = new Set();
        for (let i = 0; i < this.slots.length; i++) {
            if (this.graph.get(i) == null) {
                console.dir(this);
                throw new Error(`Unreachable slot ${i}`);
            }
            queue.add(i);
        }
        for (const n of queue) {
            queue.delete(n);
            if (reachable.has(n))
                continue;
            const needed = this.graph.get(n);
            if (needed == null)
                throw new Error(`Not in graph: ${n}`);
            for (let i = 0, len = needed.length; i < len; i++) {
                if (!Bits.containsAll(has, needed[i]))
                    continue;
                if (path)
                    path.push([n, ...Bits.bits(needed[i])]);
                reachable.add(n);
                const items = [];
                if (n < this.common)
                    items.push(n);
                const filled = fill(n);
                if (filled != null)
                    items.push(filled);
                for (const item of items) {
                    has = Bits.with(has, item);
                    for (const j of this.unlocks.get(item) || []) {
                        if (this.graph.get(j) == null) {
                            console.dir(this);
                            throw new Error(`Adding bad node ${j} from unlock ${item}`);
                        }
                        queue.add(j);
                    }
                }
                break;
            }
        }
        return reachable;
    }
    expandFill(indexFill, fill) {
        for (const [slotIndex, itemIndex] of indexFill) {
            const slotId = this.slots.get(slotIndex);
            const itemId = this.items.get(itemIndex);
            if (slotId == null || itemId == null)
                throw new Error(`missing`);
            fill.replace(slotId, itemId);
        }
    }
    compressFill(fill) {
        const indexFill = new MutableArrayBiMap();
        for (const [slotId, itemId] of fill) {
            const slotIndex = this.slots.index(slotId);
            const itemIndex = this.items.index(itemId);
            if (slotIndex == null || itemIndex == null) {
                throw new Error(`Bad slot/item: ${slotId} ${slotIndex} ${itemId} ${itemIndex}`);
            }
            indexFill.set(slotIndex, itemIndex);
        }
        return indexFill;
    }
    checkName(id) {
        return this.worlds[id >>> 24].checkName(id & 0xffffff);
    }
    prefill(fill, random) {
        for (let i = 0; i < this.worlds.length; i++) {
            const worldId = i << 24;
            const worldFill = this.worlds[i].prefill(random);
            for (const [slot, item] of worldFill) {
                fill.set((worldId | slot), (worldId | item));
            }
        }
    }
    itemInfoFromIndex(item) {
        const id = this.items.get(item);
        if (id == null)
            throw new Error(`Bad item: ${item}`);
        return this.itemInfoFromId(id);
    }
    itemInfoFromId(id) {
        const info = this.itemInfos.get(id);
        if (info == null)
            throw new Error(`Missing info: ${hex(id)}`);
        return info;
    }
    slotInfoFromIndex(slot) {
        const id = this.slots.get(slot);
        if (id == null)
            throw new Error(`Bad slot: ${slot}`);
        return this.slotInfoFromId(id);
    }
    slotInfoFromId(id) {
        const info = this.slotInfos.get(id);
        if (info != null)
            return info;
        return undefined;
    }
}
function addCopies(arr, elem, copies) {
    for (let i = 0; i < copies; i++) {
        arr.push(elem);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvbG9naWMvZ3JhcGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLFlBQVksQ0FBQztBQUloQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxFQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBQyxNQUFNLFlBQVksQ0FBQztBQUM3RSxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBeURqQyxNQUFNLE9BQU8sS0FBSztJQW9CaEIsWUFBNkIsTUFBK0I7O1FBQS9CLFdBQU0sR0FBTixNQUFNLENBQXlCO1FBUTFELE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDbkMsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUNuQyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztRQUMxQyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztRQUMxQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN0QyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN4QixLQUFLLE1BQU0sQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLElBQUksS0FBSyxDQUFDLFlBQVksRUFBRTtnQkFDMUQsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLENBQUM7Z0JBQ25DLEtBQUssTUFBTSxLQUFLLElBQUksV0FBVyxFQUFFO29CQUMvQixLQUFLLE1BQU0sSUFB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LENBQUMsRUFBVTtRQUN2QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNwQyxJQUFJLElBQUksSUFBSSxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5RCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxJQUFlO1FBQy9CLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hDLElBQUksRUFBRSxJQUFJLElBQUk7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNyRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELGNBQWMsQ0FBQyxFQUFVO1FBQ3ZCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BDLElBQUksSUFBSSxJQUFJLElBQUk7WUFBRSxPQUFPLElBQUksQ0FBQztRQUU5QixPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0NBQ0Y7QUFFRCxTQUFTLFNBQVMsQ0FBSSxHQUFRLEVBQUUsSUFBTyxFQUFFLE1BQWM7SUFDckQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMvQixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ2hCO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Qml0c30gZnJvbSAnLi4vYml0cy5qcyc7XG5pbXBvcnQge0ZsYWdTZXR9IGZyb20gJy4uL2ZsYWdzZXQuanMnO1xuaW1wb3J0IHtSYW5kb219IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQge1Nwb2lsZXJ9IGZyb20gJy4uL3JvbS9zcG9pbGVyLmpzJztcbmltcG9ydCB7aGV4fSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQge0tleWVkLCBBcnJheU1hcCwgTXV0YWJsZUFycmF5QmlNYXAsIGl0ZXJzLCBzcHJlYWR9IGZyb20gJy4uL3V0aWwuanMnO1xuaW1wb3J0IHtkaWV9IGZyb20gJy4uL2Fzc2VydC5qcyc7XG5cbi8qKiBJbnB1dCBmb3IgdGhlIGdyYXBoLiAqL1xuZXhwb3J0IGludGVyZmFjZSBMb2NhdGlvbkxpc3Qge1xuICB3b3JsZE5hbWU6IHN0cmluZztcbiAgaXRlbXM6IFJlYWRvbmx5TWFwPG51bWJlciwgSXRlbUluZm8+O1xuICBzbG90czogUmVhZG9ubHlNYXA8bnVtYmVyLCBTbG90SW5mbz47XG4gIHJlcXVpcmVtZW50czogUmVhZG9ubHlNYXA8bnVtYmVyLCBJdGVyYWJsZTxJdGVyYWJsZTxudW1iZXI+Pj47XG4gIGNoZWNrTmFtZTogKG5vZGU6IG51bWJlcikgPT4gc3RyaW5nO1xuICBwcmVmaWxsOiAocmFuZG9tOiBSYW5kb20pID0+IE1hcDxudW1iZXIsIG51bWJlcj47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSXRlbUluZm8ge1xuICAvKiogVW5pcXVlIGl0ZW1zIGNhbiBvcHRpb25hbGx5IGJlIHNodWZmbGVkIHNlcGFyYXRlbHkuICovXG4gIHVuaXF1ZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBMb3NhYmxlIGl0ZW1zIGFyZSBhdCByaXNrIG9mIGJlaW5nIGxvc3QgaWYgdGhleSBhcmUgcGxhY2VkIGluIGEgbG9zc3kgc2xvdFxuICAgKiAoaS5lLiBpZiB0aGUgaW52ZW50b3J5IGlzIGZ1bGwpLlxuICAgKi9cbiAgbG9zYWJsZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBMb3NhYmxlIGl0ZW1zIG1heSBiZSBwcm90ZWN0ZWQsIG1lYW5pbmcgdGhhdCB0aGV5IHdpbGwgbm90IGJlIHBsYWNlZCBpbiBhXG4gICAqIGxvc3N5IHNsb3QuXG4gICAqL1xuICBwcmV2ZW50TG9zcz86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXZWlnaHQgZm9yIHBsYWNlbWVudC4gIEhpZ2hlciBudW1iZXJzIGFyZSBtb3JlIGxpa2VseSB0byBiZSBwbGFjZWQgZWFybGllci5cbiAgICogRGVmYXVsdCBpcyAxLiAgUG93ZXJmdWwgYW5kIGltcG9ydGFudCBpdGVtcyBzaG91bGQgYmUgZ2l2ZW4gbGFyZ2VyIHdlaWdodHNcbiAgICogdG8gbWFrZSBpdCBsZXNzIGxpa2VseSB0aGF0IHRoZXkgYWx3YXlzIGVuZCB1cCBpbiBlYXJseSBzcGhlcmVzLlxuICAgKi9cbiAgd2VpZ2h0PzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNsb3RJbmZvIHtcbiAgLyoqIFdoZXRoZXIgdGhlIHNsb3QgY2FuIGhvbGQgYSB1bmlxdWUgaXRlbS4gKi9cbiAgdW5pcXVlPzogYm9vbGVhbjtcbiAgLyoqIFdoZXRoZXIgbG9zYWJsZSBpdGVtcyBpbiB0aGlzIHNsb3QgYXJlIGF0IHJpc2sgb2YgYmVpbmcgbG9zdC4gKi9cbiAgbG9zc3k6IGJvb2xlYW47XG4gIC8qKiBXaGV0aGVyIHRoZSBzbG90IGlzIGRpc2FsbG93ZWQgZnJvbSBsb3NpbmcgaXRlbXMgKGUuZy4gdHJpZ2dlcnMpLiAqL1xuICBwcmV2ZW50TG9zcz86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXZWlnaHQgZm9yIHBsYWNpbmcgcHJvZ3Jlc3Npb24gaXRlbXMuICBEZWZhdWx0IGlzIDEuICBVc2VmdWwgZm9yIG1ha2luZ1xuICAgKiBkaXN0YW50IGFuZCBvdXQtb2YtdGhlIHdheSBjaGVja3MgbW9yZSB3b3J0aHdoaWxlLiAgQWx0ZXJuYXRpdmVseSwgd2VcbiAgICogY291bGQganVzdCBhdm9pZCBldmVyIHBsYWNpbmcgbWltaWNzIGluIHRoZXNlIGFyZWFzP1xuICAgKi9cbiAgd2VpZ2h0PzogbnVtYmVyO1xufVxuXG5leHBvcnQgdHlwZSBTbG90SW5kZXggPSBudW1iZXIgJiB7X19zbG90SW5kZXhfXzogbmV2ZXJ9O1xuZXhwb3J0IHR5cGUgSXRlbUluZGV4ID0gbnVtYmVyICYge19faXRlbUluZGV4X186IG5ldmVyfTtcbmV4cG9ydCB0eXBlIFNsb3RJZCA9IG51bWJlciAmIHtfX3Nsb3RJZF9fOiBuZXZlcn07XG5leHBvcnQgdHlwZSBJdGVtSWQgPSBudW1iZXIgJiB7X19pdGVtSWRfXzogbmV2ZXJ9O1xuXG4vKipcbiAqIEEgZ3JhcGggZGF0YSBzdHJ1Y3R1cmUuICBJbml0aWFsaXplZCB3aXRoIG9uZSBvciBtb3JlIGxvY2F0aW9uIGxpc3RzXG4gKiAoYSBzZXQgb2YgRE5GIGV4cHJlc3Npb25zIHByb3ZpZGluZyBhIGJ1bmNoIG9mIG51bWVyaWMgZmxhZ3MpLlxuICovXG5leHBvcnQgY2xhc3MgR3JhcGgge1xuXG4gIC8vcHJpdmF0ZSByZWFkb25seSByZXZlcnNlV29ybGRzOiBSZWFkb25seU1hcDxMb2NhdGlvbkxpc3QsIG51bWJlcj47XG4gIHByaXZhdGUgcmVhZG9ubHkgY29tbW9uOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2xvdHM6IEFycmF5TWFwPFNsb3RJbmRleCwgU2xvdElkPjtcbiAgcHJpdmF0ZSByZWFkb25seSBpdGVtczogQXJyYXlNYXA8SXRlbUluZGV4LCBJdGVtSWQ+O1xuICAvLyBOb3RlIHRoYXQgbm90IGV2ZXJ5IGl0ZW0gZ2V0cyBhbiBpbmRleCAtIG9ubHkgdGhvc2UgaW4gdGhlIGdyYXBoLlxuICBwcml2YXRlIHJlYWRvbmx5IHNsb3RJbmZvczogUmVhZG9ubHlNYXA8U2xvdElkLCBTbG90SW5mbz47XG4gIHByaXZhdGUgcmVhZG9ubHkgaXRlbUluZm9zOiBSZWFkb25seU1hcDxJdGVtSWQsIEl0ZW1JbmZvPjtcblxuICAvLyBJdGVtcyB0aGF0IHByb3ZpZGUgcHJvZ3Jlc3Npb24uXG4gIHByaXZhdGUgcmVhZG9ubHkgcHJvZ3Jlc3Npb246IFNldDxJdGVtSWQ+O1xuXG4gIC8vIC8qKiBNYXBwaW5nIG9mIHByb3ZpZGVzIHRvIHRoZSBzYW1lIHJlcXVpcmVzLiAqL1xuICAvLyBwcml2YXRlIHJlYWRvbmx5IGNvbW1vbkZpbGw6IEFycmF5TWFwPFNsb3RJbmRleCwgSXRlbUluZGV4PjtcblxuICAvKiogQml0c2V0cyBrZXllZCBieSBJdGVtSW5kZXgsIHJlcHJlc2VudCBhIERORiBjb25kaXRpb24uICovXG4gIHJlYWRvbmx5IGdyYXBoOiBLZXllZDxTbG90SW5kZXgsIHJlYWRvbmx5IEJpdHNbXT47XG4gIHJlYWRvbmx5IHVubG9ja3M6IEtleWVkPEl0ZW1JbmRleCwgcmVhZG9ubHkgU2xvdEluZGV4W10+O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgd29ybGRzOiByZWFkb25seSBMb2NhdGlvbkxpc3RbXSkge1xuICAgIC8vY29uc3QgcmV2ZXJzZVdvcmxkcyA9IG5ldyBNYXA8TG9jYXRpb25MaXN0LCBudW1iZXI+KCk7XG4gICAgLy9mb3IgKGxldCBpID0gMDsgaSA8IHdvcmxkcy5sZW5ndGg7IGkrKykge1xuICAgIC8vICByZXZlcnNlV29ybGRzLnNldCh3b3JsZHNbaV0sIGkpO1xuICAgIC8vfVxuICAgIC8vdGhpcy5yZXZlcnNlV29ybGRzID0gcmV2ZXJzZVdvcmxkcztcblxuICAgIC8vIEJ1aWxkIHVwIGEgbGlzdCBvZiBhbGwga25vd24gcHJvdmlkZXMvcmVxdWlyZXMuXG4gICAgY29uc3QgcHJvdmlkZWQgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBjb25zdCByZXF1aXJlZCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGNvbnN0IHNsb3RzID0gbmV3IE1hcDxTbG90SWQsIFNsb3RJbmZvPigpO1xuICAgIGNvbnN0IGl0ZW1zID0gbmV3IE1hcDxJdGVtSWQsIEl0ZW1JbmZvPigpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd29ybGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB3b3JsZCA9IHdvcmxkc1tpXTtcbiAgICAgIGNvbnN0IHdvcmxkSWQgPSBpIDw8IDI0O1xuICAgICAgZm9yIChjb25zdCBbcHJvdmlkZWRJZCwgcmVxdWlyZW1lbnRdIG9mIHdvcmxkLnJlcXVpcmVtZW50cykge1xuICAgICAgICBwcm92aWRlZC5hZGQod29ybGRJZCB8IHByb3ZpZGVkSWQpO1xuICAgICAgICBmb3IgKGNvbnN0IHJvdXRlIG9mIHJlcXVpcmVtZW50KSB7XG4gICAgICAgICAgZm9yIChjb25zdCBjb25kIG9mIHJvdXRlKSB7XG4gICAgICAgICAgICByZXF1aXJlZC5hZGQod29ybGRJZCB8IGNvbmQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSAgICAgICAgXG4gICAgICB9XG5cbiAgICAgIC8vIFByb2JhYmx5IGp1c3QgbWFrZSBhIGNvbW1vbiBpbmRleCBmaWxsIGFuZCBkbyBhIGZ1bGwgaW5kaXJlY3Rpb24/XG4gICAgICAvLyAgLSBpZiBpdCdzIGluIHRoZSBjb21tb24gZmlsbCwgdXNlIGl0LCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIHRoZVxuICAgICAgLy8gICAgaXRlbSBmaWxsP1xuXG4gICAgICBmb3IgKGNvbnN0IFtpdGVtSWQsIGluZm9dIG9mIHdvcmxkLml0ZW1zKSB7XG4gICAgICAgIGl0ZW1zLnNldCgod29ybGRJZCB8IGl0ZW1JZCkgYXMgSXRlbUlkLCBpbmZvKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgW3Nsb3RJZCwgaW5mb10gb2Ygd29ybGQuc2xvdHMpIHtcbiAgICAgICAgc2xvdHMuc2V0KCh3b3JsZElkIHwgc2xvdElkKSBhcyBTbG90SWQsIGluZm8pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvcHkgdGhlIG1hcHMgYW5kIHNhdmUgdGhlbSBiZWZvcmUgd2Ugc3RhcnQgZGVsZXRpbmcgZWxlbWVudHMuXG4gICAgdGhpcy5pdGVtSW5mb3MgPSBuZXcgTWFwKGl0ZW1zKTtcbiAgICB0aGlzLnNsb3RJbmZvcyA9IG5ldyBNYXAoc2xvdHMpO1xuXG4gICAgdGhpcy5wcm9ncmVzc2lvbiA9IG5ldyBTZXQocmVxdWlyZWQgYXMgU2V0PEl0ZW1JZD4pO1xuICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcy5rZXlzKCkpIHJlcXVpcmVkLmFkZChpdGVtKTsgLy8gbm9uLXByb2dyZXNzaW9uIGxhc3RcblxuICAgIGNvbnN0IGNvbW1vbiA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGNvbnN0IGV4dHJhUHJvdmlkZXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBjb25zdCBleHRyYVJlcXVpcmVzID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgZm9yIChjb25zdCBjaGVjayBvZiByZXF1aXJlZCkge1xuICAgICAgKHByb3ZpZGVkLmhhcyhjaGVjaykgPyBjb21tb24gOiBleHRyYVJlcXVpcmVzKS5hZGQoY2hlY2spO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGNoZWNrIG9mIHByb3ZpZGVkKSB7XG4gICAgICBpZiAoIXJlcXVpcmVkLmhhcyhjaGVjaykpIGV4dHJhUHJvdmlkZXMuYWRkKGNoZWNrKTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbW1vbiA9IGNvbW1vbi5zaXplO1xuICAgIHRoaXMuc2xvdHMgPSBuZXcgQXJyYXlNYXAoWy4uLmNvbW1vbiwgLi4uZXh0cmFQcm92aWRlc10gYXMgU2xvdElkW10pO1xuICAgIHRoaXMuaXRlbXMgPSBuZXcgQXJyYXlNYXAoWy4uLmNvbW1vbiwgLi4uZXh0cmFSZXF1aXJlc10gYXMgSXRlbUlkW10pO1xuXG4gICAgLy8gQnVpbGQgdXAgdGhlIGdyYXBoIG5vdyB0aGF0IHdlIGhhdmUgdGhlIGFycmF5IG1hcHMuXG4gICAgY29uc3QgZ3JhcGg6IEJpdHNbXVtdID0gW107XG4gICAgY29uc3QgdW5sb2NrczogQXJyYXk8U2V0PFNsb3RJbmRleD4+ID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3b3JsZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHdvcmxkSWQgPSBpIDw8IDI0O1xuICAgICAgZm9yIChjb25zdCBbc2xvdCwgcmVxXSBvZiB3b3JsZHNbaV0ucmVxdWlyZW1lbnRzKSB7XG4gICAgICAgIGNvbnN0IHNsb3RJbmRleCA9IHRoaXMuc2xvdHMuaW5kZXgoKHdvcmxkSWQgfCBzbG90KSBhcyBTbG90SWQpO1xuICAgICAgICBpZiAoc2xvdEluZGV4ID09IG51bGwpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb3ZpZGVkIGEgbm9uLXNsb3Q/ICR7aGV4KHNsb3QpfWApO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgY3Mgb2YgcmVxKSB7XG4gICAgICAgICAgY29uc3QgaXMgPVxuICAgICAgICAgICAgICBbLi4uY3NdLm1hcChjID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbXMuaW5kZXgoKHdvcmxkSWQgfCBjKSBhcyBJdGVtSWQpID8/IGRpZSgpKTtcbiAgICAgICAgICAoZ3JhcGhbc2xvdEluZGV4XSB8fCAoZ3JhcGhbc2xvdEluZGV4XSA9IFtdKSkucHVzaChCaXRzLmZyb20oaXMpKTtcbiAgICAgICAgICBmb3IgKGNvbnN0IGkgb2YgaXMpIHtcbiAgICAgICAgICAgICh1bmxvY2tzW2ldIHx8ICh1bmxvY2tzW2ldID0gbmV3IFNldCgpKSkuYWRkKHNsb3RJbmRleCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU2FuaXR5IGNoZWNrIHRvIG1ha2Ugc3VyZSBhbGwgc2xvdHMgYXJlIHByb3ZpZGVkLlxuICAgIGZvciAobGV0IGkgPSAwIGFzIFNsb3RJbmRleDsgaSA8IHRoaXMuc2xvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICghZ3JhcGhbaV0gfHwgIWdyYXBoW2ldLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBpZCA9IHRoaXMuc2xvdHMuZ2V0KGkpID8/IE5hTiBhcyBTbG90SWQ7XG4gICAgICAgIGNvbnN0IG5hbWUgPSB0aGlzLmNoZWNrTmFtZShpZCk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYE5vdGhpbmcgcHJvdmlkZWQgJCR7aGV4KGlkKX06ICR7bmFtZX0gKGluZGV4ICR7aX0pYCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZ3JhcGggPSBuZXcgS2V5ZWQoZ3JhcGgpO1xuICAgIHRoaXMudW5sb2NrcyA9IG5ldyBLZXllZCh1bmxvY2tzLm1hcChzcHJlYWQpKTtcbiAgfVxuXG4gIGFzeW5jIHNodWZmbGUoZmxhZ3NldDogRmxhZ1NldCxcbiAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbiAgICAgICAgICAgICAgICBhdHRlbXB0cyA9IDIwLCAvLyAwMFxuICAgICAgICAgICAgICAgIHByb2dyZXNzPzogUHJvZ3Jlc3NUcmFja2VyLFxuICAgICAgICAgICAgICAgIHNwb2lsZXI/OiBTcG9pbGVyKTogUHJvbWlzZTxNYXA8U2xvdElkLCBJdGVtSWQ+fG51bGw+IHtcbiAgICBpZiAocHJvZ3Jlc3MpIHByb2dyZXNzLmFkZFRhc2tzKE1hdGguZmxvb3IoYXR0ZW1wdHMgLyAxMDApKTtcbiAgICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8IGF0dGVtcHRzOyBhdHRlbXB0KyspIHtcbiAgICAgIGlmIChwcm9ncmVzcyAmJiAoYXR0ZW1wdCAlIDEwMCA9PT0gOTkpKSB7XG4gICAgICAgIHByb2dyZXNzLmFkZENvbXBsZXRlZCgxKTtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVxdWVzdEFuaW1hdGlvbkZyYW1lKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZpbGwgPSBuZXcgTXV0YWJsZUFycmF5QmlNYXA8U2xvdElkLCBJdGVtSWQ+KCk7XG4gICAgICB0aGlzLnByZWZpbGwoZmlsbCwgcmFuZG9tKTtcbiAgICAgIGNvbnN0IGluZGV4RmlsbCA9IHRoaXMuY29tcHJlc3NGaWxsKGZpbGwpO1xuICAgICAgY29uc3QgaXRlbXMgPSB0aGlzLml0ZW1Qb29sKGluZGV4RmlsbC52YWx1ZXMoKSwgcmFuZG9tKTtcbiAgICAgIGxldCBoYXMgPSBCaXRzLmZyb20obmV3IFNldChpdGVtcykpO1xuICAgICAgY29uc3QgYmFja3RyYWNrcyA9IE1hdGguZmxvb3IoYXR0ZW1wdCAvIDUpO1xuICAgICAgaWYgKCF0aGlzLmZpbGxJbnRlcm5hbChpbmRleEZpbGwsIGl0ZW1zLCBoYXMsIHJhbmRvbSwgZmxhZ3NldCwgYmFja3RyYWNrcykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBjb25zdCBwYXRoOiBudW1iZXJbXVtdfHVuZGVmaW5lZCA9IHNwb2lsZXIgPyBbXSA6IHVuZGVmaW5lZDtcbiAgICAgIGNvbnN0IGZpbmFsID0gdGhpcy50cmF2ZXJzZShpID0+IGluZGV4RmlsbC5nZXQoaSksIEJpdHMub2YoKSwgcGF0aCk7XG4gICAgICBpZiAoc3BvaWxlciAmJiBwYXRoKSB7XG4gICAgICAgIGZvciAoY29uc3QgW3RhcmdldCwgLi4uZGVwc10gb2YgcGF0aCkge1xuICAgICAgICAgIGlmICh0YXJnZXQgPCB0aGlzLmNvbW1vbiB8fCBpbmRleEZpbGwuaGFzKHRhcmdldCBhcyBTbG90SW5kZXgpKSB7XG4gICAgICAgICAgICBzcG9pbGVyLmFkZENoZWNrKFxuICAgICAgICAgICAgICAgIHRoaXMuc2xvdHMuZ2V0KHRhcmdldCBhcyBTbG90SW5kZXgpISxcbiAgICAgICAgICAgICAgICBkZXBzLm1hcChkID0+IHRoaXMuaXRlbXMuZ2V0KGQgYXMgSXRlbUluZGV4KSEpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIFRPRE8gLSBmbGFncyB0byBsb29zZW4gdGhpcyByZXF1aXJlbWVudD9cbiAgICAgIGlmIChmaW5hbC5zaXplICE9PSB0aGlzLnNsb3RzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBucyA9IChzaTogU2xvdEluZGV4KSA9PiB0aGlzLmNoZWNrTmFtZSh0aGlzLnNsb3RzLmdldChzaSkhKTtcbiAgICAgICAgY29uc3QgbWlzc2luZyA9IG5ldyBTZXQoWy4uLnRoaXMuc2xvdHNdLm1hcCh4ID0+IHhbMF0pKTtcbiAgICAgICAgZm9yIChjb25zdCBzIG9mIGZpbmFsKSBtaXNzaW5nLmRlbGV0ZShzKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihgSW5pdGlhbCBmaWxsIG5ldmVyIGZpbGxlZCBzbG90czpcbiAgJHtbLi4ubWlzc2luZ10ubWFwKG5zKS5zb3J0KCkuam9pbignXFxuICAnKX1gLCBmaW5hbCwgdGhpcyk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdGhpcy5leHBhbmRGaWxsKGluZGV4RmlsbCwgZmlsbCk7XG4gICAgICBjb25zdCBvdXQgPSB0aGlzLmZpbGxOb25Qcm9ncmVzc2lvbihmaWxsLCBmbGFnc2V0LCByYW5kb20pO1xuICAgICAgaWYgKG91dCA9PSBudWxsKSBjb250aW51ZTtcbiAgICAgIGlmIChwcm9ncmVzcykge1xuICAgICAgICBwcm9ncmVzcy5hZGRDb21wbGV0ZWQoTWF0aC5mbG9vcigoYXR0ZW1wdHMgLSBhdHRlbXB0KSAvIDEwMCkpO1xuICAgICAgfVxuICAgICAgaWYgKHNwb2lsZXIpIHtcbiAgICAgICAgZm9yIChjb25zdCBbc2xvdCwgaXRlbV0gb2YgZmlsbCkge1xuICAgICAgICAgIC8vIFRPRE8gLSBjbGVhbiB0aGlzIHVwLlxuICAgICAgICAgIGNvbnN0IG5hbWUgPSB0aGlzLmNoZWNrTmFtZShzbG90KS5yZXBsYWNlKC9eWzAtOWEtZl17M30gLywgJycpO1xuICAgICAgICAgIHNwb2lsZXIuYWRkU2xvdChzbG90LCBuYW1lLCBpdGVtKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIG91dDtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcml2YXRlIGZpbGxJbnRlcm5hbChmaWxsOiBNdXRhYmxlQXJyYXlCaU1hcDxTbG90SW5kZXgsIEl0ZW1JbmRleD4sXG4gICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBJdGVtSW5kZXhbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgaGFzOiBCaXRzLFxuICAgICAgICAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbiAgICAgICAgICAgICAgICAgICAgICAgZmxhZ3NldDogRmxhZ1NldCxcbiAgICAgICAgICAgICAgICAgICAgICAgYmFja3N0ZXBzOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBjb25zdCBmaXhlZCA9IG5ldyBTZXQoZmlsbC5rZXlzKCkpO1xuICAgIGZvciAobGV0IGJpdDogSXRlbUluZGV4IHwgdW5kZWZpbmVkID0gaXRlbXMucG9wKCk7IGJpdCAhPSBudWxsOyBiaXQgPSBpdGVtcy5wb3AoKSkge1xuICAgICAgaWYgKCFCaXRzLmhhcyhoYXMsIGJpdCkpIGNvbnRpbnVlOyAvLyBpdGVtIGFscmVhZHkgcGxhY2VkOiBza2lwXG4gICAgICBjb25zdCBpdGVtSW5mbyA9IHRoaXMuaXRlbUluZm9Gcm9tSW5kZXgoYml0KTtcbiAgICAgIGhhcyA9IEJpdHMud2l0aG91dChoYXMsIGJpdCk7XG4gICAgICBjb25zdCByZWFjaGFibGUgPVxuICAgICAgICAgIHRoaXMuZXhwYW5kUmVhY2hhYmxlKHRoaXMudHJhdmVyc2UoaSA9PiBmaWxsLmdldChpKSwgaGFzKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFnc2V0KTtcbiAgICAgIHJhbmRvbS5zaHVmZmxlKHJlYWNoYWJsZSk7XG4gICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgIGNvbnN0IGNoZWNrZWQgPSBuZXcgU2V0KGZpbGwua2V5cygpKTtcbiAgICAgIGZvciAoY29uc3Qgc2xvdCBvZiByZWFjaGFibGUpIHtcbiAgICAgICAgaWYgKGNoZWNrZWQuaGFzKHNsb3QpKSBjb250aW51ZTtcbiAgICAgICAgY2hlY2tlZC5hZGQoc2xvdCk7XG4gICAgICAgIGNvbnN0IHNsb3RJbmZvID0gdGhpcy5zbG90SW5mb0Zyb21JbmRleChzbG90KTtcbiAgICAgICAgaWYgKCFzbG90SW5mbyB8fCAhdGhpcy5maXRzKHNsb3RJbmZvLCBpdGVtSW5mbywgZmxhZ3NldCkpIGNvbnRpbnVlO1xuICAgICAgICBmaWxsLnNldChzbG90LCBiaXQpO1xuICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgaWYgKGZvdW5kKSBjb250aW51ZTtcbiAgICAgIGNoZWNrZWQuY2xlYXIoKTtcbiAgICAgIGlmIChiYWNrc3RlcHMtLSA+IDApIHtcbiAgICAgICAgLy8gdGFrZSBhIGJhY2stc3RlcFxuICAgICAgICBmb3IgKGNvbnN0IHNsb3Qgb2YgcmVhY2hhYmxlKSB7XG4gICAgICAgICAgaWYgKGNoZWNrZWQuaGFzKHNsb3QpIHx8ICFmaWxsLmhhcyhzbG90KSB8fCBmaXhlZC5oYXMoc2xvdCkpIGNvbnRpbnVlO1xuICAgICAgICAgIGNoZWNrZWQuYWRkKHNsb3QpO1xuICAgICAgICAgIGNvbnN0IHNsb3RJbmZvID0gdGhpcy5zbG90SW5mb0Zyb21JbmRleChzbG90KTtcbiAgICAgICAgICBpZiAoIXNsb3RJbmZvIHx8ICF0aGlzLmZpdHMoc2xvdEluZm8sIGl0ZW1JbmZvLCBmbGFnc2V0KSkgY29udGludWU7XG4gICAgICAgICAgY29uc3QgcHJldmlvdXNJdGVtID0gZmlsbC5yZXBsYWNlKHNsb3QsIGJpdCkgPz8gZGllKCk7XG4gICAgICAgICAgaGFzID0gQml0cy53aXRoKGhhcywgcHJldmlvdXNJdGVtKTtcbiAgICAgICAgICBpdGVtcy5wdXNoKHByZXZpb3VzSXRlbSk7XG4gICAgICAgICAgcmFuZG9tLnNodWZmbGUoaXRlbXMpO1xuICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpZiAoZm91bmQpIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgLy8gY29uc3QgbnMgPSAoc2k6IFNsb3RJbmRleCkgPT4gdGhpcy5jaGVja05hbWUodGhpcy5zbG90cy5nZXQoc2kpISk7XG4gICAgICAvLyBjb25zdCBuaSA9IChpaTogSXRlbUluZGV4KSA9PiB0aGlzLmNoZWNrTmFtZSh0aGlzLml0ZW1zLmdldChpaSkhKTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGBQb29sOlxcbiAgJHtpdGVtcy5tYXAobmkpLmpvaW4oJ1xcbiAgJyl9YCk7XG4gICAgICAvLyBjb25zb2xlLmxvZyhgRmlsbDpcXG4gICR7Wy4uLmZpbGxdLm1hcCgoW3MsaV0pID0+IGAke25zKHMpfTogJHtuaShpKX1gKS5qb2luKCdcXG4gICcpfWApO1xuICAgICAgLy8gY29uc29sZS5lcnJvcihgUkVST0xMOiBDb3VsZCBub3QgcGxhY2UgaXRlbSBpbmRleCAke2JpdH06ICR7bmkoYml0KX1gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvLyBhZGRzIHdlaWdodHNcbiAgcHJpdmF0ZSBleHBhbmRSZWFjaGFibGUoc2xvdHM6IEl0ZXJhYmxlPFNsb3RJbmRleD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGZsYWdzZXQ6IEZsYWdTZXQpOiBTbG90SW5kZXhbXSB7XG4gICAgY29uc3Qgb3V0OiBTbG90SW5kZXhbXSA9IFtdO1xuICAgIGZvciAoY29uc3Qgc2xvdCBvZiBzbG90cykge1xuICAgICAgY29uc3QgaW5mbyA9IHRoaXMuc2xvdEluZm9Gcm9tSW5kZXgoc2xvdCk7XG4gICAgICAvLyBkb24ndCBib3RoZXIgd2l0aCBub24tdW5pcXVlIHNsb3RzIGF0IHRoaXMgc3RhZ2UuXG4gICAgICBpZiAoIWluZm8gfHwgZmxhZ3NldC5wcmVzZXJ2ZVVuaXF1ZUNoZWNrcygpICYmICFpbmZvLnVuaXF1ZSkgY29udGludWU7XG4gICAgICBhZGRDb3BpZXMob3V0LCBzbG90LCBpbmZvLndlaWdodCB8fCAxKTtcbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHByaXZhdGUgaXRlbVBvb2woZXhjbHVkZTogSXRlcmFibGU8SXRlbUluZGV4PiwgcmFuZG9tOiBSYW5kb20pOiBJdGVtSW5kZXhbXSB7XG4gICAgY29uc3QgZXhjbHVkZVNldCA9IG5ldyBTZXQoZXhjbHVkZSk7XG4gICAgY29uc3QgYXJyOiBJdGVtSW5kZXhbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgW2lkLCBpbmZvXSBvZiB0aGlzLml0ZW1JbmZvcykge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLml0ZW1zLmluZGV4KGlkKTtcbiAgICAgIC8vIHNraXAgbm9uLXByb2dyZXNzaW9uIGFuZCBhbHJlYWR5LXBsYWNlZCBpdGVtc1xuICAgICAgaWYgKGluZGV4ID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgaWYgKCF0aGlzLnByb2dyZXNzaW9uLmhhcyhpZCkpIGNvbnRpbnVlO1xuICAgICAgaWYgKGV4Y2x1ZGVTZXQuaGFzKGluZGV4KSkgY29udGludWU7XG4gICAgICBhZGRDb3BpZXMoYXJyLCBpbmRleCwgaW5mby53ZWlnaHQgfHwgMSk7XG4gICAgfVxuICAgIHJldHVybiByYW5kb20uc2h1ZmZsZShhcnIpO1xuICB9XG5cbiAgLy8gVE9ETyAtIGluc3RlYWQgb2YgcGx1bWJpbmcgdGhlIGZsYWdzZXQgdGhyb3VnaCBoZXJlLCBjb25zaWRlclxuICAvLyBidWlsZGluZyBpdCBpbnRvIHRoZSBTbG90SW5mbz8gIE9yIHRoZSBJdGVtSW5mbywgc2luY2UgaXQnc1xuICAvLyBwb3NzaWJsZSBmb3IgYSB1bmlxdWUgc2xvdCB0byBhY2NlcHQgYSBub251bmlxdWUgaXRlbSwgYnV0XG4gIC8vIGEgdW5pcXVlIGl0ZW0gbXVzdCBiZSBpbiBhIHVuaXF1ZSBzbG90Li4uIHNhbWUgZGlmZmVyZW5jZVxuICBwcml2YXRlIGZpdHMoc2xvdDogU2xvdEluZm8sIGl0ZW06IEl0ZW1JbmZvLCBmbGFnc2V0OiBGbGFnU2V0KTogYm9vbGVhbiB7XG4gICAgaWYgKGZsYWdzZXQucHJlc2VydmVVbmlxdWVDaGVja3MoKSAmJlxuICAgICAgICBpdGVtLnVuaXF1ZSAmJiAhc2xvdC51bmlxdWUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgcHJldmVudExvc3MgPSBpdGVtLnByZXZlbnRMb3NzIHx8IHNsb3QucHJldmVudExvc3M7XG4gICAgaWYgKHNsb3QubG9zc3kgJiYgaXRlbS5sb3NhYmxlICYmIHByZXZlbnRMb3NzKSByZXR1cm4gZmFsc2U7XG4gICAgLy8gVE9ETyAtIGZsYWcgZm9yIFwicHJvdGVjdCBhbGwgbG9zYWJsZSBpdGVtc1wiXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBmaWxsTm9uUHJvZ3Jlc3Npb24oZmlsbDogTXV0YWJsZUFycmF5QmlNYXA8U2xvdElkLCBJdGVtSWQ+LFxuICAgICAgICAgICAgICAgICAgICAgZmxhZ3NldDogRmxhZ1NldCxcbiAgICAgICAgICAgICAgICAgICAgIHJhbmRvbTogUmFuZG9tKTogTWFwPFNsb3RJZCwgSXRlbUlkPnxudWxsIHtcbiAgICAvLyBGaWd1cmUgb3V0IHdoYXQgc3RpbGwgbmVlZHMgdG8gYmUgZmlsbGVkLiAgV2lsbCBiZSBtb3N0bHkgZmlsbGVyXG4gICAgLy8gaXRlbXMuICBJdGVtcyBhcmUgc3BsaXQgaW50byB0aHJlZSBncm91cHM6ICgxKSBmaXJzdCBpdGVtcyBpcyBhbnlcbiAgICAvLyB1bmlxdWVzIHRoYXQgbmVlZCB0byBnbyBpbnRvIHVuaXF1ZSBzbG90cyAoaS5lLiBvbmx5IGlmIGBFdWAgaXNcbiAgICAvLyBzZXQpLCAoMikgZWFybHkgaXRlbXMgaXMgYW55dGhpbmcgdGhhdCBuZWVkcyBzcGVjaWFsIHRyZWF0bWVudCB0b1xuICAgIC8vIHByZXZlbnQgcGxhY2VtZW50IGluIGEgbG9zc3kgc2xvdCwgKDMpIG90aGVyIGl0ZW1zIGlzIGV2ZXJ5dGhpbmcgZWxzZS5cbiAgICBjb25zdCBpdGVtUGFzc2VzOiBJdGVtSWRbXVtdID0gW1tdLCBbXSwgW11dO1xuICAgIC8vIFNsb3RzIGFyZSBicm9rZW4gaW50byB0d28gcGFzc2VzOiAoMSkgcmVzdHJpY3RlZCBhbmQgKDIpIHVucmVzdHJpY3RlZC5cbiAgICBjb25zdCBzbG90UGFzc2VzOiBTbG90SWRbXVtdID0gW1tdLCBbXV07XG5cbiAgICBmb3IgKGNvbnN0IFtpdGVtSWQsIGluZm9dIG9mIHRoaXMuaXRlbUluZm9zKSB7XG4gICAgICBpZiAoZmlsbC5oYXNWYWx1ZShpdGVtSWQpKSBjb250aW51ZTtcbiAgICAgIGxldCBpbmRleCA9IDI7XG4gICAgICBpZiAoaW5mby5sb3NhYmxlICYmIGluZm8ucHJldmVudExvc3MpIGluZGV4ID0gMTtcbiAgICAgIGlmIChmbGFnc2V0LnByZXNlcnZlVW5pcXVlQ2hlY2tzKCkgJiYgaW5mby51bmlxdWUpIGluZGV4ID0gMDtcbiAgICAgIGl0ZW1QYXNzZXNbaW5kZXhdLnB1c2goaXRlbUlkKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBbc2xvdElkLCBpbmZvXSBvZiB0aGlzLnNsb3RJbmZvcykge1xuICAgICAgaWYgKGZpbGwuaGFzKHNsb3RJZCkpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgaW5kZXggPSBpbmZvLmxvc3N5ICYmIGluZm8ucHJldmVudExvc3MgPyAwIDogMTtcbiAgICAgIHNsb3RQYXNzZXNbaW5kZXhdLnB1c2goc2xvdElkKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBwYXNzIG9mIFsuLi5pdGVtUGFzc2VzLCAuLi5zbG90UGFzc2VzXSkge1xuICAgICAgcmFuZG9tLnNodWZmbGUocGFzcyk7XG4gICAgfVxuXG4gICAgY29uc3QgbiA9IChzaTogbnVtYmVyKSA9PiB0aGlzLmNoZWNrTmFtZShzaSk7XG4gICAgY29uc3Qgc2MgPSBpdGVycy5jb3VudChpdGVycy5jb25jYXQoLi4uc2xvdFBhc3NlcykpO1xuICAgIGNvbnN0IGljID0gaXRlcnMuY291bnQoaXRlcnMuY29uY2F0KC4uLml0ZW1QYXNzZXMpKTtcbiAgICBpZiAoaWMgPiBzYykge1xuICAgICAgY29uc29sZS5sb2coYFNsb3RzICR7c2N9OlxcbiAgJHtbLi4uaXRlcnMuY29uY2F0KC4uLnNsb3RQYXNzZXMpXS5tYXAobikuam9pbignXFxuICAnKX1gKTtcbiAgICAgIGNvbnNvbGUubG9nKGBJdGVtcyAke2ljfTpcXG4gICR7Wy4uLml0ZXJzLmNvbmNhdCguLi5pdGVtUGFzc2VzKV0ubWFwKG4pLmpvaW4oJ1xcbiAgJyl9YCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRvbyBtYW55IGl0ZW1zYCk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVycy5jb25jYXQoLi4uaXRlbVBhc3NlcykpIHtcbiAgICAgIC8vIFRyeSB0byBwbGFjZSB0aGUgaXRlbSwgc3RhcnRpbmcgd2l0aCBlYXJsaWVzIGZpcnN0LlxuICAgICAgLy8gTWltaWNzIGNvbWUgYmVmb3JlIGNvbnN1bWFibGVzIGJlY2F1c2UgdGhlcmUncyBmZXdlciBwbGFjZXMgdGhleSBjYW4gZ28uXG4gICAgICAvLyBTaW5jZSBrZXkgc2xvdHMgYXJlIGFsbG93ZWQgdG8gY29udGFpbiBjb25zdW1hYmxlcyAoZXZlbiBpbiBmdWxsIHNodWZmbGUpLFxuICAgICAgLy8gd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdCB0aGUgdW5pcXVlcyBnbyBpbnRvIHRob3NlIHNsb3RzIGZpcnN0LlxuICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgICBmb3IgKGNvbnN0IHNsb3RzIG9mIFsuLi5zbG90UGFzc2VzXSkge1xuICAgICAgICBpZiAoZm91bmQpIGJyZWFrO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNsb3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZml0cyh0aGlzLnNsb3RJbmZvcy5nZXQoc2xvdHNbaV0pISxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUluZm9zLmdldChpdGVtKSEsIGZsYWdzZXQpKSB7XG4gICAgICAgICAgICBmaWxsLnNldChzbG90c1tpXSwgaXRlbSk7XG4gICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICBzbG90cy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgLy8gY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGZpbGwgZXh0cmEgaXRlbSAke2l0ZW19LiBTbG90czogJHtlYXJseVNsb3RzfSwgJHtvdGhlclNsb3RzfWApO1xuICAgICAgICBjb25zb2xlLmxvZyhgU2xvdHM6XFxuICAke1suLi5pdGVycy5jb25jYXQoLi4uc2xvdFBhc3NlcyldLm1hcChuKS5qb2luKCdcXG4gICcpfWApO1xuICAgICAgICAvL2NvbnNvbGUubG9nKGBGaWxsOlxcbiAgJHtbLi4uZmlsbF0ubWFwKChbcyxpXSkgPT4gYCR7bnMocyl9OiAke25pKGkpfWApLmpvaW4oJ1xcbiAgJyl9YCk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYFJFUk9MTDogQ291bGQgbm90IHBsYWNlIGl0ZW0gJHtuKGl0ZW0pfWApO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5ldyBNYXAoZmlsbCk7XG4gIH1cblxuICAvLyBOT1RFOiBmb3IgYW4gSW5kZXhGaWxsLCB0aGlzIGlzIGp1c3QgZ2V0KCksIGJ1dCBmb3JcbiAgLy8gYW4gSWRGaWxsLCB3ZSBuZWVkIHRvIG1hcCBpdCBiYWNrIGFuZCBmb3J0aC4uLlxuICB0cmF2ZXJzZShmaWxsOiAoc2xvdDogU2xvdEluZGV4KSA9PiBJdGVtSW5kZXh8dW5kZWZpbmVkLFxuICAgICAgICAgICBoYXM6IEJpdHMsXG4gICAgICAgICAgIHBhdGg/OiBudW1iZXJbXVtdKTogU2V0PFNsb3RJbmRleD4ge1xuICAgIGhhcyA9IEJpdHMuY2xvbmUoaGFzKTtcbiAgICBjb25zdCByZWFjaGFibGUgPSBuZXcgU2V0PFNsb3RJbmRleD4oKTtcbiAgICBjb25zdCBxdWV1ZSA9IG5ldyBTZXQ8U2xvdEluZGV4PigpO1xuICAgIGZvciAobGV0IGkgPSAwIGFzIFNsb3RJbmRleDsgaSA8IHRoaXMuc2xvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICh0aGlzLmdyYXBoLmdldChpKSA9PSBudWxsKSB7XG4gICAgICAgIGNvbnNvbGUuZGlyKHRoaXMpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVucmVhY2hhYmxlIHNsb3QgJHtpfWApO1xuICAgICAgfVxuICAgICAgcXVldWUuYWRkKGkgYXMgU2xvdEluZGV4KTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBuIG9mIHF1ZXVlKSB7XG4gICAgICBxdWV1ZS5kZWxldGUobik7XG4gICAgICBpZiAocmVhY2hhYmxlLmhhcyhuKSkgY29udGludWU7XG4gICAgICAvLyBjYW4gd2UgcmVhY2ggaXQ/XG4gICAgICBjb25zdCBuZWVkZWQgPSB0aGlzLmdyYXBoLmdldChuKTtcbiAgICAgIGlmIChuZWVkZWQgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBOb3QgaW4gZ3JhcGg6ICR7bn1gKTtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBuZWVkZWQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgaWYgKCFCaXRzLmNvbnRhaW5zQWxsKGhhcywgbmVlZGVkW2ldKSkgY29udGludWU7XG4gICAgICAgIGlmIChwYXRoKSBwYXRoLnB1c2goW24sIC4uLkJpdHMuYml0cyhuZWVkZWRbaV0pXSk7XG4gICAgICAgIHJlYWNoYWJsZS5hZGQobik7XG4gICAgICAgIC8vIFRPRE8gLS0tIG5lZWQgdG8gZmlndXJlIG91dCB3aGF0IHRvIGRvIGhlcmUuXG4gICAgICAgIC8vICAgICAgLS0tIGZpbGwgd291bGQgbGlrZSB0byBiZSB6ZXJvLWJhc2VkIGJ1dCBkb2Vzbid0IG5lZWQgdG8gYmUuXG4gICAgICAgIC8vICAgICAgICAgIGNvdWxkIHVzZSBhIHNpbXBsZSBwYWlyIG9mIE1hcHMsIHBvc3NpYmx5P1xuICAgICAgICAvLyAgICAgICAgICBvciBmcm9udC1sb2FkIHRoZSBpdGVtcz9cbiAgICAgICAgLy8gICBzbG90czogMXh4IG90aGVyc1xuICAgICAgICAvLyAgIGl0ZW1zOiAyeHggb3RoZXJzXG4gICAgICAgIC8vIGJ1dCB3ZSB3YW50IHNhbWUgZmxhZ3MgdG8gaGF2ZSBzYW1lIGluZGV4XG4gICAgICAgIC8vICAgc2xvdHM6IChmaXhlZCkgKHJlcXVpcmVkIHNsb3RzKSAoZXh0cmEgc2xvdHMpXG4gICAgICAgIC8vICAgaXRlbXM6IChmaXhlZCkgKHJlcXVpcmVkIHNsb3RzKSAoaXRlbXMpXG4gICAgICAgIC8vIGlmIG4gaXMgYSBzbG90IHRoZW4gYWRkIHRoZSBpdGVtIHRvIGhhcy5cbiAgICAgICAgY29uc3QgaXRlbXM6IEl0ZW1JbmRleFtdID0gW107XG4gICAgICAgIGlmIChuIDwgdGhpcy5jb21tb24pIGl0ZW1zLnB1c2gobiBhcyBudW1iZXIgYXMgSXRlbUluZGV4KTtcbiAgICAgICAgY29uc3QgZmlsbGVkID0gZmlsbChuKTtcbiAgICAgICAgaWYgKGZpbGxlZCAhPSBudWxsKSBpdGVtcy5wdXNoKGZpbGxlZCk7XG4gICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykge1xuICAgICAgICAgIGhhcyA9IEJpdHMud2l0aChoYXMsIGl0ZW0pO1xuICAgICAgICAgIGZvciAoY29uc3QgaiBvZiB0aGlzLnVubG9ja3MuZ2V0KGl0ZW0pIHx8IFtdKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5ncmFwaC5nZXQoaikgPT0gbnVsbCkge1xuICAgICAgICAgICAgICBjb25zb2xlLmRpcih0aGlzKTtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBZGRpbmcgYmFkIG5vZGUgJHtqfSBmcm9tIHVubG9jayAke2l0ZW19YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBxdWV1ZS5hZGQoaik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVhY2hhYmxlO1xuICB9XG5cbiAgZXhwYW5kRmlsbChpbmRleEZpbGw6IE11dGFibGVBcnJheUJpTWFwPFNsb3RJbmRleCwgSXRlbUluZGV4PixcbiAgICAgICAgICAgICBmaWxsOiBNdXRhYmxlQXJyYXlCaU1hcDxTbG90SWQsIEl0ZW1JZD4pIHtcbiAgICBmb3IgKGNvbnN0IFtzbG90SW5kZXgsIGl0ZW1JbmRleF0gb2YgaW5kZXhGaWxsKSB7XG4gICAgICBjb25zdCBzbG90SWQgPSB0aGlzLnNsb3RzLmdldChzbG90SW5kZXgpO1xuICAgICAgY29uc3QgaXRlbUlkID0gdGhpcy5pdGVtcy5nZXQoaXRlbUluZGV4KTtcbiAgICAgIGlmIChzbG90SWQgPT0gbnVsbCB8fCBpdGVtSWQgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBtaXNzaW5nYCk7XG4gICAgICBmaWxsLnJlcGxhY2Uoc2xvdElkLCBpdGVtSWQpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXByZXNzRmlsbChmaWxsOiBNdXRhYmxlQXJyYXlCaU1hcDxTbG90SWQsIEl0ZW1JZD4pOlxuICBNdXRhYmxlQXJyYXlCaU1hcDxTbG90SW5kZXgsIEl0ZW1JbmRleD4ge1xuICAgIGNvbnN0IGluZGV4RmlsbCA9IG5ldyBNdXRhYmxlQXJyYXlCaU1hcDxTbG90SW5kZXgsIEl0ZW1JbmRleD4oKTtcbiAgICBmb3IgKGNvbnN0IFtzbG90SWQsIGl0ZW1JZF0gb2YgZmlsbCkge1xuICAgICAgY29uc3Qgc2xvdEluZGV4ID0gdGhpcy5zbG90cy5pbmRleChzbG90SWQpO1xuICAgICAgY29uc3QgaXRlbUluZGV4ID0gdGhpcy5pdGVtcy5pbmRleChpdGVtSWQpO1xuICAgICAgaWYgKHNsb3RJbmRleCA9PSBudWxsIHx8IGl0ZW1JbmRleCA9PSBudWxsKSB7XG4gICAgICAgIC8vIFRPRE8gLSB0aGlzIGlzIG5vdCB1bnJlYXNvbmFibGUgLSB3ZSBjYW4gcHJlLWZpbGwgYSBzbG90IChhbHdheXNcbiAgICAgICAgLy8gdHJhY2tlZCkgd2l0aCBhIG5vbi1wcm9ncmVzc2lvbiBpdGVtLi4uIGhvdyB0byBoYW5kbGU/IHdoYXQgdG8gbWFwXG4gICAgICAgIC8vIHRvPyAgQ2FuIHdlIG1ha2UgdXAgYSBkdW1teSBpbmRleCBvciBzb21ldGhpbmc/XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBCYWQgc2xvdC9pdGVtOiAke3Nsb3RJZH0gJHtzbG90SW5kZXh9ICR7aXRlbUlkfSAke2l0ZW1JbmRleH1gKTtcbiAgICAgIH1cbiAgICAgIGluZGV4RmlsbC5zZXQoc2xvdEluZGV4LCBpdGVtSW5kZXgpO1xuICAgIH1cbiAgICByZXR1cm4gaW5kZXhGaWxsO1xuICB9XG5cbiAgY2hlY2tOYW1lKGlkOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLndvcmxkc1tpZCA+Pj4gMjRdLmNoZWNrTmFtZShpZCAmIDB4ZmZmZmZmKTtcbiAgfVxuXG4gIHByZWZpbGwoZmlsbDogTXV0YWJsZUFycmF5QmlNYXA8U2xvdElkLCBJdGVtSWQ+LCByYW5kb206IFJhbmRvbSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy53b3JsZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHdvcmxkSWQgPSBpIDw8IDI0O1xuICAgICAgY29uc3Qgd29ybGRGaWxsID0gdGhpcy53b3JsZHNbaV0ucHJlZmlsbChyYW5kb20pO1xuICAgICAgZm9yIChjb25zdCBbc2xvdCwgaXRlbV0gb2Ygd29ybGRGaWxsKSB7XG4gICAgICAgIGZpbGwuc2V0KCh3b3JsZElkIHwgc2xvdCkgYXMgU2xvdElkLCAod29ybGRJZCB8IGl0ZW0pIGFzIEl0ZW1JZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaXRlbUluZm9Gcm9tSW5kZXgoaXRlbTogSXRlbUluZGV4KTogSXRlbUluZm8ge1xuICAgIGNvbnN0IGlkID0gdGhpcy5pdGVtcy5nZXQoaXRlbSk7XG4gICAgaWYgKGlkID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgQmFkIGl0ZW06ICR7aXRlbX1gKTtcbiAgICByZXR1cm4gdGhpcy5pdGVtSW5mb0Zyb21JZChpZCk7XG4gIH1cblxuICBpdGVtSW5mb0Zyb21JZChpZDogSXRlbUlkKTogSXRlbUluZm8ge1xuICAgIGNvbnN0IGluZm8gPSB0aGlzLml0ZW1JbmZvcy5nZXQoaWQpO1xuICAgIGlmIChpbmZvID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBpbmZvOiAke2hleChpZCl9YCk7XG4gICAgcmV0dXJuIGluZm87XG4gIH1cblxuICBzbG90SW5mb0Zyb21JbmRleChzbG90OiBTbG90SW5kZXgpOiBTbG90SW5mb3x1bmRlZmluZWQge1xuICAgIGNvbnN0IGlkID0gdGhpcy5zbG90cy5nZXQoc2xvdCk7XG4gICAgaWYgKGlkID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgQmFkIHNsb3Q6ICR7c2xvdH1gKTtcbiAgICByZXR1cm4gdGhpcy5zbG90SW5mb0Zyb21JZChpZCk7XG4gIH1cblxuICBzbG90SW5mb0Zyb21JZChpZDogU2xvdElkKTogU2xvdEluZm98dW5kZWZpbmVkIHtcbiAgICBjb25zdCBpbmZvID0gdGhpcy5zbG90SW5mb3MuZ2V0KGlkKTtcbiAgICBpZiAoaW5mbyAhPSBudWxsKSByZXR1cm4gaW5mbztcbiAgICAvLyB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgaW5mbzogJHtoZXgoaWQpfWApO1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gYWRkQ29waWVzPFQ+KGFycjogVFtdLCBlbGVtOiBULCBjb3BpZXM6IG51bWJlcikge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGNvcGllczsgaSsrKSB7XG4gICAgYXJyLnB1c2goZWxlbSk7XG4gIH1cbn1cblxuXG4vLyBUT0RPIC0gY2xlYW4gdGhpcyB1cFxuaW50ZXJmYWNlIFByb2dyZXNzVHJhY2tlciB7XG4gIGFkZFRhc2tzKHRhc2tzOiBudW1iZXIpOiB2b2lkO1xuICBhZGRDb21wbGV0ZWQodGFza3M6IG51bWJlcik6IHZvaWQ7XG59XG4iXX0=