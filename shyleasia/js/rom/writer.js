import { hex } from './util.js';
function page(addr) {
    return addr >>> 13;
}
class Chunk {
    constructor(start, end) {
        this.start = start;
        this.end = end;
        this.page = page(start);
        if (page(end - 1) !== this.page)
            throw new Error('Chunk spans pages');
        this.pos = start;
    }
    free() {
        return this.end - this.pos;
    }
    find(data, rom) {
        for (let i = this.start; i <= this.pos - data.length; i++) {
            let found = true;
            for (let j = 0; j < data.length; j++) {
                if (rom[i + j] !== data[j]) {
                    found = false;
                    break;
                }
            }
            if (found)
                return i;
        }
        return -1;
    }
}
export class Writer {
    constructor(rom, chr) {
        this.rom = rom;
        this.chr = chr;
        this.chunks = [];
        this.writes = [];
        this.promises = [];
        this.free = [];
    }
    report() {
        for (const chunk of this.chunks) {
            const free = chunk.free();
            if (free) {
                console.log(`Free: ${free} bytes ${hex(chunk.pos)}..${hex(chunk.end)}`);
            }
        }
    }
    alloc(start, end) {
        while (page(end - 1) > page(start)) {
            const boundary = (page(start) + 1) << 13;
            this.addChunk(new Chunk(start, boundary - 1));
            start = boundary;
        }
        this.addChunk(new Chunk(start, end));
    }
    addChunk(c) {
        this.chunks.push(c);
        this.free[c.page] = (this.free[c.page] || 0) + c.free();
    }
    async write(data, start, end, name) {
        const startPage = page(start);
        const endPage = page(end - 1);
        const p = new Promise((resolve, reject) => {
            this.writes.push({ data, resolve, reject, startPage, endPage, name });
        });
        this.promises.push(p.catch(() => { }));
        return p;
    }
    async commit() {
        while (this.writes.length) {
            const writes = this.writes;
            this.writes = [];
            const promises = this.promises;
            this.promises = [];
            writes.sort((a, b) => ((a.endPage - a.startPage) - (b.endPage - b.startPage)) ||
                (b.data.length - a.data.length));
            for (const write of writes) {
                const address = this.find(write);
                if (address >= 0) {
                    write.resolve(address);
                }
                else {
                    this.writeOne(write);
                }
            }
            await Promise.all(promises);
            await 0;
            await 0;
            await 0;
        }
    }
    find({ data, startPage, endPage }) {
        for (const chunk of this.chunks) {
            if (chunk.page < startPage || chunk.page > endPage)
                continue;
            const found = chunk.find(data, this.rom);
            if (found >= 0)
                return found;
        }
        return -1;
    }
    writeOne(write) {
        for (const chunk of this.chunks) {
            if (chunk.page < write.startPage || chunk.page > write.endPage)
                continue;
            if (chunk.free() < write.data.length)
                continue;
            this.rom.subarray(chunk.pos, chunk.pos + write.data.length).set(write.data);
            write.resolve(chunk.pos);
            this.free[chunk.page] -= write.data.length;
            if (DEBUG && DEBUG_PAGE.has(chunk.page)) {
                console.log(`${write.name}: writing ${write.data.length} bytes at ${hex(chunk.pos)}: ${Array.from(write.data, hex).join(' ')} | FREE ${this.free.map((v, k) => `${hex(2 * k)}:${v}`).join('/')}`);
            }
            chunk.pos += write.data.length;
            return;
        }
        if (DEBUG) {
            console.log(`LOOKING FOR CHUNK: ${write.data.length} bytes in ${hex(write.startPage)}..${hex(write.endPage)}`);
            for (const chunk of this.chunks) {
                if (chunk.page < write.startPage || chunk.page > write.endPage) {
                    console.log(`wrong page: ${hex(chunk.pos)}..${hex(chunk.end)} -> ${hex(chunk.page)}`);
                    continue;
                }
                if (chunk.free() < write.data.length) {
                    console.log(`not enough free: ${hex(chunk.pos)}..${hex(chunk.end)} -> ${chunk.free()}`);
                    continue;
                }
            }
            console.log(this.chunks);
        }
        console.log(`${write.name}: WRITE FAILED ${write.data.length} bytes: ${Array.from(write.data, hex).join(' ')}`);
        write.reject(new Error(`Could not find sufficient chunk in ${hex(write.startPage)}..${hex(write.endPage)} to write ${write.name}: ${write.data}`));
    }
}
const DEBUG = false;
const DEBUG_PAGE = new Set([0xe, 0xf]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JpdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3JvbS93cml0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFPLEdBQUcsRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUVwQyxTQUFTLElBQUksQ0FBQyxJQUFZO0lBQ3hCLE9BQU8sSUFBSSxLQUFLLEVBQUUsQ0FBQztBQUNyQixDQUFDO0FBRUQsTUFBTSxLQUFLO0lBSVQsWUFBcUIsS0FBYSxFQUFXLEdBQVc7UUFBbkMsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUFXLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDdEQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDO0lBQ25CLENBQUM7SUFFRCxJQUFJO1FBQ0YsT0FBTyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDN0IsQ0FBQztJQUdELElBQUksQ0FBQyxJQUFrQixFQUFFLEdBQWU7UUFDdEMsS0FBSyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDekQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ2pCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNwQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUMxQixLQUFLLEdBQUcsS0FBSyxDQUFDO29CQUNkLE1BQU07aUJBQ1A7YUFDRjtZQUNELElBQUksS0FBSztnQkFBRSxPQUFPLENBQUMsQ0FBQztTQUNyQjtRQUVELE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDWixDQUFDO0NBQ0Y7QUFhRCxNQUFNLE9BQU8sTUFBTTtJQVFqQixZQUFxQixHQUFlLEVBQVcsR0FBZTtRQUF6QyxRQUFHLEdBQUgsR0FBRyxDQUFZO1FBQVcsUUFBRyxHQUFILEdBQUcsQ0FBWTtRQUo3QyxXQUFNLEdBQVksRUFBRSxDQUFDO1FBQzlCLFdBQU0sR0FBWSxFQUFFLENBQUM7UUFDckIsYUFBUSxHQUF1QixFQUFFLENBQUM7UUFJbEMsU0FBSSxHQUFhLEVBQUUsQ0FBQztJQUZxQyxDQUFDO0lBTWxFLE1BQU07UUFDSixLQUFLLE1BQU0sS0FBSyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDL0IsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzFCLElBQUksSUFBSSxFQUFFO2dCQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLFVBQVUsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUN6RTtTQUNGO0lBQ0gsQ0FBQztJQUdELEtBQUssQ0FBQyxLQUFhLEVBQUUsR0FBVztRQUM5QixPQUFPLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ2xDLE1BQU0sUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxDQUFDLEtBQUssRUFBRSxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM5QyxLQUFLLEdBQUcsUUFBUSxDQUFDO1NBQ2xCO1FBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQsUUFBUSxDQUFDLENBQVE7UUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMxRCxDQUFDO0lBR0QsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFrQixFQUFFLEtBQWEsRUFBRSxHQUFXLEVBQUUsSUFBWTtRQUV0RSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUM5QixNQUFNLENBQUMsR0FBRyxJQUFJLE9BQU8sQ0FBUyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNoRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUN0RSxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN0QyxPQUFPLENBQUMsQ0FBQztJQUNYLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTTtRQUVWLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7WUFDekIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUMzQixJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztZQUNqQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQy9CLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1lBQ25CLE1BQU0sQ0FBQyxJQUFJLENBQ1AsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDakUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDckMsS0FBSyxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUU7Z0JBQzFCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2pDLElBQUksT0FBTyxJQUFJLENBQUMsRUFBRTtvQkFFaEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDeEI7cUJBQU07b0JBQ0wsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDdEI7YUFDRjtZQUNELE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUc1QixNQUFNLENBQUMsQ0FBQztZQUNSLE1BQU0sQ0FBQyxDQUFDO1lBQ1IsTUFBTSxDQUFDLENBQUM7U0FDVDtJQU1ILENBQUM7SUFFTyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBUTtRQUM1QyxLQUFLLE1BQU0sS0FBSyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDL0IsSUFBSSxLQUFLLENBQUMsSUFBSSxHQUFHLFNBQVMsSUFBSSxLQUFLLENBQUMsSUFBSSxHQUFHLE9BQU87Z0JBQUUsU0FBUztZQUM3RCxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDekMsSUFBSSxLQUFLLElBQUksQ0FBQztnQkFBRSxPQUFPLEtBQUssQ0FBQztTQUM5QjtRQUNELE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDWixDQUFDO0lBRU8sUUFBUSxDQUFDLEtBQVk7UUFFM0IsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQy9CLElBQUksS0FBSyxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLE9BQU87Z0JBQUUsU0FBUztZQUN6RSxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU07Z0JBQUUsU0FBUztZQUUvQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVFLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBRTNDLElBQUksS0FBSyxJQUFJLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN2QyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksYUFBYSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sYUFDMUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQVEsRUFBQyxDQUFRLEVBQUMsRUFBRSxDQUFBLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDbEY7WUFFRCxLQUFLLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQy9CLE9BQU87U0FDUjtRQUVELElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLGFBQWEsR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQ2xFLEtBQUssR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDNUMsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUMvQixJQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLFNBQVMsSUFBSSxLQUFLLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxPQUFPLEVBQUU7b0JBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQUMsU0FBUztpQkFDakc7Z0JBQ0QsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7b0JBQ3BDLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxLQUFLLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUFDLFNBQVM7aUJBQ25HO2FBQ0Y7WUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUMxQjtRQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxrQkFBa0IsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLFdBQy9DLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELEtBQUssQ0FBQyxNQUFNLENBQ1IsSUFBSSxLQUFLLENBQUMsc0NBQXNDLEdBQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUNwRCxLQUFLLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsS0FBSyxDQUFDLElBQUksS0FBSyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3ZGLENBQUM7Q0FDRjtBQUVELE1BQU0sS0FBSyxHQUFZLEtBQUssQ0FBQztBQUM3QixNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtEYXRhLCBoZXh9IGZyb20gJy4vdXRpbC5qcyc7XG5cbmZ1bmN0aW9uIHBhZ2UoYWRkcjogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIGFkZHIgPj4+IDEzO1xufVxuXG5jbGFzcyBDaHVuayB7XG4gIHBhZ2U6IG51bWJlcjtcbiAgcG9zOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgc3RhcnQ6IG51bWJlciwgcmVhZG9ubHkgZW5kOiBudW1iZXIpIHtcbiAgICB0aGlzLnBhZ2UgPSBwYWdlKHN0YXJ0KTtcbiAgICBpZiAocGFnZShlbmQgLSAxKSAhPT0gdGhpcy5wYWdlKSB0aHJvdyBuZXcgRXJyb3IoJ0NodW5rIHNwYW5zIHBhZ2VzJyk7XG4gICAgdGhpcy5wb3MgPSBzdGFydDtcbiAgfVxuXG4gIGZyZWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuZW5kIC0gdGhpcy5wb3M7XG4gIH1cblxuICAvKiogUmV0dXJucyB0aGUgYWRkcmVzcyAoPj0gMCkgaWYgZm91bmQsIG9yIC0xIGlmIG5vdCBmb3VuZC4gKi9cbiAgZmluZChkYXRhOiBEYXRhPG51bWJlcj4sIHJvbTogVWludDhBcnJheSk6IG51bWJlciB7XG4gICAgZm9yIChsZXQgaSA9IHRoaXMuc3RhcnQ7IGkgPD0gdGhpcy5wb3MgLSBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgZm91bmQgPSB0cnVlO1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBkYXRhLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGlmIChyb21baSArIGpdICE9PSBkYXRhW2pdKSB7XG4gICAgICAgICAgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGZvdW5kKSByZXR1cm4gaTtcbiAgICB9XG4gICAgLy8gY29uc29sZS5sb2coYGNvdWxkIG5vdCBmaW5kICR7ZGF0YS5tYXAoeD0+eC50b1N0cmluZygxNikpfWApO1xuICAgIHJldHVybiAtMTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgV3JpdGUge1xuICByZWFkb25seSBkYXRhOiBEYXRhPG51bWJlcj47XG4gIHJlYWRvbmx5IHJlc29sdmU6IChhZGRyZXNzOiBudW1iZXIpID0+IHZvaWQ7XG4gIHJlYWRvbmx5IHJlamVjdDogKGVycjogdW5rbm93bikgPT4gdm9pZDtcbiAgcmVhZG9ubHkgc3RhcnRQYWdlOiBudW1iZXI7XG4gIHJlYWRvbmx5IGVuZFBhZ2U6IG51bWJlcjsgLy8gaW5jbHVzaXZlXG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbn1cblxuLy8gdHlwZSBEYXRhID0gVWludDhBcnJheSB8IG51bWJlcltdO1xuXG5leHBvcnQgY2xhc3MgV3JpdGVyIHtcblxuICAvL3ByaXZhdGUgd3JpdGluZyA9IGZhbHNlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgY2h1bmtzOiBDaHVua1tdID0gW107XG4gIHByaXZhdGUgd3JpdGVzOiBXcml0ZVtdID0gW107XG4gIHByaXZhdGUgcHJvbWlzZXM6IFByb21pc2U8dW5rbm93bj5bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogVWludDhBcnJheSwgcmVhZG9ubHkgY2hyOiBVaW50OEFycmF5KSB7fVxuXG4gIHByaXZhdGUgZnJlZTogbnVtYmVyW10gPSBbXTtcblxuICAvLyBUT0RPOiBtb3ZlKCk/XG5cbiAgcmVwb3J0KCkge1xuICAgIGZvciAoY29uc3QgY2h1bmsgb2YgdGhpcy5jaHVua3MpIHtcbiAgICAgIGNvbnN0IGZyZWUgPSBjaHVuay5mcmVlKCk7XG4gICAgICBpZiAoZnJlZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhgRnJlZTogJHtmcmVlfSBieXRlcyAke2hleChjaHVuay5wb3MpfS4uJHtoZXgoY2h1bmsuZW5kKX1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKiogTm90ZTogc3RhcnQgYW5kIGVuZCBwYWdlcyBtdXN0IGJlIHRoZSBzYW1lISAgJ2VuZCcgaXMgZXhjbHVzaXZlLiAqL1xuICBhbGxvYyhzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlcikge1xuICAgIHdoaWxlIChwYWdlKGVuZCAtIDEpID4gcGFnZShzdGFydCkpIHtcbiAgICAgIGNvbnN0IGJvdW5kYXJ5ID0gKHBhZ2Uoc3RhcnQpICsgMSkgPDwgMTM7XG4gICAgICB0aGlzLmFkZENodW5rKG5ldyBDaHVuayhzdGFydCwgYm91bmRhcnkgLSAxKSk7XG4gICAgICBzdGFydCA9IGJvdW5kYXJ5O1xuICAgIH1cbiAgICB0aGlzLmFkZENodW5rKG5ldyBDaHVuayhzdGFydCwgZW5kKSk7XG4gIH1cblxuICBhZGRDaHVuayhjOiBDaHVuaykge1xuICAgIHRoaXMuY2h1bmtzLnB1c2goYyk7XG4gICAgdGhpcy5mcmVlW2MucGFnZV0gPSAodGhpcy5mcmVlW2MucGFnZV0gfHwgMCkgKyBjLmZyZWUoKTtcbiAgfVxuXG4gIC8vIFRPRE86IGNvbnNpZGVyIHJlbmFtaW5nIHRoaXMgdG8gcXVldWUoKSBvciBwbGFuKCkgb3Igc29tZXRoaW5nP1xuICBhc3luYyB3cml0ZShkYXRhOiBEYXRhPG51bWJlcj4sIHN0YXJ0OiBudW1iZXIsIGVuZDogbnVtYmVyLCBuYW1lOiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIC8vaWYgKHRoaXMud3JpdGluZykgY29uc29sZS5sb2coYExhdGUgd3JpdGU6ICR7bmFtZX1gKTtcbiAgICBjb25zdCBzdGFydFBhZ2UgPSBwYWdlKHN0YXJ0KTtcbiAgICBjb25zdCBlbmRQYWdlID0gcGFnZShlbmQgLSAxKTtcbiAgICBjb25zdCBwID0gbmV3IFByb21pc2U8bnVtYmVyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLndyaXRlcy5wdXNoKHtkYXRhLCByZXNvbHZlLCByZWplY3QsIHN0YXJ0UGFnZSwgZW5kUGFnZSwgbmFtZX0pO1xuICAgIH0pO1xuICAgIHRoaXMucHJvbWlzZXMucHVzaChwLmNhdGNoKCgpID0+IHt9KSk7XG4gICAgcmV0dXJuIHA7XG4gIH1cblxuICBhc3luYyBjb21taXQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy90aGlzLndyaXRpbmcgPSB0cnVlO1xuICAgIHdoaWxlICh0aGlzLndyaXRlcy5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IHdyaXRlcyA9IHRoaXMud3JpdGVzO1xuICAgICAgdGhpcy53cml0ZXMgPSBbXTtcbiAgICAgIGNvbnN0IHByb21pc2VzID0gdGhpcy5wcm9taXNlcztcbiAgICAgIHRoaXMucHJvbWlzZXMgPSBbXTtcbiAgICAgIHdyaXRlcy5zb3J0KFxuICAgICAgICAgIChhLCBiKSA9PiAoKGEuZW5kUGFnZSAtIGEuc3RhcnRQYWdlKSAtIChiLmVuZFBhZ2UgLSBiLnN0YXJ0UGFnZSkpIHx8XG4gICAgICAgICAgKGIuZGF0YS5sZW5ndGggLSBhLmRhdGEubGVuZ3RoKSk7XG4gICAgICBmb3IgKGNvbnN0IHdyaXRlIG9mIHdyaXRlcykge1xuICAgICAgICBjb25zdCBhZGRyZXNzID0gdGhpcy5maW5kKHdyaXRlKTtcbiAgICAgICAgaWYgKGFkZHJlc3MgPj0gMCkge1xuICAgICAgICAgIC8vY29uc29sZS5sb2coYCR7d3JpdGUubmFtZX06IG92ZXJsYXBzIGF0ICR7aGV4KGFkZHJlc3MpfWApO1xuICAgICAgICAgIHdyaXRlLnJlc29sdmUoYWRkcmVzcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy53cml0ZU9uZSh3cml0ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICAgIC8vIE5PVEU6IFRoaXMgaXMgcHJldHR5IGJhZCAtIGhvdyBjYW4gd2UgdGVsbCB3aGVuIGFsbCB0aGUgY29uc3RpdHVlbnRcbiAgICAgIC8vIHByb21pc2VzIGFyZSBhY3R1YWxseSBhZGRlZD8/P1xuICAgICAgYXdhaXQgMDtcbiAgICAgIGF3YWl0IDA7XG4gICAgICBhd2FpdCAwO1xuICAgIH1cbiAgICAvL3RoaXMud3JpdGluZyA9IGZhbHNlO1xuICAgIC8vIGNvbnNvbGUubG9nKGBGaW5pc2hlZCB3cml0aW5nICQke3RoaXMuc3RhcnQudG9TdHJpbmcoMTYpfS4uJCR7dGhpcy5wb3MudG9TdHJpbmcoMTYpXG4gICAgLy8gICAgICAgICAgICAgIH0uICAke3RoaXMuZW5kIC0gdGhpcy5wb3N9IGJ5dGVzIGZyZWVgKTtcbiAgICAvLyBUT0RPIC0gc3VtbWFyaXplIGFsbCBmcmVlIGNodW5rcz8/P1xuICAgIC8vICAgLS0gZmVlZCBmcmVlIGNodW5rIGdpdmVuIHBhZ2UgaW50byBkZWZpbmUgZm9yIGFzc2VtYmxlcj9cbiAgfVxuXG4gIHByaXZhdGUgZmluZCh7ZGF0YSwgc3RhcnRQYWdlLCBlbmRQYWdlfTogV3JpdGUpOiBudW1iZXIge1xuICAgIGZvciAoY29uc3QgY2h1bmsgb2YgdGhpcy5jaHVua3MpIHtcbiAgICAgIGlmIChjaHVuay5wYWdlIDwgc3RhcnRQYWdlIHx8IGNodW5rLnBhZ2UgPiBlbmRQYWdlKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IGZvdW5kID0gY2h1bmsuZmluZChkYXRhLCB0aGlzLnJvbSk7XG4gICAgICBpZiAoZm91bmQgPj0gMCkgcmV0dXJuIGZvdW5kO1xuICAgIH1cbiAgICByZXR1cm4gLTE7XG4gIH1cblxuICBwcml2YXRlIHdyaXRlT25lKHdyaXRlOiBXcml0ZSkge1xuICAgIC8vIGZpbmQgYSBjaHVuayB3aXRoIGVub3VnaCBzcGFjZSB0byBmaXQgdGhlIGRhdGEuXG4gICAgZm9yIChjb25zdCBjaHVuayBvZiB0aGlzLmNodW5rcykge1xuICAgICAgaWYgKGNodW5rLnBhZ2UgPCB3cml0ZS5zdGFydFBhZ2UgfHwgY2h1bmsucGFnZSA+IHdyaXRlLmVuZFBhZ2UpIGNvbnRpbnVlO1xuICAgICAgaWYgKGNodW5rLmZyZWUoKSA8IHdyaXRlLmRhdGEubGVuZ3RoKSBjb250aW51ZTtcbiAgICAgIC8vIGxvb2tzIGxpa2UgaXQgZml0cyFcbiAgICAgIHRoaXMucm9tLnN1YmFycmF5KGNodW5rLnBvcywgY2h1bmsucG9zICsgd3JpdGUuZGF0YS5sZW5ndGgpLnNldCh3cml0ZS5kYXRhKTtcbiAgICAgIHdyaXRlLnJlc29sdmUoY2h1bmsucG9zKTtcbiAgICAgIHRoaXMuZnJlZVtjaHVuay5wYWdlXSAtPSB3cml0ZS5kYXRhLmxlbmd0aDtcblxuICAgICAgaWYgKERFQlVHICYmIERFQlVHX1BBR0UuaGFzKGNodW5rLnBhZ2UpKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGAke3dyaXRlLm5hbWV9OiB3cml0aW5nICR7d3JpdGUuZGF0YS5sZW5ndGh9IGJ5dGVzIGF0ICR7XG4gICAgICAgICAgICAgICAgICAgICBoZXgoY2h1bmsucG9zKX06ICR7QXJyYXkuZnJvbSh3cml0ZS5kYXRhLCBoZXgpLmpvaW4oJyAnKX0gfCBGUkVFICR7XG4gICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWUubWFwKCh2Om51bWJlcixrOm51bWJlcik9PmAke2hleCgyKmspfToke3Z9YCkuam9pbignLycpfWApO1xuICAgICAgfVxuXG4gICAgICBjaHVuay5wb3MgKz0gd3JpdGUuZGF0YS5sZW5ndGg7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKERFQlVHKSB7XG4gICAgICBjb25zb2xlLmxvZyhgTE9PS0lORyBGT1IgQ0hVTks6ICR7d3JpdGUuZGF0YS5sZW5ndGh9IGJ5dGVzIGluICR7aGV4KHdyaXRlLnN0YXJ0UGFnZSlcbiAgICAgICAgICAgICAgICAgICAgICAgfS4uJHtoZXgod3JpdGUuZW5kUGFnZSl9YCk7XG4gICAgICBmb3IgKGNvbnN0IGNodW5rIG9mIHRoaXMuY2h1bmtzKSB7XG4gICAgICAgIGlmIChjaHVuay5wYWdlIDwgd3JpdGUuc3RhcnRQYWdlIHx8IGNodW5rLnBhZ2UgPiB3cml0ZS5lbmRQYWdlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coYHdyb25nIHBhZ2U6ICR7aGV4KGNodW5rLnBvcyl9Li4ke2hleChjaHVuay5lbmQpfSAtPiAke2hleChjaHVuay5wYWdlKX1gKTsgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNodW5rLmZyZWUoKSA8IHdyaXRlLmRhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coYG5vdCBlbm91Z2ggZnJlZTogJHtoZXgoY2h1bmsucG9zKX0uLiR7aGV4KGNodW5rLmVuZCl9IC0+ICR7Y2h1bmsuZnJlZSgpfWApOyBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc29sZS5sb2codGhpcy5jaHVua3MpO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGAke3dyaXRlLm5hbWV9OiBXUklURSBGQUlMRUQgJHt3cml0ZS5kYXRhLmxlbmd0aH0gYnl0ZXM6ICR7XG4gICAgICAgICAgICAgICAgIEFycmF5LmZyb20od3JpdGUuZGF0YSwgaGV4KS5qb2luKCcgJyl9YCk7XG4gICAgd3JpdGUucmVqZWN0KFxuICAgICAgICBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIHN1ZmZpY2llbnQgY2h1bmsgaW4gJHtoZXgod3JpdGUuc3RhcnRQYWdlKVxuICAgICAgICAgICAgICAgICAgICAgICB9Li4ke2hleCh3cml0ZS5lbmRQYWdlKX0gdG8gd3JpdGUgJHt3cml0ZS5uYW1lfTogJHt3cml0ZS5kYXRhfWApKTtcbiAgfVxufVxuXG5jb25zdCBERUJVRzogYm9vbGVhbiA9IGZhbHNlO1xuY29uc3QgREVCVUdfUEFHRSA9IG5ldyBTZXQoWzB4ZSwgMHhmXSk7XG4iXX0=