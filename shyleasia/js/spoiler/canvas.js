import { die } from '../assert.js';
import { seq } from '../rom/util.js';
export class Canvas {
    constructor(rom, height, width, layers = 1) {
        this.rom = rom;
        this._width = width;
        this._height = height;
        this.element = document.createElement('div');
        this.canvas = document.createElement('canvas');
        this.element.appendChild(this.canvas);
        this.canvas.width = width;
        this.canvas.height = height;
        this.ctx = this.canvas.getContext('2d') || die();
        this._minX = this._minY = Infinity;
        this._maxX = this._maxY = -Infinity;
        this.palettes = new Uint32Array(0x400);
        this.layers = seq(layers, () => new Uint32Array(width * height));
        this.data = this.layers[0];
        for (let i = 0; i < 0x100; i++) {
            for (let j = 0; j < 4; j++) {
                const color = COLORS[rom.palettes[i].color(j)];
                this.palettes[i << 2 | j] = color | 0xff000000;
            }
        }
    }
    useLayer(layer) {
        this.data = this.layers[layer] || die(`Bad layer: ${layer}`);
    }
    resizeWidth(arr, width) {
        const data = new Uint32Array(width * this._height);
        const min = Math.min(width, this._width);
        for (let y = 0; y < this._height; y++) {
            data.subarray(y * width, y + width + min)
                .set(arr.subarray(y * this._width, y * this._width + min));
        }
        return data;
    }
    resizeHeight(arr, height) {
        const data = new Uint32Array(this._width * height);
        const min = this._width * Math.min(height, this._height);
        data.subarray(0, min).set(arr.subarray(0, min));
        return data;
    }
    get width() { return this._width; }
    set width(width) {
        for (let i = 0; i < this.layers.length; i++) {
            this.layers[i] = this.resizeWidth(this.layers[i], width);
        }
        this._width = width;
        this.canvas.width = width;
    }
    get height() { return this._height; }
    set height(height) {
        for (let i = 0; i < this.layers.length; i++) {
            this.layers[i] = this.resizeHeight(this.layers[i], height);
        }
        this._height = height;
        this.canvas.height = height;
    }
    get minX() { return this._minX; }
    get maxX() { return this._maxX; }
    get minY() { return this._minY; }
    get maxY() { return this._maxY; }
    fill(color) {
        this.data.fill(color);
    }
    clear(background) {
        const fillColor = background != null ? this.palettes[background << 2] : 0;
        this._minX = this._minY = Infinity;
        this._maxX = this._maxY = -Infinity;
        this.layers[0].fill(fillColor);
        for (let i = 1; i < this.layers.length; i++) {
            this.layers[i].fill(0);
        }
    }
    toDataUrl(cropToContent = false) {
        return this.canvas.toDataURL('image/png');
    }
    render() {
        let canvas = this.canvas;
        let ctx = this.ctx;
        for (let i = 0; i < this.layers.length; i++) {
            if (i) {
                canvas = document.createElement('canvas');
                canvas.width = this.canvas.width;
                canvas.height = this.canvas.height;
                ctx = canvas.getContext('2d') || die();
            }
            const uint8 = new Uint8Array(this.layers[i].buffer);
            const data = ctx.getImageData(0, 0, this._width, this._height);
            data.data.set(uint8);
            ctx.putImageData(data, 0, 0);
            if (i)
                this.ctx.drawImage(canvas, 0, 0);
        }
    }
    rect(y, x, height, width, color) {
        const y0 = Math.max(0, y);
        const x0 = Math.max(0, x);
        const y1 = Math.min(this._height, y + height);
        const x1 = Math.min(this._width, x + width);
        for (y = y0; y < y1; y++) {
            for (x = x0; x < x1; x++) {
                this.data[y * this._width + x] = color;
            }
        }
    }
    tile(y, x, id, attr) {
        if (x < 0 || y < 0 || x + 8 >= this._width || y + 8 >= this._height)
            return;
        const pat = this.rom.patterns[id].flip(attr << 6);
        for (let r = 0; r < 8; r++) {
            let hi = pat.pixels[8 | r] << 1;
            let lo = pat.pixels[r];
            for (let c = 7; c >= 0; c--) {
                const z = hi & 2 | lo & 1;
                hi >>>= 1;
                lo >>>= 1;
                if (z) {
                    this.data[(y + r) * this._width + x + c] =
                        this.palettes[attr & 0x3fc | z];
                }
            }
        }
        this._minX = Math.min(this._minX, x);
        this._maxX = Math.max(this._maxX, x + 8);
        this._minY = Math.min(this._minY, y);
        this._maxY = Math.max(this._maxY, y + 8);
    }
    metatile(y, x, id, locid, frame = 0) {
        const loc = this.rom.locations[locid];
        const patterns = [...loc.tilePatterns];
        if (loc.animation) {
            patterns[1] = this.rom.tileAnimations[loc.animation].pages[frame & 7];
        }
        const palettes = [...loc.tilePalettes, 0x7f];
        const tileset = this.rom.tilesets[(loc.tileset & 0x7f) >>> 2];
        const palette = palettes[tileset.attrs[id]];
        for (let r = 0; r < 2; r++) {
            for (let c = 0; c < 2; c++) {
                const tile = tileset.tiles[r << 1 | c][id];
                const pattern = patterns[tile & 0x80 ? 1 : 0] << 6 | tile & 0x7f;
                const x1 = x + (c << 3);
                const y1 = y + (r << 3);
                this.tile(y1, x1, pattern, palette << 2);
            }
        }
    }
    metasprite(y, x, id, locid, offset = 0, frame = 0) {
        const loc = this.rom.locations[locid];
        let metasprite = this.rom.metasprites[id];
        const patterns = [0x40, 0x42, ...loc.spritePatterns];
        const palettes = [0, 1, ...loc.spritePalettes];
        let mirrored = false;
        if (metasprite.mirrored != null) {
            metasprite = this.rom.metasprites[metasprite.mirrored];
            mirrored = true;
        }
        if (!metasprite || !metasprite.used)
            return;
        const version = frame & metasprite.frameMask;
        for (let [dx, dy, attr, tile] of metasprite.sprites[version]) {
            if (dx == 0x80)
                break;
            dx = signed(dx);
            dy = signed(dy);
            tile = (tile + offset) & 0xff;
            const patternPage = patterns[tile >> 6];
            const palette = (palettes[attr & 3] + 0xb0) & 0xff;
            const pattern = patternPage << 6 | tile & 0x3f;
            if (mirrored) {
                dx = -8 - dx;
                attr ^= 0x40;
            }
            this.tile(y + dy, x + dx, pattern, palette << 2 | attr >> 6);
        }
    }
    text(y, x, text, palette = 0x12) {
        for (let i = 0; i < text.length; i++) {
            this.tile(y, x + 8 * i, text.charCodeAt(i) | 0xf00, palette << 2);
        }
    }
}
const COLORS = [
    0x525252, 0xB40000, 0xA00000, 0xB1003D, 0x740069, 0x00005B, 0x00005F, 0x001840,
    0x002F10, 0x084A08, 0x006700, 0x124200, 0x6D2800, 0x000000, 0x000000, 0x000000,
    0xC4D5E7, 0xFF4000, 0xDC0E22, 0xFF476B, 0xD7009F, 0x680AD7, 0x0019BC, 0x0054B1,
    0x006A5B, 0x008C03, 0x00AB00, 0x2C8800, 0xA47200, 0x000000, 0x000000, 0x000000,
    0xF8F8F8, 0xFFAB3C, 0xFF7981, 0xFF5BC5, 0xFF48F2, 0xDF49FF, 0x476DFF, 0x00B4F7,
    0x00E0FF, 0x00E375, 0x03F42B, 0x78B82E, 0xE5E218, 0x787878, 0x000000, 0x000000,
    0xFFFFFF, 0xFFF2BE, 0xF8B8B8, 0xF8B8D8, 0xFFB6FF, 0xFFC3FF, 0xC7D1FF, 0x9ADAFF,
    0x88EDF8, 0x83FFDD, 0xB8F8B8, 0xF5F8AC, 0xFFFFB0, 0xF8D8F8, 0x000000, 0x000000,
];
function signed(x) {
    return x < 0x80 ? x : x - 0x100;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Nwb2lsZXIvY2FudmFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFFakMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTXJDLE1BQU0sT0FBTyxNQUFNO0lBaUJqQixZQUFxQixHQUFRLEVBQUUsTUFBYyxFQUFFLEtBQWEsRUFBRSxNQUFNLEdBQUcsQ0FBQztRQUFuRCxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QyxJQUFJLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUMxQixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDNUIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNqRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDO1FBQ25DLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUNwQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksV0FBVyxDQUFDLEtB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QUFJLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUNyQzthQUNGO1NBQ0Y7UUFDRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFRCxRQUFRLENBQUMsQ0FBUyxFQUFFLENBQVMsRUFBRSxFQUFVLEVBQUUsS0FBYSxFQUFFLEtBQUssR0FBRyxDQUFDO1FBQ2pFLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkMsSUFBSSxHQUFHLENBQUMsU0FBUyxFQUFFO1lBRWpCLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztTQUN2RTtRQUNELE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzdDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxJQUFJ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LEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUTtJQUM5RSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUTtJQUM5RSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUTtJQUM5RSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUTtDQUMvRSxDQUFDO0FBRUYsU0FBUyxNQUFNLENBQUMsQ0FBUztJQUN2QixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztBQUNsQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtkaWV9IGZyb20gJy4uL2Fzc2VydC5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7IHNlcSB9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcblxuLy8gV3JhcHBlciBhcm91bmQgYSBjYW52YXMgd2l0aCBidWlsdC1pbiBjYXBhYmlsaXR5IHRvIGRvIHNvbWUgdXNlZnVsXG4vLyB0aGluZ3MgbGlrZSBkaXNwbGF5aW5nIHNwZWNpZmljIHNwcml0ZXMgYW5kIHRleHQuICBBbHNvIHVuZGVyc3RhbmRzXG4vLyB0aGUgUk9NJ3MgYnVpbHQtaW4gcGFsZXR0ZXMuXG5cbmV4cG9ydCBjbGFzcyBDYW52YXMge1xuXG4gIHJlYWRvbmx5IGVsZW1lbnQ6IEhUTUxEaXZFbGVtZW50O1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudDtcbiAgcHJpdmF0ZSByZWFkb25seSBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcbiAgcHJpdmF0ZSByZWFkb25seSBwYWxldHRlczogVWludDMyQXJyYXk7XG5cbiAgcHJpdmF0ZSBfaGVpZ2h0OiBudW1iZXI7XG4gIHByaXZhdGUgX3dpZHRoOiBudW1iZXI7XG4gIHByaXZhdGUgX21pblk6IG51bWJlcjtcbiAgcHJpdmF0ZSBfbWF4WTogbnVtYmVyO1xuICBwcml2YXRlIF9taW5YOiBudW1iZXI7XG4gIHByaXZhdGUgX21heFg6IG51bWJlcjtcbiAgcHJpdmF0ZSBkYXRhOiBVaW50MzJBcnJheTtcbiAgcHJpdmF0ZSBsYXllcnM6IFVpbnQzMkFycmF5W107XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20sIGhlaWdodDogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBsYXllcnMgPSAxKSB7XG4gICAgdGhpcy5fd2lkdGggPSB3aWR0aDtcbiAgICB0aGlzLl9oZWlnaHQgPSBoZWlnaHQ7XG4gICAgdGhpcy5lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgdGhpcy5jYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICB0aGlzLmVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpO1xuICAgIHRoaXMuY2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgIHRoaXMuY3R4ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKSB8fCBkaWUoKTtcbiAgICB0aGlzLl9taW5YID0gdGhpcy5fbWluWSA9IEluZmluaXR5O1xuICAgIHRoaXMuX21heFggPSB0aGlzLl9tYXhZID0gLUluZmluaXR5O1xuICAgIHRoaXMucGFsZXR0ZXMgPSBuZXcgVWludDMyQXJyYXkoMHg0MDApO1xuICAgIHRoaXMubGF5ZXJzID0gc2VxKGxheWVycywgKCkgPT4gbmV3IFVpbnQzMkFycmF5KHdpZHRoICogaGVpZ2h0KSk7XG4gICAgdGhpcy5kYXRhID0gdGhpcy5sYXllcnNbMF07XG5cbiAgICAvLyBpbml0aWFsaXplIHBhbGV0dGVzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAweDEwMDsgaSsrKSB7XG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDQ7IGorKykge1xuICAgICAgICBjb25zdCBjb2xvciA9IENPTE9SU1tyb20ucGFsZXR0ZXNbaV0uY29sb3IoaildO1xuICAgICAgICB0aGlzLnBhbGV0dGVzW2kgPDwgMiB8IGpdID0gY29sb3IgfCAweGZmMDAwMDAwO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHVzZUxheWVyKGxheWVyOiBudW1iZXIpIHtcbiAgICB0aGlzLmRhdGEgPSB0aGlzLmxheWVyc1tsYXllcl0gfHwgZGllKGBCYWQgbGF5ZXI6ICR7bGF5ZXJ9YCk7XG4gIH1cblxuICBwcml2YXRlIHJlc2l6ZVdpZHRoKGFycjogVWludDMyQXJyYXksIHdpZHRoOiBudW1iZXIpOiBVaW50MzJBcnJheSB7XG4gICAgY29uc3QgZGF0YSA9IG5ldyBVaW50MzJBcnJheSh3aWR0aCAqIHRoaXMuX2hlaWdodCk7XG4gICAgY29uc3QgbWluID0gTWF0aC5taW4od2lkdGgsIHRoaXMuX3dpZHRoKTtcbiAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuX2hlaWdodDsgeSsrKSB7XG4gICAgICBkYXRhLnN1YmFycmF5KHkgKiB3aWR0aCwgeSArIHdpZHRoICsgbWluKVxuICAgICAgICAgIC5zZXQoYXJyLnN1YmFycmF5KHkgKiB0aGlzLl93aWR0aCwgeSAqIHRoaXMuX3dpZHRoICsgbWluKSk7XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgcHJpdmF0ZSByZXNpemVIZWlnaHQoYXJyOiBVaW50MzJBcnJheSwgaGVpZ2h0OiBudW1iZXIpOiBVaW50MzJBcnJheSB7XG4gICAgY29uc3QgZGF0YSA9IG5ldyBVaW50MzJBcnJheSh0aGlzLl93aWR0aCAqIGhlaWdodCk7XG4gICAgY29uc3QgbWluID0gdGhpcy5fd2lkdGggKiBNYXRoLm1pbihoZWlnaHQsIHRoaXMuX2hlaWdodCk7XG4gICAgZGF0YS5zdWJhcnJheSgwLCBtaW4pLnNldChhcnIuc3ViYXJyYXkoMCwgbWluKSk7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBnZXQgd2lkdGgoKSB7IHJldHVybiB0aGlzLl93aWR0aDsgfVxuICBzZXQgd2lkdGgod2lkdGg6IG51bWJlcikge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5sYXllcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMubGF5ZXJzW2ldID0gdGhpcy5yZXNpemVXaWR0aCh0aGlzLmxheWVyc1tpXSwgd2lkdGgpO1xuICAgIH1cbiAgICB0aGlzLl93aWR0aCA9IHdpZHRoO1xuICAgIHRoaXMuY2FudmFzLndpZHRoID0gd2lkdGg7XG4gIH1cblxuICBnZXQgaGVpZ2h0KCkgeyByZXR1cm4gdGhpcy5faGVpZ2h0OyB9XG4gIHNldCBoZWlnaHQoaGVpZ2h0OiBudW1iZXIpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubGF5ZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLmxheWVyc1tpXSA9IHRoaXMucmVzaXplSGVpZ2h0KHRoaXMubGF5ZXJzW2ldLCBoZWlnaHQpO1xuICAgIH1cbiAgICB0aGlzLl9oZWlnaHQgPSBoZWlnaHQ7XG4gICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICB9XG5cbiAgZ2V0IG1pblgoKSB7IHJldHVybiB0aGlzLl9taW5YOyB9XG4gIGdldCBtYXhYKCkgeyByZXR1cm4gdGhpcy5fbWF4WDsgfVxuICBnZXQgbWluWSgpIHsgcmV0dXJuIHRoaXMuX21pblk7IH1cbiAgZ2V0IG1heFkoKSB7IHJldHVybiB0aGlzLl9tYXhZOyB9XG5cbiAgZmlsbChjb2xvcjogbnVtYmVyKSB7XG4gICAgdGhpcy5kYXRhLmZpbGwoY29sb3IpO1xuICB9XG5cbiAgY2xlYXIoYmFja2dyb3VuZD86IG51bWJlcikge1xuICAgIGNvbnN0IGZpbGxDb2xvciA9IGJhY2tncm91bmQgIT0gbnVsbCA/IHRoaXMucGFsZXR0ZXNbYmFja2dyb3VuZCA8PCAyXSA6IDA7XG4gICAgdGhpcy5fbWluWCA9IHRoaXMuX21pblkgPSBJbmZpbml0eTtcbiAgICB0aGlzLl9tYXhYID0gdGhpcy5fbWF4WSA9IC1JbmZpbml0eTtcbiAgICB0aGlzLmxheWVyc1swXS5maWxsKGZpbGxDb2xvcik7XG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCB0aGlzLmxheWVycy5sZW5ndGg7IGkrKykge1xuICAgICAgdGhpcy5sYXllcnNbaV0uZmlsbCgwKTtcbiAgICB9XG4gIH1cblxuICB0b0RhdGFVcmwoY3JvcFRvQ29udGVudDogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgLy8gVE9ETyAtIGhvdyB0byBjcm9wIHRvIGNvbnRlbnQ/ICBnZXQgYSBkYXRhIHVybCBmb3Igc3Vic2V0P1xuICAgIC8vIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM0MjQyMTU1L2hvdy10by1jcm9wLWNhbnZhcy10b2RhdGF1cmxcbiAgICByZXR1cm4gdGhpcy5jYW52YXMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBsZXQgY2FudmFzID0gdGhpcy5jYW52YXM7XG4gICAgbGV0IGN0eCA9IHRoaXMuY3R4O1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5sYXllcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChpKSB7XG4gICAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgICBjYW52YXMud2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aDtcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IHRoaXMuY2FudmFzLmhlaWdodDtcbiAgICAgICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJykgfHwgZGllKCk7XG4gICAgICB9XG4gICAgICBjb25zdCB1aW50OCA9IG5ldyBVaW50OEFycmF5KHRoaXMubGF5ZXJzW2ldLmJ1ZmZlcik7XG4gICAgICBjb25zdCBkYXRhID0gY3R4LmdldEltYWdlRGF0YSgwLCAwLCB0aGlzLl93aWR0aCwgdGhpcy5faGVpZ2h0KTtcbiAgICAgIGRhdGEuZGF0YS5zZXQodWludDgpO1xuICAgICAgY3R4LnB1dEltYWdlRGF0YShkYXRhLCAwLCAwKTtcbiAgICAgIGlmIChpKSB0aGlzLmN0eC5kcmF3SW1hZ2UoY2FudmFzLCAwLCAwKTtcbiAgICB9ICAgICAgICBcbiAgfVxuXG4gIHJlY3QoeTogbnVtYmVyLCB4OiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBjb2xvcjogbnVtYmVyKSB7XG4gICAgY29uc3QgeTAgPSBNYXRoLm1heCgwLCB5KTtcbiAgICBjb25zdCB4MCA9IE1hdGgubWF4KDAsIHgpO1xuICAgIGNvbnN0IHkxID0gTWF0aC5taW4odGhpcy5faGVpZ2h0LCB5ICsgaGVpZ2h0KTtcbiAgICBjb25zdCB4MSA9IE1hdGgubWluKHRoaXMuX3dpZHRoLCB4ICsgd2lkdGgpO1xuICAgIGZvciAoeSA9IHkwOyB5IDwgeTE7IHkrKykge1xuICAgICAgZm9yICh4ID0geDA7IHggPCB4MTsgeCsrKSB7XG4gICAgICAgIHRoaXMuZGF0YVt5ICogdGhpcy5fd2lkdGggKyB4XSA9IGNvbG9yO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIGF0dHIgPSBwYWxldHRlIDw8IDIgfCB2ZmxpcCA8PCAxIHwgaGZsaXBcbiAgdGlsZSh5OiBudW1iZXIsIHg6IG51bWJlciwgaWQ6IG51bWJlciwgYXR0cjogbnVtYmVyKSB7XG4gICAgaWYgKHggPCAwIHx8IHkgPCAwIHx8IHggKyA4ID49IHRoaXMuX3dpZHRoIHx8IHkgKyA4ID49IHRoaXMuX2hlaWdodCkgcmV0dXJuO1xuICAgIGNvbnN0IHBhdCA9IHRoaXMucm9tLnBhdHRlcm5zW2lkXS5mbGlwKGF0dHIgPDwgNik7XG4gICAgZm9yIChsZXQgciA9IDA7IHIgPCA4OyByKyspIHtcbiAgICAgIGxldCBoaSA9IHBhdC5waXhlbHNbOCB8IHJdIDw8IDE7XG4gICAgICBsZXQgbG8gPSBwYXQucGl4ZWxzW3JdO1xuICAgICAgZm9yIChsZXQgYyA9IDc7IGMgPj0gMDsgYy0tKSB7XG4gICAgICAgIGNvbnN0IHogPSBoaSAmIDIgfCBsbyAmIDE7XG4gICAgICAgIGhpID4+Pj0gMTsgbG8gPj4+PSAxO1xuICAgICAgICBpZiAoeikge1xuICAgICAgICAgIHRoaXMuZGF0YVsoeSArIHIpICogdGhpcy5fd2lkdGggKyB4ICsgY10gPVxuICAgICAgICAgICAgICB0aGlzLnBhbGV0dGVzW2F0dHIgJiAweDNmYyB8IHpdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX21pblggPSBNYXRoLm1pbih0aGlzLl9taW5YLCB4KTtcbiAgICB0aGlzLl9tYXhYID0gTWF0aC5tYXgodGhpcy5fbWF4WCwgeCArIDgpO1xuICAgIHRoaXMuX21pblkgPSBNYXRoLm1pbih0aGlzLl9taW5ZLCB5KTtcbiAgICB0aGlzLl9tYXhZID0gTWF0aC5tYXgodGhpcy5fbWF4WSwgeSArIDgpO1xuICB9XG5cbiAgbWV0YXRpbGUoeTogbnVtYmVyLCB4OiBudW1iZXIsIGlkOiBudW1iZXIsIGxvY2lkOiBudW1iZXIsIGZyYW1lID0gMCkge1xuICAgIGNvbnN0IGxvYyA9IHRoaXMucm9tLmxvY2F0aW9uc1tsb2NpZF07XG4gICAgY29uc3QgcGF0dGVybnMgPSBbLi4ubG9jLnRpbGVQYXR0ZXJuc107XG4gICAgaWYgKGxvYy5hbmltYXRpb24pIHtcbiAgICAgIC8vIE5PVEU6IFRoaXMgd2lsbCBhdXRvbWF0aWNhbGx5IHRha2UgY2FyZSBvZiBjb3JydXB0ZWQgZGVzZXJ0IGdyYXBoY2lzXG4gICAgICBwYXR0ZXJuc1sxXSA9IHRoaXMucm9tLnRpbGVBbmltYXRpb25zW2xvYy5hbmltYXRpb25dLnBhZ2VzW2ZyYW1lICYgN107XG4gICAgfVxuICAgIGNvbnN0IHBhbGV0dGVzID0gWy4uLmxvYy50aWxlUGFsZXR0ZXMsIDB4N2ZdO1xuICAgIGNvbnN0IHRpbGVzZXQgPSB0aGlzLnJvbS50aWxlc2V0c1sobG9jLnRpbGVzZXQgJiAweDdmKSA+Pj4gMl07XG4gICAgY29uc3QgcGFsZXR0ZSA9IHBhbGV0dGVzW3RpbGVzZXQuYXR0cnNbaWRdXTtcbiAgICBmb3IgKGxldCByID0gMDsgciA8IDI7IHIrKykge1xuICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCAyOyBjKyspIHtcbiAgICAgICAgY29uc3QgdGlsZSA9IHRpbGVzZXQudGlsZXNbciA8PCAxIHwgY11baWRdO1xuICAgICAgICBjb25zdCBwYXR0ZXJuID0gcGF0dGVybnNbdGlsZSAmIDB4ODAgPyAxIDogMF0gPDwgNiB8IHRpbGUgJiAweDdmO1xuICAgICAgICBjb25zdCB4MSA9IHggKyAoYyA8PCAzKTtcbiAgICAgICAgY29uc3QgeTEgPSB5ICsgKHIgPDwgMyk7XG4gICAgICAgIHRoaXMudGlsZSh5MSwgeDEsIHBhdHRlcm4sIHBhbGV0dGUgPDwgMik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSBvZmZzZXQgdXN1YWxseSAwIG9yIDB4NDAsIGJ1dCBzb21ldGltZXMgaXMgYSBvbmUtb2ZmLlxuICAgKiBAcGFyYW0gZnJhbWUgYW5pbWF0aW9uIGZyYW1lLlxuICAgKi9cbiAgbWV0YXNwcml0ZSh5OiBudW1iZXIsIHg6IG51bWJlciwgaWQ6IG51bWJlciwgbG9jaWQ6IG51bWJlcixcbiAgICAgICAgICAgICBvZmZzZXQgPSAwLCBmcmFtZSA9IDApIHtcbiAgICBjb25zdCBsb2MgPSB0aGlzLnJvbS5sb2NhdGlvbnNbbG9jaWRdO1xuICAgIGxldCBtZXRhc3ByaXRlID0gdGhpcy5yb20ubWV0YXNwcml0ZXNbaWRdO1xuICAgIC8vIE5PVEU6IHRoaXMgaXMgc3dvcmQgb2Ygd2luZCAtIGVsc2UgcGF0WzFdIGFuZCBwYWxbMV0gZ2V0ICsxLDIsMyBhZGRlZFxuICAgIGNvbnN0IHBhdHRlcm5zID0gWzB4NDAsIDB4NDIsIC4uLmxvYy5zcHJpdGVQYXR0ZXJuc107XG4gICAgY29uc3QgcGFsZXR0ZXMgPSBbMCwgMSwgLi4ubG9jLnNwcml0ZVBhbGV0dGVzXTtcbiAgICBsZXQgbWlycm9yZWQgPSBmYWxzZTtcbiAgICBpZiAobWV0YXNwcml0ZS5taXJyb3JlZCAhPSBudWxsKSB7XG4gICAgICBtZXRhc3ByaXRlID0gdGhpcy5yb20ubWV0YXNwcml0ZXNbbWV0YXNwcml0ZS5taXJyb3JlZF07XG4gICAgICBtaXJyb3JlZCA9IHRydWU7XG4gICAgfVxuICAgIGlmICghbWV0YXNwcml0ZSB8fCAhbWV0YXNwcml0ZS51c2VkKSByZXR1cm47XG4gICAgY29uc3QgdmVyc2lvbiA9IGZyYW1lICYgbWV0YXNwcml0ZS5mcmFtZU1hc2s7XG4gICAgZm9yIChsZXQgW2R4LCBkeSwgYXR0ciwgdGlsZV0gb2YgbWV0YXNwcml0ZS5zcHJpdGVzW3ZlcnNpb25dKSB7XG4gICAgICAvLyAgYmVjb21lcyBhdHRyIGJ5dGUsIG1heWJlIHdpdGggIyQyMCAocHJpb3JpdHkpIE9SZWQgaW5cbiAgICAgIGlmIChkeCA9PSAweDgwKSBicmVhaztcbiAgICAgIGR4ID0gc2lnbmVkKGR4KTtcbiAgICAgIGR5ID0gc2lnbmVkKGR5KTtcbiAgICAgIHRpbGUgPSAodGlsZSArIG9mZnNldCkgJiAweGZmO1xuICAgICAgY29uc3QgcGF0dGVyblBhZ2UgPSBwYXR0ZXJuc1t0aWxlID4+IDZdO1xuICAgICAgY29uc3QgcGFsZXR0ZSA9IChwYWxldHRlc1thdHRyICYgM10gKyAweGIwKSAmIDB4ZmY7XG4gICAgICBjb25zdCBwYXR0ZXJuID0gcGF0dGVyblBhZ2UgPDwgNiB8IHRpbGUgJiAweDNmO1xuICAgICAgaWYgKG1pcnJvcmVkKSB7XG4gICAgICAgIGR4ID0gLTggLSBkeDtcbiAgICAgICAgYXR0ciBePSAweDQwO1xuICAgICAgfVxuICAgICAgdGhpcy50aWxlKHkgKyBkeSwgeCArIGR4LCBwYXR0ZXJuLCBwYWxldHRlIDw8IDIgfCBhdHRyID4+IDYpO1xuICAgIH1cbiAgfVxuXG4gIHRleHQoeTogbnVtYmVyLCB4OiBudW1iZXIsIHRleHQ6IHN0cmluZywgcGFsZXR0ZSA9IDB4MTIpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRleHQubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMudGlsZShcbiAgICAgICAgICB5LCB4ICsgOCAqIGksIHRleHQuY2hhckNvZGVBdChpKSB8IDB4ZjAwLCBwYWxldHRlIDw8IDIpO1xuICAgIH0gICAgICAgICAgICBcbiAgfVxufVxuXG5jb25zdCBDT0xPUlMgPSBbXG4gIDB4NTI1MjUyLCAweEI0MDAwMCwgMHhBMDAwMDAsIDB4QjEwMDNELCAweDc0MDA2OSwgMHgwMDAwNUIsIDB4MDAwMDVGLCAweDAwMTg0MCxcbiAgMHgwMDJGMTAsIDB4MDg0QTA4LCAweDAwNjcwMCwgMHgxMjQyMDAsIDB4NkQyODAwLCAweDAwMDAwMCwgMHgwMDAwMDAsIDB4MDAwMDAwLFxuICAweEM0RDVFNywgMHhGRjQwMDAsIDB4REMwRTIyLCAweEZGNDc2QiwgMHhENzAwOUYsIDB4NjgwQUQ3LCAweDAwMTlCQywgMHgwMDU0QjEsXG4gIDB4MDA2QTVCLCAweDAwOEMwMywgMHgwMEFCMDAsIDB4MkM4ODAwLCAweEE0NzIwMCwgMHgwMDAwMDAsIDB4MDAwMDAwLCAweDAwMDAwMCxcbiAgMHhGOEY4RjgsIDB4RkZBQjNDLCAweEZGNzk4MSwgMHhGRjVCQzUsIDB4RkY0OEYyLCAweERGNDlGRiwgMHg0NzZERkYsIDB4MDBCNEY3LFxuICAweDAwRTBGRiwgMHgwMEUzNzUsIDB4MDNGNDJCLCAweDc4QjgyRSwgMHhFNUUyMTgsIDB4Nzg3ODc4LCAweDAwMDAwMCwgMHgwMDAwMDAsXG4gIDB4RkZGRkZGLCAweEZGRjJCRSwgMHhGOEI4QjgsIDB4RjhCOEQ4LCAweEZGQjZGRiwgMHhGRkMzRkYsIDB4QzdEMUZGLCAweDlBREFGRixcbiAgMHg4OEVERjgsIDB4ODNGRkRELCAweEI4RjhCOCwgMHhGNUY4QUMsIDB4RkZGRkIwLCAweEY4RDhGOCwgMHgwMDAwMDAsIDB4MDAwMDAwLFxuXTtcblxuZnVuY3Rpb24gc2lnbmVkKHg6IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiB4IDwgMHg4MCA/IHggOiB4IC0gMHgxMDA7XG59XG4iXX0=