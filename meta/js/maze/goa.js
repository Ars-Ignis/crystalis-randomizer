import { Maze } from './maze.js';
import { GOA1_SCREENS, write2d } from './spec.js';
import { Dir } from './types.js';
import { Flag } from '../rom/location.js';
import { hex } from '../rom/util.js';
import { Monster } from '../rom/monster.js';
export function shuffleGoa1(rom, random, attempts = 1500) {
    extendGoaScreens(rom);
    const loc = rom.locations.GoaFortress_Kelbesque;
    const w = loc.width;
    const h = loc.height;
    OUTER: for (let attempt = 0; attempt < attempts; attempt++) {
        const maze = new Maze(random, h, w, GOA1_SCREENS);
        const entrance = ((h - 1) << 4 | random.nextInt(w));
        const boss = random.nextInt(w);
        const entranceTile = entrance << 8 | 0x02;
        const exitTiles = [(boss + 32) << 8 | 0x01, (boss + 32) << 8 | 0x03];
        function fixed(pos, value) {
            maze.set(pos, value, { force: true });
        }
        fixed(entrance, 0xf0f1);
        fixed(entrance - 1, 0x00f0);
        fixed(entrance + 1, 0xf000);
        fixed(boss, 0xfff0);
        fixed(boss - 1, 0x0ff0);
        fixed(boss + 1, 0xff00);
        fixed(boss + 16, 0xf1ff);
        fixed(boss + 15, 0x00ff);
        fixed(boss + 17, 0xf00f);
        if (!maze.connect(entrance, Dir.UP, boss + 16, Dir.DOWN)) {
            continue OUTER;
        }
        if (maze.get((boss + 32)) === 0x0101 ||
            maze.get((entrance - 16)) === 0x0101)
            continue OUTER;
        for (let i = 0; i < 10 && maze.density() < 0.65; i++) {
            if (maze.addLoop())
                i = 0;
        }
        if (maze.density() < 0.45)
            continue OUTER;
        if (!check())
            continue OUTER;
        for (const [pos, scr] of maze) {
            if (scr === 0x0101 && maze.get((pos + 16)) === 0x0101) {
                const order = random.shuffle([0, 16]);
                if (!tryFlag((pos + order[0]), 131072) &&
                    !tryFlag((pos + order[1]), 131072)) {
                    continue OUTER;
                }
            }
        }
        for (const [pos, alt] of random.shuffle([...maze.alternates()])) {
            tryFlag(pos, alt);
        }
        maze.fillAll({ edge: 0 });
        function check() {
            const traversal = maze.traverse();
            const main = traversal.get(entranceTile);
            if (!main)
                return false;
            if (!exitTiles.filter(t => main.has(t)).length)
                return false;
            if (main.size < 0.8 * traversal.size)
                return false;
            return true;
        }
        function tryFlag(pos, mod = 65536) {
            const prev = maze.get(pos);
            if (prev == null)
                throw new Error(`Cannot flag empty screen ${hex(pos)}`);
            maze.replace(pos, (prev | mod));
            if (check())
                return true;
            maze.replace(pos, prev);
            return false;
        }
        loc.moveScreen(0x06, boss);
        loc.moveScreen(0x83, entrance);
        maze.write(loc, new Set());
        const monsterPlacer = loc.monsterPlacer(random);
        for (const spawn of loc.spawns) {
            if (!spawn.isMonster())
                continue;
            const monster = rom.objects[spawn.monsterId];
            if (!(monster instanceof Monster))
                continue;
            const pos = monsterPlacer(monster);
            if (pos == null) {
                console.error(`no valid location for ${hex(monster.id)} in ${hex(loc.id)}`);
                spawn.used = false;
                continue;
            }
            else {
                spawn.screen = pos >>> 8;
                spawn.tile = pos & 0xff;
            }
        }
        if (rom.spoiler)
            rom.spoiler.addMaze(loc.id, loc.name, maze.show());
        return;
    }
    throw new Error(`unable to shuffle goa1 after ${attempts} attempts`);
}
export function extendGoaScreens(rom) {
    for (const t of [0x8c, 0xa4, 0xa8]) {
        const ts = rom.tilesets[t];
        ts.alternates[0x19] = 0x19;
        ts.alternates[0x1b] = 0x1b;
    }
    rom.swapMetatiles([0xa4, 0x8c], [0x2b, [0x19, 0xc5], ~0xc6], [0xba, [0x1b, 0xc5], ~0xc4]);
    rom.swapMetatiles([0xa8], [[0x17, 0x54], ~0x19], [[0x18, 0x58], ~0x1b]);
    rom.swapMetatiles([0x88], [0x19, ~0xc5], [0x1b, ~0xc5]);
    const w = [[0x19, 0x19], [0x1b, 0x1b]];
    write2d(rom.screens[0xe0].tiles, 0x61, w);
    write2d(rom.screens[0xe1].tiles, 0x6d, w);
    write2d(rom.screens[0xe2].tiles, 0x91, w);
    write2d(rom.screens[0xe3].tiles, 0x9d, w);
    write2d(rom.screens[0xe4].tiles, 0x41, w);
    write2d(rom.screens[0xe4].tiles, 0x8d, w);
    write2d(rom.screens[0xe5].tiles, 0x61, w);
    write2d(rom.screens[0xe5].tiles, 0xad, w);
    write2d(rom.screens[0xe6].tiles, 0x0d, w);
    write2d(rom.screens[0xe6].tiles, 0xd1, w);
    write2d(rom.screens[0xe7].tiles, 0x01, w);
    write2d(rom.screens[0xe7].tiles, 0x0d, w);
    write2d(rom.screens[0xe8].tiles, 0xd1, w);
    write2d(rom.screens[0xe8].tiles, 0xdd, w);
    rom.locations[0xa9].flags.push(Flag.of({ screen: 0x10, flag: 0x2ef }), Flag.of({ screen: 0x20, flag: 0x2ef }), Flag.of({ screen: 0x21, flag: 0x2ef }), Flag.of({ screen: 0x24, flag: 0x2ef }), Flag.of({ screen: 0x25, flag: 0x2ef }), Flag.of({ screen: 0x30, flag: 0x2ef }), Flag.of({ screen: 0x31, flag: 0x2ef }), Flag.of({ screen: 0x33, flag: 0x2ef }), Flag.of({ screen: 0x34, flag: 0x2ef }), Flag.of({ screen: 0x41, flag: 0x2ef }), Flag.of({ screen: 0x54, flag: 0x2ef }), Flag.of({ screen: 0x62, flag: 0x2ef }), Flag.of({ screen: 0x64, flag: 0x2ef }), Flag.of({ screen: 0x72, flag: 0x2ef }), Flag.of({ screen: 0x74, flag: 0x200 }));
    rom.locations.WaterfallCave3.tileset = 0x88;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL21hemUvZ29hLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDL0IsT0FBTyxFQUFDLFlBQVksRUFBRSxPQUFPLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDaEQsT0FBTyxFQUFDLEdBQUcsRUFBVyxNQUFNLFlBQVksQ0FBQztBQUd6QyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDeEMsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUUxQyxNQUFNLFVBQVUsV0FBVyxDQUFDLEdBQVEsRUFBRSxNQUFjLEVBQUUsUUFBUSxHQUFHLElBQUk7SUFFbkUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdEIsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxxQkFBcUIsQ0FBQztJQUNoRCxNQUFNLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO0lBQ3BCLE1BQU0sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFJckIsS0FBSyxFQUNMLEtBQUssSUFBSSxPQUFPLEdBQUcsQ0FBQyxFQUFFLE9BQU8sR0FBRyxRQUFRLEVBQUUsT0FBTyxFQUFFLEVBQUU7UUFDbkQsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFHbEQsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBUSxDQUFDO1FBQzNELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxP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akMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBVSxDQUFDO0lBQ2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQVExQyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQzFCLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUNwQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLENBQUMsQ0FBQztJQUsxQyxHQUFHLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0FBQzlDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01hemV9IGZyb20gJy4vbWF6ZS5qcyc7XG5pbXBvcnQge0dPQTFfU0NSRUVOUywgd3JpdGUyZH0gZnJvbSAnLi9zcGVjLmpzJztcbmltcG9ydCB7RGlyLCBQb3MsIFNjcn0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQge1JhbmRvbX0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtGbGFnfSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHtoZXh9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7TW9uc3Rlcn0gZnJvbSAnLi4vcm9tL21vbnN0ZXIuanMnO1xuXG5leHBvcnQgZnVuY3Rpb24gc2h1ZmZsZUdvYTEocm9tOiBSb20sIHJhbmRvbTogUmFuZG9tLCBhdHRlbXB0cyA9IDE1MDApOiB2b2lkIHtcbiAgLy8gTk9URTogYWxzbyBuZWVkIHRvIG1vdmUgZW5lbWllcy4uLlxuICBleHRlbmRHb2FTY3JlZW5zKHJvbSk7XG4gIGNvbnN0IGxvYyA9IHJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2VsYmVzcXVlO1xuICBjb25zdCB3ID0gbG9jLndpZHRoO1xuICBjb25zdCBoID0gbG9jLmhlaWdodDtcblxuICAvLyBUT0RPIC0gY29uc2lkZXIgYmlnZ2VyIGljb25zPyAn4pSY4pWR4pSUXFxu4pWQ4pWs4pWQXFxu4pSQ4pWR4pSMJyBvciAn4pSY4pSD4pSUXFxu4pSB4pWL4pSBXFxu4pSQ4pSD4pSMJyA/P1xuXG4gIE9VVEVSOlxuICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8IGF0dGVtcHRzOyBhdHRlbXB0KyspIHtcbiAgICBjb25zdCBtYXplID0gbmV3IE1hemUocmFuZG9tLCBoLCB3LCBHT0ExX1NDUkVFTlMpO1xuXG4gICAgLy8gUGxhY2UgdGhlIGVudHJhbmNlIGF0IHRoZSBib3R0b20sIGJvc3MgYXQgdG9wLlxuICAgIGNvbnN0IGVudHJhbmNlID0gKChoIC0gMSkgPDwgNCB8IHJhbmRvbS5uZXh0SW50KHcpKSBhcyBQb3M7XG4gICAgY29uc3QgYm9zcyA9IHJhbmRvbS5uZXh0SW50KHcpIGFzIFBvcztcblxuICAgIGNvbnN0IGVudHJhbmNlVGlsZSA9IGVudHJhbmNlIDw8IDggfCAweDAyO1xuICAgIGNvbnN0IGV4aXRUaWxlcyA9IFsoYm9zcyArIDMyKSA8PCA4IHwgMHgwMSwgKGJvc3MgKyAzMikgPDwgOCB8IDB4MDNdO1xuXG4gICAgZnVuY3Rpb24gZml4ZWQocG9zOiBudW1iZXIsIHZhbHVlOiBudW1iZXIpIHtcbiAgICAgIG1hemUuc2V0KHBvcyBhcyBQb3MsIHZhbHVlIGFzIFNjciwge2ZvcmNlOiB0cnVlfSk7IC8vIE5PVEU6IG5vIGNoZWNrIE9PQlxuICAgIH1cblxuICAgIGZpeGVkKGVudHJhbmNlLCAweGYwZjEpO1xuICAgIGZpeGVkKGVudHJhbmNlIC0gMSwgMHgwMGYwKTtcbiAgICBmaXhlZChlbnRyYW5jZSArIDEsIDB4ZjAwMCk7XG4gICAgZml4ZWQoYm9zcywgMHhmZmYwKTtcbiAgICBmaXhlZChib3NzIC0gMSwgMHgwZmYwKTtcbiAgICBmaXhlZChib3NzICsgMSwgMHhmZjAwKTtcbiAgICBmaXhlZChib3NzICsgMTYsIDB4ZjFmZik7XG4gICAgZml4ZWQoYm9zcyArIDE1LCAweDAwZmYpO1xuICAgIGZpeGVkKGJvc3MgKyAxNywgMHhmMDBmKTtcblxuICAgIC8vIGNvbnNvbGUubG9nKGBpbml0aWFsXFxuJHttYXplLnNob3coKX1gKTtcblxuICAgIC8vIG1ha2UgdGhlIGluaXRpYWwgcGF0aCBmcm9tIHRoZSBlbnRyYW5jZSB0byB0aGUgYm9zc1xuICAgIGlmICghbWF6ZS5jb25uZWN0KGVudHJhbmNlIGFzIFBvcywgRGlyLlVQLCBib3NzICsgMTYgYXMgUG9zLCBEaXIuRE9XTikpIHtcbiAgICAgIGNvbnRpbnVlIE9VVEVSO1xuICAgIH1cbiAgICAvLyBkb24ndCBhbGxvdyBhIGRpcmVjdCBmb3J3YXJkIGVudHJhbmNlXG4gICAgaWYgKG1hemUuZ2V0KChib3NzICsgMzIpIGFzIFBvcykgPT09IDB4MDEwMSB8fFxuICAgICAgICBtYXplLmdldCgoZW50cmFuY2UgLSAxNikgYXMgUG9zKSA9PT0gMHgwMTAxKSBjb250aW51ZSBPVVRFUjtcbiAgICAvL2NvbnNvbGUubG9nKCdmaXJzdCcsIG1hemUuc2hvdygpKTtcblxuICAgIC8vIGFkZCBhbiBleHRyYSBwYXRoIHVudGlsIHdlIGZhaWwgMTAgdGltZXNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwICYmIG1hemUuZGVuc2l0eSgpIDwgMC42NTsgaSsrKSB7XG4gICAgICBpZiAobWF6ZS5hZGRMb29wKCkpIGkgPSAwO1xuICAgIH1cbiAgICAvL2NvbnNvbGUubG9nKGBsb29wXFxuJHttYXplLnNob3coKX1gKTtcblxuICAgIC8vIEVuc3VyZSBhIG1pbmltdW0gZGVuc2l0eVxuICAgIGlmIChtYXplLmRlbnNpdHkoKSA8IDAuNDUpIGNvbnRpbnVlIE9VVEVSO1xuXG4gICAgLy8gTm93IHN0YXJ0IGFkZGluZyB3YWxscyBhbmQgZW5zdXJlIHRoZSBtYXplIGlzIGNvbXBsZXRlYWJsZS5cbiAgICAvLyBJbiBwYXJ0aWN1bGFyLCB3ZSBuZWVkIHRvIGNvbnZlcnQgc29tZSBvZiB0aGUgdmVydGljYWwgaGFsbHdheXNcbiAgICAvLyBpbnRvIGVpdGhlciBzdGFpcndheXMgb3IgZGVhZCBlbmRzLlxuICAgIC8vIFRoZSBiYXNpYyBzdHJhdGVneSBhdCB0aGlzIHBvaW50IGlzIHRvIG1ha2UgdGhlIG1hcCBhcyBvcGVuIGFzXG4gICAgLy8gcG9zc2libGUsIGNvdW50IHRoZSBudW1iZXIgb2YgcmVhY2hhYmxlIHRpbGVzLCBhbmQgdGhlbiBhZGRcbiAgICAvLyB3YWxscyB1bnRpbCB3ZSBjYW4ndCBkbyBzbyBhbnkgbW9yZSB3aXRob3V0IG1ha2luZyBzb21lXG4gICAgLy8gcHJldmlvdXNseS1yZWFjaGFibGUgdGlsZSB1bnJlYWNoYWJsZS4gIEF0IHRoYXQgcG9pbnQsIHRyeSBldmVyeVxuICAgIC8vIHdhbGwgb25jZSBtb3JlIGFuZCB0aGVuIHF1aXQuXG5cbiAgICBpZiAoIWNoZWNrKCkpIGNvbnRpbnVlIE9VVEVSO1xuXG4gICAgLy8gRmluZCBhbnkgdmVydGljYWxseS1hZGphY2VudCAwMTAxIGFuZCB0cnkgdG8gbWFrZSB0aGVtIGludG8gMjAxMDFcbiAgICBmb3IgKGNvbnN0IFtwb3MsIHNjcl0gb2YgbWF6ZSkge1xuICAgICAgaWYgKHNjciA9PT0gMHgwMTAxICYmIG1hemUuZ2V0KChwb3MgKyAxNikgYXMgUG9zKSA9PT0gMHgwMTAxKSB7XG4gICAgICAgIGNvbnN0IG9yZGVyID0gcmFuZG9tLnNodWZmbGUoWzAsIDE2XSk7XG4gICAgICAgIGlmICghdHJ5RmxhZygocG9zICsgb3JkZXJbMF0pIGFzIFBvcywgMHgyXzAwMDApICYmXG4gICAgICAgICAgICAhdHJ5RmxhZygocG9zICsgb3JkZXJbMV0pIGFzIFBvcywgMHgyXzAwMDApKSB7XG4gICAgICAgICAgY29udGludWUgT1VURVI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBUcnkgYWxsIHBvc3NpYmxlIGFsdGVybmF0ZXMsIHNraXBwaW5nIGFueSB0aGF0IGRvbid0IHdvcmsuXG4gICAgLy8gVE9ETyAtIGlzIGl0IGV2ZXIgcG9zc2libGUgdGhhdCBjb21pbmcgYmFjayB0byBvbmUgbGF0ZXIgX3dpbGxfIHdvcms/XG4gICAgLy8gICAgICAtLS0+IG1heWJlLCBkZXBlbmRpbmcgb24gaG93IHRoZXkncmUgYXJyYW5nZWQuICBJbiBvdXIgY2FzZSxcbiAgICAvLyAgICAgICAgICAgMDEwMSA9PiAxMjM5YWI7IDEwMTAxID0+IDEyYWI7IDIwMTAxID0+IDEzOWI7IDMwMTAxID0+IDM5XG4gICAgLy8gICAgICAgICAgIHNvIDAgLT4gMSAtPiAzIE1JR0hUIG9wZW4gYSBwYXRoLCBidXQgMiBzaG91bGQgaGF2ZSBwYXNzZWQuLi4/XG5cbiAgICBmb3IgKGNvbnN0IFtwb3MsIGFsdF0gb2YgcmFuZG9tLnNodWZmbGUoWy4uLm1hemUuYWx0ZXJuYXRlcygpXSkpIHtcbiAgICAgIHRyeUZsYWcocG9zLCBhbHQpO1xuICAgIH1cblxuICAgIG1hemUuZmlsbEFsbCh7ZWRnZTogMH0pO1xuXG4gICAgZnVuY3Rpb24gY2hlY2soKTogYm9vbGVhbiB7XG4gICAgICBjb25zdCB0cmF2ZXJzYWwgPSBtYXplLnRyYXZlcnNlKCk7XG4gICAgICAvLyh3aW5kb3cgYXMgYW55KS5UUkFWID0gdHJhdmVyc2FsO1xuXG4gICAgICBjb25zdCBtYWluID0gdHJhdmVyc2FsLmdldChlbnRyYW5jZVRpbGUpO1xuICAgICAgaWYgKCFtYWluKSByZXR1cm4gZmFsc2U7XG4gICAgICBpZiAoIWV4aXRUaWxlcy5maWx0ZXIodCA9PiBtYWluLmhhcyh0KSkubGVuZ3RoKSByZXR1cm4gZmFsc2U7XG4gICAgICBpZiAobWFpbi5zaXplIDwgMC44ICogdHJhdmVyc2FsLnNpemUpIHJldHVybiBmYWxzZTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHRyeUZsYWcocG9zOiBQb3MsIG1vZCA9IDB4MV8wMDAwKTogYm9vbGVhbiB7XG4gICAgICBjb25zdCBwcmV2ID0gbWF6ZS5nZXQocG9zKTtcbiAgICAgIGlmIChwcmV2ID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZsYWcgZW1wdHkgc2NyZWVuICR7aGV4KHBvcyl9YCk7XG4gICAgICBtYXplLnJlcGxhY2UocG9zLCAocHJldiB8IG1vZCkgYXMgU2NyKTtcbiAgICAgIGlmIChjaGVjaygpKSByZXR1cm4gdHJ1ZTtcbiAgICAgIG1hemUucmVwbGFjZShwb3MsIHByZXYpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGxvYy5tb3ZlU2NyZWVuKDB4MDYsIGJvc3MpO1xuICAgIGxvYy5tb3ZlU2NyZWVuKDB4ODMsIGVudHJhbmNlKTtcblxuICAgIG1hemUud3JpdGUobG9jLCBuZXcgU2V0KCkpO1xuXG4gICAgY29uc3QgbW9uc3RlclBsYWNlciA9IGxvYy5tb25zdGVyUGxhY2VyKHJhbmRvbSk7XG4gICAgZm9yIChjb25zdCBzcGF3biBvZiBsb2Muc3Bhd25zKSB7XG4gICAgICBpZiAoIXNwYXduLmlzTW9uc3RlcigpKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IG1vbnN0ZXIgPSByb20ub2JqZWN0c1tzcGF3bi5tb25zdGVySWRdO1xuICAgICAgaWYgKCEobW9uc3RlciBpbnN0YW5jZW9mIE1vbnN0ZXIpKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IHBvcyA9IG1vbnN0ZXJQbGFjZXIobW9uc3Rlcik7XG4gICAgICBpZiAocG9zID09IG51bGwpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgbm8gdmFsaWQgbG9jYXRpb24gZm9yICR7aGV4KG1vbnN0ZXIuaWQpfSBpbiAke2hleChsb2MuaWQpfWApO1xuICAgICAgICBzcGF3bi51c2VkID0gZmFsc2U7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3Bhd24uc2NyZWVuID0gcG9zID4+PiA4O1xuICAgICAgICBzcGF3bi50aWxlID0gcG9zICYgMHhmZjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBjb25zb2xlLmxvZyhgc3VjY2VzcyBhZnRlciAke2F0dGVtcHR9IGF0dGVtcHRzYCk7XG4gICAgLy8gY29uc29sZS5sb2cobWF6ZS5zaG93KCkpO1xuICAgIGlmIChyb20uc3BvaWxlcikgcm9tLnNwb2lsZXIuYWRkTWF6ZShsb2MuaWQsIGxvYy5uYW1lLCBtYXplLnNob3coKSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgdGhyb3cgbmV3IEVycm9yKGB1bmFibGUgdG8gc2h1ZmZsZSBnb2ExIGFmdGVyICR7YXR0ZW1wdHN9IGF0dGVtcHRzYCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHRlbmRHb2FTY3JlZW5zKHJvbTogUm9tKSB7XG4gIC8vIFBMQU46XG4gIC8vIHRpbGVzZXQgYTQsOGM6IG1vdmUgMTksMWIgLT4gMmIsYmFcbiAgLy8gdGlsZXNldCBhODogICAgbW92ZSAxOSwxYiAtPiAxNywxOFxuICAvLyB0aWxlc2V0IDg4OiAgICBtb3ZlIGM1IC0+IDE5LDFiXG4gIC8vICAgICAxNywxOCB1c2VkIGluIDg4LCB3aGljaCBzaGFyZXMgYSBsb3Qgd2l0aCBhOCwgYnV0XG4gIC8vICAgICBubyA4OCBtYXBzIGhhdmUgYW55IDE5LDFiIHNvIHRoZXknbGwgbmV2ZXIgc2VlIGNvbmZsaWN0aW5nIDE3LDE4XG4gIC8vIGNoYW5nZSB0aGUgODggdXNlcnMgb2YgZTEsZTIgKGh5ZHJhKSB0byB0aWxlc2V0IGE4IHdpdGggcGF0MT0yYSB0byBhdm9pZFxuICAvLyBjb25mbGljdD8gIHRoZSBjb3N0IGlzIG9uZSB3YWxsIHRoYXQgZG9lc24ndCBmaXQgaW4gcXVpdGUgYXMgd2VsbC5cbiAgLy8gVGhpcyBmcmVlcyB1cCAxOSwxYiB0byBhYnNvcmIgYzYvYzQgd2l0aCBhbHRzIG9mIGM1XG4gIFxuICBmb3IgKGNvbnN0IHQgb2YgWzB4OGMsIDB4YTQsIDB4YThdKSB7IC8vIGdldCBhcm91bmQgY2hlY2tcbiAgICBjb25zdCB0cyA9IHJvbS50aWxlc2V0c1t0XTtcbiAgICB0cy5hbHRlcm5hdGVzWzB4MTldID0gMHgxOTtcbiAgICB0cy5hbHRlcm5hdGVzWzB4MWJdID0gMHgxYjtcbiAgfVxuICByb20uc3dhcE1ldGF0aWxlcyhbMHhhNCwgMHg4Y10sXG4gICAgICAgICAgICAgICAgICAgIFsweDJiLCBbMHgxOSwgMHhjNV0sIH4weGM2XSxcbiAgICAgICAgICAgICAgICAgICAgWzB4YmEsIFsweDFiLCAweGM1XSwgfjB4YzRdKTtcbiAgcm9tLnN3YXBNZXRhdGlsZXMoWzB4YThdLFxuICAgICAgICAgICAgICAgICAgICBbWzB4MTcsIDB4NTRdLCB+MHgxOV0sXG4gICAgICAgICAgICAgICAgICAgIFtbMHgxOCwgMHg1OF0sIH4weDFiXSk7XG4gIHJvbS5zd2FwTWV0YXRpbGVzKFsweDg4XSxcbiAgICAgICAgICAgICAgICAgICAgWzB4MTksIH4weGM1XSxcbiAgICAgICAgICAgICAgICAgICAgWzB4MWIsIH4weGM1XSk7XG5cbiAgLy8gU2NyZWVucyB0aGF0IGNhbiBub3cgYmUgb3BlbmVkIG9yIHNodXQgKCogbWVhbnMgY3VycmVudGx5IHNodXQpOlxuICAvLyAgIGUwLCBlMSosIGUyLCBlMyosIGU0LCBlNSwgZTYsIGU3LCBlOCoqXG4gIC8vIFdlIG5lZWQgdG8gcGljayB3aGljaCB3YWxsKHMpIGFyZSB0b2dnbGVkLi4uXG4gIFxuICAvLyBUT0RPIC0gZmlndXJlIG91dCBuZXcgd2F5IHRvIHJhbmRvbWx5IG11dGF0ZS9mbGFnIGV4aXN0aW5nIHNyZWVuc1xuXG4gIGNvbnN0IHcgPSBbWzB4MTksIDB4MTldLCBbMHgxYiwgMHgxYl1dIGFzIGNvbnN0O1xuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTBdLnRpbGVzLCAweDYxLCB3KTsgLy8gb3BlbiB1cCAod2lkZSksIHJpZ2h0ICh2YW5pbGxhIG9wZW4pXG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlMV0udGlsZXMsIDB4NmQsIHcpOyAvLyBvcGVuIHVwICh3aWRlKSwgbGVmdCAodmFuaWxsYSBzaHV0KVxuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTJdLnRpbGVzLCAweDkxLCB3KTsgLy8gb3BlbiBkb3duICh3aWRlKSwgcmlnaHQgKHZhbmlsbGEgb3BlbilcbiAgd3JpdGUyZChyb20uc2NyZWVuc1sweGUzXS50aWxlcywgMHg5ZCwgdyk7IC8vIG9wZW4gZG93biAod2lkZSksIGxlZnQgKHZhbmlsbGEgc2h1dClcbiAgd3JpdGUyZChyb20uc2NyZWVuc1sweGU0XS50aWxlcywgMHg0MSwgdyk7IC8vIHN0YWlyc1xuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTRdLnRpbGVzLCAweDhkLCB3KTtcbiAgd3JpdGUyZChyb20uc2NyZWVuc1sweGU1XS50aWxlcywgMHg2MSwgdyk7IC8vIGhvcml6b250YWwgd2FsbFxuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTVdLnRpbGVzLCAweGFkLCB3KTtcbiAgd3JpdGUyZChyb20uc2NyZWVuc1sweGU2XS50aWxlcywgMHgwZCwgdyk7IC8vIGZvdXItd2F5IHBhc3NhZ2VzXG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlNl0udGlsZXMsIDB4ZDEsIHcpO1xuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZTddLnRpbGVzLCAweDAxLCB3KTsgLy8gY29ybmVycyB1cCB0b3BcbiAgd3JpdGUyZChyb20uc2NyZWVuc1sweGU3XS50aWxlcywgMHgwZCwgdyk7XG4gIHdyaXRlMmQocm9tLnNjcmVlbnNbMHhlOF0udGlsZXMsIDB4ZDEsIHcpOyAvLyBjb3JuZXJzIG9uIGJvdHRvbVxuICB3cml0ZTJkKHJvbS5zY3JlZW5zWzB4ZThdLnRpbGVzLCAweGRkLCB3KTtcblxuICAvLyBUbyBtYWludGFpbiBjdXJyZW50IGJlaGF2aW9yIHdlIG5lZWQgdG8gcHVzaCBmbGFncyBmb3IgYWxsIHRoZVxuICAvLyBzY3JlZW5zIHRoYXQgbmVlZCB0byBiZSAqb3BlbiouXG5cbiAgLy8gTk9URTogYWZ0ZXIgdGVzdGluZywgb25seSBub3JtYWxseS1vcGVuIHRpbGVzIG5lZWQgZmxhZ3MuLi4/XG4gIC8vICAgLSBqdXN0IG1ha2UgYSBsaXN0IGFuZCBpdGVyYXRlIG92ZXIgXG5cbiAgcm9tLmxvY2F0aW9uc1sweGE5XS5mbGFncy5wdXNoKFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDEwLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDIwLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDIxLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDI0LCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDI1LCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDMwLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDMxLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDMzLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDM0LCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDQxLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDU0LCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDYyLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDY0LCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDcyLCBmbGFnOiAweDJlZn0pLFxuICAgICAgRmxhZy5vZih7c2NyZWVuOiAweDc0LCBmbGFnOiAweDIwMH0pKTtcblxuICAvLyBUaGlzIGRlZmF1bHRzIHRvIGE4LCBidXQgdGhhdCBkb2Vzbid0IHdvcmsgZm9yIHdpZGUgc2NyZWVucy5cbiAgLy8gV2Ugc2hvdWxkIG1ha2Ugc3VyZSB0aGlzIGRvZXNuJ3QgYnJlYWsgcGFydGl0aW9ucyBmb3IgbXVzaWNcbiAgLy8gYW5kL29yIHBhbGV0dGUgc2h1ZmZsZXMuXG4gIHJvbS5sb2NhdGlvbnMuV2F0ZXJmYWxsQ2F2ZTMudGlsZXNldCA9IDB4ODg7XG59XG4iXX0=