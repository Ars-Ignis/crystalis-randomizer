import { featureMask } from './metascreendata.js';
import { DefaultMap } from '../util.js';
export class Metascreen {
    constructor(rom, uid, data) {
        var _a, _b, _c;
        this.rom = rom;
        this.uid = uid;
        this.data = data;
        this._tilesets = new Set();
        this.used = false;
        this.neighbors = [
            new DefaultMap((s) => this._checkNeighbor(s, 0)),
            new DefaultMap((s) => this._checkNeighbor(s, 1)),
        ];
        for (const tileset of Object.values(data.tilesets)) {
            if (!tileset.requires)
                this.used = true;
        }
        let features = 0;
        for (const feature of (_a = data.feature) !== null && _a !== void 0 ? _a : []) {
            const mask = featureMask[feature];
            if (mask != null)
                features |= mask;
        }
        for (const exit of (_b = data.exits) !== null && _b !== void 0 ? _b : []) {
            if (exit.type === 'stair:down' || exit.type === 'stair:up') {
                features |= featureMask[exit.type];
            }
        }
        this._features = features;
        this.flag = data.flag;
        const cxn = [[[]], [[]], [[]], [[]]];
        this.connections = cxn;
        for (let i = 0; i < 3; i++) {
            for (const term of (_c = this.data.connect) !== null && _c !== void 0 ? _c : '') {
                if (connectionBlocks.includes(term)) {
                    cxn[i].push([]);
                    continue;
                }
                const num = parseInt(term, 16);
                if (!num)
                    continue;
                const channel = (num & 3) << (num & 4);
                const offset = num & 8 ? (num & 4 ? 0x0100 : 0x1000) : 0;
                cxn[i][cxn[i].length - 1].push(channel | offset);
            }
        }
    }
    get manual() {
        return Boolean(this._features & manualFeatureMask);
    }
    get counted() {
        return Boolean(this._features & countedFeatureMask);
    }
    hasFeature(feature) {
        return Boolean(this._features & featureMask[feature]);
    }
    hasFeatures(features) {
        return (this._features & features) === features;
    }
    withFeature(feature) {
        throw new Error();
    }
    withObstruction() {
        throw new Error();
    }
    isCompatibleWithTileset(id) {
        for (const tileset of this._tilesets) {
            if (tileset.tilesetId === id)
                return true;
        }
        return false;
    }
    replace(from, to) {
        const { tiles } = this.screen;
        for (let i = 0; i < tiles.length; i++) {
            if (tiles[i] === from)
                tiles[i] = to;
        }
        return this;
    }
    remove() {
        for (const key in this.data.tilesets) {
            const tileset = this.rom.metatilesets[key];
            tileset.deleteScreen(this);
        }
    }
    get id() {
        return this.data.id;
    }
    set id(id) {
        if (this.id === id)
            return;
        this.rom.metascreens.renumber(this.id, id);
    }
    get screen() {
        const { id, rom: { screens } } = this;
        return id < 0 ? screens.unallocated[~id] : screens[id];
    }
    unsafeSetId(id) {
        this.data.id = id;
        for (const tileset of this._tilesets) {
            tileset.invalidate();
        }
    }
    unsafeAddTileset(tileset) {
        this._tilesets.add(tileset);
    }
    unsafeRemoveTileset(tileset) {
        this._tilesets.delete(tileset);
    }
    edgeExits() {
        var _a;
        let mask = 0;
        for (const e of (_a = this.data.exits) !== null && _a !== void 0 ? _a : []) {
            const dir = edgeTypeMap[e.type];
            if (dir != null)
                mask |= (1 << dir);
        }
        return mask;
    }
    findExitType(tile, single, seamless) {
        var _a, _b;
        for (const exit of (_a = this.data.exits) !== null && _a !== void 0 ? _a : []) {
            if (exit.type.startsWith('seamless') !== seamless)
                continue;
            const t0 = single && exit.type === 'edge:bottom' && tile >= 0xc0 ?
                tile + 0x20 : tile;
            if (exit.exits.includes(t0) || ((_b = exit.allowedExits) !== null && _b !== void 0 ? _b : []).includes(t0)) {
                return exit;
            }
        }
        return undefined;
    }
    findEntranceType(coord, single) {
        var _a, _b;
        for (const exit of (_a = this.data.exits) !== null && _a !== void 0 ? _a : []) {
            if (exit.type.startsWith('seamless'))
                continue;
            const c0 = single && exit.type === 'edge:bottom' && coord >= 0xbf00 ?
                coord + 0x2000 : coord;
            const t0 = (c0 & 0xf0) >> 4 | (c0 & 0xf000) >> 8;
            if (exit.entrance === c0 ||
                exit.exits.includes(t0) || ((_b = exit.allowedExits) !== null && _b !== void 0 ? _b : []).includes(t0)) {
                return exit.type;
            }
        }
        return undefined;
    }
    addCustomFlag(defaultValue) {
        this.flag = defaultValue ? 'custom:true' : 'custom:false';
    }
    _checkNeighbor(that, dir) {
        return false;
    }
}
const edgeTypeMap = {
    'edge:top': 0,
    'edge:left': 1,
    'edge:bottom': 2,
    'edge:right': 3,
};
const connectionBlocks = [
    '|:',
    '|:=-',
    '|',
    '|=',
];
const manualFeatures = new Set([
    'arena', 'portoa1', 'portoa2', 'portoa3', 'lake', 'overBridge', 'underBridge',
    'lighthouse', 'cabin', 'windmill', 'altar', 'pyramid', 'crypt',
]);
const countedFeatures = new Set([
    'pit', 'spikes', 'bridge', 'wall', 'stairs', 'whirlpool',
]);
const manualFeatureMask = [...manualFeatures].map(f => featureMask[f]).reduce((a, b) => a | b);
const countedFeatureMask = [...countedFeatures].map(f => featureMask[f]).reduce((a, b) => a | b);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vbWV0YXNjcmVlbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0MsV0FBVyxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFJaEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUl4QyxNQUFNLE9BQU8sVUFBVTtJQXFCckIsWUFBcUIsR0FBUSxFQUFXLEdBQVEsRUFDM0IsSUFBb0I7O1FBRHBCLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFBVyxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQzNCLFNBQUksR0FBSixJQUFJLENBQWdCO1FBcEJ4QixjQUFTLEdBQUcsSUFBSSxHQUFHLEVBQWUsQ0FBQztRQU1wRCxTQUFJLEdBQUcsS0FBSyxDQUFDO1FBS0osY0FBUyxHQUFHO1lBQ25CLElBQUksVUFBVSxDQUFzQixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDckUsSUFBSSxVQUFVLENBQXNCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUM3RCxDQUFDO1FBT1QsS0FBSyxNQUFNLE9BQU8sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUNsRCxJQUFJLENBQUMsT0FBUSxDQUFDLFFBQVE7Z0JBQUUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDMUM7UUFHRCxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDakIsS0FBSyxNQUFNLE9BQU8sVUFBSSxJQUFJLENBQUMsT0FBTyxtQ0FBSSxFQUFFLEVBQUU7WUFDeEMsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xD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LE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29ubmVjdGlvbiwgQ29ubmVjdGlvblR5cGUsIEZlYXR1cmUsIE1ldGFzY3JlZW5EYXRhLFxuICAgICAgICBmZWF0dXJlTWFza30gZnJvbSAnLi9tZXRhc2NyZWVuZGF0YS5qcyc7XG5pbXBvcnQge01ldGF0aWxlc2V0LCBNZXRhdGlsZXNldHN9IGZyb20gJy4vbWV0YXRpbGVzZXQuanMnO1xuaW1wb3J0IHtTY3JlZW59IGZyb20gJy4vc2NyZWVuLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHsgRGVmYXVsdE1hcCB9IGZyb20gJy4uL3V0aWwuanMnO1xuXG5leHBvcnQgdHlwZSBVaWQgPSBudW1iZXIgJiB7X191aWRfXzogbmV2ZXJ9O1xuXG5leHBvcnQgY2xhc3MgTWV0YXNjcmVlbiB7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2ZlYXR1cmVzOiBudW1iZXI7IC8vID0gbmV3IFNldDxGZWF0dXJlPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IF90aWxlc2V0cyA9IG5ldyBTZXQ8TWV0YXRpbGVzZXQ+KCk7XG4gIC8vIGtleTogYml0c2V0IC0gMSBmb3IgZmxpZ2h0LCAyIGZvciBub0ZsYWdcbiAgLy8gdmFsdWU6IHNlZ21lbnRzLCBlYWNoIGNvbnRhaW5pbmcgYW4gb2Zmc2V0IHRvIGFkZCB0byBwb3M8PDggdG8gZ2V0XG4gIC8vICAgICAgICBjb25uZWN0aW9uIHBvaW50cyAoZS5nLiAwMDAxLCAwMTAxLCAxMDIwLCBldGMpLlxuICByZWFkb25seSBjb25uZWN0aW9uczogUmVhZG9ubHlBcnJheTxSZWFkb25seUFycmF5PFJlYWRvbmx5QXJyYXk8bnVtYmVyPj4+O1xuXG4gIHVzZWQgPSBmYWxzZTtcblxuICBmbGFnPzogJ2Fsd2F5cycgfCAnY2FsbScgfCAnY3VzdG9tOmZhbHNlJyB8ICdjdXN0b206dHJ1ZSc7XG4gIG5hbWU/OiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkgbmVpZ2hib3JzID0gW1xuICAgIG5ldyBEZWZhdWx0TWFwPE1ldGFzY3JlZW4sIGJvb2xlYW4+KChzKSA9PiB0aGlzLl9jaGVja05laWdoYm9yKHMsIDApKSxcbiAgICBuZXcgRGVmYXVsdE1hcDxNZXRhc2NyZWVuLCBib29sZWFuPigocykgPT4gdGhpcy5fY2hlY2tOZWlnaGJvcihzLCAxKSksXG4gIF0gYXMgY29uc3Q7XG5cbiAgLy9yZWFkb25seSBmZWF0dXJlQ291bnQ6IFJlYWRvbmx5TWFwPEZlYXR1cmUsIG51bWJlcj47XG5cbiAgLy8gVE9ETyAtIG1ha2UgZGF0YSBwcml2YXRlP1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSwgcmVhZG9ubHkgdWlkOiBVaWQsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IGRhdGE6IE1ldGFzY3JlZW5EYXRhKSB7XG4gICAgZm9yIChjb25zdCB0aWxlc2V0IG9mIE9iamVjdC52YWx1ZXMoZGF0YS50aWxlc2V0cykpIHtcbiAgICAgIGlmICghdGlsZXNldCEucmVxdWlyZXMpIHRoaXMudXNlZCA9IHRydWU7XG4gICAgfVxuICAgIC8vIGxldCBmaXhlZCA9IGZhbHNlO1xuICAgIC8vIGNvbnN0IGZlYXR1cmVDb3VudCA9IG5ldyBEZWZhdWx0TWFwPEZlYXR1cmUsIG51bWJlcj4oKCkgPT4gMCk7XG4gICAgbGV0IGZlYXR1cmVzID0gMDtcbiAgICBmb3IgKGNvbnN0IGZlYXR1cmUgb2YgZGF0YS5mZWF0dXJlID8/IFtdKSB7XG4gICAgICBjb25zdCBtYXNrID0gZmVhdHVyZU1hc2tbZmVhdHVyZV07XG4gICAgICBpZiAobWFzayAhPSBudWxsKSBmZWF0dXJlcyB8PSBtYXNrO1xuICAgICAgLy8gdGhpcy5fZmVhdHVyZXMuYWRkKGZlYXR1cmUpO1xuICAgICAgLy8gaWYgKGZpeGVkRmVhdHVyZXMuaGFzKGZlYXR1cmUpKSBmaXhlZCA9IHRydWU7XG4gICAgICAvLyBpZiAoZml4ZWRDb3VudEZlYXR1cmVzLmhhcyhmZWF0dXJlKSkge1xuICAgICAgLy8gICBmZWF0dXJlQ291bnQuc2V0KGZlYXR1cmUsIGZlYXR1cmVDb3VudC5nZXQoZmVhdHVyZSkgKyAxKTtcbiAgICAgIC8vIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCBleGl0IG9mIGRhdGEuZXhpdHMgPz8gW10pIHtcbiAgICAgIGlmIChleGl0LnR5cGUgPT09ICdzdGFpcjpkb3duJyB8fCBleGl0LnR5cGUgPT09ICdzdGFpcjp1cCcpIHtcbiAgICAgICAgZmVhdHVyZXMgfD0gZmVhdHVyZU1hc2tbZXhpdC50eXBlXTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fZmVhdHVyZXMgPSBmZWF0dXJlcztcbiAgICB0aGlzLmZsYWcgPSBkYXRhLmZsYWc7XG4gICAgLy8gdGhpcy5maXhlZCA9IGZpeGVkO1xuICAgIC8vIHRoaXMuZmVhdHVyZUNvdW50ID0gZmVhdHVyZUNvdW50O1xuICAgIC8vIFRPRE8gLSBidWlsZCBcImNvbm5lY3Rpb25zXCIgYnkgaXRlcmF0aW5nIG92ZXIgMC4uMy5cbiAgICBjb25zdCBjeG46IG51bWJlcltdW11bXSA9IFtbW11dLCBbW11dLCBbW11dLCBbW11dXTtcbiAgICB0aGlzLmNvbm5lY3Rpb25zID0gY3huO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7XG4gICAgICBmb3IgKGNvbnN0IHRlcm0gb2YgdGhpcy5kYXRhLmNvbm5lY3QgPz8gJycpIHtcbiAgICAgICAgaWYgKGNvbm5lY3Rpb25CbG9ja3MuaW5jbHVkZXModGVybSkpIHtcbiAgICAgICAgICBjeG5baV0ucHVzaChbXSk7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbnVtID0gcGFyc2VJbnQodGVybSwgMTYpO1xuICAgICAgICBpZiAoIW51bSkgY29udGludWU7XG4gICAgICAgIGNvbnN0IGNoYW5uZWwgPSAobnVtICYgMykgPDwgKG51bSAmIDQpOyAvLyAwMSwgMDIsIDAzLCAxMCwgMjAsIG9yIDMwXG4gICAgICAgIGNvbnN0IG9mZnNldCA9IG51bSAmIDggPyAobnVtICYgNCA/IDB4MDEwMCA6IDB4MTAwMCkgOiAwO1xuICAgICAgICBjeG5baV1bY3huW2ldLmxlbmd0aCAtIDFdLnB1c2goY2hhbm5lbCB8IG9mZnNldCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0IG1hbnVhbCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbih0aGlzLl9mZWF0dXJlcyAmIG1hbnVhbEZlYXR1cmVNYXNrKTtcbiAgfVxuXG4gIGdldCBjb3VudGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBCb29sZWFuKHRoaXMuX2ZlYXR1cmVzICYgY291bnRlZEZlYXR1cmVNYXNrKTtcbiAgfVxuXG4gIC8vIGZlYXR1cmVzKCk6IEl0ZXJhYmxlPEZlYXR1cmU+IHtcbiAgLy8gICByZXR1cm4gdGhpcy5fZmVhdHVyZXMudmFsdWVzKCk7XG4gIC8vIH1cblxuICBoYXNGZWF0dXJlKGZlYXR1cmU6IEZlYXR1cmUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbih0aGlzLl9mZWF0dXJlcyAmIGZlYXR1cmVNYXNrW2ZlYXR1cmVdKTtcbiAgfVxuXG4gIGhhc0ZlYXR1cmVzKGZlYXR1cmVzOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKHRoaXMuX2ZlYXR1cmVzICYgZmVhdHVyZXMpID09PSBmZWF0dXJlcztcbiAgfVxuXG4gIC8qKiBSZXR1cm4gYSBuZXcgbWV0YXNjcmVlbiB3aXRoIHRoZSBzYW1lIHByb2ZpbGUgYnV0IGFuIGV4dHJhIGZlYXR1cmUuICovXG4gIHdpdGhGZWF0dXJlKGZlYXR1cmU6IEZlYXR1cmUpOiBNZXRhc2NyZWVuW10ge1xuICAgIC8vIFRPRE8gLSBpbmRleCB0aGlzP1xuICAgIHRocm93IG5ldyBFcnJvcigpO1xuICB9XG5cbiAgLyoqIFJldHVybiBhIG5ldyBtZXRhc2NyZWVuIHdpdGggdGhlIHNhbWUgcHJvZmlsZSBidXQgbW9yZSBvYnN0cnVjdGVkLiAqL1xuICB3aXRoT2JzdHJ1Y3Rpb24oKTogTWV0YXNjcmVlbltdIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgfVxuXG4gIGlzQ29tcGF0aWJsZVdpdGhUaWxlc2V0KGlkOiBudW1iZXIpIHtcbiAgICBmb3IgKGNvbnN0IHRpbGVzZXQgb2YgdGhpcy5fdGlsZXNldHMpIHtcbiAgICAgIGlmICh0aWxlc2V0LnRpbGVzZXRJZCA9PT0gaWQpIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogUmVwbGFjZSBvY2N1cnJlbmNlcyBvZiBhIG1ldGF0aWxlIHdpdGhpbiB0aGlzIHNjcmVlbi5cbiAgICovXG4gIHJlcGxhY2UoZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyKTogTWV0YXNjcmVlbiB7XG4gICAgY29uc3Qge3RpbGVzfSA9IHRoaXMuc2NyZWVuO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGlsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICh0aWxlc1tpXSA9PT0gZnJvbSkgdGlsZXNbaV0gPSB0bztcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICByZW1vdmUoKSB7XG4gICAgLy8gUmVtb3ZlIHNlbGYgZnJvbSBhbGwgbWV0YXRpbGVzZXRzLiAgVXNlZCBieSBsYWJ5cmludGhWYXJpYW50IHRvXG4gICAgLy8gZW5zdXJlIGltcG9zc2libGUgdmFyaWFudHMgYXJlbid0IGFkZGVkIChub3RlOiB3aXRoIGEgZGVkaWNhdGVkXG4gICAgLy8gcGFnZSB3ZSBjb3VsZCBtYWtlIG1vcmUgYXZhaWxhYmxlKS5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmRhdGEudGlsZXNldHMpIHtcbiAgICAgIGNvbnN0IHRpbGVzZXQgPVxuICAgICAgICAgIHRoaXMucm9tLm1ldGF0aWxlc2V0c1trZXkgYXMga2V5b2YgTWV0YXRpbGVzZXRzXSBhcyBNZXRhdGlsZXNldDtcbiAgICAgIHRpbGVzZXQuZGVsZXRlU2NyZWVuKHRoaXMpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBpZCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmRhdGEuaWQ7XG4gIH1cblxuICBzZXQgaWQoaWQ6IG51bWJlcikge1xuICAgIGlmICh0aGlzLmlkID09PSBpZCkgcmV0dXJuO1xuICAgIHRoaXMucm9tLm1ldGFzY3JlZW5zLnJlbnVtYmVyKHRoaXMuaWQsIGlkKTtcbiAgfVxuXG4gIGdldCBzY3JlZW4oKTogU2NyZWVuIHtcbiAgICBjb25zdCB7aWQsIHJvbToge3NjcmVlbnN9fSA9IHRoaXM7XG4gICAgcmV0dXJuIGlkIDwgMCA/IHNjcmVlbnMudW5hbGxvY2F0ZWRbfmlkXSA6IHNjcmVlbnNbaWRdO1xuICB9XG5cbiAgLy8gT25seSBNZXRhc2NyZWVucy5yZW51bWJlciBzaG91bGQgY2FsbCB0aGlzLlxuICB1bnNhZmVTZXRJZChpZDogbnVtYmVyKSB7XG4gICAgKHRoaXMuZGF0YSBhcyB7aWQ6IG51bWJlcn0pLmlkID0gaWQ7XG4gICAgZm9yIChjb25zdCB0aWxlc2V0IG9mIHRoaXMuX3RpbGVzZXRzKSB7XG4gICAgICB0aWxlc2V0LmludmFsaWRhdGUoKTtcbiAgICB9XG4gIH1cbiAgLy8gT25seSBNZXRhdGlsZXNldC5hZGRTY3JlZW4gc2hvdWxkIGNhbGwgdGhpcy5cbiAgdW5zYWZlQWRkVGlsZXNldCh0aWxlc2V0OiBNZXRhdGlsZXNldCkge1xuICAgIHRoaXMuX3RpbGVzZXRzLmFkZCh0aWxlc2V0KTtcbiAgfVxuICAvLyBPbmx5IE1ldGF0aWxlc2V0LnJlbW92ZVNjcmVlbiBzaG91bGQgY2FsbCB0aGlzLlxuICB1bnNhZmVSZW1vdmVUaWxlc2V0KHRpbGVzZXQ6IE1ldGF0aWxlc2V0KSB7XG4gICAgdGhpcy5fdGlsZXNldHMuZGVsZXRlKHRpbGVzZXQpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYSBiaXQgbWFzayBvZiBlZGdlcyB0aGF0IF9jb3VsZF8gZXhpdDogMT1OLCAyPVcsIDQ9UywgOD1FLiAqL1xuICBlZGdlRXhpdHMoKTogbnVtYmVyIHtcbiAgICBsZXQgbWFzayA9IDA7XG4gICAgZm9yIChjb25zdCBlIG9mIHRoaXMuZGF0YS5leGl0cyA/PyBbXSkge1xuICAgICAgY29uc3QgZGlyID0gZWRnZVR5cGVNYXBbZS50eXBlXTtcbiAgICAgIGlmIChkaXIgIT0gbnVsbCkgbWFzayB8PSAoMSA8PCBkaXIpO1xuICAgIH1cbiAgICByZXR1cm4gbWFzaztcbiAgfVxuXG4gIGZpbmRFeGl0VHlwZSh0aWxlOiBudW1iZXIsIHNpbmdsZTogYm9vbGVhbixcbiAgICAgICAgICAgICAgIHNlYW1sZXNzOiBib29sZWFuKTogQ29ubmVjdGlvbnx1bmRlZmluZWQge1xuICAgIGZvciAoY29uc3QgZXhpdCBvZiB0aGlzLmRhdGEuZXhpdHMgPz8gW10pIHtcbiAgICAgIGlmIChleGl0LnR5cGUuc3RhcnRzV2l0aCgnc2VhbWxlc3MnKSAhPT0gc2VhbWxlc3MpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgdDAgPSBzaW5nbGUgJiYgZXhpdC50eXBlID09PSAnZWRnZTpib3R0b20nICYmIHRpbGUgPj0gMHhjMCA/XG4gICAgICAgICAgdGlsZSArIDB4MjAgOiB0aWxlO1xuICAgICAgaWYgKGV4aXQuZXhpdHMuaW5jbHVkZXModDApIHx8IChleGl0LmFsbG93ZWRFeGl0cyA/PyBbXSkuaW5jbHVkZXModDApKSB7XG4gICAgICAgIHJldHVybiBleGl0O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgZmluZEVudHJhbmNlVHlwZShjb29yZDogbnVtYmVyLCBzaW5nbGU6IGJvb2xlYW4pOiBDb25uZWN0aW9uVHlwZXx1bmRlZmluZWQge1xuICAgIGZvciAoY29uc3QgZXhpdCBvZiB0aGlzLmRhdGEuZXhpdHMgPz8gW10pIHtcbiAgICAgIGlmIChleGl0LnR5cGUuc3RhcnRzV2l0aCgnc2VhbWxlc3MnKSkgY29udGludWU7XG4gICAgICBjb25zdCBjMCA9IHNpbmdsZSAmJiBleGl0LnR5cGUgPT09ICdlZGdlOmJvdHRvbScgJiYgY29vcmQgPj0gMHhiZjAwID9cbiAgICAgICAgICBjb29yZCArIDB4MjAwMCA6IGNvb3JkO1xuICAgICAgY29uc3QgdDAgPSAoYzAgJiAweGYwKSA+PiA0IHwgKGMwICYgMHhmMDAwKSA+PiA4O1xuICAgICAgaWYgKGV4aXQuZW50cmFuY2UgPT09IGMwIHx8XG4gICAgICAgICAgZXhpdC5leGl0cy5pbmNsdWRlcyh0MCkgfHwgKGV4aXQuYWxsb3dlZEV4aXRzID8/IFtdKS5pbmNsdWRlcyh0MCkpIHtcbiAgICAgICAgcmV0dXJuIGV4aXQudHlwZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGFkZEN1c3RvbUZsYWcoZGVmYXVsdFZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5mbGFnID0gZGVmYXVsdFZhbHVlID8gJ2N1c3RvbTp0cnVlJyA6ICdjdXN0b206ZmFsc2UnO1xuXG4gICAgLy8gVE9ETyAtIGZvciBub3csIGN1c3RvbSBmbGFncyBhcmUgc2V0IGJ5IGRlZmF1bHQuXG5cbiAgICAvLyBpZiAoIWZsYWdBbGwpIHJldHVybjtcbiAgICAvLyBmb3IgKGNvbnN0IGxvYyBvZiB0aGlzLnJvbS5sb2NhdGlvbnMpIHtcbiAgICAvLyAgIGlmICghbG9jLnVzZWQpIGNvbnRpbnVlO1xuICAgIC8vICAgZm9yIChjb25zdCBwb3Mgb2YgbG9jLm1ldGEuYWxsUG9zKCkpIHtcbiAgICAvLyAgICAgaWYgKGxvYy5tZXRhLmdldFVpZChwb3MpICE9PSB0aGlzLnVpZCkgY29udGludWU7XG4gICAgLy8gICAgIGxvYy5tZXRhLmN1c3RvbUZsYWdzLnNldChwb3MsIHRoaXMucm9tLmZsYWdzLkFsd2F5c1RydWUpO1xuICAgIC8vICAgfVxuICAgIC8vIH1cbiAgfVxuXG4gIC8qKiBAcGFyYW0gZGlyIDAgdG8gY2hlY2sgaWYgdGhhdCBpcyB1bmRlciB0aGlzLCAxIGlmIHRoYXQgaXMgcmlnaHQgb2YgdGhpcyAqL1xuICBwcml2YXRlIF9jaGVja05laWdoYm9yKHRoYXQ6IE1ldGFzY3JlZW4sIGRpcjogMHwxKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICAgIC8vIGNvbnN0IGUxID0gdGhpcy5kYXRhLmVkZ2VzO1xuICAgIC8vIGNvbnN0IGUyID0gdGhhdC5kYXRhLmVkZ2VzO1xuICAgIC8vIGlmIChlMSAmJiBlMikge1xuICAgIC8vICAgY29uc3Qgb3BwID0gZGlyIHwgMjtcbiAgICAvLyAgIGlmIChlMVtvcHBdICE9PSAnKicgJiYgZTFbb3BwXSA9PT0gZTJbZGlyXSkgcmV0dXJuIHRydWU7XG4gICAgLy8gfVxuXG4gICAgLy8gVE9ETyAtIGNoYW5nZSBhbGxvd2VkIHRvIHJldHVybiBhIG1hc2suXG4gIH1cbn1cblxuY29uc3QgZWRnZVR5cGVNYXA6IHtbQyBpbiBDb25uZWN0aW9uVHlwZV0/OiBudW1iZXJ9ID0ge1xuICAnZWRnZTp0b3AnOiAwLFxuICAnZWRnZTpsZWZ0JzogMSxcbiAgJ2VkZ2U6Ym90dG9tJzogMixcbiAgJ2VkZ2U6cmlnaHQnOiAzLFxufTtcblxuY29uc3QgY29ubmVjdGlvbkJsb2NrcyA9IFtcbiAgJ3w6JywgLy8gYnJlYWsgd2FsbCwgZm9ybSBicmlkZ2UsIGJ1dCBubyBmbGlnaHRcbiAgJ3w6PS0nLCAvLyBubyB3YWxscy9icmlkZ2UvZmxpZ2h0XG4gICd8JywgLy8gZmxpZ2h0IGFuZCBicmVhayB3YWxsc1xuICAnfD0nLCAvLyBmbGlnaHQgb25seVxuXTtcbiAgXG5cbmNvbnN0IG1hbnVhbEZlYXR1cmVzID0gbmV3IFNldDxGZWF0dXJlPihbXG4gICdhcmVuYScsICdwb3J0b2ExJywgJ3BvcnRvYTInLCAncG9ydG9hMycsICdsYWtlJywgJ292ZXJCcmlkZ2UnLCAndW5kZXJCcmlkZ2UnLFxuICAnbGlnaHRob3VzZScsICdjYWJpbicsICd3aW5kbWlsbCcsICdhbHRhcicsICdweXJhbWlkJywgJ2NyeXB0Jyxcbl0pO1xuY29uc3QgY291bnRlZEZlYXR1cmVzID0gbmV3IFNldDxGZWF0dXJlPihbXG4gICdwaXQnLCAnc3Bpa2VzJywgJ2JyaWRnZScsICd3YWxsJywgJ3N0YWlycycsICd3aGlybHBvb2wnLFxuXSk7XG5cbmNvbnN0IG1hbnVhbEZlYXR1cmVNYXNrID0gWy4uLm1hbnVhbEZlYXR1cmVzXS5tYXAoXG4gICAgZiA9PiBmZWF0dXJlTWFza1tmXSBhcyBudW1iZXIpLnJlZHVjZSgoYSwgYikgPT4gYSB8IGIpO1xuY29uc3QgY291bnRlZEZlYXR1cmVNYXNrID0gWy4uLmNvdW50ZWRGZWF0dXJlc10ubWFwKFxuICAgIGYgPT4gZmVhdHVyZU1hc2tbZl0gYXMgbnVtYmVyKS5yZWR1Y2UoKGEsIGIpID0+IGEgfCBiKTtcbiJdfQ==