import { Entity, EntityArray } from './entity.js';
import { MessageId } from './messageid.js';
import { ITEM_GET_FLAGS, Address, Segment, hex, readLittleEndian, relocExportLabel } from './util.js';
const { $0e, $0f, $14, $fe, $ff } = Segment;
const ITEMGET_TABLE = Address.of($0e, 0x9b00);
const GET_TO_ITEM_BASE = Address.of($0e, 0x9d66);
const GET_TO_ITEM_THRESHOLD = 0x49;
export class ItemGets extends EntityArray {
    constructor(rom) {
        super(0x71);
        this.rom = rom;
        this.actionGrants = new Map();
        for (let i = 0; i < 0x71; i++) {
            this[i] = new ItemGet(rom, i);
        }
        this.actionGrants.set(0x25, 0x29);
        this.actionGrants.set(0x39, 0x3a);
        this.actionGrants.set(0x3b, 0x47);
        this.actionGrants.set(0x3c, 0x3e);
        this.actionGrants.set(0x84, 0x46);
        this.actionGrants.set(0xb2, 0x42);
        this.actionGrants.set(0xb4, 0x41);
    }
    write() {
        const a = this.rom.assembler();
        for (const itemget of this) {
            itemget.assemble(a);
        }
        relocExportLabel(a, [$14, $fe, $ff], 'GrantItemTable');
        for (const [key, value] of this.actionGrants) {
            a.byte(key, value);
        }
        return [a.module()];
    }
}
export class ItemGet extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this._itemId = this.itemPointer.read(rom.prg);
        const tableBase = this.tablePointer.readAddress(rom.prg, $0e, $0f);
        let a = tableBase.offset;
        this.inventoryRowStart = rom.prg[a++];
        this.inventoryRowLength = rom.prg[a++];
        this.acquisitionAction = MessageId.from(rom.prg, a);
        this.flags = ITEM_GET_FLAGS.read(rom.prg, a + 2);
        this.key = rom.prg[a + 2 + 2 * this.flags.length + 1] === 0xfe;
        if (id !== 0 && tableBase.org === readLittleEndian(rom.prg, 0x1dd66)) {
            this.key = false;
            this.flags = [];
        }
    }
    get itemPointer() {
        return GET_TO_ITEM_BASE.plus(this.id);
    }
    get tablePointer() {
        return ITEMGET_TABLE.plus(this.id << 1);
    }
    get itemId() { return this._itemId; }
    set itemId(itemId) {
        if (this.id < GET_TO_ITEM_THRESHOLD)
            throw new Error(`${this.id}`);
        this._itemId = itemId;
    }
    isLosable() {
        return LOSABLE_ROWS.has(this.inventoryRowStart);
    }
    copyFrom(that) {
        this.inventoryRowStart = that.inventoryRowStart;
        this.inventoryRowLength = that.inventoryRowLength;
        this.acquisitionAction = that.acquisitionAction;
        this.flags = [...that.flags];
        this.key = that.key;
    }
    assemble(a) {
        this.itemPointer.loc(a);
        a.byte(this.itemId);
        const table = [
            this.inventoryRowStart, this.inventoryRowLength,
            ...this.acquisitionAction.data,
            ...ITEM_GET_FLAGS.bytes(this.flags),
            this.key ? 0xfe : 0xff,
        ];
        a.segment($0e.name, $0f.name);
        a.reloc(`ItemGetData ${hex(this.id)}`);
        const tableAddr = a.pc();
        a.byte(...table);
        this.tablePointer.loc(a);
        a.word(tableAddr);
    }
}
const LOSABLE_ROWS = new Set([4, 8, 16]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbWdldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vaXRlbWdldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFdBQVcsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDekMsT0FBTyxFQUFDLGNBQWMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUN0QyxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFFNUQsTUFBTSxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsR0FBRyxPQUFPLENBQUM7QUFHMUMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFOUMsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNqRCxNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQztBQU9uQyxNQUFNLE9BQU8sUUFBUyxTQUFRLFdBQW9CO0lBSWhELFlBQXFCLEdBQVE7UUFDM0IsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRE8sUUFBRyxHQUFILEdBQUcsQ0FBSztRQUY3QixpQkFBWSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBSXZDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDN0IsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUMvQjtRQU9ELElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMs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QUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJO1lBQzlCLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ25DLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSTtTQUN2QixDQUFDO1FBQ0YsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdkMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BCLENBQUM7Q0FDRjtBQUVELE1BQU0sWUFBWSxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBc3NlbWJsZXJ9IGZyb20gJy4uL2FzbS9hc3NlbWJsZXIuanMnO1xuaW1wb3J0IHtNb2R1bGV9IGZyb20gJy4uL2FzbS9tb2R1bGUuanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0VudGl0eSwgRW50aXR5QXJyYXl9IGZyb20gJy4vZW50aXR5LmpzJztcbmltcG9ydCB7TWVzc2FnZUlkfSBmcm9tICcuL21lc3NhZ2VpZC5qcyc7XG5pbXBvcnQge0lURU1fR0VUX0ZMQUdTLCBBZGRyZXNzLCBTZWdtZW50LFxuICBoZXgsIHJlYWRMaXR0bGVFbmRpYW4sIHJlbG9jRXhwb3J0TGFiZWx9IGZyb20gJy4vdXRpbC5qcyc7XG5cbmNvbnN0IHskMGUsICQwZiwgJDE0LCAkZmUsICRmZn0gPSBTZWdtZW50O1xuXG4vLyBUT0RPIC0gdGhpcyBkZXBlbmRzIG9uIGEgcHJlcGFyc2UgY2hhbmdlLCB3ZSBzaG91bGQgcmVjb25zaWRlciB0aGF0LlxuY29uc3QgSVRFTUdFVF9UQUJMRSA9IEFkZHJlc3Mub2YoJDBlLCAweDliMDApO1xuLy9jb25zdCBHUkFOVF9JVEVNX1RBQkxFID0gQWRkcmVzcy5vZigkZmUsIDB4ZDZkNSk7XG5jb25zdCBHRVRfVE9fSVRFTV9CQVNFID0gQWRkcmVzcy5vZigkMGUsIDB4OWQ2Nik7XG5jb25zdCBHRVRfVE9fSVRFTV9USFJFU0hPTEQgPSAweDQ5O1xuXG4vKipcbiAqIEFycmF5IG9mIEl0ZW1HZXREYXRhIHRhYmxlIGVudHJpZXMsIHRvZ2V0aGVyIHdpdGggdGhlIG1hcCBvZlxuICogdHJpZ2dlci9pdGVtdXNlIGdyYW50cyAoYWRkZWQgZm9yIHN0YXR1ZSBvZiBnb2xkIHNodWZmbGUpLFxuICogZm9yIHByb2dyYW1tYXRpYyBhY2Nlc3MuXG4gKi9cbmV4cG9ydCBjbGFzcyBJdGVtR2V0cyBleHRlbmRzIEVudGl0eUFycmF5PEl0ZW1HZXQ+IHtcblxuICBhY3Rpb25HcmFudHMgPSBuZXcgTWFwPG51bWJlciwgbnVtYmVyPigpO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tKSB7XG4gICAgc3VwZXIoMHg3MSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAweDcxOyBpKyspIHtcbiAgICAgIHRoaXNbaV0gPSBuZXcgSXRlbUdldChyb20sIGkpO1xuICAgIH1cblxuICAgIC8vIFRPRE8gLSBlbmNvZGUgR1JBTlRfSVRFTV9UQUJMRSBvZmZzZXQgaW50byByb21cbiAgICAvLyBzaW5jZSBpdCdzIHJlYWxseSBoYXJkIHRvIHJlYWQgb3RoZXJ3aXNlLlxuXG4gICAgLy8gUHJvYmFibHkgdGhlIHRoaW5nIHRvIGRvIGlmIHRoZSB0YWJsZSBkb2Vzbid0IGV4aXN0IGlzIHRvXG4gICAgLy8gcmVhZCB0aGVzZSB2YWx1ZXMgZnJvbSB0aGVpciB2YW5pbGxhIGxvY2k/XG4gICAgdGhpcy5hY3Rpb25HcmFudHMuc2V0KDB4MjUsIDB4MjkpO1xuICAgIHRoaXMuYWN0aW9uR3JhbnRzLnNldCgweDM5LCAweDNhKTtcbiAgICB0aGlzLmFjdGlvbkdyYW50cy5zZXQoMHgzYiwgMHg0Nyk7XG4gICAgdGhpcy5hY3Rpb25HcmFudHMuc2V0KDB4M2MsIDB4M2UpO1xuICAgIHRoaXMuYWN0aW9uR3JhbnRzLnNldCgweDg0LCAweDQ2KTtcbiAgICB0aGlzLmFjdGlvbkdyYW50cy5zZXQoMHhiMiwgMHg0Mik7XG4gICAgdGhpcy5hY3Rpb25HcmFudHMuc2V0KDB4YjQsIDB4NDEpO1xuXG4gICAgLy8gbGV0IGFkZHIgPSBHUkFOVF9JVEVNX1RBQkxFLm9mZnNldDtcbiAgICAvLyB3aGlsZSAocm9tLnByZ1thZGRyXSAhPT0gMHhmZikge1xuICAgIC8vICAgY29uc3Qga2V5ID0gcm9tLnByZ1thZGRyKytdO1xuICAgIC8vICAgY29uc3QgdmFsdWUgPSByb20ucHJnW2FkZHIrK107XG4gICAgLy8gICB0aGlzLmFjdGlvbkdyYW50cy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgLy8gfVxuICB9XG5cbiAgd3JpdGUoKTogTW9kdWxlW10ge1xuICAgIGNvbnN0IGEgPSB0aGlzLnJvbS5hc3NlbWJsZXIoKTtcbiAgICBmb3IgKGNvbnN0IGl0ZW1nZXQgb2YgdGhpcykge1xuICAgICAgaXRlbWdldC5hc3NlbWJsZShhKTtcbiAgICB9XG4gICAgcmVsb2NFeHBvcnRMYWJlbChhLCBbJDE0LCAkZmUsICRmZl0sICdHcmFudEl0ZW1UYWJsZScpO1xuICAgIC8vR1JBTlRfSVRFTV9UQUJMRS5sb2MoYSk7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdGhpcy5hY3Rpb25HcmFudHMpIHtcbiAgICAgIGEuYnl0ZShrZXksIHZhbHVlKTtcbiAgICB9XG4gICAgcmV0dXJuIFthLm1vZHVsZSgpXTtcbiAgfVxuXG59XG5cbi8vIEEgZ2V0dGFibGUgaXRlbSBzbG90L2NoZWNrLiAgRWFjaCBJdGVtR2V0IG1hcHMgdG8gYSBzaW5nbGUgaXRlbSxcbi8vIGJ1dCBub24tdW5pcXVlIGl0ZW1zIG1heSBtYXAgdG8gbXVsdGlwbGUgSXRlbUdldHMuXG5leHBvcnQgY2xhc3MgSXRlbUdldCBleHRlbmRzIEVudGl0eSB7XG5cbiAgcHJpdmF0ZSBfaXRlbUlkOiBudW1iZXI7XG5cbiAgLy8gV2hhdCBwYXJ0IG9mIGludmVudG9yeSB0byBzZWFyY2ggd2hlbiBhY3F1aXJpbmcuXG4gIGludmVudG9yeVJvd1N0YXJ0OiBudW1iZXI7XG4gIGludmVudG9yeVJvd0xlbmd0aDogbnVtYmVyO1xuICAvLyBPbmx5IHVzZWQgZm9yIHRoZSAnYWN0aW9uJy5cbiAgYWNxdWlzaXRpb25BY3Rpb246IE1lc3NhZ2VJZDtcbiAgLy8gRmxhZ3MgdG8gc2V0L2NsZWFyIG9uIGdldHRpbmcgdGhlIGl0ZW0uICB+ZmxhZyBpbmRpY2F0ZXMgdG8gY2xlYXIuXG4gIC8vIE5vdGU6IHdlIGNhbiBlbGltaW5hdGUgbW9zdCBvZiB0aGVzZSBzaW5jZSB3ZSBoYW5kbGUgdGhlIDJ4eCBmbGFnXG4gIC8vIGF1dG9tYXRpY2FsbHkgYW5kIHVzZSBpdCBmb3IgY2hlc3Qgc3Bhd25pbmcuXG4gIGZsYWdzOiBudW1iZXJbXTtcblxuICAvLyBXaGV0aGVyIHRoZSBpdGVtIGlzIFwia2V5XCIgb3Igbm90IGZvciBzY2FsaW5nIHB1cnBvc2VzLlxuICAvLyBUT0RPIC0gZmluZCBhIGJldHRlciBzb3VyY2UgZm9yIHRoaXMgc28gd2UgY2FuIHJlbW92ZSBpdCBmcm9tIHRoaXMgdGFibGUuXG4gIC8vICAgICAgICBXZSBjb3VsZCBwb3NzaWJseSBzdG9yZSBpdCBpbiBhIDE0LWJ5dGUgYml0ZmllbGQuLi5cbiAga2V5OiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tLCBpZDogbnVtYmVyKSB7XG4gICAgc3VwZXIocm9tLCBpZCk7XG5cbiAgICB0aGlzLl9pdGVtSWQgPSB0aGlzLml0ZW1Qb2ludGVyLnJlYWQocm9tLnByZyk7XG4gICAgLy8gSSBkb24ndCBmdWxseSB1bmRlcnN0YW5kIHRoaXMgdGFibGUuLi5cbiAgICBjb25zdCB0YWJsZUJhc2UgPSB0aGlzLnRhYmxlUG9pbnRlci5yZWFkQWRkcmVzcyhyb20ucHJnLCAkMGUsICQwZik7XG4gICAgbGV0IGEgPSB0YWJsZUJhc2Uub2Zmc2V0O1xuXG4gICAgdGhpcy5pbnZlbnRvcnlSb3dTdGFydCA9IHJvbS5wcmdbYSsrXTtcbiAgICB0aGlzLmludmVudG9yeVJvd0xlbmd0aCA9IHJvbS5wcmdbYSsrXTtcbiAgICB0aGlzLmFjcXVpc2l0aW9uQWN0aW9uID0gTWVzc2FnZUlkLmZyb20ocm9tLnByZywgYSk7XG4gICAgdGhpcy5mbGFncyA9IElURU1fR0VUX0ZMQUdTLnJlYWQocm9tLnByZywgYSArIDIpO1xuXG4gICAgLy8gVE9ETzogcmVtb3ZlIHRoaXMgY2hlY2tcbiAgICB0aGlzLmtleSA9IHJvbS5wcmdbYSArIDIgKyAyICogdGhpcy5mbGFncy5sZW5ndGggKyAxXSA9PT0gMHhmZTtcblxuICAgIGlmIChpZCAhPT0gMCAmJiB0YWJsZUJhc2Uub3JnID09PSByZWFkTGl0dGxlRW5kaWFuKHJvbS5wcmcsIDB4MWRkNjYpKSB7XG4gICAgICAvLyBUaGlzIGlzIG9uZSBvZiB0aGUgdW51c2VkIGl0ZW1zIHRoYXQgcG9pbnQgdG8gc3dvcmQgb2Ygd2luZC5cbiAgICAgIHRoaXMua2V5ID0gZmFsc2U7XG4gICAgICB0aGlzLmZsYWdzID0gW107XG4gICAgfVxuICB9XG5cbiAgZ2V0IGl0ZW1Qb2ludGVyKCk6IEFkZHJlc3Mge1xuICAgIHJldHVybiBHRVRfVE9fSVRFTV9CQVNFLnBsdXModGhpcy5pZCk7XG4gIH1cblxuICBnZXQgdGFibGVQb2ludGVyKCk6IEFkZHJlc3Mge1xuICAgIHJldHVybiBJVEVNR0VUX1RBQkxFLnBsdXModGhpcy5pZCA8PCAxKVxuICB9XG5cbiAgZ2V0IGl0ZW1JZCgpIHsgcmV0dXJuIHRoaXMuX2l0ZW1JZDsgfVxuICBzZXQgaXRlbUlkKGl0ZW1JZDogbnVtYmVyKSB7XG4gICAgaWYgKHRoaXMuaWQgPCBHRVRfVE9fSVRFTV9USFJFU0hPTEQpIHRocm93IG5ldyBFcnJvcihgJHt0aGlzLmlkfWApO1xuICAgIHRoaXMuX2l0ZW1JZCA9IGl0ZW1JZDtcbiAgfVxuXG4gIGlzTG9zYWJsZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gTE9TQUJMRV9ST1dTLmhhcyh0aGlzLmludmVudG9yeVJvd1N0YXJ0KTtcbiAgfVxuXG4gIGNvcHlGcm9tKHRoYXQ6IEl0ZW1HZXQpIHtcbiAgICB0aGlzLmludmVudG9yeVJvd1N0YXJ0ID0gdGhhdC5pbnZlbnRvcnlSb3dTdGFydDtcbiAgICB0aGlzLmludmVudG9yeVJvd0xlbmd0aCA9IHRoYXQuaW52ZW50b3J5Um93TGVuZ3RoO1xuICAgIHRoaXMuYWNxdWlzaXRpb25BY3Rpb24gPSB0aGF0LmFjcXVpc2l0aW9uQWN0aW9uO1xuICAgIHRoaXMuZmxhZ3MgPSBbLi4udGhhdC5mbGFnc107XG4gICAgdGhpcy5rZXkgPSB0aGF0LmtleTtcbiAgfVxuXG4gIGFzc2VtYmxlKGE6IEFzc2VtYmxlcikge1xuICAgIC8vIEZpcnN0IHdyaXRlIChpdGVtZ2V0IC0+IGl0ZW0pIG1hcHBpbmdcbiAgICB0aGlzLml0ZW1Qb2ludGVyLmxvYyhhKTtcbiAgICBhLmJ5dGUodGhpcy5pdGVtSWQpO1xuXG4gICAgY29uc3QgdGFibGUgPSBbXG4gICAgICB0aGlzLmludmVudG9yeVJvd1N0YXJ0LCB0aGlzLmludmVudG9yeVJvd0xlbmd0aCxcbiAgICAgIC4uLnRoaXMuYWNxdWlzaXRpb25BY3Rpb24uZGF0YSxcbiAgICAgIC4uLklURU1fR0VUX0ZMQUdTLmJ5dGVzKHRoaXMuZmxhZ3MpLFxuICAgICAgdGhpcy5rZXkgPyAweGZlIDogMHhmZiwgIC8vIFRPRE86IHJlbW92ZSB0aGlzIGJ5dGUgd2hlbiBubyBsb25nZXIgbmVlZGVkXG4gICAgXTtcbiAgICBhLnNlZ21lbnQoJDBlLm5hbWUsICQwZi5uYW1lKTtcbiAgICBhLnJlbG9jKGBJdGVtR2V0RGF0YSAke2hleCh0aGlzLmlkKX1gKTtcbiAgICBjb25zdCB0YWJsZUFkZHIgPSBhLnBjKCk7XG4gICAgYS5ieXRlKC4uLnRhYmxlKTtcbiAgICB0aGlzLnRhYmxlUG9pbnRlci5sb2MoYSk7XG4gICAgYS53b3JkKHRhYmxlQWRkcik7XG4gIH1cbn1cblxuY29uc3QgTE9TQUJMRV9ST1dTID0gbmV3IFNldChbNCwgOCwgMTZdKTtcbiJdfQ==