import { DefaultMap, iters } from '../util.js';
export class Metatilesets {
    constructor(rom) {
        this.rom = rom;
        this._all = [];
        this.grass = this.tileset(0x80, {
            patterns: [0x00, 0x0c],
        });
        this.town = this.tileset(0x84, {});
        this.cave = this.tileset(0x88, {});
        this.dolphinCave = this.tileset(0x88, {});
        this.pyramid = this.tileset(0x8c, {});
        this.river = this.tileset(0x90, {
            animated: [0, 1],
            patterns: [0x14, 0x00],
        });
        this.sea = this.tileset(0x94, {});
        this.lime = this.tileset(0x94, {});
        this.mountain = this.tileset(0x94, {});
        this.shrine = this.tileset(0x98, {});
        this.desert = this.tileset(0x9c, {});
        this.mountainRiver = this.tileset(0x9c, {});
        this.swamp = this.tileset(0xa0, {
            consolidated: true,
        });
        this.house = this.tileset(0xa0, {});
        this.fortress = this.tileset(0xa4, {});
        this.labyrinth = this.tileset(0xa4, {});
        this.iceCave = this.tileset(0xa8, {});
        this.tower = this.tileset(0xac, {});
        for (const key in this) {
            const value = this[key];
            if (value instanceof Metatileset)
                value.name = key;
        }
    }
    tileset(id, opts) {
        const ts = new Metatileset(this.rom, id, opts);
        this._all.push(ts);
        return ts;
    }
    [Symbol.iterator]() {
        return this._all[Symbol.iterator]();
    }
}
export class Metatileset {
    constructor(rom, tilesetId, data) {
        this.rom = rom;
        this.tilesetId = tilesetId;
        this.data = data;
        this._screens = new Set();
        this._cache = undefined;
    }
    [Symbol.iterator]() {
        return this._screens[Symbol.iterator]();
    }
    get cache() {
        if (!this._cache)
            this._cache = new NeighborCache(this);
        return this._cache;
    }
    get tileset() {
        return this.rom.tilesets[this.tilesetId];
    }
    get empty() {
        const e = this.cache.empty;
        if (!e)
            throw new Error(`No empty screen for ${this.name}`);
        return e;
    }
    get exit() {
        return this.rom.metascreens.exit;
    }
    effects() {
        return this.tileset.effects();
    }
    getTile(id) {
        return this.tileset.getTile(id);
    }
    addScreen(screen) {
        this._screens.add(screen);
        screen.unsafeAddTileset(this);
        this.invalidate();
    }
    deleteScreen(screen) {
        this._screens.delete(screen);
        screen.unsafeRemoveTileset(this);
        this.invalidate();
    }
    getMetascreens(screenId) {
        var _a;
        return (_a = this.cache.fromId.get(screenId)) !== null && _a !== void 0 ? _a : EMPTY_SET;
    }
    invalidate() {
        this._cache = undefined;
    }
    check(s1, s2, delta) {
        const cache = this.cache.allowed[delta & 1];
        const index = delta > 0 ? s1 << 16 | s2 : s2 << 16 | s1;
        return cache.has(index);
    }
}
const EMPTY_SET = new class extends Set {
    add() { throw new Error(); }
};
export var Dir;
(function (Dir) {
    Dir.N = 0;
    Dir.W = 1;
    Dir.S = 2;
    Dir.E = 3;
})(Dir || (Dir = {}));
class NeighborCache {
    constructor(tileset) {
        var _a;
        this.tileset = tileset;
        this.allowed = [new Set(), new Set()];
        this.neighbors = new DefaultMap(() => new Set());
        this.fromId = new DefaultMap(() => new Set());
        let empty = undefined;
        for (const s1 of iters.concat(tileset, [tileset.exit])) {
            if (s1.id >= 0)
                this.fromId.get(s1.id).add(s1);
            if (!empty &&
                s1.data.edges === '    ' &&
                s1.hasFeature('empty') &&
                !((_a = s1.data.exits) === null || _a === void 0 ? void 0 : _a.length)) {
                empty = s1;
            }
            const e1 = s1.data.edges || '****';
            for (const s2 of iters.concat(tileset, [tileset.exit])) {
                const e2 = s2.data.edges || '****';
                if (e1[2] !== '*' && e1[2] === e2[0]) {
                    this.add(Dir.S, s1, s2);
                }
                if (e1[3] !== '*' && e1[3] === e2[1]) {
                    this.add(Dir.E, s1, s2);
                }
                for (const dir of (s1.data.allowed ? s1.data.allowed(s2) : [])) {
                    this.add(dir, s1, s2);
                }
            }
        }
        this.empty = empty !== null && empty !== void 0 ? empty : tileset.rom.metascreens.caveEmpty;
    }
    add(dir, s1, s2) {
        const u1 = s1.uid;
        const u2 = s2.uid;
        this.allowed[dir & 1].add(dir & 2 ? u1 << 16 | u2 : u2 << 16 | u1);
        this.neighbors.get(u1 << 2 | dir).add(u2);
        this.neighbors.get(u2 << 2 | (dir ^ 2)).add(u1);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXRpbGVzZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL21ldGF0aWxlc2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFBQyxVQUFVLEVBQUUsS0FBSyxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBRzdDLE1BQU0sT0FBTyxZQUFZO0lBcUR2QixZQUE2QixHQUFRO1FBQVIsUUFBRyxHQUFILEdBQUcsQ0FBSztRQW5EN0IsU0FBSSxHQUFrQixFQUFFLENBQUM7UUFFeEIsVUFBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQ2xDLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7U0FDdkIsQ0FBQyxDQUFDO1FBRU0sU0FBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRzlCLFNBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUU5QixnQkFBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRXJDLFlBQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQyxVQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFDbEMsUUFBUSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNoQixRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1NBQ3ZCLENBQUMsQ0FBQztRQUVNLFFBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUU3QixTQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFHOUIsYUFBUSxHQUFHLElBQUks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RCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQ3ZCO2FBQ0Y7U0FDRjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxhQUFMLEtBQUssY0FBTCxLQUFLLEdBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDO0lBQzFELENBQUM7SUFFTyxHQUFHLENBQUMsR0FBUSxFQUFFLEVBQWMsRUFBRSxFQUFjO1FBQ2xELE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUM7UUFDbEIsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQztRQUNsQixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNsRCxDQUFDO0NBUUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7TWV0YXNjcmVlbn0gZnJvbSAnLi9tZXRhc2NyZWVuLmpzJztcbmltcG9ydCB7TWV0YXRpbGV9IGZyb20gJy4vbWV0YXRpbGUuanMnO1xuaW1wb3J0IHtUaWxlRWZmZWN0c30gZnJvbSAnLi90aWxlZWZmZWN0cy5qcyc7XG5pbXBvcnQge1RpbGVzZXR9IGZyb20gJy4vdGlsZXNldC5qcyc7XG5pbXBvcnQge0RlZmF1bHRNYXAsIGl0ZXJzfSBmcm9tICcuLi91dGlsLmpzJztcblxuLy8gTk9URTogTXVzdCBiZSBpbml0aWFsaXplZCBCRUZPUkUgTWV0YXNjcmVlbnNcbmV4cG9ydCBjbGFzcyBNZXRhdGlsZXNldHMgaW1wbGVtZW50cyBJdGVyYWJsZTxNZXRhdGlsZXNldD4ge1xuXG4gIHByaXZhdGUgX2FsbDogTWV0YXRpbGVzZXRbXSA9IFtdO1xuXG4gIHJlYWRvbmx5IGdyYXNzID0gdGhpcy50aWxlc2V0KDB4ODAsIHtcbiAgICBwYXR0ZXJuczogWzB4MDAsIDB4MGNdLFxuICB9KTtcblxuICByZWFkb25seSB0b3duID0gdGhpcy50aWxlc2V0KDB4ODQsIHt9KTtcblxuICAvLyBzdXBwb3J0cyB3YXRlciwgYnV0IGhhcyB1Z2x5IHdhbGxcbiAgcmVhZG9ubHkgY2F2ZSA9IHRoaXMudGlsZXNldCgweDg4LCB7fSk7XG5cbiAgcmVhZG9ubHkgZG9scGhpbkNhdmUgPSB0aGlzLnRpbGVzZXQoMHg4OCwge30pO1xuXG4gIHJlYWRvbmx5IHB5cmFtaWQgPSB0aGlzLnRpbGVzZXQoMHg4Yywge30pO1xuXG4gIHJlYWRvbmx5IHJpdmVyID0gdGhpcy50aWxlc2V0KDB4OTAsIHtcbiAgICBhbmltYXRlZDogWzAsIDFdLFxuICAgIHBhdHRlcm5zOiBbMHgxNCwgMHgwMF0sIC8vIFRPRE8gLSBhbmltYXRlZCBjbG9iYmVycyAybmQgZW50cnkgYW55d2F5XG4gIH0pO1xuXG4gIHJlYWRvbmx5IHNlYSA9IHRoaXMudGlsZXNldCgweDk0LCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyA4MC4uZmZcblxuICByZWFkb25seSBsaW1lID0gdGhpcy50aWxlc2V0KDB4OTQsIHt9KTsgLy8gcHJpbWFyaWx5IHRpbGVzIDYwLi43ZlxuXG4gIC8vIHBhcnRzIHdpdGggXCJmZWF0dXJlc1wiOiBhcmNoZXMgYW5kIGhvdXNlc1xuICByZWFkb25seSBtb3VudGFpbiA9IHRoaXMudGlsZXNldCgweDk0LCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyAwLi41ZlxuXG4gIC8vIE5PVEU6IGZyZWUgc3BhY2UgZnJvbSA5MC4uZmZcbiAgcmVhZG9ubHkgc2hyaW5lID0gdGhpcy50aWxlc2V0KDB4OTgsIHt9KTtcblxuICByZWFkb25seSBkZXNlcnQgPSB0aGlzLnRpbGVzZXQoMHg5Yywge30pOyAvLyBwcmltYXJpbHkgdGlsZXMgNTAuLmZmXG5cbiAgLy8gdHJhZGVzIGZlYXR1cmVzIGZvciBjcm9zc2FibGUgcml2ZXJcbiAgcmVhZG9ubHkgbW91bnRhaW5SaXZlciA9IHRoaXMudGlsZXNldCgweDljLCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyAwMC4uNGZcblxuICByZWFkb25seSBzd2FtcCA9IHRoaXMudGlsZXNldCgweGEwLCB7XG4gICAgY29uc29saWRhdGVkOiB0cnVlLFxuICB9KTsgLy8gdGlsZXMgYTAuLmZmXG5cbiAgcmVhZG9ubHkgaG91c2UgPSB0aGlzLnRpbGVzZXQoMHhhMCwge30pOyAvLyB0aWxlcyAwMC4uOWZcblxuICByZWFkb25seSBmb3J0cmVzcyA9IHRoaXMudGlsZXNldCgweGE0LCB7fSk7XG5cbiAgLy8gdmFyaWFudCBvZiB0aGUgZm9ydHJlc3MgbWV0YXRpbGVzZXQsIGJ1dCBtYWtlcyB1c2Ugb2YgdGhlIHBhcmFwZXRzXG4gIHJlYWRvbmx5IGxhYnlyaW50aCA9IHRoaXMudGlsZXNldCgweGE0LCB7fSk7XG5cbiAgLy8gc2FtZSBhcyA4OCwgYnV0IHRyYWRlcyByaXZlcnMgZm9yIHByZXR0aWVyIGljZSB3YWxsXG4gIHJlYWRvbmx5IGljZUNhdmUgPSB0aGlzLnRpbGVzZXQoMHhhOCwge30pO1xuXG4gIHJlYWRvbmx5IHRvd2VyID0gdGhpcy50aWxlc2V0KDB4YWMsIHt9KTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJvbTogUm9tKSB7XG4gICAgLy8gVGFnIG5hbWVzIGZvciBkZWJ1Z2dpbmcuLi5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzIGFzIG9iamVjdCkge1xuICAgICAgY29uc3QgdmFsdWUgPSAodGhpcyBhcyBhbnkpW2tleV0gYXMgdW5rbm93bjtcbiAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE1ldGF0aWxlc2V0KSB2YWx1ZS5uYW1lID0ga2V5O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdGlsZXNldChpZDogbnVtYmVyLCBvcHRzOiBNZXRhdGlsZXNldERhdGEpOiBNZXRhdGlsZXNldCB7XG4gICAgY29uc3QgdHMgPSBuZXcgTWV0YXRpbGVzZXQodGhpcy5yb20sIGlkLCBvcHRzKTtcbiAgICB0aGlzLl9hbGwucHVzaCh0cyk7XG4gICAgcmV0dXJuIHRzO1xuICB9XG5cbiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FsbFtTeW1ib2wuaXRlcmF0b3JdKCk7XG4gIH1cbn1cblxuLy8gTWFwcHBpbmcgZnJvbSBtZXRhdGlsZSBJRCB0byB0aWxlIHF1YWRzIGFuZCBwYWxldHRlIG51bWJlci5cbmV4cG9ydCBjbGFzcyBNZXRhdGlsZXNldCBpbXBsZW1lbnRzIEl0ZXJhYmxlPE1ldGFzY3JlZW4+IHtcblxuICAvLyBUT0RPIC0gbWFpbnRhaW4gYW4gaW52YXJpYW50IE1hcDxzY3JlZW4taWQsIFNldDxNZXRhc2NyZWVuPj4sXG4gIC8vICAgICAgICB3aWxsIG5lZWQgdG8gbG9jayBkb3duIChtZXRhKXNjcmVlbiBJRCBmaWVsZCB0byBlbnN1cmVcbiAgLy8gICAgICAgIGludmFyaWFudCBpcyBrZXB0LlxuXG4gIC8vIFRPRE8gLSBwZXJtYW5lbnRseSBhdHRhY2ggYmVoYXZpb3JcbiAgLy8gU3RvcmUgbW9yZSBpbmZvcm1hdGlvbiwgc3VjaCBhcyBzY3JlZW4gdHlwZXMsIGVkZ2UgdHlwZXMsIGV0Yy5cbiAgLy8gTmFtZXMuLi5cbiAgLy8gRG9lcyBwYWxldHRlIGluZm8gYmVsb25nIGhlcmU/ICBNYXliZS4uLlxuXG4gIG5hbWU/OiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3NjcmVlbnMgPSBuZXcgU2V0PE1ldGFzY3JlZW4+KCk7XG4gIHByaXZhdGUgX2NhY2hlPzogTmVpZ2hib3JDYWNoZSA9IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSxcbiAgICAgICAgICAgICAgcmVhZG9ubHkgdGlsZXNldElkOiBudW1iZXIsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IGRhdGE6IE1ldGF0aWxlc2V0RGF0YSkge31cblxuICBbU3ltYm9sLml0ZXJhdG9yXSgpIHtcbiAgICByZXR1cm4gdGhpcy5fc2NyZWVuc1tTeW1ib2wuaXRlcmF0b3JdKCk7XG4gIH1cblxuICBwcml2YXRlIGdldCBjYWNoZSgpOiBOZWlnaGJvckNhY2hlIHtcbiAgICBpZiAoIXRoaXMuX2NhY2hlKSB0aGlzLl9jYWNoZSA9IG5ldyBOZWlnaGJvckNhY2hlKHRoaXMpO1xuICAgIHJldHVybiB0aGlzLl9jYWNoZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB1bmRlcmx5aW5nIHBoeXNpY2FsIHRpbGVzZXQuICBNdWx0aXBsZSBNZXRhdGlsZXNldHNcbiAgICogbWF5IHNoYXJlIHRoZSBzYW1lIHBoeXNpY2FsIHRpbGVzZXQuXG4gICAqL1xuICBnZXQgdGlsZXNldCgpOiBUaWxlc2V0IHtcbiAgICByZXR1cm4gdGhpcy5yb20udGlsZXNldHNbdGhpcy50aWxlc2V0SWRdO1xuICB9XG5cbiAgZ2V0IGVtcHR5KCk6IE1ldGFzY3JlZW4ge1xuICAgIGNvbnN0IGUgPSB0aGlzLmNhY2hlLmVtcHR5O1xuICAgIGlmICghZSkgdGhyb3cgbmV3IEVycm9yKGBObyBlbXB0eSBzY3JlZW4gZm9yICR7dGhpcy5uYW1lfWApO1xuICAgIHJldHVybiBlO1xuICB9XG5cbiAgZ2V0IGV4aXQoKTogTWV0YXNjcmVlbiB7XG4gICAgcmV0dXJuIHRoaXMucm9tLm1ldGFzY3JlZW5zLmV4aXQ7XG4gIH1cblxuICAvLyBUT0RPIC0gdXNlIEVNUFRZIGFzIGEgYm9yZGVyIHNxdWFyZS4uLiBhbHNvIG5lZWRcbiAgLy8gYW4gRVhJVCBib3JkZXIgc3F1YXJlPyAgSG93IHRvIGxpbmsgdGhpcyBpbnRvXG4gIC8vIFwiYWxsb3dlZFwiPyAgbmVlZHMgdG8gbGluayB0byBjaGVjayBleGl0cyBvbiBlZGdlLlxuICAvLyAgIC0gc28gc3RpbGwgcHJvYmFibHkgd2FudCBhbiBFWElUIG1ldGFzY3JlZW4/XG5cbiAgZWZmZWN0cygpOiBUaWxlRWZmZWN0cyB7XG4gICAgcmV0dXJuIHRoaXMudGlsZXNldC5lZmZlY3RzKCk7XG4gIH1cblxuICAvLyBGb3J3YXJkIHRvIHRoZSB1bmRlcmx5aW5nIFRpbGVzZXQuXG4gIGdldFRpbGUoaWQ6IG51bWJlcik6IE1ldGF0aWxlIHtcbiAgICByZXR1cm4gdGhpcy50aWxlc2V0LmdldFRpbGUoaWQpO1xuICB9XG5cbiAgYWRkU2NyZWVuKHNjcmVlbjogTWV0YXNjcmVlbikge1xuICAgIHRoaXMuX3NjcmVlbnMuYWRkKHNjcmVlbik7XG4gICAgc2NyZWVuLnVuc2FmZUFkZFRpbGVzZXQodGhpcyk7XG4gICAgdGhpcy5pbnZhbGlkYXRlKCk7XG4gIH1cblxuICBkZWxldGVTY3JlZW4oc2NyZWVuOiBNZXRhc2NyZWVuKSB7XG4gICAgdGhpcy5fc2NyZWVucy5kZWxldGUoc2NyZWVuKTtcbiAgICBzY3JlZW4udW5zYWZlUmVtb3ZlVGlsZXNldCh0aGlzKTtcbiAgICB0aGlzLmludmFsaWRhdGUoKTtcbiAgfVxuXG4gIGdldE1ldGFzY3JlZW5zKHNjcmVlbklkOiBudW1iZXIpOiBSZWFkb25seVNldDxNZXRhc2NyZWVuPiB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuZnJvbUlkLmdldChzY3JlZW5JZCkgPz8gRU1QVFlfU0VUO1xuICB9XG5cbiAgLyoqXG4gICAqIEludmFsaWRhdGUgdGhlIG5laWdoYm9yIGNhY2hlLiAgVGhpcyBpcyBuZWNlc3NhcnkgYW55IHRpbWUgdGhlXG4gICAqIHNjcmVlbnMgY2hhbmdlLlxuICAgKi9cbiAgaW52YWxpZGF0ZSgpIHtcbiAgICB0aGlzLl9jYWNoZSA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNoZWNrKHMxOiBVaWQsIHMyOiBVaWQsIGRlbHRhOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGUuYWxsb3dlZFtkZWx0YSAmIDFdOyAgLy8gdmVydGljYWwgPSAwLCBob3JpeiA9IDFcbiAgICBjb25zdCBpbmRleCA9IGRlbHRhID4gMCA/IHMxIDw8IDE2IHwgczIgOiBzMiA8PCAxNiB8IHMxO1xuICAgIHJldHVybiBjYWNoZS5oYXMoaW5kZXgpO1xuICB9XG59XG5cbmludGVyZmFjZSBNZXRhdGlsZXNldERhdGEge1xuICBwYXR0ZXJucz86IHJlYWRvbmx5IFtudW1iZXIsIG51bWJlcl07XG4gIGFuaW1hdGVkPzogcmVhZG9ubHkgbnVtYmVyW107XG4gIGNvbnNvbGlkYXRlZD86IGJvb2xlYW47XG59XG5cbmNvbnN0IEVNUFRZX1NFVDogU2V0PGFueT4gPSBuZXcgY2xhc3MgZXh0ZW5kcyBTZXQge1xuICBhZGQoKTogdGhpcyB7IHRocm93IG5ldyBFcnJvcigpOyB9XG59XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFNwZWNpYWxpemVkIGNhY2hlIG9mIG5laWdoYm9ycy9yZWxhdGlvbnNoaXBzIGluIGEgdGlsZXNldC5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiBcbmV4cG9ydCB0eXBlIERpciA9IDB8MXwyfDM7XG5cbmV4cG9ydCBuYW1lc3BhY2UgRGlyIHtcbiAgZXhwb3J0IGNvbnN0IE46IERpciA9IDA7XG4gIGV4cG9ydCBjb25zdCBXOiBEaXIgPSAxO1xuICBleHBvcnQgY29uc3QgUzogRGlyID0gMjtcbiAgZXhwb3J0IGNvbnN0IEU6IERpciA9IDM7XG59XG5cbi8vIG11c3QgYmUgMTYgYml0cyAoNjUwMDAgc2NyZWVucyBpcyBwbGVudHkpXG50eXBlIFVpZCA9IG51bWJlcjtcbi8vIChhLCBiKSAtPiAoYSA8PCAxNiB8IGIpXG50eXBlIFVpZFBhaXIgPSBudW1iZXI7XG4vLyAodWlkLCBkaXIpIC0+ICh1aWQgPDwgMiB8IGRpcilcbnR5cGUgVWlkRGlyID0gbnVtYmVyO1xuXG5jbGFzcyBOZWlnaGJvckNhY2hlIHtcbiAgLy8gW3ZlcnRpY2FsLCBob3Jpem9udGFsXSwgaW5kZXhlZCBieSBkaXIgJiAxXG4gIHJlYWRvbmx5IGFsbG93ZWQgPSBbbmV3IFNldDxVaWRQYWlyPigpLCBuZXcgU2V0PFVpZFBhaXI+KCldIGFzIGNvbnN0O1xuICByZWFkb25seSBuZWlnaGJvcnMgPSBuZXcgRGVmYXVsdE1hcDxVaWREaXIsIFNldDxVaWQ+PigoKSA9PiBuZXcgU2V0KCkpO1xuICByZWFkb25seSBmcm9tSWQgPSBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIFNldDxNZXRhc2NyZWVuPj4oKCkgPT4gbmV3IFNldCgpKTtcbiAgcmVhZG9ubHkgZW1wdHk6IE1ldGFzY3JlZW47XG4gIC8vIHByaXZhdGUgcmVhZG9ubHkgdG9nZ2xlcyA9IG5ldyBEZWZhdWx0TWFwPFVpZERpciwgU2V0PFVpZD4+KCgpID0+IG5ldyBTZXQpO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHRpbGVzZXQ6IE1ldGF0aWxlc2V0KSB7XG4gICAgbGV0IGVtcHR5OiBNZXRhc2NyZWVufHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICBmb3IgKGNvbnN0IHMxIG9mIGl0ZXJzLmNvbmNhdCh0aWxlc2V0LCBbdGlsZXNldC5leGl0XSkpIHtcbiAgICAgIC8vIFJlZ2lzdGVyIGluIHRoZSBmcm9tSWQgbXVsdGltYXBcbiAgICAgIGlmIChzMS5pZCA+PSAwKSB0aGlzLmZyb21JZC5nZXQoczEuaWQpLmFkZChzMSk7XG4gICAgICAvLyBDaGVjayBmb3IgZW1wdHlcbiAgICAgIGlmICghZW1wdHkgJiZcbiAgICAgICAgICBzMS5kYXRhLmVkZ2VzID09PSAnICAgICcgJiZcbiAgICAgICAgICBzMS5oYXNGZWF0dXJlKCdlbXB0eScpICYmXG4gICAgICAgICAgIXMxLmRhdGEuZXhpdHM/Lmxlbmd0aCkge1xuICAgICAgICBlbXB0eSA9IHMxO1xuICAgICAgfVxuICAgICAgLy8gUmVnaXN0ZXIgdGhlIHNjcmVlbiBwYWlyc1xuICAgICAgY29uc3QgZTEgPSBzMS5kYXRhLmVkZ2VzIHx8ICcqKioqJztcbiAgICAgIGZvciAoY29uc3QgczIgb2YgaXRlcnMuY29uY2F0KHRpbGVzZXQsIFt0aWxlc2V0LmV4aXRdKSkge1xuICAgICAgICAvLyBCYXNpYyBpZGVhOiBjb21wYXJlIHRoZSBlZGdlcy4gIEJ1dCB3ZSBuZWVkIGEgd2F5IHRvIG92ZXJyaWRlP1xuICAgICAgICAvLyBTcGVjaWZpY2FsbHksIGlmIHRoZXJlJ3MgYSAqIHRoZW4gY2FsbCBhIG1ldGhvZD8gIFdoYXQgYWJvdXRcbiAgICAgICAgLy8gYWxsb3dpbmcgKHNheSkgbm9ybWFsIGNhdmUgdy8gbmFycm93P1xuICAgICAgICBjb25zdCBlMiA9IHMyLmRhdGEuZWRnZXMgfHwgJyoqKionO1xuICAgICAgICBpZiAoZTFbMl0gIT09ICcqJyAmJiBlMVsyXSA9PT0gZTJbMF0pIHtcbiAgICAgICAgICB0aGlzLmFkZChEaXIuUywgczEsIHMyKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZTFbM10gIT09ICcqJyAmJiBlMVszXSA9PT0gZTJbMV0pIHtcbiAgICAgICAgICB0aGlzLmFkZChEaXIuRSwgczEsIHMyKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBNYXliZSBjYWxsIGEgbWV0aG9kIGlmIGl0J3MgdGhlcmU/XG4gICAgICAgIGZvciAoY29uc3QgZGlyIG9mIChzMS5kYXRhLmFsbG93ZWQgPyBzMS5kYXRhLmFsbG93ZWQoczIpIDogW10pKSB7XG4gICAgICAgICAgdGhpcy5hZGQoZGlyLCBzMSwgczIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZW1wdHkgPSBlbXB0eSA/PyB0aWxlc2V0LnJvbS5tZXRhc2NyZWVucy5jYXZlRW1wdHk7XG4gIH1cblxuICBwcml2YXRlIGFkZChkaXI6IERpciwgczE6IE1ldGFzY3JlZW4sIHMyOiBNZXRhc2NyZWVuKSB7XG4gICAgY29uc3QgdTEgPSBzMS51aWQ7XG4gICAgY29uc3QgdTIgPSBzMi51aWQ7XG4gICAgdGhpcy5hbGxvd2VkW2RpciAmIDFdLmFkZChkaXIgJiAyID8gdTEgPDwgMTYgfCB1MiA6IHUyIDw8IDE2IHwgdTEpO1xuICAgIHRoaXMubmVpZ2hib3JzLmdldCh1MSA8PCAyIHwgZGlyKS5hZGQodTIpO1xuICAgIHRoaXMubmVpZ2hib3JzLmdldCh1MiA8PCAyIHwgKGRpciBeIDIpKS5hZGQodTEpO1xuICB9XG5cbiAgLy8gVE9ETyAtIHdoYXQgdG8gZG8gd2l0aCBib3JkZXJzPyE/IENhbiB3ZSB0cmVhdCB0aGVtIGxpa2UgYSBzY3JlZW4/XG4gIC8vIFRoZSBtYWluIHRoaW5nIHRoYXQgbWF0dGVycyBmb3IgYm9yZGVycyBpcyB3aGV0aGVyIGl0J3MgYW4gZWRnZSBleGl0XG4gIC8vIG9yIG5vdC4gIFdlIGNhbiBhbHJlYWR5IHRyYWNrIHRoaXMgYSBiaXQgLSB3ZSBjb3VsZCBoYXZlIGEgbGlzdCBvZlxuICAvLyBhY2NlcHRhYmxlIGVkZ2UgdHlwZXMgZm9yIGVhY2ggdGlsZXNldCAtIFwiIG5cIiBtb3N0IGxpa2VseSwgZXhjZXB0IGZvclxuICAvLyBzd2FtcCAoXCIgbnNcIj8pICBXZSBzaG91bGQgZ28gdGhydSBhbmQgbWFrZSBzdXJlIHRoZXJlJ3Mgbm8gcmV1c2Ugb2ZcbiAgLy8gZWRnZSB0eXBlcyBpbiBpbmNvbnNpc3RlbnQgd2F5cyAoZS5nLiAndicgZm9yIGJvdGggZ3Jhc3MgYW5kIGJvdW5kYXJ5KVxufVxuIl19