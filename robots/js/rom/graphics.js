import { DefaultMap } from '../util.js';
import { ACTION_SCRIPTS, Monster } from './monster.js';
import { Constraint } from './constraint.js';
export class Graphics {
    constructor(rom) {
        this.rom = rom;
        this.monsterConstraints = new Map();
        this.npcConstraints = new Map();
        this.allSpritePalettes = new Set();
        const allSpawns = new DefaultMap(() => []);
        for (const l of rom.locations) {
            if (!l.used)
                continue;
            for (let i = 0; i < l.spawns.length; i++) {
                const s = l.spawns[i];
                if (!s.used)
                    continue;
                if (s.isMonster()) {
                    allSpawns.get(s.monsterId).push([l, i, s]);
                }
                else if (s.isNpc() || s.isBoss()) {
                    allSpawns.get(~s.id).push([l, i, s]);
                }
            }
        }
        for (const [m, spawns] of allSpawns) {
            if (m < 0) {
                const npc = rom.npcs[~m];
                const metaspriteIds = [npc.data[3]];
                const metasprite = rom.metasprites[metaspriteIds[0]];
                if (!metasprite)
                    throw new Error(`bad NPC: ${~m}`);
                if (npc.data[2] === 0xd0)
                    metaspriteIds.push(0xc0);
                const offset = npc.data[2] < 0x80 ? npc.data[2] & 0x70 : 0;
                let constraint = this.computeConstraint(metaspriteIds, spawns, true, offset);
                if (~m === 0x5f)
                    constraint = constraint.ignorePalette();
                this.npcConstraints.set(~m, constraint);
            }
            else {
                let constraint = Constraint.ALL;
                const parent = this.rom.objects[m];
                if (!(parent instanceof Monster)) {
                    throw new Error(`expected monster: ${parent} from ${spawns}`);
                }
                for (const obj of allObjects(rom, parent)) {
                    const action = ACTION_SCRIPTS.get(obj.action);
                    const metaspriteFn = action && action.metasprites || (() => [obj.metasprite]);
                    const child = this.computeConstraint(metaspriteFn(obj), spawns, obj.id === m, obj.data[1]);
                    const meet = constraint.meet(child);
                    if (!meet)
                        throw new Error(`Bad meet for ${m} with ${obj.id}`);
                    if (meet)
                        constraint = meet;
                    if (obj.data[4] & 0x02) {
                        const child2 = this.computeConstraint([obj.data[0x14]], spawns, false, obj.data[1]);
                        const meet2 = constraint.meet(child2);
                        if (!meet2)
                            throw new Error(`Bad meet for ${m} bonus ${obj.id}`);
                        constraint = meet2;
                    }
                }
                this.monsterConstraints.set(parent.id, constraint);
                parent.constraint = constraint;
            }
        }
    }
    getMonsterConstraint(locationId, monsterId) {
        const c = this.monsterConstraints.get(monsterId) || Constraint.NONE;
        if ((locationId & 0x58) === 0x58)
            return c;
        const m = null;
        if (!m)
            return c;
        return c.meet(Constraint.COIN) || Constraint.NONE;
    }
    getNpcConstraint(locationId, npcId) {
        const c = this.npcConstraints.get(npcId) || Constraint.NONE;
        if (locationId === 0x1e && npcId === 0x60) {
            return c.meet(Constraint.STOM_FIGHT);
        }
        else if (locationId === 0xa0 && npcId === 0xc9) {
            return c.meet(Constraint.GUARDIAN_STATUE);
        }
        return c;
    }
    shufflePalettes(random) {
        const pal = [...this.allSpritePalettes];
        for (const [k, c] of this.monsterConstraints) {
            this.monsterConstraints.set(k, c.shufflePalette(random, pal));
        }
        for (const [k, c] of this.npcConstraints) {
            this.npcConstraints.set(k, c.shufflePalette(random, pal));
        }
    }
    configure(location, spawn) {
        if (!spawn.used)
            return;
        const c = spawn.isMonster() ? this.monsterConstraints.get(spawn.monsterId) :
            spawn.isNpc() ? this.npcConstraints.get(spawn.id) :
                spawn.isChest() ? (spawn.id < 0x70 ? Constraint.TREASURE_CHEST :
                    Constraint.MIMIC) :
                    undefined;
        if (!c)
            return;
        if (c.shift === 3 || c.float.length >= 2) {
            throw new Error(`don't know what to do with two floats`);
        }
        else if (!c.float.length) {
            spawn.patternBank = Number(c.shift === 2);
        }
        else if (c.float[0].has(location.spritePatterns[0])) {
            spawn.patternBank = 0;
        }
        else if (c.float[0].has(location.spritePatterns[1])) {
            spawn.patternBank = 1;
        }
        else if (spawn.isMonster()) {
            throw new Error(`no matching pattern bank`);
        }
    }
    computeConstraint(metaspriteIds, spawns, shiftable, offset = 0) {
        const patterns = new Set();
        const palettes = new Set();
        for (const metasprite of metaspriteIds.map(s => this.rom.metasprites[s])) {
            for (const p of metasprite.palettes()) {
                palettes.add(p);
            }
            for (const p of metasprite.patternBanks(offset)) {
                patterns.add(p);
            }
        }
        shiftable = shiftable && patterns.size == 1 && [...patterns][0] === 2;
        const locs = new Map();
        for (const [l, , spawn] of spawns) {
            locs.set(spawn.patternBank && shiftable ? ~l.id : l.id, spawn);
        }
        let child = undefined;
        for (let [l, spawn] of locs) {
            const loc = this.rom.locations[l < 0 ? ~l : l];
            for (const pal of palettes) {
                if (pal > 1)
                    this.allSpritePalettes.add(loc.spritePalettes[pal - 2]);
            }
            const c = Constraint.fromSpawn(palettes, patterns, loc, spawn, shiftable);
            child = child ? child.join(c) : c;
            if (!shiftable && spawn.patternBank)
                child = child.shifted();
        }
        if (!child)
            throw new Error(`Expected child to appear`);
        return child;
    }
}
function* allObjects(rom, parent) {
    yield parent;
    const repl = parent.spawnedReplacement();
    if (repl)
        yield* allObjects(rom, repl);
    const child = parent.spawnedChild();
    if (child)
        yield* allObjects(rom, child);
    if (parent.id === 0x50)
        yield rom.objects[0x5f];
    if (parent.id === 0x53)
        yield rom.objects[0x69];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL2dyYXBoaWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFFdEMsT0FBTyxFQUFDLGNBQWMsRUFBRSxPQUFPLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDckQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBUTNDLE1BQU0sT0FBTyxRQUFRO0lBT25CLFlBQXFCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBTHJCLHVCQUFrQixHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQ25ELG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFFdkQsc0JBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUtwQyxNQUFNLFNBQVMsR0FDWCxJQUFJLFVBQVUsQ0FBb0QsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFaEYsS0FBSyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQzdCLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSTtnQkFBRSxTQUFTO1lBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJO29CQUFFLFNBQVM7Z0JBQ3RCLElBQUksQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO29CQUNqQixTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFF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TUFBTSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDekMsSUFBSSxJQUFJO1FBQUUsS0FBSyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN2QyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDcEMsSUFBSSxLQUFLO1FBQUUsS0FBSyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQU16QyxJQUFJLE1BQU0sQ0FBQyxFQUFFLEtBQUssSUFBSTtRQUFFLE1BQU0sR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQVksQ0FBQztJQUMzRCxJQUFJLE1BQU0sQ0FBQyxFQUFFLEtBQUssSUFBSTtRQUFFLE1BQU0sR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQVksQ0FBQztBQUM3RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0RlZmF1bHRNYXB9IGZyb20gJy4uL3V0aWwuanMnO1xuaW1wb3J0IHtMb2NhdGlvbiwgU3Bhd259IGZyb20gJy4vbG9jYXRpb24uanMnO1xuaW1wb3J0IHtBQ1RJT05fU0NSSVBUUywgTW9uc3Rlcn0gZnJvbSAnLi9tb25zdGVyLmpzJztcbmltcG9ydCB7Q29uc3RyYWludH0gZnJvbSAnLi9jb25zdHJhaW50LmpzJztcbmltcG9ydCB7UmFuZG9tfSBmcm9tICcuLi9yYW5kb20uanMnO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbi8vIFRoaXMgYWN0dWFsbHkgYXBwZWFycyB0byBiZSBtb3JlIG9mIGEgR3JhcGhpY3NDb25zdHJhaW50cyBjbGFzcz9cbi8vICAgLSBtYXliZSBkb24ndCBzdG9yZSB0aGUgY29uc3RyYWludHMgb24gTW9uc3Rlcj9cblxuZXhwb3J0IGNsYXNzIEdyYXBoaWNzIHtcblxuICBwcml2YXRlIG1vbnN0ZXJDb25zdHJhaW50cyA9IG5ldyBNYXA8bnVtYmVyLCBDb25zdHJhaW50PigpO1xuICBwcml2YXRlIG5wY0NvbnN0cmFpbnRzID0gbmV3IE1hcDxudW1iZXIsIENvbnN0cmFpbnQ+KCk7XG5cbiAgYWxsU3ByaXRlUGFsZXR0ZXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSkge1xuICAgIC8vIEl0ZXJhdGUgb3ZlciBsb2NhdGlvbnMvc3Bhd25zIHRvIGJ1aWxkIG11bHRpbWFwIG9mIHdoZXJlIG1vbnN0ZXJzIGFwcGVhci5cbiAgICAvLyBQb3N0aXZlIGtleXMgYXJlIG1vbnN0ZXJzLCBuZWdhdGl2ZSBrZXlzIGFyZSBOUENzLlxuICAgIGNvbnN0IGFsbFNwYXducyA9XG4gICAgICAgIG5ldyBEZWZhdWx0TWFwPG51bWJlciwgQXJyYXk8cmVhZG9ubHkgW0xvY2F0aW9uLCBudW1iZXIsIFNwYXduXT4+KCgpID0+IFtdKTtcblxuICAgIGZvciAoY29uc3QgbCBvZiByb20ubG9jYXRpb25zKSB7XG4gICAgICBpZiAoIWwudXNlZCkgY29udGludWU7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwuc3Bhd25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHMgPSBsLnNwYXduc1tpXTtcbiAgICAgICAgaWYgKCFzLnVzZWQpIGNvbnRpbnVlO1xuICAgICAgICBpZiAocy5pc01vbnN0ZXIoKSkge1xuICAgICAgICAgIGFsbFNwYXducy5nZXQocy5tb25zdGVySWQpLnB1c2goW2wsIGksIHNdKTtcbiAgICAgICAgfSBlbHNlIGlmIChzLmlzTnBjKCkgfHwgcy5pc0Jvc3MoKSkge1xuICAgICAgICAgIGFsbFNwYXducy5nZXQofnMuaWQpLnB1c2goW2wsIGksIHNdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICAvLyBGb3IgZWFjaCBtb25zdGVyLCBkZXRlcm1pbmUgd2hpY2ggcGF0dGVybnMgYW5kIHBhbGV0dGVzIGFyZSB1c2VkLlxuICAgIGZvciAoY29uc3QgW20sIHNwYXduc10gb2YgYWxsU3Bhd25zKSB7XG4gICAgICAvLyBUT0RPIC0gZm9sZCBpbnRvIHBhdGNoLnNodWZmbGVNb25zdGVyc1xuICAgICAgLy9pZiAobSA9PT0gMCkgY29udGludWU7IC8vIHVzZWQgdG8gc3VwcHJlc3MgYnVnZ3kgc3RyYXkgc3Bhd25zXG4gICAgICBpZiAobSA8IDApIHsgLy8gTlBDXG4gICAgICAgIGNvbnN0IG5wYyA9IHJvbS5ucGNzW35tXTtcbiAgICAgICAgY29uc3QgbWV0YXNwcml0ZUlkcyA9IFtucGMuZGF0YVszXV07XG4gICAgICAgIGNvbnN0IG1ldGFzcHJpdGUgPSByb20ubWV0YXNwcml0ZXNbbWV0YXNwcml0ZUlkc1swXV07XG4gICAgICAgIGlmICghbWV0YXNwcml0ZSkgdGhyb3cgbmV3IEVycm9yKGBiYWQgTlBDOiAke35tfWApO1xuICAgICAgICAvLyBIYXJkY29kZSBleGNlcHRpb24gZm9yIGp1bXBpbmcgbWFuIChhY3Rpb24gc2NyaXB0ICQ1MClcbiAgICAgICAgaWYgKG5wYy5kYXRhWzJdID09PSAweGQwKSBtZXRhc3ByaXRlSWRzLnB1c2goMHhjMCk7XG4gICAgICAgIC8vIENvbXB1dGUgY29uc3RyYWludFxuICAgICAgICBjb25zdCBvZmZzZXQgPSBucGMuZGF0YVsyXSA8IDB4ODAgPyBucGMuZGF0YVsyXSAmIDB4NzAgOiAwO1xuICAgICAgICBsZXQgY29uc3RyYWludCA9XG4gICAgICAgICAgICB0aGlzLmNvbXB1dGVDb25zdHJhaW50KG1ldGFzcHJpdGVJZHMsIHNwYXducywgdHJ1ZSwgb2Zmc2V0KTtcbiAgICAgICAgLy8gVE9ETyAtIGJldHRlciB3YXkgc3RyZWFtbGluZSB0aGlzLi4uPyAodG9ybmVsIG9uIHNhYnJlKVxuICAgICAgICBpZiAofm0gPT09IDB4NWYpIGNvbnN0cmFpbnQgPSBjb25zdHJhaW50Lmlnbm9yZVBhbGV0dGUoKTtcbiAgICAgICAgdGhpcy5ucGNDb25zdHJhaW50cy5zZXQofm0sIGNvbnN0cmFpbnQpO1xuICAgICAgfSBlbHNlIHsgLy8gbW9uc3RlclxuICAgICAgICBsZXQgY29uc3RyYWludCA9IENvbnN0cmFpbnQuQUxMO1xuICAgICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLnJvbS5vYmplY3RzW21dO1xuICAgICAgICBpZiAoIShwYXJlbnQgaW5zdGFuY2VvZiBNb25zdGVyKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZXhwZWN0ZWQgbW9uc3RlcjogJHtwYXJlbnR9IGZyb20gJHtzcGF3bnN9YCk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBvYmogb2YgYWxsT2JqZWN0cyhyb20sIHBhcmVudCkpIHtcbiAgICAgICAgICBjb25zdCBhY3Rpb24gPSBBQ1RJT05fU0NSSVBUUy5nZXQob2JqLmFjdGlvbik7XG4gICAgICAgICAgY29uc3QgbWV0YXNwcml0ZUZuOiAobTogTW9uc3RlcikgPT4gcmVhZG9ubHkgbnVtYmVyW10gPVxuICAgICAgICAgICAgICBhY3Rpb24gJiYgYWN0aW9uLm1ldGFzcHJpdGVzIHx8ICgoKSA9PiBbb2JqLm1ldGFzcHJpdGVdKTtcbiAgICAgICAgICBjb25zdCBjaGlsZCA9IHRoaXMuY29tcHV0ZUNvbnN0cmFpbnQobWV0YXNwcml0ZUZuKG9iaiksIHNwYXducyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmlkID09PSBtLCBvYmouZGF0YVsxXSk7XG4gICAgICAgICAgY29uc3QgbWVldCA9IGNvbnN0cmFpbnQubWVldChjaGlsZCk7XG4gICAgICAgICAgaWYgKCFtZWV0KSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBtZWV0IGZvciAke219IHdpdGggJHtvYmouaWR9YCk7XG4gICAgICAgICAgaWYgKG1lZXQpIGNvbnN0cmFpbnQgPSBtZWV0O1xuICAgICAgICAgIC8vIE5PVEU6IGlmICQzODAseCAmICMkMDIgdGhlbiB3ZSBkcmF3IGEgYm9udXMgc3ByaXRlIChlLmcuXG4gICAgICAgICAgLy8gbW9zcXVpdG8gd2luZ3MpIGZyb20gJDU4MCx4IHdpdGggbm8gc2hpZnQuXG4gICAgICAgICAgaWYgKG9iai5kYXRhWzRdICYgMHgwMikge1xuICAgICAgICAgICAgY29uc3QgY2hpbGQyID0gdGhpcy5jb21wdXRlQ29uc3RyYWludChbb2JqLmRhdGFbMHgxNF1dLCBzcGF3bnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlLCBvYmouZGF0YVsxXSk7XG4gICAgICAgICAgICBjb25zdCBtZWV0MiA9IGNvbnN0cmFpbnQubWVldChjaGlsZDIpO1xuICAgICAgICAgICAgaWYgKCFtZWV0MikgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWVldCBmb3IgJHttfSBib251cyAke29iai5pZH1gKTtcbiAgICAgICAgICAgIGNvbnN0cmFpbnQgPSBtZWV0MjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tb25zdGVyQ29uc3RyYWludHMuc2V0KHBhcmVudC5pZCwgY29uc3RyYWludCk7XG4gICAgICAgIHBhcmVudC5jb25zdHJhaW50ID0gY29uc3RyYWludDsgIC8vIGZvciBkZWJ1Z2dpbmdcbiAgICAgIH1cbiAgICB9ICAgIFxuICB9XG5cbiAgZ2V0TW9uc3RlckNvbnN0cmFpbnQobG9jYXRpb25JZDogbnVtYmVyLCBtb25zdGVySWQ6IG51bWJlcik6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IGMgPSB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cy5nZXQobW9uc3RlcklkKSB8fCBDb25zdHJhaW50Lk5PTkU7XG4gICAgaWYgKChsb2NhdGlvbklkICYgMHg1OCkgPT09IDB4NTgpIHJldHVybiBjO1xuICAgIGNvbnN0IG0gPSBudWxsOyAvLyB0aGlzLnJvbS5vYmplY3RzW21vbnN0ZXJJZF0uZ29sZERyb3A7XG4gICAgaWYgKCFtKSByZXR1cm4gYztcbiAgICByZXR1cm4gYy5tZWV0KENvbnN0cmFpbnQuQ09JTikgfHwgQ29uc3RyYWludC5OT05FO1xuICB9XG5cbiAgZ2V0TnBjQ29uc3RyYWludChsb2NhdGlvbklkOiBudW1iZXIsIG5wY0lkOiBudW1iZXIpOiBDb25zdHJhaW50IHtcbiAgICBjb25zdCBjID0gdGhpcy5ucGNDb25zdHJhaW50cy5nZXQobnBjSWQpIHx8IENvbnN0cmFpbnQuTk9ORTtcbiAgICBpZiAobG9jYXRpb25JZCA9PT0gMHgxZSAmJiBucGNJZCA9PT0gMHg2MCkge1xuICAgICAgLy8gVE9ETzogY2hhbmdlIHRoaXMgdG8gYWN0dWFsbHkgbG9vayBhdCB0aGUgbG9jYXRpb24ncyB0cmlnZ2Vycz9cbiAgICAgIHJldHVybiBjLm1lZXQoQ29uc3RyYWludC5TVE9NX0ZJR0hUKTtcbiAgICB9IGVsc2UgaWYgKGxvY2F0aW9uSWQgPT09IDB4YTAgJiYgbnBjSWQgPT09IDB4YzkpIHtcbiAgICAgIHJldHVybiBjLm1lZXQoQ29uc3RyYWludC5HVUFSRElBTl9TVEFUVUUpO1xuICAgIH1cbiAgICByZXR1cm4gYztcbiAgfVxuXG4gIHNodWZmbGVQYWxldHRlcyhyYW5kb206IFJhbmRvbSk6IHZvaWQge1xuICAgIGNvbnN0IHBhbCA9IFsuLi50aGlzLmFsbFNwcml0ZVBhbGV0dGVzXTtcbiAgICBmb3IgKGNvbnN0IFtrLCBjXSBvZiB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cykge1xuICAgICAgdGhpcy5tb25zdGVyQ29uc3RyYWludHMuc2V0KGssIGMuc2h1ZmZsZVBhbGV0dGUocmFuZG9tLCBwYWwpKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBbaywgY10gb2YgdGhpcy5ucGNDb25zdHJhaW50cykge1xuICAgICAgdGhpcy5ucGNDb25zdHJhaW50cy5zZXQoaywgYy5zaHVmZmxlUGFsZXR0ZShyYW5kb20sIHBhbCkpO1xuICAgIH1cbiAgfVxuXG4gIGNvbmZpZ3VyZShsb2NhdGlvbjogTG9jYXRpb24sIHNwYXduOiBTcGF3bikge1xuICAgIGlmICghc3Bhd24udXNlZCkgcmV0dXJuO1xuICAgIGNvbnN0IGMgPSBzcGF3bi5pc01vbnN0ZXIoKSA/IHRoaXMubW9uc3RlckNvbnN0cmFpbnRzLmdldChzcGF3bi5tb25zdGVySWQpIDpcbiAgICAgICAgc3Bhd24uaXNOcGMoKSA/IHRoaXMubnBjQ29uc3RyYWludHMuZ2V0KHNwYXduLmlkKSA6XG4gICAgICAgIHNwYXduLmlzQ2hlc3QoKSA/IChzcGF3bi5pZCA8IDB4NzAgPyBDb25zdHJhaW50LlRSRUFTVVJFX0NIRVNUIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbnN0cmFpbnQuTUlNSUMpIDpcbiAgICAgICAgdW5kZWZpbmVkO1xuICAgIGlmICghYykgcmV0dXJuO1xuICAgIGlmIChjLnNoaWZ0ID09PSAzIHx8IGMuZmxvYXQubGVuZ3RoID49IDIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgZG9uJ3Qga25vdyB3aGF0IHRvIGRvIHdpdGggdHdvIGZsb2F0c2ApO1xuICAgIH0gZWxzZSBpZiAoIWMuZmxvYXQubGVuZ3RoKSB7XG4gICAgICBzcGF3bi5wYXR0ZXJuQmFuayA9IE51bWJlcihjLnNoaWZ0ID09PSAyKTtcbiAgICB9IGVsc2UgaWYgKGMuZmxvYXRbMF0uaGFzKGxvY2F0aW9uLnNwcml0ZVBhdHRlcm5zWzBdKSkge1xuICAgICAgc3Bhd24ucGF0dGVybkJhbmsgPSAwO1xuICAgIH0gZWxzZSBpZiAoYy5mbG9hdFswXS5oYXMobG9jYXRpb24uc3ByaXRlUGF0dGVybnNbMV0pKSB7XG4gICAgICBzcGF3bi5wYXR0ZXJuQmFuayA9IDE7XG4gICAgfSBlbHNlIGlmIChzcGF3bi5pc01vbnN0ZXIoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBubyBtYXRjaGluZyBwYXR0ZXJuIGJhbmtgKTtcbiAgICB9XG4gIH1cblxuICBjb21wdXRlQ29uc3RyYWludChtZXRhc3ByaXRlSWRzOiByZWFkb25seSBudW1iZXJbXSxcbiAgICAgICAgICAgICAgICAgICAgc3Bhd25zOiBTcGF3bnMsXG4gICAgICAgICAgICAgICAgICAgIHNoaWZ0YWJsZTogYm9vbGVhbixcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gMCk6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IHBhdHRlcm5zID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgY29uc3QgcGFsZXR0ZXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBmb3IgKGNvbnN0IG1ldGFzcHJpdGUgb2YgbWV0YXNwcml0ZUlkcy5tYXAocyA9PiB0aGlzLnJvbS5tZXRhc3ByaXRlc1tzXSkpIHtcbiAgICAgIC8vIFdoaWNoIHBhbGV0dGUgYW5kIHBhdHRlcm4gYmFua3MgYXJlIHJlZmVyZW5jZWQ/XG4gICAgICBmb3IgKGNvbnN0IHAgb2YgbWV0YXNwcml0ZS5wYWxldHRlcygpKSB7XG4gICAgICAgIHBhbGV0dGVzLmFkZChwKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgcCBvZiBtZXRhc3ByaXRlLnBhdHRlcm5CYW5rcyhvZmZzZXQpKSB7XG4gICAgICAgIHBhdHRlcm5zLmFkZChwKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBvYmoudXNlZFBhbGV0dGVzID0gWy4uLnBhbGV0dGVzXTtcbiAgICAvLyBvYmoudXNlZFBhdHRlcm5zID0gWy4uLnBhdHRlcm5zXTtcblxuICAgIC8vIElmIG9ubHkgdGhpcmQtYmFuayBwYXR0ZXJucyBhcmUgdXNlZCwgdGhlbiB0aGUgbWV0YXNwcml0ZSBjYW4gYmVcbiAgICAvLyBzaGlmdGVkIHRvIGZvdXJ0aCBiYW5rIHdoZW4gbmVjZXNzYXJ5LiAgVGhpcyBpcyBvbmx5IHRydWUgZm9yIE5QQ1xuICAgIC8vIHNwYXducy4gIEFkIGhvYyBzcGF3bnMgY2Fubm90IGJlIHNoaWZ0ZWQgKHlldD8pLlxuICAgIHNoaWZ0YWJsZSA9IHNoaWZ0YWJsZSAmJiBwYXR0ZXJucy5zaXplID09IDEgJiYgWy4uLnBhdHRlcm5zXVswXSA9PT0gMjtcblxuICAgIC8vIElmIHRoZSBzcGF3biBzZXRzIHBhdHRlcm5CYW5rIHRoZW4gd2UgbmVlZCB0byBpbmNyZW1lbnQgZWFjaCBwYXR0ZXJuLlxuICAgIC8vIFdlIGhhdmUgdGhlIGZyZWVkb20gdG8gc2V0IHRoaXMgdG8gZWl0aGVyLCBkZXBlbmRpbmcuXG4gICAgY29uc3QgbG9jcyA9IG5ldyBNYXA8bnVtYmVyLCBTcGF3bj4oKTtcbiAgICBmb3IgKGNvbnN0IFtsLCAsIHNwYXduXSBvZiBzcGF3bnMpIHtcbiAgICAgIGxvY3Muc2V0KHNwYXduLnBhdHRlcm5CYW5rICYmIHNoaWZ0YWJsZSA/IH5sLmlkIDogbC5pZCwgc3Bhd24pO1xuICAgIH1cblxuICAgIC8vIFRPRE8gLSBDb25zdHJhaW50QnVpbGRlclxuICAgIC8vICAgLS0ga2VlcHMgdHJhY2sgb25seSBvZiByZWxldmFudCBmYWN0b3JzLCBpbiBhIGpvaW4uXG4gICAgLy8gICAgICAtLT4gbm8gbWVldGluZyBpbnZvbHZlZCFcbiAgICBsZXQgY2hpbGQgPSB1bmRlZmluZWQ7XG5cbiAgICBmb3IgKGxldCBbbCwgc3Bhd25dIG9mIGxvY3MpIHtcbiAgICAgIGNvbnN0IGxvYyA9IHRoaXMucm9tLmxvY2F0aW9uc1tsIDwgMCA/IH5sIDogbF07XG4gICAgICBmb3IgKGNvbnN0IHBhbCBvZiBwYWxldHRlcykge1xuICAgICAgICBpZiAocGFsID4gMSkgdGhpcy5hbGxTcHJpdGVQYWxldHRlcy5hZGQobG9jLnNwcml0ZVBhbGV0dGVzW3BhbCAtIDJdKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGMgPSBDb25zdHJhaW50LmZyb21TcGF3bihwYWxldHRlcywgcGF0dGVybnMsIGxvYywgc3Bhd24sIHNoaWZ0YWJsZSk7XG4gICAgICBjaGlsZCA9IGNoaWxkID8gY2hpbGQuam9pbihjKSA6IGM7XG4gICAgICBpZiAoIXNoaWZ0YWJsZSAmJiBzcGF3bi5wYXR0ZXJuQmFuaykgY2hpbGQgPSBjaGlsZC5zaGlmdGVkKCk7XG5cbiAgICAgIC8vIC0tLSBoYW5kbGUgc2hpZnRzIGJldHRlci4uLj8gc3VwcG9zZSBlLmcuIG11bHRpcGxlIHBhbDInc1xuICAgICAgLy8gICAgLT4gd2Ugd2FudCB0byBqb2luIHRoZW0gLSB3aWxsIGhhdmUgbXVsdGlwbGUgc2hpZnRhYmxlcy4uLlxuICAgICAgLy9jb25zdHJhaW50ID0gY29uc3RyYWludC5cbiAgICB9XG5cbiAgICAvLyBJZiB3ZSdyZSBzaGlmdGFibGUsIHNhdmUgdGhlIHNldCBvZiBwb3NzaWJsZSBzaGlmdCBiYW5rc1xuICAgIGlmICghY2hpbGQpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgY2hpbGQgdG8gYXBwZWFyYCk7XG4gICAgLy8gaWYgKGNoaWxkLmZsb2F0Lmxlbmd0aCA9PT0gMSkge1xuICAgIC8vICAgcGFyZW50LnNoaWZ0UGF0dGVybnMgPSBuZXcgU2V0KGNoaWxkLmZsb2F0WzBdKTtcbiAgICAvLyB9XG4gICAgcmV0dXJuIGNoaWxkO1xuICB9XG59XG5cbmZ1bmN0aW9uKiBhbGxPYmplY3RzKHJvbTogUm9tLCBwYXJlbnQ6IE1vbnN0ZXIpOiBJdGVyYWJsZTxNb25zdGVyPiB7XG4gIHlpZWxkIHBhcmVudDtcbiAgY29uc3QgcmVwbCA9IHBhcmVudC5zcGF3bmVkUmVwbGFjZW1lbnQoKTtcbiAgaWYgKHJlcGwpIHlpZWxkKiBhbGxPYmplY3RzKHJvbSwgcmVwbCk7XG4gIGNvbnN0IGNoaWxkID0gcGFyZW50LnNwYXduZWRDaGlsZCgpO1xuICBpZiAoY2hpbGQpIHlpZWxkKiBhbGxPYmplY3RzKHJvbSwgY2hpbGQpO1xuICAvLyBUT0RPIC0gdGhlc2UgZG9uJ3QgbWFrZSBzZW5zZSB0byBwdXQgaW4gc3Bhd25lZFJlcGxhY2VtZW50IGJlY2F1c2VcbiAgLy8gd2UgZG9uJ3Qgd2FudCB0byBvdmVyLWluZmxhdGUgcmVkIHNsaW1lcyBkdWUgdG8gZ2lhbnQgcmVkIHNsaW1lcydcbiAgLy8gZGlmZmljdWx0eSwgc2luY2UgbW9zdCBmb2xrcyB3aWxsIG5ldmVyIGhhdmUgdG8gZGVhbCB3aXRoIHRoYXQuXG4gIC8vIEJ1dCB3ZSBkbyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZXkgZ2V0IFwidW4tZmxvYXRlZFwiIHNpbmNlIHRoZVxuICAvLyByZXBsYWNlbWVudCBzcGF3biB3aWxsIG5vdCBzaGFyZSB0aGUgc2FtZSAzODA6MjAgKGZvciBub3cpLlxuICBpZiAocGFyZW50LmlkID09PSAweDUwKSB5aWVsZCByb20ub2JqZWN0c1sweDVmXSBhcyBNb25zdGVyOyAvLyBibHVlIHNsaW1lXG4gIGlmIChwYXJlbnQuaWQgPT09IDB4NTMpIHlpZWxkIHJvbS5vYmplY3RzWzB4NjldIGFzIE1vbnN0ZXI7IC8vIHJlZCBzbGltZVxufVxuXG50eXBlIFNwYXducyA9IFJlYWRvbmx5QXJyYXk8cmVhZG9ubHkgW0xvY2F0aW9uLCBudW1iZXIsIFNwYXduXT47XG4iXX0=