import { Bits } from '../bits.js';
import { seq } from '../rom/util.js';
import { iters } from '../util.js';
class GenericFill {
    constructor() {
        this.slots = [];
        this.items = [];
    }
    set(slot, item) {
        if (this.slots[slot] != null)
            throw new Error(`already filled slot ${slot}`);
        if (this.items[item] != null)
            throw new Error(`already filled item ${item}`);
        this.slots[slot] = item;
        this.items[item] = slot;
    }
    hasSlot(slot) {
        return this.slots[slot] != null;
    }
    hasItem(item) {
        return this.items[item] != null;
    }
}
function expandFill(g, f) {
    const out = new GenericFill();
    for (let i = g.fixed; i < g.items.length; i++) {
        const s = f.items[i];
        out.set(g.slots[s].item, g.items[i].item);
    }
    return out;
}
export function newFill() {
    return new GenericFill();
}
export function traverse(graph, fill, has) {
    has = Bits.clone(has);
    const reachable = new Set();
    const queue = new Set();
    for (let i = 0; i < graph.slots.length; i++) {
        if (graph.graph[i] == null) {
            console.dir(graph);
            throw new Error(`adding bad node ${i} (${graph.slots[i].name}) from slot`);
        }
        queue.add(i);
    }
    for (const n of queue) {
        queue.delete(n);
        if (reachable.has(n))
            continue;
        const needed = graph.graph[n];
        if (needed == null)
            throw new Error(`not in graph: ${n}`);
        for (let i = 0, len = needed.length; i < len; i++) {
            if (!Bits.containsAll(has, needed[i]))
                continue;
            reachable.add(n);
            const item = n < graph.fixed ? n : fill.slots[n];
            if (item != null) {
                has = Bits.with(has, item);
                for (const j of graph.unlocks[item] || []) {
                    if (graph.graph[j] == null) {
                        console.dir(graph);
                        throw new Error(`adding bad node ${j} from unlock ${item}`);
                    }
                    queue.add(j);
                }
            }
            break;
        }
    }
    return reachable;
}
export function traverseFill(graph, fill) {
    const items = [];
    for (const i of graph.items) {
        if (i.item != null)
            items[i.item] = i.index;
    }
    const slots = [];
    for (const s of graph.slots) {
        if (s.item != null && fill.slots[s.item] != null) {
            slots[s.index] = items[fill.slots[s.item]];
        }
    }
    const out = [];
    let has = Bits.of();
    const reachable = new Set();
    const queue = new Set();
    for (let i = 0; i < graph.slots.length; i++) {
        queue.add(i);
    }
    for (const n of queue) {
        queue.delete(n);
        if (reachable.has(n))
            continue;
        const needed = graph.graph[n];
        for (let i = 0, len = needed.length; i < len; i++) {
            if (!Bits.containsAll(has, needed[i]))
                continue;
            out.push([n, ...Bits.bits(needed[i])]);
            reachable.add(n);
            const item = n < graph.fixed ? n : slots[n];
            if (item != null) {
                has = Bits.with(has, item);
                for (const j of graph.unlocks[item] || []) {
                    queue.add(j);
                }
            }
            break;
        }
    }
    return out;
}
var Type;
(function (Type) {
    Type[Type["EMPTY"] = 0] = "EMPTY";
    Type[Type["MIMIC"] = 1] = "MIMIC";
    Type[Type["CONSUMABLE"] = 2] = "CONSUMABLE";
    Type[Type["KEY"] = 3] = "KEY";
    Type[Type["BOSS_DROP"] = 4] = "BOSS_DROP";
    Type[Type["NPC"] = 5] = "NPC";
    Type[Type["MAGIC"] = 6] = "MAGIC";
    Type[Type["TRIGGER"] = 7] = "TRIGGER";
})(Type || (Type = {}));
export class ShuffleRules {
    constructor(rom, flags) {
        this.rom = rom;
        this.pools = new Map();
        const triggers = new Set([0x41, 0x42, 0x46]);
        const chests = new Set();
        const bossDrops = new Set();
        for (const l of rom.locations) {
            if (!l.used)
                continue;
            for (const s of l.spawns) {
                if (s.isInvisible()) {
                    bossDrops.add(s.id);
                }
                else if (s.isChest()) {
                    if (l.bossId() != null) {
                        bossDrops.add(s.id);
                    }
                    else {
                        chests.add(s.id);
                    }
                }
            }
        }
        for (const b of rom.bosses) {
            if (b.drop != null)
                bossDrops.add(b.drop);
        }
        this.slotTypes = seq(0x7c, i => {
            if (triggers.has(i))
                return Type.TRIGGER;
            if (i >= 0x70)
                return Type.MIMIC;
            if (i <= 0x48 && i >= 0x41)
                return Type.MAGIC;
            const item = rom.items[i];
            if (chests.has(i))
                return item && item.unique ? Type.KEY : Type.CONSUMABLE;
            if (bossDrops.has(i))
                return Type.BOSS_DROP;
            if (i === 0x67)
                return Type.NPC;
            return item && item.unique ? Type.NPC : Type.EMPTY;
        });
        const poolFlags = flags.get('S') || [];
        for (let i = 0; i < poolFlags.length; i++) {
            const flag = poolFlags[i];
            if (/c/.test(flag)) {
                this.pools.set(Type.CONSUMABLE, i + 1);
            }
            if (/t/.test(flag)) {
                this.pools.set(Type.MIMIC, i + 1);
            }
            if (/k/.test(flag)) {
                this.pools.set(Type.KEY, i + 1);
                this.pools.set(Type.BOSS_DROP, i + 1);
                this.pools.set(Type.NPC, i + 1);
            }
            if (/m/.test(flag)) {
                this.pools.set(Type.MAGIC, i + 1);
                this.pools.set(Type.TRIGGER, i + 1);
            }
        }
    }
    fits(slot, item) {
        if (slot === item)
            return true;
        const slotType = this.slotTypes[slot] || Type.EMPTY;
        const slotPool = this.pools.get(slotType);
        if (slotPool == null)
            return false;
        if (requiresChest(item) && slotType >= Type.BOSS_DROP)
            return false;
        let itemPool;
        if (item >= 0x70) {
            if (slotType > Type.KEY)
                return false;
            itemPool = this.pools.get(Type.MIMIC);
        }
        else if (item <= 0x48 && item >= 0x41) {
            itemPool = this.pools.get(Type.MAGIC);
        }
        else if (item < 0x41 && this.rom.items[item].unique) {
            itemPool = this.pools.get(Type.KEY);
        }
        else if (this.pools.get(Type.CONSUMABLE) == null &&
            this.slotTypes[item] === Type.BOSS_DROP) {
            itemPool = this.pools.get(Type.BOSS_DROP);
        }
        else {
            if (slotType === Type.TRIGGER)
                return false;
            itemPool = this.pools.get(Type.CONSUMABLE);
        }
        if (itemPool == null)
            return false;
        if (slotPool === itemPool)
            return true;
        return (itemPool === this.pools.get(Type.CONSUMABLE));
    }
    shouldShuffle(id) {
        return this.pools.get(this.slotTypes[id] || 0) != null;
    }
    isEarly(slot) {
        const slotType = this.slotTypes[slot] || Type.EMPTY;
        if (slotType >= Type.TRIGGER)
            return true;
        const pool = this.pools.get(slotType);
        const consumablePool = this.pools.get(Type.CONSUMABLE);
        const mimicPool = this.pools.get(Type.MIMIC);
        return pool !== consumablePool && pool !== mimicPool;
    }
}
export class AssumedFill {
    constructor(rom, flags) {
        this.rom = rom;
        this.flags = flags;
        this.shuffleRules = new ShuffleRules(rom, flags);
    }
    fits(slot, item) {
        return this.shuffleRules.fits(slot, item);
    }
    items(graph, random) {
        const arr = [];
        for (const item of graph.items) {
            if (item.item == null)
                continue;
            let count = 1;
            if (item.item === 0x00 || item.item === 0x01)
                count = 5;
            if (item.item === 0x02)
                count = 10;
            if (item.item === 0x03 || item.item === 0x48)
                count = 15;
            for (let i = 0; i < count; i++)
                arr.push(item.index);
        }
        random.shuffle(arr);
        return arr;
    }
    async shuffle(graph, random, progress, attempts = 2000) {
        if (progress)
            progress.addTasks(Math.floor(attempts / 100));
        for (let attempt = 0; attempt < attempts; attempt++) {
            if (progress && (attempt % 100 === 99)) {
                await new Promise(requestAnimationFrame);
                progress.addCompleted(1);
            }
            const items = this.items(graph, random);
            let has = Bits.from(new Set(items));
            const fill = new GenericFill();
            const itemIndex = new Map();
            const slotIndex = new Map();
            const nonShuffledItems = [];
            for (let i = graph.fixed; i < graph.items.length; i++) {
                const id = graph.items[i].item;
                if (id == null)
                    continue;
                itemIndex.set(id, i);
                if (!this.shuffleRules.shouldShuffle(id))
                    nonShuffledItems.push(id);
            }
            for (let s = graph.fixed; s < graph.slots.length; s++) {
                const id = graph.slots[s].item;
                if (id != null)
                    slotIndex.set(id, s);
            }
            for (const id of nonShuffledItems) {
                const i = itemIndex.get(id);
                const s = slotIndex.get(id);
                if (s == null || i == null)
                    continue;
                fill.set(s, i);
                has = Bits.without(has, i);
            }
            if (this.flags.guaranteeSword()) {
                const sword = random.nextInt(4);
                const i = itemIndex.get(sword);
                const s = slotIndex.get(0);
                if (i != null && s != null && !fill.hasSlot(s) && !fill.hasItem(i)) {
                    fill.set(s, i);
                    has = Bits.without(has, i);
                }
            }
            if (!this.fillInternal(graph, random, fill, items, has, Math.floor(attempt / 5)))
                continue;
            const final = traverse(graph, fill, Bits.of());
            if (final.size !== graph.slots.length) {
                console.error('unexpected size mismatch!', final, graph);
                continue;
            }
            const out = this.fill(graph, expandFill(graph, fill), random);
            if (out == null)
                continue;
            if (progress)
                progress.addCompleted(Math.floor((attempts - attempt) / 100));
            return out;
        }
        return null;
    }
    fillInternal(graph, random, fill, items, has, backSteps) {
        for (let bit = items.pop(); bit != null; bit = items.pop()) {
            if (!Bits.has(has, bit))
                continue;
            const itemId = graph.items[bit].item;
            if (itemId == null)
                throw new Error(`bad item: ${Object.entries(graph.items[bit])}`);
            has = Bits.without(has, bit);
            const reachable = [...traverse(graph, fill, has)];
            random.shuffle(reachable);
            let found = false;
            for (const slot of reachable) {
                const slotId = graph.slots[slot].item;
                if (slotId == null)
                    continue;
                if (!fill.hasSlot(slot) && this.fits(slotId, itemId)) {
                    fill.set(slot, bit);
                    found = true;
                    break;
                }
            }
            if (found)
                continue;
            if (backSteps-- > 0) {
                for (const slot of reachable) {
                    const slotId = graph.slots[slot].item;
                    if (slotId == null)
                        continue;
                    if (this.fits(slotId, itemId)) {
                        const previousItem = fill.slots[slot];
                        fill.slots[slot] = fill.items[previousItem] = undefined;
                        has = Bits.with(has, previousItem);
                        items.push(previousItem);
                        random.shuffle(items);
                        fill.set(slot, bit);
                        found = true;
                        break;
                    }
                }
                if (found)
                    continue;
            }
            return false;
        }
        return true;
    }
    fill(graph, fill, random) {
        const validItems = new Set();
        for (const slot of graph.slots) {
            if (slot.item != null)
                validItems.add(slot.item);
        }
        const uniques = [];
        const consumables = [];
        const mimics = [];
        const earlySlots = [];
        const otherSlots = [];
        for (let i = 0; i < 0x7c; i++) {
            if (i < 0x70 && !validItems.has(i)) {
                if (fill.hasSlot(i) !== fill.hasItem(i))
                    console.error('MISMATCH', i);
                continue;
            }
            if (!fill.hasSlot(i) && !fill.hasItem(i) && !this.shuffleRules.shouldShuffle(i)) {
                fill.set(i, i);
                continue;
            }
            if (!fill.hasSlot(i)) {
                if (this.shuffleRules.isEarly(i)) {
                    earlySlots.push(i);
                }
                else {
                    otherSlots.push(i);
                }
            }
            if (!fill.hasItem(i)) {
                if (i <= 0x48 && this.rom.items[i].unique) {
                    uniques.push(i);
                }
                else if (i < 0x70) {
                    consumables.push(i);
                }
                else {
                    mimics.push(i);
                }
            }
        }
        random.shuffle(earlySlots);
        random.shuffle(otherSlots);
        random.shuffle(uniques);
        random.shuffle(consumables);
        for (const item of iters.concat(uniques, mimics, consumables)) {
            let found = false;
            for (const slots of [earlySlots, otherSlots]) {
                if (found)
                    break;
                for (const slot of slots) {
                    if (this.fits(slot, item)) {
                        fill.set(slot, item);
                        found = true;
                        slots.splice(slots.indexOf(slot), 1);
                        break;
                    }
                }
            }
            if (!found) {
                return null;
            }
        }
        return fill;
    }
}
function requiresChest(id) {
    return id === 0x14 || id === 0x1b || id === 0x1c || id === 0x26;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9ncmFwaC9zaHVmZmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFJaEMsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFtRWpDLE1BQU0sV0FBVztJQUFqQjtRQUVFLFVBQUssR0FBZ0IsRUFBRSxDQUFDO1FBRXhCLFVBQUssR0FBZ0IsRUFBRSxDQUFDO0lBZ0IxQixDQUFDO0lBZEMsR0FBRyxDQUFDLElBQU8sRUFBRSxJQUFPO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM3RSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsdUJBQXVCLElBQUksRUFBRSxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFPO1FBQ2IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztJQUNsQyxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQU87UUFDYixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0lBQ2xDLENBQUM7Q0FDRjtBQU9ELFNBQVMsVUFBVSxDQUFDLENBQVEsRUFBRSxDQUFZO0lBQ3hDLE1B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QUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFNUIsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLEVBQUU7WUFLN0QsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDO1lBQ2xCLEtBQUssTUFBTSxLQUFLLElBQUksQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLEVBQUU7Z0JBQzVDLElBQUksS0FBSztvQkFBRSxNQUFNO2dCQUNqQixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtvQkFDeEIsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQWEsRUFBRTt3QkFDckMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7d0JBQ3JCLEtBQUssR0FBRyxJQUFJLENBQUM7d0JBQ2IsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO3dCQUNyQyxNQUFNO3FCQUNQO2lCQUNGO2FBQ0Y7WUFDRCxJQUFJLENBQUMsS0FBSyxFQUFFO2dCQUVWLE9BQU8sSUFBSSxDQUFDO2FBQ2I7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGO0FBRUQsU0FBUyxhQUFhLENBQUMsRUFBVTtJQUMvQixPQUFPLEVBQUUsS0FBSyxJQUFJLElBQUksRUFBRSxLQUFLLElBQUksSUFBSSxFQUFFLEtBQUssSUFBSSxJQUFJLEVBQUUsS0FBSyxJQUFJLENBQUM7QUFDbEUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEJhc2ljIGdyYXBoIHNodWZmbGUgYWxnb3JpdGhtXG5pbXBvcnQge0JpdHN9IGZyb20gJy4uL2JpdHMuanMnO1xuaW1wb3J0IHtGbGFnU2V0fSBmcm9tICcuLi9mbGFnc2V0LmpzJztcbmltcG9ydCB7UmFuZG9tfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge3NlcX0gZnJvbSAnLi4vcm9tL3V0aWwuanMnO1xuaW1wb3J0IHtpdGVyc30gZnJvbSAnLi4vdXRpbC5qcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2h1ZmZsZSB7XG4gIHNodWZmbGUoZ3JhcGg6IEdyYXBoLFxuICAgICAgICAgIHJhbmRvbTogUmFuZG9tLFxuICAgICAgICAgIHByb2dyZXNzPzogUHJvZ3Jlc3NUcmFja2VyLFxuICAgICAgICAgIGF0dGVtcHRzPzogbnVtYmVyKTogUHJvbWlzZTxGaWxsIHwgbnVsbD47XG59XG5leHBvcnQgaW50ZXJmYWNlIFByb2dyZXNzVHJhY2tlciB7XG4gIGFkZFRhc2tzKHRhc2tzOiBudW1iZXIpOiB2b2lkO1xuICBhZGRDb21wbGV0ZWQodGFza3M6IG51bWJlcik6IHZvaWQ7XG59XG5cbmV4cG9ydCB0eXBlIFNsb3RJbmRleCA9IG51bWJlciAmIHtfX3Nsb3RJbmRleF9fOiBuZXZlcn07XG5leHBvcnQgdHlwZSBJdGVtSW5kZXggPSBudW1iZXIgJiB7X19pdGVtSW5kZXhfXzogbmV2ZXJ9O1xuZXhwb3J0IHR5cGUgU2xvdElkID0gbnVtYmVyICYge19fc2xvdElkX186IG5ldmVyfTtcbmV4cG9ydCB0eXBlIEl0ZW1JZCA9IG51bWJlciAmIHtfX2l0ZW1JZF9fOiBuZXZlcn07XG5cbmV4cG9ydCB0eXBlIEtleWVkPF9LLCBWPiA9IEFycmF5PFY+O1xuZXhwb3J0IHR5cGUgUmVhZG9ubHlLZXllZDxfSywgVj4gPSBSZWFkb25seUFycmF5PFY+O1xuXG4vLyBkZWNsYXJlIGNvbnN0IHM6IFNsb3RJbmRleDtcbi8vIGRlY2xhcmUgY29uc3QgaTogSXRlbUluZGV4O1xuLy8gY29uc3QgYTogS2V5ZWQ8U2xvdEluZGV4LCBJdGVtSW5kZXg+ID0gW107XG4vLyBjb25zdCB4ID0gYVtzXTtcbi8vIGNvbnN0IFtdID0gW3MsIGksIGEsIHhdO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5vZGUge1xuICBpdGVtPzogbnVtYmVyOyAvLyBvbmx5IHNldCBmb3IgbGVnaXQgaXRlbXMvc2xvdHNcbiAgbmFtZTogIHN0cmluZztcbiAgY29uZGl0aW9uOiBudW1iZXI7IC8vIGZsYWcvY29uZGl0aW9uIG51bWJlciBmb3IgdHJhY2tpbmcgdGhpcyBub2RlIChlLmcuIDB4MjQ4IGZvciBmbGlnaHQpXG4gIGluZGV4OiBudW1iZXI7XG59XG5leHBvcnQgaW50ZXJmYWNlIFNsb3ROb2RlIGV4dGVuZHMgTm9kZSB7XG4gIGl0ZW0/OiBTbG90SWQ7XG4gIGluZGV4OiBTbG90SW5kZXg7XG59XG5leHBvcnQgaW50ZXJmYWNlIEl0ZW1Ob2RlIGV4dGVuZHMgTm9kZSB7XG4gIGl0ZW0/OiBJdGVtSWQ7XG4gIGluZGV4OiBJdGVtSW5kZXg7XG59XG5cbi8vIHR5cGUgS2V5ZWQ8SywgVj4gPSBBcnJheTxWPjsgLy8gJiB7X19rZXllZF9fOiAoazogSykgPT4gViwgX193cml0ZWFibGVfXzogbmV2ZXJ9O1xuLy8gdHlwZSBSZWFkb25seUtleWVkPEssIFY+ID0gUmVhZG9ubHlBcnJheTxWPjsgLy8gJiB7X19rZXllZF9fOiAoazogSykgPT4gVn07XG4vLyBmdW5jdGlvbiBLZXllZDxLLCBWPihhOiBWW10pOiBLZXllZDxLLCBWPiB7IHJldHVybiBhIGFzIGFueTsgfVxuLy8gbmFtZXNwYWNlIEtleWVkIHtcbi8vICAgLy8gZXhwb3J0IGNvbnN0IHRvQXJyYXk6IHs8SywgVj4oYTogS2V5ZWQ8SywgVj4pOiBBcnJheTxWPixcbi8vICAgLy8gICAgICAgICAgICAgICAgICAgICAgICA8SywgVj4oYTogUmVhZG9ubHlLZXllZDxLLCBWPik6IFJlYWRvbmx5QXJyYXk8Vj59ID0gKGE6IGFueSkgPT4gYTtcbi8vICAgZXhwb3J0IGZ1bmN0aW9uIGdldDxLLCBWPihhOiBSZWFkb25seUtleWVkPEssIFY+LCBrOiBLKTogViB7XG4vLyAgICAgcmV0dXJuIChhIGFzIGFueSlba107XG4vLyAgIH1cbi8vICAgZXhwb3J0IGZ1bmN0aW9uIHNldDxLLCBWPihhOiBLZXllZDxLLCBWPiwgazogSywgdjogVik6IHZvaWQge1xuLy8gICAgIChhIGFzIGFueSlba10gPSB2O1xuLy8gICB9XG4vLyB9XG5cbmV4cG9ydCBpbnRlcmZhY2UgR3JhcGgge1xuICByZWFkb25seSBmaXhlZDogbnVtYmVyOyAgLy8gaW5kZXggYmVmb3JlIHdoaWNoIHNsb3RzICYgZGVwcyBhcmUgdGhlIHNhbWU/XG4gIHJlYWRvbmx5IHNsb3RzOiBSZWFkb25seUtleWVkPFNsb3RJbmRleCwgU2xvdE5vZGU+O1xuICByZWFkb25seSBpdGVtczogUmVhZG9ubHlLZXllZDxJdGVtSW5kZXgsIEl0ZW1Ob2RlPjtcbiAgLyoqIE1hcCBmcm9tIGxvY2F0aW9uIHRvIERORiBvZiBpdGVtcyByZXF1aXJlZCB0byByZWFjaC4gKi9cbiAgcmVhZG9ubHkgZ3JhcGg6IFJlYWRvbmx5S2V5ZWQ8U2xvdEluZGV4LCByZWFkb25seSBCaXRzW10+O1xuICAvKiogTWFwIGZyb20gaXRlbSB0byBsb2NhdGlvbnMgdGhhdCBtYXkgbm93IGJlIHJlYWNoYWJsZS4gKi9cbiAgcmVhZG9ubHkgdW5sb2NrczogUmVhZG9ubHlLZXllZDxJdGVtSW5kZXgsIHJlYWRvbmx5IFNsb3RJbmRleFtdPjtcbiAgcmVhZG9ubHkgcm9tOiBSb207XG59XG5cbmNsYXNzIEdlbmVyaWNGaWxsPFMgZXh0ZW5kcyBudW1iZXIsIEkgZXh0ZW5kcyBudW1iZXI+IHtcbiAgLyoqIE1hcHMgbG9jYXRpb24gdG8gaXRlbS4gKi9cbiAgc2xvdHM6IEtleWVkPFMsIEk+ID0gW107XG4gIC8qKiBNYXBzIGl0ZW0gdG8gbG9jYXRpb24uICovXG4gIGl0ZW1zOiBLZXllZDxJLCBTPiA9IFtdO1xuXG4gIHNldChzbG90OiBTLCBpdGVtOiBJKSB7XG4gICAgaWYgKHRoaXMuc2xvdHNbc2xvdF0gIT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBhbHJlYWR5IGZpbGxlZCBzbG90ICR7c2xvdH1gKTtcbiAgICBpZiAodGhpcy5pdGVtc1tpdGVtXSAhPSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYGFscmVhZHkgZmlsbGVkIGl0ZW0gJHtpdGVtfWApO1xuICAgIHRoaXMuc2xvdHNbc2xvdF0gPSBpdGVtO1xuICAgIHRoaXMuaXRlbXNbaXRlbV0gPSBzbG90O1xuICB9XG5cbiAgaGFzU2xvdChzbG90OiBTKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuc2xvdHNbc2xvdF0gIT0gbnVsbDtcbiAgfVxuXG4gIGhhc0l0ZW0oaXRlbTogSSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLml0ZW1zW2l0ZW1dICE9IG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgRmlsbCA9IEdlbmVyaWNGaWxsPFNsb3RJZCwgSXRlbUlkPjtcbi8vZXhwb3J0IGNvbnN0IEZpbGw6IHtuZXcoKTogRmlsbH0gPSBHZW5lcmljRmlsbDtcbmV4cG9ydCB0eXBlIEluZGV4RmlsbCA9IEdlbmVyaWNGaWxsPFNsb3RJbmRleCwgSXRlbUluZGV4PjtcblxuLyoqIENvbnZlcnRzIGFuIEluZGV4RmlsbCB0byBhIGZ1bGwgRmlsbC4gKi9cbmZ1bmN0aW9uIGV4cGFuZEZpbGwoZzogR3JhcGgsIGY6IEluZGV4RmlsbCk6IEZpbGwge1xuICBjb25zdCBvdXQgPSBuZXcgR2VuZXJpY0ZpbGw8U2xvdElkLCBJdGVtSWQ+KCk7XG4gIGZvciAobGV0IGkgPSBnLmZpeGVkOyBpIDwgZy5pdGVtcy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHM6IFNsb3RJbmRleCA9IGYuaXRlbXNbaV07XG4gICAgb3V0LnNldChnLnNsb3RzW3NdLml0ZW0hLCBnLml0ZW1zW2ldLml0ZW0hKTtcbiAgfVxuICByZXR1cm4gb3V0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbmV3RmlsbDxTIGV4dGVuZHMgbnVtYmVyLCBJIGV4dGVuZHMgbnVtYmVyPigpOiBHZW5lcmljRmlsbDxTLCBJPiB7XG4gIHJldHVybiBuZXcgR2VuZXJpY0ZpbGwoKTtcbn1cblxuXG4vKiogQHJldHVybiBUaGUgc2V0IG9mIHJlYWNoYWJsZSBzbG90cy4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0cmF2ZXJzZShncmFwaDogR3JhcGgsIGZpbGw6IEluZGV4RmlsbCwgaGFzOiBCaXRzKTogU2V0PFNsb3RJbmRleD4ge1xuICAvLyBOT1RFOiB3ZSBjYW4ndCB1c2UgaXNBcnJheSBiZWNhdXNlIHRoZSBub24tYmlnaW50IHBvbHlmaWxsIElTIGFuIGFycmF5XG4gIGhhcyA9IEJpdHMuY2xvbmUoaGFzKTtcbiAgY29uc3QgcmVhY2hhYmxlID0gbmV3IFNldDxTbG90SW5kZXg+KCk7XG4gIGNvbnN0IHF1ZXVlID0gbmV3IFNldDxTbG90SW5kZXg+KCk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JhcGguc2xvdHMubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAoZ3JhcGguZ3JhcGhbaV0gPT0gbnVsbCkge1xuICAgICAgY29uc29sZS5kaXIoZ3JhcGgpO1xuICAgICAgLy8gSSB0aGluayB0aGlzIGNvcnJlc3BvbmRzIHRvIGFuIHVucmVhY2hhYmxlIGNoZWNrP1xuICAgICAgLy8gIC0gaG93IGlzIHRoaXMgZGlmZmVyZW50IGZyb20gXCJub3RoaW5nIHByb3ZpZGVkXCIgaW4gd29ybGQudHM/XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGFkZGluZyBiYWQgbm9kZSAke2l9ICgke2dyYXBoLnNsb3RzW2ldLm5hbWV9KSBmcm9tIHNsb3RgKTtcbiAgICB9XG4gICAgcXVldWUuYWRkKGkgYXMgU2xvdEluZGV4KTtcbiAgfVxuICBmb3IgKGNvbnN0IG4gb2YgcXVldWUpIHtcbiAgICBxdWV1ZS5kZWxldGUobik7XG4gICAgaWYgKHJlYWNoYWJsZS5oYXMobikpIGNvbnRpbnVlO1xuICAgIC8vIGNhbiB3ZSByZWFjaCBpdD9cbiAgICBjb25zdCBuZWVkZWQgPSBncmFwaC5ncmFwaFtuXTtcbiAgICBpZiAobmVlZGVkID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgbm90IGluIGdyYXBoOiAke259YCk7XG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IG5lZWRlZC5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgaWYgKCFCaXRzLmNvbnRhaW5zQWxsKGhhcywgbmVlZGVkW2ldKSkgY29udGludWU7XG4gICAgICByZWFjaGFibGUuYWRkKG4pO1xuICAgICAgY29uc3QgaXRlbSA9IG4gPCBncmFwaC5maXhlZCA/IG4gOiBmaWxsLnNsb3RzW25dO1xuICAgICAgaWYgKGl0ZW0gIT0gbnVsbCkge1xuICAgICAgICBoYXMgPSBCaXRzLndpdGgoaGFzLCBpdGVtKTtcbiAgICAgICAgZm9yIChjb25zdCBqIG9mIGdyYXBoLnVubG9ja3NbaXRlbV0gfHwgW10pIHtcbiAgICAgICAgICBpZiAoZ3JhcGguZ3JhcGhbal0gPT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc29sZS5kaXIoZ3JhcGgpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBhZGRpbmcgYmFkIG5vZGUgJHtqfSBmcm9tIHVubG9jayAke2l0ZW19YCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHF1ZXVlLmFkZChqKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIHJldHVybiByZWFjaGFibGU7XG59XG5cbi8vIFRPRE8gLSB0aGlzIGlzIGEgbG90IG9mIGNvcHkgcGFzdGEsIHdlIHNob3VsZCBjb25zb2xpZGF0ZSFcbi8qKiBDb3B5IG9mIHRyYXZlcnNlIGJ1dCBvdXRwdXRzIGEgaHVtYW4tcmVhZGFibGUgcGF0aC4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0cmF2ZXJzZUZpbGwoZ3JhcGg6IEdyYXBoLCBmaWxsOiBGaWxsKTogbnVtYmVyW11bXSB7XG4gIGNvbnN0IGl0ZW1zID0gW107XG4gIGZvciAoY29uc3QgaSBvZiBncmFwaC5pdGVtcykge1xuICAgIGlmIChpLml0ZW0gIT0gbnVsbCkgaXRlbXNbaS5pdGVtXSA9IGkuaW5kZXg7XG4gIH1cbiAgY29uc3Qgc2xvdHMgPSBbXTtcbiAgZm9yIChjb25zdCBzIG9mIGdyYXBoLnNsb3RzKSB7XG4gICAgaWYgKHMuaXRlbSAhPSBudWxsICYmIGZpbGwuc2xvdHNbcy5pdGVtXSAhPSBudWxsKSB7XG4gICAgICBzbG90c1tzLmluZGV4XSA9IGl0ZW1zW2ZpbGwuc2xvdHNbcy5pdGVtXV07XG4gICAgfVxuICB9XG4gIGNvbnN0IG91dCA9IFtdO1xuXG4gIGxldCBoYXMgPSBCaXRzLm9mKClcbiAgY29uc3QgcmVhY2hhYmxlID0gbmV3IFNldDxTbG90SW5kZXg+KCk7XG4gIGNvbnN0IHF1ZXVlID0gbmV3IFNldDxTbG90SW5kZXg+KCk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JhcGguc2xvdHMubGVuZ3RoOyBpKyspIHtcbiAgICBxdWV1ZS5hZGQoaSBhcyBTbG90SW5kZXgpO1xuICB9XG4gIGZvciAoY29uc3QgbiBvZiBxdWV1ZSkge1xuICAgIHF1ZXVlLmRlbGV0ZShuKTtcbiAgICBpZiAocmVhY2hhYmxlLmhhcyhuKSkgY29udGludWU7XG4gICAgLy8gY2FuIHdlIHJlYWNoIGl0P1xuICAgIGNvbnN0IG5lZWRlZCA9IGdyYXBoLmdyYXBoW25dO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBuZWVkZWQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIGlmICghQml0cy5jb250YWluc0FsbChoYXMsIG5lZWRlZFtpXSkpIGNvbnRpbnVlO1xuICAgICAgb3V0LnB1c2goW24sIC4uLkJpdHMuYml0cyhuZWVkZWRbaV0pXSk7XG4gICAgICByZWFjaGFibGUuYWRkKG4pO1xuICAgICAgY29uc3QgaXRlbSA9IG4gPCBncmFwaC5maXhlZCA/IG4gOiBzbG90c1tuXTtcbiAgICAgIGlmIChpdGVtICE9IG51bGwpIHtcbiAgICAgICAgaGFzID0gQml0cy53aXRoKGhhcywgaXRlbSk7XG4gICAgICAgIGZvciAoY29uc3QgaiBvZiBncmFwaC51bmxvY2tzW2l0ZW1dIHx8IFtdKSB7XG4gICAgICAgICAgcXVldWUuYWRkKGopO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG91dDtcbn1cblxuLy8gU2h1ZmZsZSBtb2Rlczpcbi8vICAxLiBrZXkgaXRlbSBzaHVmZmxlIFNrKHQpXG4vLyAgMi4gZnVsbCBzaHVmZmxlIFNmKHQpXG4vLyBGb3Igbm93IHdlIHByb3h5IGEgZmV3IHRoaW5ncyBmb3IgdGhpcy4uLlxuXG4vLyBTbG90IHByb3BlcnRpZXM6XG4vLyAgMS4gY29uc3VtYWJsZSBvciBrZXlcbi8vICAyLiBjaGVzdCAoaW5jbC4gYm9zcyBkcm9wcywgbWF5IGJlIGNvbnN1bWFibGUpXG4vLyAgMy4gdHJpZ2dlciAoYWx3YXlzIGtleSwgbXVzdCBiZSBrZXkpXG4vLyAgNC4gbWltaWNcblxuLy8gUnVsZXM6XG4vLyAgLSBJZiBrZXkgc2h1ZmZsZSB0aGVuIGluaXRpYWwgZmlsbCBpZ25vcmVzIGFsbCBub24ta2V5IHNsb3RzXG4vLyAgLSBJZiB0cmFwIHNodWZmbGUgb2ZmIHRoZW4gaWdub3JlIG1pbWljIHNsb3RzXG4vLyAgLSBDb25zdW1hYmxlcyBtYXkgbm90IGdvIGludG8gdHJpZ2dlcnNcbi8vICAtIE1pbWljcyBtYXkgbm90IGdvIGludG8gbnBjcywgdHJpZ2dlcnMsIG9yIGJvc3MgZHJvcHMuXG4vLyAgLSBXZSB0cmVhdCBpbnZpc2libGUgY2hlc3RzIGxpa2UgYm9zcyBkcm9wcy5cblxuZW51bSBUeXBlIHtcbiAgRU1QVFkgPSAwLFxuICBNSU1JQyA9IDEsXG4gIENPTlNVTUFCTEUgPSAyLFxuICBLRVkgPSAzLFxuICBCT1NTX0RST1AgPSA0LFxuICBOUEMgPSA1LFxuICBNQUdJQyA9IDYsXG4gIFRSSUdHRVIgPSA3LFxufVxuXG5leHBvcnQgY2xhc3MgU2h1ZmZsZVJ1bGVzIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzbG90VHlwZXM6IFJlYWRvbmx5S2V5ZWQ8U2xvdElkIHwgSXRlbUlkLCBUeXBlIHwgdW5kZWZpbmVkPjtcbiAgcHJpdmF0ZSByZWFkb25seSBwb29scyA9IG5ldyBNYXA8VHlwZSwgbnVtYmVyPigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcm9tOiBSb20sIGZsYWdzOiBGbGFnU2V0KSB7XG4gICAgY29uc3QgdHJpZ2dlcnMgPSBuZXcgU2V0KFsweDQxLCAweDQyLCAweDQ2XSk7XG4gICAgY29uc3QgY2hlc3RzID0gbmV3IFNldCgpO1xuICAgIGNvbnN0IGJvc3NEcm9wcyA9IG5ldyBTZXQoKTtcbiAgICBmb3IgKGNvbnN0IGwgb2Ygcm9tLmxvY2F0aW9ucykge1xuICAgICAgaWYgKCFsLnVzZWQpIGNvbnRpbnVlO1xuICAgICAgZm9yIChjb25zdCBzIG9mIGwuc3Bhd25zKSB7XG4gICAgICAgIGlmIChzLmlzSW52aXNpYmxlKCkpIHtcbiAgICAgICAgICBib3NzRHJvcHMuYWRkKHMuaWQpO1xuICAgICAgICB9IGVsc2UgaWYgKHMuaXNDaGVzdCgpKSB7XG4gICAgICAgICAgaWYgKGwuYm9zc0lkKCkgIT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gTm9uLWRyb3AgY2hlc3RzIG9uIGJvc3Mgc2NyZWVucyBhbHNvIGRvbid0IHdvcmsgZm9yIG1pbWljcyxcbiAgICAgICAgICAgIC8vIHNvIGNvdW50IHRob3NlIGNoZXN0cyBhcyBib3NzIGRyb3BzLCB0b28gKGUuZy4gc3Rvcm0gYnJhY2VsZXQpXG4gICAgICAgICAgICBib3NzRHJvcHMuYWRkKHMuaWQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjaGVzdHMuYWRkKHMuaWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IGIgb2Ygcm9tLmJvc3Nlcykge1xuICAgICAgaWYgKGIuZHJvcCAhPSBudWxsKSBib3NzRHJvcHMuYWRkKGIuZHJvcCk7XG4gICAgfVxuXG4gICAgdGhpcy5zbG90VHlwZXMgPSBzZXEoMHg3YywgaSA9PiB7XG4gICAgICBpZiAodHJpZ2dlcnMuaGFzKGkpKSByZXR1cm4gVHlwZS5UUklHR0VSO1xuICAgICAgaWYgKGkgPj0gMHg3MCkgcmV0dXJuIFR5cGUuTUlNSUM7XG4gICAgICBpZiAoaSA8PSAweDQ4ICYmIGkgPj0gMHg0MSkgcmV0dXJuIFR5cGUuTUFHSUM7XG4gICAgICBjb25zdCBpdGVtID0gcm9tLml0ZW1zW2ldO1xuICAgICAgaWYgKGNoZXN0cy5oYXMoaSkpIHJldHVybiBpdGVtICYmIGl0ZW0udW5pcXVlID8gVHlwZS5LRVkgOiBUeXBlLkNPTlNVTUFCTEU7XG4gICAgICBpZiAoYm9zc0Ryb3BzLmhhcyhpKSkgcmV0dXJuIFR5cGUuQk9TU19EUk9QO1xuICAgICAgaWYgKGkgPT09IDB4NjcpIHJldHVybiBUeXBlLk5QQzsgLy8gTk9URTogcmVwdXJwb3NlZCwgYnV0IHdlIGRvbid0IHNlZSBkaWFsb2cgYWN0aW9uc1xuICAgICAgcmV0dXJuIGl0ZW0gJiYgaXRlbS51bmlxdWUgPyBUeXBlLk5QQyA6IFR5cGUuRU1QVFk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBwb29sRmxhZ3MgPSBmbGFncy5nZXQoJ1MnKSB8fCBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xGbGFncy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgZmxhZyA9IHBvb2xGbGFnc1tpXTtcbiAgICAgIGlmICgvYy8udGVzdChmbGFnKSkge1xuICAgICAgICB0aGlzLnBvb2xzLnNldChUeXBlLkNPTlNVTUFCTEUsIGkgKyAxKTtcbiAgICAgIH1cbiAgICAgIGlmICgvdC8udGVzdChmbGFnKSkge1xuICAgICAgICB0aGlzLnBvb2xzLnNldChUeXBlLk1JTUlDLCBpICsgMSk7XG4gICAgICB9XG4gICAgICBpZiAoL2svLnRlc3QoZmxhZykpIHtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5LRVksIGkgKyAxKTtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5CT1NTX0RST1AsIGkgKyAxKTtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5OUEMsIGkgKyAxKTtcbiAgICAgIH1cbiAgICAgIGlmICgvbS8udGVzdChmbGFnKSkge1xuICAgICAgICB0aGlzLnBvb2xzLnNldChUeXBlLk1BR0lDLCBpICsgMSk7XG4gICAgICAgIHRoaXMucG9vbHMuc2V0KFR5cGUuVFJJR0dFUiwgaSArIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZpdHMoc2xvdDogU2xvdElkLCBpdGVtOiBJdGVtSWQpOiBib29sZWFuIHtcbiAgICAvLyBWYW5pbGxhIHBsYWNlbWVudCBpcyBhbHdheXMgbGVnYWwuXG4gICAgaWYgKHNsb3QgYXMgbnVtYmVyID09PSBpdGVtKSByZXR1cm4gdHJ1ZTtcbiAgICBjb25zdCBzbG90VHlwZSA9IHRoaXMuc2xvdFR5cGVzW3Nsb3RdIHx8IFR5cGUuRU1QVFk7XG4gICAgY29uc3Qgc2xvdFBvb2wgPSB0aGlzLnBvb2xzLmdldChzbG90VHlwZSk7XG4gICAgaWYgKHNsb3RQb29sID09IG51bGwpIHJldHVybiBmYWxzZTtcbiAgICAvLyBTcGVjaWFsIGhhbmRsaW5nIHRvIHByZXZlbnQgb3BlbHMgYW5kIHVuaXF1ZSBhcm1vcnMgb24gTlBDcy5cbiAgICBpZiAocmVxdWlyZXNDaGVzdChpdGVtKSAmJiBzbG90VHlwZSA+PSBUeXBlLkJPU1NfRFJPUCkgcmV0dXJuIGZhbHNlO1xuICAgIC8vIFRPRE8gLSBhY2NvdW50IGZvciBuZXcgTUFHSUMgdHlwZSBhbmQgdXNlIHBvb2xzIGluc3RlYWQhXG4gICAgbGV0IGl0ZW1Qb29sO1xuICAgIGlmIChpdGVtID49IDB4NzApIHtcbiAgICAgIC8vIE1pbWljcyAtIGNhbiBuZXZlciBzaG93IHVwIGV4Y2VwdCBpbiBub24tYm9zcy1kcm9wIGNoZXN0cy5cbiAgICAgIGlmIChzbG90VHlwZSA+IFR5cGUuS0VZKSByZXR1cm4gZmFsc2U7XG4gICAgICBpdGVtUG9vbCA9IHRoaXMucG9vbHMuZ2V0KFR5cGUuTUlNSUMpO1xuICAgIH0gZWxzZSBpZiAoaXRlbSA8PSAweDQ4ICYmIGl0ZW0gPj0gMHg0MSkge1xuICAgICAgLy8gTWFnaWNzIC0gY2FuIGJlIGFueXdoZXJlLlxuICAgICAgaXRlbVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLk1BR0lDKTtcbiAgICB9IGVsc2UgaWYgKGl0ZW0gPCAweDQxICYmIHRoaXMucm9tLml0ZW1zW2l0ZW1dLnVuaXF1ZSkge1xuICAgICAgLy8gVW5pcXVlIGl0ZW0gLSBjYW4gYmUgYW55d2hlcmUuXG4gICAgICBpdGVtUG9vbCA9IHRoaXMucG9vbHMuZ2V0KFR5cGUuS0VZKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucG9vbHMuZ2V0KFR5cGUuQ09OU1VNQUJMRSkgPT0gbnVsbCAmJlxuICAgICAgICAgICAgICAgdGhpcy5zbG90VHlwZXNbaXRlbV0gPT09IFR5cGUuQk9TU19EUk9QKSB7XG4gICAgICAvLyBJZiBjb25zdW1hYmxlcyBhcmUgKm5vdCogc2h1ZmZsZWQgdGhlbiBhbGwgYm9zcyBkcm9wc1xuICAgICAgLy8gbmVlZCB0byBiZSB0cmVhdGVkIGFzIGtleSBpdGVtcywgbm90IGNvbnN1bWFibGVzLlxuICAgICAgaXRlbVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLkJPU1NfRFJPUClcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ29uc3VtYWJsZXMgLSBjYW5ub3QgYmUgb24gYW4gTlBDLCBNYWdpYywgb3IgVHJpZ2dlci5cbiAgICAgIGlmIChzbG90VHlwZSA9PT0gVHlwZS5UUklHR0VSKSByZXR1cm4gZmFsc2U7XG4gICAgICBpdGVtUG9vbCA9IHRoaXMucG9vbHMuZ2V0KFR5cGUuQ09OU1VNQUJMRSk7XG4gICAgfVxuICAgIGlmIChpdGVtUG9vbCA9PSBudWxsKSByZXR1cm4gZmFsc2U7XG5cbiAgICAvLyBObyBoYXJkIGJsb2NrZXIsIHNvIGNoZWNrIGZvciBzYW1lIHBvb2wuXG4gICAgaWYgKHNsb3RQb29sID09PSBpdGVtUG9vbCkgcmV0dXJuIHRydWU7XG5cbiAgICAvLyBEaWZmZXJlbnQgcG9vbHMsIGJ1dCB3ZSBuZWVkIHRvIHNodWZmbGUgc29tZSBjb25zdW1hYmxlc1xuICAgIC8vIGludG8ga2V5IGl0ZW0gc2xvdHMgb2NjYXNpb25hbGx5LlxuICAgIHJldHVybiAoaXRlbVBvb2wgPT09IHRoaXMucG9vbHMuZ2V0KFR5cGUuQ09OU1VNQUJMRSkpO1xuXG4gIC8vICAgICBpZiAoIXRoaXMuc2h1ZmZsZUZ1bGwpIHJldHVybiBzbG90VHlwZSA+PSBUeXBlLktFWTtcbiAgLy8gICAgIGlmICghdGhpcy5zaHVmZmxlVHJhcHMpIHJldHVybiBzbG90VHlwZSAhPT0gVHlwZS5NSU1JQztcbiAgLy8gICAgIHJldHVybiB0cnVlO1xuICAvLyAgIH1cbiAgLy8gICAvLyBDb25zdW1hYmxlXG4gIC8vICAgLy8gaWYgKHVuaXF1ZXNMZWZ0ICYmIHNsb3RUeXBlID4gVHlwZS5DT05TVU1BQkxFKSByZXR1cm4gZmFsc2U7XG4gIC8vICAgaWYgKCF0aGlzLnNodWZmbGVUcmFwcykgcmV0dXJuIHNsb3RUeXBlICE9PSBUeXBlLk1JTUlDO1xuICAvLyAgIHJldHVybiBzbG90VHlwZSAhPT0gVHlwZS5UUklHR0VSO1xuXG5cbiAgLy8gLy8gbWltaWNcbiAgLy8gICAgIGlmICghdGhpcy5zaHVmZmxlVHJhcHMpIHJldHVybiBzbG90VHlwZSA9PT0gVHlwZS5NSU1JQztcbiAgLy8gICAgIGlmICghdGhpcy5zaHVmZmxlRnVsbCkgcmV0dXJuIHNsb3RUeXBlIDw9IFR5cGUuQ09OU1VNQUJMRTtcbiAgLy8gICAgIHJldHVybiBzbG90VHlwZSA8PSBUeXBlLktFWTtcblxuICB9XG5cbiAgc2hvdWxkU2h1ZmZsZShpZDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucG9vbHMuZ2V0KHRoaXMuc2xvdFR5cGVzW2lkXSB8fCAwKSAhPSBudWxsO1xuICB9XG5cbiAgaXNFYXJseShzbG90OiBTbG90SWQpOiBib29sZWFuIHtcbiAgICBjb25zdCBzbG90VHlwZSA9IHRoaXMuc2xvdFR5cGVzW3Nsb3RdIHx8IFR5cGUuRU1QVFk7XG5cbiAgICAvLyBFYXJseSBzbG90czpcbiAgICAvLyAgLSBUcmlnZ2VyIHNsb3RzIGFyZSBhbHdheXMgZWFybHksIGZvciBhbGwgZmxhZ3MsIHNpbmNlIHRoZXkgY2Fubm90IGdldFxuICAgIC8vICAgIGNvbnN1bWFibGVzIChvciBtaW1pY3MpLlxuICAgIC8vICAtIFRPRE8gLSBjb25zaWRlciBhIGNvbXByb21pc2UgZnVsbC1zaHVmZmxlIGZsYWcvbW9kZSB3aGVyZSBOUENzIGRvbid0XG4gICAgLy8gICAgZXZlciBoYXZlIGNvbnN1bWFibGVzLlxuICAgIC8vICAtIE90aGVyd2lzZSBhbnkgc2xvdCB0eXBlIHRoYXQgZG9lcyBub3Qgc2h1ZmZsZSB3LyBjb25zdW1hYmxlcyBuZWVkc1xuICAgIC8vICAgIHRvIGJlIGVhcmx5LlxuXG4gICAgaWYgKHNsb3RUeXBlID49IFR5cGUuVFJJR0dFUikgcmV0dXJuIHRydWU7XG4gICAgY29uc3QgcG9vbCA9IHRoaXMucG9vbHMuZ2V0KHNsb3RUeXBlKTtcbiAgICBjb25zdCBjb25zdW1hYmxlUG9vbCA9IHRoaXMucG9vbHMuZ2V0KFR5cGUuQ09OU1VNQUJMRSk7XG4gICAgY29uc3QgbWltaWNQb29sID0gdGhpcy5wb29scy5nZXQoVHlwZS5NSU1JQyk7XG4gICAgcmV0dXJuIHBvb2wgIT09IGNvbnN1bWFibGVQb29sICYmIHBvb2wgIT09IG1pbWljUG9vbDtcblxuICAgIC8vIHJldHVybiBzbG90VHlwZSA+IChmdWxsU2h1ZmZsZSA/IFR5cGUuTlBDIDogVHlwZS5DT05TVU1BQkxFKTtcbiAgfVxufVxuXG5cbi8vIFRPRE8gLSBwdWxsIG91dCBhIGJhc2UgY2xhc3Mgd2l0aCBmaXRzLCBldGMuXG5leHBvcnQgY2xhc3MgQXNzdW1lZEZpbGwgaW1wbGVtZW50cyBTaHVmZmxlIHtcbiAgLy8gVE9ETyAtIG90aGVyIGNvbmZpZ3VyYXRpb24/XG5cbiAgcmVhZG9ubHkgc2h1ZmZsZVJ1bGVzOiBTaHVmZmxlUnVsZXM7XG4gXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcm9tOiBSb20sXG4gICAgICAgICAgICAgIHByaXZhdGUgcmVhZG9ubHkgZmxhZ3M6IEZsYWdTZXQpIHtcbiAgICB0aGlzLnNodWZmbGVSdWxlcyA9IG5ldyBTaHVmZmxlUnVsZXMocm9tLCBmbGFncyk7XG4gICAgLy8gRmlyc3QgY29tcHV0ZSBhIHRhYmxlIG9mIGFsbG93ZWQgbG9jYXRpb25zLCBhbmQgd2hldGhlciBpdGVtcyBhcmUgdW5pcXVlLlxuXG4gICAgLy8gRm9yIGVhY2ggc2xvdCwgZmlndXJlIG91dCAoYSkgaXMgaXQgYSBjaGVzdCAob3IgbWltaWMpLCAoYikgaXMgaXQgYSB0cmlnZ2VyIHNxdWFyZS5cbiAgICAvLyBJZiBuZWl0aGVyIHRoZW4gaXQncyBhbiBOUEMgb3IgYm9zc2Ryb3AuXG5cbiAgfVxuXG4gIHByaXZhdGUgZml0cyhzbG90OiBTbG90SWQsIGl0ZW06IEl0ZW1JZCAvKiAsIHVuaXF1ZXNMZWZ0OiBib29sZWFuICovKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuc2h1ZmZsZVJ1bGVzLmZpdHMoc2xvdCwgaXRlbSk7XG4gIH1cblxuICAvLyBOb3RlOiBkdXBsaWNhdGVzIGFyZSBhbGxvd2VkLlxuICBwcm90ZWN0ZWQgaXRlbXMoZ3JhcGg6IEdyYXBoLCByYW5kb206IFJhbmRvbSk6IEl0ZW1JbmRleFtdIHtcbiAgICBjb25zdCBhcnIgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZ3JhcGguaXRlbXMpIHtcbiAgICAgIGlmIChpdGVtLml0ZW0gPT0gbnVsbCkgY29udGludWU7XG4gICAgICBsZXQgY291bnQgPSAxO1xuICAgICAgaWYgKGl0ZW0uaXRlbSA9PT0gMHgwMCB8fCBpdGVtLml0ZW0gPT09IDB4MDEpIGNvdW50ID0gNTtcbiAgICAgIGlmIChpdGVtLml0ZW0gPT09IDB4MDIpIGNvdW50ID0gMTA7XG4gICAgICBpZiAoaXRlbS5pdGVtID09PSAweDAzIHx8IGl0ZW0uaXRlbSA9PT0gMHg0OCkgY291bnQgPSAxNTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgYXJyLnB1c2goaXRlbS5pbmRleCk7XG4gICAgfVxuICAgIHJhbmRvbS5zaHVmZmxlKGFycik7XG4gICAgcmV0dXJuIGFycjtcbiAgfVxuXG4gIGFzeW5jIHNodWZmbGUoZ3JhcGg6IEdyYXBoLFxuICAgICAgICAgICAgICAgIHJhbmRvbTogUmFuZG9tLFxuICAgICAgICAgICAgICAgIHByb2dyZXNzPzogUHJvZ3Jlc3NUcmFja2VyLFxuICAgICAgICAgICAgICAgIGF0dGVtcHRzOiBudW1iZXIgPSAyMDAwKTogUHJvbWlzZTxGaWxsIHwgbnVsbD4ge1xuICAgIGlmIChwcm9ncmVzcykgcHJvZ3Jlc3MuYWRkVGFza3MoTWF0aC5mbG9vcihhdHRlbXB0cyAvIDEwMCkpO1xuICAgIGZvciAobGV0IGF0dGVtcHQgPSAwOyBhdHRlbXB0IDwgYXR0ZW1wdHM7IGF0dGVtcHQrKykge1xuICAgICAgLy8gZW5zdXJlIFVJIHVwZGF0ZXNcbiAgICAgIGlmIChwcm9ncmVzcyAmJiAoYXR0ZW1wdCAlIDEwMCA9PT0gOTkpKSB7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcXVlc3RBbmltYXRpb25GcmFtZSk7XG4gICAgICAgIHByb2dyZXNzLmFkZENvbXBsZXRlZCgxKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5pdGVtcyhncmFwaCwgcmFuZG9tKTtcbiAgICAgIGxldCBoYXMgPSBCaXRzLmZyb20obmV3IFNldChpdGVtcykpO1xuICAgICAgY29uc3QgZmlsbDogSW5kZXhGaWxsID0gbmV3IEdlbmVyaWNGaWxsKCk7XG5cbiAgICAgIC8vIEluaXRpYWxpemUgZmlsbCB3aXRoIG5vbi1zaHVmZmxlZCBpdGVtcy5cbiAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IG5ldyBNYXA8SXRlbUlkIHwgU2xvdElkLCBJdGVtSW5kZXg+KCk7XG4gICAgICBjb25zdCBzbG90SW5kZXggPSBuZXcgTWFwPEl0ZW1JZCB8IFNsb3RJZCwgU2xvdEluZGV4PigpO1xuICAgICAgY29uc3Qgbm9uU2h1ZmZsZWRJdGVtczogSXRlbUlkW10gPSBbXTtcbiAgICAgIGZvciAobGV0IGkgPSBncmFwaC5maXhlZCBhcyBJdGVtSW5kZXg7IGkgPCBncmFwaC5pdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBpZCA9IGdyYXBoLml0ZW1zW2ldLml0ZW07XG4gICAgICAgIGlmIChpZCA9PSBudWxsKSBjb250aW51ZTtcbiAgICAgICAgaXRlbUluZGV4LnNldChpZCwgaSk7XG4gICAgICAgIGlmICghdGhpcy5zaHVmZmxlUnVsZXMuc2hvdWxkU2h1ZmZsZShpZCkpIG5vblNodWZmbGVkSXRlbXMucHVzaChpZCk7XG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IHMgPSBncmFwaC5maXhlZCBhcyBTbG90SW5kZXg7IHMgPCBncmFwaC5zbG90cy5sZW5ndGg7IHMrKykge1xuICAgICAgICBjb25zdCBpZCA9IGdyYXBoLnNsb3RzW3NdLml0ZW07XG4gICAgICAgIGlmIChpZCAhPSBudWxsKSBzbG90SW5kZXguc2V0KGlkLCBzKTtcbiAgICAgIH1cblxuICAgICAgZm9yIChjb25zdCBpZCBvZiBub25TaHVmZmxlZEl0ZW1zKSB7XG4gICAgICAgIGNvbnN0IGkgPSBpdGVtSW5kZXguZ2V0KGlkKTtcbiAgICAgICAgY29uc3QgcyA9IHNsb3RJbmRleC5nZXQoaWQpO1xuICAgICAgICBpZiAocyA9PSBudWxsIHx8IGkgPT0gbnVsbCkgY29udGludWU7XG4gICAgICAgIGZpbGwuc2V0KHMsIGkpO1xuICAgICAgICBoYXMgPSBCaXRzLndpdGhvdXQoaGFzLCBpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuZmxhZ3MuZ3VhcmFudGVlU3dvcmQoKSkge1xuICAgICAgICAvLyBwaWNrIGEgc3dvcmQgYXQgcmFuZG9tIGFuZCBwdXQgaXQgaW4gc2xvdCAwXG4gICAgICAgIGNvbnN0IHN3b3JkID0gcmFuZG9tLm5leHRJbnQoNCkgYXMgSXRlbUlkO1xuICAgICAgICBjb25zdCBpID0gaXRlbUluZGV4LmdldChzd29yZCk7XG4gICAgICAgIGNvbnN0IHMgPSBzbG90SW5kZXguZ2V0KDAgYXMgU2xvdElkKTsgLy8gZWxkZXIgbm9ybWFsbCBnaXZlcyBzd29yZCBvZiB3aW5kXG4gICAgICAgIGlmIChpICE9IG51bGwgJiYgcyAhPSBudWxsICYmICFmaWxsLmhhc1Nsb3QocykgJiYgIWZpbGwuaGFzSXRlbShpKSkge1xuICAgICAgICAgIGZpbGwuc2V0KHMsIGkpO1xuICAgICAgICAgIGhhcyA9IEJpdHMud2l0aG91dChoYXMsIGkpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFRPRE86IGlmIGV4aXRzIHNodWZmbGVkIHRoZW4gZmluZCBhIHNsb3QgaW4gemVyby1zcGhlcmUuXG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5maWxsSW50ZXJuYWwoZ3JhcGgsIHJhbmRvbSwgZmlsbCwgaXRlbXMsIGhhcywgTWF0aC5mbG9vcihhdHRlbXB0IC8gNSkpKSBjb250aW51ZTtcblxuICAgICAgY29uc3QgZmluYWwgPSB0cmF2ZXJzZShncmFwaCwgZmlsbCwgQml0cy5vZigpKTtcbiAgICAgIGlmIChmaW5hbC5zaXplICE9PSBncmFwaC5zbG90cy5sZW5ndGgpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcigndW5leHBlY3RlZCBzaXplIG1pc21hdGNoIScsIGZpbmFsLCBncmFwaCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3Qgb3V0ID0gdGhpcy5maWxsKGdyYXBoLCBleHBhbmRGaWxsKGdyYXBoLCBmaWxsKSwgcmFuZG9tKTtcbiAgICAgIGlmIChvdXQgPT0gbnVsbCkgY29udGludWU7XG4gICAgICBpZiAocHJvZ3Jlc3MpIHByb2dyZXNzLmFkZENvbXBsZXRlZChNYXRoLmZsb29yKChhdHRlbXB0cyAtIGF0dGVtcHQpIC8gMTAwKSk7XG4gICAgICByZXR1cm4gb3V0O1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByb3RlY3RlZCBmaWxsSW50ZXJuYWwoZ3JhcGg6IEdyYXBoLFxuICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbTogUmFuZG9tLFxuICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6IEluZGV4RmlsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogSXRlbUluZGV4W10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgaGFzOiBCaXRzLFxuICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tTdGVwczogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgZm9yIChsZXQgYml0OiBJdGVtSW5kZXggfCB1bmRlZmluZWQgPSBpdGVtcy5wb3AoKTsgYml0ICE9IG51bGw7IGJpdCA9IGl0ZW1zLnBvcCgpKSB7XG4gICAgICBpZiAoIUJpdHMuaGFzKGhhcywgYml0KSkgY29udGludWU7IC8vIGl0ZW0gYWxyZWFkeSBwbGFjZWQ6IHNraXBcbiAgICAgIGNvbnN0IGl0ZW1JZCA9IGdyYXBoLml0ZW1zW2JpdF0uaXRlbTtcbiAgICAgIGlmIChpdGVtSWQgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBiYWQgaXRlbTogJHtPYmplY3QuZW50cmllcyhncmFwaC5pdGVtc1tiaXRdKX1gKTtcbiAgICAgIGhhcyA9IEJpdHMud2l0aG91dChoYXMsIGJpdCk7XG4gICAgICBjb25zdCByZWFjaGFibGUgPSBbLi4udHJhdmVyc2UoZ3JhcGgsIGZpbGwsIGhhcyldO1xuICAgICAgcmFuZG9tLnNodWZmbGUocmVhY2hhYmxlKTtcbiAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgICAgZm9yIChjb25zdCBzbG90IG9mIHJlYWNoYWJsZSkge1xuICAgICAgICBjb25zdCBzbG90SWQgPSBncmFwaC5zbG90c1tzbG90XS5pdGVtO1xuICAgICAgICBpZiAoc2xvdElkID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgICBpZiAoIWZpbGwuaGFzU2xvdChzbG90KSAmJiB0aGlzLmZpdHMoc2xvdElkLCBpdGVtSWQgLyosIHRydWUqLykpIHsgLy8gc2xvdCAhPT0gdGhpcy53aW4gJiZcbiAgICAgICAgICBmaWxsLnNldChzbG90LCBiaXQpO1xuICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGZvdW5kKSBjb250aW51ZTtcbiAgICAgIGlmIChiYWNrU3RlcHMtLSA+IDApIHtcbiAgICAgICAgLy8gdGFrZSBhIGJhY2sgc3RlcC5cbiAgICAgICAgZm9yIChjb25zdCBzbG90IG9mIHJlYWNoYWJsZSkge1xuICAgICAgICAgIGNvbnN0IHNsb3RJZCA9IGdyYXBoLnNsb3RzW3Nsb3RdLml0ZW07XG4gICAgICAgICAgaWYgKHNsb3RJZCA9PSBudWxsKSBjb250aW51ZTtcbiAgICAgICAgICBpZiAodGhpcy5maXRzKHNsb3RJZCwgaXRlbUlkKSkge1xuICAgICAgICAgICAgY29uc3QgcHJldmlvdXNJdGVtID0gZmlsbC5zbG90c1tzbG90XTtcbiAgICAgICAgICAgIGZpbGwuc2xvdHNbc2xvdF0gPSBmaWxsLml0ZW1zW3ByZXZpb3VzSXRlbV0gPSB1bmRlZmluZWQgYXMgYW55O1xuICAgICAgICAgICAgaGFzID0gQml0cy53aXRoKGhhcywgcHJldmlvdXNJdGVtKTtcbiAgICAgICAgICAgIGl0ZW1zLnB1c2gocHJldmlvdXNJdGVtKTtcbiAgICAgICAgICAgIHJhbmRvbS5zaHVmZmxlKGl0ZW1zKTtcbiAgICAgICAgICAgIGZpbGwuc2V0KHNsb3QsIGJpdCk7XG4gICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICBicmVhazsgICAgICAgICAgICBcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvdW5kKSBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIC8vIFRPRE8gLSBpdCBsb29rcyBsaWtlIHdlJ3JlIHBsYWNpbmcgcmFuZG9tIGl0ZW1zIGluIG1hZ2ljIHNsb3RzIHdoZW4gU20gaXMgb2ZmPyE/XG4gICAgICAvLyAgICAgLS0tLT4gZmlndXJlIG91dCB3aGF0IHdhcyBwbGFjZWQgaW4gaXRzIHNwb3Q/XG4gICAgICAvLyBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gcGxhY2Uga2V5IGl0ZW0gJHtpdGVtSWR9OiBhdmFpbGFibGUgJHtyZWFjaGFibGUubWFwKHMgPT4gZ3JhcGguc2xvdHNbc10uaXRlbSl9YCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqIEZpbHMgdGhlIHJlbWFpbmluZyBzbG90cyB3aXRoIG5vbi1wcm9ncmVzc2lvbiBpdGVtcy4gKi9cbiAgcHJpdmF0ZSBmaWxsKGdyYXBoOiBHcmFwaCwgZmlsbDogRmlsbCwgcmFuZG9tOiBSYW5kb20pOiBGaWxsIHwgbnVsbCB7XG4gICAgLy8gRmlndXJlIG91dCB3aGF0IHN0aWxsIG5lZWRzIHRvIGJlIGZpbGxlZC4gIFdpbGwgYmUgbW9zdGx1IGNvbnN1bWFibGVzIG9yIG1pbWljcy5cbiAgICAvLyBTdGFydCB3aXRoIHVuaXF1ZSBpdGVtcyBzaW5jZSB3ZSBoYXZlIHJ1bGVzIHRvIHByZXZlbnQgcHV0dGluZyB1bmlxdWVzIGluIG5vbi11bmlxdWVcbiAgICAvLyBzbG90cyAoaWYgdGhlIGZsYWcgaXMgc2V0KSBidXQgbm90IHZpY2UgdmVyc2EuXG4gICAgY29uc3QgdmFsaWRJdGVtcyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGZvciAoY29uc3Qgc2xvdCBvZiBncmFwaC5zbG90cykge1xuICAgICAgaWYgKHNsb3QuaXRlbSAhPSBudWxsKSB2YWxpZEl0ZW1zLmFkZChzbG90Lml0ZW0pO1xuICAgIH1cblxuICAgIGNvbnN0IHVuaXF1ZXM6IEl0ZW1JZFtdID0gW107XG4gICAgY29uc3QgY29uc3VtYWJsZXM6IEl0ZW1JZFtdID0gW107XG4gICAgY29uc3QgbWltaWNzOiBJdGVtSWRbXSA9IFtdO1xuICAgIC8vIGVhcmx5U2xvdHMgYXJlIGZpbGxlZCBmaXJzdCwgaWYgdGhleSdyZSBub24tZW1wdHkuXG4gICAgY29uc3QgZWFybHlTbG90czogU2xvdElkW10gPSBbXTtcbiAgICBjb25zdCBvdGhlclNsb3RzOiBTbG90SWRbXSA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwIGFzIFNsb3RJZCAmIEl0ZW1JZDsgaSA8IDB4N2M7IGkrKykge1xuICAgICAgaWYgKGkgPCAweDcwICYmICF2YWxpZEl0ZW1zLmhhcyhpKSkge1xuICAgICAgICBpZiAoZmlsbC5oYXNTbG90KGkpICE9PSBmaWxsLmhhc0l0ZW0oaSkpIGNvbnNvbGUuZXJyb3IoJ01JU01BVENIJyxpKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoIWZpbGwuaGFzU2xvdChpKSAmJiAhZmlsbC5oYXNJdGVtKGkpICYmICF0aGlzLnNodWZmbGVSdWxlcy5zaG91bGRTaHVmZmxlKGkpKSB7XG4gICAgICAgIGZpbGwuc2V0KGksIGkpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmICghZmlsbC5oYXNTbG90KGkpKSB7XG4gICAgICAgIGlmICh0aGlzLnNodWZmbGVSdWxlcy5pc0Vhcmx5KGkpKSB7XG4gICAgICAgICAgZWFybHlTbG90cy5wdXNoKGkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG90aGVyU2xvdHMucHVzaChpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFmaWxsLmhhc0l0ZW0oaSkpIHtcbiAgICAgICAgaWYgKGkgPD0gMHg0OCAmJiB0aGlzLnJvbS5pdGVtc1tpXS51bmlxdWUpIHtcbiAgICAgICAgICB1bmlxdWVzLnB1c2goaSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaSA8IDB4NzApIHtcbiAgICAgICAgICBjb25zdW1hYmxlcy5wdXNoKGkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG1pbWljcy5wdXNoKGkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJhbmRvbS5zaHVmZmxlKGVhcmx5U2xvdHMpO1xuICAgIHJhbmRvbS5zaHVmZmxlKG90aGVyU2xvdHMpO1xuICAgIHJhbmRvbS5zaHVmZmxlKHVuaXF1ZXMpO1xuICAgIHJhbmRvbS5zaHVmZmxlKGNvbnN1bWFibGVzKTtcblxuICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVycy5jb25jYXQodW5pcXVlcywgbWltaWNzLCBjb25zdW1hYmxlcykpIHtcbiAgICAgIC8vIFRyeSB0byBwbGFjZSB0aGUgaXRlbSwgc3RhcnRpbmcgd2l0aCBlYXJsaWVzIGZpcnN0LlxuICAgICAgLy8gTWltaWNzIGNvbWUgYmVmb3JlIGNvbnN1bWFibGVzIGJlY2F1c2UgdGhlcmUncyBmZXdlciBwbGFjZXMgdGhleSBjYW4gZ28uXG4gICAgICAvLyBTaW5jZSBrZXkgc2xvdHMgYXJlIGFsbG93ZWQgdG8gY29udGFpbiBjb25zdW1hYmxlcyAoZXZlbiBpbiBmdWxsIHNodWZmbGUpLFxuICAgICAgLy8gd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdCB0aGUgdW5pcXVlcyBnbyBpbnRvIHRob3NlIHNsb3RzIGZpcnN0LlxuICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgICBmb3IgKGNvbnN0IHNsb3RzIG9mIFtlYXJseVNsb3RzLCBvdGhlclNsb3RzXSkge1xuICAgICAgICBpZiAoZm91bmQpIGJyZWFrO1xuICAgICAgICBmb3IgKGNvbnN0IHNsb3Qgb2Ygc2xvdHMpIHtcbiAgICAgICAgICBpZiAodGhpcy5maXRzKHNsb3QsIGl0ZW0gLyosIGZhbHNlKi8pKSB7XG4gICAgICAgICAgICBmaWxsLnNldChzbG90LCBpdGVtKTtcbiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICAgIHNsb3RzLnNwbGljZShzbG90cy5pbmRleE9mKHNsb3QpLCAxKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFmb3VuZCkge1xuICAgICAgICAvLyBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZmlsbCBleHRyYSBpdGVtICR7aXRlbX0uIFNsb3RzOiAke2Vhcmx5U2xvdHN9LCAke290aGVyU2xvdHN9YCk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmlsbDtcbiAgfVxufVxuXG5mdW5jdGlvbiByZXF1aXJlc0NoZXN0KGlkOiBJdGVtSWQpOiBib29sZWFuIHtcbiAgcmV0dXJuIGlkID09PSAweDE0IHx8IGlkID09PSAweDFiIHx8IGlkID09PSAweDFjIHx8IGlkID09PSAweDI2O1xufVxuXG4vLyBleHBvcnQgY2xhc3MgRm9yd2FyZEZpbGwgZXh0ZW5kcyBBc3N1bWVkRmlsbCB7XG4vLyAgIHByb3RlY3RlZCBmaWxsSW50ZXJuYWwoZ3JhcGg6IEdyYXBoLFxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbTogUmFuZG9tLFxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6IEluZGV4RmlsbCxcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogSXRlbUluZGV4W10sXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzOiBCaXRzKTogYm9vbGVhbiB7XG4vLyAgICAgd2hpbGUgKCFCaXRzLmVtcHR5KGhhcykpIHtcbi8vICAgICAgIC8vIFdoYXQncyByZWFjaGFibGUgd2l0aCBub3RoaW5nP1xuLy8gICAgICAgY29uc3QgcmVhY2hhYmxlID0gWy4uLnRyYXZlcnNlKGdyYXBoLCBmaWxsLCBCaXRzLm9mKCkpXTtcbi8vICAgICAgIC8vIFdoYXQgYXJlIHRoZSBpbW1lZGlhdGUgYmxvY2tzPyE/IE5lZWQgdG8gYWRkIGFuIEFQSSB0byBnZXQgdGhlc2U/XG4vLyAgICAgICAvLyBUcmFuc2xhdGUgcmVhY2hhYmJsZSBpbnRvIGEgXCJoYXNcIlxuLy8gICAgICAgbGV0IGdldHRhYmxlID0gQml0cy5mcm9tKFxuLy8gICAgICAgICAgIHJlYWNoYWJsZS5tYXAocyA9PiBzIDwgZ3JhcGguZml4ZWQgPyBzIDogZmlsbC5zbG90c1tzXSkuZmlsdGVyKGkgPT4gaSkpO1xuLy8gICAgICAgbGV0IHVubG9ja3MgPSBuZXcgU2V0PEl0ZW1JbmRleD4oKTtcbi8vICAgICAgIGNvbnN0IHVubG9ja3MyID0gbmV3IFNldDxJdGVtSW5kZXg+KCk7XG4vLyAgICAgICBmb3IgKGxldCBzID0gMCBhcyBTbG90SW5kZXg7IHMgPCBncmFwaC5ncmFwaC5sZW5ndGg7IHMrKykge1xuLy8gICAgICAgICBmb3IgKGNvbnN0IHJvdXRlIG9mIGdyYXBoLmdyYXBoW3NdKSB7XG4vLyAgICAgICAgICAgY29uc3QgYml0cyA9IEJpdHMuYml0cyhCaXRzLmRpZmZlcmVuY2Uocm91dGUsIGdldHRhYmxlKSkgYXMgSXRlbUluZGV4W107XG4vLyAgICAgICAgICAgaWYgKGJpdHMubGVuZ3RoID09PSAxKSB1bmxvY2tzLmFkZChiaXRzWzBdKTtcbi8vICAgICAgICAgICBpZiAoYml0cy5sZW5ndGggPT09IDIpIHtcbi8vICAgICAgICAgICAgIHVubG9ja3MyLmFkZChiaXRzWzBdKTtcbi8vICAgICAgICAgICAgIHVubG9ja3MyLmFkZChiaXRzWzFdKTtcbi8vICAgICAgICAgICAgIC8vIFRPRE8gLSBtdWx0aW1hcCwgYW5kIHRoZW4gZ28gd2l0aCBpdGVtIHRoYXQncyBsZWFzdCBldmVudGZ1bFxuLy8gICAgICAgICAgIH1cbi8vICAgICAgICAgfSAgICAgICAgXG4vLyAgICAgICB9XG5cbi8vICAgICAgIC8vIFBpY2sgYW4gdW5sb2NrYWJsZSBhbmQgYSBzbG90LlxuLy8gICAgICAgY29uc3QgYWxsSXRlbXMgPSBbLi4uKHVubG9ja3Muc2l6ZSA/IHVubG9ja3MgOiB1bmxvY2tzMildO1xuLy8gICAgICAgY29uc3QgaXRlbSA9IGFsbEl0ZW1zW3JhbmRvbS5uZXh0SW50KGFsbEl0ZW1zLmxlbmd0aCldO1xuICAgICAgXG4vLyAgICAgLy8gICByYW5kb20uc2h1ZmZsZShyZWFjaGFibGUpO1xuLy8gICAgIC8vICAgbGV0IGZvdW5kID0gZmFsc2U7XG4vLyAgICAgLy8gICBmb3IgKGNvbnN0IHNsb3Qgb2YgcmVhY2hhYmxlKSB7XG4vLyAgICAgLy8gICAgIGNvbnN0IHNsb3RJZCA9IGdyYXBoLnNsb3RzW3Nsb3RdLml0ZW07XG4vLyAgICAgLy8gICAgIGlmIChzbG90SWQgPT0gbnVsbCkgY29udGludWU7XG4vLyAgICAgLy8gICAgIGlmICghZmlsbC5oYXNTbG90KHNsb3QpICYmIHRoaXMuZml0cyhzbG90SWQsIGl0ZW1JZCAvKiwgdHJ1ZSovKSkgeyAvLyBzbG90ICE9PSB0aGlzLndpbiAmJlxuLy8gICAgIC8vICAgICAgIGZpbGwuc2V0KHNsb3QsIGJpdCk7XG4vLyAgICAgLy8gICAgICAgZm91bmQgPSB0cnVlO1xuLy8gICAgIC8vICAgICAgIGJyZWFrO1xuLy8gICAgIC8vICAgICB9XG4vLyAgICAgLy8gICB9XG4vLyAgICAgLy8gICBpZiAoIWZvdW5kKSB7XG5cbi8vICAgICAvLyAgICAgLy8gVE9ETyAtIGl0IGxvb2tzIGxpa2Ugd2UncmUgcGxhY2luZyByYW5kb20gaXRlbXMgaW4gbWFnaWMgc2xvdHMgd2hlbiBTbSBpcyBvZmY/IT9cbi8vICAgICAvLyAgICAgLy8gICAgIC0tLS0+IGZpZ3VyZSBvdXQgd2hhdCB3YXMgcGxhY2VkIGluIGl0cyBzcG90P1xuXG4vLyAgICAgLy8gICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBwbGFjZSBrZXkgaXRlbSAke2l0ZW1JZH06IGF2YWlsYWJsZSAke3JlYWNoYWJsZS5tYXAocyA9PiBncmFwaC5zbG90c1tzXS5pdGVtKX1gKTtcbi8vICAgICAvLyAgICAgcmV0dXJuIGZhbHNlO1xuLy8gICAgIC8vICAgfVxuICAgICAgICAgICAgICAgICAgICAgICBcbi8vICAgICAvLyB9XG5cblxuLy8gICAgIGZvciAobGV0IGJpdDogSXRlbUluZGV4IHwgdW5kZWZpbmVkID0gaXRlbXMucG9wKCk7IGJpdCAhPSBudWxsOyBiaXQgPSBpdGVtcy5wb3AoKSkge1xuLy8gICAgICAgaWYgKCFCaXRzLmhhcyhoYXMsIGJpdCkpIGNvbnRpbnVlOyAvLyBpdGVtIGFscmVhZHkgcGxhY2VkOiBza2lwXG4vLyAgICAgICBjb25zdCBpdGVtSWQgPSBncmFwaC5pdGVtc1tiaXRdLml0ZW07XG4vLyAgICAgICBpZiAoaXRlbUlkID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgYmFkIGl0ZW06ICR7T2JqZWN0LmVudHJpZXMoZ3JhcGguaXRlbXNbYml0XSl9YCk7XG4vLyAgICAgICBoYXMgPSBCaXRzLndpdGhvdXQoaGFzLCBiaXQpO1xuLy8gICAgICAgY29uc3QgcmVhY2hhYmxlID0gWy4uLnRyYXZlcnNlKGdyYXBoLCBmaWxsLCBoYXMpXTtcbi8vICAgICAgIHJhbmRvbS5zaHVmZmxlKHJlYWNoYWJsZSk7XG4vLyAgICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbi8vICAgICAgIGZvciAoY29uc3Qgc2xvdCBvZiByZWFjaGFibGUpIHtcbi8vICAgICAgICAgY29uc3Qgc2xvdElkID0gZ3JhcGguc2xvdHNbc2xvdF0uaXRlbTtcbi8vICAgICAgICAgaWYgKHNsb3RJZCA9PSBudWxsKSBjb250aW51ZTtcbi8vICAgICAgICAgaWYgKCFmaWxsLmhhc1Nsb3Qoc2xvdCkgJiYgdGhpcy5maXRzKHNsb3RJZCwgaXRlbUlkIC8qLCB0cnVlKi8pKSB7IC8vIHNsb3QgIT09IHRoaXMud2luICYmXG4vLyAgICAgICAgICAgZmlsbC5zZXQoc2xvdCwgYml0KTtcbi8vICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4vLyAgICAgICAgICAgYnJlYWs7XG4vLyAgICAgICAgIH1cbi8vICAgICAgIH1cbi8vICAgICAgIGlmICghZm91bmQpIHtcblxuLy8gICAgICAgICAvLyBUT0RPIC0gaXQgbG9va3MgbGlrZSB3ZSdyZSBwbGFjaW5nIHJhbmRvbSBpdGVtcyBpbiBtYWdpYyBzbG90cyB3aGVuIFNtIGlzIG9mZj8hP1xuLy8gICAgICAgICAvLyAgICAgLS0tLT4gZmlndXJlIG91dCB3aGF0IHdhcyBwbGFjZWQgaW4gaXRzIHNwb3Q/XG5cbi8vICAgICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHBsYWNlIGtleSBpdGVtICR7aXRlbUlkfTogYXZhaWxhYmxlICR7cmVhY2hhYmxlLm1hcChzID0+IGdyYXBoLnNsb3RzW3NdLml0ZW0pfWApO1xuLy8gICAgICAgICByZXR1cm4gZmFsc2U7XG4vLyAgICAgICB9XG4vLyAgICAgfVxuLy8gICAgIHJldHVybiB0cnVlO1xuLy8gICB9XG4vLyB9XG4iXX0=