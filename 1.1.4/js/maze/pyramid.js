export function shufflePyramid(rom, random) {
    const loc = rom.locations.pyramidMain;
    const dir = 'dudududuudududduu'.split('');
    let realDir = 'u';
    if (random.next() < 0.5) {
        loc.screens[0][3] = 0x84;
        loc.screens[0][2] = 0x99;
        dir[16] = realDir = 'd';
        loc.entrances[12].screen = loc.entrances[16].screen;
        loc.entrances[12].coord = loc.entrances[16].coord;
        loc.exits[2 * 12].screen = loc.exits[2 * 16].screen;
        loc.exits[2 * 12].tile = loc.exits[2 * 16].tile;
        loc.exits[2 * 12 + 1].screen = loc.exits[2 * 16 + 1].screen;
        loc.exits[2 * 12 + 1].tile = loc.exits[2 * 16 + 1].tile;
        loc.entrances[16].screen = 0x02;
        loc.entrances[16].coord = 0xafd0;
        loc.exits[2 * 16].screen = loc.exits[2 * 16 + 1].screen = 0x02;
        loc.exits[2 * 16].tile = 0xbc;
        loc.exits[2 * 16 + 1].tile = 0xbd;
        const loc2 = rom.locations.pyramidDraygon;
        loc2.width = 2;
        loc2.screens[0].push(0x9a);
        loc2.screens[1].push(0xfd);
        loc2.screens[2] = [0xe0, 0xe1];
        loc2.exits[0].screen = loc2.exits[1].screen = 0x01;
        loc2.exits[0].tile = 0xc7;
        loc2.exits[1].tile = 0xc8;
        loc2.entrances[0].screen = 0x01;
        loc2.entrances[0].coord = 0xd080;
    }
    const all = { 'u': [], 'd': [] };
    for (let i = 0; i < dir.length; i++) {
        all[dir[i]].push(i);
    }
    random.shuffle(all['u']);
    random.shuffle(all['d']);
    const realEntrance = all[realDir].pop();
    const entrances = [];
    entrances[16] = loc.entrances[realEntrance];
    setExit(realEntrance, 0x9f, 0);
    const upEntrance = all['u'].pop();
    entrances[1] = loc.entrances[upEntrance];
    setExit(upEntrance, 0x9d, 2);
    let downEntrance = all['d'].pop();
    if (realDir === 'u' && downEntrance === 0xe && upEntrance === 0xc) {
        [downEntrance] = all['d'].splice(0, 1, downEntrance);
    }
    else if (realDir === 'd' &&
        ((downEntrance === 0xe && realEntrance === 0x10) ||
            (downEntrance === 0x10 && realEntrance === 0xe))) {
        [downEntrance] = all['d'].splice(0, 1, downEntrance);
    }
    entrances[0] = loc.entrances[downEntrance];
    setExit(downEntrance, 0x9d, 1);
    do {
        const sources = { 'u': [...all['u']], 'd': [...all['d']] };
        const dests = { 'u': [...all['u']], 'd': [...all['d']] };
        random.shuffle(dests['u']);
        random.shuffle(dests['d']);
        const inv = { 'u': 'd', 'd': 'u' };
        for (let i = 2; i < 16; i++) {
            const source = sources[dir[i]].pop();
            const dest = dests[inv[dir[i]]].pop();
            if (source == null || dest == null)
                throw new Error('impossible');
            entrances[i] = loc.entrances[source];
            setExit(dest, 0x9e, i);
        }
        const cExit = loc.exits[2 * 0xc];
        const eExit = loc.exits[2 * 0xe];
        if (realDir === 'u' && cExit.dest === eExit.dest &&
            loc.entrances[0xe] === entrances[cExit.entrance] &&
            loc.entrances[0xc] === entrances[eExit.entrance]) {
            continue;
        }
        break;
    } while (true);
    loc.entrances = entrances;
    function setExit(i, dest, entrance) {
        loc.exits[2 * i].dest = loc.exits[2 * i + 1].dest = dest;
        loc.exits[2 * i].entrance = loc.exits[2 * i + 1].entrance = entrance;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHlyYW1pZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9tYXplL3B5cmFtaWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsTUFBTSxVQUFVLGNBQWMsQ0FBQyxHQUFRLEVBQUUsTUFBYztJQWtCckQsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUM7SUFDdEMsTUFBTSxHQUFHLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBVSxDQUFDO0lBQ25ELElBQUksT0FBTyxHQUFRLEdBQUcsQ0FBQztJQUd2QixJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsR0FBRyxHQUFHLEVBQUU7UUFFdkIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDekIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDekIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sR0FBRyxHQUFHLENBQUM7UUFHeEIsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDcEQsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDbEQsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNwRCxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ2hELEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUM1RCxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFHeEQsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2hDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztRQUNqQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFDL0QsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUM5QixHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUdsQyxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQztRQUMxQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FB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O1FBRUQsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDakMsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDakMsSUFBSSxPQUFPLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLElBQUk7WUFDNUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsS0FBSyxTQUFTLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQztZQUNoRCxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDcEQsU0FBUztTQUNWO1FBQ0QsTUFBTTtLQUNQLFFBQVEsSUFBSSxFQUFFO0lBQ2YsR0FBRyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFFMUIsU0FBUyxPQUFPLENBQUMsQ0FBUyxFQUFFLElBQVksRUFBRSxRQUFnQjtRQUN4RCxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDekQsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQ3ZFLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSYW5kb219IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RW50cmFuY2V9IGZyb20gJy4uL3JvbS9sb2NhdGlvbi5qcyc7XG5cbnR5cGUgRGlyID0gJ3UnIHwgJ2QnO1xuXG5leHBvcnQgZnVuY3Rpb24gc2h1ZmZsZVB5cmFtaWQocm9tOiBSb20sIHJhbmRvbTogUmFuZG9tKTogdm9pZCB7XG4gIC8vIFRoZSBweXJhbWlkIGhhcyAxNyBlbnRyYW5jZXMvZXhpdHM6IDggZG93biwgOSB1cC5cbiAgLy8gVGhlIGVudHJhbmNlcyBhbmQgZXhpdHMgYXJlIHBhaXJlZDogZW50cmFuY2UgMCA8PT0+IGV4aXRzIDAgYW5kIDEsXG4gIC8vIGVudHJhbmNlIDEgPD09PiBleGl0cyAyIGFuZCAzLCBldGMuICBOb3JtYWxseSAwIGFuZCAxIGdvIGJhY2sgdG9cbiAgLy8gdGhlIGVudHJhbmNlIGFuZCAxNiBhZHZhbmNlcy5cbiAgLy9cbiAgLy8gT3VyIHN0cmF0ZWd5IGhlcmUgaXMgdG8gc2h1ZmZsZSB0aGUgcG9zaXRpb25zIG9mIHRoZSBlbnRyYW5jZXMsXG4gIC8vIHNvIHRoYXQgd2UgZG9uJ3QgbmVlZCB0byBjaGFuZ2UgdGhlIGV4aXQgZGVzdGluYXRpb25zIHBvaW50aW5nXG4gIC8vIHRvIHRoZW0uICBXZSBzdGFydCBieSBwaWNraW5nIDMgZW50cmFuY2VzIHRvIGJlIG5vcm1hbCwgYW5kIHB1bGxcbiAgLy8gdGhlbSBvdXQgb2YgdGhlIG1peCwgYXNzaWduaW5nIHRoZW0gdGhlIGNvcnJlY3QgaW5mb3JtYXRpb24gc29cbiAgLy8gdGhhdCB0aGV5J3JlIHByb3Blcmx5IHJldmVyc2libGUuICBUaGUgcmVtYWluaW5nIDcgdXAgYW5kIDcgZG93blxuICAvLyBlbnRyYW5jZXMgYXJlIHRoZW4gcGFpcmVkIHVwIHJhbmRvbWx5LCBub3QgbmVjZXNzYXJpbHkgcmV2ZXJzaWJseS5cbiAgLy9cbiAgLy8gVGhlcmUncyBvbmUgZWRnZSBjYXNlIHRvIGJlIGF3YXJlIG9mOiBpdCdzIHBvc3NpYmxlIHRoYXQgdGhlIGNoZXN0XG4gIC8vIHJvb20gZm9ybXMgYSBjbG9zZWQgbG9vcCwgZWl0aGVyIGJlY2F1c2UgYm90aCBiYWNrIGVudHJhbmNlcyBhcmVcbiAgLy8gdGhlcmUsIG9yIGJlY2F1c2UgdGhleSByZXZlcnNpYmx5IHBvaW50IHRvIGVhY2ggb3RoZXIuICBXZSBtdXN0XG4gIC8vIGRldGVjdCBlaXRoZXIgY2FzZSBhbmQgcmVyb2xsLlxuXG4gIGNvbnN0IGxvYyA9IHJvbS5sb2NhdGlvbnMucHlyYW1pZE1haW47XG4gIGNvbnN0IGRpciA9ICdkdWR1ZHVkdXVkdWR1ZGR1dScuc3BsaXQoJycpIGFzIERpcltdO1xuICBsZXQgcmVhbERpcjogRGlyID0gJ3UnO1xuXG4gIC8vIDUwJSBjaGFuY2UgdG8gZmxpcCB0aGUgdG9wIGVudHJhbmNlIHVwc2lkZSBkb3duLlxuICBpZiAocmFuZG9tLm5leHQoKSA8IDAuNSkge1xuICAgIC8vIEFkZCBhbiBleHRyYSBzY3JlZW4gdG8gcG9pbnQgdGhlIHRvcCBleGl0IGRvd253YXJkLlxuICAgIGxvYy5zY3JlZW5zWzBdWzNdID0gMHg4NDtcbiAgICBsb2Muc2NyZWVuc1swXVsyXSA9IDB4OTk7XG4gICAgZGlyWzE2XSA9IHJlYWxEaXIgPSAnZCc7XG5cbiAgICAvLyBNb3ZlIGVudHJhbmNlIDEyIHRvIHRoZSB2YW5pbGxhIGFkdmFuY2VtZW50IGRvb3IuXG4gICAgbG9jLmVudHJhbmNlc1sxMl0uc2NyZWVuID0gbG9jLmVudHJhbmNlc1sxNl0uc2NyZWVuO1xuICAgIGxvYy5lbnRyYW5jZXNbMTJdLmNvb3JkID0gbG9jLmVudHJhbmNlc1sxNl0uY29vcmQ7XG4gICAgbG9jLmV4aXRzWzIgKiAxMl0uc2NyZWVuID0gbG9jLmV4aXRzWzIgKiAxNl0uc2NyZWVuO1xuICAgIGxvYy5leGl0c1syICogMTJdLnRpbGUgPSBsb2MuZXhpdHNbMiAqIDE2XS50aWxlO1xuICAgIGxvYy5leGl0c1syICogMTIgKyAxXS5zY3JlZW4gPSBsb2MuZXhpdHNbMiAqIDE2ICsgMV0uc2NyZWVuO1xuICAgIGxvYy5leGl0c1syICogMTIgKyAxXS50aWxlID0gbG9jLmV4aXRzWzIgKiAxNiArIDFdLnRpbGU7XG5cbiAgICAvLyBNb3ZlIGVudHJhbmNlIDE2IHRvIHRoZSBuZXcgdGlsZS5cbiAgICBsb2MuZW50cmFuY2VzWzE2XS5zY3JlZW4gPSAweDAyO1xuICAgIGxvYy5lbnRyYW5jZXNbMTZdLmNvb3JkID0gMHhhZmQwO1xuICAgIGxvYy5leGl0c1syICogMTZdLnNjcmVlbiA9IGxvYy5leGl0c1syICogMTYgKyAxXS5zY3JlZW4gPSAweDAyO1xuICAgIGxvYy5leGl0c1syICogMTZdLnRpbGUgPSAweGJjO1xuICAgIGxvYy5leGl0c1syICogMTYgKyAxXS50aWxlID0gMHhiZDtcblxuICAgIC8vIEZpeCB1cCB0aGUgbGFuZGluZyB0byBiZSB0aGUgb3RoZXIgZGlyZWN0aW9uLCB0b28uXG4gICAgY29uc3QgbG9jMiA9IHJvbS5sb2NhdGlvbnMucHlyYW1pZERyYXlnb247XG4gICAgbG9jMi53aWR0aCA9IDI7XG4gICAgbG9jMi5zY3JlZW5zWzBdLnB1c2goMHg5YSk7XG4gICAgbG9jMi5zY3JlZW5zWzFdLnB1c2goMHhmZCk7XG4gICAgbG9jMi5zY3JlZW5zWzJdID0gWzB4ZTAsIDB4ZTFdO1xuICAgIGxvYzIuZXhpdHNbMF0uc2NyZWVuID0gbG9jMi5leGl0c1sxXS5zY3JlZW4gPSAweDAxO1xuICAgIGxvYzIuZXhpdHNbMF0udGlsZSA9IDB4Yzc7XG4gICAgbG9jMi5leGl0c1sxXS50aWxlID0gMHhjODtcbiAgICBsb2MyLmVudHJhbmNlc1swXS5zY3JlZW4gPSAweDAxO1xuICAgIGxvYzIuZW50cmFuY2VzWzBdLmNvb3JkID0gMHhkMDgwO1xuICB9XG5cbiAgY29uc3QgYWxsID0geyd1JzogW10gYXMgbnVtYmVyW10sICdkJzogW10gYXMgbnVtYmVyW119O1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGRpci5sZW5ndGg7IGkrKykge1xuICAgIGFsbFtkaXJbaV1dLnB1c2goaSk7XG4gIH1cblxuICByYW5kb20uc2h1ZmZsZShhbGxbJ3UnXSk7XG4gIHJhbmRvbS5zaHVmZmxlKGFsbFsnZCddKTtcbiAgY29uc3QgcmVhbEVudHJhbmNlID0gYWxsW3JlYWxEaXJdLnBvcCgpITtcblxuICBjb25zdCBlbnRyYW5jZXM6IEVudHJhbmNlW10gPSBbXTtcbiAgLy8gRml4IHRoZSBcInJlYWwgZW50cmFuY2VcIlxuICBlbnRyYW5jZXNbMTZdID0gbG9jLmVudHJhbmNlc1tyZWFsRW50cmFuY2VdO1xuICBzZXRFeGl0KHJlYWxFbnRyYW5jZSwgMHg5ZiwgMCk7XG4gIC8vIEZpeCB0aGUgYnJhbmNoZWQgZW50cmFuY2VzXG4gIGNvbnN0IHVwRW50cmFuY2UgPSBhbGxbJ3UnXS5wb3AoKSE7XG4gIGVudHJhbmNlc1sxXSA9IGxvYy5lbnRyYW5jZXNbdXBFbnRyYW5jZV07XG4gIHNldEV4aXQodXBFbnRyYW5jZSwgMHg5ZCwgMik7XG4gIGxldCBkb3duRW50cmFuY2UgPSBhbGxbJ2QnXS5wb3AoKSE7XG4gIGlmIChyZWFsRGlyID09PSAndScgJiYgZG93bkVudHJhbmNlID09PSAweGUgJiYgdXBFbnRyYW5jZSA9PT0gMHhjKSB7XG4gICAgLy8gcHJldmVudCB0aGUgY2FzZSB3aGVyZSBib3RoIGJhY2sgZW50cmFuY2VzIGFyZSBpbiB0aGUgY2hlc3Qgcm9vbVxuICAgIFtkb3duRW50cmFuY2VdID0gYWxsWydkJ10uc3BsaWNlKDAsIDEsIGRvd25FbnRyYW5jZSk7XG4gIH0gZWxzZSBpZiAocmVhbERpciA9PT0gJ2QnICYmXG4gICAgICAgICAgICAgKChkb3duRW50cmFuY2UgPT09IDB4ZSAmJiByZWFsRW50cmFuY2UgPT09IDB4MTApIHx8XG4gICAgICAgICAgICAgIChkb3duRW50cmFuY2UgPT09IDB4MTAgJiYgcmVhbEVudHJhbmNlID09PSAweGUpKSkge1xuICAgIC8vIHByZXZlbnQgdGhlIGNhc2Ugd2hlcmUgYm90aCBkb3duLWJhY2sgYW5kIHJlYWwgZXhpdCBhcmUgaW4gY2hlc3Qgcm9vbVxuICAgIFtkb3duRW50cmFuY2VdID0gYWxsWydkJ10uc3BsaWNlKDAsIDEsIGRvd25FbnRyYW5jZSk7XG4gIH1cbiAgZW50cmFuY2VzWzBdID0gbG9jLmVudHJhbmNlc1tkb3duRW50cmFuY2VdO1xuICBzZXRFeGl0KGRvd25FbnRyYW5jZSwgMHg5ZCwgMSk7XG4gIC8vIE5vdyBkbyB0aGUgZnVsbCBzaHVmZmxlZCByZW1hcFxuICBkbyB7XG4gICAgY29uc3Qgc291cmNlcyA9IHsndSc6IFsuLi5hbGxbJ3UnXV0sICdkJzogWy4uLmFsbFsnZCddXX07XG4gICAgY29uc3QgZGVzdHMgPSB7J3UnOiBbLi4uYWxsWyd1J11dLCAnZCc6IFsuLi5hbGxbJ2QnXV19O1xuICAgIHJhbmRvbS5zaHVmZmxlKGRlc3RzWyd1J10pO1xuICAgIHJhbmRvbS5zaHVmZmxlKGRlc3RzWydkJ10pO1xuICAgIGNvbnN0IGludiA9IHsndSc6ICdkJywgJ2QnOiAndSd9IGFzIGNvbnN0O1xuICAgIGZvciAobGV0IGkgPSAyOyBpIDwgMTY7IGkrKykge1xuICAgICAgLy8gRm9yIGVhY2ggZW50cmFuY2UgaT0yLi4xNiwgcGljayBhIHJlbWFpbmluZyBzYW1lLWRpcmVjdGlvbiBlbnRyYW5jZVxuICAgICAgLy8gYW5kIGEgcmVtYWluaW5nIG9wcG9zaXRlLWRpcmVjdGlvbiBlbnRyYW5jZS5cbiAgICAgIGNvbnN0IHNvdXJjZSA9IHNvdXJjZXNbZGlyW2ldXS5wb3AoKTtcbiAgICAgIGNvbnN0IGRlc3QgPSBkZXN0c1tpbnZbZGlyW2ldXV0ucG9wKCk7XG4gICAgICBpZiAoc291cmNlID09IG51bGwgfHwgZGVzdCA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ2ltcG9zc2libGUnKTtcbiAgICAgIGVudHJhbmNlc1tpXSA9IGxvYy5lbnRyYW5jZXNbc291cmNlXTtcbiAgICAgIHNldEV4aXQoZGVzdCwgMHg5ZSwgaSk7XG4gICAgfVxuICAgIC8vIE1ha2Ugc3VyZSB3ZSBkaWRuJ3QgY3V0IG9mZiB0aGUgY2hlc3Qgcm9vbSBmcm9tIHRoZSByZXN0IG9mIHRoZSBtYXAuXG4gICAgY29uc3QgY0V4aXQgPSBsb2MuZXhpdHNbMiAqIDB4Y107XG4gICAgY29uc3QgZUV4aXQgPSBsb2MuZXhpdHNbMiAqIDB4ZV07XG4gICAgaWYgKHJlYWxEaXIgPT09ICd1JyAmJiBjRXhpdC5kZXN0ID09PSBlRXhpdC5kZXN0ICYmXG4gICAgICAgIGxvYy5lbnRyYW5jZXNbMHhlXSA9PT0gZW50cmFuY2VzW2NFeGl0LmVudHJhbmNlXSAmJlxuICAgICAgICBsb2MuZW50cmFuY2VzWzB4Y10gPT09IGVudHJhbmNlc1tlRXhpdC5lbnRyYW5jZV0pIHtcbiAgICAgIGNvbnRpbnVlOyAvLyB0cnkgYWdhaW5cbiAgICB9XG4gICAgYnJlYWs7XG4gIH0gd2hpbGUgKHRydWUpO1xuICBsb2MuZW50cmFuY2VzID0gZW50cmFuY2VzO1xuXG4gIGZ1bmN0aW9uIHNldEV4aXQoaTogbnVtYmVyLCBkZXN0OiBudW1iZXIsIGVudHJhbmNlOiBudW1iZXIpIHtcbiAgICBsb2MuZXhpdHNbMiAqIGldLmRlc3QgPSBsb2MuZXhpdHNbMiAqIGkgKyAxXS5kZXN0ID0gZGVzdDtcbiAgICBsb2MuZXhpdHNbMiAqIGldLmVudHJhbmNlID0gbG9jLmV4aXRzWzIgKiBpICsgMV0uZW50cmFuY2UgPSBlbnRyYW5jZTtcbiAgfVxufVxuIl19