const IM1 = 2147483563;
const IM2 = 2147483399;
const AM = 1 / IM1;
const IMM1 = IM1 - 1;
const IA1 = 40014;
const IA2 = 40692;
const IQ1 = 53668;
const IQ2 = 52774;
const IR1 = 12211;
const IR2 = 3791;
const NTAB = 32;
const NDIV = 1 + Math.floor(IMM1 / NTAB);
const EPS = 1.2e-7;
const RNMX = 1 - EPS;
export class Random {
    constructor(seed = Math.floor(Math.random() * 0x100000000)) {
        this.idum = 0;
        this.idum2 = 0;
        this.iy = 0;
        this.iv = [];
        this.z1 = null;
        this.seed(seed);
    }
    static newSeed() {
        return Math.floor(Math.random() * 0x100000000);
    }
    seed(seed) {
        this.idum = Math.max(1, Math.floor(seed));
        this.idum2 = this.idum;
        this.iy = 0;
        this.iv = new Array(NTAB).fill(0);
        for (let j = NTAB + 7; j >= 0; j--) {
            const k = Math.floor(this.idum / IQ1);
            this.idum = IA1 * (this.idum - k * IQ1) - k * IR1;
            if (this.idum < 0)
                this.idum += IM1;
            if (j < NTAB)
                this.iv[j] = this.idum;
        }
        this.iy = this.iv[0];
    }
    next() {
        let k = Math.floor(this.idum / IQ1);
        this.idum = IA1 * (this.idum - k * IQ1) - k * IR1;
        if (this.idum < 0)
            this.idum += IM1;
        k = Math.floor(this.idum2 / IQ2);
        this.idum2 = IA2 * (this.idum2 - k * IQ2) - k * IR2;
        if (this.idum2 < 0)
            this.idum2 += IM2;
        const j = Math.floor(this.iy / NDIV);
        this.iy = this.iv[j] - this.idum2;
        this.iv[j] = this.idum;
        if (this.iy < 1)
            this.iy += IMM1;
        return Math.min(AM * this.iy, RNMX);
    }
    nextInt(n) {
        return Math.floor(this.next() * n);
    }
    nextNormal(mean = 0, stdev = 1, min = -Infinity, max = Infinity) {
        while (true) {
            let z = this.z1;
            if (z == null) {
                const r = Math.sqrt(-2 * Math.log(this.next()));
                const theta = TWOPI * this.next();
                z = r * Math.cos(theta);
                this.z1 = r * Math.sin(theta);
            }
            else {
                this.z1 = null;
            }
            z = mean + z * stdev;
            if (z >= min && z <= max)
                return z;
        }
    }
    shuffle(array) {
        for (let i = array.length; i;) {
            const j = this.nextInt(i--);
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    *ishuffle(iterable) {
        const arr = [];
        if (!Array.isArray(iterable)) {
            if (hasSize(iterable)) {
                const iter = iterable[Symbol.iterator]();
                for (let i = 0; i < iterable.size; i++) {
                    const j = i + this.nextInt(iterable.size - i);
                    while (arr.length <= j) {
                        arr.push(iter.next().value);
                    }
                    yield arr[j];
                    arr[j] = arr[i];
                }
                return;
            }
            else {
                iterable = [...iterable];
            }
        }
        if (!Array.isArray(iterable))
            throw new Error('impossible');
        for (let i = 0; i < iterable.length; i++) {
            const j = i + this.nextInt(iterable.length - i);
            yield j in arr ? arr[j] : iterable[j];
            arr[j] = i in arr ? arr[i] : iterable[i];
        }
    }
    *ishuffleMetropolis(arr, temp) {
        const a = [...arr];
        for (let i = a.length - 1; i >= 0; i--) {
            for (let j = 1; j < i; j <<= 1) {
                const j1 = j >>> 1;
                const k = (j1 ? this.nextInt(j1) : 0) + j1 + 1;
                const delta = a[i][0] - a[i - k][0];
                const swap = delta < 0 ? 2 * this.next() > Math.exp(delta / temp) :
                    2 * this.next() < Math.exp(-delta / temp);
                if (swap) {
                    const tmp = a[i];
                    a[i] = a[i - k];
                    a[i - k] = tmp;
                }
            }
            yield a[i][1];
        }
    }
    pick(arr) {
        if (!arr.length)
            throw new Error('empty array');
        return arr[this.nextInt(arr.length)];
    }
    pickWeighted(arr) {
        if (!arr.length)
            throw new Error('empty array');
        let total = 0;
        for (const [weight] of arr)
            total += weight;
        let choice = this.next() * total;
        for (const [weight, elem] of arr) {
            if (choice < weight)
                return elem;
            choice -= weight;
        }
        throw new Error('bad weights');
    }
    pickAndRemove(...arrs) {
        let count = 0;
        for (const arr of arrs) {
            count += arr.length;
        }
        if (!count)
            throw new Error('empty arrays');
        let i = this.nextInt(count);
        for (const arr of arrs) {
            if (i < arr.length)
                return arr.splice(i, 1)[0];
            i -= arr.length;
        }
        throw new Error('impossible');
    }
    bitGenerator() {
        let bits = 0;
        let next = 0;
        return () => {
            if (!bits) {
                bits = 32;
                next = this.nextInt(0x100000000);
            }
            bits--;
            const result = !(next & 1);
            next >>>= 1;
            return result;
        };
    }
}
function hasSize(iter) {
    return 'size' in iter;
}
const TWOPI = 2 * Math.PI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFuZG9tLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2pzL3JhbmRvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUM7QUFDdkIsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDO0FBQ3ZCLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDbkIsTUFBTSxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztBQUNyQixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUM7QUFDbEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDO0FBQ2xCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQztBQUNsQixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUM7QUFDbEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDO0FBQ2xCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQztBQUNqQixNQUFNLElBQUksR0FBRyxFQUFFLENBQUM7QUFDaEIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQztBQUNuQixNQUFNLElBQUksR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBRXJCLE1BQU0sT0FBTyxNQUFNO0lBYWpCLFlBQVksT0FBZSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxXQUFXLENBQUM7UUFOMUQsU0FBSSxHQUFXLENBQUMsQ0FBQztRQUNqQixVQUFLLEdBQVcsQ0FBQyxDQUFDO1FBQ2xCLE9BQUUsR0FBVyxDQUFDLENBQUM7UUFDZixPQUFFLEdBQWEsRUFBRSxDQUFDO1FBQ2xCLE9BQUUsR0FBa0IsSUFBSSxDQUFDO1FBRy9CLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQVpELE1BQU0sQ0FBQyxPQUFPO1FBQ1osT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxXQUFXLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBWUQsSUFBSSxDQUFDLElBQVk7UUFDZixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDWixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQyxLQUFLLElBQUksQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNsQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDdEMsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO1lBQ2xELElBQUksSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDO2dCQUFFLElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxHQUFHLElBQUk7Z0JBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ3RDO1FBQ0QsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxJQUFJO1FBQ0YsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUNsRCxJQUFJLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQztZQUFFLElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDO1FBQ3BDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ3BELElBQUksSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDO1lBQUUsSUFBSSxDQUFDLEtBQUssSUFBSSxHQUFHLENBQUM7UUFDdEMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN2QixJQUFJLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQztZQUFFLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQsT0FBTyxDQUFDLENBQVM7UUFDZixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCxVQUFVLENBQUMsT0FBZSxDQUFDLEVBQ2hCLFFBQWdCLENBQUMsRUFDakIsTUFBYyxDQUFDLFFBQVEsRUFDdkIsTUFBYyxRQUFRO1FBQy9CLE9BQU8sSUFBSSxFQUFFO1lBQ1gsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUU7Z0JBQ2IsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hELE1BQU0sS0FBSyxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2xDLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDeEIsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUMvQjtpQkFBTTtnQkFDTCxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQzthQUNoQjtZQUNELENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUc7Z0JBQUUsT0FBTyxDQUFDLENBQUM7U0FDcEM7SUFDSCxDQUFDO0lBRUQsT0FBTyxDQUFzQyxLQUFRO1FBQ25ELEtBQUssSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUc7WUFDN0IsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzVCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzdDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBR0QsQ0FBRSxRQUFRLENBQUksUUFBcUI7UUFDakMsTUFBTSxHQUFHLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzVCLElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNyQixNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7Z0JBQ3pDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUN0QyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUM5QyxPQUFPLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO3dCQUN0QixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztxQkFDN0I7b0JBQ0QsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2IsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDakI7Z0JBQ0QsT0FBTzthQUNSO2lCQUFNO2dCQUNMLFFBQVEsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUM7YUFDMUI7U0FDRjtRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDNUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNoRCxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMxQztJQUNILENBQUM7SUFVRCxDQUFFLGtCQUFrQixDQUFJLEdBQXVCLEVBQUUsSUFBWTtRQUUzRCxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBRXRDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDOUIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbkIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQy9DLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUdwQyxNQUFNLElBQUksR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQzFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQztnQkFDbkUsSUFBSSxJQUFJLEVBQUU7b0JBQ1IsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqQixDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDaEIsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7aUJBQ2hCO2FBQ0Y7WUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNmO0lBQ0gsQ0FBQztJQTRDRCxJQUFJLENBQUksR0FBaUI7UUFDdkIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNoRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxZQUFZLENBQUksR0FBd0M7UUFDdEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNoRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxLQUFLLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHO1lBQUUsS0FBSyxJQUFJLE1BQU0sQ0FBQztRQUM1QyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQ2pDLEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUU7WUFDaEMsSUFBSSxNQUFNLEdBQUcsTUFBTTtnQkFBRSxPQUFPLElBQUksQ0FBQztZQUNqQyxNQUFNLElBQUksTUFBTSxDQUFDO1NBQ2xCO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQsYUFBYSxDQUFJLEdBQUcsSUFBVztRQUM3QixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksRUFBRTtZQUN0QixLQUFLLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQztTQUNyQjtRQUNELElBQUksQ0FBQyxLQUFLO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVCLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNO2dCQUFFLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0MsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUM7U0FDakI7UUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxZQUFZO1FBQ1YsSUFBSSxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsSUFBSSxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsT0FBTyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNULElBQUksR0FBRyxFQUFFLENBQUM7Z0JBQ1YsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7YUFDbEM7WUFDRCxJQUFJLEVBQUUsQ0FBQztZQUNQLE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxNQUFNLENBQUMsQ0FBQTtZQUNYLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQUtELFNBQVMsT0FBTyxDQUFJLElBQWlCO0lBQ25DLE9BQU8sTUFBTSxJQUFJLElBQUksQ0FBQztBQUN4QixDQUFDO0FBRUQsTUFBTSxLQUFLLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBJTTEgPSAyMTQ3NDgzNTYzO1xuY29uc3QgSU0yID0gMjE0NzQ4MzM5OTtcbmNvbnN0IEFNID0gMSAvIElNMTtcbmNvbnN0IElNTTEgPSBJTTEgLSAxO1xuY29uc3QgSUExID0gNDAwMTQ7XG5jb25zdCBJQTIgPSA0MDY5MjtcbmNvbnN0IElRMSA9IDUzNjY4O1xuY29uc3QgSVEyID0gNTI3NzQ7XG5jb25zdCBJUjEgPSAxMjIxMTtcbmNvbnN0IElSMiA9IDM3OTE7XG5jb25zdCBOVEFCID0gMzI7XG5jb25zdCBORElWID0gMSArIE1hdGguZmxvb3IoSU1NMSAvIE5UQUIpO1xuY29uc3QgRVBTID0gMS4yZS03O1xuY29uc3QgUk5NWCA9IDEgLSBFUFM7XG5cbmV4cG9ydCBjbGFzcyBSYW5kb20ge1xuXG4gIC8vIFJldHVybnMgYSBuZXcgc2VlZCBhdCByYW5kb20sIHVzaW5nIHRoZSBzeXN0ZW0gUFJORy5cbiAgc3RhdGljIG5ld1NlZWQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMHgxMDAwMDAwMDApO1xuICB9XG5cbiAgcHJpdmF0ZSBpZHVtOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIGlkdW0yOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIGl5OiBudW1iZXIgPSAwO1xuICBwcml2YXRlIGl2OiBudW1iZXJbXSA9IFtdO1xuICBwcml2YXRlIHoxOiBudW1iZXIgfCBudWxsID0gbnVsbDsgLy8gZXh0cmEgbm9ybWFsIGRldmlhdGVcblxuICBjb25zdHJ1Y3RvcihzZWVkOiBudW1iZXIgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMCkpIHtcbiAgICB0aGlzLnNlZWQoc2VlZCk7XG4gIH1cblxuICBzZWVkKHNlZWQ6IG51bWJlcikge1xuICAgIHRoaXMuaWR1bSA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3Ioc2VlZCkpO1xuICAgIHRoaXMuaWR1bTIgPSB0aGlzLmlkdW07XG4gICAgdGhpcy5peSA9IDA7XG4gICAgdGhpcy5pdiA9IG5ldyBBcnJheShOVEFCKS5maWxsKDApO1xuICAgIGZvciAobGV0IGogPSBOVEFCICsgNzsgaiA+PSAwOyBqLS0pIHtcbiAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKHRoaXMuaWR1bSAvIElRMSk7XG4gICAgICB0aGlzLmlkdW0gPSBJQTEgKiAodGhpcy5pZHVtIC0gayAqIElRMSkgLSBrICogSVIxO1xuICAgICAgaWYgKHRoaXMuaWR1bSA8IDApIHRoaXMuaWR1bSArPSBJTTE7XG4gICAgICBpZiAoaiA8IE5UQUIpIHRoaXMuaXZbal0gPSB0aGlzLmlkdW07XG4gICAgfVxuICAgIHRoaXMuaXkgPSB0aGlzLml2WzBdO1xuICB9XG5cbiAgbmV4dCgpOiBudW1iZXIge1xuICAgIGxldCBrID0gTWF0aC5mbG9vcih0aGlzLmlkdW0gLyBJUTEpO1xuICAgIHRoaXMuaWR1bSA9IElBMSAqICh0aGlzLmlkdW0gLSBrICogSVExKSAtIGsgKiBJUjE7XG4gICAgaWYgKHRoaXMuaWR1bSA8IDApIHRoaXMuaWR1bSArPSBJTTE7XG4gICAgayA9IE1hdGguZmxvb3IodGhpcy5pZHVtMiAvIElRMik7XG4gICAgdGhpcy5pZHVtMiA9IElBMiAqICh0aGlzLmlkdW0yIC0gayAqIElRMikgLSBrICogSVIyO1xuICAgIGlmICh0aGlzLmlkdW0yIDwgMCkgdGhpcy5pZHVtMiArPSBJTTI7XG4gICAgY29uc3QgaiA9IE1hdGguZmxvb3IodGhpcy5peSAvIE5ESVYpO1xuICAgIHRoaXMuaXkgPSB0aGlzLml2W2pdIC0gdGhpcy5pZHVtMjtcbiAgICB0aGlzLml2W2pdID0gdGhpcy5pZHVtO1xuICAgIGlmICh0aGlzLml5IDwgMSkgdGhpcy5peSArPSBJTU0xO1xuICAgIHJldHVybiBNYXRoLm1pbihBTSAqIHRoaXMuaXksIFJOTVgpO1xuICB9XG5cbiAgbmV4dEludChuOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMubmV4dCgpICogbik7XG4gIH1cblxuICBuZXh0Tm9ybWFsKG1lYW46IG51bWJlciA9IDAsXG4gICAgICAgICAgICAgc3RkZXY6IG51bWJlciA9IDEsXG4gICAgICAgICAgICAgbWluOiBudW1iZXIgPSAtSW5maW5pdHksXG4gICAgICAgICAgICAgbWF4OiBudW1iZXIgPSBJbmZpbml0eSkge1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICBsZXQgeiA9IHRoaXMuejE7XG4gICAgICBpZiAoeiA9PSBudWxsKSB7XG4gICAgICAgIGNvbnN0IHIgPSBNYXRoLnNxcnQoLTIgKiBNYXRoLmxvZyh0aGlzLm5leHQoKSkpO1xuICAgICAgICBjb25zdCB0aGV0YSA9IFRXT1BJICogdGhpcy5uZXh0KCk7XG4gICAgICAgIHogPSByICogTWF0aC5jb3ModGhldGEpO1xuICAgICAgICB0aGlzLnoxID0gciAqIE1hdGguc2luKHRoZXRhKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuejEgPSBudWxsO1xuICAgICAgfVxuICAgICAgeiA9IG1lYW4gKyB6ICogc3RkZXY7XG4gICAgICBpZiAoeiA+PSBtaW4gJiYgeiA8PSBtYXgpIHJldHVybiB6O1xuICAgIH1cbiAgfVxuXG4gIHNodWZmbGU8VCBleHRlbmRzIE11dGFibGVBcnJheUxpa2U8dW5rbm93bj4+KGFycmF5OiBUKTogVCB7XG4gICAgZm9yIChsZXQgaSA9IGFycmF5Lmxlbmd0aDsgaTspIHtcbiAgICAgIGNvbnN0IGogPSB0aGlzLm5leHRJbnQoaS0tKTtcbiAgICAgIFthcnJheVtpXSwgYXJyYXlbal1dID0gW2FycmF5W2pdLCBhcnJheVtpXV07XG4gICAgfVxuICAgIHJldHVybiBhcnJheTtcbiAgfVxuXG4gIC8qKiBEb2VzIG5vdCBkZXN0cm95IHRoZSBpbnB1dCBpdGVyYWJsZS4gKi9cbiAgKiBpc2h1ZmZsZTxUPihpdGVyYWJsZTogSXRlcmFibGU8VD4pOiBJdGVyYWJsZUl0ZXJhdG9yPFQ+IHtcbiAgICBjb25zdCBhcnI6IFRbXSA9IFtdO1xuICAgIGlmICghQXJyYXkuaXNBcnJheShpdGVyYWJsZSkpIHtcbiAgICAgIGlmIChoYXNTaXplKGl0ZXJhYmxlKSkge1xuICAgICAgICBjb25zdCBpdGVyID0gaXRlcmFibGVbU3ltYm9sLml0ZXJhdG9yXSgpO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZXJhYmxlLnNpemU7IGkrKykge1xuICAgICAgICAgIGNvbnN0IGogPSBpICsgdGhpcy5uZXh0SW50KGl0ZXJhYmxlLnNpemUgLSBpKTtcbiAgICAgICAgICB3aGlsZSAoYXJyLmxlbmd0aCA8PSBqKSB7XG4gICAgICAgICAgICBhcnIucHVzaChpdGVyLm5leHQoKS52YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHlpZWxkIGFycltqXTtcbiAgICAgICAgICBhcnJbal0gPSBhcnJbaV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuOyAvLyBUT0RPIC0gd2h5IHdhcyB0aGlzIG5vdCByZXF1aXJlZD9cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGl0ZXJhYmxlID0gWy4uLml0ZXJhYmxlXTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGl0ZXJhYmxlKSkgdGhyb3cgbmV3IEVycm9yKCdpbXBvc3NpYmxlJyk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVyYWJsZS5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaiA9IGkgKyB0aGlzLm5leHRJbnQoaXRlcmFibGUubGVuZ3RoIC0gaSk7XG4gICAgICB5aWVsZCBqIGluIGFyciA/IGFycltqXSA6IGl0ZXJhYmxlW2pdO1xuICAgICAgYXJyW2pdID0gaSBpbiBhcnIgPyBhcnJbaV0gOiBpdGVyYWJsZVtpXTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQXR0ZW1wdHMgdG8gZG8gYSBtZXRyb3BvbGlzLWlzaCB3ZWlnaHRlZCBzaHVmZmxlLiAgVGhpcyBhZGRzIG9ubHkgYVxuICAgKiBsb2ctdGltZSBvdmVyaGVhZCB0byB0aGUgc2h1ZmZsZS4gIFRoZXJlIGFyZSBhIGZldyBjaG9pY2VzIHdlIGNvdWxkXG4gICAqIGNvbnNpZGVyOiAoMSkgcHJlLXNvcnQgb3Igbm90LCAoMikgdW5jb25kaXRpb25hbGx5IHN3YXAgdG8gaW1wcm92ZVxuICAgKiB3ZWlnaHQgb3Igbm90LiAgV2Ugb3B0IHRvIG5vdCBzb3J0IGFuZCB0byBtYXliZSBub3Qgc3dhcCAodGhvdWdoIHRoaXNcbiAgICogcG90ZW50aWFsbHkgc2NhbGVzIHRoZSB0ZW1wZXJhdHVyZSBieSBhIGZhY3RvciBvZiAyIG9uZSBkaXJlY3Rpb24gb3JcbiAgICogdGhlIG90aGVyKS5cbiAgICovXG4gICogaXNodWZmbGVNZXRyb3BvbGlzPFQ+KGFycjogQXJyYXk8W251bWJlciwgVF0+LCB0ZW1wOiBudW1iZXIpOlxuICBJdGVyYWJsZUl0ZXJhdG9yPFQ+IHtcbiAgICBjb25zdCBhID0gWy4uLmFycl07IC8vIC5zb3J0KChhLCBiKSA9PiBhWzBdIC0gYlswXSk7XG4gICAgZm9yIChsZXQgaSA9IGEubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIC8vIHRyeSB0byBzd2FwIG91dCBsb2cyKGkpIGRpZmZlcmVudCBpdGVtcywgdXNpbmcgYSBzaG9vdGluZyBtZXRob2RcbiAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgaTsgaiA8PD0gMSkge1xuICAgICAgICBjb25zdCBqMSA9IGogPj4+IDE7XG4gICAgICAgIGNvbnN0IGsgPSAoajEgPyB0aGlzLm5leHRJbnQoajEpIDogMCkgKyBqMSArIDE7XG4gICAgICAgIGNvbnN0IGRlbHRhID0gYVtpXVswXSAtIGFbaSAtIGtdWzBdO1xuICAgICAgICAvLyBJZiBkZWx0YSA8IDAgdGhlbiBkZWZpbml0ZWx5IHN3YXAsIG90aGVyd2lzZSB1c2UgYSBib2x0em1hbiBmYWN0b3JcbiAgICAgICAgLy9jb25zdCBzd2FwID0gZGVsdGEgPCAwIHx8IHRoaXMubmV4dCgpIDwgTWF0aC5leHAoLWRlbHRhIC8gdGVtcCk7XG4gICAgICAgIGNvbnN0IHN3YXAgPSBkZWx0YSA8IDAgPyAyICogdGhpcy5uZXh0KCkgPiBNYXRoLmV4cChkZWx0YSAvIHRlbXApIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgKiB0aGlzLm5leHQoKSA8IE1hdGguZXhwKC1kZWx0YSAvIHRlbXApO1xuICAgICAgICBpZiAoc3dhcCkge1xuICAgICAgICAgIGNvbnN0IHRtcCA9IGFbaV07XG4gICAgICAgICAgYVtpXSA9IGFbaSAtIGtdO1xuICAgICAgICAgIGFbaSAtIGtdID0gdG1wO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB5aWVsZCBhW2ldWzFdO1xuICAgIH0gICAgXG4gIH1cblxuICAvLyAvKipcbiAgLy8gICogU2h1ZmZsZXMgYSB3ZWlnaHRlZCBsaXN0IHN1Y2ggdGhhdCB0aGUgaGlnaGVyIHdlaWdodHMgX3RlbmRfIHRvIGNvbWVcbiAgLy8gICogZWFybGllciwgYnV0IHVzZXMgYSB0ZW1wZXJhdHVyZS1wYXJhbWV0cml6ZWQgbW9udGUgY2FybG8gYWxnb3JpdGhtIHRvXG4gIC8vICAqIGluamVjdCBzb21lIHJhbmRvbW5lc3MuICBXaGVuIHRlbXBlcmF0dXJlIGlzIHplcm8gdGhlbiB0aGlzIGlzIGp1c3QgYVxuICAvLyAgKiBkZXRlcm1pbmlzdGljIHNvcnQuICBXaGVuIHRlbXBlcmF0dXJlIGlzIGluZmluaXRlLCB0aGVuIGl0J3MgYVxuICAvLyAgKiBjb21wbGV0ZWx5IHJhbmRvbSBzaHVmZmxlLiAgQXQgaW4tYmV0d2VlbiB0ZW1wZXJhdHVyZXMgKG9uIHRoZSBvcmRlclxuICAvLyAgKiBvZiBtYWduaXR1ZGUgb2YgdGhlIHdlaWdodHMpLCB0aGVyZSBpcyBhIHRyYW5zaXRpb24uXG4gIC8vICAqL1xuICAvLyBtZXRyb3BvbGlzU2h1ZmZsZTxUIGV4dGVuZHMgQXJyYXk8W251bWJlciwgVF0+PihhcnI6IFQsIHRlbXA6IG51bWJlcik6IFQge1xuICAvLyAgIC8vIFN0YXJ0IGF0IFQ9MCBlcXVpbGlicml1bSwgdGhlbiBoZWF0IGl0IHVwLlxuICAvLyAgIGFyci5zb3J0KChhLCBiKSA9PiBiWzBdIC0gYVswXSk7XG4gIC8vICAgaWYgKHRlbXAgPD0gMCkgcmV0dXJuIGFycjtcblxuICAvLyAgIC8vIFRPRE8gLSB0aGlzIHByb2JhYmx5IGRvZXNuJ3Qgd29yayBob3cgd2UnZCBsaWtlIC0gcmFuZG9tbHkgc3dhcHBpbmdcbiAgLy8gICAvLyBub24tbmVpZ2hib3JzIHNlZW1zIHByb2JsZW1hdGljLCBhbmQgSSdtIHN0YXJ0aW5nIHRvIHF1ZXN0aW9uIHRoZVxuICAvLyAgIC8vIHNjYWxlIC0gaWYgd2UgaGF2ZSB3ZWlnaHRzIGZyb20gMCB0byAxNSB0aGVuIFQ9NSBtaWdodCBtZWFuIHRoYXRcbiAgLy8gICAvLyB3ZSdsbCBzZWUgMTAuLjE1IGF0IHRoZSBmcm9udCBidXQgdmVyeSBub3QgbGlrZWx5IG90aGVycy5cbiAgLy8gICAvLyAgIC0gbWF5YmUgaXQncyB0aGUgc2FtZSB0aGluZyB3aXRoIGEgdW5pdGxlc3Mgc2NhbGluZz9cbiAgLy8gICAvLyBXZSBzaG91bGQgYWxzbyB0cnkgTiBwYXNzZXMgb2Ygbm9uLXJhbmRvbSBuZWlnaGJvciBzaHVmZmxlcz9cbiAgLy8gICAvLyAgIC0gaWYgdGhlcmUncyBhIGJpZyBkZWx0YSBzb21ld2hlcmUgaW4gdGhlIG1pZGRsZSwgaXQgd291bGQgYmUgaGFyZFxuICAvLyAgIC8vICAgICB0byBicmVhayB0aHJvdWdoIHRoYXQ/XG4gIC8vICAgLy8gICAtLS0+IHdheSB0b28gc2xvd1xuXG4gIC8vICAgY29uc3QgbCA9IGFyci5sZW5ndGg7XG4gIC8vICAgZm9yIChsZXQgaSA9IGwgKiBsOyBpID4gMDsgaS0tKSB7XG4gIC8vICAgICBjb25zdCBqMiA9IHRoaXMubmV4dEludChsIC0gMSkgKyAxO1xuICAvLyAgICAgY29uc3QgajEgPSB0aGlzLm5leHRJbnQoajIpO1xuICAvLyAgICAgY29uc3QgZGVsdGEgPSBhcnJbajFdWzBdIC0gYXJyW2oyXVswXTtcbiAgLy8gICAgIC8vIEdvYWw6IHdlaWdodCAxIHNob3VsZCBiZSBncmVhdGVyIHRoYW4gd2VpZ2h0IDI6XG4gIC8vICAgICAvLyAgIHNvIGRlbHRhIDwgMCBtZWFucyB3ZSBzaG91bGQgZGVmaW5pdGVseSBzd2FwXG4gIC8vICAgICAvLyAgIGJ1dCBkZWx0YSA+IDAgbWVhbnMgd2UgbWlnaHQgc3dhcCBhdCBoaWdoZXIgdGVtcGVyYXR1cmVzXG4gIC8vICAgICAvLyAgICAgICAgICAgICAgICAgKHByb2JhYmlsaXR5IFA9ZXhwKC1kZWx0YS90ZW1wKSlcbiAgLy8gICAgIGNvbnN0IHN3YXAgPSBkZWx0YSA8IDAgfHwgdGhpcy5uZXh0KCkgPCBNYXRoLmV4cCgtZGVsdGEgLyB0ZW1wKTtcbiAgLy8gICAgIGlmIChzd2FwKSB7XG4gIC8vICAgICAgIGNvbnN0IHRtcCA9IGFycltqMV07XG4gIC8vICAgICAgIGFycltqMV0gPSBhcnJbajJdO1xuICAvLyAgICAgICBhcnJbajJdID0gdG1wO1xuICAvLyAgICAgfVxuICAvLyAgIH1cbiAgLy8gICByZXR1cm4gYXJyO1xuICAvLyB9XG5cbiAgcGljazxUPihhcnI6IHJlYWRvbmx5IFRbXSk6IFQge1xuICAgIGlmICghYXJyLmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdlbXB0eSBhcnJheScpO1xuICAgIHJldHVybiBhcnJbdGhpcy5uZXh0SW50KGFyci5sZW5ndGgpXTtcbiAgfVxuXG4gIHBpY2tXZWlnaHRlZDxUPihhcnI6IFJlYWRvbmx5QXJyYXk8cmVhZG9ubHkgW251bWJlciwgVF0+KTogVCB7XG4gICAgaWYgKCFhcnIubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ2VtcHR5IGFycmF5Jyk7XG4gICAgbGV0IHRvdGFsID0gMDtcbiAgICBmb3IgKGNvbnN0IFt3ZWlnaHRdIG9mIGFycikgdG90YWwgKz0gd2VpZ2h0O1xuICAgIGxldCBjaG9pY2UgPSB0aGlzLm5leHQoKSAqIHRvdGFsO1xuICAgIGZvciAoY29uc3QgW3dlaWdodCwgZWxlbV0gb2YgYXJyKSB7XG4gICAgICBpZiAoY2hvaWNlIDwgd2VpZ2h0KSByZXR1cm4gZWxlbTtcbiAgICAgIGNob2ljZSAtPSB3ZWlnaHQ7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcignYmFkIHdlaWdodHMnKTtcbiAgfVxuXG4gIHBpY2tBbmRSZW1vdmU8VD4oLi4uYXJyczogVFtdW10pOiBUIHtcbiAgICBsZXQgY291bnQgPSAwO1xuICAgIGZvciAoY29uc3QgYXJyIG9mIGFycnMpIHtcbiAgICAgIGNvdW50ICs9IGFyci5sZW5ndGg7XG4gICAgfVxuICAgIGlmICghY291bnQpIHRocm93IG5ldyBFcnJvcignZW1wdHkgYXJyYXlzJyk7XG4gICAgbGV0IGkgPSB0aGlzLm5leHRJbnQoY291bnQpO1xuICAgIGZvciAoY29uc3QgYXJyIG9mIGFycnMpIHtcbiAgICAgIGlmIChpIDwgYXJyLmxlbmd0aCkgcmV0dXJuIGFyci5zcGxpY2UoaSwgMSlbMF07XG4gICAgICBpIC09IGFyci5sZW5ndGg7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcignaW1wb3NzaWJsZScpO1xuICB9XG5cbiAgYml0R2VuZXJhdG9yKCk6ICgpID0+IGJvb2xlYW4ge1xuICAgIGxldCBiaXRzID0gMDtcbiAgICBsZXQgbmV4dCA9IDA7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmICghYml0cykge1xuICAgICAgICBiaXRzID0gMzI7XG4gICAgICAgIG5leHQgPSB0aGlzLm5leHRJbnQoMHgxMDAwMDAwMDApO1xuICAgICAgfVxuICAgICAgYml0cy0tO1xuICAgICAgY29uc3QgcmVzdWx0ID0gIShuZXh0ICYgMSk7XG4gICAgICBuZXh0ID4+Pj0gMVxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9O1xuICB9XG59XG5cbmludGVyZmFjZSBIYXNTaXplPFQ+IGV4dGVuZHMgSXRlcmFibGU8VD4ge1xuICByZWFkb25seSBzaXplOiBudW1iZXI7XG59XG5mdW5jdGlvbiBoYXNTaXplPFQ+KGl0ZXI6IEl0ZXJhYmxlPFQ+KTogaXRlciBpcyBIYXNTaXplPFQ+IHtcbiAgcmV0dXJuICdzaXplJyBpbiBpdGVyO1xufVxuXG5jb25zdCBUV09QSSA9IDIgKiBNYXRoLlBJO1xuXG5pbnRlcmZhY2UgTXV0YWJsZUFycmF5TGlrZTxUPiB7XG4gIGxlbmd0aDogbnVtYmVyO1xuICBbaW5kZXg6IG51bWJlcl06IFQ7XG59XG5cbi8vIC8vIFByb3ZpZGUgYSBzdGF0aWMgc2luZ2xldG9uIGluc3RhbmNlLlxuLy8gbGV0IHJhbmRvbSA9ICgoKSA9PiB7XG4vLyAgIGxldCBzZWVkID0gMDtcbi8vICAgaWYgKHdpbmRvdyAmJiB3aW5kb3cubG9jYXRpb24gJiYgd2luZG93LmxvY2F0aW9uLmhhc2gpIHtcbi8vICAgICBmb3IgKGNvbnN0IGNvbXBvbmVudCBvZiB3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoMSkuc3BsaXQoJyYnKSkge1xuLy8gICAgICAgY29uc3Qgc3BsaXQgPSBjb21wb25lbnQuc3BsaXQoJz0nKTtcbi8vICAgICAgIGlmIChzcGxpdFswXSA9PT0gJ3NlZWQnKSB7XG4vLyAgICAgICAgIHNlZWQgPSBOdW1iZXIoc3BsaXRbMV0pIHx8IDA7XG4vLyAgICAgICB9XG4vLyAgICAgfVxuLy8gICB9XG4vLyAgIGlmICghc2VlZCkge1xuLy8gICAgIHNlZWQgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMCk7XG4vLyAgIH1cbi8vICAgcmV0dXJuIG5ldyBSYW5kb20oc2VlZCk7XG4vLyB9KSgpO1xuLy8gUmFuZG9tLm5leHRJbnQgPSAobikgPT4gcmFuZG9tLm5leHRJbnQobik7XG4vLyBSYW5kb20ubmV4dCA9ICgpID0+IHJhbmRvbS5uZXh0KCk7XG4vLyBSYW5kb20uc2VlZCA9IChzKSA9PiByYW5kb20uc2VlZChzKTtcbiJdfQ==