(function(){'use strict';var l=l||{};l.scope={};l.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};l.arrayIterator=function(a){return{next:l.arrayIteratorImpl(a)}};l.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):l.arrayIterator(a)};l.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};l.global=l.getGlobal(this);
l.ASSUME_ES5=!1;l.ASSUME_NO_NATIVE_MAP=!1;l.ASSUME_NO_NATIVE_SET=!1;l.SIMPLE_FROUND_POLYFILL=!1;l.defineProperty=l.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};l.polyfill=function(a,b){if(b){var c=l.global;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&l.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
l.FORCE_POLYFILL_PROMISE=!1;l.SYMBOL_PREFIX="jscomp_symbol_";l.initSymbol=function(){l.initSymbol=function(){};l.global.Symbol||(l.global.Symbol=l.Symbol)};l.Symbol=function(){var a=0;return function(b){return l.SYMBOL_PREFIX+(b||"")+a++}}();
l.initSymbolIterator=function(){l.initSymbol();var a=l.global.Symbol.iterator;a||(a=l.global.Symbol.iterator=l.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&l.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return l.iteratorPrototype(l.arrayIteratorImpl(this))}});l.initSymbolIterator=function(){}};
l.initSymbolAsyncIterator=function(){l.initSymbol();var a=l.global.Symbol.asyncIterator;a||(a=l.global.Symbol.asyncIterator=l.global.Symbol("asyncIterator"));l.initSymbolAsyncIterator=function(){}};l.iteratorPrototype=function(a){l.initSymbolIterator();a={next:a};a[l.global.Symbol.iterator]=function(){return this};return a};l.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};
l.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:l.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;l.generator={};l.generator.ensureIteratorResultIsObject_=function(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");};
l.generator.Context=function(){this.isRunning_=!1;this.yieldAllIterator_=null;this.yieldResult=void 0;this.nextAddress=1;this.finallyAddress_=this.catchAddress_=0;this.finallyContexts_=this.abruptCompletion_=null};l.generator.Context.prototype.start_=function(){if(this.isRunning_)throw new TypeError("Generator is already running");this.isRunning_=!0};l.generator.Context.prototype.stop_=function(){this.isRunning_=!1};
l.generator.Context.prototype.jumpToErrorHandler_=function(){this.nextAddress=this.catchAddress_||this.finallyAddress_};l.generator.Context.prototype.next_=function(a){this.yieldResult=a};l.generator.Context.prototype.throw_=function(a){this.abruptCompletion_={exception:a,isException:!0};this.jumpToErrorHandler_()};l.generator.Context.prototype.return=function(a){this.abruptCompletion_={return:a};this.nextAddress=this.finallyAddress_};
l.generator.Context.prototype.jumpThroughFinallyBlocks=function(a){this.abruptCompletion_={jumpTo:a};this.nextAddress=this.finallyAddress_};l.generator.Context.prototype.yield=function(a,b){this.nextAddress=b;return{value:a}};l.generator.Context.prototype.yieldAll=function(a,b){a=l.makeIterator(a);var c=a.next();l.generator.ensureIteratorResultIsObject_(c);if(c.done)this.yieldResult=c.value,this.nextAddress=b;else return this.yieldAllIterator_=a,this.yield(c.value,b)};
l.generator.Context.prototype.jumpTo=function(a){this.nextAddress=a};l.generator.Context.prototype.jumpToEnd=function(){this.nextAddress=0};l.generator.Context.prototype.setCatchFinallyBlocks=function(a,b){this.catchAddress_=a;void 0!=b&&(this.finallyAddress_=b)};l.generator.Context.prototype.setFinallyBlock=function(a){this.catchAddress_=0;this.finallyAddress_=a||0};l.generator.Context.prototype.leaveTryBlock=function(a,b){this.nextAddress=a;this.catchAddress_=b||0};
l.generator.Context.prototype.enterCatchBlock=function(a){this.catchAddress_=a||0;a=this.abruptCompletion_.exception;this.abruptCompletion_=null;return a};l.generator.Context.prototype.enterFinallyBlock=function(a,b,c){c?this.finallyContexts_[c]=this.abruptCompletion_:this.finallyContexts_=[this.abruptCompletion_];this.catchAddress_=a||0;this.finallyAddress_=b||0};
l.generator.Context.prototype.leaveFinallyBlock=function(a,b){b=this.finallyContexts_.splice(b||0)[0];if(b=this.abruptCompletion_=this.abruptCompletion_||b){if(b.isException)return this.jumpToErrorHandler_();void 0!=b.jumpTo&&this.finallyAddress_<b.jumpTo?(this.nextAddress=b.jumpTo,this.abruptCompletion_=null):this.nextAddress=this.finallyAddress_}else this.nextAddress=a};l.generator.Context.prototype.forIn=function(a){return new l.generator.Context.PropertyIterator(a)};
l.generator.Context.PropertyIterator=function(a){this.object_=a;this.properties_=[];for(var b in a)this.properties_.push(b);this.properties_.reverse()};l.generator.Context.PropertyIterator.prototype.getNext=function(){for(;0<this.properties_.length;){var a=this.properties_.pop();if(a in this.object_)return a}return null};l.generator.Engine_=function(a){this.context_=new l.generator.Context;this.program_=a};
l.generator.Engine_.prototype.next_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_.next,a,this.context_.next_);this.context_.next_(a);return this.nextStep_()};l.generator.Engine_.prototype.return_=function(a){this.context_.start_();var b=this.context_.yieldAllIterator_;if(b)return this.yieldAllStep_("return"in b?b["return"]:function(a){return{value:a,done:!0}},a,this.context_.return);this.context_.return(a);return this.nextStep_()};
l.generator.Engine_.prototype.throw_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_["throw"],a,this.context_.next_);this.context_.throw_(a);return this.nextStep_()};
l.generator.Engine_.prototype.yieldAllStep_=function(a,b,c){try{var d=a.call(this.context_.yieldAllIterator_,b);l.generator.ensureIteratorResultIsObject_(d);if(!d.done)return this.context_.stop_(),d;var e=d.value}catch(f){return this.context_.yieldAllIterator_=null,this.context_.throw_(f),this.nextStep_()}this.context_.yieldAllIterator_=null;c.call(this.context_,e);return this.nextStep_()};
l.generator.Engine_.prototype.nextStep_=function(){for(;this.context_.nextAddress;)try{var a=this.program_(this.context_);if(a)return this.context_.stop_(),{value:a.value,done:!1}}catch(b){this.context_.yieldResult=void 0,this.context_.throw_(b)}this.context_.stop_();if(this.context_.abruptCompletion_){a=this.context_.abruptCompletion_;this.context_.abruptCompletion_=null;if(a.isException)throw a.exception;return{value:a.return,done:!0}}return{value:void 0,done:!0}};
l.generator.Generator_=function(a){this.next=function(b){return a.next_(b)};this.throw=function(b){return a.throw_(b)};this.return=function(b){return a.return_(b)};l.initSymbolIterator();this[Symbol.iterator]=function(){return this}};l.generator.createGenerator=function(a,b){b=new l.generator.Generator_(new l.generator.Engine_(b));l.setPrototypeOf&&l.setPrototypeOf(b,a.prototype);return b};
l.asyncExecutePromiseGenerator=function(a){function b(b){return a.next(b)}function c(b){return a.throw(b)}return new Promise(function(d,e){function f(a){a.done?d(a.value):Promise.resolve(a.value).then(b,c).then(f,e)}f(a.next())})};l.asyncExecutePromiseGeneratorFunction=function(a){return l.asyncExecutePromiseGenerator(a())};l.asyncExecutePromiseGeneratorProgram=function(a){return l.asyncExecutePromiseGenerator(new l.generator.Generator_(new l.generator.Engine_(a)))};
l.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};l.stringPadding=function(a,b){a=void 0!==a?String(a):" ";return 0<b&&a?a.repeat(Math.ceil(b/a.length)).substring(0,b):""};
l.polyfill("String.prototype.padStart",function(a){return a?a:function(a,c){var b=l.checkStringArgs(this,null,"padStart");return l.stringPadding(c,a-b.length)+b}},"es8","es3");l.iteratorFromArray=function(a,b){l.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
l.polyfill("Array.prototype.values",function(a){return a?a:function(){return l.iteratorFromArray(this,function(a,c){return c})}},"es8","es3");l.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var e=b.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=b[c];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");l.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};
l.polyfill("Object.entries",function(a){return a?a:function(a){var b=[],d;for(d in a)l.owns(a,d)&&b.push([d,a[d]]);return b}},"es8","es3");l.polyfill("Object.values",function(a){return a?a:function(a){var b=[],d;for(d in a)l.owns(a,d)&&b.push(a[d]);return b}},"es8","es3");l.polyfill("String.prototype.padEnd",function(a){return a?a:function(a,c){var b=l.checkStringArgs(this,null,"padStart");return b+l.stringPadding(c,a-b.length)}},"es8","es3");function aa(a){throw Error(a);};const ba={of:(...a)=>{const b=[];for(const c of a)b[c>>>5]=(b[c>>>5]||0)|1<<c;return b},from:(a)=>{const b=[];for(const c of a)b[c>>>5]=(b[c>>>5]||0)|1<<c;return b},containsAll:(a,b)=>{for(let c=Math.max(a.length,b.length)-1;0<=c;c--)if((b[c]||0)&~(a[c]||0))return!1;return!0},difference:(a,b)=>{const c=Array(Math.max(a.length,b.length));for(let d=Math.max(a.length,b.length)-1;0<=d;d--)c[d]=(a[d]||0)&~(b[d]||0);return c},with:(a,b)=>{a=[...a];a[b>>>5]=(a[b>>>5]||0)|1<<b;return a},without:(a,b)=>{a=
[...a];a[b>>>5]=(a[b>>>5]||0)&~(1<<b);return a},has:(a,b)=>!!((a[b>>>5]||0)&1<<b),bits:(a)=>{const b=[];for(let c=0;c<a.length;c++){let d=a[c],e=32;for(;d;){const a=Math.clz32(d)+1;e-=a;d<<=a;32===a&&(d=0);b.push(c<<5|e)}}return b},clone:(a)=>[...a],empty:(a)=>a.every((a)=>!a)};const ja={of:(...a)=>{let b=ca;for(const c of a)b|=da<<BigInt(c);return b},from:(a)=>{let b=ca;for(const c of a)b|=da<<BigInt(c);return b},containsAll:(a,b)=>!(b&~a),with:(a,b)=>a|da<<BigInt(b),without:(a,b)=>a&~(da<<BigInt(b)),has:(a,b)=>!!(a&da<<BigInt(b)),bits:(a)=>{const b=[];let c=0;for(;a;){let d=Number(a&fa),e=32;for(;d;){const a=Math.clz32(d)+1;e-=a;d<<=a;32===a&&(d=0);b.push(c|e)}a>>=ia;c+=32}return b},clone:(a)=>a,empty:(a)=>!a,difference:(a,b)=>a&~b},ka="function"===typeof BigInt&&"bigint"===
typeof BigInt(0),ca=ka&&BigInt(0),da=ka&&BigInt(1),fa=ka&&BigInt(4294967295),ia=ka&&BigInt(32);const la=ka?ja:ba;let na;const oa=(a)=>a.split("").map((a)=>a.charCodeAt(0)),qa=(a)=>{if(!na){na=new Uint32Array(256);for(let a=0;256>a;a++){var b=a;for(let a=0;8>a;a++)b=b&1?3988292384^b>>>1:b>>>1;na[a]=b}}"string"===typeof a&&(a=oa(a));b=-1;for(let c=0,d=a.length;c<d;c++)b=b>>>8^na[(b^a[c])&255];return(b^-1)>>>0};class sa{constructor(a){this.buffer=Array(16);this.mask=15;this.size=this.end=this.start=0;a&&this.push(...a)}[Symbol.iterator](){let a=0;return{next:()=>a>=this.size?{value:void 0,done:!0}:{value:this.buffer[this.start+a++&this.mask],done:!1},[Symbol.iterator](){return this}}}get length(){return this.size}upsize(a){for(;this.mask<=a;)this.end<this.start&&(this.start+=this.mask+1),this.mask=this.mask<<1|1,this.buffer=this.buffer.concat(this.buffer);this.size=a}push(...a){this.upsize(this.size+a.length);
for(const b of a)this.buffer[this.end]=b,this.end=this.end+1&this.mask}pop(){if(this.size)return this.end=this.end-1&this.mask,this.size--,this.buffer[this.end]}peek(){if(this.size)return this.buffer[this.end-1&this.mask]}unshift(...a){this.upsize(this.size+a.length);let b=this.start=this.start-a.length&this.mask;for(const c of a)this.buffer[b++&this.mask]=c}shift(){if(this.size){var a=this.buffer[this.start];this.start=this.start+1&this.mask;this.size--;return a}}front(){if(this.size)return this.buffer[this.start]}get(a){if(!(a>=
this.size))return this.buffer[this.start+a&this.mask]}slice(a,b=this.size){0>a&&(a+=this.size);0>b&&(b+=this.size);if(b<=a)return[];a=this.start+Math.max(0,Math.min(this.size,a))&this.mask;b=this.start+Math.max(0,Math.min(this.size,b))&this.mask;return a<=b?this.buffer.slice(a,b):this.buffer.slice(a).concat(this.buffer.slice(0,b))}splice(a,b,...c){0>a&&(a+=this.size);a=Math.max(0,Math.min(this.size,a));b=Math.max(0,Math.min(this.size-a,b));var d=a+b;b=c.length-b;const e=this.slice(a,d);this.upsize(this.size+
b);this.size-=b;if(0===a)for(this.start=this.start-b&this.mask,a=0;a<c.length;a++)this.buffer[this.start+a&this.mask]=c[a];else if(d===this.size)for(this.end=this.end+b&this.mask,a+=this.start,d=0;d<c.length;d++)this.buffer[a+d&this.mask]=c[d];else c=[...this.slice(0,a),...c,...this.slice(d)],c.length=this.buffer.length,this.buffer=c,this.start=0,this.end=this.size;this.size+=b;return e}toString(){const a=Array(this.size);for(let b=0;b<this.size;b++)a[b]=this.buffer[this.start+b&this.mask];return`[${a.join(", ")}]`}}
class ta extends Error{}class n extends Map{constructor(a,b){super(b);this.supplier=a}get(a){let b=super.get(a);null==b&&super.set(a,b=this.supplier(a));return b}sortedKeys(a){return[...this.keys()].sort(a)}sortedEntries(a){return this.sortedKeys(a).map((a)=>[a,this.get(a)])}}var ua;
(function(a){a.concat=function*(...a){for(const b of a)yield*b};a.isEmpty=function(a){return!!a[Symbol.iterator]().next().done};a.map=function*(a,c){for(const b of a)yield c(b)};a.filter=function*(a,c){for(const b of a)c(b)&&(yield b)};a.flatMap=function*(a,c){for(const b of a)yield*c(b)};a.count=function(a){let b=0;for(const c of a)b++;return b};a.take=function*(a,c){for(const b of a){if(0>--c)break;yield b}};a.first=function(a,c){for(const b of a)return b;if(2>arguments.length)throw Error(`Empty iterable: ${a}`);
return c};a.zip=function(a,c,d=(a,b)=>[a,b]){return{*[Symbol.iterator](){const b=a[Symbol.iterator](),f=c[Symbol.iterator]();let g,h;for(;g=b.next(),h=f.next(),!g.done&&!h.done;)yield d(g.value,h.value)}}}})(ua||(ua={}));function va(a){return[...a]}class wa{constructor(){this.map=new Map}add(a){this.map.set(a.label,a)}has(a){return this.map.has(a.label)}delete(a){this.map.delete(a.label)}[Symbol.iterator](){return this.map.values()}}const xa=Symbol("Invalidated"),ya=Symbol("Size");
class Ba{constructor(a,b,c){this.ownerMap=a;this.ownerKey=b;this.currentSet=c}getCurrentSet(){if(!this.currentSet||this.currentSet[xa])this.currentSet=this.ownerMap.get(this.ownerKey)||new Set;return this.currentSet}mutateSet(a){const b=this.getCurrentSet(),c=b.size;try{return a(b)}finally{this.ownerMap[ya]+=b.size-c,b.size||(this.ownerMap.delete(this.ownerKey),b[xa]=!0)}}add(a){this.mutateSet((b)=>b.add(a));return this}has(a){return this.getCurrentSet().has(a)}clear(){this.mutateSet((a)=>a.clear())}delete(a){return this.mutateSet((b)=>
b.delete(a))}[Symbol.iterator](){return this.getCurrentSet()[Symbol.iterator]()}values(){return this.getCurrentSet().values()}keys(){return this.getCurrentSet().keys()}entries(){return this.getCurrentSet().entries()}forEach(a,b){this.getCurrentSet().forEach(a,b)}get size(){return this.getCurrentSet().size}get [Symbol.toStringTag](){return"Set"}}Reflect.setPrototypeOf(Ba.prototype,Set.prototype);
class Ca{constructor(a=[]){this.entries=new n(()=>0,a)}add(a){this.entries.set(a,this.entries.get(a)+1)}delete(a){const b=this.entries.get(a)-1;0<b?this.entries.set(a,b):this.entries.delete(a)}unique(){return this.entries.size}count(a){return this.entries.has(a)?this.entries.get(a):0}[Symbol.iterator](){return this.entries.entries()}}function Da(a){throw Error(`non-exhaustive check: ${a}`);}
class Ga{constructor(a){this.data=a}get(a){return this.data[a]}[Symbol.iterator](){return this.data.entries()}values(){return this.data[Symbol.iterator]()}}
class Ha{constructor(a){this.data=a;const b=new Map;for(let c=0;c<a.length;c++)b.set(a[c],c);this.rev=b;this.length=a.length}get(a){return this.data[a]}hasValue(a){return this.rev.has(a)}index(a){const b=this.rev.get(a);if(null==b)throw Error(`Missing index for ${a}`);return b}[Symbol.iterator](){return this.data.entries()}values(){return this.data[Symbol.iterator]()}}
class Ja{constructor(){this._fwd=[];this._rev=[]}*[Symbol.iterator](){for(let a=0;a<this._fwd.length;a++){const b=this._fwd[a];null!=b&&(yield[a,b])}}*keys(){for(let a=0;a<this._fwd.length;a++)null!=this._fwd[a]&&(yield a)}*values(){for(let a=0;a<this._rev.length;a++)null!=this._rev[a]&&(yield a)}get(a){return this._fwd[a]}has(a){return null!=this._fwd[a]}hasValue(a){return null!=this._rev[a]}index(a){const b=this._rev[a];if(null==b)throw Error(`Missing index for ${a}`);return b}set(a,b){if(this._fwd[a])throw Error(`already has key ${a}`);
if(this._rev[b])throw Error(`already has value ${b}`);this._fwd[a]=b;this._rev[b]=a}replace(a,b){var c=this._rev[b];null!=c&&delete this._fwd[c];c=this._fwd[a];null!=c&&delete this._rev[c];this._fwd[a]=b;this._rev[b]=a;return c}}
class Oa{constructor(a){this._map=new Map;if(a)for(const [b,c,d]of a)this.set(b,c,d)}*[Symbol.iterator](){for(const [a,b]of this._map)for(const [c,d]of b)yield[a,c,d]}set(a,b,c){let d=this._map.get(a);d||this._map.set(a,d=new Map);d.set(b,c)}get(a,b){var c;return null===(c=this._map.get(a))||void 0===c?void 0:c.get(b)}has(a,b){var c;return(null===(c=this._map.get(a))||void 0===c?void 0:c.has(b))||!1}delete(a,b){const c=this._map.get(a);c&&(c.delete(b),c.size||this._map.delete(a))}row(a){var b;return null!==
(b=this._map.get(a))&&void 0!==b?b:new Map}}var Pa;(function(a){a.NONE={get requested(){return!1},throwIfRequested(){},register(){return{unregister(){}}}};a.CANCELLED={get requested(){return!0},throwIfRequested(){throw Error("cancelled");},register(){return{unregister(){}}}}})(Pa||(Pa={}));var Qa=ua;class Ra{constructor(a){this.table=a}op(a){const b=this.table[a];if(!b)throw Error(`Bad mnemonic: ${a}`);return b}argLen(a){switch(a){case "acc":case "imp":return 0;case "imm":case "rel":case "zpg":case "zpx":case "zpy":case "iny":return 1;case "abs":case "abx":case "aby":case "ind":case "inx":return 2}return Da(a)}}var Xa;
(Xa||(Xa={})).P02=new Ra({adc:{abs:109,abx:125,aby:121,imm:105,iny:113,inx:97,zpg:101,zpx:117},and:{abs:45,abx:61,aby:57,imm:41,iny:49,inx:33,zpg:37,zpx:53},asl:{abs:14,abx:30,acc:10,imp:10,zpg:6,zpx:22},bcc:{rel:144},bcs:{rel:176},beq:{rel:240},bit:{abs:44,zpg:36},bmi:{rel:48},bne:{rel:208},bpl:{rel:16},brk:{imp:0},bvc:{rel:80},bvs:{rel:112},clc:{imp:24},cld:{imp:216},cli:{imp:88},clv:{imp:184},cmp:{abs:205,abx:221,aby:217,imm:201,iny:209,inx:193,zpg:197,zpx:213},cpx:{abs:236,imm:224,zpg:228},cpy:{abs:204,
imm:192,zpg:196},dec:{abs:206,abx:222,zpg:198,zpx:214},dex:{imp:202},dey:{imp:136},eor:{abs:77,abx:93,aby:89,imm:73,iny:81,inx:65,zpg:69,zpx:85},inc:{abs:238,abx:254,zpg:230,zpx:246},inx:{imp:232},iny:{imp:200},jmp:{abs:76,ind:108},jsr:{abs:32},lda:{abs:173,abx:189,aby:185,imm:169,iny:177,inx:161,zpg:165,zpx:181},ldx:{abs:174,aby:190,imm:162,zpg:166,zpy:182},ldy:{abs:172,abx:188,imm:160,zpg:164,zpx:180},lsr:{abs:78,abx:94,acc:74,imp:74,zpg:70,zpx:86},nop:{imp:234},ora:{abs:13,abx:29,aby:25,imm:9,
iny:17,inx:1,zpg:5,zpx:21},pha:{imp:72},php:{imp:8},pla:{imp:104},plp:{imp:40},rol:{abs:46,abx:62,acc:42,imp:42,zpg:38,zpx:54},ror:{abs:110,abx:126,acc:106,imp:106,zpg:102,zpx:118},rti:{imp:64},rts:{imp:96},sbc:{abs:237,abx:253,aby:249,imm:233,iny:241,inx:225,zpg:229,zpx:245},sec:{imp:56},sed:{imp:248},sei:{imp:120},sta:{abs:141,abx:157,aby:153,iny:145,inx:129,zpg:133,zpx:149},stx:{abs:142,zpg:134,zpy:150},sty:{abs:140,zpg:132,zpx:148},tax:{imp:170},tay:{imp:168},tsx:{imp:186},txa:{imp:138},txs:{imp:154},
tya:{imp:152}});var Ya=Xa;var Za;(function(a){class b{next(){for(;;){this.sink||(this.sink=this.pump());const {value:a,done:b}=this.sink.next();if(!b)return a;this.sink=void 0}}}a.Abstract=b;a.concat=function(...a){let b;return{next:()=>{for(;;){b||(b=a.shift());if(!b)break;const c=b.next();if(c)return c;b=void 0}}}}})(Za||(Za={}));var $a;
(function(a){function b(a,b){return a&&b&&a.token===b.token&&"grp"!==a.token&&a.str===b.str&&a.num===b.num?!0:!1}function c(a){switch(a.token){case "num":return`NUM[$${a.num.toString(16)}]`;case "str":return`STR[$${a.str}]`;case "lb":return"[";case "rb":return"]";case "grp":return"{";case "lc":return"{";case "rc":return"}";case "lp":return"(";case "rp":return")";case "eol":return"EOL";case "eof":return"EOF";case "ident":return a.str;case "cs":case "op":return`${a.str.toUpperCase()}`;default:Da(a)}}
function d(a){a=a.source;if(!a)return"";const b=a.parent?d({source:a.parent}):"";return`\n  at ${a.file}:${a.line}:${a.column}${b}`}function e(a){return c(a)+d(a)}function f(a,b){return g("ident","identifier",a,b)}function g(a,b,c,d){if(!c){if(!d)throw Error(`Expected ${b}`);throw Error(`Expected ${b} after ${e(d)}`);}if(c.token!==a)throw Error(`Expected ${b}: ${e(c)}`);return c.str}function h(a,c,d){for(;d<a.length;d++)if(b(a[d],c))return d;return-1}function k(a){let b=0;for(const c of a)"grp"===
c.token?b+=2+k(c.inner):b++;return b}a.LB={token:"lb"};a.LC={token:"lc"};a.LP={token:"lp"};a.RB={token:"rb"};a.RC={token:"rc"};a.RP={token:"rp"};a.EOL={token:"eol"};a.EOF={token:"eof"};a.DEFINE={token:"cs",str:".define"};a.DOT_EOL={token:"cs",str:".eol"};a.ELSE={token:"cs",str:".else"};a.ELSEIF={token:"cs",str:".elseif"};a.ENDIF={token:"cs",str:".endif"};a.ENDMAC={token:"cs",str:".endmac"};a.ENDMACRO={token:"cs",str:".endmacro"};a.ENDREP={token:"cs",str:".endrep"};a.ENDREPEAT={token:"cs",str:".endrepeat"};
a.ENDPROC={token:"cs",str:".endproc"};a.ENDSCOPE={token:"cs",str:".endscope"};a.LOCAL={token:"cs",str:".local"};a.MACRO={token:"cs",str:".macro"};a.REPEAT={token:"cs",str:".repeat"};a.SET={token:"cs",str:".set"};a.SKIP={token:"cs",str:".skip"};a.BYTE={token:"cs",str:".byte"};a.WORD={token:"cs",str:".word"};a.COLON={token:"op",str:":"};a.COMMA={token:"op",str:","};a.STAR={token:"op",str:"*"};a.IMMEDIATE={token:"op",str:"#"};a.ASSIGN={token:"op",str:"="};a.match=function(a,b){return a.token!==b.token?
!1:"num"===a.token||"str"===a.token?!0:a.str!==b.str?!1:!0};a.eq=b;a.name=c;a.at=d;a.nameAt=e;a.expectEol=function(b,c="end of line"){if(b)throw Error(`Expected ${c}: ${a.nameAt(b)}`);};a.expect=function(a,d,f){if(!d){if(!f)throw Error(`Expected ${c(a)}`);throw Error(`Expected ${c(a)} after ${e(d)}`);}if(!b(a,d))throw Error(`Expected ${c(a)}: ${e(d)}`);};a.expectIdentifier=f;a.expectString=function(a,b){return g("str","constant string",a,b)};a.identsFromCList=function(c){if(!c.length)return[];const d=
[];for(let f=0;f<=c.length;f+=2){const g=c[f];if("ident"!==(null===g||void 0===g?void 0:g.token)){if(g)throw Error(`Expected identifier: ${e(g)}`);throw Error(`Expected identifier after ${e(c[c.length-1])}`);}if(f+1<c.length&&!b(c[f+1],a.COMMA))throw Error(`Expected comma: ${e(c[f+1])}`);d.push(g.str)}return d};a.findBalanced=function(a,b){const c=a[b++].token;if("lp"!==c&&"lb"!==c)throw Error("non-grouping token");const d="lp"===c?"rp":"rb";let e=1;for(;b<a.length;b++){const f=a[b].token;e+=Number(f===
c)-Number(f===d);if(!e)return b}return-1};a.parseArgList=function(c,e=0,f=c.length){let g=[];const h=[g];let k=0;for(;e<f;e++){const f=c[e];if(!k&&b(f,a.COMMA))h.push(g=[]);else if(g.push(f),b(f,a.LP)&&k++,b(f,a.RP)&&0>--k)throw Error(`Unbalanced paren${d(f)}`);}return h};a.parseAttrList=function(c,g){const h=new Map;let k,m=[];if(g>=c.length)return h;if(!b(c[g],a.COLON))throw Error(`Unexpected: ${e(c[g])}`);for(g+=1;g<c.length;g++){const e=c[g];if(b(e,a.COLON)){if(null==k)throw Error(`Missing key${d(e)}`);
h.set(k,m);k=void 0;m=[]}else null==k?k=f(e):m.push(e)}null!=k?h.set(k,m):f(void 0,c[c.length-1]);return h};a.findComma=function(b,c){c=h(b,a.COMMA,c);return 0>c?b.length:c};a.find=h;a.count=k;a.isRegister=function(a,b){return"ident"===a.token&&a.str.toLowerCase()===b};a.str=function(b){switch(b.token){case "cs":case "ident":case "str":case "op":return b.str}throw Error(`Non-string token: ${a.nameAt(b)}`);};a.strip=function(a){delete a.source;return a}})($a||($a={}));new Set(".blank .const .defined .left .match .mid .right .tcount .xmatch".split(" "));
var cb=Za,q=$a;var db;
(function(a){function b(a,b){function c(a){return a.args?Object.assign({},a,{args:a.args.map((b)=>d(b,a))}):a}function d(a,d){const e=a.source;a=b(a,c,d);e&&!a.source&&(a.source=e);return a}return d(a)}function c(a,b){const [c,e]=d(a,void 0===b?0:b);if(e<a.length)throw Error(`Garbage after expression: ${q.nameAt(a[e])}`);if(!c)throw Error("No expression?");return c}function d(a,b){function d(){const [a,[,,b]]=e.pop(),c=f.splice(f.length-b,b);if(c.length!==b)throw Error("shunting parse failed?");f.push(fb({op:a,
args:c}))}b=void 0===b?0:b;const e=[],f=[];for(var g=!0,h=b;h<a.length;h++){var k=a[h];if(g)if("cs"===k.token||"op"===k.token){var m=kb.get(k.str);if(m=lb.get(null!==m&&void 0!==m?m:k.str))e.push([k.str,m]);else if("cs"===k.token){g=k.str;if(!mb.has(g))throw Error(`No such function: ${q.nameAt(k)}`);m=a[h+1];if("lp"!==(null===m||void 0===m?void 0:m.token))throw Error(`Bad funcall: ${q.nameAt(null!==m&&void 0!==m?m:k)}`);k=q.findBalanced(a,h+1);if(0>k)throw Error(`Never closed: ${q.nameAt(m)}`);m=
[];for(const b of q.parseArgList(a,h+2,k))m.push(c(b));h=k;f.push(fb({op:g,args:m}));g=!1}else if(q.eq(k,q.STAR))f.push({op:"sym",sym:"*"}),g=!1;else throw Error(`Unknown prefix operator: ${q.nameAt(k)}`);}else if("lp"===k.token){g=q.findBalanced(a,h);if(0>g)throw Error(`No close paren: ${q.nameAt(k)}`);h=c(a.slice(h+1,g));f.push(h);h=g;g=!1}else if("ident"===k.token)f.push({op:"sym",sym:k.str}),g=!1;else if("num"===k.token)k=k.num,f.push({op:"num",num:k,meta:nb(k)}),g=!1;else throw Error(`Bad expression token: ${q.nameAt(k)}`);
else{if(q.eq(k,q.COMMA))break;if("cs"===k.token||"op"===k.token){g=kb.get(k.str);g=ob.get(null!==g&&void 0!==g?g:k.str);if(!g)break;for(;e.length;){m=e[e.length-1];const a=sb(m[1],g);if(0>a)break;if(0===a)throw Error(`Mixing ${m[0]} and ${k.str} needs explicit parens.${q.at(k)}`);d()}e.push([k.str,g]);g=!0}else break}}for(;e.length;)d();if(1!==f.length)throw Error("shunting parse failed?");a[b].source&&(f[0].source=a[b].source);return[f[0],h]}function e(a){if(null!=a)return{op:"num",num:a,meta:nb(a)}}
function f(a,b){const c=a.args[0];if(!p(c))return a;a=b(c.num);return{op:"num",num:a,meta:nb(a)}}function g(a,b){const [c,d]=a.args;if(!p(c)||!p(d))return a;a=b(c.num,d.num);return{op:"num",num:a,meta:nb(a)}}function h(a){var b,c,d,e,f,g;const [h,k]=a.args;if("num"!==h.op||"num"!==k.op)return a;const m={op:"num",num:h.num+k.num};if(h.meta||k.meta){if((null===(b=h.meta)||void 0===b?0:b.rel)&&(null===(c=k.meta)||void 0===c?0:c.rel))return a;if(null===(d=h.meta)||void 0===d?0:d.rel)m.meta=h.meta;else if(null===
(e=k.meta)||void 0===e?0:e.rel)m.meta=k.meta}null!==(f=m.meta)&&void 0!==f&&f.rel||null!=(null===(g=m.meta)||void 0===g?void 0:g.size)||((m.meta||(m.meta={})).size=nb(m.num).size);return m}function k(a){var b,c,d,e,f;const [g,h]=a.args;if("num"!==g.op||"num"!==h.op)return a;const k={op:"num",num:g.num-h.num};if(null===(b=h.meta)||void 0===b?0:b.rel)return(null===(c=g.meta)||void 0===c?0:c.rel)&&g.meta.chunk===h.meta.chunk?k:a;if(null===(d=g.meta)||void 0===d?0:d.rel)k.meta=g.meta;null!==(e=k.meta)&&
void 0!==e&&e.rel||null!=(null===(f=k.meta)||void 0===f?void 0:f.size)||((k.meta||(k.meta={})).size=nb(k.num).size);return k}function p(a){var b;return"num"===a.op&&!(null===(b=a.meta)||void 0===b?0:b.rel)}a.traverse=b;a.traversePost=function(a,c){return b(a,(a,b)=>c(b(a)))};a.evaluate=function(a){var b,c,d,p;switch(a.op){case ".move":case "im":case "sym":return a;case "num":return(null===(b=a.meta)||void 0===b?0:b.rel)&&null!=a.meta.org?(b=Object.assign({},a.meta),b=(delete b.rel,b),{op:"num",num:a.num+
b.org,meta:b}):a;case ".max":throw Error();case ".min":throw Error();}if(1===(null===(c=a.args)||void 0===c?void 0:c.length))switch(a.op){case "+":return a.args[0];case "-":return f(a,(a)=>-a);case "~":return f(a,(a)=>~a);case "!":return f(a,(a)=>+!a);case "<":return f(a,(a)=>a&255);case ">":return f(a,(a)=>a>>8&255);case "^":return null!==(p=e(null===(d=a.args[0].meta)||void 0===d?void 0:d.bank))&&void 0!==p?p:a;default:throw Error(`Unknown unary operator: ${a.op}`);}switch(a.op){case "+":return h(a);
case "-":return k(a);case "*":return g(a,(a,b)=>a*b);case "/":return g(a,(a,b)=>Math.floor(a/b));case ".mod":return g(a,(a,b)=>a%b);case "&":return g(a,(a,b)=>a&b);case "|":return g(a,(a,b)=>a|b);case "^":return g(a,(a,b)=>a^b);case "<<":return g(a,(a,b)=>a<<b);case ">>":return g(a,(a,b)=>a>>>b);case "<":return g(a,(a,b)=>+(a<b));case "<=":return g(a,(a,b)=>+(a<=b));case ">":return g(a,(a,b)=>+(a>b));case ">=":return g(a,(a,b)=>+(a>=b));case "=":return g(a,(a,b)=>+(a==b));case "<>":return g(a,(a,
b)=>+(a!=b));case "&&":return g(a,(a,b)=>a&&b);case "||":return g(a,(a,b)=>a||b);case ".xor":return g(a,(a,b)=>!a&&b||!b&&a||0);default:throw Error(`Unknown operator: ${a.op}`);}};a.identifier=function(a){if("sym"===a.op&&a.sym)return a.sym;throw Error(`Expected identifier but got op: ${a.op}`);};a.parseOnly=c;a.parse=d})(db||(db={}));function sb(a,b){return a[0]>b[0]?1:a[0]<b[0]?-1:a[1]!==b[1]?0:a[1]}
const ob=new Map([["*",[5,4,2]],["/",[5,4,2]],[".mod",[5,3,2]],["&",[5,2,2]],["^",[5,1,2]],["<<",[5,0,2]],[">>",[5,0,2]],["+",[4,2,2]],["-",[4,2,2]],["|",[4,1,2]],["<",[3,0,2]],["<=",[3,0,2]],[">",[3,0,2]],[">=",[3,0,2]],["=",[3,0,2]],["<>",[3,0,2]],["&&",[2,3,2]],[".xor",[2,2,2]],["||",[2,1,2]]]),lb=new Map([["+",[9,-1,1]],["-",[9,-1,1]],["~",[9,-1,1]],["<",[9,-1,1]],[">",[9,-1,1]],["^",[9,-1,1]],["!",[2,-1,1]]]),mb=new Set([".byteat",".wordat",".max",".min"]),kb=new Map([[".bitand","&"],[".bitxor",
"^"],[".bitor","|"],[".shl","<<"],[".shr",">>"],[".and","&&"],[".or","||"],[".bitnot","~"],[".lobyte","<"],[".hibyte",">"],[".bankbyte","^"],[".not","!"]]),tb=new Map([["^",(...a)=>1===a.length?1:Math.max(...a)],["<",()=>1],[">",()=>1],["!",()=>1],["<=",()=>1],[">=",()=>1],["<>",()=>1],["=",()=>1],["&",Math.max],["&&",Math.max],["|",Math.max],["||",Math.max],[".xor",Math.max],[".max",Math.max],[".min",Math.max]]);
function fb(a){var b=tb.get(a.op);if(b=null===b||void 0===b?void 0:b(...a.args.map((a)=>{var b;return Number(null===(b=a.meta)||void 0===b?void 0:b.size)})))(a.meta||(a.meta={})).size=b;return a}function nb(a){return{size:0<=a&&256>a?1:2}}var zb=db;var Ab;(function(a){a.merge=function(a,c){const b=Object.assign({},a,c);a=[...a.free||[],...c.free||[]];a.length&&(b.free=a);return b}})(Ab||(Ab={}));var Hb=Ab;class Ib{constructor(a,b,c,d,e){this.line=a;this.column=b;this.prefix=c;this.remainder=d;this.match=e}}
class Jb{constructor(a,b=0,c=0){this.content=a;this.line=b;this.column=c;this.prefix="";this.remainder=a}advance(a){const b=this.remainder.substring(0,a.length);if(a!==b)throw Error(`Non-rooted token: '${a}' vs '${b}'`);this.prefix+=a;this.remainder=this.remainder.substring(a.length);a=a.split(/\n/g);1<a.length&&(this.line+=a.length-1,this.column=0);this.column+=a[a.length-1].length}saveState(){return new Ib(this.line,this.column,this.prefix,this.remainder,this.lastMatch)}restoreState(a){this.line=
a.line;this.column=a.column;this.prefix=a.prefix;this.remainder=a.remainder;this.lastMatch=a.match}skip(a){a=a.exec(this.remainder);if(!a)return!1;this.advance(a[0]);return!0}space(){return this.skip(/^[ \t]+/)}newline(){return this.skip(/^\n/)}lookingAt(a){return"string"===typeof a?this.remainder.startsWith(a):a.test(this.remainder)}token(a){if("string"===typeof a){if(!this.remainder.startsWith(a))return!1;a=[a]}else a=a.exec(this.remainder);if(!a)return!1;a.line=this.line;a.column=this.column;this.lastMatch=
a;this.advance(a[0]);return!0}lookBehind(a){if("string"===typeof a)return this.prefix.endsWith(a);a=a.exec(this.prefix);if(!a)return!1;a.line=this.line;a.column=this.line;this.lastMatch=a;return!0}match(){return this.lastMatch}group(a=0){var b;return null===(b=this.lastMatch)||void 0===b?void 0:b[a]}eof(){return!this.remainder}};class Kb{constructor(a,b="input.s",c={}){this.file=b;this.opts=c;this.buffer=new Jb(a)}next(){for(var a=this.token();q.eq(a,q.EOL);)a=this.token();var b=[[]];let c=0;for(;!q.eq(a,q.EOL)&&!q.eq(a,q.EOF);){if(q.eq(a,q.LC))b[c++].push(a),b.push([]);else if(q.eq(a,q.RC)){if(!c)throw Error(`Missing open curly: ${q.nameAt(a)}`);var d=b.pop();a=b[--c].pop().source;d={token:"grp",inner:d};a&&(d.source=a);b[c].push(d)}else b[c].push(a);a=this.token()}if(c)throw b=b[c-1].pop(),Error(`Missing close curly: ${q.nameAt(b)}`);
return b[0].length?b[0]:void 0}token(){for(;this.buffer.space()||this.buffer.token(/^;.*/)||this.opts.lineContinuations&&this.buffer.token(/^\\\n/););if(this.buffer.eof())return q.EOF;var a={file:this.file,line:this.buffer.line,column:this.buffer.column};try{const b=this.tokenInternal();this.opts.skipSourceAnnotations||(b.source=a);return b}catch(b){const {file:c,line:d,column:e}=a;a=(a=this.buffer.group())?` near '${a}'`:"";b.message+=`\n  at ${c}:${d}:${e}${a}`;throw b;}}tokenInternal(){if(this.buffer.newline())return{token:"eol"};
if(this.buffer.token(/^@+[a-z0-9_]*/i)||this.buffer.token(/^((::)?[a-z_][a-z0-9_]*)+/i))return this.strTok("ident");if(this.buffer.token(/^\.[a-z]+/i))return this.strTok("cs");if(this.buffer.token(/^:(\++|-+)/))return this.strTok("ident");if(this.buffer.token(/^(:|\++|-+|&&?|\|\|?|[#*/,=~!^]|<[<>=]?|>[>=]?)/))return this.strTok("op");if(this.buffer.token("["))return{token:"lb"};if(this.buffer.token("{"))return{token:"lc"};if(this.buffer.token("("))return{token:"lp"};if(this.buffer.token("]"))return{token:"rb"};
if(this.buffer.token("}"))return{token:"rc"};if(this.buffer.token(")"))return{token:"rp"};if(this.buffer.token(/^["']/))return this.tokenizeStr();if(this.buffer.token(/^[$%]?[0-9a-z_]+/i))return this.tokenizeNum();throw Error("Syntax error");}tokenizeStr(){const a=this.buffer,b=a.match()[0];let c="";for(;!a.lookingAt(b);){if(a.eof())throw Error(`EOF while looking for ${b}`);a.token(/^\\u([0-9a-f]{4})/i)?c+=String.fromCodePoint(parseInt(a.group(1),16)):a.token(/^\\x([0-9a-f]{2})/i)?c+=String.fromCharCode(parseInt(a.group(1),
16)):a.token(/^\\(.)/)?c+=a.group(1):(a.token(/^./),c+=a.group(0))}a.token(b);return{token:"str",str:c}}strTok(a){return{token:a,str:this.buffer.group()}}tokenizeNum(a=this.buffer.group()){this.opts.numberSeparators&&(a=a.replace(/_/g,""));if("$"===a[0]){a=a.substring(1);if(!/^[0-9a-f]+$/i.test(a))throw Error(`Bad hex number: $${a}`);return{token:"num",num:Number.parseInt(a,16)}}if("%"===a[0]){a=a.substring(1);if(!/^[01]+$/.test(a))throw Error(`Bad binary number: %${a}`);return{token:"num",num:Number.parseInt(a,
2)}}if("0"===a[0]){if(!/^[0-7]+$/.test(a))throw Error(`Bad octal number: ${a}`);return{token:"num",num:Number.parseInt(a,8)}}if(!/^[0-9]+$/.test(a))throw Error(`Bad decimal number: ${a}`);return{token:"num",num:Number.parseInt(a,10)}}};class Lb{constructor(){this.symbols=new Map}pickScope(a){return[a,this]}resolve(a,b){const [c,d]=this.pickScope(a);let e=d.symbols.get(c);if(e)return c!==a&&(e.scoped=!0),e;if(b)return b={},d.symbols.set(c,b),c!==a&&(b.scoped=!0),b}}
class Xb extends Lb{constructor(a,b){super();this.parent=a;this.kind=b;this.children=new Map;this.anonymousChildren=[];this.global=a?a.global:this}pickScope(a){var b=this;a=a.split(/::/g);const c=a.pop();for(let c=0;c<a.length;c++){if(!c&&!a[c]){b=b.global;continue}let d=b.children.get(a[c]);for(;!c&&b.parent&&!d;)d=(b=b.parent).children.get(a[c]);if(!d)throw b=a.slice(0,c+1).join("::"),Error(`Could not resolve scope ${b}`);b=d}return[c,b]}}
class Yb extends Lb{clear(){for(var a of this.symbols){const [b,c]=a;if(!c.expr)throw a=c.ref?q.at(c.ref):"",Error(`Cheap local label never defined: ${b}${a}`);}this.symbols.clear()}}
class Zb{constructor(a,b){a=void 0===a?Ya.P02:a;b=void 0===b?{}:b;this.cpu=a;this.opts=b;this.segments=["code"];this.segmentData=new Map;this.segmentStack=[];this.symbols=[];this.globals=new Map;this.currentScope=new Xb;this.cheapLocals=new Yb;this.anonymousForward=[];this.anonymousReverse=[];this.relativeForward=[];this.relativeReverse=[];this.chunks=[];this._org=this._name=this._chunk=void 0;this._segmentPrefix=""}get chunk(){this.ensureChunk();return this._chunk}ensureChunk(){this._chunk||(this._chunk=
{segments:this.segments,data:[]},null!=this._org&&(this._chunk.org=this._org),this._name&&(this._chunk.name=this._name),this.chunks.push(this._chunk))}definedSymbol(a){let b=this.currentScope;const c=!a.includes("::");do{const c=b.resolve(a,!1);if(c)return!!c.expr}while(c&&(b=b.parent));return!1}constantSymbol(a){a=this.currentScope.resolve(a,!1);return!(!a||!a.expr||0>a.id)}referencedSymbol(a){return null!=this.currentScope.resolve(a,!1)}evaluate(a){var b;a=this.resolve(a);if("num"===a.op&&(null===
(b=a.meta)||void 0===b||!b.rel))return a.num}pc(){var a;const b=this.chunk.data.length,c={rel:!0,chunk:this.chunks.length-1};null!=(null===(a=this._chunk)||void 0===a?void 0:a.org)&&(c.org=this._chunk.org);return zb.evaluate({op:"num",num:b,meta:c})}resolve(a){return zb.traverse(a,(a,c)=>{for(;"sym"===a.op&&a.sym;)a=this.resolveSymbol(a.sym);return zb.evaluate(c(a))})}resolveSymbol(a){if("*"===a)return this.pc();if(/^:\++$/.test(a)){a=a.length-2;var b=this.anonymousForward[a];if(null!=b)return{op:"sym",
num:b};this.anonymousForward[a]=b=this.symbols.length;this.symbols.push({id:b});return{op:"sym",num:b}}if(/^\++$/.test(a)){b=this.relativeForward[a.length-1];if(null!=b)return{op:"sym",num:b};this.relativeForward[a.length-1]=b=this.symbols.length;this.symbols.push({id:b});return{op:"sym",num:b}}if(/^:-+$/.test(a))return b=this.anonymousReverse.length-a.length+1,0>b&&this.fail(`Bad anonymous backref: ${a}`),this.anonymousReverse[b];if(/^-+$/.test(a))return b=this.relativeReverse[a.length-1],null==
b&&this.fail(`Bad relative backref: ${a}`),b;a=(a.startsWith("@")?this.cheapLocals:this.currentScope).resolve(a,!0);if(a.expr)return a.expr;null==a.id&&(a.id=this.symbols.length,this.symbols.push(a));return{op:"sym",num:a.id}}chunkData(a){return{org:this.chunks[a].org}}closeScopes(){function a(b){for(var c of b.children.values())a(c);for(const c of b.anonymousChildren)a(c);for(const a of b.symbols){const [d,f]=a;if(!f.expr&&null!=f.id&&b.parent){if(f.scoped)throw Error(`Symbol '${d}' undefined`);
if(c=b.parent.symbols.get(d))if(null!=c.id)f.expr={op:"sym",num:c.id};else if(c.expr)f.expr=c.expr;else throw Error(`Impossible: ${d}`);else b.parent.symbols.set(d,f)}}}this.cheapLocals.clear();if(this.currentScope.parent)throw Error("Scope never closed");a(this.currentScope);for(const a of this.globals){const [b,d]=a;{const a=this.currentScope.symbols.get(b);if("export"===d){if(null===a||void 0===a||!a.expr)throw Error(`Symbol '${b}' undefined`);null==a.id&&(a.id=this.symbols.length,this.symbols.push(a));
a.export=b}else if("import"===d){if(a){if(a.expr)throw Error(`Already defined: ${b}`);a.expr={op:"im",sym:b}}}else Da(d)}}for(const a of this.currentScope.symbols){const [b,d]=a;if(!d.expr)throw Error(`Symbol '${b}' undefined`);}}module(){this.closeScopes();const a=[];for(var b of this.chunks)a.push(Object.assign({},b,{data:Uint8Array.from(b.data)}));b=[];for(var c of this.symbols){if(null==c.expr)throw Error("Symbol undefined");const a={expr:c.expr};null!=c.export&&(a.export=c.export);b.push(a)}c=
[...this.segmentData.values()];return{chunks:a,symbols:b,segments:c}}line(a){this._source=a[0].source;3>a.length&&q.eq(a[a.length-1],q.COLON)?this.label(a[0]):q.eq(a[1],q.ASSIGN)?this.assign(q.str(a[0]),this.parseExpr(a,2)):q.eq(a[1],q.SET)?this.set(q.str(a[0]),this.parseExpr(a,2)):"cs"===a[0].token?this.directive(a):this.instruction(a)}tokens(a){let b;for(;b=a.next();)this.line(b)}tokensAsync(a){const b=this;return l.asyncExecutePromiseGeneratorFunction(function*(){let c;for(;c=yield a.nextAsync();)b.line(c)})}directive(a){switch(q.str(a[0])){case ".org":return this.org(this.parseConst(a));
case ".reloc":return this.parseNoArgs(a),this.reloc();case ".assert":return this.assert(this.parseExpr(a));case ".segment":return this.segment(...this.parseSegmentList(a));case ".byte":return this.byte(...this.parseDataList(a,!0));case ".res":return this.res(...this.parseResArgs(a));case ".word":return this.word(...this.parseDataList(a));case ".free":return this.free(this.parseConst(a),a[0]);case ".segmentprefix":return this.segmentPrefix(this.parseStr(a));case ".import":return this.import(...this.parseIdentifierList(a));
case ".export":return this.export(...this.parseIdentifierList(a));case ".scope":return this.scope(this.parseOptionalIdentifier(a));case ".endscope":return this.parseNoArgs(a),this.endScope();case ".proc":return this.proc(this.parseRequiredIdentifier(a));case ".endproc":return this.parseNoArgs(a),this.endProc();case ".pushseg":return this.pushSeg(...this.parseSegmentList(a));case ".popseg":return this.parseNoArgs(a),this.popSeg();case ".move":return this.move(...this.parseMoveArgs(a))}this.fail(`Unknown directive: ${q.nameAt(a[0])}`)}label(a){let b;
const c=this.pc();if("string"===typeof a)var d=a;else d=q.str(b=a),a.source&&(c.source=a.source);":"===d?(this.anonymousReverse.push(c),d=this.anonymousForward.shift(),null!=d&&(this.symbols[d].expr=c)):/^\++$/.test(d)?(a=this.relativeForward[d.length-1],delete this.relativeForward[d.length-1],null!=a&&(this.symbols[a].expr=c)):/^-+$/.test(d)?this.relativeReverse[d.length-1]=c:(d.startsWith("@")||(this.cheapLocals.clear(),this.chunk.name||this.chunk.data.length||(this.chunk.name=d)),this.assignSymbol(d,
!1,c,b))}assign(a,b){a.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${a}`);"number"!==typeof b&&(b=this.resolve(b));this.assignSymbol(a,!1,b)}set(a,b){a.startsWith("@")&&this.fail(`Cheap locals may only be labels: ${a}`);"number"!==typeof b&&(b=this.resolve(b));this.assignSymbol(a,!0,b)}assignSymbol(a,b,c,d){"number"===typeof c&&(c={op:"num",num:c});const e=a.startsWith("@")?this.cheapLocals:this.currentScope;let f=e.resolve(a,!b);if(f&&b!==0>f.id)this.fail(`Cannot change mutability of ${a}`,
d);else if(b&&"num"!=c.op)this.fail("Mutable set requires constant",d);else if(!f){if(!b)throw Error("impossible");e.symbols.set(a,f={id:-1})}else if(!b&&f.expr)throw b=f.expr.source?`\nOriginally defined${q.at(f.expr)}`:"",a=d?q.nameAt(d):a+(this._source?q.at({source:this._source}):""),Error(`Redefining symbol ${a}${b}`);f.expr=c}instruction(...a){var b;let c;1===a.length&&Array.isArray(a[0])?(a=a[0],c=q.expectIdentifier(a[0]).toLowerCase(),a=this.parseArg(a)):"string"===typeof a[1]?(c=a[0],a=new Kb(a[1]),
a=this.parseArg(a.next(),0)):(([c,a]=a)||(a=["imp"]),c=c.toLowerCase());const d=this.cpu.op(c),e=a[0];if("add"===e||"a,x"===e||"a,y"===e){const f=a[1],g=(null===(b=f.meta)||void 0===b?void 0:b.size)||2;if("add"===e&&1===g&&"zpg"in d)return this.opcode(d.zpg,1,f);if("add"===e&&"abs"in d)return this.opcode(d.abs,2,f);if("add"===e&&"rel"in d)return this.relative(d.rel,1,f);if("a,x"===e&&1===g&&"zpx"in d)return this.opcode(d.zpx,1,f);if("a,x"===e&&"abx"in d)return this.opcode(d.abx,2,f);if("a,y"===e&&
1===g&&"zpy"in d)return this.opcode(d.zpy,1,f);if("a,y"===e&&"aby"in d)return this.opcode(d.aby,2,f);this.fail(`Bad address mode ${e} for ${c}`)}if(e in d)return b=this.cpu.argLen(e),"rel"===e?this.relative(d[e],b,a[1]):this.opcode(d[e],b,a[1]);this.fail(`Bad address mode ${e} for ${c}`)}parseArg(a,b){b=void 0===b?1:b;if(a.length===b)return["imp"];const c=a[b];var d=a[b+1];if(a.length===b+1){if(q.isRegister(c,"a"))return["acc"]}else if(q.eq(c,q.IMMEDIATE))return["imm",zb.parseOnly(a,b+1)];if(q.eq(c,
q.COLON)&&a.length===b+2&&"op"===d.token&&/^[-+]+$/.test(d.str))return["add",{op:"sym",sym:":"+d.str}];if(a.length===b+1&&"op"===c.token&&/^[-+]+$/.test(c.str))return["add",{op:"sym",sym:c.str}];if(q.eq(c,q.LP)||this.opts.allowBrackets&&q.eq(c,q.LB)){d=q.findBalanced(a,b);0>d&&this.fail(`Unbalanced ${q.name(c)}`,c);const e=q.parseArgList(a,b+1,d);e.length||this.fail("Bad argument",c);const f=zb.parseOnly(e[0]);if(1===e.length){if(q.eq(a[d+1],q.COMMA)&&q.isRegister(a[d+2],"y"))return q.expectEol(a[d+
3]),["iny",f];q.expectEol(a[d+1]);return["ind",f]}if(2===e.length&&1===e[1].length&&q.isRegister(e[1][0],"x"))return["inx",f];this.fail("Bad argument",c)}a=q.parseArgList(a,b);a.length||this.fail("Bad arg",c);b=zb.parseOnly(a[0]);if(1===a.length)return["add",b];if(2===a.length&&1===a[1].length){if(q.isRegister(a[1][0],"x"))return["a,x",b];if(q.isRegister(a[1][0],"y"))return["a,y",b]}this.fail("Bad arg",c)}relative(a,b,c){var d;const e=this.chunk.data.length+b+1,f={rel:!0,chunk:this.chunks.length-
1};if(null===(d=this._chunk)||void 0===d?0:d.org)f.org=this._chunk.org;d={op:"-",args:[c,{op:"num",num:e,meta:f}]};c.source&&(d.source=c.source);this.opcode(a,b,d)}opcode(a,b,c){b&&(c=this.resolve(c));const {chunk:d}=this;d.data.push(a);b&&this.append(c,b);d.name||(d.name="Code")}append(a,b){var c;const {chunk:d}=this;a=this.resolve(a);let e=a.num;"num"!==a.op||(null===(c=a.meta)||void 0===c?0:c.rel)?(c=d.data.length,(d.subs||(d.subs=[])).push({offset:c,size:b,expr:a}),this.writeNumber(d.data,b)):
this.writeNumber(d.data,b,e)}org(a,b){this._org=a;this._chunk=void 0;this._name=b}reloc(a){this._chunk=this._org=void 0;this._name=a}segment(...a){this.segments=a.map((a)=>"string"===typeof a?a:a.name);for(const b of a)"object"===typeof b&&(a=this.segmentData.get(b.name)||{name:b.name},this.segmentData.set(b.name,Hb.merge(a,b)));this._name=this._chunk=void 0}assert(a){a=this.resolve(a);var b=this.evaluate(a);null!=b?b||this.fail("Assertion failed",a):({chunk:b}=this,(b.asserts||(b.asserts=[])).push(a))}byte(...a){const {chunk:b}=
this;for(const d of a)if("number"===typeof d)this.writeNumber(b.data,1,d);else if("string"===typeof d){a=b.data;var c=d;for(let b=0;b<c.length;b++)a.push(c.charCodeAt(b))}else this.append(d,1)}res(a,b){a&&this.byte(...Array(a).fill(null!==b&&void 0!==b?b:0))}word(...a){const {chunk:b}=this;for(const c of a)"number"===typeof c?this.writeNumber(b.data,2,c):this.append(c,2)}free(a,b){null==this._org&&this.fail(".free in .reloc mode",b);var c=1<this.segments.length?this.segments.filter((a)=>{a=this.segmentData.get(a);
return!a||null==a.memory||null==a.size||a.memory>this._org||a.memory+a.size<=this._org?!1:!0}):this.segments;1!==c.length?this.fail(`.free with non-unique segment: ${this.segments}`,b):0>a&&this.fail(`.free with negative size: ${a}`,b);this._chunk&&(this._org+=this._chunk.data.length);this._chunk=void 0;b=c[0];(c=this.segmentData.get(b))||this.segmentData.set(b,c={name:b});(c.free||(c.free=[])).push([this._org,this._org+a]);this._org+=a}segmentPrefix(a){this._segmentPrefix=a}import(...a){for(const b of a)this.globals.set(b,
"import")}export(...a){for(const b of a)this.globals.set(b,"export")}scope(a){this.enterScope(a,"scope")}proc(a){this.label(a);this.enterScope(a,"proc")}enterScope(a,b){const c=a?this.currentScope.children.get(a):void 0;if(c){if(this.opts.reentrantScopes){this.currentScope=c;return}this.fail(`Cannot re-enter scope ${a}`)}b=new Xb(this.currentScope,b);a?this.currentScope.children.set(a,b):this.currentScope.anonymousChildren.push(b);this.currentScope=b}endScope(){this.exitScope("scope")}endProc(){this.exitScope("proc")}exitScope(a){this.currentScope.kind===
a&&this.currentScope.parent||this.fail(`.end${a} without .${a}`);this.currentScope=this.currentScope.parent}pushSeg(...a){this.segmentStack.push([this.segments,this._chunk]);this.segment(...a)}popSeg(){this.segmentStack.length||this.fail(".popseg without .pushseg");[this.segments,this._chunk]=this.segmentStack.pop()}move(a,b){this.append({op:".move",args:[b],meta:{size:a}},a)}parseConst(a,b){b=this.evaluate(zb.parseOnly(a,void 0===b?1:b));if(null!=b)return b;this.fail("Expression is not constant",
a[1])}parseNoArgs(a){q.expectEol(a[1])}parseExpr(a,b){return zb.parseOnly(a,void 0===b?1:b)}parseStr(a,b){b=void 0===b?1:b;const c=q.expectString(a[b]);q.expectEol(a[b+1],"a single string");return c}parseSegmentList(a,b){b=void 0===b?1:b;a.length<b+1&&this.fail("Expected a segment list",a[b-1]);return q.parseArgList(a,1).map((a)=>{var b=this._segmentPrefix+q.expectString(a[0]);if(1===a.length)return b;q.eq(a[1],q.COLON)||this.fail(`Expected comma or colon: ${q.name(a[1])}`,a[1]);b={name:b};a=q.parseAttrList(a,
1);for(const c of a){const [a,d]=c;switch(a){case "bank":b.bank=this.parseConst(d,0);break;case "size":b.size=this.parseConst(d,0);break;case "off":b.offset=this.parseConst(d,0);break;case "mem":b.memory=this.parseConst(d,0);break;default:this.fail(`Unknown segment attr: ${a}`)}}return b})}parseResArgs(a){a=this.parseDataList(a);2<a.length&&this.fail("Expected at most 2 args",a[2]);a.length||this.fail("Expected at least 1 arg");const b=this.evaluate(a[0]);null==b&&this.fail("Expected constant count");
const c=a[1]&&this.evaluate(a[1]);a[1]&&null==c&&this.fail("Expected constant value");return[b,c]}parseDataList(a,b){b=void 0===b?!1:b;2>a.length&&this.fail("Expected a data list",a[0]);const c=[];for(const d of q.parseArgList(a,1))b&&1===d.length&&"str"===d[0].token?c.push(d[0].str):c.push(this.resolve(zb.parseOnly(d)));return c}parseIdentifierList(a){2>a.length&&this.fail("Expected identifier(s)",a[0]);const b=[];for(const c of q.parseArgList(a,1))1===c.length&&"ident"===c[0].token||this.fail(`Expected identifier: ${q.name(c[0])}`,
c[0]),b.push(q.str(c[0]));return b}parseOptionalIdentifier(a){var b=a[1];if(b)return b=q.expectIdentifier(b),q.expectEol(a[2]),b}parseRequiredIdentifier(a){const b=q.expectIdentifier(a[1]);q.expectEol(a[2]);return b}parseMoveArgs(a){var b;a=q.parseArgList(a,1);2!==a.length&&this.fail("Expected constant number, then identifier");const c=this.evaluate(zb.parseOnly(a[0]));null==c&&this.fail("Expected a constant number");const d=this.resolve(zb.parseOnly(a[1]));if("num"===d.op&&null!=(null===(b=d.meta)||
void 0===b?void 0:b.chunk))return[c,d];this.fail("Expected a constant offset",a[1][0])}fail(a,b){var c;if(null===b||void 0===b?0:b.source)throw Error(a+q.at(b));if(!this._source&&(null===(c=this._chunk)||void 0===c?0:c.name))throw Error(a+`\n  in ${this._chunk.name}`);throw Error(a+q.at({source:this._source}));}writeNumber(a,b,c){var d=b<<3;null!=c&&(c<-1<<d||c>=1<<d)&&this.fail(`Not a ${["byte","word","farword","dword"][b-1]}: $${c.toString(16)}`);for(d=0;d<b;d++)a.push(null!=c?c&255:255),null!=
c&&(c>>=8)}};class $b{constructor(a){this.overloads=a}canOverload(){return this.overloads[this.overloads.length-1].canOverload()}append(a){if(!this.canOverload()){var b=this.overloads[this.overloads.length-1].definition;b=(b?q.at(b):"").replace(/at/,"previously defined at");a=(a=a.overloads[0].definition)?q.nameAt(a):"";throw Error(`Non-overloadable: ${a}${b}`);}this.overloads.push(...a.overloads)}expand(a,b){const c=[];for(const d of this.overloads){const e=d.expand(a,b);if(Array.isArray(e))return e;c.push(e)}}static from(a){var b;
if(!q.eq(a[0],q.DEFINE))throw Error("invalid");if("ident"!==(null===(b=a[1])||void 0===b?void 0:b.token))throw Error("invalid");if(b=a[2])if("grp"===b.token)a=new ac(b.inner,a.slice(3),a[1]);else if("lp"===b.token){b=q.findBalanced(a,2);if(0>b)throw Error(`Expected close paren ${q.nameAt(a[2])}`);a=new bc(q.identsFromCList(a.slice(3,b)),a.slice(b+1),a[1])}else a=new ac([],a.slice(2),a[1]);else a=new ac([],[],a[1]);return new $b([a])}}
function cc(a,b,c,d,e){const f=[];let g=[],h=f;for(const b of e){if("ident"===b.token){if(e=d.get(b.str)){h.push(...e);continue}}else if(q.eq(b,q.DOT_EOL)){g.push(h=[]);continue}e=b.source&&a[0].source?Object.assign({},b.source,{parent:a[0].source}):b.source||a[0].source;h.push(e?Object.assign({},b,{source:e}):b)}g=g.filter((a)=>a.length);if(g.length&&c<a.length)return"cannot expand .eol without consuming to end of line";a.splice(b,c-b,...f);return g}
class bc{constructor(a,b,c){this.params=a;this.production=b;this.definition=c}expand(a,b){let c=b+1,d=this.params.length?a.length:b;var e=d;const f=new Map;if(b<a.length&&q.eq(q.LP,a[c])){e=q.findBalanced(a,c);if(0>e)return"missing close paren for enclosed C-style expansion";d=e+1;c++}e=q.parseArgList(a,c,e);if(e.length>this.params.length)return"too many args";for(c=0;c<this.params.length;c++){let a=e[c]||[];const b=a[0];1===a.length&&"grp"===b.token&&(a=b.inner);f.set(this.params[c],a)}return cc(a,
b,d,f,this.production)}canOverload(){return!!this.params.length}}
class ac{constructor(a,b,c){this.pattern=a;this.production=b;this.definition=c}expand(a,b){let c=b+1;const d=new Map;for(let b=0;b<this.pattern.length;b++){const f=this.pattern[b];if("ident"===f.token){var e=this.pattern[b+1];if(e&&"ident"!==(null===e||void 0===e?void 0:e.token)){const b=q.eq(e,q.DOT_EOL)?a.length:q.find(a,e,c);if(0>b)return`could not find delimiter ${q.name(e)}`;d.set(f.str,a.slice(c,b));c=b}else{e=a[c++];if(!e)return`missing undelimited argument ${q.name(f)}`;d.set(f.str,"grp"===
e.token?e.inner:[e])}}else if(q.eq(f,q.DOT_EOL)){if(c<a.length)return"could not match .eol"}else if(!q.eq(a[c++],f))return`could not match: ${q.name(f)}`}return cc(a,b,c,d,this.production)}canOverload(){return!!this.pattern.length}};function dc(a,b){if(!a)return-1;var c=b(0),d=b(a-1);if(0>c)return-1;if(0===c)return 0;if(0<d)return~a;if(0===d)return a-1;c=0;for(--a;1<a-c;){d=c+a>>1;const e=b(d);if(0<e)c=d;else if(0>e)a=d;else return d}return~a}function mc(a,b,c){const d=b(c),e=dc(a.length,(c)=>d<b(a[c])?-1:1);a.splice(~e,0,c)}
class nc{constructor(){this._chunks=[];this._length=0}get length(){return this._length}_find(a){return dc(this._chunks.length,(b)=>{const [c,d]=this._chunks[b];return a<c?-1:a>=c+d.length?1:0})}apply(a){if(a.length<this._length)throw Error("Target too small.");for(const [b,c]of this._chunks)for(let d=0;d<c.length;d++)a[b+d]=c[d]}chunks(){return this._chunks}get(a){let b=this._find(a);if(!(0>b)){var [c,d]=this._chunks[b];return d[a-c]}}set(a,...b){this.setInternal(a,b)}setInternal(a,b){var c;if(b.length){var d=
a+b.length;this._length=Math.max(this._length,d);var e=this._find(a),f=this._find(d);if(0<=e&&e===f){const [c,d]=this._chunks[e];for(f=0;f<b.length;f++)d[a+f-c]=b[f]}else{var g=this._chunks[~e-1];g&&g[0]+g[1].length===a&&(e=~e-1);(null===(c=this._chunks[~f])||void 0===c?void 0:c[0])===d&&(f=~f);if(0<=e){const [d,k]=this._chunks[e];f===e&&Array.isArray(b)?b.unshift(...k.slice(0,a-d)):(c=k,a-=d,g=c.length,b.length<g||!Array.isArray(b)?(c.splice(a,g-a,...b),b=c):b.unshift(...oc(c,a)));a=d}if(0<=f){const [a,
e]=this._chunks[f];d-=a;c=e;b.length<c.length||!Array.isArray(b)?(c.splice(0,d,...b),b=c):b.push(...pc(c,d))}e=0>e?~e:e;d=0>f?~f:f;0<=f&&d++;Array.isArray(b)||(b=Array.from(b));this._chunks.splice(e,d-e,[a,b])}}}splice(a,b=1){const c=a+b;var d=this._find(a);b=this._find(c);var e=0<=d?this._chunks[d]:void 0;let f=0<=b?this._chunks[b]:void 0;e&&((a-=e[0])?e=[e[0],e===f?e[1].slice(0,a):oc(e[1],a)]:(e=void 0,d=~d));f&&(f=[c,pc(f[1],c-f[0])],f[1].length||(f=void 0,b=~b));a=[];e&&a.push(e);f&&a.push(f);
d=0>d?~d:d;e=0>b?~b:b;0<=b&&e++;this._chunks.splice(d,e-d,...a)}slice(a,b){if(b<=a)return[];const c=this._find(a);if(0>c)throw Error(`Absent: ${a}`);const [d,e]=this._chunks[c];if(d+e.length<b)throw Error(`Absent: ${d+e.length}`);return e.slice(a-d,b-d)}}
class qc extends nc{set(a,...b){this.setInternal(a,b[0]instanceof Uint8Array?b[0]:Uint8Array.from(b))}search(a,b,c){return this.pattern(a).search(b,c)}pattern(a){function b(b){for(let c=b,e=0;c<d;++c,++e)if(a[c]!==a[e])return!1;return!0}function c(b){let c=0;for(let e=b,f=d-1;0<=e&&a[e]===a[f];--e,--f)++c;return c}if(!a.length)return{search:(a=0)=>a};const d=a.length,e=Array(256).fill(d);for(var f=0;f<a.length;f++)e[a[f]]=d-1-f;const g=[];f=d;for(let a=d;0<a;--a){b(a)&&(f=a);g[d-a]=f-a+d;for(let a=
0;a<d-1;++a){const b=c(a);g[b]=d-1-a+b}}return{search:(b=0,c=this._length)=>{if(!this._chunks.length||c<b)return-1;let f=this._find(b),h=0;for(0<=f?h=b-this._chunks[f][0]:f=~f;f<this._chunks.length;){const [k,p]=this._chunks[f++];b=Math.min(c-k,p.length);if(0>b)break;for(let c=d-1+h,f;c<b;){for(f=d-1;a[f]===p[c];--c,--f)if(0===f)return c+k;c+=Math.max(g[d-1-f],e[p[c]])}h=0}return-1}}}addOffset(a){const b=new qc;for(const [c,d]of this._chunks)b._chunks.push([c+a,d]);return b}toIpsPatch(){var a=8;for(var [,
b]of this._chunks)a+=5+b.length;a=new Uint8Array(a);b=5;a[0]=80;a[1]=65;a[2]=84;a[3]=67;a[4]=72;for(const [c,d]of this._chunks){if(65535<d.length)throw Error("Oops!");a[b++]=c>>>16;a[b++]=c>>>8&255;a[b++]=c&255;a[b++]=d.length>>>8;a[b++]=d.length&255;a.subarray(b,b+d.length).set(d);b+=d.length}a[b]=69;a[b+1]=79;a[b+2]=70;return a}toIpsHexString(){const a=[...this.toIpsPatch()],b=[];for(let c=0;c<a.length;c+=16)b.push([c.toString(16).padStart(8,"0")+":",...a.slice(c,c+16).map((a)=>a.toString(16).padStart(2,
"0"))].join(" "));return b.join("\n")}}function oc(a,b){const c=a.length;if(b<<1<c)return a.slice(0,b);a.splice(b,c-b);return a}function pc(a,b){return b<<1<a.length?(a.splice(0,b),a):a.slice(b)}
class rc{constructor(){this.data=[]}[Symbol.iterator](){return this.data[Symbol.iterator]()}_find(a){return dc(this.data.length,(b)=>{b=this.data[b];return a<b[0]?-1:a>=b[1]?1:0})}has(a){return 0<=this._find(a)}add(a,b){var c,d,e=this._find(a);let f=this._find(b);(null===(c=this.data[~e-1])||void 0===c?void 0:c[1])===a&&(e=~e-1);(null===(d=this.data[~f])||void 0===d?void 0:d[0])===b&&(f=~f);a=[a,b];0<=e&&(a[0]=this.data[e][0]);0<=f&&(a[1]=this.data[f][1]);e=0>e?~e:e;b=0>f?~f:f;0<=f&&b++;this.data.splice(e,
b-e,a)}delete(a,b){var c=this._find(a);let d=this._find(b);var e=0<=c?this.data[c]:void 0;let f=0<=d?this.data[d]:void 0;e&&(e=[e[0],Math.min(e[1],a)],e[0]===e[1]&&(e=void 0,c=~c));f&&(f=[Math.max(f[0],b),f[1]],f[0]===f[1]&&(f=void 0,d=~d));a=[];e&&a.push(e);f&&a.push(f);c=0>c?~c:c;e=0>d?~d:d;0<=d&&e++;this.data.splice(c,e-c,...a)}tail(a){let b=this._find(a);0>b&&(b=~b);const c=this.data;return{[Symbol.iterator](){return this},next(){if(b>=c.length)return{value:void 0,done:!0};const d=c[b++];return{value:[Math.max(a,
d[0]),d[1]],done:!1}}}}};class sc{constructor(){this._link=new tc}static link(...a){const b=new sc;for(const c of a)b.read(c);return b.link()}read(a){this._link.readFile(a);return this}base(a,b){this._link.base(a,void 0===b?0:b);return this}link(){return this._link.link()}report(a){console.log(this._link.report(void 0===a?!1:a))}exports(){return this._exports?this._exports:this._exports=this._link.buildExports()}watch(...a){this._link.watches.push(...a)}}function Fc(a){throw Error(a);}
class Gc{constructor(a){var b,c,d,e,f;const g=this.name=a.name;this.bank=null!==(b=a.bank)&&void 0!==b?b:0;this.addressing=null!==(c=a.addressing)&&void 0!==c?c:2;this.size=null!==(d=a.size)&&void 0!==d?d:Fc(`Size must be specified: ${g}`);this.offset=null!==(e=a.offset)&&void 0!==e?e:Fc(`OFfset must be specified: ${g}`);this.memory=null!==(f=a.memory)&&void 0!==f?f:Fc(`OFfset must be specified: ${g}`)}get delta(){return this.offset-this.memory}}
class Hc{constructor(a,b,c,d,e){this.linker=a;this.index=b;this.subs=new Set;this.selfSubs=new Set;this.deps=new Set;this.imports=new Set;this.follow=new Map;this.overlaps=!1;this.name=c.name;this.size=c.data.length;this.segments=c.segments;this._data=c.data;for(const a of c.subs||[])this.subs.add(Ic(a,d,e));this.asserts=(c.asserts||[]).map((a)=>Jc(a,d,e));c.org&&(this._org=c.org)}get org(){return this._org}get offset(){return this._offset}get segment(){return this._segment}get data(){var a;return null!==
(a=this._data)&&void 0!==a?a:Fc("no data")}initialPlacement(){if(null!=this._org){var a=[];for(const b of this.segments){const c=this.linker.segments.get(b);if(!c)throw Error(`Unknown segment: ${b}`);this._org>=c.memory&&this._org<c.memory+c.size&&a.push(c)}if(1!==a.length)throw Error(`Non-unique segment: ${a}`);a=a[0];if(this._org>=a.memory+a.size)throw Error(`Chunk does not fit in segment ${a.name}`);this.place(this._org,a)}}place(a,b){var c;this._org=a;this._segment=b;a=this._offset=a+b.delta;
for(var d of this.linker.watches)if(d>=a&&d<a+this.size)debugger;mc(this.linker.placed,(a)=>a[0],[a,this]);d=this.linker.data;b=null!==(c=this._data)&&void 0!==c?c:Fc("No data");this._data=void 0;if(this.subs.size){d.splice(a,b.length);c=new qc;c.set(0,b);for(const a of this.subs)c.splice(a.offset,a.size);for(const b of c.chunks()){const [c,e]=b;d.set(a+c,...e)}}else d.set(a,b);for(const a of this.follow){const [b,c]=a;c.resolveSub(b,!1)}this.linker.free.delete(this.offset,this.offset+this.size)}resolveSubs(a){a=
void 0===a?!1:a;for(const b of this.selfSubs)this.resolveSub(b,a);for(const b of this.subs)this.resolveSub(b,a)}addDep(a,b){b===this.index&&this.subs.delete(a)&&this.selfSubs.add(a);this.linker.chunks[b].follow.set(a,this);this.deps.add(b)}resolveSub(a,b){var c,d;if(this.subs.has(a)||this.selfSubs.has(a)){a.expr=zb.traverse(a.expr,(c,d,e)=>{var f;if(b&&"^"===(null===e||void 0===e?void 0:e.op)&&1===e.args.length&&c.meta)return null==c.meta.bank&&this.addDep(a,c.meta.chunk),c;c=this.linker.resolveLink(zb.evaluate(d(c)));
b&&(null===(f=c.meta)||void 0===f?0:f.rel)&&this.addDep(a,c.meta.chunk);return c});var e=!1;if("num"===a.expr.op&&(null===(c=a.expr.meta)||void 0===c||!c.rel))this.writeValue(a.offset,a.expr.num,a.size),e=!0;else if(".move"===a.expr.op){if(1!==a.expr.args.length)throw Error("bad .move");c=a.expr.args[0];"num"===c.op&&null!=(null===(d=c.meta)||void 0===d?void 0:d.offset)&&(d=c.meta.offset+c.num,d=this.linker.orig.slice(d,d+a.size),this.writeBytes(a.offset,Uint8Array.from(d)),e=!0)}e&&(this.subs.delete(a)||
this.selfSubs.delete(a),this.subs.size||this.linker.unresolvedChunks.delete(this)&&this.linker.insertResolved(this))}}writeBytes(a,b){if(this._data)this._data.subarray(a,a+b.length).set(b);else if(null!=this._offset)this.linker.data.set(this._offset+a,b);else throw Error("Impossible");}writeValue(a,b,c){var d=c<<3;if(null!=b&&(b<-1<<d||b>=1<<d))throw Error(`Not a ${["byte","word","farword","dword"][c-1]}: $${b.toString(16)}`);d=new Uint8Array(c);for(let a=0;a<c;a++)d[a]=b&255,b>>=8;this.writeBytes(a,
d)}}function Ic(a,b,c){a=Object.assign({},a);a.expr=Jc(a.expr,b,c);return a}function Jc(a,b,c){var d;a=Object.assign({},a);a.meta&&(a.meta=Object.assign({},a.meta));a.args&&(a.args=a.args.map((a)=>Jc(a,b,c)));null!=(null===(d=a.meta)||void 0===d?void 0:d.chunk)&&(a.meta.chunk+=b);"sym"===a.op&&null!=a.num&&(a.num+=c);return a}function Kc(a,b,c){a=Object.assign({},a);a.expr&&(a.expr=Jc(a.expr,b,c));return a}
class tc{constructor(){this.data=new qc;this.orig=new qc;this.exports=new Map;this.chunks=[];this.symbols=[];this.free=new rc;this.rawSegments=new Map;this.segments=new Map;this.resolvedChunks=[];this.unresolvedChunks=new Set;this.watches=[];this.placed=[];this.initialReport=""}insertResolved(a){mc(this.resolvedChunks,(a)=>a.size,a)}base(a,b){b=void 0===b?0:b;this.data.set(b,a);this.orig.set(b,a)}readFile(a){const b=this.chunks.length,c=this.symbols.length;for(var d of a.segments||[])this.addRawSegment(d);
for(const e of a.chunks||[])d=new Hc(this,this.chunks.length,e,b,c),this.chunks.push(d);for(const d of a.symbols||[])this.symbols.push(Kc(d,b,c))}resolveLink(a){var b,c,d;if(".orig"===a.op&&1===(null===(b=a.args)||void 0===b?void 0:b.length)){var e=a.args[0];var f=null===(c=e.meta)||void 0===c?void 0:c.offset;if(null!=f&&(e=this.orig.get(f+e.num),null!=e))return{op:"num",num:e}}else"num"===a.op&&null!=(null===(d=a.meta)||void 0===d?void 0:d.chunk)&&(c=a.meta,b=this.chunks[c.chunk],b.org!==c.org||
(null===(f=b.segment)||void 0===f?void 0:f.bank)!==c.bank||b.offset!==c.offset)&&(f={org:b.org,offset:b.offset,bank:null===(e=b.segment)||void 0===e?void 0:e.bank},a=zb.evaluate(Object.assign({},a,{meta:Object.assign({},c,f)})));return a}resolveExpr(a){var b;a=zb.traverse(a,(a,b)=>this.resolveLink(zb.evaluate(b(a))));if("num"===a.op&&(null===(b=a.meta)||void 0===b||!b.rel))return a.num;a=q.at(a);throw Error(`Unable to fully resolve expr${a}`);}link(){for(var a of this.rawSegments){const [c,d]=a;var b=
d[0];for(let a=1;a<d.length;a++)b=Hb.merge(b,d[a]);this.segments.set(c,new Gc(b))}for(var c of this.rawSegments){const [e,f]=c;a=this.segments.get(e);for(var d of f){b=d.free;for(const c of b||[]){const [b,d]=c;this.free.add(b+a.delta,d+a.delta);this.data.splice(b+a.delta,d-b)}}}for(const a of this.chunks)a.initialPlacement();for(c=0;c<this.symbols.length;c++){d=this.symbols[c];if(!d.expr)throw Error(`Symbol ${c} never resolved`);null!=d.export&&this.exports.set(d.export,c)}for(var e of this.symbols)e.expr=
this.resolveSymbols(e.expr);for(var f of this.chunks){for(const a of[...f.subs,...f.selfSubs])a.expr=this.resolveSymbols(a.expr);for(e=0;e<f.asserts.length;e++)f.asserts[e]=this.resolveSymbols(f.asserts[e])}for(const a of this.chunks)a.resolveSubs(!0);f=[...this.chunks];f.sort((a,b)=>b.size-a.size);for(var g of f)g.resolveSubs(),g.subs.size?this.unresolvedChunks.add(g):this.insertResolved(g);for(g=this.resolvedChunks.length+2*this.unresolvedChunks.size;g;){if(f=this.resolvedChunks.pop())this.placeChunk(f);
else{[f]=this.unresolvedChunks;for(var h of f.deps)f=this.chunks[h],null==f.org&&this.placeChunk(f)}f=this.resolvedChunks.length+2*this.unresolvedChunks.size;if(f===g)throw console.error(this.resolvedChunks,this.unresolvedChunks),Error("Not making progress");g=f}h=new qc;for(var k of this.chunks){for(const a of k.asserts)if(!this.resolveExpr(a))throw k=q.at(a),Error(`Assertion failed${k}`);k.overlaps||h.set(k.offset,...this.data.slice(k.offset,k.offset+k.size))}return h}placeChunk(a){if(null==a.org){var b=
a.size;if(!a.subs.size&&!a.selfSubs.size){var c=this.data.pattern(a.data);for(var d of a.segments){var e=this.segments.get(d),f=e.offset;f=c.search(f,f+e.size);if(!(0>f)){a.place(f-e.delta,e);a.overlaps=!0;return}}}for(var g of a.segments){c=this.segments.get(g);f=c.offset;d=f+c.size;let h;e=Infinity;for(const a of this.free.tail(f)){const [c,g]=a;if(c>=d)break;f=Math.min(g,d)-c;!(f<b)&&f<e&&(h=c,e=f)}if(null!=h){a.place(h-c.delta,c);return}}console.log(`After filling:\n${this.report(!0)}`);g=a.name?
`${a.name} `:"";console.log(this.segments.get(a.segments[0]));throw Error(`Could not find space for ${b}-byte chunk ${g}in ${a.segments.join(", ")}`);}}resolveSymbols(a){return zb.traverse(a,(b,c)=>{for(;"im"===b.op||"sym"===b.op;)if("im"===b.op){b=b.sym;const d=this.exports.get(b);if(null==d)throw c=q.at(a),Error(`Symbol never exported ${b}${c}`);b=this.symbols[d].expr}else{if(null==b.num)throw Error("Symbol not global");b=this.symbols[b.num].expr}return zb.evaluate(c(b))})}addRawSegment(a){let b=
this.rawSegments.get(a.name);b||this.rawSegments.set(a.name,b=[]);b.push(a)}buildExports(){var a,b;const c=new Map;for(const d of this.symbols){if(!d.export)continue;const e=zb.traverse(d.expr,(a,b)=>this.resolveLink(zb.evaluate(b(a))));if("num"!==e.op)throw Error(`never resolved: ${d.export}`);const f=e.num,g={value:f};null!=(null===(a=e.meta)||void 0===a?void 0:a.offset)&&null!=e.meta.org&&(g.offset=e.meta.offset+f-e.meta.org);null!=(null===(b=e.meta)||void 0===b?void 0:b.bank)&&(g.bank=e.meta.bank);
c.set(d.export,g)}return c}report(a){a=void 0===a?!1:a;var b;let c="";for(var d of this.free){const [a,b]=d;c+=`Free: ${a.toString(16)}..${b.toString(16)}: ${b-a} bytes\n`}if(a)for(const e of this.placed){const [f,g]=e;a=null!==(b=g.name)&&void 0!==b?b:`Chunk ${g.index}`;d=g.offset+g.size;c+=`${f.toString(16).padStart(5,"0")} .. ${d.toString(16).padStart(5,"0")}: ${a} (${d-f} bytes)\n`}return c}};class Lc{constructor(a,b){this.params=a;this.production=b}static from(a,b){var c;if(!q.eq(a[0],q.MACRO))throw Error("invalid");if("ident"!==(null===(c=a[1])||void 0===c?void 0:c.token))throw Error("invalid");c=q.identsFromCList(a.slice(2));const d=[];let e;for(;e=b.next();){if(q.eq(e[0],q.ENDMACRO)||q.eq(e[0],q.ENDMAC))return new Lc(c,d);d.push(e)}throw Error(`EOF looking for .endmacro: ${q.nameAt(a[1])}`);}expand(a,b){let c=1;const d=new Map,e=[];for(const b of this.params){const e=q.findComma(a,
c);let f=a.slice(c,e);c=e+1;1===f.length&&"grp"===f[0].token&&(f=f[0].inner);d.set(b,f)}if(c<a.length)throw Error(`Too many macro parameters: ${q.nameAt(a[c])}`);const f=new Map;for(const c of this.production){var g=function(b){const c=[];for(const e of b){if("ident"===e.token){if(b=d.get(e.str)){c.push(...b);continue}if(b=f.get(e.str)){c.push({token:"ident",str:b});continue}}else if("grp"===e.token){c.push({token:"grp",inner:g(e.inner)});continue}b=e.source&&a[0].source?Object.assign({},e.source,
{parent:a[0].source}):e.source||a[0].source;c.push(b?Object.assign({},e,{source:b}):e)}return c};if(q.eq(c[0],q.LOCAL))for(const a of q.identsFromCList(c.slice(1)))f.set(a,`${a}@${b.next()}`);e.push(g(c))}return e}};const Mc=new WeakMap;function Nc(a){let b=Mc.get(a);b||Mc.set(a,b=((a)=>({next:()=>a++}))(0));return b}
class Oc extends cb.Abstract{constructor(a,b,c){super();this.stream=a;this.env=b;this.repeats=[];this.runDirectives={".define":(a)=>this.parseDefine(a),".undefine":(a)=>this.parseUndefine(a),".else":([a])=>Pc(".if",a),".elseif":([a])=>Pc(".if",a),".endif":([a])=>Pc(".if",a),".endmac":([a])=>Pc(".macro",a),".endmacro":([a])=>Pc(".macro",a),".endrep":(a)=>this.parseEndRepeat(a),".endrepeat":(a)=>this.parseEndRepeat(a),".exitmacro":([,a])=>{if(a)throw Error(`garbage at end of line: ${q.nameAt(a)}`);
this.stream.exit()},".if":([a,...b])=>this.parseIf(!!this.evaluateConst(Qc(b,a))),".ifdef":([a,...b])=>this.parseIf(this.macros.has(Rc(b,a))),".ifndef":([a,...b])=>this.parseIf(!this.macros.has(Rc(b,a))),".ifblank":([,...a])=>this.parseIf(!a.length),".ifnblank":([,...a])=>this.parseIf(!!a.length),".ifref":([a,...b])=>this.parseIf(this.env.referencedSymbol(Rc(b,a))),".ifnref":([a,...b])=>this.parseIf(!this.env.referencedSymbol(Rc(b,a))),".ifsym":([a,...b])=>this.parseIf(this.env.definedSymbol(Rc(b,
a))),".ifnsym":([a,...b])=>this.parseIf(!this.env.definedSymbol(Rc(b,a))),".ifconst":([a,...b])=>this.parseIf(this.env.constantSymbol(Rc(b,a))),".ifnconst":([a,...b])=>this.parseIf(!this.env.constantSymbol(Rc(b,a))),".macro":(a)=>this.parseMacro(a),".repeat":(a)=>this.parseRepeat(a)};this.macros=c?c.macros:new Map}*pump(){const a=this.readLine();if(null==a)return void(yield a);for(;a.length;){var b=a[0];switch(b.token){case "ident":if(q.eq(a[1],q.COLON)){yield a.splice(0,2);break}this.tryExpandMacro(a)||
(yield a);return;case "cs":this.tryRunDirective(a)||(yield a);return;case "op":if(/^[-+]+$/.test(b.str)){b=[b];const c=a[1];c&&q.eq(c,q.COLON)?(b.push(c),a.splice(0,2)):(b.push({token:"op",str:":"}),a.splice(0,1));yield b;break}else if(":"===b.str){yield a.splice(0,1);break}default:throw Error(`Unexpected: ${q.nameAt(a[0])}`);}}}readLine(){const a=this.stream.next();return null==a?a:this.expandLine(a)}expandLine(a,b=0){const c=a[0];let d=0,e=0;for(;b<a.length;){if(b>e)e=b,d=0;else if(100<d++)throw Error(`Maximum expansion depth reached: ${a.map(q.name).join(" ")}${q.at(c)}`);
b=this.expandToken(a,b)}return a}expandToken(a,b){var c=a[b];if("ident"===c.token){if(c=this.macros.get(c.str),c instanceof $b&&(a=c.expand(a,b)))return a.length&&this.stream.unshift(...a),b}else if("cs"===c.token)return this.expandDirective(c.str,a,b);return b+1}tryExpandMacro(a){var [b]=a;if("ident"!==b.token)throw Error("impossible");b=this.macros.get(b.str);if(!(b instanceof Lc))return!1;a=b.expand(a,Nc(this.env));this.stream.enter();this.stream.unshift(...a);return!0}expandDirective(a,b,c){switch(a){case ".define":case ".ifdef":case ".ifndef":case ".undefine":return this.skipIdentifier(b,
c);case ".skip":return this.skip(b,c);case ".noexpand":return this.noexpand(b,c);case ".tcount":return this.parseArgs(b,c,1,this.tcount);case ".ident":return this.parseArgs(b,c,1,this.ident);case ".string":return this.parseArgs(b,c,1,this.string);case ".concat":return this.parseArgs(b,c,0,this.concat);case ".sprintf":return this.parseArgs(b,c,0,this.sprintf);case ".cond":return this.parseArgs(b,c,0,this.cond);case ".def":case ".defined":return this.parseArgs(b,c,1,this.defined);case ".definedsymbol":return this.parseArgs(b,
c,1,this.definedSymbol);case ".constantsymbol":return this.parseArgs(b,c,1,this.constantSymbol);case ".referencedsymbol":return this.parseArgs(b,c,1,this.referencedSymbol)}return c+1}skip(a,b){a.splice(b,1);const c=a[b];"grp"===(null===c||void 0===c?void 0:c.token)?this.expandToken(c.inner,0):this.expandToken(a,b+1);return b}noexpand(a,b){const c=a[b+1];"grp"===c.token?(a.splice(b,2,...c.inner),b+=c.inner.length-1):a.splice(b,1);return b+1}parseArgs(a,b,c,d){const e=a[b];q.expect(q.LP,a[b+1],e);const f=
q.findBalanced(a,b+1),g=q.parseArgList(a,b+2,f).map((a)=>{1===a.length&&"grp"===a[0].token&&(a=a[0].inner);return this.expandLine(a)});if(c&&g.length!==c)throw Error(`Expected ${c} parameters: ${q.nameAt(e)}`);c=d.call(this,e,...g);a.splice(b,f+1-b,...c);return b}tcount(a,b){return[{token:"num",num:q.count(b),source:a.source}]}ident(a,b){a=q.expectString(b[0],a);q.expectEol(b[1],"a single token");return[{token:"ident",str:a,source:b[0].source}]}string(a,b){a=q.expectIdentifier(b[0],a);q.expectEol(b[1],
"a single token");return[{token:"str",str:a,source:b[0].source}]}concat(a,...b){return[{token:"str",str:b.map((a)=>{const b=q.expectString(a[0]);q.expectEol(a[1],"a single string");return b}).join(""),source:a.source}]}sprintf(a,b){q.expectString(b[0],a);q.expectEol(b[1],"a single format string");throw Error("unimplemented");}cond(){throw Error("unimplemented");}defined(a,b){a=q.expectIdentifier(b[0],a);q.expectEol(b[1],"a single identifier");return[{token:"num",num:this.macros.has(a)?1:0}]}definedSymbol(a,
b){a=q.expectIdentifier(b[0],a);q.expectEol(b[1],"a single identifier");return[{token:"num",num:this.env.definedSymbol(a)?1:0}]}constantSymbol(a,b){a=q.expectIdentifier(b[0],a);q.expectEol(b[1],"a single identifier");return[{token:"num",num:this.env.constantSymbol(a)?1:0}]}referencedSymbol(a,b){a=q.expectIdentifier(b[0],a);q.expectEol(b[1],"a single identifier");return[{token:"num",num:this.env.referencedSymbol(a)?1:0}]}skipIdentifier(a,b){var c;return"ident"===(null===(c=a[b+1])||void 0===c?void 0:
c.token)?b+2:b+1}tryRunDirective(a){var b=a[0];if("cs"!==b.token)throw Error("impossible");b=this.runDirectives[b.str];if(!b)return!1;b(a);return!0}evaluateConst(a){var b;a=zb.traversePost(a,zb.evaluate);if("num"===a.op&&(null===(b=a.meta)||void 0===b||!b.rel))return a.num;a=q.at(a);throw Error(`Expected a constant${a}`);}parseDefine(a){const b=q.expectIdentifier(a[1],a[0]);a=$b.from(a);const c=this.macros.get(b);if(c instanceof $b)c.append(a);else{if(c)throw Error(`Already defined: ${b}`);this.macros.set(b,
a)}}parseUndefine(a){const [b,c,d]=a;a=q.expectIdentifier(c,b);q.expectEol(d);if(!this.macros.has(a))throw Error(`Not defined: ${q.nameAt(c)}`);this.macros.delete(a)}parseMacro(a){const b=q.expectIdentifier(a[1],a[0]);a=Lc.from(a,this.stream);if(this.macros.get(b))throw Error(`Already defined: ${b}`);this.macros.set(b,a)}parseRepeat(a){var b;const [c,d]=zb.parse(a,1);var e=a[1]||a[0];if(!c)throw Error(`Expected expression: ${q.nameAt(e)}`);e=this.evaluateConst(c);if(null==e)throw Error(`Expected a constant${q.at(c)}`);
let f;if(d<a.length){if(!q.eq(a[d],q.COMMA))throw Error(`Expected comma: ${q.nameAt(a[d])}`);f=q.expectIdentifier(a[d+1]);q.expectEol(a[d+2])}const g=[];let h=1;for(;0<h;){if(null!==(b=this.stream.next())&&void 0!==b)a=b;else throw Error(".repeat with no .endrep");q.eq(a[0],q.REPEAT)&&h++;q.eq(a[0],q.ENDREPEAT)&&h--;q.eq(a[0],q.ENDREP)&&h--;g.push(a)}this.repeats.push([g,e,-1,f]);this.parseEndRepeat(a)}parseEndRepeat(a){q.expectEol(a[1]);const b=this.repeats.pop();if(!b)throw Error(`.endrep with no .repeat${q.at(a[0])}`);
++b[2]>=b[1]||(this.repeats.push(b),this.stream.unshift(...b[0].map((a)=>a.map((a)=>{if("ident"!==a.token||a.str!==b[3])return a;const c={token:"num",num:b[2]};a.source&&(c.source=a.source);return c}))))}parseIf(a){let b=1,c=!1;const d=[];for(;0<b;){const e=this.stream.next();if(!e)throw Error("EOF looking for .endif");const f=e[0];if(q.eq(f,q.ENDIF)){if(b--,!b)break}else if("cs"===f.token&&f.str.startsWith(".if"))b++;else if(1===b&&!c)if(a&&(q.eq(f,q.ELSE)||q.eq(f,q.ELSEIF))){a=!1;c=!0;continue}else if(q.eq(f,
q.ELSEIF)){a=!!this.evaluateConst(Qc(e.slice(1),f));continue}else if(q.eq(f,q.ELSE)){a=!0;continue}a&&d.push(e)}this.stream.unshift(...d)}}function Rc(a,b){a=Qc(a,b);return zb.identifier(a)}function Qc(a,b){if(!a.length){if(!b)throw Error("Expected expression");throw Error(`Expected expression: ${q.nameAt(b)}`);}return zb.parseOnly(a)}function Pc(a,b){throw Error(`${q.name(b)} with no ${a}${q.at(b)}`);};class Sc{constructor(){this.stack=[]}next(){for(;this.stack.length;){const [a,b]=this.stack[this.stack.length-1];if(b.length)return b.pop();const c=null===a||void 0===a?void 0:a.next();if(c)return c;this.stack.pop()}}unshift(...a){if(!this.stack.length)throw Error("Cannot unshift after EOF");const b=this.stack[this.stack.length-1][1];for(let c=a.length-1;0<=c;c--)b.push(a[c])}enter(a){const b=[void 0,[]];a&&(b[0]=a);this.stack.push(b);if(100<this.stack.length)throw Error("Stack overflow");}exit(){this.stack.pop()}}
;const Tc=()=>"",Uc=(a)=>!0===a?!1:a;class cd{constructor(a,b){this.flag=a;this.opts=b;cd.flags.set(a,this)}static all(){return[...this.flags.values()]}}cd.flags=new Map;
class dd{constructor(a,b,c,d){this.name=b;this.description=c;this.flags=d.map((a)=>a instanceof cd?[a,!0]:a);a.presets.set(b.toLowerCase().replace(/[^a-z]/g,""),this)}static all(){ed.instance||(ed.instance=new ed);return[...ed.instance.presets.values()]}get flagString(){null==this._flagString&&(this._flagString=String(new fd(`@${this.name}`)));return this._flagString}}
class ed{constructor(){this.presets=new Map;this.Casual=new dd(this,"Casual","\n      Basic flags for a relatively easy playthrough.  This is a good\n      place to start.",[gd.PreserveUniqueChecks,gd.NoShuffleMimics,gd.DecreaseEnemyDamage,gd.GuaranteeRefresh,gd.GuaranteeStartingSword,gd.ExperienceScalesFaster,hd.NoThunderSwordWarp,id.Shops,id.Dyna,[id.Maps,"!"],[id.WildWarp,"!"],jd.SpoilerLog]);this.Classic=new dd(this,"Classic","\n      Provides a relatively quick playthough with a reasonable amount of\n      challenge.  Similar to older versions.",
[gd.GuaranteeStartingSword,kd.StatueGlitch,[hd.NoThunderSwordWarp,"!"],[id.Maps,"!"],jd.SpoilerLog]);this.Standard=new dd(this,"Standard","\n      Well-balanced, standard race flags.",[ld.RandomizeWeaknesses,hd.StoryMode,jd.SpoilerLog]);this.NoBowMode=new dd(this,"No Bow Mode","\n      The tower is open from the start, as soon as you're ready for it.",[ld.RandomizeWeaknesses,ld.TowerRobots,md.MaxScalingInTower,hd.NoBowMode,jd.SpoilerLog]);this.Advanced=new dd(this,"Advanced","\n      A balanced randomization with quite a bit more difficulty.",
[kd.GhettoFlight,kd.MtSabreRequirementSkip,kd.StatueGlitch,[kd.SwordChargeGlitch,"!"],nd.Barrier,nd.BattleMagic,nd.GasMask,md.MaxScalingInTower,ld.RandomizeWeaknesses,ld.TowerRobots,hd.OrbsNotRequired,hd.StoryMode,r.RandomizeMaps,r.RandomizeTrades,r.RandomizeWallElements,r.UnidentifiedKeyItems,jd.SpoilerLog]);this.WildWarp=new dd(this,"Wild Warp","\n      Significantly opens up the game right from the start with wild\n      warp in logic.",[gd.GuaranteeRefresh,r.RandomizeWildWarp,ld.RandomizeWeaknesses,
ld.TowerRobots,hd.OrbsNotRequired,hd.StoryMode,jd.SpoilerLog]);this.Hardcore=new dd(this,"Hardcore","\n      Not for the faint of heart.  Good luck.",[nd.Barrier,nd.BattleMagic,md.ExperienceScalesSlower,md.MaxScalingInTower,md.Permadeath,hd.OrbsNotRequired,hd.StoryMode,r.RandomizeMaps,r.RandomizeTrades,r.RandomizeWallElements,r.UnidentifiedKeyItems]);this.FullStupid=new dd(this,"The Full Stupid","\n      Nobody has ever completed this.  Be sure to record this because\n      pics or it didn't happen.",
[nd.Barrier,nd.BattleMagic,md.Blackout,md.ExperienceScalesSlower,md.MaxScalingInTower,md.Permadeath,ld.RandomizeWeaknesses,ld.TowerRobots,hd.OrbsNotRequired,hd.StoryMode,r.RandomizeMaps,r.RandomizeTrades,r.RandomizeWallElements,r.ShuffleGoaFloors,r.UnidentifiedKeyItems]);this.Random=new dd(this,"Truly Random","\n      Even the options are random.",[[r.RandomizeMaps,"?"],[r.RandomizeTrades,"?"],[r.UnidentifiedKeyItems,"?"],[r.RandomizeWallElements,"?"],[r.ShuffleGoaFloors,"?"],[r.RandomizeSpriteColors,
"?"],[r.RandomizeWildWarp,"?"],[hd.OrbsNotRequired,"?"],[hd.NoBowMode,"?"],[hd.StoryMode,"?"],[hd.VanillaDolphin,"?"],[hd.NoThunderSwordWarp,"?"],[kd.RageSkip,"?"],[kd.TriggerSkip,"?"],[kd.StatueGlitch,"?"],[kd.GhettoFlight,"?"],[kd.SwordChargeGlitch,"?"],[kd.MtSabreRequirementSkip,"?"],[od.RandomizeMusic,"?"],[od.RandomizeMapColors,"?"],[ld.RandomizeWeaknesses,"?"],[ld.TowerRobots,"?"],[gd.NoShuffleMimics,"?"],[gd.PreserveUniqueChecks,"?"],[nd.Barrier,"?"],[nd.BattleMagic,"?"],[nd.GasMask,"?"],[id.Dyna,
"?"],[id.BonusItems,"?"],[id.Maps,"?"],jd.SpoilerLog])}static get(a){this.instance||(this.instance=new ed);return this.instance.presets.get(a.toLowerCase().replace(/[^a-z]/g,""))}}class t{constructor(){this.flags=new Map}static all(){return[...this.sections]}static flag(a,b){t.sections.add(this.instance||(this.instance=new this));b=new cd(a,b);if(!a.startsWith(this.instance.prefix))throw Error("bad flag");this.instance.flags.set(a,b);return b}}t.sections=new Set;
class r extends t{constructor(){super(...arguments);this.prefix="W";this.name="World"}}r.RandomizeMaps=t.flag("Wm",{name:"Randomize maps",text:"Individual maps are randomized.  For now this is only a subset of\n           possible maps.  A randomized map will have all the same features\n           (exits, chests, NPCs, etc) except things are moved around.",hard:!0});
r.RandomizeTrades=t.flag("Wt",{name:"Randomize trade-in items",text:"Items expected by various NPCs will be shuffled: specifically,\n           Statue of Onyx, Kirisa Plant, Love Pendant, Ivory Statue, Fog\n           Lamp, and Flute of Lime (for Akahana).  Rage will expect a\n           random sword, and Tornel will expect a random bracelet.",hard:!0});
r.UnidentifiedKeyItems=t.flag("Wu",{name:"Unidentified key items",text:"Item names will be generic and effects will be shuffled.  This\n           includes keys, flutes, lamps, and statues.",hard:!0});r.RandomizeWallElements=t.flag("We",{name:"Randomize elements to break walls",text:'Walls will require a randomized element to break.  Normal rock and\n           ice walls will indicate the required element by the color (light\n           grey or yellow for wind, blue for fire, bright orange ("embers") for\n           water, or dark grey ("steel") for thunder.  The element to break\n           these walls is the same throughout an area.  Iron walls require a\n           one-off random element, with no visual cue, and two walls in the\n           same area may have different requirements.'});
r.ShuffleGoaFloors=t.flag("Wg",{name:"Shuffle Goa fortress floors",text:"The four areas of Goa fortress will appear in a random order."});r.RandomizeSpriteColors=t.flag("Ws",{name:"Randomize sprite colors",text:"Monsters and NPCs will have different colors.  This is not an\n           optional flag because it affects what monsters can be grouped\n           together."});
r.RandomizeWildWarp=t.flag("Ww",{name:"Randomize wild warp",text:"Wild warp will go to Mezame Shrine and 15 other random locations.\n           These locations will be considered in-logic.",excludes:["Vw"]});class hd extends t{constructor(){super(...arguments);this.prefix="R";this.name="Routing"}}hd.StoryMode=t.flag("Rs",{name:"Story Mode",text:"Draygon 2 won't spawn unless you have all four swords and have\n           defeated all major bosses of the tetrarchy."});
hd.NoBowMode=t.flag("Rb",{name:"No Bow mode",text:"No items are required to finish the game.  An exit is added from\n           Mezame shrine directly to the Draygon 2 fight (and the normal entrance\n           is removed).  Draygon 2 spawns automatically with no Bow of Truth."});hd.OrbsNotRequired=t.flag("Ro",{name:"Orbs not required to break walls",text:"Walls can be broken and bridges formed with level 1 shots."});
hd.NoThunderSwordWarp=t.flag("Rt",{name:"No Sword of Thunder warp",text:'Normally when acquiring the thunder sword, the player is instantly\n           warped to a random town.  This flag disables the warp.  If set as\n           "R!t", then the warp will always go to Shyron, like in vanilla.',modes:"!"});hd.VanillaDolphin=t.flag("Rd",{name:"Vanilla Dolphin interactions",text:"By default, the randomizer changes a number of dolphin and boat\n           interactions: (1) healing the dolphin and having the Shell Flute\n           is no longer required before the fisherman spawns: instead, he\n           will spawn as soon as you have the item he wants; (2) talking to\n           Kensu in the beach cabin is no longer required for the Shell Flute\n           to work: instead, the Shell Flute will always work, and Kensu will\n           spawn after the Fog Lamp is turned in and will give a key item\n           check.  This flag restores the vanilla interaction where healing\n           and shell flute are required."});
class kd extends t{constructor(){super(...arguments);this.prefix="G";this.name="Glitches";this.description="\n      By default, the randomizer disables all known glitches (except ghetto\n      flight).  These flags selectively re-enable certain glitches.  Most of\n      these flags have two modes: normally enabling a glitch will add it as\n      possibly required by logic, but clicking a second time will add a '!'\n      and enable the glitch outside of logic (e.g. \"G!c\")."}}
kd.GhettoFlight=t.flag("Gf",{name:"Ghetto flight",text:"Ghetto flight allows using Dolphin and Rabbit Boots to fly up the\n           waterfalls in the Angry Sea (without calming the whirlpools).\n           This is done by swimming up to a diagonal beach and jumping\n           in a different direction immediately before disembarking."});
kd.StatueGlitch=t.flag("Gs",{name:"Statue glitch",text:"Statue glitch allows getting behind statues that block certain\n           entrances: the guards in Portoa, Amazones, Oak, Goa, and Shyron,\n           as well as the statues in the Waterfall Cave.  It is done by\n           approaching the statue from the top right and holding down and\n           left on the controller while mashing B.",modes:"!"});
kd.MtSabreRequirementSkip=t.flag("Gn",{name:"Mt Sabre requirements skip",text:"Entering Mt Sabre North normally requires (1) having Teleport,\n           and (2) talking to the rabbit in Leaf after the abduction (via\n           Telepathy).  Both of these requirements can be skipped: first by\n           flying over the river in Cordel plain rather than crossing the\n           bridge, and then by threading the needle between the hitboxes in\n           Mt Sabre North.",modes:"!"});
kd.StatueGauntletSkip=t.flag("Gg",{name:"Statue guantlet skip",text:"The shooting statues in front of Goa and Stxy normally require\n           Barrier to pass safely.  With this flag, Flight can also be used\n           by flying around the edge of the statue.",modes:"!"});
kd.SwordChargeGlitch=t.flag("Gc",{name:"Sword charge glitch",text:"Sword charge glitch allows charging one sword to the level of\n           another sword by equipping the higher-level sword, re-entering\n           the menu, changing to the lower-level sword without exiting the\n           menu, creating a hard save, resetting, and then continuing.",hard:!0,modes:"!"});
kd.TriggerSkip=t.flag("Gt",{name:"Trigger skip",text:"A wide variety of triggers and exit squares can be skipped by\n           using an invalid item every frame while walking.  This allows\n           bypassing both Mt Sabre entrance triggers, the Evil Spirit Island\n           entrance trigger, triggers for guards to move, slopes, and seamless\n           map transitions.",hard:!0,modes:"!"});
kd.RageSkip=t.flag("Gr",{name:"Rage skip",text:"Rage can be skipped by damage-boosting diagonally into the Lime\n           Tree Lake screen.  This provides access to the area beyond the\n           lake if flight or bridges are available.",hard:!0,modes:"!"});
class od extends t{constructor(){super(...arguments);this.prefix="A";this.name="Aesthetics";this.description='\n      These flags don\'t directly affect gameplay or shuffling, but they do\n      affect the experience significantly enough that there are three modes\n      for each: "off", "optional" (no exclamation point), and "required"\n      (exclamation point).  The first two are equivalent for seed generation\n      purposes, so that you can play the same seed with either setting.\n      Setting it to "!" will change the seed.'}}
od.RandomizeMusic=t.flag("Am",{name:"Randomize background music",modes:"!",optional:Uc});od.NoMusic=t.flag("As",{name:"No background music",optional:Tc});od.RandomizeMapColors=t.flag("Ac",{name:"Randomize map colors",modes:"!",optional:Uc});class ld extends t{constructor(){super(...arguments);this.prefix="M";this.name="Monsters"}}ld.RandomizeWeaknesses=t.flag("Me",{name:"Randomize monster weaknesses",text:"Monster and boss elemental weaknesses are shuffled."});
ld.TowerRobots=t.flag("Mt",{name:"Shuffle tower robots",text:"Tower robots will be shuffled into the normal pool.  At some\n           point, normal monsters may be shuffled into the tower as well.",hard:!0});class gd extends t{constructor(){super(...arguments);this.prefix="E";this.name="Easy Mode";this.description="\n      The following options make parts of the game easier."}}gd.NoShuffleMimics=t.flag("Et",{name:"Don't shuffle mimics.",text:"Mimics will be in their vanilla locations."});
gd.PreserveUniqueChecks=t.flag("Eu",{name:"Keep unique items and consumables separate",text:"Normally all items and mimics are shuffled into a single pool and\n           distributed from there.  If this flag is set, unique items\n           (specifically, anything that cannot be sold) will only be found in\n           either (a) checks that held unique items in vanilla, or (b) boss\n           drops.  Chests containing consumables in vanilla may be safely\n           ignored, but chests containing unique items in vanilla may still\n           end up with non-unique items because of bosses like Vampire 2 that\n           drop consumables.  If mimics are shuffled, they will only be in\n           consumable locations."});
gd.DecreaseEnemyDamage=t.flag("Ed",{name:"Decrease enemy damage",text:"Enemy attack power will be significantly decreased in the early game\n           (by a factor of 3).  The gap will narrow in the mid-game and eventually\n           phase out at scaling level 40."});gd.GuaranteeStartingSword=t.flag("Es",{name:"Guarantee starting sword",text:"The Leaf elder is guaranteed to give a sword.  It will not be\n           required to deal with any enemies before finding the first sword."});
gd.GuaranteeRefresh=t.flag("Er",{name:"Guarantee refresh",text:"Guarantees the Refresh spell will be available before fighting\n           Tetrarchs."});gd.ExperienceScalesFaster=t.flag("Ex",{name:"Experience scales faster",text:'Less grinding will be required to "keep up" with the game difficulty.',excludes:["Hx"]});class nd extends t{constructor(){super(...arguments);this.prefix="N";this.name="No guarantees";this.description="\n      Removes various guarantees from the logic."}}
nd.BattleMagic=t.flag("Nw",{name:"Battle magic not guaranteed",text:"Normally, the logic will guarantee that level 3 sword charges are\n           available before fighting the tetrarchs (with the exception of Karmine,\n           who only requires level 2).  This disables that check.",hard:!0});
nd.MatchingSword=t.flag("Ns",{name:"Matching sword not guaranteed",text:'Player may be required to fight bosses with the wrong sword, which\n           may require using "tink strats" dealing 1 damage per hit.',hard:!0});nd.Barrier=t.flag("Nb",{name:"Barrier not guaranteed",text:"Normally, the logic will guarantee Barrier (or else refresh and shield\n           ring) before entering Stxy, the Fortress, or fighting Karmine.  This\n           disables that check.",hard:!0});
nd.GasMask=t.flag("Ng",{name:"Gas mask not guaranteed",text:"The logic will not guarantee gas mask before needing to enter the swamp.\n           Gas mask is still guaranteed to kill the insect.",hard:!0});class md extends t{constructor(){super(...arguments);this.prefix="H";this.name="Hard mode"}}
md.NoBuffMedicalHerb=t.flag("Hm",{name:"Don't buff medical herb or fruit of power",text:"Medical Herb is not buffed to heal 80 damage, which is helpful to make\n           up for cases where Refresh is unavailable early.  Fruit of Power is not\n           buffed to restore 56 MP.",hard:!0});md.MaxScalingInTower=t.flag("Ht",{name:"Max scaling level in tower",text:"Enemies in the tower spawn at max scaling level.",hard:!0});
md.ExperienceScalesSlower=t.flag("Hx",{name:"Experience scales slower",text:'More grinding will be required to "keep up" with the difficulty.',excludes:["Ex"],hard:!0});md.ChargeShotsOnly=t.flag("Hc",{name:"Charge shots only",text:"Stabbing is completely ineffective.  Only charged shots work.",hard:!0});md.Blackout=t.flag("Hz",{name:"Blackout",text:"All caves and fortresses are permanently dark.",hard:!0});
md.Permadeath=t.flag("Hh",{name:"Permadeath",text:"Hardcore mode: checkpoints and saves are removed.",hard:!0});class id extends t{constructor(){super(...arguments);this.name="Vanilla";this.prefix="V";this.description="\n      Options to restore vanilla behavior changed by default."}}id.Dyna=t.flag("Vd",{name:"Don't buff Dyna",text:"By default, we makes the Dyna fight a bit more of a challenge.\n           Side pods will fire significantly more.  The safe spot has been\n           removed.  The revenge beams pass through barrier.  Side pods can\n           now be killed.  This flag prevents that change."});
id.BonusItems=t.flag("Vb",{name:"Don't buff bonus items",text:"Leather Boots are changed to Speed Boots, which increase player walking\n           speed (this allows climbing up the slope to access the Tornado Bracelet\n           chest, which is taken into consideration by the logic).  Deo's pendant\n           restores MP while moving.  Rabbit boots enable sword charging up to\n           level 2 while walking (level 3 still requires being stationary, so as\n           to prevent wasting tons of magic)."});
id.Maps=t.flag("Vm",{name:"Vanilla maps",text:'Normally the randomizer adds a new "East Cave" to Valley of Wind,\n           borrowed from the GBC version of the game.  This cave contains two\n           chests (one considered a key item) on the upper floor and exits to\n           two random areas (chosen between Lime Tree Valley, Cordel Plain,\n           Goa Valley, or Desert 2; the quicksand is removed from the entrances\n           to Pyramid and Crypt), one unblocked on the lower floor, and one\n           down the stairs and behind a rock wall from the upper floor.  This\n           flag prevents adding that cave.  If set as "V!m" then a direct path\n           will instead be added between Valley of Wind and Lime Tree Valley\n           (as in earlier versions of the randomizer).',
modes:"!"});id.Shops=t.flag("Vs",{name:"Vanilla shops",text:"By default, we disable shop glitch, shuffle shop contents, and tie\n           the prices to the scaling level (item shops and inns increase by a\n           factor of 2 every 10 scaling levels, armor shops decrease by a\n           factor of 2 every 12 scaling levels).  This flag prevents all of\n           these changes, restoring shops to be completely vanilla."});
id.WildWarp=t.flag("Vw",{name:"Vanilla wild warp",text:"By default, Wild Warp is nerfed to only return to Mezame Shrine.\n           This flag restores it to work like normal.  Note that this will put\n           all wild warp locations in logic unless the flag is set as (V!w).",modes:"!"});
class Bd extends t{constructor(){super(...arguments);this.prefix="Q";this.name="Quality of Life";this.description="\n      The following quality-of-life flags turn <i>off</i> improvements that\n      are normally on by default.  They are optional and will not affect the\n      seed generation.  They may be toggled freely in race mode."}}
Bd.NoAutoEquip=t.flag("Qa",{name:"Don't automatically equip orbs and bracelets",text:"Prevents adding a quality-of-life improvement to automatically equip\n           the corresponding orb/bracelet whenever changing swords.",optional:Tc});
Bd.NoControllerShortcuts=t.flag("Qc",{name:"Disable controller shortcuts",text:"By default, we disable second controller input and instead enable\n           some new shortcuts on controller 1: Start+A+B for wild warp, and\n           Select+B to quickly change swords.  To support this, the action of\n           the start and select buttons is changed slightly.  This flag\n           disables this change and retains normal behavior.",optional:Tc});
class jd extends t{constructor(){super(...arguments);this.prefix="D";this.name="Debug Mode";this.description="\n      These options are helpful for exploring or debugging.  Note that,\n      while they do not directly affect any randomization, they\n      <i>do</i> factor into the seed to prevent cheating, and they\n      will remove the option to generate a seed for racing."}}jd.SpoilerLog=t.flag("Ds",{name:"Generate a spoiler log",text:"Note: <b>this will change the placement of items</b> compared to a\n           seed generated without this flag turned on."});
jd.TrainerMode=t.flag("Dt",{name:"Trainer mode",text:"Installs a trainer for practicing certain parts of the game.\n           At the start of the game, the player will have all swords, basic\n           armors and shields, all worn items and magics, a selection of\n           consumables, bow of truth, maximum cash, all warp points activated,\n           and the Shyron massacre will have been triggered.  Wild warp is\n           reconfigured to provide easy access to all bosses.  Additionally,\n           the following button combinations are recognized:<ul>\n             <li>Start+Up: increase player level\n             <li>Start+Down: increase scaling level\n             <li>Start+Left: get all balls\n             <li>Start+Right: get all bracelets\n             <li>Start+B+Down: get a full set of consumable items\n             <li>Start+B+Left: get all advanced armors\n             <li>Start+B+Right: get all advanced shields\n           </ul>"});
jd.NeverDie=t.flag("Di",{name:"Player never dies"});
class fd{constructor(a="@Casual"){if("string"!==typeof a){this.flags=new Map;for(const [b,c]of a)this.set(b.flag,c)}else if(a.startsWith("@")){var b=ed.get(a.substring(1));if(!b)throw new ta(`Unknown preset: ${a}`);this.flags=new Map(b.flags)}else{this.flags=new Map;a=a.replace(/[^A-Za-z0-9!?]/g,"");b=/([A-Z])([a-z0-9!?]+)/g;for(var c;c=b.exec(a);){const [,a,b]=c,f=/([!?]|^)([a-z0-9]+)/g;for(;c=f.exec(b);){const [,b,d]=c;for(const c of d)this.set(a+c,b||!0)}}}}filterOptional(){return new fd(new Map([...this.flags].map(([a,
b])=>[a,a.opts.optional?a.opts.optional(b):b])))}filterRandom(a){return new fd(new Map([...this.flags].map(([b,c])=>{c="?"!==c?c:a.pick([!0,!1,...b.opts.modes||""]);return[b,c]})))}toString(){var a=new n(()=>new n(()=>[]));for(const [b,d]of this.flags){if(2!==b.flag.length)throw Error(`Bad flag ${b.flag}`);d&&a.get(b.flag[0]).get(!0===d?"":d).push(b.flag[1])}const b=[];for(const [c,d]of a.sortedEntries()){a=c;for(const [b,c]of d)a+=b+c.sort().join("");b.push(a)}return b.join(" ")}toggle(a){const b=
cd.flags.get(a);if(!b)return console.error(`Bad flag: ${a}`),!1;a=this.flags.get(b)||!1;const c=[!1,!0,...b.opts.modes||"","?",!1],d=c.indexOf(a);if(0>d)throw Error(`Bad current mode ${a}`);a=c[d+1];this.flags.set(b,a);return a}set(a,b){var c;const d=cd.flags.get(a);if(d){if(b)if(!0===b||"?"===b||(null===(c=d.opts.modes)||void 0===c?0:c.includes(b)))this.flags.set(d,b);else{console.error(`Bad flag mode: ${a[0]}${b}${a.substring(1)}`);return}else this.flags.delete(d);for(const a of d.opts.excludes||
[])this.flags.delete(cd.flags.get(a))}else console.error(`Bad flag: ${a}`)}check(a,...b){a=a instanceof cd?a:cd.flags.get(a);b.length||b.push(!0);return b.includes(a&&this.flags.get(a)||!1)}get(a){return(a=a instanceof cd?a:cd.flags.get(a))&&this.flags.get(a)||!1}preserveUniqueChecks(){return this.check(gd.PreserveUniqueChecks)}shuffleMimics(){return this.check(gd.NoShuffleMimics,!1)}buffDeosPendant(){return this.check(id.BonusItems,!1)}changeGasMaskToHazmatSuit(){return this.check(id.BonusItems,
!1)}slowDownTornado(){return this.check(id.BonusItems,!1)}leatherBootsGiveSpeed(){return this.check(id.BonusItems,!1)}rabbitBootsChargeWhileWalking(){return this.check(id.BonusItems,!1)}shuffleSpritePalettes(){return this.check(r.RandomizeSpriteColors)}shuffleMonsters(){return!0}shuffleShops(){return this.check(id.Shops,!1)}bargainHunting(){return this.shuffleShops()}shuffleTowerMonsters(){return this.check(ld.TowerRobots)}shuffleMonsterElements(){return this.check(ld.RandomizeWeaknesses)}shuffleBossElements(){return this.shuffleMonsterElements()}buffMedicalHerb(){return this.check(md.NoBuffMedicalHerb,
!1)}decreaseEnemyDamage(){return this.check(gd.DecreaseEnemyDamage)}trainer(){return this.check(jd.TrainerMode)}neverDie(){return this.check(jd.NeverDie)}chargeShotsOnly(){return this.check(md.ChargeShotsOnly)}barrierRequiresCalmSea(){return!0}connectLimeTreeToLeaf(){return this.check(id.Maps,"!")}addEastCave(){return this.check(id.Maps,!1)}fogLampNotRequired(){return this.check(hd.VanillaDolphin,!1)}storyMode(){return this.check(hd.StoryMode)}noBowMode(){return this.check(hd.NoBowMode)}requireHealedDolphinToRide(){return this.check(hd.VanillaDolphin)}saharaRabbitsRequireTelepathy(){return!0}teleportOnThunderSword(){return this.check(hd.NoThunderSwordWarp,
!1,"!")}randomizeThunderTeleport(){return this.check(hd.NoThunderSwordWarp,!1)}orbsOptional(){return this.check(hd.OrbsNotRequired)}shuffleGoaFloors(){return this.check(r.ShuffleGoaFloors)}randomizeMaps(){return this.check(r.RandomizeMaps)}randomizeTrades(){return this.check(r.RandomizeTrades)}unidentifiedItems(){return this.check(r.UnidentifiedKeyItems)}randomizeWalls(){return this.check(r.RandomizeWallElements)}guaranteeSword(){return this.check(gd.GuaranteeStartingSword)}guaranteeSwordMagic(){return this.check(nd.BattleMagic,
!1)}guaranteeMatchingSword(){return this.check(nd.MatchingSword,!1)}guaranteeGasMask(){return this.check(nd.GasMask,!1)}guaranteeBarrier(){return this.check(nd.Barrier,!1)}guaranteeRefresh(){return this.check(gd.GuaranteeRefresh)}disableSwordChargeGlitch(){return this.check(kd.SwordChargeGlitch,!1)}disableTeleportSkip(){return this.check(kd.MtSabreRequirementSkip,!1)}disableRabbitSkip(){return this.check(kd.MtSabreRequirementSkip,!1)}disableShopGlitch(){return this.check(id.Shops,!1)}disableStatueGlitch(){return this.check(kd.StatueGlitch,
!1)}disableRageSkip(){return this.check(kd.RageSkip,!1)}disableFlightStatueSkip(){return this.check(kd.StatueGauntletSkip,!1)}assumeSwordChargeGlitch(){return this.check(kd.SwordChargeGlitch)}assumeGhettoFlight(){return this.check(kd.GhettoFlight)}assumeTeleportSkip(){return this.check(kd.MtSabreRequirementSkip)}assumeRabbitSkip(){return this.check(kd.MtSabreRequirementSkip)}assumeStatueGlitch(){return this.check(kd.StatueGlitch)}assumeTriggerGlitch(){return this.check(kd.TriggerSkip)}assumeFlightStatueSkip(){return this.check(kd.StatueGauntletSkip)}assumeWildWarp(){return this.check(id.WildWarp,
!0)||this.check(r.RandomizeWildWarp)}assumeRageSkip(){return!1}nerfWildWarp(){return this.check(id.WildWarp,!1)&&this.check(r.RandomizeWildWarp,!1)}allowWildWarp(){return!this.nerfWildWarp()}randomizeWildWarp(){return this.check(r.RandomizeWildWarp,!0)}blackoutMode(){return this.check(md.Blackout)}hardcoreMode(){return this.check(md.Permadeath)}buffDyna(){return!this.check(id.Dyna)}maxScalingInTower(){return this.check(md.MaxScalingInTower)}expScalingFactor(){return this.check(md.ExperienceScalesSlower)?
.25:this.check(gd.ExperienceScalesFaster)?2.5:1}autoEquipBracelet(a){return"early"===a||this.check(Bd.NoAutoEquip,!1)}controllerShortcuts(a){return"early"===a||this.check(Bd.NoControllerShortcuts,!1)}randomizeMusic(a){return this.check(od.RandomizeMusic,"early"===a?"!":!0)}shuffleTilePalettes(a){return this.check(od.RandomizeMapColors,"early"===a?"!":!0)}noMusic(a){return"late"===a&&this.check(od.NoMusic)}};const Cd={of:(...a)=>a.map((a)=>a.uid)};class Dd{constructor(a,b){this.graph=a;this.name=b;this.uid=a.nodes.length;a.nodes.push(this)}get nodeType(){return"Node"}toString(){return`${this.nodeType} ${this.name}`}edges(){return[]}write(){}}
class Ed{constructor(a){this.rom=a;this.nodes=[]}traverse({wanted:a,dfs:b=!1}={}){const c=new sa,d=new Map,e=new Map;for(var f of this.nodes)for(var g of f.edges()){var h=g.join(" ");for(let a=1;a<g.length;a++){const b=g[a];e.has(b)||e.set(b,new Map);e.get(b).set(h,g)}1===g.length&&(h=g[0],d.has(h)||(c.push(h),d.set(h,g)))}a=new Set((a||this.nodes).map((a)=>a instanceof Dd?a.uid:a));for(f=new Map;a.size&&c.length;){g=b?c.pop():c.shift();a.delete(g);a:for(const a of(e.get(g)||f).values())if(g=a[0],
!d.has(g)){for(h=1;h<a.length;h++)if(!d.has(a[h]))continue a;d.set(g,a);c.push(g)}}return{path:[...d.values()].map(([a,...b])=>{const c=(a)=>[this.nodes[a]];return[a,[...c(a)," (",b.map((a)=>c(a).join("").replace(/\s+\(.*\)/,"")).join(", "),")"].join("")]}),seen:d,win:!a.size}}}
class Fd{constructor(a){this.nodes=Array(a).fill(0).map(()=>new Map);this.finalized=Array(a).fill(!1)}addRoute(a){const b=a[0];if(this.finalized[b])throw Error(`Attempted to add a route for finalized node ${b}`);let c=new Set;for(let b=a.length-1;1<=b;b--)c.add(a[b]);for(;;){a=!1;for(var d of c){if(d===b)return[];if(this.finalized[d]){a=this.nodes[d];if(!a.size)return[];c.delete(d);if(1===a.size){for(const b of a.values().next().value)c.add(b);a=!0;break}d=new Map;for(var e of a.values())for(var f of this.addRoute([b,
...c,...e]))d.set(f.label,f);return[...d.values()]}}if(!a)break}e=[...c].sort();c=new Set(e);e=e.join(" ");f=this.nodes[b];if(f.has(e))return[];for(const [a,b]of f){if(Gd(c,b))return[];Gd(b,c)&&f.delete(a)}f.set(e,c);return[{target:b,deps:c,label:`${b}:${e}`}]}finalize(a){if(!this.finalized[a]){this.finalized[a]=!0;for(let b=0;b<this.nodes.length;b++){const c=this.nodes[b];if(c.size)for(const [d,e]of c)if(e.has(a)){const a=this.finalized[b];this.finalized[b]=!1;c.delete(d);this.addRoute([b,...e.values()]);
this.finalized[b]=a}}}}}const Gd=(a,b)=>{if(a.size<b.size)return!1;for(const c of b)if(!a.has(c))return!1;return!0};function Hd(a){return a.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace(/Of/g,"of").replace(/_/g," - ")}function v(a,b=(a)=>a){return Array(a).fill(0).map((a,d)=>b(d))}function Id(a,b,c){return Array.from(a.slice(b,b+c))}function Jd(a){return 128>a?a:a-256}function Kd(a,b,c,d,e=Infinity,f){f||(f=(a)=>a);const g=[];for(;b+c<=e&&a[b]!==d;)g.push(f(a.slice(b,b+c))),b+=c;return g}function Ld(a,b,c=0){return(a[b]|a[b+1]<<8)+c}
function Md(a,b,c){c||(c=(a)=>a);return v(Math.max(0,Math.floor(b.length/a)),(d)=>{var e=c;d*=a;d=b.slice(d,d+a);return e(d)})}function Nd(a){return 65793*(2050*a&139536|32800*a&558144)>>>16&255}function w(a){return null!=a?a.toString(16).padStart(2,"0"):String(a)}function Od(a){const b=[];for(const c of a)for(const a of c)b.push(a);return b}function Pd(a,b){return a[b]<<8|a[b+1]}function Qd(a,b){return a[b+1]<<8|a[b]}
function Rd(a,b,c=0){const d=[];for(;a[b]!=c;)d.push(a[b++]);return String.fromCharCode(...d)}
class Sd{constructor(a,b,c=!1){this.last=a;this.clear=b;this.nonEmpty=c}read(a,b=0){const c=[];for(;;){const e=a[b++];var d=a[b++];d|=(e&3)<<8;d=e&this.clear?~d:d;-1!==d&&c.push(d);if(e&this.last)return c}}bytes(a){a=a.filter((a)=>-1!==a);this.nonEmpty&&!a.length&&(a=[-1]);const b=[];for(let c=0;c<a.length;c++){let d=a[c];0>d&&(d=this.clear<<8|~d);c===a.length-1&&(d|=this.last<<8);b.push(d>>>8);b.push(d&255)}return b}write(a,b,c=0){b=this.bytes(b);for(let d=0;d<b.length;d++)a[d+c]=b[d]}}
const $d=new Sd(64,128),ae=new Sd(64,128,!0),be=new Sd(64,128,!0),ce=new Sd(128,32,!0),de=new Sd(128,32);function ee(){function a(...a){return{tag:b,args:a}}const b=Symbol();a.commit=(a,d)=>{for(const c of Object.getOwnPropertyNames(a)){const e=a[c];e.tag===b&&(a[c]=d(c,...e.args))}};return a}const fe=Symbol("PROP_TAG"),ge=new WeakMap;
function he(a){let b=ge.get(a);if(!b){b=class extends x{};Object.defineProperties(b,{name:{value:a.name}});Object.assign(b,a);Reflect.setPrototypeOf(b.prototype,a.prototype);const c=new a,d={};for(const [a,b]of Object.entries(c))b&&b[fe]&&(d[a]=b);Object.defineProperties(b.prototype,d);ge.set(a,b);ge.set(b,b)}return b}
class x{constructor(a){this.data=a}static of(a){return Object.assign(new (he(this))(Array(this.size).fill(0)),a)}static from(a,b=0){const c=he(this);a=b||a.length!==this.size?Id(a,b,this.size):a;return new c(a)}[Symbol.iterator](){return this.data[Symbol.iterator]()}hex(){return Array.from(this.data,w).join(" ")}clone(){return new this.constructor(this.data)}prop(...a){return{get(){let b=0;for(const [c,d=255,e=0]of a)b|=(this.data[c]&d)>>>(0>e?0:e)<<(0>e?-e:0);return b},set(b){for(const [c,d=255,
e=0]of a)this.data[c]=this.data[c]&~d|b>>>(0>e?-e:0)<<(0>e?0:e)&d},[fe]:!0}}booleanProp(a,b){return{get(){return!!(this.data[a]&1<<b)},set(c){const d=1<<b;this.data[a]=c?this.data[a]|d:this.data[a]&~d},[fe]:!0}}}class z{constructor(a,b,c){this.name=a;this.bank=b;this.org=c}get offset(){return(this.bank&31)<<13}}z.$04=new z("04",4,32768);z.$05=new z("05",5,40960);z.$0a=new z("0a",10,32768);z.$0b=new z("0b",11,40960);z.$0c=new z("0c",12,32768);z.$0d=new z("0d",13,40960);z.$0e=new z("0e",14,32768);
z.$0f=new z("0f",15,40960);z.$10=new z("10",16,32768);z.$14=new z("14",20,32768);z.$15=new z("15",21,40960);z.$16_a=new z("16:a",22,40960);z.$17=new z("17",23,40960);z.$18=new z("18",24,32768);z.$19=new z("19",25,40960);z.$1a=new z("1a",26,32768);z.$1b=new z("1b",27,40960);z.$fe=new z("fe",30,49152);z.$ff=new z("ff",31,57344);
class ie{constructor(a,b){this.seg=a;this.delta=b}static of(a,b){return new ie(a,b-a.org)}get offset(){return this.seg.offset+this.delta}get org(){return this.seg.org+this.delta}get segment(){return this.seg.name}plus(a,b){a=this.delta+a;if(8192<=a){if(!b)throw Error("Segment changed");if(this.seg.org&8192)throw Error("Bad segment cross");return new ie(b,a&8191)}return new ie(this.seg,a)}minus(a){if(a.seg!==this.seg)throw Error("Incompatible segments");return this.delta-a.delta}read(a){return a[this.offset]}readLittleEndian(a){const b=
this.offset;return a[b]|a[b+1]<<8}readAddress(a,...b){a=this.readLittleEndian(a);b.length||(b=[this.seg]);for(const c of b)if((a&57344)===(c.org&57344))return ie.of(c,a);throw Error(`Could not find valid segment for ${w(a)}`);}loc(a,b){a.segment(this.segment);a.org(this.org,b)}}function je(a,b,c,d){a.segment(b.name);a.org(c);a.free(d-c)}function ke(a,b,c){a.segment(...b.map((a)=>a.name));a.reloc(c);a.label(c);a.export(c)};class le extends Dd{constructor(a,b,c){super(a,c);this.type=b}get nodeType(){return"Tracker"}edges(){return[]}}le.OFF_ROUTE=1;le.GLITCH=2;le.HARD=3;class me extends Dd{constructor(a,b,c){super(a,b);this.value=c}get nodeType(){return"Option"}edges(){return this.value?[Cd.of(this)]:[]}}
class ne extends Dd{constructor(a,b,c,d,e=[]){super(a,b);this.item=c;this.slots=e;this.isInvisible=this.requiresUnique=!1;this.slotName=b;this.slotIndex=d;this.slotType=c instanceof oe?"magic":"consumable";this.vanillaItemName=c.name;this.itemIndex=d}get nodeType(){return"Slot"}toString(){return`${super.toString()} [${this.vanillaItemName} $${this.slotIndex.toString(16).padStart(2,"0")}]`}edges(){return null!=this.item&&null!=this.itemIndex?[Cd.of(this.item,this)]:[]}isFixed(){return!1}isMimic(){return 112<=
this.itemIndex}requireUnique(){this.requiresUnique=!0;return this}canHoldMimic(){return this instanceof Ie&&!this.isInvisible}needsChest(){const a=this.itemIndex;return 13<=a&&36>=a||38===a||72<a}isChest(){return(this instanceof Ie||this instanceof Je)&&9!==this.slotIndex}get name2(){return this.item.name===this.vanillaItemName?this.name:`${this.item.name} [${this.vanillaItemName}]`}set(a,b){this.item=a;this.itemIndex=b}write(){if(this.slots){var a=this.graph.rom;if(a)for(const b of this.slots)b(a,
this)}}swap(a){const b=this.item,c=this.itemIndex;this.set(a.item,a.itemIndex);a.set(b,c)}key(){this.slotType="key";return this}bonus(){this.slotType="bonus";return this}direct(a){this.slots.push((b,c)=>{b.prg[a]=c.itemIndex});return this}fromPerson(a,b,c=0){this.slots.push((a,e)=>{a.npcs[b].data[c]=e.itemIndex});return this}npcSpawn(a,b,c=0){this.slots.push((d,e)=>{d=d.npcs[a].spawnConditions;null==b&&(b=Ke(d.keys()));d=d.get(b);if(!d)throw Error(`No spawn found for NPC $${w(a)} @ $${w(b)}`);d[c]=
Le(d[c],e)});return this}dialog(a,b,c=0,d){this.slots.push((e,f)=>{e=e.npcs[a].localDialogs;null==b&&(b=Ke(e.keys()));e=e.get(b);if(!e)throw Error(`No dialog found for NPC $${w(a)} @ $${w(b)}`);e=e[c];if(!e)throw Error(`No such dialog ${c}`);null==d?e.condition=Le(e.condition,f):e.flags[d]=Le(e.flags[d],f)});return this}trigger(a,b=0,c){this.slots.push((d,e)=>{d=d.triggers[a&127];null==c?d.conditions[b]=Le(d.conditions[b],e):d.flags[c]=Le(d.flags[c],e)});return this}}
class Me extends ne{isFixed(){return!0}}class Je extends ne{get nodeType(){return"BossDrop"}}
class Ie extends ne{constructor(a,b,c,d){super(a,b,c,d);this.spawnSlot=null;this.isInvisible=!1}get nodeType(){return"Chest"}objectSlot(a,b){this.spawnSlot=b;this.slots.push((c,d)=>{c=c.locations[a];if(!c||!c.used)throw Error(`No such location: $${w(a)}`);c=c.spawns[b-13];if(!c||!c.isChest())throw Error(`No chest $${w(b)} on $${w(a)}`);c.timed=!1;c.id=Math.min(d.itemIndex,112)});return this}invisible(a){this.isInvisible=!0;return this.direct(a)}}
class Ne extends Dd{constructor(a,b,c){super(a,c);this.id=b;this.shufflePriority=1;this.inventoryRow="unique"}get nodeType(){return"ItemGet"}chest(a=this.name+" chest",b=this.id){return new Ie(this.graph,a,this,b)}fromPerson(a,b,c=0){return new ne(this.graph,a,this,this.id,[(a,e)=>{a.npcs[b].data[c]=e.itemIndex}])}bossDrop(a,b,c=this.id){return new Je(this.graph,a,this,c,[(a,c)=>{a.bossKills[b].itemDrop=c.itemIndex}])}direct(a,b){return new ne(this.graph,a,this,this.id,[(a,d)=>{a.prg[b]=d.itemIndex}])}fixed(){return new Me(this.graph,
this.name,this,this.id)}weight(a){this.shufflePriority=a;return this}consumable(){this.inventoryRow="consumable";return this}armor(){this.inventoryRow="armor";return this}}class B extends Ne{get nodeType(){return"Item"}}class oe extends Ne{get nodeType(){return"Magic"}}
class C extends Dd{constructor(a,b){super(a,b);this.slot=null;this.reqs=[]}get nodeType(){return"Trigger"}edges(){const a=[...this.reqs];this.slot&&a.push(Cd.of(this.slot,this));return a}get(a){if(this.slot)throw Error("already have a slot");this.slot=a;return this}}class D extends Dd{constructor(a,b){super(a,b);this.options=[]}get nodeType(){return"Condition"}edges(){return this.options.map((a)=>Cd.of(this,...a))}option(...a){this.options.push(a.map((a)=>a instanceof ne?a.item:a));return this}}
class Oe extends C{constructor(a,b,c,...d){super(a,c);this.index=b;this.deps=d.map((a)=>a instanceof ne?a.item:a)}get nodeType(){return"Boss"}}class Pe extends Dd{get nodeType(){return"Area"}}class Qe{constructor(a,b,c=!1,d=[]){this.from=a;this.to=b;this.bidi=c;this.deps=d.map((a)=>a instanceof ne?a.item:a)}reverse(){return new Qe(this.to,this.from,this.bidi,this.deps)}}
class E extends Dd{constructor(a,b,c,d){super(a,c.name+": "+d);this.id=b;this.area=c;this.connections=[];this.chests=[];this.type=this.bossNode=null;this.isEnd=this.isStart=!1;this.sells=[];this.simpleName=d}get nodeType(){return"Location"}toString(){return`Location ${this.id.toString(16).padStart(2,"0")} ${this.name}`}edges(){const a=[];for(const b of this.connections)a.push(Cd.of(b.to,b.from,...b.deps,...b.from.bossNode?[b.from.bossNode]:[])),b.bidi&&a.push(Cd.of(b.from,b.to,...b.deps,...b.to.bossNode?
[b.to.bossNode]:[]));for(const b of this.chests)a.push(Cd.of(b,this));this.isStart&&a.push(Cd.of(this));return a}addConnection(a){a.from.connections.push(a);a.to.connections.push(a);return this}from(a,...b){return this.addConnection(new Qe(a,this,!1,b))}to(a,...b){return this.addConnection(new Qe(this,a,!1,b))}connect(a,...b){return this.addConnection(new Qe(a,this,!0,b))}connectTo(a,...b){return this.addConnection(new Qe(this,a,!0,b))}chest(a,b,c){a instanceof ne&&!(a instanceof Ie)&&null!=c&&(a=
a.item);a instanceof Ne&&(a=a.chest(void 0,c));b=a.objectSlot(this.id,b);this.chests.push(b);112<=b.itemIndex&&(b.slotType="trap");if(!b.slotName||b.slotName.endsWith(" chest"))b.slotName=a.name+" in "+this.area.name;return this}trigger(a,...b){b=b.map((a)=>a instanceof ne?a.item:a);a.reqs.push(Cd.of(a,this,...b));return this}boss(a){this.bossNode=a;a.reqs.push(Cd.of(a,this,...a.deps));return this}overworld(){this.type="overworld";return this}town(){this.type="town";return this}cave(){this.type="cave";
return this}sea(){this.type="sea";return this}fortress(){this.type="fortress";return this}house(){this.type="house";return this}shop(...a){this.type="house";this.sells=a.map((a)=>a instanceof ne?a.item:a);return this}misc(){this.type="misc";return this}start(){this.isStart=!0;return this}end(){this.isEnd=!0;return this}fullName(){const a=[this.simpleName];this.bossNode&&a.push(this.bossNode.name);return a.join("\\n")}write(){if(this.sells.length){var a=this.graph.rom;if(!a)throw Error("Cannot write without a rom");
for(const b of a.shops)if(b.location===this.id)for(a=0;4>a;a++)b.contents[a]=this.sells[a]?this.sells[a].id:255}}}
class Re extends Ed{write(){for(const a of this.nodes)a.write()}shuffleShops(a){const b={shops:[],items:[]},c={shops:[],items:[]};for(var d of this.nodes)if(d instanceof E&&d.sells.length){var e="armor"===d.sells[0].inventoryRow?b:c;e.shops.push(d);for(let a=0;4>a;a++)e.items.push(d.sells[a]||null);d.sells=[]}a.shuffle(b.items);a.shuffle(c.items);for(const {shops:f,items:g}of[b,c])for(a=0;g.length&&1E5>a;)d=g.pop(),e=f[a++%f.length],d&&(0<=e.sells.indexOf(d)||4<=e.sells.length?g.push(d):e.sells.push(d));
for(const {shops:a}of[b,c])for(const b of a)b.sells.sort((a,b)=>a.id-b.id)}integrate({tracker:a=!1}={}){var b=!a;const c=new Fd(this.nodes.length);var d=[],e=[];const f=new Set,g=new Map;var h=[];const k=[],p=[],m=[],u=[],y=new Set;for(const a of this.nodes)if(a instanceof E){if(a.isStart){const [b]=c.addRoute([a.uid]);g.set(b.label,b)}d[a.uid]=[];e[a.uid]=[];for(const b of a.connections)f.has(b)||(f.add(b),b.bidi&&f.add(b.reverse()));for(const b of a.chests)c.addRoute([b.uid,a.uid])}else if(a instanceof
Ne&&"Medical Herb"===a.name&&(c.addRoute([a.uid]),c.finalize(a.uid)),a instanceof me)h.push(a);else if(a instanceof le)k.push(a);else if(a instanceof D)p.push(a);else if(a instanceof C)m.push(a);else if(a instanceof Ne)u.push(a);else if(a instanceof ne)y.add(a);else if(!(a instanceof Pe))throw Error(`Unknown node type: ${a.nodeType}`);for(const a of f)d[a.from.uid].push(a),e[a.to.uid].push(a);e=(b)=>{for(const d of b){for(const b of d.edges({tracker:a}))c.addRoute(b);c.finalize(d.uid)}};e(h);b&&e(k);
e(m);for(const a of g.values()){b=a.target;for(const e of d[b]){b=[e.to.uid,...a.deps];for(h=e.deps.length-1;0<=h;h--)b.push(e.deps[h].uid);e.from.bossNode&&b.push(e.from.bossNode.uid);for(const a of c.addRoute(b))g.has(a.label)||g.set(a.label,a)}}e(p);for(d=0;d<this.nodes.length;d++)this.nodes[d]instanceof Ne||this.nodes[d]instanceof le||c.finalize(d);d=new Se(this);for(const a of y)for(const b of c.nodes[a.uid].values())d.addRoute([a.uid,...b]);return d}}
class Se{constructor(a){this.worldGraph=a;this.uidToLocation=[];this.locationToUid=[];this.uidToItem=[];this.itemToUid=[];this.routes=[];this.unlocks=[];this.win=null}item(a){return this.worldGraph.nodes[this.itemToUid[a]]}location(a){return this.worldGraph.nodes[this.locationToUid[a]]}addRoute(a){let b=la.of(),c=-1;const d=[];for(let f=a.length-1;0<=f;f--){var e=f?this.uidToItem:this.uidToLocation;const g=f?this.itemToUid:this.locationToUid,h=a[f];let k=e[h];null==k&&(k=g.length,g.push(h),e[h]=k,
e=this.worldGraph.nodes[h],!f&&e instanceof ne&&e.isFixed()&&(this.win=k));f?(b=la.with(b,k),d.push(this.unlocks[k]||(this.unlocks[k]=new Set))):c=k}(this.routes[c]||(this.routes[c]=[])).push(b);for(const a of d)a.add(c)}canReach(a,b){a=this.routes[this.uidToLocation[a.uid]];for(let c=0,d=a.length;c<d;c++)if(la.containsAll(b,a[c]))return!0;return!1}traverse(a=la.of(),b=[]){a=la.clone(a);const c=new Set,d=new Set;for(var e=0;e<this.locationToUid.length;e++)d.add(e);for(const f of d)if(d.delete(f),
!c.has(f)){e=this.routes[f];for(let g=0,h=e.length;g<h;g++)if(la.containsAll(a,e[g])){c.add(f);if(b[f]){a=la.with(a,b[f]);for(const a of this.unlocks[b[f]])d.add(a)}break}}return c}traverseDepths(a){let b=la.of(),c=0;const d=[],e={},f=new Set;for(var g=0;g<this.locationToUid.length;g++)f.add(g);f.add(e);for(const h of f)if(f.delete(h),"number"!==typeof h)f.size&&f.add(e),c++;else if(null==d[h]){g=this.routes[h];for(let e=0,p=g.length;e<p;e++)if(la.containsAll(b,g[e])){d[h]=c;if(a[h]){b=la.with(b,
a[h]);for(const b of this.unlocks[a[h]])f.add(b)}break}}return d}toString(){const a=[];for(let b=0;b<this.routes.length;b++){const c=this.location(b),d=this.routes[b],e=[];for(let a=0,b=d.length;a<b;a++){const b=[];for(const c of la.bits(d[a]))b.push(this.item(c));e.push("("+b.join(" & ")+")")}a.push(`${c}: ${e.join(" | ")}`)}return a.join("\n")}assumedFill(a,b=()=>!0,c=Te){const d=c.shuffleItems(this.itemToUid.map((a)=>this.worldGraph.nodes[a]),a);let e=la.from(d);const f=Array(this.locationToUid.length).fill(null);
for(;d.length;){const g=d.pop();if(!la.has(e,g))continue;const h=this.item(g);e=la.without(e,g);const k=[...this.traverse(e,f)].filter((a)=>null==f[a]);c.shuffleSlots(h,k,a);let p=!1;for(const a of k)if(null==f[a]&&a!==this.win&&b(this.location(a),h)){if(100<a)throw Error("Something went horribly wrong");f[a]=g;p=!0;break}if(!p)return null}return f}}
const Te={shuffleSlots:(a,b,c)=>{c.shuffle(b)},shuffleItems:(a,b)=>{const c=[];for(let b=0;b<a.length;b++){const {shufflePriority:d=1}=a[b];for(let a=0;a<d;a++)c.push(b)}b.shuffle(c);return c}};function Ke(a){for(const b of a)return b;throw Error("Empty iterable");}function Le(a,b){return 0>a?~(512|b.itemIndex):512|b.itemIndex};const Ue=(a=new fd,b)=>{const c=new Re(b),d=(a,b=!0)=>new me(c,a,b),e=(a,b,...d)=>new Oe(c,a,b,...d),f=new le(c,le.GLITCH,"Glitch"),g=new le(c,le.HARD,"Hard"),h=(a)=>a.value?a:f,k=d("Leather Boots grant speed",a.leatherBootsGiveSpeed()),p=h(d("Assume ghetto flight",a.assumeGhettoFlight())),m=h(d("Assume statue glitch",a.assumeStatueGlitch())),u=d("Allow statue glitch",!a.disableStatueGlitch()),y=h(d("Assume teleport skip",a.assumeTeleportSkip())),G=d("Allow teleport skip",!a.disableTeleportSkip()),
A=h(d("Assume rabbit skip",a.assumeRabbitSkip())),T=h(d("Allow rabbit skip",!a.disableRabbitSkip())),ma=h(d("Assume sword charge glitch",a.assumeSwordChargeGlitch())),M=d("Allow sword charge glitch",!a.disableSwordChargeGlitch()),Z=h(d("Assume wild warp",a.assumeWildWarp())),ea=d("Allow wild warp",a.allowWildWarp()),pa=d("Sword magic optional",!a.guaranteeSwordMagic()),P=d("Matching sword optional",!a.guaranteeMatchingSword()),ec=d("Gas mask optional",!a.guaranteeGasMask()),ub=d("Healed dolphin optional",
!a.requireHealedDolphinToRide()),ab=d("Calm sea optional",!a.barrierRequiresCalmSea()),Mb=d("Prison key optional",!1),pb=d("Windmill optional",!1),gb=d("Sword of Thunder teleports to Shyron",a.teleportOnThunderSword()),Bb=d("Barrier magic optional",!a.guaranteeBarrier()),fc=d("Refresh magic optional",!a.guaranteeRefresh()),gc=d("Telepathy optional for Deo",!a.saharaRabbitsRequireTelepathy()),eb=d("Lime Tree connects to Leaf",a.connectLimeTreeToLeaf()),Td=d("Buffed medical herb",a.buffMedicalHerb()),
hb=d("Orbs optional",a.orbsOptional()),Ua=(new B(c,0,"Sword of Wind")).weight(a.guaranteeSword()?10:5).fromPerson("Leaf elder",13).npcSpawn(94,16,1).dialog(13,192,2).key(),Ka=(new B(c,1,"Sword of Fire")).weight(a.guaranteeSword()?10:5).fromPerson("Oak elder",29).dialog(29,void 0,3).key(),Sa=(new B(c,2,"Sword of Water")).weight(10).chest().key(),Ta=(new B(c,3,"Sword of Thunder")).weight(15).chest().key(),Nb=(new B(c,4,"Crystalis")).fixed(),vb=(new B(c,5,"Ball of Wind")).chest().key(),hc=(new B(c,6,
"Tornado Bracelet")).chest().key(),qb=(new B(c,7,"Ball of Fire")).bossDrop("Insect",1).dialog(30,void 0,2).dialog(32,void 0,0).dialog(33,void 0,0).dialog(34,void 0,0).dialog(96,30,0).dialog(29,void 0,2).dialog(31,void 0,1).npcSpawn(193).key(),Ob=(new B(c,8,"Flame Bracelet")).bossDrop("Kelbesque 1",2).npcSpawn(194).key(),Pb=(new B(c,9,"Ball of Water")).weight(5).direct("Rage",250679).npcSpawn(195).key(),Qb=(new B(c,10,"Blizzard Bracelet")).weight(5).chest().key(),Cb=(new B(c,11,"Ball of Thunder")).bossDrop("Mado 1",
5).trigger(154,1).key(),uc=(new B(c,12,"Storm Bracelet")).chest().key(),Vc=(new B(c,13,"Carapace Shield")).armor(),vc=(new B(c,14,"Bronze Shield")).armor(),O=(new B(c,15,"Platinum Shield")).armor(),pe=(new B(c,16,"Mirrored Shield")).armor(),Ea=(new B(c,17,"Ceramic Shield")).armor(),ib=(new B(c,18,"Sacred Shield")).armor().bossDrop("Mado 2",8).npcSpawn(199).bonus(),Va=(new B(c,19,"Battle Shield")).armor(),Rb=(new B(c,20,"Psycho Shield")).armor(),Wc=(new B(c,21,"Tanned Hide")).armor(),wc=(new B(c,22,
"Leather Armor")).armor(),$l=(new B(c,23,"Bronze Armor")).armor(),ph=(new B(c,24,"Platinmum Armor")).armor(),am=(new B(c,25,"Soldier Suit")).armor(),qh=(new B(c,26,"Ceramic Suit")).armor(),bm=(new B(c,27,"Battle Suit")).armor(),cm=(new B(c,28,"Psycho Armor")).armor().bossDrop("Draygon 1",10).npcSpawn(203).trigger(159).npcSpawn(131).key(),Wa=(new B(c,29,"Medical Herb")).consumable(),rb=(new B(c,30,"Antidote")).consumable(),pd=(new B(c,31,"Lysis Plant")).consumable(),yf=(new B(c,32,"Fruit of Lime")).consumable(),
wb=(new B(c,33,"Fruit of Power")).consumable(),Sb=(new B(c,34,"Magic Ring")).consumable(),zf=(new B(c,35,"Fruit of Repun")).consumable().bossDrop("Sabera 2",7).npcSpawn(198).key(),Db=(new B(c,36,"Warp Boots")).consumable(),rh=(new B(c,37,"Statue of Onyx")).chest("Cordel grass").invisible(254882).key(),Af=(new B(c,38,"Opel Statue")).consumable().bossDrop("Kelbesque 2",6).npcSpawn(197).key(),sh=(new B(c,39,"Insect Flute")).fromPerson("Oak mother",30).dialog(30,void 0,1).key(),Bf=(new B(c,40,"Flute of Lime")).fromPerson("Portoa queen",
56).fromPerson("Asina secondary",98,1).dialog(56,void 0,4).key(),qe=(new B(c,41,"Gas Mask")).direct("Akahana in Brynmaer",251902).npcSpawn(22,24).key(),dm=(new B(c,42,"Power Ring")).chest().bonus(),em=(new B(c,43,"Warrior Ring")).fromPerson("Akahana's friend",84).dialog(84,void 0,2).bonus(),fm=(new B(c,44,"Iron Necklace")).chest().bonus(),gm=(new B(c,45,"Deo's Pendant")).fromPerson("Deo",90).dialog(90,void 0,0).bonus(),Cf=(new B(c,46,"Rabbit Boots")).bossDrop("Vampire 1",0).npcSpawn(192).key(),th=
((a,b)=>new B(c,a,b))(47,a.leatherBootsGiveSpeed()?"Speed Boots":"Leather Boots").chest().bonus(),uh=(new B(c,48,"Shield Ring")).direct("Akahana in waterfall cave",250543).bonus(),Df=(new B(c,49,"Alarm Flute")).fromPerson("Zebu's student",20,1).key(),vh=(new B(c,50,"Windmill Key")).fromPerson("Windmill guard",20).dialog(20,14,0).npcSpawn(20,14,1).key(),Ef=(new B(c,51,"Key to Prison")).chest().key(),wh=(new B(c,52,"Key to Styx")).fromPerson("Zebu in Shyron",94,1).trigger(128,2).dialog(94,242,0).dialog(98,
242,0).key(),xh=(new B(c,53,"Fog Lamp")).chest().key(),Ff=(new B(c,54,"Shell Flute")).fromPerson("Dolphin",99,1).npcSpawn(99).key(),yh=(new B(c,55,"Eye Glasses")).fromPerson("Clark",68).dialog(68,233,1).key(),zh=(new B(c,56,"Broken Statue")).bossDrop("Sabera 1",4).npcSpawn(127,101).npcSpawn(9).npcSpawn(10).npcSpawn(69).npcSpawn(70).npcSpawn(71).npcSpawn(132).npcSpawn(142).dialog(61).dialog(62).dialog(63).dialog(64).dialog(65).dialog(66).dialog(67).dialog(68,233).trigger(182).key(),Ah=(new B(c,57,
"Glowing Lamp")).direct("Kensu in lighthouse",250638).npcSpawn(126,98,1).key(),Bh=(new B(c,59,"Love Pendant")).chest("Underground channel").invisible(254890).key(),Ch=(new B(c,60,"Kirisa Plant")).chest("Kirisa meadow").invisible(254886).key(),Gf=(new B(c,61,"Ivory Statue")).bossDrop("Karmine",9).npcSpawn(200).key(),Dh=(new B(c,62,"Bow of Moon")).fromPerson("Aryllis",35).direct(251624).dialog(35,void 0,1).key(),Eh=(new B(c,63,"Bow of Sun")).chest().key(),Fh=(new B(c,64,"Bow of Truth")).fromPerson("Azteca",
131).npcSpawn(131,156,1).dialog(131,void 0,0).key(),re=(new oe(c,65,"Refresh")).fromPerson("Zebu at windmill",94).requireUnique().direct(251665).dialog(94,16,3).trigger(180,1),Ud=(new oe(c,66,"Paralysis")).direct("Zebu at Mt. Sabre summit",251477).requireUnique().trigger(141).trigger(178),xc=(new oe(c,67,"Telepathy")).direct("Tornel at Stom's house",223220).npcSpawn(95,30,1).trigger(133,1),Gh=(new oe(c,68,"Teleport")).fromPerson("Tornel on Mt. Sabre",95).dialog(95,33,0),hm=(new oe(c,69,"Recover")).direct("Asina in Portoa",
250361),Hh=(new oe(c,70,"Barrier")).direct("Asina on Angry sea",251609).requireUnique().trigger(132,0),Xc=(new oe(c,71,"Change")).direct("Kensu in Swan",251614).npcSpawn(116,241,1).npcSpawn(126,241,1),La=(new oe(c,72,"Flight")).weight(15).direct("Kensu in Draygonia Fortress",250255),im=wb.bossDrop("Vampire 2",12,97).npcSpawn(204).key(),xb=new B(c,112,"Mimic"),Ih=(new C(c,"Talked to Leaf Elder")).get(Ua),Jh=(new C(c,"Talked to Leaf Student")).get(Df),Hf=new C(c,"Talked to Zebu in cave"),jm=(new C(c,
"Woke up Windmill Guard")).get(vh),Vd=new C(c,"Started Windmill"),Kh=(new C(c,"Learned Refresh")).get(re),km=(new C(c,"Gave Statue to Akahana")).get(qe),lm=(new C(c,"Fought Stom")).get(xc),Lh=new C(c,"Visited Oak"),Mh=new C(c,"Talked to Oak Mother"),If=new C(c,"Rescued Oak Child"),mm=(new C(c,"Talked to Oak Mother Again")).get(sh),nm=(new C(c,"Talked to Oak Elder")).get(Ka),om=(new C(c,"Talked to Tornel on Mt Sabre")).get(Gh),Nh=new C(c,"Villagers Abducted"),Oh=new C(c,"Talked to Rabbit in Leaf"),
pm=(new C(c,"Learned Paralysis")).get(Ud),Ph=new C(c,"Talked to Portoa Queen"),Qh=new C(c,"Talked to Fortune Teller"),Rh=new C(c,"Visited Underground Channel"),qm=(new C(c,"Sent to Waterfall Cave")).get(Bf),rm=(new C(c,"Cured Akahana")).get(uh),Sh=(new C(c,"Talked to Rage")).get(Pb),Th=new C(c,"Mesia recording played"),Uh=(new C(c,"Talked to Asina")).get(hm),Vh=(new C(c,"Healed Dolphin")).get(Ff),Jf=new C(c,"Returned Fog Lamp"),Wh=new C(c,"Talked to Kensu in Cabin"),Xh=new C(c,"Talked to Joel Elder"),
sm=(new C(c,"Talked to Clark")).get(yh),tm=(new C(c,"Talked to Kensu in Lighthouse")).get(Ah),Kf=new C(c,"Calmed the Angry Sea"),um=(new C(c,"Learned Barrier")).get(Hh),Yh=new C(c,"Talked to Stom in Swan Hut"),Zh=new C(c,"Talked to Kensu in Swan tavern"),$h=new C(c,"Talked to Kensu at Swan dance"),vm=(new C(c,"Returned Kensu's love pendant")).get(Xc),wm=(new C(c,"Talked to Amazones Queen")).get(Dh),Lf=new C(c,"Entered Shyron"),xm=(new C(c,"Talked to Zebu in Shyron")).get(wh),ai=new C(c,"Shyron Massacre"),
ym=(new C(c,"Saved Kensu")).get(La),zm=(new C(c,"Talked to Deo")).get(gm),Am=(new C(c,"Talked to Akahana's Friend")).get(em),Bm=(new C(c,"Get Bow of Truth")).get(Fh),Cm=(new C(c,"Forged Crystalis")).get(Nb),se=(new D(c,"Sword charge glitch")).option(ma,M),Dm=(new D(c,"Rabbit skip")).option(A,T),Em=(new D(c,"Teleport skip")).option(y,G),te=(new D(c,"Statue glitch")).option(m,u),Fm=(new D(c,"Wild warp")).option(Z,ea),ue=(new D(c,"Any level 2 sword")).option(Ua,vb).option(Ua,hc).option(Ka,qb).option(Ka,
Ob).option(Sa,Pb).option(Sa,Qb).option(Ta,Cb).option(Ta,uc),za=(new D(c,"Destroy stone")).option(Ua,hb).option(Ua,vb).option(Ua,hc).option(se,Ua,ue),Aa=(new D(c,"Destroy ice")).option(Ka,hb).option(Ka,qb).option(Ka,Ob).option(se,Ka,ue),ha=(new D(c,"Cross rivers")).option(Sa,hb).option(Sa,Pb).option(Sa,Qb).option(La).option(se,Sa,ue),qd=(new D(c,"Destroy iron")).option(Ta,hb).option(Ta,Cb).option(Ta,uc).option(se,Ta,ue),Eb=(new D(c,"Any sword")).option(Ua).option(Ka).option(Sa).option(Ta),Gm=(new D(c,
"Match insect sword (fire/water/thunder)")).option(Ka).option(Sa).option(Ta).option(qe,P.value?P:g,Ua),Hm=(new D(c,"Match vampire 2 sword (wind/water/thunder)")).option(Ua).option(Sa).option(Ta).option(P.value?P:g,Ka),bi=(new D(c,"Speed boots")).option(th,k),ci=(new D(c,"Climb slopes")).option(Cf).option(La).option(bi),Im=(new D(c,"Enter Mt Sabre North (rabbit)")).option(Oh).option(Dm),Jm=(new D(c,"Enter Mt Sabre North (Teleport)")).option(Gh).option(Em,La),di=(new D(c,"Asina in her room")).option(Th),
Km=(new D(c,"Paralysis or Asina revealed")).option(Ud).option(di).option(te),ei=(new D(c,"Ride dolphin")).option(Ff,Wh),Lm=(new D(c,"Ghetto flight")).option(p,ei,Cf),ic=(new D(c,"Cross sea")).option(ei).option(La),Mm=(new D(c,"Cross whirlpool")).option(Kf).option(La).option(Lm),Fb=(new D(c,"Refresh if needed")).option(fc.value?fc:g).option(re),fi=(new D(c,"Wind magic")).option(pa.value?pa:g,Fb).option(vb,hc,Fb),gi=(new D(c,"Fire magic")).option(pa.value?pa:g,Fb).option(qb,Ob,Fb),hi=(new D(c,"Water magic")).option(pa.value?
pa:g,Fb).option(pa,Fb).option(Pb,Qb,Fb),Nm=(new D(c,"Thunder magic")).option(pa.value?pa:g,Fb).option(pa,Fb).option(Cb,Fb).option(uc,Fb),Om=(new D(c,"Flute of lime or glitch")).option(Bf).option(te),Pm=(new D(c,"Change or glitch")).option(Xc).option(te),Qm=(new D(c,"Change or glitch or paralysis")).option(Xc).option(te).option(Ud),Mf=(new D(c,"Pass shooting statues")).option(Hh).option(Eb,Bb.value?Bb:g).option(re,uh),Rm=(new D(c,"Healed dolphin if required")).option(Vh).option(ub),ii=(new D(c,"Match sword of wind")).option(Ua).option(P.value?
P:g,Eb),ji=(new D(c,"Match sword of fire")).option(Ka).option(P.value?P:g,Eb),ki=(new D(c,"Match sword of water")).option(Sa).option(P.value?P:g,Eb),Sm=(new D(c,"Match sword of thunder")).option(Ta).option(P.value?P:g,Eb),Tm=(new D(c,"Swamp run possible")).option(Eb,bi).option(Eb,Td).option(Eb,re),Um=(new D(c,"Insect possible to kill")).option(qe),ve=(new D(c,"Travel swamp")).option(qe).option(ec.value?ec:g,Tm),Vm=(new D(c,"Calmed sea if required")).option(Kf).option(ab),Wm=(new D(c,"Started windmill if required")).option(Vd).option(pb),
Xm=(new D(c,"Telepathy if required for Deo")).option(xc).option(gc),Ym=e(0,"Vampire 1",Eb).get(Cf),Zm=e(1,"Insect",sh,Gm,Um).get(qb),$m=e(2,"Kelbesque 1",ii,fi).get(Ob),an=e(12,"Vampire 2",Hm).get(im),li=e(4,"Sabera 1",ji,gi).get(zh),bn=e(5,"Mado 1",ki,hi).get(Cb),cn=e(6,"Kelbesque 2",ii,fi).get(Af),dn=e(7,"Sabera 2",ji,gi).get(zf),en=e(8,"Mado 2",ki,hi).get(ib),fn=e(9,"Karmine",Sm,Nm).get(Gf),gn=e(10,"Draygon 1",Eb).get(cm),hn=e(-1,"Statues",Eh,Dh),jn=e(11,"Draygon 2",Eb,Fh),kn=e(13,"Dyna",Nb),ln=
(new D(c,"Opened prison if required")).option(Ef).option(Mb),Tb=new Pe(c,"Leaf"),rd=new Pe(c,"Valley of Wind"),Gb=new Pe(c,"Sealed Cave"),Yc=new Pe(c,"Cordel Plain"),sd=new Pe(c,"Brynmaer"),td=new Pe(c,"Amazones"),Ma=new Pe(c,"Mt Sabre West"),ra=new Pe(c,"Mt Sabre North"),we=new Pe(c,"Nadare's"),Wd=new Pe(c,"Oak"),yc=new Pe(c,"Waterfall Valley"),Ia=new Pe(c,"Portoa"),zc=new Pe(c,"Waterfall Cave"),Na=new Pe(c,"Fog Lamp Cave"),Ac=new Pe(c,"Kirisa Plant Cave"),Zc=new Pe(c,"Angry Sea"),Bc=new Pe(c,"Joel"),
jb=new Pe(c,"Evil Spirit Island"),Cc=new Pe(c,"Sabera's Castle"),Ub=new Pe(c,"Swan"),Fa=new Pe(c,"Mt Hydra"),Dc=new Pe(c,"Shyron"),$c=new Pe(c,"Styx"),ad=new Pe(c,"Goa"),xe=new Pe(c,"Draygonia Fortress 1"),Vb=new Pe(c,"Draygonia Fortress 2"),ud=new Pe(c,"Draygonia Fortress 3"),yb=new Pe(c,"Draygonia Fortress 4"),bb=new Pe(c,"Oasis Cave"),Wb=new Pe(c,"Sahara"),vd=new Pe(c,"Pyramid Front"),jc=new Pe(c,"Pyramid Back"),kc=new Pe(c,"Tower"),Nf=(new E(c,0,Tb,"Start")).overworld().start(),mn=(new E(c,0,
Tb,"Mezame Shrine")).overworld().from(Nf),nn=(new E(c,1,Tb,"Outside Start")).overworld().connect(mn),Ec=(new E(c,2,Tb,"Town")).town().connect(nn),Xd=(new E(c,3,rd,"Main")).overworld().connect(Ec).trigger(Kh,Vd),mi=(new E(c,3,rd,"Outside Windmill")).overworld(),ni=(new E(c,4,Gb,"Tunnel 1 (entrance)")).cave().from(Xd,Vd),on=(new E(c,5,Gb,"Tunnel 2 (over bridge)")).cave().connect(ni),pn=(new E(c,6,Gb,"Tunnel 6 (herb dead end)")).cave().chest(Wa,15),oi=(new E(c,7,Gb,"Tunnel 4a (ball corridor)")).cave().chest(Wa,
20,80).chest(vb,21);(new E(c,7,Gb,"Tunnel 4b (antidote dead end)")).cave().connect(oi,za).chest(rb,19);const qn=(new E(c,8,Gb,"Tunnel 5 (warp boots dead end)")).cave().chest(Db,14),rn=(new E(c,9,Gb,"Tunnel 3a (branch, front)")).cave().connect(on).connectTo(oi).connectTo(qn),sn=(new E(c,9,Gb,"Tunnel 3b (branch, back)")).cave().connect(rn,za).connectTo(pn),tn=(new E(c,10,Gb,"Tunnel 7 (boss)")).cave().connect(sn).boss(Ym),un=(new E(c,12,Gb,"Tunnel 8a (exit, above wall)")).cave().connect(tn),vn=(new E(c,
12,Gb,"Tunnel 8b (exit, below wall")).cave().connect(un,za);(new E(c,14,rd,"Windmill Cave")).cave().connect(Xd).connectTo(mi).trigger(jm,Df,Hf);(new E(c,15,rd,"Windmill")).misc().connect(mi).trigger(Vd,vh);const wn=(new E(c,16,rd,"Zebu's Cave Front")).cave().connect(Xd).trigger(Hf,Ih,Jh).trigger(Kh,Vd,Hf),xn=(new E(c,16,rd,"Zebu's Cave Back")).cave().trigger(Nh).connect(wn,Aa),yn=(new E(c,17,Ma,"Tunnel 1 (to Zebu)")).cave().connect(xn),wd=(new E(c,20,Yc,"West")).overworld().connect(vn,Wm),zn=(new E(c,
20,Yc,"South")).overworld().connect(wd,ha),pi=(new E(c,21,Yc,"East")).overworld().connect(wd).chest(rh,24),Yd=(new E(c,24,sd,"Town")).town().connect(wd).trigger(km,rh),An=(new E(c,25,Yc,"Outside Stom's House")).town().connect(wd),Of=(new E(c,26,Yc,"Swamp")).overworld().connect(pi,ve).trigger(If,Mh,ve);(new E(c,26,Yc,"Swamp Insect Area")).overworld().connect(Of,ve).boss(Zm);const ye=(new E(c,27,td,"Town")).town().connect(zn),ze=(new E(c,28,Wd,"Town")).town().connect(Of,ve).trigger(Lh);(new E(c,30,
Yc,"Stom's House")).house().connect(An).trigger(lm,Lh);const xd=(new E(c,32,Ma,"Entrance")).overworld().connect(wd).connect(yn),Bn=(new E(c,32,Ma,"Up Slope")).overworld().from(xd,ci).to(xd),Cn=(new E(c,32,Ma,"Dead End (warp boots)")).overworld().chest(Db,24,106),qi=(new E(c,33,Ma,"Upper")).overworld().from(xd,La).to(xd),Dn=(new E(c,33,Ma,"Tornel Dead End")).overworld().trigger(om,vb,hc).chest(Sb,23,105),ri=(new E(c,34,Ma,"Tunnel 2a (fork at start)")).cave().connect(xd);(new E(c,34,Ma,"Tunnel 2b (left branch to dead end)")).cave().connect(ri,
Aa).connectTo(Cn);const En=(new E(c,34,Ma,"Tunnel 2c (right branch to upper)")).cave().connect(ri,Aa),Fn=(new E(c,35,Ma,"Tunnel 3a (tunnel to upper, with herb chest)")).cave().connect(En).chest(Wa,23,82),Gn=(new E(c,35,Ma,"Tunnel 3b (tunnel to upper, branch below ice)")).cave().connect(Fn,Aa).connectTo(qi),si=(new E(c,36,Ma,"Tunnel 4a (branch to upper or Tornel)")).cave().connect(Gn);(new E(c,36,Ma,"Tunnel 4b (out to upper)")).cave().connect(si,Aa).connectTo(qi);const Hn=(new E(c,37,Ma,"Tunnel 5 (tiny connector)")).cave().connect(si),
In=(new E(c,38,Ma,"Tunnel 6a (exit to Tornel, above ice)")).cave().connect(Hn);(new E(c,38,Ma,"Tunnel 6b (exit to Tornel, below ice)")).cave().connect(In,Aa).connectTo(Dn);const Jn=(new E(c,39,Ma,"Tunnel 7a (tornado bracelet, lower)")).cave().connect(Bn),Kn=(new E(c,39,Ma,"Tunnel 7b (tornado bracelet, middle)")).cave().connect(Jn,Aa);(new E(c,39,Ma,"Tunnel 7c (tornado bracelet, upper)")).cave().connect(Kn,Aa).chest(hc,25);const Ae=(new E(c,40,ra,"Entrance")).overworld().connect(pi,Jm,Im),Be=(new E(c,
40,ra,"Upper")).overworld().from(Ae,La).to(Ae),Pf=(new E(c,40,ra,"Summit (boss)")).overworld().from(Be,La).to(Be).boss($m),ti=(new E(c,41,ra,"Connector")).overworld(),Qf=(new E(c,41,ra,"Middle Left")).overworld(),Ln=(new E(c,41,ra,"Middle Right")).overworld().from(Qf,ci).to(Qf),ui=(new E(c,42,ra,"Tunnel 2a (from entrance to connector)")).cave().connectTo(ti);(new E(c,42,ra,"Tunnel 2b (under bridge, to antidote)")).cave().connect(ui,Aa).chest(rb,23,94);const vi=(new E(c,43,ra,"Tunnel 3a (branch after connector)")).cave().connect(ti),
Mn=(new E(c,43,ra,"Tunnel 3b (right branch)")).cave().connect(vi,Aa),Nn=(new E(c,43,ra,"Tunnel 3c (upper branch)")).cave().connect(vi,Aa);(new E(c,44,ra,"Tunnel 4 (over bridge, to middle)")).cave().connect(Nn).connectTo(Qf);const wi=(new E(c,45,ra,"Tunnel 5a (E-shaped, from right branch)")).cave().connect(Mn).connectTo(Ln);(new E(c,45,ra,"Tunnel 5b (dead-end with herb)")).cave().connect(wi,Aa).chest(Wa,22,83);const On=(new E(c,46,ra,"Tunne; 6a (S-shaped hall, right)")).cave().connect(wi),Pn=(new E(c,
46,ra,"Tunne; 6b (S-shaped hall, middle)")).cave().connect(On,Aa),Qn=(new E(c,46,ra,"Tunnel 6c (S-shaped hall, left)")).cave().connect(Pn,Aa),xi=(new E(c,47,ra,"Prison (hallway)")).cave().connect(Be),Rn=(new E(c,48,ra,"Left Cell (shopkeepers)")).cave().from(xi,Aa);(new E(c,49,ra,"Left Cell 2 (back, with prison key)")).cave().from(Rn,Aa).chest(Ef,13);const Sn=(new E(c,50,ra,"Right Cell (villagers)")).cave().from(xi,Aa),Tn=(new E(c,51,ra,"Tunnel 8 (behind right cell, toward summit)")).cave().from(Sn,
Aa);(new E(c,52,ra,"Tunnel 9 (connector to summit)")).cave().connect(Tn).connectTo(Pf);const Un=(new E(c,53,ra,"Summit Cave (front)")).cave().from(Pf,Ef).to(Pf),Vn=(new E(c,53,ra,"Summit Cave (behind ice)")).cave().connect(Un,Aa).trigger(pm);(new E(c,56,ra,"Tunnel 1 (leads from main entrance)")).cave().connect(Ae).connectTo(ui);(new E(c,57,ra,"Tunnel 7 (to upper)")).cave().connect(Qn).connectTo(Be);const Wn=(new E(c,60,we,"Inn")).shop(),Xn=(new E(c,61,we,"Tool Shop")).shop(Wa,rb,wb,Db),Yn=(new E(c,
62,we,"Back Room")).house(),Rf=(new E(c,64,yc,"Summit")).overworld().connect(Vn,ln),Ce=(new E(c,64,yc,"Northwest")).overworld().from(Rf).to(Rf,La),Zn=(new E(c,64,yc,"Northeast")).overworld().connect(Ce,ha),yi=(new E(c,65,yc,"Southwest")).overworld().connect(Ce),$n=(new E(c,65,yc,"Southeast")).overworld().connect(yi,ha),zi=(new E(c,66,yc,"Lime Tree Valley")).overworld().connect(yi).connect(Xd,eb),ao=(new E(c,67,yc,"Lime Tree Lake (Rage)")).cave().connect(zi).trigger(Sh,Sa),bo=(new E(c,68,Ac,"Tunnel 1a (entrance)")).cave().connect($n),
co=(new E(c,68,Ac,"Tunnel 1b (behind wall)")).cave().connect(bo,za),Ai=(new E(c,69,Ac,"Tunnel 2a (main path, before wall)")).cave().connect(co);(new E(c,69,Ac,"Tunnel 2b (dead end, antidote)")).cave().connect(Ai,za).chest(rb,25,95);const eo=(new E(c,69,Ac,"Tunnel 2c (main path, after wall)")).cave().connect(Ai,za),fo=(new E(c,70,Ac,"Tunnel 3a (last room, before wall)")).cave().connect(eo),go=(new E(c,70,Ac,"Tunnel 3b (last room, after wall)")).cave().connect(fo,za);(new E(c,71,Ac,"Meadow")).overworld().connect(go).chest(Ch,
14);const ho=(new E(c,72,Na,"Tunnel 1a (entrance)")).cave().connect(Zn),Bi=(new E(c,72,Na,"Tunnel 1b (past wall)")).cave().connect(ho,za);(new E(c,72,Na,"Tunnel 1c (dead end, lysisPlant)")).cave().connect(Bi,za).chest(pd,24);const io=(new E(c,73,Na,"Tunnel 2 (tiny connector)")).cave().connect(Bi),Ci=(new E(c,74,Na,"Tunnel 3a (upper branch)")).cave().connect(io);(new E(c,74,Na,"Tunnel 3b (dead end, mimic)")).cave().connect(Ci,za).chest(xb,21,112);const Di=(new E(c,74,Na,"Tunnel 3c (short passage with mimic)")).cave().connect(Ci,
za).chest(xb,22,113),jo=(new E(c,74,Na,"Tunnel 3d (lower branch)")).cave().connect(Di,za);(new E(c,75,Na,"Dead end loop")).cave().connect(jo);const Ei=(new E(c,76,Na,"Tunnel 4a (right branch over bridge)")).cave().connect(Di),ko=(new E(c,76,Na,"Tunnel 4b (past wall over bridge)")).cave().connect(Ei,za),lo=(new E(c,77,Na,"Tunnel 5a (from left branch)")).cave().connect(Ei),mo=(new E(c,77,Na,"Tunnel 5b (reconvergence)")).cave().connect(lo,za).connect(ko),no=(new E(c,77,Na,"Tunnel 5c (between walls)")).cave().connect(mo,
za),oo=(new E(c,77,Na,"Tunnel 5d (under bridge)")).cave().connect(no,za),po=(new E(c,78,Na,"Tunnel 6a (over second bridge)")).cave().connect(oo),qo=(new E(c,78,Na,"Tunnel 6b (past wall)")).cave().connect(po,za),ro=(new E(c,79,Na,"Tunnel 7a (under second bridge)")).cave().connect(qo);(new E(c,79,Na,"Tunnel 7b (fog lamp)")).cave().connect(ro,za).chest(xh,19);const bd=(new E(c,80,Ia,"Town")).town().connect(Ce),Fi=(new E(c,81,Ia,"Fishherman Island")).town().connect(bd);(new E(c,82,yc,"Mesia Shrine")).cave().trigger(Th).connect(ao,
ha,Sh);const Gi=(new E(c,84,zc,"Tunnel 1a (entrance)")).cave().connect(Ce);(new E(c,84,zc,"Tunnel 1b (dead end, mimic)")).cave().connect(Gi,Aa).chest(xb,19,114);const so=(new E(c,84,zc,"Tunnel 1c (past ice)")).cave().connect(Gi,Aa),to=(new E(c,85,zc,"Tunnel 2 (stoned pair)")).cave().connect(so),Sf=(new E(c,86,zc,"Tunnel 3 (wide medusa hallways)")).cave().connect(to,Om),uo=(new E(c,87,zc,"Tunnel 4a (left entrance)")).cave().from(Sf,Aa).chest(pe.chest().bonus(),25).trigger(rm,Bf);(new E(c,87,zc,"Tunnel 4b (right entrance)")).cave().from(Sf,
Aa).connect(uo,La);(new E(c,87,zc,"Tunnel 4c (sword of water)")).cave().connect(Sf,Aa).chest(Sa,24);const Hi=(new E(c,88,kc,"Entrance")).misc(),vo=(new E(c,89,kc,"Level 1")).misc().from(Hi),wo=(new E(c,90,kc,"Level 2")).misc().from(vo),xo=(new E(c,91,kc,"Level 3")).misc().from(wo),Ii=(new E(c,92,kc,"Outside Mesia Room")).misc().from(xo),yo=(new E(c,93,kc,"Outside Dyna Room")).misc().from(Ii,Nb);(new E(c,94,kc,"Mesia")).misc().connect(Ii).trigger(Cm);const zo=(new E(c,95,kc,"Dyna")).misc().from(yo).boss(kn);
(new E(c,95,kc,"Win")).misc().from(zo).end();const Tf=(new E(c,96,Zc,"Cabin Beach")).sea().from(Fi,Jf),yd=(new E(c,96,Zc,"South")).sea().connect(Tf,ic),Ao=(new E(c,96,Zc,"Joel Beach")).sea().connect(yd,ic),Ji=(new E(c,96,Bc,"Outside Lighthouse")).sea();(new E(c,96,Zc,"Altar")).sea().connect(yd,ic).trigger(Kf,Ah,zh);const Bo=(new E(c,96,Zc,"North")).sea().to(yd,ic).from(yd,ic,Mm).trigger(um,Vm),Co=(new E(c,96,Zc,"Swan Beach")).sea().connect(Bo,ic);(new E(c,97,Zc,"Cabin")).misc().connect(Tf).trigger(Wh,
Jf);(new E(c,98,Bc,"Lighthouse")).misc().connect(Ji).trigger(tm,Df);const De=(new E(c,100,Ia,"Underground Channel 1 (from throne room)")).sea().trigger(Rh),Do=(new E(c,100,Ia,"Underground Channel 2 (to fortune teller)")).sea().connect(De,ha),Ki=(new E(c,100,Ia,"Underground Channel 3 (from fortune teller)")).sea().connect(De,La),Li=(new E(c,100,Ia,"Underground Channel 4 (asina)")).sea().connect(Ki,ha),Eo=(new E(c,100,Ia,"Underground Channel 5 (dolphin)")).sea().connect(Li,ha).trigger(Vh,Wa,Uh);(new E(c,
100,Ia,"Underground Channel 6 (water)")).sea().connect(Eo,ic).connectTo(yd,ic).chest(Bh,17);const Uf=(new E(c,101,jb,"Zombie Town")).town(),Fo=(new E(c,104,jb,"Tunnel 1 (entrance)")).sea().connect(yd,Xh,ic),Mi=(new E(c,105,jb,"Tunnel 2a (start)")).cave().connect(Fo);(new E(c,105,jb,"Tunnel 2b (dead end to left)")).cave().connect(Mi,ha);const Go=(new E(c,105,jb,"Tunnel 2c (across first river)")).cave().connect(Mi,ha),Ni=(new E(c,105,jb,"Tunnel 2d (across second river)")).cave().connect(Go,ha);(new E(c,
105,jb,"Tunnel 2e (dead end, magic ring)")).cave().connect(Ni,za).chest(Sb,29);const Ho=(new E(c,105,jb,"Tunnel 2f (stair down)")).cave().connect(Ni,za),Io=(new E(c,106,jb,"Tunnel 3a (main area)")).cave().connect(Ho).connectTo(Uf).chest(pd,25,92),Jo=(new E(c,106,jb,"Tunnel 3b (left area toward items)")).cave().connect(Io,za),Ko=(new E(c,107,jb,"Tunnel 4a (right side, mimic)")).cave().connect(Jo).chest(xb,14,115);(new E(c,107,jb,"Tunnel 4b (left side, iron necklace)")).cave().connect(Ko,ha).chest(fm,
15);const Vf=(new E(c,108,Cc,"Floor 1")).fortress().connect(Uf),Lo=(new E(c,108,Cc,"Miniboss")).fortress().boss(an).connect(Vf);(new E(c,109,Cc,"Floor 2a (left stair)")).fortress().connect(Vf).chest(wb,19);const Mo=(new E(c,109,Cc,"Floor 2b (right stair)")).fortress().connect(Lo).chest(Wa,30,85),No=(new E(c,110,Cc,"Floor 3a (toward boss)")).fortress().connect(Mo),Oi=(new E(c,110,Cc,"Floor 3b (boss room)")).fortress().connect(No);(new E(c,110,Cc,"Boss")).fortress().boss(li).connect(Oi);(new E(c,110,
Cc,"Floor 3c (back room trap)")).fortress().from(Oi).to(Vf);const Oo=(new E(c,112,Bc,"Secret Passage")).cave().connectTo(Ji),Ee=(new E(c,113,Bc,"Town")).town().connect(Ao),lc=(new E(c,114,Ub,"Town")).town().connect(Co),Po=(new E(c,115,Ub,"Inside Gate")).overworld().connect(lc),Qo=(new E(c,115,Ub,"Outside Gate")).overworld().from(Po,Xc),Fe=(new E(c,120,ad,"Valley")).overworld().connect(Qo),Wf=(new E(c,124,Fa,"Entrance")).overworld().connect(Fe),Ro=(new E(c,124,Fa,"Over first river toward Shyron")).overworld().connect(Wf,
ha),Pi=(new E(c,124,Fa,"After first tunnel")).overworld(),Qi=(new E(c,124,Fa,"Door to Styx")).overworld().connect(Pi,ha),So=(new E(c,124,Fa,"Dead end (no item)")).overworld(),To=(new E(c,124,Fa,"Dead end (fruit of lime)")).overworld().chest(yf,26),Uo=(new E(c,124,Fa,"Dead end (magic ring)")).overworld().chest(Sb,25,101),Ri=(new E(c,124,Fa,"Outside tunnel to bow")).overworld();(new E(c,124,Fa,"Floating island (bow of sun)")).overworld().connect(Ri,La).chest(Eh,24);const Vo=(new E(c,125,Fa,"Tunnel 1 (to Shyron)")).cave().connect(Ro),
Wo=(new E(c,126,Fa,"Outside Shyron")).overworld().connect(Vo);(new E(c,127,Fa,"Tunnel 2 (fork)")).cave().connect(Wf).connectTo(To).connectTo(Pi);const Si=(new E(c,128,Fa,"Tunnel 3 (caves)")).cave().connect(Qi).connect(So),Ti=(new E(c,129,Fa,"Tunnel 4 (left branch of cave)")).cave().connect(Si);(new E(c,130,Fa,"Tunnel 5 (dead end, medical herb)")).cave().connect(Ti).chest(Wa,15,86);const Xo=(new E(c,131,Fa,"Tunnel 6a (left-then-right)")).cave().connect(Ti),Yo=(new E(c,131,Fa,"Tunnel 6b (past wall)")).cave().connect(Xo,
za),Zo=(new E(c,132,Fa,"Tunnel 7 (wide hall)")).cave().connect(Yo);(new E(c,133,Fa,"Tunnel 8 (red slimes)")).cave().from(Zo,za).connectTo(Ri).chest(xb,23,116);const $o=(new E(c,134,Fa,"Tunnel 9 (right branch, infinite loop)")).cave().connect(Si),ap=(new E(c,135,Fa,"Tunnel 10a (toward magic ring)")).cave().connect($o);(new E(c,135,Fa,"Tunnel 10b (past wall)")).cave().connect(ap,za).connectTo(Uo);const Ui=(new E(c,136,$c,"Entrance")).fortress().from(Qi,wh,Mf),bp=(new E(c,137,$c,"Left branch")).fortress().connect(Ui).chest(xb,
19,117),cp=(new E(c,137,$c,"Left branch, past one bridge")).fortress().connect(bp,ha),dp=(new E(c,137,$c,"Left branch, past two bridges")).fortress().connect(cp,ha).chest(Wa,29,87),ep=(new E(c,137,$c,"Right branch")).fortress().connect(Ui);(new E(c,137,$c,"Right branch, across water")).fortress().connect(ep,La).chest(xb,20,118).chest(xb,21,119).chest(Rb,28);(new E(c,138,$c,"Upper floor")).fortress().connect(dp).chest(Ta,27);const zd=(new E(c,140,Dc,"Town")).town().connect(Wo,Pm).trigger(Lf),Zd=(new E(c,
142,ad,"Town")).town().connect(Fe),Vi=(new E(c,143,bb,"Draygonia Fortress Basement 1 (front)")).fortress();(new E(c,143,bb,"Draygonia Fortress Basement 2 (power ring)")).fortress().connect(Vi,qd).chest(dm,15);const Xf=(new E(c,144,ad,"Desert 1")).overworld().connect(Fe),Ge=(new E(c,145,bb,"Area 1 (from entrance)")).cave().chest(th,26),Wi=(new E(c,145,bb,"Area 2 (across top bridge)")).cave().connect(Ge,ha);(new E(c,145,bb,"Area 3 (dead-end across top-right bridge)")).cave().connect(Wi,ha);const fp=
(new E(c,145,bb,"Area 4 (left across middle-right bridge)")).cave().connect(Wi,ha),gp=(new E(c,145,bb,"Area 5 (bottom edge)")).cave().connect(fp,ha),hp=(new E(c,145,bb,"Area 6 (bottom island)")).cave().connect(gp,ha),ip=(new E(c,145,bb,"Area 7 (bottom inner ring)")).cave().connect(hp,ha),jp=(new E(c,145,bb,"Area 8 (left outer ring)")).cave().connect(ip,ha).connect(Ge,ha).chest(wb,27,100),kp=(new E(c,145,bb,"Area 9 (top left inner ring)")).cave().connect(jp,ha),lp=(new E(c,145,bb,"Area 10 (top right inner ring)")).cave().connect(kp,
ha);(new E(c,145,bb,"Area 11 (center)")).cave().connect(lp,ha).connectTo(Vi);(new E(c,145,bb,"Area 12 (top center islands)")).cave().connect(Ge,La).chest(bm,28);const mp=(new E(c,146,Wb,"Desert Cave 1")).cave().connect(Xf,La),Ad=(new E(c,147,Wb,"Town")).town(),np=(new E(c,148,Wb,"Outside Cave")).overworld().connect(Ad),op=(new E(c,149,Wb,"Desert Cave 2")).cave().connect(np);(new E(c,150,Wb,"Meadow")).overworld().connect(mp).connectTo(Ad).trigger(zm,Xc,Xm);const Yf=(new E(c,152,Wb,"Desert 2")).overworld().connect(op),
pp=(new E(c,156,vd,"Entrance")).fortress().connect(Yf,La),qp=(new E(c,156,vd,"Azteca")).fortress().trigger(Bm),rp=(new E(c,157,vd,"Fork")).fortress().connect(pp),Xi=(new E(c,158,vd,"Main")).fortress().connect(rp);(new E(c,158,vd,"Treasure Chest (magic ring)")).fortress().connect(Xi).chest(Sb,27,108);(new E(c,159,vd,"Draygon")).fortress().connect(Xi).to(qp).boss(gn);const sp=(new E(c,160,jc,"Entrance")).fortress().connect(Yf,La),tp=(new E(c,160,jc,"Statues")).fortress().connect(sp).boss(hn),up=(new E(c,
161,jc,"Hall 1")).fortress().connect(tp),Zf=(new E(c,162,jc,"Branch")).fortress().connect(up);(new E(c,163,jc,"Left Dead End")).fortress().connect(Zf).chest(xb,13,120);(new E(c,164,jc,"Right Dead End")).fortress().connect(Zf);const vp=(new E(c,165,jc,"Hall 2")).fortress().connect(Zf).chest(Af,26,109),wp=(new E(c,166,jc,"Draygon 2")).fortress().connect(vp).boss(jn);(new E(c,167,jc,"Teleporter")).fortress().from(wp).to(Hi);const Yi=(new E(c,168,xe,"Entrance")).fortress().connect(Zd,Mf).trigger(ai,Ta),
xp=(new E(c,169,xe,"Main")).fortress().from(Yi,qd),yp=(new E(c,169,xe,"Boss")).fortress().connect(xp).boss(cn),zp=(new E(c,170,xe,"Zebu")).fortress().connect(yp),He=(new E(c,171,Vb,"Entrance")).fortress().connect(zp);(new E(c,171,Vb,"Dead End Behind Iron (fruit of power)")).fortress().connect(He,qd).chest(wb,28,98);(new E(c,171,Vb,"Dead End Loop Across Closer Bridges")).fortress().connect(He,ha).connect(He,ha);const Ap=(new E(c,171,Vb,"Across First Bridge (fruit of repun)")).fortress().connect(He,
ha).chest(zf,30,102),$f=(new E(c,171,Vb,"Across Second Bridge")).fortress().connect(Ap,ha);(new E(c,171,Vb,"Dead End Across Two Bridges ()")).fortress().connect($f,ha).connect($f,ha).chest(pd,29,93);const Bp=(new E(c,171,Vb,"Across Third Bridge")).fortress().connect($f,ha),Cp=(new E(c,171,Vb,"Exit Behind Iron Door")).fortress().connect(Bp,qd),Dp=(new E(c,172,Vb,"Boss")).fortress().connect(Cp).boss(dn),Ep=(new E(c,172,Vb,"Tornel")).fortress().connect(Dp),Zi=(new E(c,173,ud,"Lower")).fortress().connect(Ep).chest(Af,
26,99).chest(Sb,27,111),Fp=(new E(c,174,ud,"Upper Loop")).fortress().connect(Zi).chest(rb,22,96);(new E(c,174,ud,"Upper Loop Behind Wall (magic ring)")).fortress().connect(Fp,qd).chest(Sb,23,107);const Gp=(new E(c,175,ud,"Upper Passage (toward Mado)")).fortress().connect(Zi).chest(Sb,27,84),ag=(new E(c,176,yb,"Initial Fork")).fortress(),Hp=(new E(c,177,yb,"Left Branch")).fortress().connect(ag),$i=(new E(c,178,yb,"Main Area (right branch, over bridges)")).fortress().connect(ag),Ip=(new E(c,179,yb,
"U-shaped Passage (between floors)")).fortress().connect($i),Jp=(new E(c,180,yb,"Main Area Lower (under bridge)")).fortress().connect(Hp).connect($i).connect(Ip),aj=(new E(c,180,yb,"Behind Iron Wall")).fortress().connect(Jp,qd),Kp=(new E(c,181,yb,"Lower")).fortress().connect(aj).chest(xb,13,121).chest(xb,14,122).chest(xb,15,123).chest(Sb,23,88).chest(Db,24,110),Lp=(new E(c,182,yb,"Boss Corridor")).fortress().connect(Kp),Mp=(new E(c,182,yb,"Boss")).fortress().connect(Lp,Mf).boss(fn);(new E(c,182,yb,
"Behind Boss (stormBracelet)")).fortress().connect(Mp).chest(uc,18);const bj=(new E(c,183,yb,"Exit Stairs")).fortress(),Np=(new E(c,184,bb,"Entrance Back (behind river)")).cave().connect(bj).chest(wb,13,90);(new E(c,184,bb,"Entrance Front")).cave().connect(Np,La).connectTo(Xf).connectTo(Ge);const Op=(new E(c,185,ud,"Boss")).fortress().connect(Gp).boss(en);(new E(c,185,ud,"Asina")).fortress().connect(Op).connectTo(ag);(new E(c,186,yb,"Kensu")).fortress().connect(aj).connectTo(bj).trigger(ym,Gf);(new E(c,
187,ad,"House")).house().connect(Zd).trigger(Am,Xc,Gf);(new E(c,188,ad,"Inn")).shop().connect(Zd,Lf);(new E(c,190,ad,"Tool Shop")).shop(Wa,rb,Db,wb).connect(Zd,Lf);(new E(c,191,ad,"Tavern")).shop().connect(Zd);(new E(c,192,Tb,"Elder House")).house().connect(Ec).trigger(Ih);(new E(c,193,Tb,"Rabbit Hut")).house().connect(Ec).trigger(Oh,Nh,xc);(new E(c,194,Tb,"Inn")).shop().connect(Ec);(new E(c,195,Tb,"Tool Shop")).shop(Wa,rb,Db,wb).connect(Ec);(new E(c,196,Tb,"Armor Shop")).shop(Wc,Vc).connect(Ec);
(new E(c,197,Tb,"Student House")).house().connect(Ec).trigger(Jh);(new E(c,198,sd,"Tavern")).house().connect(Yd);(new E(c,199,sd,"Pawn Shop")).shop().connect(Yd);(new E(c,200,sd,"Inn")).shop().connect(Yd);(new E(c,201,sd,"Armor Shop")).shop(wc,Vc,vc).connect(Yd);(new E(c,203,sd,"Tool Shop")).shop(Wa,rb,Db).connect(Yd);(new E(c,205,Wd,"Elder House")).house().from(ze,xc).trigger(nm,If);(new E(c,206,Wd,"Mother's House")).house().from(ze,xc).trigger(Mh,xc).trigger(mm,If);(new E(c,207,Wd,"Tool Shop")).shop(Wa,
rb,wb).from(ze,xc);(new E(c,208,Wd,"Inn")).shop().from(ze,xc);(new E(c,209,td,"Inn")).shop().connect(ye);(new E(c,210,td,"Tool Shop")).shop(Db,wb,pd).connect(ye);(new E(c,211,td,"Armor Shop")).shop(ph,O,pe,ib).connect(ye);const Pp=(new E(c,212,td,"Queen's House")).house().from(ye,Qm).trigger(wm,Xc,Ch);(new E(c,213,we,"Nadare's")).house().connect(Ae).connectTo(Wn).connectTo(Xn).connectTo(Yn);(new E(c,214,Ia,"Fisherman's House")).house().connect(Fi).trigger(Jf,xh,Ff,Rm);const bg=(new E(c,215,Ia,"Palace Entrance")).house().connect(bd);
(new E(c,216,Ia,"Fortune Teller Front")).house().connect(bd).trigger(Qh,Ph);(new E(c,216,Ia,"Fortune Teller Back")).house().connect(Do).connect(Ki);(new E(c,217,Ia,"Pawn Shop")).shop().connect(bd);(new E(c,218,Ia,"Armor Shop")).shop($l,ph,O).connect(bd);(new E(c,220,Ia,"Inn")).shop().connect(bd);(new E(c,221,Ia,"Tool Shop")).shop(Wa,pd,yf,Db).connect(bd);(new E(c,222,Ia,"Palace Left")).house().connect(bg);(new E(c,223,Ia,"Palace Throne Room")).house().connect(bg).to(De,Km).from(De).trigger(Ph).trigger(qm,
Qh,Rh);(new E(c,224,Ia,"Palace Right")).house().connect(bg);(new E(c,225,Ia,"Asina's Room")).house().connect(Li).trigger(Uh,di);(new E(c,226,td,"Queen Downstairs")).house().connect(Pp).chest(Qb,13);(new E(c,227,Bc,"Elder's House")).house().connect(Ee).trigger(Xh);(new E(c,228,Bc,"Shed")).house().connect(Ee).to(Oo,yh);(new E(c,229,Bc,"Tool Shop")).shop(Wa,rb,wb,pd).connect(Ee);(new E(c,231,Bc,"Inn")).shop().connect(Ee);const Qp=(new E(c,232,jb,"Zombie Town House")).house().connect(Uf);(new E(c,233,
jb,"Zombie Town Basement")).house().connect(Qp).trigger(sm,li);(new E(c,235,Ub,"Tool Shop")).shop(Wa,rb,wb,Db).connect(lc);(new E(c,236,Ub,"Stom's Hut")).house().connect(lc).trigger(Yh);(new E(c,237,Ub,"Inn")).shop().connect(lc);(new E(c,238,Ub,"Armor Shop")).shop(am,qh,Ea,Va).connect(lc);(new E(c,239,Ub,"Tavern")).house().connect(lc).trigger(Zh,Yh,Ud);(new E(c,240,Ub,"Pawn Shop")).shop().connect(lc);(new E(c,241,Ub,"Dance Hall")).house().connect(lc).trigger($h,Zh,Ud).trigger(vm,$h,Bh);const Rp=(new E(c,
242,Dc,"Temple (pre-massacre)")).fortress().connect(zd).from(Nf,Ta,gb).trigger(xm);(new E(c,242,Dc,"Temple (post-massacre)")).fortress().from(Rp,ai).boss(bn);(new E(c,243,Dc,"Training Hall")).house().connect(zd);(new E(c,244,Dc,"Hospital")).house().connect(zd);(new E(c,245,Dc,"Armor Shop")).shop(qh,ib,Va).connect(zd);(new E(c,246,Dc,"Tool Shop")).shop(Wa,rb,yf,Sb).connect(zd);(new E(c,247,Dc,"Inn")).shop().connect(zd);(new E(c,248,Wb,"Inn")).shop().connect(Ad);(new E(c,249,Wb,"Tool Shop")).shop(rb,
Db,zf,Sb).connect(Ad);(new E(c,250,Wb,"Elder's House")).house().connect(Ad);(new E(c,251,Wb,"Pawn Shop")).house().connect(Ad);const Sp=[Ec,Xd,ni,wd,Of,xd,Rf,zi,Tf,lc,Fe,Wf,Xf,Yi,Yf];for(const a of Sp)a.from(Nf,Fm);return c};class Ve{constructor(a){this.path=void 0===a?"js/":a}read(a){const b=this;return l.asyncExecutePromiseGeneratorFunction(function*(){return a in We?We[a]:yield(yield fetch(b.path+a)).text()})}}const We={};var Xe;(function(a){a.name=function(a){switch(a){case 0:return"N";case 1:return"W";case 2:return"S";case 3:return"E"}throw Error(`Bad direction: ${a}`);};a.all=function(){return[0,1,2,3]};a.North=0;a.West=1;a.South=2;a.East=3})(Xe||(Xe={}));var Ye=Xe;class Ze{constructor(a){var b;this.worlds=a;var c=new Set,d=new Set,e=new Map,f=new Map;for(var g=0;g<a.length;g++){const b=a[g],h=g<<24;for(const a of b.requirements){const [b,e]=a;c.add(h|b);for(const a of e)for(const b of a)d.add(h|b)}for(const a of b.items){const [b,c]=a;f.set(h|b,c)}for(const a of b.slots){const [b,c]=a;e.set(h|b,c)}}this.itemInfos=new Map(f);this.slotInfos=new Map(e);this.progression=new Set(d);for(const a of f.keys())d.add(a);e=new Set;f=new Set;g=new Set;for(var h of d)(c.has(h)?
e:g).add(h);for(var k of c)d.has(k)||f.add(k);this.common=e.size;this.slots=new Ha([...e,...f]);this.items=new Ha([...e,...g]);c=[];d=[];for(h=0;h<a.length;h++){const b=h<<24;for(var p of a[h].requirements){const [a,f]=p;k=this.slots.index(b|a);if(null==k)throw Error(`Provided a non-slot? ${w(a)}`);for(var m of f){e=[...m].map((a)=>{var c;return null!==(c=this.items.index(b|a))&&void 0!==c?c:aa()});(c[k]||(c[k]=[])).push(la.from(e));for(const a of e)(d[a]||(d[a]=new Set)).add(k)}}}for(a=0;a<this.slots.length;a++)c[a]&&
c[a].length||(p=null!==(b=this.slots.get(a))&&void 0!==b?b:NaN,m=this.checkName(p),console.error(`Nothing provided $${w(p)}: ${m} (index ${a})`));this.graph=new Ga(c);this.unlocks=new Ga(d.map(va))}shuffle(a,b,c,d,e){c=void 0===c?20:c;const f=this;return l.asyncExecutePromiseGeneratorFunction(function*(){d&&d.addTasks(Math.floor(c/100));for(var g=0;g<c;g++){d&&99===g%100&&(d.addCompleted(1),yield new Promise(requestAnimationFrame));var h=new Ja;f.prefill(h,b);const m=f.compressFill(h);var k=f.itemPool(m.values(),
b),p=la.from(new Set(k));if(f.fillInternal(m,k,p,b,a,Math.floor(g/5)))if(k=e?[]:void 0,p=f.traverse((a)=>m.get(a),la.of(),k),p.size!==f.slots.length){h=(a)=>`${String(a).padStart(3)} ${f.slots.get(a).toString(16).padStart(3,"0")} ${f.checkName(f.slots.get(a))}`;const a=(a)=>`${String(a).padStart(3)} ${f.items.get(a).toString(16).padStart(3,"0")} ${f.checkName(f.items.get(a))}`;k=new Set([...f.slots].map((a)=>a[0]));for(const a of p)k.delete(a);const b=new Map;for(const c of k)b.set(h(c),f.graph.get(c).map((b)=>
"\n    "+la.bits(b).map(a).join(" & ")).join(""));console.error(`Initial fill never reached slots:\n  ${[...b.keys()].sort().map((a)=>a+b.get(a)).join("\n  ")}`)}else if(f.expandFill(m,h),p=f.fillNonProgression(h,a,b),null!=p){d&&d.addCompleted(Math.floor((c-g)/100));if(e){for(const a of h){const [b,c]=a;g=f.checkName(b).replace(/^[0-9a-f]{3} /,"");e.addSlot(b,g,c)}if(k)for(const a of k){const [b,...c]=a;(b<f.common||m.has(b))&&e.addCheck(f.slots.get(b),c.map((a)=>f.items.get(a)))}}return p}}return null})}fillInternal(a,
b,c,d,e,f){var g;const h=new Set(a.keys());for(var k=b.pop();null!=k;k=b.pop()){if(!la.has(c,k))continue;const m=this.itemInfoFromIndex(k);c=la.without(c,k);var p=this.expandReachable(this.traverse((b)=>a.get(b),c),e);d.shuffle(p);let u=!1;const y=new Set(a.keys());for(const b of p){if(y.has(b))continue;y.add(b);const c=this.slotInfoFromIndex(b);if(c&&this.fits(c,m,e)){a.set(b,k);u=!0;break}}if(!u){y.clear();if(0<f--){for(const f of p)if(!y.has(f)&&a.has(f)&&!h.has(f)&&(y.add(f),(p=this.slotInfoFromIndex(f))&&
this.fits(p,m,e))){k=null!==(g=a.replace(f,k))&&void 0!==g?g:aa();c=la.with(c,k);b.push(k);d.shuffle(b);u=!0;break}if(u)continue}return!1}}return!0}expandReachable(a,b){const c=[];for(const f of a){var d=this.slotInfoFromIndex(f);if(d&&(!b.preserveUniqueChecks()||d.unique)){a=c;var e=f;d=d.weight||1;for(let b=0;b<d;b++)a.push(e)}}return c}itemPool(a,b){a=new Set(a);const c=[];for(const b of this.itemInfos){const [g,k]=b;var d=this.items.index(g);if(null!=d&&this.progression.has(g)&&!a.has(d)){var e=
c,f=k.weight||1;for(let a=0;a<f;a++)e.push(d)}}return b.shuffle(c)}fits(a,b,c){if(c.preserveUniqueChecks()&&b.unique&&!a.unique)return!1;c=b.preventLoss||a.preventLoss;return a.lossy&&b.losable&&c?!1:!0}fillNonProgression(a,b,c){var d=[[],[],[]];const e=[[],[]];for(var f of this.itemInfos){const [c,e]=f;if(!a.hasValue(c)){var g=2;e.losable&&e.preventLoss&&(g=1);b.preserveUniqueChecks()&&e.unique&&(g=0);d[g].push(c)}}for(const b of this.slotInfos){const [c,d]=b;a.has(c)||e[d.lossy&&d.preventLoss?0:
1].push(c)}for(const a of[...d,...e])c.shuffle(a);c=(a)=>this.checkName(a);f=Qa.count(Qa.concat(...e));g=Qa.count(Qa.concat(...d));if(g>f)throw console.log(`Slots ${f}:\n  ${[...Qa.concat(...e)].map(c).join("\n  ")}`),console.log(`Items ${g}:\n  ${[...Qa.concat(...d)].map(c).join("\n  ")}`),Error("Too many items");for(const g of Qa.concat(...d)){d=!1;for(const c of[...e]){if(d)break;for(f=0;f<c.length;f++)if(this.fits(this.slotInfos.get(c[f]),this.itemInfos.get(g),b)){a.set(c[f],g);d=!0;c.splice(f,
1);break}}if(!d)return console.log(`Slots:\n  ${[...Qa.concat(...e)].map(c).join("\n  ")}`),console.error(`REROLL: Could not place item ${c(g)}`),null}return new Map(a)}traverse(a,b,c){b=la.clone(b);const d=new Set,e=new Set;for(var f=0;f<this.slots.length;f++){if(null==this.graph.get(f))throw console.dir(this),a=this.slots.get(f),Error(`Unreachable slot ${null===a||void 0===a?void 0:a.toString(16)}`);e.add(f)}for(const g of e)if(e.delete(g),!d.has(g)){f=this.graph.get(g);if(null==f)throw Error(`Not in graph: ${g}`);
for(let h=0,k=f.length;h<k;h++){if(!la.containsAll(b,f[h]))continue;c&&c.push([g,...la.bits(f[h])]);d.add(g);f=[];g<this.common&&f.push(g);const k=a(g);null!=k&&f.push(k);for(const a of f){b=la.with(b,a);for(const b of this.unlocks.get(a)||[]){if(null==this.graph.get(b))throw console.dir(this),Error(`Adding bad node ${b} from unlock ${a}`);e.add(b)}}break}}return d}expandFill(a,b){for(const c of a){const [d,e]=c;{a=this.slots.get(d);const c=this.items.get(e);if(null==a||null==c)throw Error("missing");
b.replace(a,c)}}}compressFill(a){const b=new Ja;for(const c of a){const [d,e]=c;{a=this.slots.index(d);const c=this.items.index(e);if(null==a||null==c)throw Error(`Bad slot/item: ${d} ${a} ${e} ${c}`);b.set(a,c)}}return b}checkName(a){return this.worlds[a>>>24].checkName(a&16777215)}prefill(a,b){for(let c=0;c<this.worlds.length;c++){const d=c<<24,e=this.worlds[c].prefill(b);for(const b of e){const [c,e]=b;a.set(d|c,d|e)}}}itemInfoFromIndex(a){const b=this.items.get(a);if(null==b)throw Error(`Bad item: ${a}`);
return this.itemInfoFromId(b)}itemInfoFromId(a){const b=this.itemInfos.get(a);if(null==b)throw Error(`Missing info: ${w(a)}`);return b}slotInfoFromIndex(a){const b=this.slots.get(a);if(null==b)throw Error(`Bad slot: ${a}`);return this.slotInfoFromId(b)}slotInfoFromId(a){a=this.slotInfos.get(a);if(null!=a)return a}};function $e(a){return a}(function(a){a.from=function({id:a},{x:c,y:d}){return a<<16|d>>>8<<12|c>>>8<<8|(d>>>4&15)<<4|c>>>4&15};a.add=function(a,c,d){if(c){for(c=(a&240)+(c<<4);240<=c;){if(61440<=(a&61440))return-1;c-=240;a+=4096}for(;0>c;){if(!(a&61440))return-1;c+=240;a-=4096}a=a&-241|c}if(d){for(d=(a&15)+d;16<=d;){if(1792<=(a&3840))return-1;d-=16;a+=256}for(;0>d;){if(!(a&3840))return-1;d+=16;a-=256}a=a&-16|d}return a}})($e||($e={}));var af=$e;var bf;
(function(a){a.trigger=function(a,c){return{*[Symbol.iterator](){let {x:b,y:e}=c;b+=8;for(const c of[-16,0]){const d=b+c;for(const b of[-16,0])yield af.from(a,{x:d,y:e+b})}}}};a.adjust=function(a,...c){const b=new Set;a=[...a];for(const [d,f]of c)for(const c of a)b.add(af.add(c,d,f));return b};a.screen=function(a){const b=[];for(let c=0;240>c;c++)b.push(a&-256|c);return b};a.atLocation=function(a,...c){const b=new Set;a=[...a];for(const d of c)for(const c of a)b.add(c&65535|d.id<<16);return b}})(bf||(bf=
{}));var cf=bf;var df;
(function(a){function b(a){return a instanceof c?[...Qa.map(a,(a)=>[...a])]:a}a.and=function(...a){return[[].concat(...a.map(([a])=>a))]};a.or=function(...c){const d=[];for(const e of c){if(e===a.OPEN)return a.OPEN;e!==a.CLOSED&&d.push(...b(e))}return d.length?d:a.CLOSED};a.meet=function(d,e){if(d===a.OPEN)return b(e);if(e===a.OPEN)return b(d);if(d===a.CLOSED||e===a.CLOSED)return a.CLOSED;const f=new c;for(const a of d)for(const b of e)f.addList([...a,...b]);return b(f)};a.freeze=b;a.label=function(a){return a instanceof
c?a.label():a.map((a)=>a.join("&")).join("|")};a.isOpen=function(a){a=a[Symbol.iterator]();const {value:b,done:c}=a.next();return c||!a.next().done?!1:b[Symbol.iterator]().next().done};a.isClosed=function(a){return!!a[Symbol.iterator]().next().done};a.OPEN=[[]];a.CLOSED=[];class c{constructor(a){this.self=a;this.map=new Map}[Symbol.iterator](){return this.map.values()}addInternal(a,b){for(const a of b)if(Array.isArray(a))throw Error();if(b.has(this.self)||this.map.has(a))return!1;for(const [a,c]of this.map){if(ef(b,
c))return!1;ef(c,b)&&this.map.delete(a)}this.map.set(a,b);return!0}addRoute(a){return this.addInternal(a[ff],a.deps)}addAll(a){for(const b of a)this.addList(b)}addList(a){a=[...new Set(a)].sort();const b=new Set(a);this.addInternal(a.join("&"),b)}restrict(a){const b=[...this.map.values()];this.map.clear();for(const c of b)for(const b of a)this.addList([...c,...b])}label(){return[this.map.keys()].join("|")}}a.Builder=c})(df||(df={}));
function ef(a,b){if(a.size<b.size)return!1;for(const c of b)if(!a.has(c))return!1;return!0}const ff=Symbol("depsLabel");class gf{constructor(a,b){this.target=a;a=[...new Set(b)].sort();this.deps=new Set(a);this[ff]=a.join("&");this.label=`${this.target}:${this[ff]}`}}var F=df;function hf(a){return a}(function(a){a.from=(a,c)=>"number"!==typeof a&&c?a.id<<8|c.y>>>8<<4|c.x>>>8:Number(a)>>>8;a.fromTile=function(a){return a>>>8}})(hf||(hf={}));var jf=hf;class kf{constructor(a){this.rom=a;this.tiles=new n((a)=>lf(this.rom,a));this.bosses=new n((a)=>new mf(a));this.statues=new Map;this.flags=new n((a)=>new n((b)=>new n((c)=>new nf(a,b,c))));this.meets=new n((a)=>new n((b)=>new of(a,b)));this._seamless=new n((a)=>new pf(a))}tile(a){return a&4?void 0:this.tiles.get(a)}boss(a){return this.bosses.get(a)}statue(a){const b=F.label(a);let c=this.statues.get(b);c||this.statues.set(b,c=new qf(a));return c}flag(a,b,c){a||(a=rf);return this.flags.get(a).get(b).get(c)}meet(a,
b){return this.meets.get(a).get(b)}seamless(a){return this._seamless.get(a)}label(a,b){return a.label?a.label(b):"Terrain"}}var sf;(function(a){a.FLY=2;a.BLOCKED=4;a.SLOPE=32;a.BITS=38;a.SWAMP=256;a.BARRIER=512;a.SLOPE8=1024;a.SLOPE9=2048;a.DOLPHIN=4096;a.label=function(a,c){var b,e;return null!==(e=null===(b=a.label)||void 0===b?void 0:b.call(a,c))&&void 0!==e?e:"Terrain"}})(sf||(sf={}));
class pf{constructor(a){this._delegate=a;this.enter=a.enter;this.exit=a.exit}label(a){return`Seamless(${sf.label(this._delegate,a)})`}}class tf{constructor(a,b=F.OPEN){this.enter=a;this.exit=[[15,b]]}get kind(){return"Simple"}label(a){const b=[];F.isOpen(this.enter)||b.push(`enter = ${uf(this.enter,a)}`);F.isOpen(this.exit[0][1])||b.push(`exit = ${uf(this.exit[0][1],a)}`);return`${this.kind}(${b.join(", ")})`}}
class vf{constructor(a,b){this.enter=a;this.exit=b?[[11,b],[4,F.OPEN]]:[[15,F.OPEN]]}get kind(){return"South"}label(a){if(1===this.exit.length)return tf.prototype.label.call(this,a);const b=[];F.isOpen(this.enter)||b.push(`enter = ${uf(this.enter,a)}`);F.isOpen(this.exit[0][1])||b.push(`other = ${uf(this.exit[0][1],a)}`);F.isOpen(this.exit[1][1])||b.push(`south = ${uf(this.exit[1][1],a)}`);return`${this.kind}(${b.join(", ")})`}}
function lf(a,b){let c=F.OPEN,d=void 0;b&sf.DOLPHIN&&b&sf.FLY?(b&sf.SLOPE&&(d=a.flags.ClimbWaterfall.r),c=[[a.flags.CurrentlyRidingDolphin.c],[a.flags.Flight.c]]):(b&sf.SLOPE9?d=a.flags.ClimbSlope9.r:b&sf.SLOPE8?d=a.flags.ClimbSlope8.r:b&sf.SLOPE&&(d=a.flags.Flight.r),b&sf.FLY&&(c=a.flags.Flight.r));b&sf.SWAMP&&(c=c.map((b)=>[a.flags.TravelSwamp.c,...b]));b&sf.BARRIER&&(c=c.map((b)=>[a.flags.ShootingStatue.c,...b]));return new vf(c,d)}
class mf extends tf{constructor(a){super(F.OPEN,[[a]]);this._flag=a}get kind(){return"Boss"}}class qf extends vf{constructor(a){super(F.OPEN,a);this._req=a}get kind(){return"Statue"}}class nf extends tf{constructor(a,b,c){if(1!==a.exit.length||1!==c.exit.length)throw Error("bad flag");const d=[[b]],e=0<=b?F.meet(c.enter,d):c.enter;b=0<=b?F.meet(c.exit[0][1],d):c.exit[0][1];super(F.or(a.enter,e),F.or(a.exit[0][1],b))}get kind(){return"Flag"}}const rf=new tf(F.CLOSED,F.CLOSED);
function wf(a){const b=[];for(var c=0;c<a.exit.length;c++)for(let d=0;4>d;d++)a.exit[c][0]&1<<d&&(b[d]=c);for(c=0;4>c;c++)if(null==b[c])throw Error(`Bad terrain: ${a.exit.map((a)=>a[0]).join(",")}`);return b}
class of{constructor(a,b){this.left=a;this.right=b;const c=wf(a),d=wf(b),e=new Set,f=[];for(let a=0;4>a;a++)e.add(c[a]<<2|d[a]);for(const c of e){const [d,e]=a.exit[c>>2],[g,m]=b.exit[c&3];f.push([d&g,F.meet(e,m)])}this.enter=F.meet(a.enter,b.enter);this.exit=f}get kind(){return"Terrain"}label(a){if(1===this.exit.length)return tf.prototype.label.call(this,a);const b=[];F.isOpen(this.enter)||b.push(`enter = ${uf(this.enter,a)}`);for(const [c,d]of this.exit){const e=[c&1?"N":"",c&2?"W":"",c&4?"S":"",
c&8?"E":""].join("");b.push(`exit${e} = ${uf(d,a)}`)}return`${this.kind}(${b.join(", ")})`}}function uf(a,b){a=[...a];const c=a.map((a)=>Qa.isEmpty(a)?"open":[...a].map((a)=>{var c;return null===(c=b.flags[a])||void 0===c?void 0:c.debug}).join(" & ")).join(") | (");return 1<a.length?`(${c})`:a.length?c:"never"}sf.debugLabel=uf;"object"===typeof window&&(window.debugLabel=uf);var xf=sf;function cg(a){return a}(function(a){a.of=function(a,c){return 16777216*a+c};a.split=function(a){return[Math.floor(a/16777216),a%16777216]}})(cg||(cg={}));var dg=cg;var eg,fg=eg||(eg={});fg[fg.WIND=0]="WIND";fg[fg.FIRE=1]="FIRE";fg[fg.WATER=2]="WATER";fg[fg.THUNDER=3]="THUNDER";var gg=eg;class hg{constructor(a,b,c,d=1){this.rom=a;this._width=c;this._height=b;this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.element.appendChild(this.canvas);this.canvas.width=c;this.canvas.height=b;this.ctx=this.canvas.getContext("2d")||aa();this._minX=this._minY=Infinity;this._maxX=this._maxY=-Infinity;this.palettes=new Uint32Array(1024);this.layers=v(d,()=>new Uint32Array(c*b));this.data=this.layers[0];for(d=0;256>d;d++)for(let b=0;4>b;b++){const c=ig[a.palettes[d].color(b)];
this.palettes[d<<2|b]=c|4278190080}}useLayer(a){this.data=this.layers[a]||aa(`Bad layer: ${a}`)}resizeWidth(a,b){const c=new Uint32Array(b*this._height),d=Math.min(b,this._width);for(let e=0;e<this._height;e++)c.subarray(e*b,e+b+d).set(a.subarray(e*this._width,e*this._width+d));return c}resizeHeight(a,b){const c=new Uint32Array(this._width*b);b=this._width*Math.min(b,this._height);c.subarray(0,b).set(a.subarray(0,b));return c}get width(){return this._width}set width(a){for(let b=0;b<this.layers.length;b++)this.layers[b]=
this.resizeWidth(this.layers[b],a);this._width=a;this.canvas.width=a}get height(){return this._height}set height(a){for(let b=0;b<this.layers.length;b++)this.layers[b]=this.resizeHeight(this.layers[b],a);this._height=a;this.canvas.height=a}get minX(){return this._minX}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}fill(a){this.data.fill(a)}clear(a){a=null!=a?this.palettes[a<<2]:0;this._minX=this._minY=Infinity;this._maxX=this._maxY=-Infinity;this.layers[0].fill(a);
for(a=1;a<this.layers.length;a++)this.layers[a].fill(0)}toDataUrl(){return this.canvas.toDataURL("image/png")}render(){let a=this.canvas,b=this.ctx;for(let c=0;c<this.layers.length;c++){c&&(a=document.createElement("canvas"),a.width=this.canvas.width,a.height=this.canvas.height,b=a.getContext("2d")||aa());const d=new Uint8Array(this.layers[c].buffer),e=b.getImageData(0,0,this._width,this._height);e.data.set(d);b.putImageData(e,0,0);c&&this.ctx.drawImage(a,0,0)}}rect(a,b,c,d,e){const f=Math.max(0,
b);c=Math.min(this._height,a+c);d=Math.min(this._width,b+d);for(a=Math.max(0,a);a<c;a++)for(b=f;b<d;b++)this.data[a*this._width+b]=e}tile(a,b,c,d){if(!(0>b||0>a||b+8>=this._width||a+8>=this._height)){c=this.rom.patterns[c].flip(d<<6);for(let e=0;8>e;e++){let f=c.pixels[8|e]<<1,g=c.pixels[e];for(let c=7;0<=c;c--){const h=f&2|g&1;f>>>=1;g>>>=1;h&&(this.data[(a+e)*this._width+b+c]=this.palettes[d&1020|h])}}this._minX=Math.min(this._minX,b);this._maxX=Math.max(this._maxX,b+8);this._minY=Math.min(this._minY,
a);this._maxY=Math.max(this._maxY,a+8)}}metatile(a,b,c,d,e=0){var f=this.rom.locations[d];d=[...f.tilePatterns];f.animation&&(d[1]=this.rom.tileAnimations[f.animation].pages[e&7]);var g=[...f.tilePalettes,127];e=this.rom.tilesets[f.tileset];f=g[e.attrs[c]];for(g=0;2>g;g++)for(let h=0;2>h;h++){const k=e.tiles[g<<1|h][c];this.tile(a+(g<<3),b+(h<<3),d[k&128?1:0]<<6|k&127,f<<2)}}metasprite(a,b,c,d,e=0,f=0){d=this.rom.locations[d];var g=this.rom.metasprites[c];c=[64,66,...d.spritePatterns];d=[0,1,...d.spritePalettes];
let h=!1;null!=g.mirrored&&(g=this.rom.metasprites[g.mirrored],h=!0);if(g&&g.used){f&=g.frameMask;for(let [k,p,m,u]of g.sprites[f]){if(128==k)break;k=128>k?k:k-256;p=128>p?p:p-256;u=u+e&255;f=d[m&3]+176&255;g=c[u>>6]<<6|u&63;h&&(k=-8-k,m^=64);this.tile(a+p,b+k,g,f<<2|m>>6)}}}text(a,b,c,d=18){for(let e=0;e<c.length;e++)this.tile(a,b+8*e,c.charCodeAt(e)|3840,d<<2)}}
const ig=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0];const jg=Symbol("[LocationMap data]");
class kg extends hg{constructor(a,b=0){super(a,1,1,4);this.rom=a;this.flags=new Set;this._maxWidth=Infinity;a=a.locations[b];this.width=256*(a.used?a.width:1);this.height=240*(a.used?a.height:1);this.location=a;a=(a)=>{let b=a.offsetX,c=a.offsetY;for(var f=a.target;f&&f!==this.element;)f=f.parentElement;if(f){f=b>>8;var g=Math.floor(c/240);kg.setData(a,{tile:this.location.id<<16|g<<12|f<<8|c-240*g>>4<<4|b-256*f>>4,target:this})}};this.element.addEventListener("mousemove",a);this.element.addEventListener("mousedown",
a);this.element.addEventListener("mouseup",a);this.element.addEventListener("click",a);this.redraw()}static getData(a){return a[jg]}static setData(a,b){a[jg]=b}get id(){return this.location.id}set id(a){this.location=this.rom.locations[a];this.height=240*(this.location.used?this.location.height:1);this.width=256*(this.location.used?this.location.width:1);this.ensureWidth();this.redraw()}get maxWidth(){return this._maxWidth}set maxWidth(a){this._maxWidth=a;this.ensureWidth()}ensureWidth(){if(this.width<=
this._maxWidth)this.element.style.transform="",this.element.style.width="",this.element.style.height="";else{var a=this._maxWidth/this.width,b=50*(1-a);this.element.style.transform=`translate(-${b}%,-${b}%) scale(${a})`;this.element.style.width=`${this.width*a}px`;this.element.style.height=`${this.height*a}px`}}clearOverlay(){this.useLayer(1);this.fill(0);this.useLayer(3);this.fill(0);this.render()}overlayShade(a){this.useLayer(3);this.fill(a)}overlayArea(a,b,c){for(const d of a){if(d>>>16!==this.location.id)continue;
const e=240*(d>>>12&15)+16*(d>>>4&15),f=256*(d>>>8&15)+16*(d&15);null!=c&&(this.useLayer(3),this.rect(e-1,f-1,18,18,0));this.useLayer(1);a.has(af.add(d,-1,0))||this.rect(e-1,f-1,2,18,b);a.has(af.add(d,0,-1))||this.rect(e-1,f-1,18,2,b);a.has(af.add(d,1,0))||this.rect(e+15,f-1,2,18,b);a.has(af.add(d,0,1))||this.rect(e-1,f+15,18,2,b)}}redraw(){this.useLayer(0);this.clear(this.location.tilePalettes[0]);for(var a=0;a<this.location.height;a++)for(var b=0;b<this.location.width;b++)this.drawScreen(this.rom.screens[this.location.screens[a][b]],
a,b);this.useLayer(2);for(const c of this.location.spawns){a=0;let {x:d,y:e}=c;e-=c.yt&240;let f;if(c.isNpc()){b=this.rom.npcs[c.id];if(!b||!b.data)continue;d+=8;e+=12;f=2|b.data[3]}else if(c.isChest())f=170;else if(c.isMonster()){b=this.rom.objects[c.monsterId];if(!b)continue;f=b.metasprite;41==b.action?f=104:[42,94].includes(b.action)&&(f=2|b.data[31])}c.patternBank&&(a+=64);null!=f&&this.metasprite(e,d,f,this.location.id,a)}this.render()}drawScreen(a,b,c){var d;const e=240*b,f=256*c,g=this.rom.tilesets[this.location.tileset];
let h,k=!1;for(const a of this.location.flags)if(a.xs===c&&a.ys===b){h=a.flag;if(null===(d=this.rom.flags[h])||void 0===d?0:d.logic.assumeTrue)k=!0;break}for(b=0;240>b;b+=16)for(c=0;16>c;c++)d=a.tiles[b|c],32>d&&(this.flags.has(h)||k)&&(d=g.alternates[d]),this.metatile(e+b,f+16*c,d,this.location.id,0)}};class lg{constructor(a,b){this.rom=a;this.world=b;this.element=document.createElement("div");this.element.addEventListener("click",(a)=>this.click(a));this.element.addEventListener("mousemove",(a)=>this.move(a));this.renderArea(0)}click(a){if(a=kg.getData(a))if(a=this.world.tiles.get(a.tile),null!=a){if(a.area===this.area){const b=null!=a.exit?this.world.tiles.get(a.exit):null;b&&b.area!==this.area&&(a=b)}a.area&&a.area!==this.area&&this.renderArea(a.area.id)}}move(a){if(a=kg.getData(a)){var b=this.world.tiles.get(a.tile);
null!=b&&(b=null!=b.exit&&!this.area.tiles.has(b.exit),a.target.element.style.cursor=b?"pointer":"default")}}clear(){for(;this.element.childNodes.length;)this.element.childNodes[0].remove()}renderArea(a){var b;this.clear();const c=document.createElement("select");c.appendChild(document.createElement("option"));c.children[0].textContent="Select location";for(const a of this.rom.locations){if(!a.used)continue;const d=null===(b=this.world.locations[a.id])||void 0===b?void 0:b.areas[Symbol.iterator]().next().value;
if(null==d)continue;const f=document.createElement("option");f.textContent=`${w(a.id)} ${a.name}`;f.value=String(d.id);c.appendChild(f)}c.addEventListener("change",()=>{this.renderArea(Number(c.value))});this.element.appendChild(c);this.area=this.world.areas[a];b=document.createElement("pre");b.textContent=`Area ${a}
Locations: ${this.area.locations.size}
Tiles: ${this.area.tiles.size}
Terrain: ${xf.label(this.area.terrain,this.rom)}
Checks:
  ${[...new Set(this.area.checks.map(([a,b])=>`${a.debug}: ${uf(b,this.rom)}`))].join("\n  ")}
Routes:
  ${uf(this.area.routes,this.rom).split(" | ").join("\n  ").replace(/[()]/g,"")}`;this.element.appendChild(b);for(const c of this.area.locations)a=this.rom.locations[c],b=document.createElement("h2"),b.textContent=a.name,this.element.appendChild(b),this.element.appendChild(this.makeLocation(this.area,a))}makeLocation(a,b){const c=new kg(this.rom,b.id);c.maxWidth=574;c.overlayShade(1426063360);for(const d of this.world.locations[b.id].areas)d!==a&&c.overlayArea(d.tiles,4294901760);c.overlayArea(a.tiles,
4278255615,0);c.render();return c.element}};class mg{constructor(a,b){this.rom=a;this.id=b}write(){return[]}toString(){return`${this.constructor.name} $${w(this.id)}`}}class ng extends Array{static get [Symbol.species](){return Array}};class og extends ng{constructor(a){super(44);this.rom=a;this.innBasePrice=20;this.toolShopScaling=Array(48).fill(0);this.armorShopScaling=Array(48).fill(0);for(let b=0;44>b;b++)this[b]=new pg(a,b);if(null!=a.shopDataTablesAddress){const b=a.shopDataTablesAddress+21*a.shopCount+2*a.scalingLevels;this.basePrices=v(73,(c)=>13<=c&&39>c?Qd(a.prg,b+2*(c-13)):0)}else this.basePrices=v(73,(b)=>2*Qd(a.prg,138946+2*b))}armorShops(){return v(11,(a)=>this[4*a])}toolShops(){return v(11,(a)=>this[4*a+1])}inns(){return v(11,
(a)=>this[4*a+2])}pawnShops(){return v(11,(a)=>this[4*a+3])}write(){var a,b,c,d,e,f,g,h;const k=this.rom.assembler();if(this.rescale){var p=function(a){k.export(a);k.label(a)};k.segment("10","fe","ff");k.reloc("ShopData");p("ShopData");p("ArmorShopIdTable");for(const b of this.armorShops())for(var m=0;4>m;m++)k.byte(null!==(a=b.contents[m])&&void 0!==a?a:255);p("ToolShopIdTable");for(const a of this.toolShops())for(m=0;4>m;m++)k.byte(null!==(b=a.contents[m])&&void 0!==b?b:255);p("ArmorShopPriceTable");
for(const a of this.armorShops())for(m=0;4>m;m++)k.byte(Math.round(32*(null!==(c=a.prices[m])&&void 0!==c?c:0)));p("ToolShopPriceTable");for(const a of this.toolShops())for(c=0;4>c;c++)k.byte(Math.round(32*(null!==(d=a.prices[c])&&void 0!==d?d:0)));p("InnPrices");for(const a of this.inns())k.byte(Math.round(32*(null!==(e=a.prices[0])&&void 0!==e?e:0)));p("ShopLocations");for(const a of this)k.byte(a.location);p("ToolShopScaling");k.byte(...this.toolShopScaling);p("ArmorShopScaling");k.byte(...this.armorShopScaling);
p("BasePrices");k.word(...this.basePrices.slice(13,39).map((a)=>null!==a&&void 0!==a?a:0));p("InnBasePrice");k.word(this.innBasePrice)}else{k.segment("10","fe","ff");k.org(40356,"ShopData");for(const a of this.armorShops())for(d=0;4>d;d++)k.byte(null!==(f=a.contents[d])&&void 0!==f?f:255);for(const a of this.armorShops())for(d=0;4>d;d++)k.word(null!==(g=a.prices[d])&&void 0!==g?g:0);for(const a of this.toolShops())for(d=0;4>d;d++)k.byte(null!==(h=a.contents[d])&&void 0!==h?h:255);for(m of this.toolShops())for(d=
0;4>d;d++)k.word(null!==(p=m.prices[d])&&void 0!==p?p:0)}return[k.module()]}}var qg,rg=qg||(qg={});rg[rg.ARMOR=0]="ARMOR";rg[rg.TOOL=1]="TOOL";rg[rg.INN=2]="INN";rg[rg.PAWN=3]="PAWN";const sg=[qg.ARMOR,qg.TOOL,qg.INN,qg.PAWN],tg=[(a)=>a?a:138660,(a,b)=>a?a+4*b:138792,()=>0,()=>0],ug=[4,4,0,0],vg=[(a,b)=>a?a+8*b:138704,(a,b)=>a?a+12*b:138836,(a,b)=>a?a+16*b:138924,()=>0],wg=[4,4,1,0];
class pg extends mg{constructor(a,b){super(a,b);this.type=sg[b&3];this.index=b>>>2;if(a.shopDataTablesAddress)this.location=a.prg[a.shopDataTablesAddress+17*a.shopCount+b];else{b=255;for(let d=0;33>d&&255===b;d++){if(a.prg[139125+d]!==this.index)continue;const e=a.prg[139092+d];for(var c of a.locations[e].spawns)if(4===c.type&&a.objects[c.id].data[25]===32+this.type){b=e;break}}this.location=b}c=a.shopDataTablesAddress?(b)=>a.prg[this.pricesAddress+b]/32:(b)=>Qd(a.prg,this.pricesAddress+2*b);this.contents=
Id(a.prg,this.contentsAddress,ug[this.type]);this.prices=v(wg[this.type],c);this.used=255!==this.location}get contentsAddress(){return tg[this.type](this.rom.shopDataTablesAddress,this.rom.shopCount)+4*this.index}get pricesAddress(){const a=this.rom.shopDataTablesAddress;return vg[this.type](a,this.rom.shopCount)+(a?1:2)*wg[this.type]*this.index}updateShopkeeper(){throw Error("not implemented");}}var xg=qg;class yg{constructor(){this.data=new Map;this.sizes=new Map}find(a){if(a!==a)throw"nan";this.data.has(a)||(this.data.set(a,a),this.sizes.set(a,1));let b;for(;!Object.is(b=this.data.get(a),a);)this.data.set(a,a=this.data.get(b));return a}union(a){this.find(a[0]);for(let b=1;b<a.length;b++){if(a[b]!==a[b])throw"nan";this.unionInternal(a[0],a[b])}}unionInternal(a,b){a=this.find(a);b=this.find(b);if(a!==b){var c=this.sizes.get(a),d=this.sizes.get(b);c<d?(this.sizes.set(b,c+d),this.data.set(a,b)):(this.sizes.set(a,
c+d),this.data.set(b,a))}}sets(){const a=new Map;for(const b of this.data.keys()){const c=this.find(b);let d=a.get(c);d||a.set(c,d=new Set);d.add(b)}return[...a.values()]}map(){const a=new n(()=>new Set);for(const b of this.data.keys()){let c=a.get(this.find(b));a.set(b,c);c.add(b)}return a}roots(){const a=new Set;for(const b of this.data.keys())a.add(this.find(b));return[...a]}};class zg{constructor(a,b,c=!1){this.rom=a;this.flagset=b;this.tracker=c;this.terrainFactory=new kf(this.rom);this.terrains=new Map;this.checks=new n(()=>new Set);this.slots=new Map;this.items=new Map;this.itemUses=new n(()=>[]);this.exits=new Map;this.exitSet=new Set;this.seamlessExits=new Set;this.tiles=new yg;this.neighbors=new n(()=>0);this.routes=new n(()=>new F.Builder);this.routeEdges=new n(()=>new wa);this.requirementMap=new n((a)=>new F.Builder(a));for(const b of a.items)for(const a of b.itemUseData)"expect"===
a.kind?this.itemUses.get(a.want).push([b,a]):"location"===a.kind&&this.itemUses.get(~a.want).push([b,a]);this.aliases=new Map([[a.flags.ChangeAkahana,a.flags.Change],[a.flags.ChangeSoldier,a.flags.Change],[a.flags.ChangeStom,a.flags.Change],[a.flags.ChangeWoman,a.flags.Change],[a.flags.ParalyzedKensuInDanceHall,a.flags.Paralysis],[a.flags.ParalyzedKensuInTavern,a.flags.Paralysis]]);for(const b of a.locations)this.processLocation(b);this.addExtraChecks();this.unionNeighbors();this.recordExits();this.buildNeighbors();
this.addAllRoutes();this.consolidateChecks();this.buildRequirementMap()}addExtraChecks(){const {locations:{Leaf_ToolShop:a,MezameShrine:b,Oak:c,Shyron_ToolShop:d},flags:{AbleToRideDolphin:e,BallOfFire:f,BallOfThunder:g,BallOfWater:h,BallOfWind:k,Barrier:p,BlizzardBracelet:m,BowOfMoon:u,BowOfSun:y,BreakStone:G,BreakIce:A,BreakIron:T,BrokenStatue:ma,BuyHealing:M,BuyWarp:Z,ClimbWaterfall:ea,ClimbSlope8:pa,ClimbSlope9:P,CurrentlyRidingDolphin:ec,Flight:ub,FlameBracelet:ab,FormBridge:Mb,GasMask:pb,GlowingLamp:gb,
InjuredDolphin:Bb,LeadingChild:fc,LeatherBoots:gc,Money:eb,OpenedCrypt:Td,RabbitBoots:hb,Refresh:Ua,RepairedStatue:Ka,RescuedChild:Sa,ShellFlute:Ta,ShieldRing:Nb,ShootingStatue:vb,StormBracelet:hc,Sword:qb,SwordOfFire:Ob,SwordOfThunder:Pb,SwordOfWater:Qb,SwordOfWind:Cb,TornadoBracelet:uc,TravelSwamp:Vc,WildWarp:vc},items:{MedicalHerb:O,WarpBoots:pe}}=this.rom,Ea=this.entrance(b);var ib=this.entrance(c);this.addCheck([Ea],Ag(u,y),[Td.id]);this.addCheck([Ea],Ag(e,Ta),[ec.id]);this.addCheck([ib],Ag(fc),
[Sa.id]);this.addItemCheck([Ea],Ag(gb,ma),Ka.id,{lossy:!0,unique:!0});for(var Va of this.rom.shops)if(Va.location!==a.id&&Va.location!==d.id&&Va.used&&Va.type===xg.TOOL){ib=[af(Va.location<<16|136)];for(var Rb of Va.contents)Rb===O.id?this.addCheck(ib,eb.r,[M.id]):Rb===pe.id&&this.addCheck(ib,eb.r,[Z.id])}Va=Cb.r;Rb=Ob.r;ib=Qb.r;let Wc=Pb.r;if(!this.flagset.orbsOptional()){var wc=Bg(k,uc);const a=Bg(f,ab),b=Bg(h,m),c=Bg(g,hc);Va=F.meet(Va,wc);Rb=F.meet(Rb,a);ib=F.meet(ib,b);Wc=F.meet(Wc,c);if(this.flagset.assumeSwordChargeGlitch()){wc=
function(b){return a.map((a)=>a[0]===b.c?a:[b.c,...a])};const a=F.or(Va,Rb,ib,Wc);Va=wc(Cb);Rb=wc(Ob);ib=wc(Qb);Wc=wc(Pb)}}this.addCheck([Ea],Va,[G.id]);this.addCheck([Ea],Rb,[A.id]);this.addCheck([Ea],ib,[Mb.id]);this.addCheck([Ea],Wc,[T.id]);this.addCheck([Ea],Bg(Cb,Ob,Qb,Pb),[qb.id,eb.id]);this.addCheck([Ea],ub.r,[ea.id]);this.addCheck([Ea],Bg(ub,hb),[pa.id]);this.addCheck([Ea],Bg(ub,hb),[P.id]);this.addCheck([Ea],p.r,[vb.id]);this.addCheck([Ea],pb.r,[Vc.id]);this.flagset.leatherBootsGiveSpeed()&&
this.addCheck([Ea],gc.r,[pa.id]);this.flagset.assumeGhettoFlight()&&this.addCheck([Ea],Ag(ec,hb),[ea.id]);this.flagset.fogLampNotRequired()&&(Va=this.flagset.requireHealedDolphinToRide(),this.addCheck([Ea],Va?Bb.r:[[]],[e.id]));this.flagset.guaranteeBarrier()||this.addCheck([Ea],[[eb.c,M.c],[eb.c,Nb.c],[eb.c,Ua.c]],[vb.id]);this.flagset.assumeFlightStatueSkip()||this.addCheck([Ea],[[eb.c,ub.c]],[vb.id]);this.flagset.guaranteeGasMask()||this.addCheck([Ea],[[eb.c,M.c],[eb.c,Ua.c]],[Vc.id]);this.flagset.assumeWildWarp()&&
this.addCheck([Ea],F.OPEN,[vc.id])}addExtraRoutes(){var a;const {flags:{BuyWarp:b,SwordOfThunder:c,Teleport:d,WildWarp:e},locations:{MezameShrine:f}}=this.rom;this.addRoute(new gf(this.entrance(f),[]));if(this.flagset.teleportOnThunderSword()){var g=this.rom.townWarp.thunderSwordWarp;this.addRoute(new gf(this.entrance(g[0],g[1]&31),[c.c,b.c]));this.addRoute(new gf(this.entrance(g[0],g[1]&31),[c.c,d.c]))}if(this.flagset.assumeWildWarp())for(const b of this.rom.wildWarp.locations){if(b===this.rom.locations.UndergroundChannel.id)continue;
g=this.entrance(b);const c=null!==(a=this.terrains.get(g))&&void 0!==a?a:aa("bad entrance");for(const a of c.enter)this.addRoute(new gf(g,[e.c,...a]))}}consolidateChecks(){for(const [a,b]of this.checks){const c=this.tiles.find(a);if(a!==c){for(const a of b)this.checks.get(c).add(a);this.checks.delete(a)}}}buildRequirementMap(){for(const [a,b]of this.checks)for(const {checks:c,requirement:d}of b)for(const b of c){const c=this.requirementMap.get(b);for(const b of d)for(const d of this.routes.get(a)||
[])c.addList([...b,...d])}}getLocationList(a="Crystalis"){return{worldName:a,requirements:this.requirementMap,items:this.items,slots:this.slots,checkName:(a)=>this.rom.flags[a].name,prefill:(a)=>{const {Crystalis:b,MesiaInTower:d,LeafElder:e}=this.rom.flags,f=new Map([[d.id,b.id]]);this.flagset.guaranteeSword()&&f.set(e.id,512|a.nextInt(4));return f}}}processLocation(a){a.used&&(this.processLocationTiles(a),this.processLocationSpawns(a),this.processLocationItemUses(a))}unionNeighbors(){for(const [b,
c]of this.terrains){var a=af.add(b,0,1);this.terrains.get(a)===c&&this.tiles.union([b,a]);a=af.add(b,1,0);this.terrains.get(a)===c&&this.tiles.union([b,a])}}addAllRoutes(){this.addExtraRoutes();for(const [b,c]of this.neighbors){const [d,e]=dg.split(b);var a=this.terrains.get(d);const f=this.terrains.get(e);if(!a||!f)throw Error(`missing terrain ${w(a?d:e)}`);for(const [b,h]of a.exit)if(b&c)for(const a of h)for(const b of f.enter)this.addRoute(new gf(e,[...a,...b]),d)}"object"===typeof document&&(a=
document.getElementById("debug"))&&a.appendChild((new lg(this.rom,this.getWorldData())).element)}getWorldData(){var a=0;const b=new n(()=>({})),c=v(256,()=>({areas:new Set,tiles:new Set})),d=[];for(var e of this.tiles.sets()){var f=this.tiles.find(Qa.first(e)),g=this.terrains.get(f);if(g&&(f=this.routes.has(f)?F.freeze(this.routes.get(f)):[],f.length)){g={checks:[],id:a++,locations:new Set,routes:f,terrain:g,tiles:new Set};d.push(g);for(const a of e)f=a>>>16,g.locations.add(f),g.tiles.add(a),c[f].areas.add(g),
c[f].tiles.add(a),b.get(a).area=g}}for(const [a,c]of this.exits)b.has(a)&&(b.get(a).exit=c);for(const [c,d]of this.checks)if(a=b.get(c).area)for(const {checks:b,requirement:c}of d)for(const d of b)e=this.rom.flags[d]||aa(),a.checks.push([e,c]);return{tiles:b,areas:d,locations:c}}addRoute(a,b){if(null!=b){this.routeEdges.get(b).add(a);for(var c of this.routes.get(b))this.addRoute(new gf(a.target,[...c,...a.deps]))}else for(b=new wa,c=new wa,b.add(a),a=b[Symbol.iterator]();;){const {value:d,done:e}=
a.next();if(e)break;c.add(d);b.delete(d);const f=new wa,g=d.target;if(this.routes.get(g).addRoute(d))for(const a of this.routeEdges.get(g))f.add(new gf(a.target,[...d.deps,...a.deps]));for(const a of f)c.has(a)||(b.delete(a),b.add(a))}}recordExits(){for(const [a,b]of this.exits)this.exitSet.add(dg.of(this.tiles.find(a),this.tiles.find(b)));for(const a of this.exitSet){const [b,c]=dg.split(a);if(this.terrains.get(b)!==this.terrains.get(c))continue;const d=dg.of(c,b);this.exitSet.has(d)&&(this.tiles.union([b,
c]),this.exitSet.delete(a),this.exitSet.delete(d))}}buildNeighbors(){for(const [c,d]of this.terrains)if(d){var a=af.add(c,1,0),b=this.terrains.get(a);b&&b!==d&&this.handleAdjacentNeighbors(c,a,Ye.North);a=af.add(c,0,1);(b=this.terrains.get(a))&&b!==d&&this.handleAdjacentNeighbors(c,a,Ye.West)}for(const b of this.exitSet){const [c,e]=dg.split(b);this.terrains.has(c)&&this.terrains.has(e)&&(a=dg.of(this.tiles.find(c),this.tiles.find(e)),this.neighbors.set(a,this.neighbors.get(a)|1))}}handleAdjacentNeighbors(a,
b,c){var d=this.tiles.find(a);const e=this.tiles.find(b);this.seamlessExits.has(b)||(b=dg.of(e,d),this.neighbors.set(b,this.neighbors.get(b)|1<<c));this.seamlessExits.has(a)||(a=c^2,d=dg.of(d,e),this.neighbors.set(d,this.neighbors.get(d)|1<<a))}processLocationTiles(a){var b,c,d,e=new Map;const f=new Set,g=88===(a.id&248);for(var h of a.spawns)h.isWall()?e.set(jf.from(a,h),h.id&3):h.isMonster()&&63===h.id&&f.add(jf.from(a,h));h=this.rom.tilesets[a.tileset];const k=this.rom.tileEffects[a.tileEffects-
179],p=(b)=>k.effects[this.rom.screens[a.screens[(b&61440)>>>12][(b&3840)>>>8]].tiles[b&255]],m=(b,c,d)=>{b&=xf.BITS;26===a.id&&(b|=xf.SWAMP);if(96===a.id||104===a.id)b|=xf.DOLPHIN;100===a.id&&4144>(c&61680)&&(b|=xf.DOLPHIN);d&&(b|=xf.BARRIER);if(!(b&xf.DOLPHIN)&&b&xf.SLOPE){for(d=0;p(c)&xf.SLOPE;)c=af.add(c,1,0),d++;6>d?b&=~xf.SLOPE:9>d?b|=xf.SLOPE8:10>d&&(b|=xf.SLOPE9)}return this.terrainFactory.tile(b)};for(let p=0,T=a.height;p<T;p++){const A=a.screens[p],T=a.id<<8|p<<4;for(let p=0,ma=a.width;p<
ma;p++){const ma=this.rom.screens[A[p]],M=jf(T|p),ea=f.has(M),Z=M&255;var u=e.get(M);u=g?this.rom.flags.AlwaysTrue.id:null!=u?this.wallCapability(u):null===(b=a.flags.find((a)=>a.screen===Z))||void 0===b?void 0:b.flag;const ab=null!==(d=null===(c=this.rom.flags[u])||void 0===c?void 0:c.logic)&&void 0!==d?d:{};for(let b=0;240>b;b++){const c=af(M<<8|b);var y=ma.tiles[b];ab.assumeTrue&&32>y&&(y=h.alternates[y]);var G=a.isShop()?0:k.effects[y]&38;G=m(G,c,ea);32>y&&h.alternates[y]!==y&&null!=u&&!ab.assumeTrue&&
!ab.assumeFalse&&(y=m(k.effects[h.alternates[y]],c,ea))&&(G=this.terrainFactory.flag(G,ab.track?u:-1,y));G&&this.terrains.set(c,G)}}}for(const f of a.exits){const {dest:g,entrance:h}=f;b=af.from(a,f);f.isSeamless()?(c=af(b&65535|g<<16),d=af.from(a,f),this.seamlessExits.add(d),(e=this.terrains.get(d))&&this.terrains.set(d,this.terrainFactory.seamless(e))):c=this.entrance(this.rom.locations[g],h&31);this.exits.set(b,c)}}processLocationSpawns(a){for(const b of a.spawns)b.isTrigger()?this.processTrigger(a,
b):b.isNpc()?this.processNpc(a,b):b.isBoss()?this.processBoss(a,b):b.isChest()?this.processChest(a,b):b.isMonster()?this.processMonster(a,b):3===b.type&&224===b.id&&this.processKeyUse(cf.screen(af.from(a,b)),this.rom.flags.UsedWindmillKey.r)}processTrigger(a,b){var c=this.rom.trigger(b.id);if(!c)throw Error(`Missing trigger ${b.id.toString(16)}`);const d=this.filterRequirements(c.conditions);let e=this.filterAntiRequirements(c.conditions);const f=af.from(a,b);let g=cf.trigger(a,b);const h=[];for(const a of c.flags){const b=
this.flag(a);(null===b||void 0===b?0:b.logic.track)&&h.push(b.id)}h.length&&this.addCheck(g,d,h);switch(c.message.action){case 25:134!==c.id||this.flagset.assumeRabbitSkip()?186!==c.id||this.flagset.assumeTeleportSkip()||this.flagset.disableTeleportSkip()||(g=cf.atLocation(g,this.rom.locations.CordelPlainEast,this.rom.locations.CordelPlainWest)):g=cf.adjust(g,[0,-1],[0,1]);this.addTerrain(g,this.terrainFactory.statue(e));break;case 29:this.addBossCheck(g,this.rom.bosses.Mado1,d);break;case 8:case 11:case 12:case 13:case 15:this.addItemGrantChecks(g,
d,c.id);break;case 24:c=this.flagset.chargeShotsOnly()?F.meet(d,Ag(this.rom.flags.WarpBoots)):d;this.addItemCheck(g,c,this.rom.flags.StomFightReward.id,{lossy:!0,unique:!0});break;case 30:this.addItemCheck(g,d,this.rom.flags.MesiaInTower.id,{lossy:!0,unique:!0});break;case 31:this.handleBoat(f,a,d);break;case 27:a===this.rom.locations.Portoa_PalaceEntrance&&(g=cf.adjust(g,[-2,0]),e=this.rom.flags.TalkedToFortuneTeller.r),this.handleMovingGuard(g,a,e)}for(const [c,d]of this.itemUses.get(b.type<<8|
b.id))this.processItemUse([af.from(a,b)],F.OPEN,c,d)}processNpc(a,b){var c,d,e;const f=this.rom.npcs[b.id];if(!f||!f.used)throw Error(`Unknown npc: ${w(b.id)}`);const g=f.spawnConditions.get(a.id)||[];var h=this.filterRequirements(g),k=af.from(a,b);k=[this.terrains.has(k)?k:null!==(c=this.walkableNeighbor(k))&&void 0!==c?c:k];for(const [a,c]of this.itemUses.get(b.type<<8|b.id))this.processItemUse(k,h,a,c);f===this.rom.npcs.SaberaDisguisedAsMesia&&this.addBossCheck(k,this.rom.bosses.Sabera1,h);f.data[2]&
4&&!this.flagset.assumeStatueGlitch()&&(b=this.filterAntiRequirements(g),f===this.rom.npcs.Rage?(k=cf.adjust(k,[2,-1],[2,0],[2,1],[2,2]),k=cf.adjust(k,[0,-6],[0,-2],[0,2],[0,6]),this.flagset.assumeRageSkip()&&(b=void 0)):f===this.rom.npcs.PortoaThroneRoomBackDoorGuard?b=Bg(this.rom.flags.MesiaRecording,this.rom.flags.Paralysis):f===this.rom.npcs.SoldierGuard&&(b=void 0),b&&this.addTerrain(k,this.terrainFactory.statue(b)));f===this.rom.npcs.FortuneTeller&&(k=cf.adjust(k,[0,0],[2,0]));if(!F.isClosed(h)){[[...h]]=
h;for(const a of f.globalDialogs)b=this.flag(~a.condition),null!==b&&void 0!==b&&b.logic.track&&h.push(b.id);a=null!==(e=null!==(d=f.localDialogs.get(a.id))&&void 0!==d?d:f.localDialogs.get(-1))&&void 0!==e?e:[];for(const b of a)d=[...h],e=this.flag(b.condition),(null===e||void 0===e?0:e.logic.track)&&d.push(e.id),this.processDialog(k,f,d,b),d=this.flag(~b.condition),(null===d||void 0===d?0:d.logic.track)&&h.push(d.id)}}processDialog(a,b,c,d){this.addCheckFromFlags(a,[c],d.flags);const e={lossy:!0,
unique:!0};switch(d.message.action){case 8:this.processKeyUse(a,[c]);break;case 20:this.addItemCheck(a,[c],this.rom.flags.SlimedKensu.id,e);break;case 16:this.addItemCheck(a,[c],this.rom.flags.AsinaInBackRoom.id,e);break;case 17:this.addItemCheck(a,[c],256|b.data[1],e);break;case 3:case 10:this.addItemCheck(a,[c],256|b.data[0],e);break;case 9:b=b.data[1];255!==b&&this.addItemCheck(a,[c],256|b,e);break;case 25:this.addItemCheck(a,[c],this.rom.flags.AkahanaFluteOfLimeTradein.id,e);break;case 26:this.addItemCheck(a,
[c],this.rom.flags.Rage.id,e)}}processLocationItemUses(a){for(const [b,c]of this.itemUses.get(~a.id))this.processItemUse([this.entrance(a)],F.OPEN,b,c)}handleMovingGuard(a,b,c){if(!this.flagset.assumeStatueGlitch()){var d=[];for(const a of b.spawns.slice(0,2))if(a.isNpc()&&this.rom.npcs[a.id].isParalyzable()){d.push([this.rom.flags.Paralysis.id]);break}this.addTerrain(a,this.terrainFactory.statue([...c,...d].map(va)))}}handleBoat(a,b,c){const d=this.walkableNeighbor(a);if(null==d)throw Error("Could not find walkable neighbor.");
var e=a>>8&240|a>>4&15;a=a>>4&240|a&15;var f;for(const c of b.exits)c.yt===e&&c.xt<a&&(f=c);if(!f)throw Error("Could not find boat exit");b=this.rom.locations[f.dest];if(!b)throw Error("Bad destination");for(e=f=af.from(b,b.entrances[f.entrance]);;)if(e=af.add(e,0,-1),b=this.walkableNeighbor(e),null!=b){c={enter:F.freeze(c),exit:[[15,F.OPEN]]};this.addTerrain([d],c);this.exits.set(d,b);this.exitSet.add(dg.of(d,b));this.exits.set(f,b);this.exitSet.add(dg.of(f,b));this.terrains.set(f,this.terrainFactory.tile(0));
break}}addItemGrantChecks(a,b,c){const d=this.itemGrant(c),e=256|d;if(null==d)throw Error(`missing item grant for ${c.toString(16)}`);this.addItemCheck(a,b,e,{lossy:!0,unique:!0,preventLoss:128<=c})}addTerrain(a,b){for(const c of a)a=this.terrains.get(c),null!=a&&this.terrains.set(c,this.terrainFactory.meet(a,b))}addCheck(a,b,c){if(!F.isClosed(b)){b={requirement:F.freeze(b),checks:c};for(const c of a)this.terrains.has(c)&&this.checks.get(c).add(b)}}addItemCheck(a,b,c,d){this.addCheck(a,b,[c]);this.slots.set(c,
d);a=this.rom.itemGets[this.rom.slots[c&255]];b=this.rom.items[a.itemId];c=null===b||void 0===b?void 0:b.unique;d=a.isLosable();const e=c||b===this.rom.items.OpelStatue;let f=1;b===this.rom.items.SwordOfWind&&(f=5);b===this.rom.items.SwordOfFire&&(f=5);b===this.rom.items.SwordOfWater&&(f=10);b===this.rom.items.SwordOfThunder&&(f=15);b===this.rom.items.Flight&&(f=15);this.items.set(512|a.id,{unique:c,losable:d,preventLoss:e,weight:f})}addCheckFromFlags(a,b,c){const d=[];for(const a of c)c=this.flag(a),
(null===c||void 0===c?0:c.logic.track)&&d.push(c.id);d.length&&this.addCheck(a,b,d)}walkableNeighbor(a){if(this.isWalkable(a))return a;for(let b of[-1,1]){const c=af.add(a,b,0),d=af.add(a,0,b);if(this.isWalkable(c))return c;if(this.isWalkable(d))return d}}isWalkable(a){return!(this.getEffects(a)&xf.BITS)}ensurePassable(a){var b;return this.isWalkable(a)?a:null!==(b=this.walkableNeighbor(a))&&void 0!==b?b:a}getEffects(a){const b=this.rom.locations[a>>>16];return this.rom.tileEffects[b.tileEffects-
179].effects[this.rom.screens[b.screens[(a&61440)>>>12][(a&3840)>>>8]].tiles[a&255]]}processBoss(a,b){if(201!==b.id&&202!==b.id){var c=195===b.id?this.rom.bosses.Rage:this.rom.bosses.fromLocation(a.id);b=af.from(a,b);if(!c||!c.flag)throw Error(`Bad boss at ${a.name}`);var d=b&-256;a=this.terrainFactory.boss(c.flag.id);b=v(240,(a)=>d|a);this.addTerrain(b,a);this.addBossCheck(b,c)}}addBossCheck(a,b,c=F.OPEN){if(null==b.flag)throw Error(`Expected a flag: ${b}`);c=F.meet(c,this.bossRequirements(b));b===
this.rom.bosses.Draygon2?this.addCheck(a,c,[b.flag.id]):this.addItemCheck(a,c,b.flag.id,{lossy:!1,unique:!0})}processChest(a,b){if(!(112<=this.rom.slots[b.id])){var c=256|b.id,d=this.rom.slots[b.id];112<=d||(d=this.rom.items[d],d=this.flagset.preserveUniqueChecks()?!(null===d||void 0===d||!d.unique):!0,this.addItemCheck([af.from(a,b)],F.OPEN,c,{lossy:!1,unique:d}))}}processMonster(){}processItemUse(a,b,c,d){a=new Set([...a].map((a)=>{var b;return null!==(b=this.walkableNeighbor(a))&&void 0!==b?b:
a}));const e=[[512|c.id]];c.id===this.rom.prg[251061]+28&&e[0].push(this.rom.flags.Change.c);c===this.rom.items.MedicalHerb&&(e[0][0]=this.rom.flags.BuyHealing.c);b=F.meet(b,e);this.addCheckFromFlags(a,b,d.flags);switch(d.message.action){case 16:this.processKeyUse(a,b);break;case 8:case 11:case 12:case 13:case 15:case 28:this.addItemGrantChecks(a,b,c.id);break;case 2:this.addItemCheck(a,b,256|this.rom.npcs[d.want&255].data[1],{lossy:!0,unique:!0})}}processKeyUse(a,b){const [c,...d]=new Set([...a].map((a)=>
jf.from(a)));if(null==c||d.length)throw Error("Expected one screen");const e=this.rom.locations[c>>>8].flags.find((a)=>a.screen===(c&255));if(null==e)throw Error("Expected flag on screen");this.addCheck(a,b,[e.flag])}bossRequirements(a){if(a===this.rom.bosses.Rage)return this.tracker&&this.flagset.randomizeTrades()?this.rom.flags.Sword.r:[[this.rom.npcs.Rage.dialog()[0].condition]];var b=a.object;const c=new F.Builder;if(this.tracker&&this.flagset.shuffleBossElements()||!this.flagset.guaranteeMatchingSword())c.addAll(this.rom.flags.Sword.r);
else{var d=this.flagset.guaranteeSwordMagic()?a.swordLevel:1;b=this.rom.objects[b];for(let a=0;4>a;a++)b.isVulnerable(a)&&c.addAll(this.swordRequirement(a,d))}d=[];null!=a.npc&&null!=a.location&&(b=a.npc.spawns(this.rom.locations[a.location]),d.push(...this.filterRequirements(b)[0]));a===this.rom.bosses.Insect?d.push(this.rom.flags.InsectFlute.c,this.rom.flags.GasMask.c):a===this.rom.bosses.Draygon2&&d.push(this.rom.flags.BowOfTruth.c);this.flagset.guaranteeRefresh()&&d.push(this.rom.flags.Refresh.c);
c.restrict([d]);return F.freeze(c)}swordRequirement(a,b){const c=[this.rom.flags.SwordOfWind,this.rom.flags.SwordOfFire,this.rom.flags.SwordOfWater,this.rom.flags.SwordOfThunder][a];if(1===b)return c.r;a=[[this.rom.flags.BallOfWind,this.rom.flags.TornadoBracelet],[this.rom.flags.BallOfFire,this.rom.flags.FlameBracelet],[this.rom.flags.BallOfWater,this.rom.flags.BlizzardBracelet],[this.rom.flags.BallOfThunder,this.rom.flags.StormBracelet]][a];return 3===b?Ag(c,...a):a.map((a)=>[c.c,a.c])}itemGrant(a){for(const [b,
c]of this.rom.itemGets.actionGrants)if(b===a)return c;throw Error(`Could not find item grant ${a.toString(16)}`);}filterRequirements(a){var b;const c=[];for(const d of a)if(0>d){if(a=null===(b=this.flag(~d))||void 0===b?void 0:b.logic,null===a||void 0===a?0:a.assumeTrue)return F.CLOSED}else{a=this.flag(d);if(null===a||void 0===a?0:a.logic.assumeFalse)return F.CLOSED;(null===a||void 0===a?0:a.logic.track)&&c.push(a.id)}return[c]}filterAntiRequirements(a){var b;const c=[];for(const d of a)if(0<=d){if(a=
null===(b=this.flag(~d))||void 0===b?void 0:b.logic,null===a||void 0===a?0:a.assumeFalse)return F.OPEN}else{a=this.flag(~d);if(null===a||void 0===a?0:a.logic.assumeTrue)return F.OPEN;(null===a||void 0===a?0:a.logic.track)&&c.push([a.id])}return c}flag(a){var b;a=this.rom.flags[a];return null!==(b=this.aliases.get(a))&&void 0!==b?b:a}entrance(a,b=0){"number"===typeof a&&(a=this.rom.locations[a]);return this.tiles.find(af.from(a,a.entrances[b]))}wallCapability(a){switch(a){case gg.WIND:return this.rom.flags.BreakStone.id;
case gg.FIRE:return this.rom.flags.BreakIce.id;case gg.WATER:return this.rom.flags.FormBridge.id;case gg.THUNDER:return this.rom.flags.BreakIron.id;default:throw Error(`bad wall type: ${a}`);}}}function Ag(...a){return[a.map((a)=>a.id)]}function Bg(...a){return a.map((a)=>[a.id])};class Cg{constructor(a,b){this.height=a;this.width=b;this._coords=void 0;this.data=Array((a<<1|1)*(b<<1|1));this.row=this.width<<1|1}screens(){if(this._coords)return this._coords;const a=[];for(let b=0;b<this.height;b++)for(let c=0;c<this.width;c++)a.push(b<<12|c<<4);return this._coords=a}index(a){return((a&248)>>3)+this.row*(a>>>11)}index2(a,b){return(this.row<<1)*a+2*b}yx(a){const b=a%this.row;return[(a-b)/this.row/2,b/2]}coord(a){const b=a%this.row;return(a-b)/this.row<<11|b<<3}get(a){return this.data[this.index(a)]}set(a,
b){this.data[this.index(a)]=b}get2(a,b){return this.data[this.index2(a,b)]}set2(a,b,c){this.data[this.index2(a,b)]=c}plus(a,b,c){return a+(this.row<<1)*b+2*c}x(a){return a%this.row/2}y(a){return Math.floor(a/this.row)/2}border(a,b){let c;a&1?(c=b<<12|2048,a=a&2?this.width<<4:0):(c=a&2?this.height<<12:0,a=b<<4|8);return c|a}randomBorder(a,b){if(null!=b)if(b&1){var c=a.nextInt(this.height)<<12|2048;b=b&2?this.width<<4:0}else c=b&2?this.height<<12:0,b=a.nextInt(this.width)<<4|8;else c=this.width+this.height,
c=a.nextInt(c<<1)-c,a=!1,0>c&&(c=~c,a=!0),c<this.width?(b=c<<4|8,c=a?this.height<<12:0):(c=c-this.width<<12|2048,b=a?this.width<<4:0);return c|b}oppositeBorder(a){return a&8?a^this.height<<12:a^this.width<<4}furthestBorder(a){return(this.height<<12|this.width<<4)-a}edgeCoordination(a,b){let c=0;if(2056!==(a&2056))throw Error(`Bad tile: ${w(a)}`);for(const d of[8,-8,2048,-2048]){const e=this.get(a+d);(b?e===b:e)&&c++}return c}isBorder(a){if(a&8){if(a&2048)return!1;a>>>=12;return!a||a===this.height}return a&
2048?(a=a>>>4&15,!a||a===this.width):!1}partition(a){var b,c,d;const e=new yg;for(let g=0;g<this.data.length;g+=this.row)for(let h=0;h<this.row;h++){const k=g+h,p=this.coord(k);if(null!==(b=null===a||void 0===a?void 0:a.get(p))&&void 0!==b?b:this.data[k]){e.find(p);var f=p-2048;g&&(null!==(c=null===a||void 0===a?void 0:a.get(f))&&void 0!==c?c:this.data[k-this.row])&&e.union([p,f]);f=p-8;h&&(null!==(d=null===a||void 0===a?void 0:a.get(f))&&void 0!==d?d:this.data[k-1])&&e.union([p,f])}}return e.map()}show(){const a=
[];for(let b=0;b<this.data.length;b+=this.row){let c="";for(let a=0;a<this.row;a++)c+=this.data[b+a]||" ";a.push(c)}return a.join("\n")}}function Dg(a,b=1){return a-8*b}function Eg(a,b=1){return a+8*b}function Fg(a,b=1){return a-2048*b}function Gg(a,b=1){return a+2048*b};class Hg extends x{constructor(){super(...arguments);this.x=this.prop([0],[1,255,-8]);this.y=this.prop([2],[3,255,-8]);this.screen=this.prop([3,15,-4],[1,15]);this.tile=this.prop([2,240],[0,240,4]);this.coord=this.prop([2,255,-8],[0,255])}get used(){return 8>this.data[1]}toString(){return`Entrance ${this.hex()}: (${w(this.y)}, ${w(this.x)})`}}Hg.size=4;
class Ig extends x{constructor(){super(...arguments);this.x=this.prop([0,255,-4]);this.xt=this.prop([0]);this.y=this.prop([1,255,-4]);this.yt=this.prop([1]);this.screen=this.prop([1,240],[0,240,4]);this.tile=this.prop([1,15,-4],[0,15]);this.coord=this.prop([1,15,-12],[0,15,-4]);this.dest=this.prop([2]);this.entrance=this.prop([3])}isSeamless(){return!!(this.entrance&32)}toString(){return`Exit ${this.hex()}: (${w(this.y)}, ${w(this.x)}) => ${this.dest}:${this.entrance}`}}Ig.size=4;
class Jg extends x{constructor(){super(...arguments);this.x=this.prop([1,7,-8]);this.xs=this.prop([1,7]);this.y=this.prop([1,240,-4]);this.ys=this.prop([1,240,4]);this.screen=this.prop([1])}get flag(){return this.data[0]|512}set flag(a){if(512!==(a&-256))throw Error(`bad flag: ${w(a)}`);this.data[0]=a&255}toString(){return`Flag ${this.hex()}: ${w(this.screen)} @ ${w(this.flag)}`}}Jg.size=2;
class Kg extends x{constructor(){super(...arguments);this.fromXs=this.prop([1,112,4]);this.toXs=this.prop([1,7]);this.fromYs=this.prop([3,240,4]);this.toYs=this.prop([3,15]);this.fromScreen=this.prop([3,240],[1,112,4]);this.toScreen=this.prop([3,15,-4],[1,7]);this.dest=this.prop([0])}toString(){return`Pit ${this.hex()}: (${w(this.fromXs)}, ${w(this.fromYs)}) => ${w(this.dest)}:(${w(this.toXs)}, ${w(this.toYs)})`}}Kg.size=4;
class Lg extends x{constructor(){super(...arguments);this.y=this.prop([0,255,-4]);this.yt=this.prop([0]);this.x=this.prop([1,127,-4],[2,64,3]);this.xt=this.prop([1,127]);this.timed=this.booleanProp(1,7);this.screen=this.prop([0,240],[1,112,4]);this.tile=this.prop([0,15,-4],[1,15]);this.coord=this.prop([0,255,-8],[1,127,-4],[2,64,3]);this.type=this.prop([2,7]);this.id=this.prop([3]);this.patternBank=this.prop([2,128,7])}get used(){return 254!==this.data[0]}set used(a){this.data[0]=a?0:254}get monsterId(){return this.id+
80&255}set monsterId(a){this.id=a-80&255}isChest(){return 2===this.type&&128>this.id}isInvisible(){return this.isChest()&&!!(this.data[2]&32)}isTrigger(){return 2===this.type&&128<=this.id}isNpc(){return 1===this.type&&192>this.id}isBoss(){return 1===this.type&&192<=this.id}isMonster(){return 0===this.type}isWall(){return!(3!==this.type||!(4>this.id||this.data[2]&32))}isShootingWall(a){return this.isWall()&&!!(this.data[2]&32?this.data[2]&16:143===a.id||168===a.id)}wallType(){if(3!==this.type)return"";
const a=this.data[2]&32?this.id>>>4:this.id;return 4<=a?"":2===a?"bridge":"wall"}wallElement(){return this.isWall()?this.id&3:-1}toString(){return`Spawn ${this.hex()}: (${w(this.x)}, ${w(this.y)}) ${this.timed?"timed":"fixed"} ${this.type}:${w(this.id)}`}}Lg.size=4;const Mg={next(){return{done:!0}}},Ng={get size(){return 0},has(){return!1},[Symbol.iterator](){return Mg}},H={get size(){return Infinity},has(){return!0},[Symbol.iterator](){throw Error("cannot iterate");}};class Og{constructor(a){this.bit=a}get size(){return 1}has(a){return a===this.bit}[Symbol.iterator](){return[this.bit][Symbol.iterator]()}}function Pg(a){return new Og(a)}var Qg;
(function(a){a.intersect=function(a,c){if(a===H||!c.size)return c;if(c===H||!a.size)return a;const b=new Set;for(const d of a)c.has(d)&&b.add(d);return b.size?b:Ng};a.union=function(a,c){if(a===H||!c.size)return a;if(c===H||!a.size)return c;a=new Set(a);for(const b of c)a.add(b);return a};a.isSubset=function(a,c){if(c===H||!a.size)return!0;if(a.size>c.size)return!1;for(const b of a)if(!c.has(b))return!1;return!0};a.label=function(a){return a===H?"all":[...a].sort().join(" ")}})(Qg||(Qg={}));
class Rg{constructor(a,b,c){this.fixed=a;this.float=b;this.shift=c}get pat0(){return this.fixed[0]}get pat1(){return this.fixed[1]}get pal2(){return this.fixed[2]}get pal3(){return this.fixed[3]}static get ALL(){return new Rg([H,H,H,H],[],0)}static get NONE(){return new Rg([Ng,Ng,Ng,Ng],[],0)}static get MIMIC(){return new Rg([H,Pg(108),H,H],[],2)}static get TREASURE_CHEST(){return new Rg([H,H,H,H],[Sg],0)}static get BOSS(){return new Rg([Sg,H,H,H],[],0)}static get COIN(){return new Rg([Tg,H,H,H],
[],0)}static get STOM_FIGHT(){return new Rg([H,new Set([77]),H,H],[],0)}static get GUARDIAN_STATUE(){return new Rg([new Set([116]),new Set([98]),H,H],[],0)}static get SHOOTING_WALL(){return new Rg([new Set([97]),H,H,H],[],0)}static get KENSU_CHEST(){return new Rg([new Set([81]),H,H,H],[],0)}static forLocation(a){switch(a){case 3:return new Rg([H,Pg(96),H,Pg(32)],[],0);case 96:case 100:case 104:return new Rg([H,Pg(82),H,Pg(8)],[],0)}return Rg.ALL}static fromSpawn(a,b,c,d,e){const [f,...g]=b;(e=e&&
2===f&&!g.length)&&d.patternBank&&(b=new Set([3]));const h=e||!b.has(2)?H:Pg(c.spritePatterns[0]);b=e||!b.has(3)?H:Pg(c.spritePatterns[1]);d=e?[Pg(c.spritePatterns[d.patternBank])]:[];e=a.has(2)?Pg(c.spritePalettes[0]):H;a=a.has(3)?Pg(c.spritePalettes[1]):H;return new Rg([h,b,e,a],d,0)}ignorePalette(){return new Rg([this.fixed[0],this.fixed[1],H,H],this.float,this.shift)}shufflePalette(a,b){const c=[...this.fixed];for(let d=2;4>d;d++){if(c[d]===H)continue;const e=Math.floor(5-Math.log2(a.nextInt(15)+
2)),f=c[d]=new Set;for(let c=0;c<e;c++)f.add(a.pick(b))}return new Rg(c,this.float,this.shift)}shifted(){return new Rg(this.fixed,this.float,this.shift|2)}join(a){const b=v(4,(b)=>Qg.union(this.fixed[b],a.fixed[b]));if(this.float.length!==a.float.length)throw console.dir(this),console.dir(a),Error(`incompatible float: ${this.float} ${a.float}`);const c=v(this.float.length,(b)=>Qg.union(this.float[b],a.float[b]));return new Rg(b,c,this.shift|a.shift)}fix(a,b){var c=b?(a)=>b.nextInt(a):()=>0;const d=
b?(a)=>b.pick([...a]):(a)=>a[Symbol.iterator]().next().value,e=[...this.fixed];if(this.float.length){c=c(2);const a=1-c;c<this.float.length&&(e[0]=Qg.intersect(e[0],this.float[c]));a<this.float.length&&(e[1]=Qg.intersect(e[1],this.float[a]))}e[0]!==H&&(a.spritePatterns[0]=d([...e[0]]));e[1]!==H&&(a.spritePatterns[1]=d([...e[1]]));e[2]!==H&&(a.spritePalettes[0]=d([...e[2]]));e[3]!==H&&(a.spritePalettes[1]=d([...e[3]]))}meet(a,b=!1){a=this.tryMeet(a,b);if(!a)throw Error("Could not reconcile patterns");
return a}tryMeet(a,b=!1){const c=[];let d=this.shift|a.shift;for(var e=0;4>e;e++){var f=Qg.intersect(this.fixed[e],a.fixed[e]);if(!f.size){if(!b||2>e)return;f=Qg.union(this.fixed[e],a.fixed[e])}c.push(f)}e=new Map;b=[];for(var g of Qa.concat(this.float,a.float)){if(g===H)throw Error("Unexpected unconstrained float");a=!1;for(var h of g)if(f=e.get(h),null!=f){for(var k of b[f])e.delete(k);b[f]=Qg.intersect(b[f],g);for(const a of b[f])e.set(a,f);a=!0;break}if(a)break;for(const a of g)e.set(a,b.length);
b.push(g);if(2<b.length)return}for(g=0;g<b.length;g++)for(h=0;2>h;h++)if(!Qg.intersect(b[g],c[h]).size){k=c[1-h]=Qg.intersect(b[g],c[1-h]);d|=1<<1-h;if(!k.size)return;b.splice(g,1);g=-1;break}return new Rg(c,b,d)}}const Sg=new Set([94,95,96,97,100,101,102,103,104,105,106,108,109,110,111,112,116,117,118,119]),Tg=new Set([94,95,96,97,99,100,101,102,103,104,105,106,107,108,109,110,111,112,116,117,118,119]);class Ug extends mg{constructor(a,b){super(a,b);this.used=!0;this.name="";this.base=Qd(a.prg,this.pointer)+65536;this.sfx=a.prg[this.base];this.data=[];b=this.base+1;let c=0;for(let d=0;32>d;d++)d&7||(c=a.prg[b++]),this.data.push(c&128?a.prg[b++]:0),c<<=1}get pointer(){return 109568+(this.id<<1)}serialize(){const a=[this.sfx];for(let b=0;4>b;b++){const c=a.length;a.push(0);for(let d=0;8>d;d++)this.data[8*b+d]&&(a[c]|=128>>>d,a.push(this.data[8*b+d]))}return a}write(){const a=`Object_${this.id.toString(16).padStart(2,
"0")}`,b=this.rom.assembler();b.segment("0d");b.reloc(a);const c=b.pc();b.byte(...this.serialize());b.org(44032+(this.id<<1),`${a}_Ptr`);b.word(c);return[b.module()]}get(a){return this.data[a-768>>>5]}parents(){return[]}locations(){return this.rom.locations.filter((a)=>a.used&&a.spawns.some((a)=>a.isMonster()&&a.monsterId===this.id))}palettes(a=!1){if(34===this.action)return[3];let b=this.data[0];42===this.action&&(b=this.data[31]|1);41===this.action&&(b=107);38===this.action&&(b=156);a=a&&this.child?
this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]]:null;return[...new Set([...this.rom.metasprites[b].palettes(),...a?a.palettes():[]])]}isVulnerable(a){return!(this.elements&1<<a)}isShadow(){return 123===this.id||140===this.id}get metasprite(){return Vg.get(this.data)}set metasprite(a){Vg.set(this.data,a)}get speed(){return Wg.get(this.data)}set speed(a){Wg.set(this.data,a)}get collisionPlane(){return Xg.get(this.data)}set collisionPlane(a){Xg.set(this.data,
a)}get hitbox(){return Yg.get(this.data)}set hitbox(a){Yg.set(this.data,a)}get hp(){return Zg.get(this.data)}set hp(a){Zg.set(this.data,a)}get atk(){return $g.get(this.data)}set atk(a){$g.set(this.data,a)}get def(){return ah.get(this.data)}set def(a){ah.set(this.data,a)}get level(){return bh.get(this.data)}set level(a){bh.set(this.data,a)}get poison(){return!!ch.get(this.data)}set poison(a){ch.set(this.data,a?1:0)}get child(){return dh.get(this.data)}set child(a){dh.set(this.data,a)}get terrainSusceptibility(){return eh.get(this.data)}set terrainSusceptibility(a){eh.set(this.data,
a)}get immobile(){return!!fh.get(this.data)}set immobile(a){fh.set(this.data,a?1:0)}get action(){return gh.get(this.data)}set action(a){gh.set(this.data,a)}get replacement(){return hh.get(this.data)}set replacement(a){hh.set(this.data,a)}get goldDrop(){return ih.get(this.data)}set goldDrop(a){ih.set(this.data,a)}get elements(){return jh.get(this.data)}set elements(a){jh.set(this.data,a)}get expReward(){return kh.get(this.data)}set expReward(a){kh.set(this.data,a)}get attackType(){return lh.get(this.data)}set attackType(a){lh.set(this.data,
a)}get statusEffect(){return mh.get(this.data)}set statusEffect(a){mh.set(this.data,a)}}function nh(...a){return new oh(...a)}class oh{constructor(...a){this.spec=a}get(a){let b=0;for(const [c,d=255,e=0]of this.spec)b|=(a[c-768>>>5]&d)>>>(0>e?0:e)<<(0>e?-e:0);return b}set(a,b){for(const [c,d=255,e=0]of this.spec){const f=c-768>>>5;a[f]=a[f]&~d|b>>>(0>e?-e:0)<<(0>e?0:e)&d}}}
const Vg=nh([768]),Wg=nh([832,15]),Xg=nh([928,240,4]),Yg=nh([1056,64,2],[928,15]),Zg=nh([960]),$g=nh([992]),ah=nh([1024]),bh=nh([1056,31]),ch=nh([1056,128,7]),dh=nh([1088]),eh=nh([1120]),fh=nh([1184,128,7]),gh=nh([1184,127]),hh=nh([1216]),ih=nh([1280,240,4]),jh=nh([1280,15]),kh=nh([1312]),lh=nh([1344]),mh=nh([1376,15]);class cj extends Ug{constructor(a,b){var [c,d,e,f={}]=b;super(a,d);this.constraint=Rg.ALL;this.name=c;a=((24>e?1+e/3:(e+12)/4)+this.level)/2;a:{b=this.elements;b=void 0===b?0:b;var g=10>e?1:18>e?2:38>e?4:8;for(var h=g;h;h>>>=1)if(!(h&b)){b=h<<1;break a}b=g<<1}b=a+b;this.hits=(this.hp+1)/(b-this.def);this.sdef=this.def/b;a=Math.min(255,Math.max(16,32+16*a));b=this.atk;g=24>e?1+e/3:(e+12)/4;h=this.attackType?dj(e,2,[6,6],[18,8],[25,12],[30,18],[37,24],[42,32]):dj(e,2,[6,6],[18,10],[25,14],[30,18],[40,
24],[46,32]);this.satk=(b-(g+h))/a;this.extraDifficulty=f.difficulty||0;this.monsterClass=f.monsterClass;a=this.expReward;a=(128>a?a:(a&127)<<4)/Math.pow(2,e/5-1);this.wealth=(b=ej[this.goldDrop]/Math.pow(2,e/7-1))&&b/(a+b)}isUntouchedMonster(){return!!fj[this.id]}placement(){const a=gj.get(this.action);return a&&a.placement||"normal"}clearance(){const a=gj.get(this.action);return a&&a.large?6:3}totalDifficulty(){return this.toughness()+this.attack()+this.statusDifficulty()+this.immunities()+this.movement()}collectDifficulty(a,
b){let c=a(this);var d=this.spawnedChild();d&&(c=b(c,d.collectDifficulty(a,b)));(d=this.spawnedReplacement())&&(c=b(c,d.collectDifficulty(a,b)));return c}toughness(){return this.collectDifficulty((a)=>dj(a.hits,0,[2,1],[3,2],[5,3],[7,4],[10,5],[13,6]),Math.max)}attack(){return this.collectDifficulty((a)=>a.attackType&&a.statusEffect?0:dj(a.satk,0,[.04,1],[.08,2],[.13,3],[.18,4],[.25,5],[.33,6]),Math.max)}addStatusEffects(a){this.attackType&&this.statusEffect?a.add(this.statusEffect):!this.attackType&&
this.poison&&a.add(0);var b=this.spawnedReplacement();b&&b.addStatusEffects(a);(b=this.spawnedChild())&&b.addStatusEffects(a)}statusDifficulty(){const a=new Set;this.addStatusEffects(a);let b=0;for(const c of a)b+=hj[c];return b}immunities(){let a=0,b=this.elements;for(;b;)b&1&&a++,b>>>=1;return a&&1<<a-1}movement(){return this.collectDifficulty((a)=>{const b=gj.get(a.action),c=a.spawnedChild();a=a.extraDifficulty;b&&(a+=b.movement||0,b.large&&a++,c&&!c.statusEffect&&(a+=b.projectile||0));167===this.metasprite&&
(a+=2);return a},(a,b)=>a+b)}spawnedChild(){var a=gj.get(this.action);if(a&&a.child&&(a=(a=this.rom.adHocSpawns[this.child])&&a.objectId,null!=a))return a=this.rom.objects[a],a instanceof cj?a:void 0}spawnedReplacement(){if(this.replacement){var a=this.rom.objects[this.replacement];return a instanceof cj?a:void 0}}totalReward(){return this.totalDifficulty()/4}normalizedGold(){if(!this.wealth)return 0;const a=this.totalDifficulty()*this.wealth*.6;return Math.max(1,Math.min(15,Math.round(a)))}normalizedExp(){if(1===
this.wealth)return 0;const a=.488+this.totalDifficulty()*(1-this.wealth)*.256;return Math.max(1,Math.min(255,Math.round(32*a)))}}
const hj=[2,1,3,2,4],ej=[0,1,2,4,8,16,30,50,100,200,400,50,100,200,400,500],gj=new Map([[16,{}],[17,{}],[22,{}],[23,{}],[27,{}],[29,{child:!0}],[30,{}],[31,{}],[32,{movement:1}],[33,{child:!0,large:!0,movement:2}],[34,{child:!0,movement:3}],[36,{movement:3}],[37,{movement:3}],[38,{child:!0,projectile:1,movement:3}],[39,{child:!0,projectile:1,movement:3}],[40,{child:!0,projectile:2,movement:3,metasprites:()=>[101,145]}],[41,{child:!0,movement:5,metasprites:()=>[107,104]}],[42,{child:!0,projectile:1,
movement:4,metasprites:(a)=>[0,1,2,3].map((b)=>b+a.data[31])}],[43,{movement:4}],[44,{child:!0}],[46,{child:!0,large:!0,projectile:2,movement:3}],[47,{}],[52,{child:!0}],[56,{}],[60,{}],[64,{child:!0,moth:!0,movement:4,placement:"moth"}],[65,{child:!0,movement:3}],[68,{movement:3}],[69,{child:!0,bird:!0,projectile:2,movement:5,placement:"bird"}],[76,{child:!0,stationary:!0,projectile:3,placement:"plant"}],[77,{child:!0,stationary:!0,projectile:3}],[78,{child:!0,stationary:!0}],[87,{}],[88,{}],[92,
{child:!0,projectile:3,movement:1}],[93,{bird:!0,movement:6,placement:"bird"}],[94,{child:!0,projectile:1,movement:4,metasprites:(a)=>[0,1,2,3].map((b)=>b+a.data[31])}],[96,{boss:!0}],[97,{}],[99,{boss:!0}],[100,{boss:!0}],[102,{boss:!0}],[103,{boss:!0}],[104,{boss:!0}],[106,{boss:!0}],[107,{boss:!0}],[112,{boss:!0}],[127,{boss:!0}]]);function dj(a,b,...c){for(let b=c.length-1;0<=b;b--){const [d,f]=c[b];if(a>=d)return f}return b}
const fj={[126]:!0,[127]:!0,[131]:!0,[141]:!0,[142]:!0,[143]:!0,[159]:!0,[166]:!0};class ij{constructor(a,b,c,d){this.id=a;this.tileset=b;this.customFlags=new Map;this.freeFlags=new Set;this._pos=void 0;this._exits=new Oa;this.rom=b.rom;this._height=c;this._width=d;this._screens=Array(c<<4).fill(b.empty)}static of(a,b){function c(a,b,c){for(const d of g.metascreens.getById(b,a.tileset))if(b=d.findEntranceType(c,1===a.height),null!=b)return b}var d,e,f;const {rom:g,width:h,height:k}=a;if(!b){const {fortress:c,labyrinth:d}=g.metatilesets;b=new Set;for(var p of g.metatilesets)a.tileset===
p.tileset.id&&b.add(p);b.delete(169===a.id?c:d);for(var m of new Set(Qa.concat(...a.screens)))for(var u of b)if(u.getMetascreens(m).length||b.delete(u),!b.size)throw Error(`No tileset for ${w(m)} in ${a}`);if(1!==b.size)throw Error(`Non-unique tileset for ${a}: [${Array.from(b,(a)=>a.name).join(", ")}]`);b=[...b][0]}const y=a.reachableTiles(!0);p=new Set;for(var G of y.keys())p.add(G>>>8);for(var A of a.entrances)p.add(A.screen);for(var T of a.exits)p.add(T.screen);G=Array(k<<4).fill(b.empty);for(let c=
0;c<k;c++)for(let d=0;d<h;d++){A=c<<4|d;var ma=b.getMetascreens(a.screens[c][d]);T=void 0;if(1===ma.length)T=ma[0];else if(ma.length){m=a.flags.find((a)=>a.screen===(c<<4|d));u=[];var M=[];for(var Z of ma)Z.data.match?u.push(Z):"always"===Z.flag&&766===(null===m||void 0===m?void 0:m.flag)||!Z.flag&&!Z.data.wall&&!m?M.unshift(Z):M.push(Z);if(u.length){ma=function(a,b){b=(d<<8)+b;a=(c<<8)+a;return y.has(a<<4&61440|b&3840|a&240|b>>4&15)};for(var ea of u)if(ea.data.match(ma,null!=m)){T=ea;break}}T||(T=
M[0])}else throw Error("impossible");if(!T)throw Error("impossible");G[A]=T}Z=new Oa;for(const b of a.exits)if(ea=b.screen,p.has(ea))if(T=G[ea],m=T.findExitType(b.tile,1===k,!!(b.entrance&32)),A=null===m||void 0===m?void 0:m.type,!A)jj.has(a.id<<16|ea<<8|b.tile)||(A=null===(d=T.data.exits)||void 0===d?void 0:d.map((a)=>a.type+": "+a.exits.map(w).join(", ")).join("\n  "),console.warn(`Unknown exit ${w(b.tile)}: ${T.name} in ${a} @ ${w(ea)}:\n  ${A}`));else if(!Z.has(ea,A))if(T=g.locations[b.dest],
A.startsWith("seamless"))u="seamless:down"===A,m=m.exits[0]+(u?-16:16),Z.set(ea,A,[T.id<<8|ea+(0>m?-16:240<=m?16:-0),u?"seamless:up":"seamless:down"]);else if(M=T.entrances[b.entrance&31],m=M.screen,u=M.coord,"door"===A&&0===(M.y&240)&&(m-=16,u+=65536),M=T.screens[m>>4][m&15],ma=c(T,M,u))Z.set(ea,A,[T.id<<8|m,ma]);else{ea=[];for(const a of g.metascreens.getById(M,T.tileset))for(const b of null!==(e=a.data.exits)&&void 0!==e?e:[])b.type.startsWith("seamless")||ea.push(`  ${a.name} ${b.type}: ${w(b.entrance)}`);
console.warn(`Bad entrance ${w(u)}: raw ${w(M)} in ${T} @ ${w(m)}\n${ea.join("\n")}`)}d=new ij(a.id,b,k,h);d._screens=G;d._exits=Z;for(const b of a.flags)a=d._screens[b.screen],(null===(f=a.flag)||void 0===f?0:f.startsWith("custom"))?d.customFlags.set(b.screen,g.flags[b.flag]):a.flag||d.freeFlags.add(g.flags[b.flag]);return d}getUid(a){return this._screens[a].uid}get(a){return this._screens[a]}get width(){return this._width}set width(a){this._width=a;this._pos=void 0}get height(){return this._height}set height(a){this._height>
a?this._screens.splice(a+2<<4,this._height-a<<4):this._height<a&&(this._screens.length=a+2<<4,this._screens.fill(this.tileset.empty,this.height+2<<4,this._screens.length));this._height=a;this._pos=void 0}allPos(){if(this._pos)return this._pos;const a=this._pos=[];for(let b=0;b<this._height;b++)for(let c=0;c<this._width;c++)a.push(b<<4|c);return a}set(a,b){this._screens[a]=null!==b&&void 0!==b?b:this.tileset.empty}inBounds(a){return(a&15)<this.width&&0<=a&&a>>>4<this.height}set2d(a,b){for(const c of b){b=
0;for(const d of c)d&&this.set(a+b,d),b++;a+=16}return this.validate()}validate(){for(var a of[0,1])for(var b=a?0:1;b<this.height;b++)for(var c=a;c<this.width;c++){var d=b<<4|c,e=this._screens[d],f=d-(a?1:16),g=this._screens[f];if(!e.isEmpty()&&!g.isEmpty()&&!e.checkNeighbor(g,a)){b=Error;a=[g.name,f,kj[a],e.name,d];d="bad neighbor %s (%02x) %s %s (%02x)".split(/%/g);e=0;f=d[0];for(g=1;g<d.length;g++){if(!d[g]){f+="%"+d[++g];continue}c=/([-+]*)([0\D]?)(\d*)([dxs])/.exec(d[g]);if(!c){f+=a[e++]+d[g];
continue}var h=parseInt(c[3])||0;const b=c[2]||" ",p=a[e++];let m="x"===c[4]?Number(p).toString(16):String(p);"s"!==c[4]&&/\+/.test(c[1])&&0<=Number(p)&&(m="+"+m);m.length<h&&(h=b.repeat(h-m.length),m=/-/.test(c[1])?m+h:h+m);f+=m+d[g].substring(c[0].length)}a=f;throw new b(a);}}return!0}spliceColumns(a,b,c,d){for(var e=0;e<this._screens.length;e+=16)this._screens.copyWithin(e+a+c,e+a+b,e+10),this._screens.splice(e+a,c,...d[e>>4]);c-=b;this.width+=c;this._pos=void 0;d=[];for(var f of this._exits){const [g,
h]=f;e=g&15;e<a+b?e>=a&&this._exits.delete(g,h):d.push([g,h,g+c,h])}this.moveExits(...d);f=this.rom.locations[this.id];d=a+b<<4;for(const a of f.spawns)a.xt<d||(a.xt-=c<<4);for(const d of f.flags)d.xs<a+b?d.xs>=a&&(d.screen=255):d.xs-=c;f.flags=f.flags.filter((a)=>255!==a.screen)}setExit(a,b,c){const d=this.rom.locations[c[0]>>>8].meta;if(!d)throw Error("Cannot set two-way exit without meta");this.setExitOneWay(a,b,c);d.setExitOneWay(c[0]&255,c[1],[this.id<<8|a,b])}setExitOneWay(a,b,c){this._exits.set(a,
b,c)}getExit(a,b){return this._exits.get(a,b)}exits(){return this._exits}exitCandidates(a){var b;const c=[];for(const d of this.tileset)(null===(b=d.data.exits)||void 0===b?0:b.some((b)=>b.type===a))&&c.push(d);return c}show(){var a,b;const c=[];let d=[];for(var e=0;e<this.width;e++)d.push(e.toString(16));c.push("   "+d.join("  "));for(e=0;e<this.height;e++)for(let f=0;3>f;f++){d=[1===f?e.toString(16):" "," "];for(let c=0;c<this.width;c++){const g=this._screens[e<<4|c];d.push(null!==(b=null===(a=
null===g||void 0===g?void 0:g.data.icon)||void 0===a?void 0:a.full[f])&&void 0!==b?b:1===f?" ? ":"   ")}c.push(d.join(""))}return c.join("\n")}screenNames(){const a=[];for(let b=0;b<this.height;b++){let c=[];for(let a=0;a<this.width;a++){const d=this._screens[b<<4|a];c.push(null===d||void 0===d?void 0:d.name)}a.push(c.join(" "))}return a.join("\n")}traverse(a){a=void 0===a?{}:a;var b,c,d=new yg;const e=(a.flight?2:0)|(a.noFlagged?1:0);for(const f of this.allPos()){const g=null!==(c=null===(b=a.with)||
void 0===b?void 0:b.get(f))&&void 0!==c?c:this._screens[f];for(const a of g.connections[e])a.length&&d.union(a.map((a)=>(f<<8)+a))}a=new Map;d=d.sets();for(b=0;b<d.length;b++){c=d[b];for(const b of c)a.set(b,c)}return a}attach(a,b,c,d,e){d||(d=this.pickTypeFromExits(a));e||(e=b.pickTypeFromExits(c));const f=b.id<<8|c,g=this._exits.get(a,d);if(g){const [a,b]=g;if(a===f&&b===e)return}const h=b._exits.get(c,e);this._exits.set(a,d,[f,e]);b._exits.set(c,e,[this.id<<8|a,d]);if(h&&g){const [b,c]=g,[d,e]=
h;a=this.rom.locations[b>>8].meta;this.rom.locations[d>>8].meta._exits.set(d&255,e,g);a._exits.set(b&255,c,h)}else if(h||g){const [a,b]=h||g;this.rom.locations[a>>8].meta._exits.delete(a&255,b)}}pickTypeFromExits(a){const b=[...this._exits.row(a).keys()];if(!b.length)return this.pickTypeFromScreens(a);if(1<b.length)throw Error(`No single type for ${w(a)}: [${b.join(", ")}]`);return b[0]}moveExits(...a){const b=[];for(const c of a){const [d,e,f,g]=c;{a=this._exits.get(d,e);const [c,k]=a;this.rom.locations[c>>
8].meta._exits.set(c&255,k,[this.id<<8|f,g]);b.push([f,g,a]);this._exits.delete(d,e)}}for(const a of b){const [b,c,f]=a;this._exits.set(b,c,f)}}moveExit(a,b,c,d){c||(c=this.pickTypeFromExits(a));d||(d=this.pickTypeFromScreens(b));const e=this._exits.get(a,c),[f,g]=e;this.rom.locations[f>>8].meta._exits.set(f&255,g,[this.id<<8|b,d]);this._exits.set(b,d,e);this._exits.delete(a,c)}pickTypeFromScreens(a){var b=this._screens[a].data.exits;b=(null!==b&&void 0!==b?b:[]).map((a)=>a.type);if(1!==b.length)throw Error(`No single type for ${w(a)}: [${b.join(", ")}]`);
return b[0]}transferFlags(a,b){var c;this.freeFlags=new Set(a.freeFlags);const d=new n(()=>[]);for(const b of a.customFlags){const [c,e]=b;d.get(a._screens[c]).push(e)}for(const a of d.values())b.shuffle(a);for(const e of this.allPos())if(a=this._screens[e],null===(c=a.flag)||void 0===c?0:c.startsWith("custom")){b=d.get(a).pop();if(!b)throw Error(`No flag for ${a.name} at ${this.rom.locations[this.id]} @${w(e)}`);this.customFlags.set(e,b)}}transferExits(a,b){var c;const d=new n(()=>[]),e=new n(()=>
new Set);for(var f of this.allPos()){var g=this._screens[f];for(var h of null!==(c=g.data.exits)&&void 0!==c?c:[])({type:g}=h),"edge:top"===g&&f>>>4||"edge:left"===g&&f&15||"edge:bottom"===g&&f>>>4<this.height-1||"edge:right"===g&&(f&15)<this.width-1||d.get(g).push(f)}for(var k of d.values())b.shuffle(k);for(const g of a._exits){const [m,p,y]=g;if(!e.get(p).has(m)){f=d.get(p).pop();if(null==f)throw Error(`Could not transfer exit ${p} in ${this.rom.locations[this.id]}: no eligible screen\n${this.show()}`);
h=this.rom.locations[y[0]>>>8].meta;b=y[0]&255;c=y[1];if(h===a){h=d.get(c).pop();if(null==h)throw Error("Impossible");this._exits.set(f,p,[this.id<<8|h,c]);this._exits.set(h,c,[this.id<<8|f,p]);e.get(c).add(b)}else{k=h._exits.get(b,c);if(!k)throw a=this.rom.locations[y[0]>>>8],console.log(h),Error(`No exit for ${a} at ${w(b)} ${c}\n${h.show()}\n${this.rom.locations[this.id]} at ${w(m)} ${p}\n${this.show()}`);k[0]>>>8===this.id&&(k[0]&255)===m&&k[1]===p&&h._exits.set(b,c,[this.id<<8|f,p]);this._exits.set(f,
p,y)}}}}transferSpawns(a,b){var c,d,e=new Map;const f=[],g=[],h=[];var k=[];for(var p of[this,a]){for(var m of p.allPos()){const a=p._screens[m],b=m&240,c=(m&15)<<4;if(p===this&&a.hasFeature("wall")){if(null==a.data.wall)throw Error("Missing wall prop");const d=[b|a.data.wall>>4,c|a.data.wall&15];g.push(d);a.data.tilesets.lime&&g.push([d[0]-1,d[1]])}else if(p===this&&a.hasFeature("bridge")){if(null==a.data.wall)throw Error("Missing wall prop");h.push([b|a.data.wall>>4,c|a.data.wall&15])}if(a.hasFeature("arena"))if(p===
this)k.push([b|8,c|8]);else{const [a,d]=k.pop();f.push([b|8,c|8,a,d,144])}}p===this&&b.shuffle(k)}for(const b of[this,a])for(const d of b._exits){const [g,h,u]=d;k=b._screens[g];a=null===(c=k.data.exits)||void 0===c?void 0:c.find((a)=>a.type===h);if(!a)throw Error(`Invalid exit: ${k.name} ${h}`);k=g&15;p=g>>>4;m=a.exits[0]&15;a=a.exits[0]>>>4;if(b===this)e.set(u,[p<<4|a,k<<4|m]);else if(u[0]>>>8!==this.id){const [b,c]=e.get(u);f.push([p<<4|a,k<<4|m,b,c,25])}}c=[[],[],[],[],[],[]];for(var u of this.allPos()){e=
this._screens[u];for(var y of null!==(d=e.data.poi)&&void 0!==d?d:[]){const [a,b=112,d=120]=y;c[a].push([((u&240)<<4)+b,((u&15)<<8)+d])}}for(const a of c)b.shuffle(a);d=[...Qa.concat(...c)];u=this.rom.locations[this.id];for(const a of b.shuffle(u.spawns)){if(a.isMonster())continue;else if(a.isWall()){b=("bridge"===a.wallType()?h:g).pop();if(!b)throw Error(`Not enough ${a.wallType()} screens in new metalocation: ${u}\n${this.show()}`);const [c,d]=b;a.yt=c;a.xt=d;continue}else if(a.isNpc()||a.isBoss()||
a.isTrigger()){b=[-1,-1,Infinity];for(const c of f){const [d,e,f,g,h]=c;y=Math.pow(a.yt-d,2)+Math.pow(a.xt-e,2);y<=h&&y<b[2]&&(b=[a.yt+f-d,a.xt+g-e,y])}if(Number.isFinite(b[2])){[a.yt,a.xt]=b;continue}}if(a.isTrigger()||a.isBoss())throw Error(`Could not place ${u} ${a.isBoss()?"Boss":"Trigger"} ${a.hex()}\n${this.show()}`);b=d.shift();if(!b)throw Error(`Ran out of POI for ${u}`);const [c,e]=b;f.push([a.y>>>4,a.x>>>4,c>>>4,e>>>4,4]);a.y=c;a.x=e}}reconcileExits(a){const b=[],c=[];for(const d of[this,
a])for(const e of d._exits){const [f,g,[h,k]]=e;{if(k.startsWith("seamless"))continue;const e=this.rom.locations[h>>>8].meta._exits.get(h&255,k);if(e){const [c,p]=e;if(c>>>8===d.id&&(c&255)===f&&p===g){b.push([d===this?a:this,f,g,[h,k]]);continue}}c.push([d,f,g])}}for(const a of c){const [b,c,d]=a;b._exits.delete(c,d)}for(const a of b){const [b,c,d,h]=a;b._exits.set(c,d,h)}}write(){var a,b,c,d,e,f,g;const h=this.rom.locations[this.id];let k;for(var p of this._exits){const [c,d,[e,f]]=p;{var m=this._screens[c];
const g=e>>8;let p=e&255;const y=this.rom.locations[g],A=y.meta._screens[e&255],G=null===(a=m.data.exits)||void 0===a?void 0:a.find((a)=>a.type===d);var u=null===(b=A.data.exits)||void 0===b?void 0:b.find((a)=>a.type===f);if(!G||!u)throw Error(`Missing ${G?"dest":"source"} exit:
  From: ${h} @ ${w(c)}:${d} ${m.name}
  To:   ${y} @ ${w(p)}:${f} ${A.name}`);m=32;u.type.startsWith("seamless")?k=y:(u=u.entrance,61439<u&&(p+=16,u-=65536),m=y.findOrAddEntrance(p,u));for(let a of G.exits)h.exits.push(x.of({screen:c,tile:a,dest:g,entrance:m}))}}h.width=this._width;h.height=this._height;h.screens=[];for(a=0;a<this._height;a++)for(b=[],h.screens.push(b),p=0;p<this._width;p++)b.push(this._screens[a<<4|p].sid);h.tileset=this.tileset.tilesetId;h.tileEffects=this.tileset.effects().id;h.flags=[];a=[...this.freeFlags];for(const p of this.allPos()){b=
this._screens[p];let m;null==b.data.wall||k?"always"===b.flag?m=this.rom.flags.AlwaysTrue.id:"calm"===b.flag?m=this.rom.flags.CalmedAngrySea.id:"custom:false"===b.flag?m=null===(e=this.customFlags.get(p))||void 0===e?void 0:e.id:"custom:true"===b.flag&&(m=null!==(g=null===(f=this.customFlags.get(p))||void 0===f?void 0:f.id)&&void 0!==g?g:this.rom.flags.AlwaysTrue.id):m=null!==(d=null===(c=a.pop())||void 0===c?void 0:c.id)&&void 0!==d?d:this.rom.flags.alloc(512);null!=m&&h.flags.push(x.of({screen:p,
flag:m}))}}replaceMonsters(a){const b=this.rom.locations[this.id];a=b.monsterPlacer(a);for(const c of b.spawns){if(!c.used)continue;if(!c.isMonster())continue;const d=b.rom.objects[c.monsterId];if(!(d instanceof cj))continue;if(d.isUntouchedMonster())continue;const e=a(d);null==e?(console.error(`no valid location for ${w(d.id)} in ${b}`),c.used=!1):(c.screen=e>>>8,c.tile=e&255)}}}
const jj=new Set([65594,65595,1392800,1716320,4202496,4202544,4292816,6326207,10552102,10552105,11077158,11077161]),kj=["above","left of","below","right of"];const lj={ok:!0,value:void 0};
class mj{constructor(a,b){this.loc=a;this.attempts=0;this.maxAttempts=100;this.orig=a.meta;this.params=null!==b&&void 0!==b?b:this.survey(this.orig)}shuffle(a){if(this.loc.used){for(this.random=a;++this.attempts<=this.maxAttempts;){a=this.build();if(a.ok){this.finish(a.value);return}console.log(`Shuffle failed ${this.loc}: ${a.fail}`)}this.reportFailure()}}reportFailure(){console.error(`Completely failed to map shuffle ${this.loc}`)}finish(a){a.transferFlags(this.loc.meta,this.random);a.transferExits(this.loc.meta,
this.random);a.transferSpawns(this.loc.meta,this.random);this.loc.meta=a}pickHeight(){return Math.max(1,Math.min(16,this.orig.height+Math.floor((this.random.nextInt(6)-1)/3)))}pickWidth(){return Math.max(1,Math.min(8,this.orig.width+Math.floor((this.random.nextInt(6)-1)/3)))}pickSize(){return this.params.size+(2>this.random.nextInt(5)?1:0)}extract(a,b,{h:c=3,w:d=3,replace:e=void 0}={}){var f=a.index(b);b="";c=f+c*a.row;const {row:g}=a;for(;f<c;f+=g)for(let c=f;c<f+d;c++){if(e){const d=e.get(a.coord(c));
if(null!=d){b+=d||" ";continue}}b+=a.data[c]||" "}return b}};class nj{constructor(a,b,c){this.h=a;this.w=b;this.size=c;this.fixed=new Set;this.bridges=this.walls=this.count=this.wides=this.rivers=0;this.grid=new Cg(a,b);this.grid.data.fill("")}}
class I extends mj{constructor(){super(...arguments);this.maxPartitions=1;this.minSpikes=2;this.maxSpikes=5;this.looseRefine=!1;this.addBlocks=!0}survey(a){var b,c;const d={meta:a,id:a.id,tileset:a.tileset,size:0,edges:[0,0,0,0],stairs:[0,0],features:{arena:0,bridge:0,over:0,pit:0,ramp:0,river:0,spike:0,under:0,wall:0,wide:0}};for(const e of a.allPos()){const f=a.get(e);(!f.isEmpty()||(null===(b=f.data.exits)||void 0===b?0:b.length))&&d.size++;for(const b of null!==(c=f.data.exits)&&void 0!==c?c:
[]){const {type:c}=b;if("edge:top"===c)0===e>>>4&&d.edges[0]++;else if("edge:left"===c)0===(e&15)&&d.edges[1]++;else if("edge:bottom"===c)e>>>4===a.height-1&&d.edges[2]++;else if("edge:right"===c)(e&15)===a.width-1&&d.edges[3]++;else if("crypt"!==c&&!c.startsWith("seamless")){if(b.dir&1)throw Error(`Bad exit direction: ${b.dir}`);d.stairs[b.dir>>>1]++}}f.hasFeature("arena")&&d.features.arena++;f.hasFeature("bridge")&&d.features.bridge++;f.hasFeature("overpass")&&d.features.over++;f.hasFeature("pit")&&
d.features.pit++;f.hasFeature("ramp")&&d.features.ramp++;f.hasFeature("spikes")&&d.features.spike++;f.hasFeature("underpass")&&d.features.under++;f.hasFeature("wall")&&d.features.wall++;f.hasFeature("river")&&d.features.river++;f.hasFeature("wide")&&d.features.wide++}2>d.size&&(1<a.width||1<a.height)&&(d.size=2);return d}build(a=this.pickHeight(),b=this.pickWidth(),c=this.pickSize()){var d;this.init();let e;a=new nj(a,b,c);if(!((e=this.initialFill(a),e.ok)&&(e=this.addEdges(a),e.ok)&&(e=this.addEarlyFeatures(a),
e.ok)&&(e=this.refine(a),e.ok)))return e;if(!this.refineEdges(a))return{ok:!1,fail:"refineEdges"};this.removeSpurs(a);this.removeTightLoops(a);if((e=this.addLateFeatures(a),!e.ok)||(e=this.addStairs(a,...null!==(d=this.params.stairs)&&void 0!==d?d:[]),!e.ok)||(e=this.preinfer(a),!e.ok))return e;d=this.inferScreens(a);return d.ok?(e=this.refineMetascreens(a,d.value),e.ok)?d:e:d}init(){}initialFill(a){this.fillCave(a,"c");return lj}fillCave(a){for(let b=.5;b<a.h;b++)for(let c=.5;c<a.w;c++)1<b&&a.grid.set2(b-
.5,c,"c"),1<c&&a.grid.set2(b,c-.5,"c"),a.grid.set2(b,c,"c");a.count=a.h*a.w}addEdges(a){if(!this.params.edges)return lj;for(let b=0;4>b;b++){let c=this.params.edges[b]||0;if(!c)continue;const d=v(b&1?a.h:a.w,(c)=>a.grid.border(b,c));for(const e of this.random.ishuffle(d))if(!a.grid.get(e)&&(b&1?1===b?this.addLeftEdge(a,e)&&c--:this.addRightEdge(a,e)&&c--:0===b?this.addUpEdge(a,e)&&c--:this.addDownEdge(a,e)&&c--,!c))break;if(c)return{ok:!1,fail:`can't fit all edges shuffling ${this.loc}\nmissing ${c} ${b}`}}return lj}addUpEdge({grid:a,
fixed:b},c){var d=c+2048;const e=d-8,f=e-8-8;d+=8;const g=d+8+8;if(a.isBorder(e)){if(a.get(e))return!1}else if(a.get(c-16)||a.isBorder(f)&&a.get(f))return!1;if(a.isBorder(d)){if(a.get(d))return!1}else if(a.get(c+16)||a.isBorder(g)&&a.get(g))return!1;b.add(c);a.set(c,"n");a.set(e,"");a.set(d,"");return!0}addDownEdge({grid:a,fixed:b},c){const d=c-2048,e=d-8,f=d+8;if(!a.get(d)||a.isBorder(e)&&a.get(e)||a.isBorder(f)&&a.get(f))return!1;b.add(c);a.set(c,"n");a.set(e,"");a.set(f,"");return!0}addLeftEdge({grid:a,
fixed:b},c){const d=c+8,e=d-2048,f=d+2048;if(!a.get(d)||a.isBorder(e)&&a.get(e)||a.isBorder(f)&&a.get(f))return!1;b.add(c);a.set(c,"c");return!0}addRightEdge({grid:a,fixed:b},c){const d=c-8,e=d-2048,f=d+2048;if(!a.get(d)||a.isBorder(e)&&a.get(e)||a.isBorder(f)&&a.get(f))return!1;b.add(c);a.set(c,"c");return!0}addEarlyFeatures(a){var b,c,d,e;return this.addSpikes(a,null!==(c=null===(b=this.params.features)||void 0===b?void 0:b.spike)&&void 0!==c?c:0)?this.addOverpasses(a,null!==(e=null===(d=this.params.features)||
void 0===d?void 0:d.over)&&void 0!==e?e:0)?lj:{ok:!1,fail:"add overpasses"}:{ok:!1,fail:"add spikes"}}addLateFeatures(a){var b,c,d,e,f,g;return this.addArenas(a,null!==(c=null===(b=this.params.features)||void 0===b?void 0:b.arena)&&void 0!==c?c:0)?this.addUnderpasses(a,null!==(e=null===(d=this.params.features)||void 0===d?void 0:d.under)&&void 0!==e?e:0)?this.addRamps(a,null!==(g=null===(f=this.params.features)||void 0===f?void 0:f.ramp)&&void 0!==g?g:0)?lj:{ok:!1,fail:"addRamps"}:{ok:!1,fail:"addUnderpasses"}:
{ok:!1,fail:"addArenas"}}addArenas(a,b){if(!b)return!0;const c=a.grid;for(const e of this.random.ishuffle(a.grid.screens())){const f=e|2056;if(this.isEligibleArena(a,f)){var d=this.extract(a.grid,e);d=d.substring(0,4)+"a"+d.substring(5);if(this.orig.tileset.getMetascreensFromTileString(d).length&&(a.fixed.add(f),c.set(f,"a"),b--,!b))return!0}}return!1}isEligibleArena(a,b){a=a.grid;const c=b-8,d=c-8,e=b+8,f=e+8;return"c"!==a.get(b)&&"w"!==a.get(b)||a.get(c)||a.get(e)||!a.isBorder(c)&&a.get(d)||!a.isBorder(e)&&
a.get(f)?!1:!0}addUnderpasses(a,b){return this.addStraightScreenLate(a,b,2048,"b")}addOverpasses(a,b){let c=0;for(;b;){var d=this.random.nextInt(a.h-2)+1;const e=this.random.nextInt(a.w-2)+1;d=d<<12|e<<4|2056;if("c"!==a.grid.get(d)){if(10<++c)throw Error("Bad attempts");}else a.grid.set(d,"b"),a.fixed.add(d),a.grid.set(d-8,""),a.grid.set(d+8,""),b--}return!0}addRamps(a,b){return this.addStraightScreenLate(a,b,8,"/")}addStraightScreenLate(a,b,c,d){if(!b)return!0;for(const f of this.random.ishuffle(a.grid.screens())){const g=
f|2056;var e=g-c;const h=g+c;if("c"===a.grid.get(g)&&!a.grid.get(e)&&!a.grid.get(h)&&(e=this.extract(a.grid,f),e=e.substring(0,4)+d+e.substring(5),this.orig.tileset.getMetascreensFromTileString(e).length&&(a.fixed.add(g),a.grid.set(g,d),b--,!b)))return!0}return!1}addSpikes(a,b){if(!b)return!0;for(var c=0;0<b;){if(20<++c)return!1;let f=Math.min(b,Math.floor(.6*a.h),this.maxSpikes);for(;f<b-1&&f>this.minSpikes;).2>this.random.next()&&f--;var d=2<f&&3<a.w?this.random.nextInt(a.w-2)+1:this.random.nextInt(a.w);
f>b-this.minSpikes&&(f=f>=a.h-2?a.h-2:b);const g=this.random.nextInt(a.h-f-2)+1<<12|d<<4|2056;d=g+(f-1<<12);for(var e=g-4096;f&&e<=d+4096;e+=2048)"c"!==a.grid.get(e)&&(f=0);if(f&&(e=this.tryClear(a,[g-8,g+8,d-8,d+8]),e.length)){for(const b of e)a.grid.set(b,"");a.fixed.add(g-2048);a.fixed.add(g-4096);a.fixed.add(d+2048);a.fixed.add(d+4096);for(c=g;c<=d;c+=2048)a.fixed.add(c),a.grid.set(c,"s");b-=f;c=0}}return 0===b}canRemove(a){return"c"===a}tryClear(a,b){var c=new Map;for(var d of b){if(a.fixed.has(d))return[];
c.set(d,"")}c=a.grid.partition(c);[d]=c.values();if(d.size===c.size)return[...b];d=new Set;const e=new Set(c.values());for(const b of a.fixed)d.add(c.get(b));if(d.size>this.maxPartitions)return[];a=[...b];for(const b of e)d.has(b)||a.push(...b);return a}refine(a){let b=new Set;for(var c=0;c<a.grid.data.length;c++)a.grid.data[c]&&b.add(a.grid.coord(c));for(c=0;a.count>a.size;){if(50<c++)throw Error("refine failed: attempts");let e=0;for(const c of this.random.ishuffle([...b])){if(a.grid.isBorder(c)||
!this.canRemove(a.grid.get(c))||a.fixed.has(c))continue;if(3<e)break;const f=a.grid.partition(this.removalMap(a,c));var [d]=f.values();if(d.size===f.size&&1<f.size)e++,b.delete(c),2056===(c&2056)&&a.count--,a.grid.set(c,"");else{let g;for(const a of f.values())if(!g||a.size>g.size)g=a;if([...a.fixed].every((a)=>g.has(a))&&(d=[...g].filter((a)=>2056==(a&2056)).length,!(d<a.size))){e++;b=g;a.count=d;a.grid.set(c,"");for(const [b,c]of f)c!==g&&a.grid.set(b,"")}}}if(!e){if(this.looseRefine)break;return{ok:!1,
fail:`refine ${a.count} > ${a.size}`}}}return lj}removalMap(a,b){return new Map([[b,""]])}refineEdges(a){var b=[];for(var c=0;c<a.grid.data.length;c++)if(a.grid.data[c]){var d=a.grid.coord(c);a.grid.isBorder(d)||a.fixed.has(d)||(d^d>>8)&8&&b.push(d)}this.random.shuffle(b);d=a.grid.partition(new Map);c=d.size;d=(new Set(d.values())).size;for(const e of b){b=a.grid.partition(new Map([[e,""]]));const [f]=b.values();if(f.size===b.size?b.size===c-1:(new Set(b.values())).size===d&&b.size===c-1)c--,a.grid.set(e,
"")}return!0}removeSpurs(a){for(let c=0;c<a.h;c++)for(let d=0;d<a.w;d++){var b=c<<12|2056|d<<4;if(a.grid.get(b))continue;const e=b-2048,f=b+2048,g=b-8;b+=8;(a.grid.get(e)||a.grid.get(f))&&(a.grid.get(g)||a.grid.get(b))&&(this.random.nextInt(2)?(a.grid.set(e,""),a.grid.set(f,"")):(a.grid.set(g,""),a.grid.set(b,"")))}}removeTightLoops(a){for(let b=0;b<a.h-1;b++){const c=b<<12|2048;for(let b=0;b<a.w-1;b++){const d=c|b<<4|8;this.isTightLoop(a,d)&&this.breakTightLoop(a,d)}}}isTightLoop({grid:a},b){for(let c=
0;6144>c;c+=2048)for(let d=0;24>d;d+=8){const e=c|d;if(2056!==e&&"c"!==a.get(b+e))return!1}return!0}breakTightLoop(a,b){const c=this.random.nextInt(65536);a.grid.set(b+(c&1?c&4096|8:c&16|2048),"")}addStairs(a,b=0,c=0){b=[b,c];if(!b[0]&&!b[1])return lj;for(const c of this.random.ishuffle(a.grid.screens()))if(this.tryAddStair(a,c,b)&&!b[0]&&!b[1])return lj;return{ok:!1,fail:"stairs"}}addEarlyStair(a,b,c){const d=[];var e=b-8,f=b+8;const g=b-2048,h=b+2048;let k=[b-8,b+8];if("<"===c){if(k.push(h),d.push([g,
""]),"c"===a.grid.get(e)&&"c"===a.grid.get(f)&&this.random.nextInt(3))return d.push([h,""],[b,"<"]),d}else">"===c&&(k.push(g),d.push([h,""]));k=k.filter((b)=>"c"===a.grid.get(b));if(!k.length)return[];e=this.random.nextInt(k.length);for(f=0;f<k.length;f++)f!==e&&d.push([k[f],""]);d.push([b,c]);return d}tryAddStair(a,b,c){if(a.fixed.has(b|2056))return!1;const d=this.extract(a.grid,b);var e=c[0]&&c[1],f=this.random.nextInt(c[0]+c[1])<c[0];const g=[f?0:1];e&&g.push(f?1:0);for(const h of g)if(e="<>"[h],
f=d.substring(0,4)+e+d.substring(5),this.orig.tileset.getMetascreensFromTileString(f).length)return a.grid.set(b|2056,e),c[h]--,!0;return!1}tryConnect(a,b,c,d,e=1){for(var f;0<e--;){const e=new Map;let m=b;if(2056!==(b&c&2056))throw Error(`bad start ${w(b)} or end ${w(c)}`);for(e.set(m,d);m!==c;){var g=[];for(const b of[8,-8,2048,-2048]){var h=m+b,k=m+2*b;a.fixed.has(k)||(null!==(f=e.get(k))&&void 0!==f?f:a.grid.get(k))||a.grid.isBorder(h)||g.push(b)}if(!g.length)break;h=(c>>12)-(m>>12);k=(c&240)-
(m&240);const b=new Set(g);0>h&&b.delete(2048);0<h&&b.delete(-2048);0>k&&b.delete(8);0<k&&b.delete(-8);g.push(...b,...b);g=this.random.pick(g);e.set(m+g,d);e.set(m+=2*g,d)}if(m===c){for(const [b,c]of e)a.grid.set(b,c),2056===(b&2056)&&a.count++;return!0}}return!1}tryAddLoop(a,b,c=1){var d=new yg;for(var e=0;e<a.grid.data.length;e++){var f=a.grid.coord(e);a.grid.get(f)||a.grid.isBorder(f)||(a.grid.get(Eg(f))||d.union([f,Eg(f)]),a.grid.get(Gg(f))||d.union([f,Gg(f)]))}e=new n(()=>[]);for(const c of a.grid.screens())if(f=
c+2056,a.grid.get(f))for(const h of[8,-8,2048,-2048]){const k=f+h;if(a.grid.isBorder(k)||a.grid.get(k))continue;const m=f+2*h;if(!a.grid.get(m)){var g=new Map([[k,b]]);g=this.extract(a.grid,c,{replace:g});this.orig.tileset.getMetascreensFromTileString(g).length&&e.get(d.find(m)).push([k,m])}}d=new Map;for(var h of e.values())if(!(2>h.length))for(var [k]of h)d.set(k,h);h=[...d.values()];if(!h.length)return!1;for(;0<c--;){k=this.random.pick(h);const [[c,d],[e,f]]=this.random.ishuffle(k);a.grid.set(c,
b);a.grid.set(e,b);if(this.tryConnect(a,d,f,b,5))return!0;a.grid.set(c,"");a.grid.set(e,"")}return!1}preinfer(a){var b;let c;if(null===(b=this.params.features)||void 0===b?0:b.spike)if(c=this.preinferSpikes(a),!c.ok)return c;return lj}preinferSpikes(){return lj}inferScreens(a){const b=[];for(var c of a.grid.screens()){var d=this.extract(a.grid,c),e=this.orig.tileset.getMetascreensFromTileString(d).filter((a)=>!a.data.mod);if(!e.length)return{ok:!1,fail:`infer screen ${w(c)}: [${d}]`};d=this.random.pick(e);
b.push(d);d.hasFeature("wall")&&a.walls++;d.hasFeature("bridge")&&a.bridges++}c=new ij(this.params.id,this.orig.tileset,a.h,a.w);for(d=0;d<a.h;d++)for(e=0;e<a.w;e++)c.set(d<<4|e,b[d*a.w+e]);return{ok:!0,value:c}}refineMetascreens(a,b){var c,d;const e=(null===(c=this.params.features)||void 0===c?void 0:c.bridge)||0;c=(null===(d=this.params.features)||void 0===d?void 0:d.wall)||0;for(const f of this.random.ishuffle(b.allPos())){d=this.extract(a.grid,(f<<8|f<<4)&61680);const g=b.get(f);this.addBlocks&&
this.tryMeta(b,f,this.orig.tileset.withMod(d,"block"))?g.hasFeature("bridge")&&a.bridges--:a.bridges>e&&g.hasFeature("bridge")&&this.tryMeta(b,f,this.orig.tileset.withMod(d,"bridge"))?a.bridges--:a.walls<c&&!g.hasFeature("wall")&&this.tryMeta(b,f,this.orig.tileset.withMod(d,"wall"))&&a.walls++}return a.bridges!==e?{ok:!1,fail:`refineMeta bridges want ${e} got ${a.bridges}`}:a.walls!==c?{ok:!1,fail:`refineMeta walls want ${c} got ${a.walls}`}:lj}tryMeta(a,b,c){for(const d of c)if(this.checkMeta(a,
new Map([[b,d]])))return a.set(b,d),!0;return!1}checkMeta(a,b){a=a.traverse(b?{with:b}:{});return(new Set(a.values())).size===this.maxPartitions}}class oj extends I{addLateFeatures(a){let b=super.addLateFeatures(a);if(!b.ok)return b;a.grid.data=a.grid.data.map((a)=>"c"===a?"w":a);return lj}}
class pj extends I{refineMetascreens(a,b){for(let c=0;c<a.h;c++)for(let d=0;d<a.w;d++)"a"===a.grid.get(c<<12|d<<4|2056)&&b.set(c<<4|d,b.rom.metascreens.cryptArena_statues);return super.refineMetascreens(a,b)}isEligibleArena(a,b){return!a.grid.get(b-2048)&&super.isEligibleArena(a,b)}}
class qj extends I{constructor(){super(...arguments);this.looseRefine=!0}pickWidth(){return 8}pickHeight(){return 5}initialFill(a){if(5!==a.grid.height||8!==a.grid.width)throw Error("bad size");for(let b=0;b<a.grid.data.length;b++){const c=qj.PATTERN[b];a.grid.data[b]=" "!==c?c:""}return lj}addSpikes(a){var b=this.random.nextInt(4);for(var c=1;10>c;c++)for(var d=0;4>d;d++){var e=2*d+5+17*c;d===b?a.grid.data[e]="c":(e=a.grid.coord(e),a.fixed.add(e),5===c&&(a.fixed.add(e+8),a.fixed.add(e+16),a.fixed.add(e-
8),a.fixed.add(e-16)))}b=0;for(const f of this.random.ishuffle(a.grid.screens())){if(3===b)break;c=f|2056;d=c-2048;e=c+2048;"c"===a.grid.get(c)&&"s"!==a.grid.get(d)&&"s"!==a.grid.get(e)&&(a.grid.set(c,"<"),a.fixed.add(c),a.grid.set(d,""),a.grid.set(e,""),b++)}return!0}addStairs(){return lj}}qj.PATTERN="                    ccccccccccc      c c c c c c    ccc s s s s ccc  c c s s s s c c  ccccscscscscccc  c c s s s s c c  ccc s s s s ccc    c c c c c c      ccccccccccc                    ";class rj extends I{refineEdges(){return!0}preinfer(a){var b=[];for(var c=0;c<a.h;c++)for(var d=0;d<a.w;d++){const e=c<<12|d<<4|2056;a.grid.get(e)&&b.push(e)}b=b.filter((b)=>1===this.tryClear(a,[b]).length);if(!b.length)return{ok:!1,fail:"all critical?"};for(c=0;c<b.length;c++)for(d=0;d<c;d++)if(2<this.tryClear(a,[b[c],b[d]]).length)return super.preinfer(a);return{ok:!1,fail:"unable to find pair of mutually critical tiles"}}}class sj extends rj{removeTightLoops(){}};class tj{constructor(a,b,c=!1){this.overpass=a;this.underpass=b;this.under=new uj(b,a,c);this.over=new vj(a,this.under,c)}shuffle(a){for(;this.under.attempts<this.under.maxAttempts;){this.under.finished=void 0;this.under.shuffle(a);if(!this.under.finished)break;this.over.maxAttempts=this.under.attempts;this.over.shuffle(a);if(this.over.finished){this.over.actuallyFinish();this.under.actuallyFinish();break}}}}
class wj extends I{finish(a){this.finished=a}actuallyFinish(){super.finish(this.finished)}}
class vj extends wj{constructor(a,b,c){super(a);this.location=a;this.under=b;this.reverse=c}init(){this.under.downStairs=[]}actualFinish(){for(const [a,b]of Qa.zip(this.under.upStairs,this.under.downStairs))this.finished.attach(b,this.under.finished,a)}addEarlyFeatures(a){var b=super.addEarlyFeatures(a);if(!b.ok)return b;b=16;let c=0,d=16,e=0;var f=1;for(var g of[...this.under.underBridges,-1,...this.under.upStairs])if(-1===g)f=0;else{var h=g>>>4,k=g&15;b=Math.min(k,b);c=Math.max(k,c);d=Math.min(h-
f,d);e=Math.max(h+f,e)}a:for(g=0;10>g;g++){f=[];h=this.random.nextInt(a.w-(c-b))+b;h=this.random.nextInt(a.h-(e-d))+d-d<<4+(h-b);for(const b of this.under.underBridges){k=b+h;k=k>>>4<<12|(k&15)<<4|2056;if("c"!==a.grid.get(k))continue a;f.push([k,"b"]);f.push([k-8,""]);f.push([k+8,""])}for(const b of this.under.upStairsEffective){k=b+h;k=k>>>4<<12|(k&15)<<4|2056;if("c"!==a.grid.get(k))continue a;f.push([k,this.reverse?"<":">"]);f.push([k+(this.reverse?-2048:2048),""]);k=this.addEarlyStair(a,k,this.reverse?
"<":">");if(!k.length)continue a;f.push(...k)}for(const [b,c]of f)c&&a.fixed.add(b),"<"!==c&&">"!==c||this.under.downStairs.push(b>>4&15|b>>8&240),a.grid.set(b,c);return lj}return{ok:!1,fail:"add fixed stairs with early features"}}addStairs(a,b=0,c=0){return this.reverse?super.addStairs(a,b-this.under.upStairs.length,c):super.addStairs(a,b,c-this.under.upStairs.length)}addOverpasses(){return!0}overpassFailure(){}}
class uj extends wj{constructor(a,b,c){super(a);this.loc=a;this.overpass=b;this.reverse=c;this.underBridges=[];this.upStairs=[];this.upStairsEffective=[];this.downStairs=[]}init(){this.underBridges=[];this.upStairs=[];this.upStairsEffective=[]}finish(a){const b=this.reverse?"stair:down":"stair:up";for(var c of a.allPos()){const d=a.get(c);d.hasFeature("underpass")&&this.underBridges.push(c);if(d.hasFeature(b)){let a=0;for(const b of d.data.exits)"stair:up"===b.type&&32768>b.entrance&&(a=-16),"stair:down"===
b.type&&32768<b.entrance&&(a=16);this.upStairsEffective.push(c+a);this.upStairs.push(c)}}if(!this.underBridges.length)throw Error(`Expected bridge in ${this.loc}\n${a.show()}`);if(!this.upStairs.length)throw Error(`Expected stair in ${this.loc}\n${a.show()}`);c=0;for(const [,a,[e]]of this.orig.exits())a===b&&e>>>8===this.overpass.id&&c++;this.upStairs=this.random.shuffle(this.upStairs).slice(0,c);super.finish(a)}};var xj,J=xj||(xj={});J[J.Unknown=0]="Unknown";J[J.GrassLongGrass=1]="GrassLongGrass";J[J.GrassLongGrassRemapping=2]="GrassLongGrassRemapping";J[J.RiverShortGrass=3]="RiverShortGrass";J[J.SeaCaveEntrance=4]="SeaCaveEntrance";J[J.SeaRocks=5]="SeaRocks";J[J.SeaMarsh=6]="SeaMarsh";J[J.SeaTrees=7]="SeaTrees";J[J.DesertShortGrass=8]="DesertShortGrass";J[J.DesertLongGrass=9]="DesertLongGrass";J[J.DesertMarsh=10]="DesertMarsh";J[J.DesertRocks=11]="DesertRocks";J[J.DesertTrees=12]="DesertTrees";
J[J.DesertTownEntrance=13]="DesertTownEntrance";J[J.LabyrinthParapets=14]="LabyrinthParapets";J[J.SwampDoors=15]="SwampDoors";J[J.ExtraSpikes=16]="ExtraSpikes";J[J.CloseCaves=17]="CloseCaves";function yj(a,b){for(const c in b)b[c].requires=[a];return b}
function zj(a){const {desert:b,grass:c,lime:d,mountain:e,mountainRiver:f,river:g,sea:h}=a.metatilesets;var k=a.metascreens;k.registerFix(xj.DesertRocks);b.getTile(95).copyFrom(91).replaceIn(k.oasisCave,k.oasisLake);b.getTile(90).copyFrom(152).setTiles([,,26,24]);b.getTile(91).copyFrom(128).setTiles([52,50,,]);b.getTile(92).copyFrom(128).setTiles([,,55,53]);b.getTile(93).copyFrom(128).setTiles([,55,,52]);b.getTile(94).copyFrom(128).setTiles([53,,50]);k.registerFix(xj.DesertTrees);b.getTile(99).copyFrom(113);
b.getTile(104).copyFrom(112);b.getTile(105).copyFrom(96);b.getTile(106).copyFrom(101);b.getTile(108).copyFrom(112);b.getTile(110).copyFrom(118);b.getTile(111).copyFrom(120);k.registerFix(xj.GrassLongGrass);c.getTile(64).copyFrom(81);c.getTile(65).copyFrom(82);c.getTile(66).copyFrom(83);c.getTile(67).copyFrom(84);c.getTile(68).copyFrom(85);c.getTile(69).copyFrom(86);c.getTile(70).copyFrom(88);c.getTile(71).copyFrom(89);k.registerFix(xj.SeaCaveEntrance);h.getTile(173).copyFrom(10).replaceIn(k.beachExitN,
k.lighthouseEntrance,k.oceanShrine);h.getTile(10).copyFrom(162);k.boundaryN_cave.screen.set2d(56,[[null,0,0,null],[null,10,10,null],[null,144,144,null],[248,248,248,248]]);k.cornerSE_cave.screen.set2d(73,[[null,0,0],[null,10,10],[null,144,144],[248,247,247],[null,253,247]]);k.cornerSE_cave.screen.set2d(74,[[0,0],[10,10],[144,144],[248,247],[128,253],[128,255],[250,null]]);h.getTile(144).setTiles([145,145,125,125]).setAttrs(2).setEffects(2);g.getTile(144).copyFrom(247);c.getTile(144).copyFrom(247);
b.getTile(144).copyFrom(247);k.registerFix(xj.CloseCaves);g.getTile(7).copyFrom(1).replaceIn(...g);g.getTile(14).copyFrom(2).replaceIn(...g);g.getTile(32).copyFrom(3).replaceIn(...g);g.getTile(33).copyFrom(4).replaceIn(...g);for(const a of[b,h,e,f,d])a.getTile(104).copyFrom(1).replaceIn(...a),a.getTile(131).copyFrom(2).replaceIn(...a),a.getTile(136).copyFrom(3).replaceIn(...a),a.getTile(137).copyFrom(4).replaceIn(...a);for(const a of[g,b,h])a.getTile(1).copyFrom(193).setAlternative(0),a.getTile(2).copyFrom(193).setAlternative(0),
a.getTile(3).copyFrom(215).setAlternative(10),a.getTile(4).copyFrom(215).setAlternative(10);k=[[k.boundaryE_cave,72],[k.boundaryW_cave,121],[k.exitW_cave,56],[k.caveAbovePortoa,86]];for(const [a,b]of k)a.screen.set2d(b,[[1,2],[3,4]]),a.addCustomFlag(!0);{const {locations:{CordelPlainEast:b,CordelPlainWest:c,WaterfallValleyNorth:d},flags:{OpenedSealedCave:e}}=a;b.meta.customFlags.set(48,e);c.meta.customFlags.set(48,e);d.meta.customFlags.set(48,e);a=x.of({y:96,x:96,type:4,id:44});k=x.of({y:112,x:112,
type:2,id:173});d.spawns.splice(1,0,a);d.spawns.push(k)}}var K=xj;class Aj extends I{initialFill(a){const b=a.size+3,c=this.random.nextInt(a.w)<<4|a.h-1<<12|2056;a.grid.isBorder(Dg(c))||a.fixed.add(Dg(c,2));a.grid.isBorder(Eg(c))||a.fixed.add(Eg(c,2));a.grid.set(c,">");a.fixed.add(c);a.grid.set(Fg(c),"w");a.fixed.add(Fg(c));a.fixed.add(Dg(c));a.fixed.add(Eg(c));const d=this.random.nextInt(a.w)<<4|2056,e=Gg(d,2);a.grid.set(d,"<");a.fixed.add(d);a.grid.set(Gg(d),"w");a.fixed.add(Gg(d));a.grid.set(e,"w");a.fixed.add(e);a.grid.set(Gg(e),"w");a.fixed.add(Gg(e));a.fixed.add(Dg(e));
a.fixed.add(Eg(e));if(!this.tryConnect(a,Fg(c,2),Gg(e,2),"w",10))return{ok:!1,fail:"initial connect"};for(;a.count<b;)if(!this.tryAddLoop(a,"w",10))return{ok:!1,fail:"add loops"};return lj}refine(){return lj}refineEdges(){return!0}addArenas(){return!0}addStairs(){return lj}refineMetascreens(a,b){console.log(b.show());for(var c=0;c<b.height;c++)for(var d=0;d<b.width;d++){var e=c<<4|d,f=b.get(e),g=f.edgeIndex("w");if(f.hasFeature("arena"))this.arena=e+16<<8|1;else if(5===g){if(16>e||!b.get(e-16).hasFeature("arena"))b.set(e,
b.rom.metascreens.goaWideHallNS_stairs),a.grid.set((e<<8|e<<4)&61680|2056,"H")}else 1===g&&(this.stair=e<<8|2)}this.reachable=void 0;if(!this.checkMeta(b))return{ok:!1,fail:"initial meta check"};console.log(b.show());c=this.orig.rom.metascreens.goaWideHallNS_deadEnd;for(d=0;d<b.width;d++)for(e=0;e<b.height;e++){f=e<<12|d<<4|2056;for(g=0;e+g<b.height&&"H"===a.grid.get(f+4096*g);)g++;if(!g)continue;const k=[new Map,new Map];for(var h=0;h<g;h++)k[h&1].set(e+h<<4|d,c);h=!1;for(const c of this.random.ishuffle(k))if(!c.size)h=
!0;else if(this.checkMeta(b,c)){for(const [d,g]of c)b.set(d,g),a.grid.set(f+4096*((d>>4)-e),"=");h=!0;break}if(!h)return{ok:!1,fail:"could not rectify hallway"};e+=g}return super.refineMetascreens(a,b)}checkMeta(a,b){b=a.traverse(b?{with:b}:{});const c=b.get(this.stair);if(c!==b.get(this.arena))return console.log(`stair not connected to arena\n${a.show()}`),!1;if(null==this.reachable){if(c&&c.size<.95*b.size)return console.log("too small"),!1;this.reachable=null===c||void 0===c?void 0:c.size;return!0}return(null===
c||void 0===c?void 0:c.size)>.95*this.reachable?!0:!1}}
function Bj(a,b){var c;const {metatilesets:{cave:d,pyramid:e,labyrinth:f,iceCave:g}}=a;a.metascreens.registerFix(K.LabyrinthParapets,1);for(var h of[f,e])h.getTile(43).copyFrom(25).replaceIn(...h),h.getTile(186).copyFrom(27).replaceIn(...h);g.getTile(23).copyFrom(25).replaceIn(...g);g.getTile(24).copyFrom(27).replaceIn(...g);for(var k of[d,e])k.getTile(25).copyFrom(197),k.getTile(27).copyFrom(197);f.getTile(25).copyFrom(198).setAlternative(197);f.getTile(27).copyFrom(196).setAlternative(197);h=new n(()=>
[]);for(var p of a.metatilesets.labyrinth)h.get(p.sid).push(p);for(const [d,e]of h){p=a.screens[d];h=e.map((a)=>{var b;return null===(b=a.data.tilesets.labyrinth)||void 0===b?void 0:b.removeWall});const [f,...g]=new Set(h.filter((a)=>null!=a));if(null!=f){p.set2d(f,[[197,197],[208,197]]);if(g.length)throw Error("bad remove");for(k=0;k<h.length;k++)null==h[k]&&(e[k].data.tilesets.labyrinth.addWall=[f])}if(!(2>e.length)){2<e.length&&(h=b.pick(e.filter((a)=>{var b;return null===(b=a.data.tilesets.labyrinth)||
void 0===b?void 0:b.addWall})),e.splice(e.indexOf(h),1),h.remove());for(const a of e)if(h=null===(c=a.data.tilesets.labyrinth)||void 0===c?void 0:c.addWall,null!=h){a.data.mod="block";for(const a of h)p.set2d(a,[[25,25],[27,27]])}else a.flag="always"}}};class Cj{constructor(a,b,c){this.h=a;this.w=b;this.valid=c;this.fixed=new Set;this.size=0;this.data=new Uint8Array(a*b)}fill(){for(let a=0;a<this.h;a++)for(let b=0;b<this.w;b++){const c=a*this.w+b;0<a&&(this.data[c]|=1);0<b&&(this.data[c]|=2);a<this.h-1&&(this.data[c]|=4);b<this.w-1&&(this.data[c]|=8)}}isBorder(a,b){const c=a%this.w;return this.isBorder2((a-c)/this.w,c,b)}isBorder2(a,b,c){if(0===c)return!a;if(1===c)return!b;if(2===c)return a>=this.h-1;if(3===c)return b>=this.w-1;throw Error("bad direction");
}delete2(a,b,c=a*this.w+b){if(this.fixed.has(c))return!1;const d=new Map;d.set(c,0);for(let e=0;4>e;e++){if(this.isBorder2(a,b,e))continue;const f=c+this.delta(e),g=this.data[f],h=g&~(1<<(e^2));if(g!==h){if(this.fixed.has(f))return!1;d.set(f,h)}}return this.try(d)}delete(a){const b=a%this.w;return this.delete2((a-b)/this.w,b,a)}deleteEdge2(a,b,c,d=a*this.w+b){if(this.fixed.has(d))return!1;if(this.isBorder2(a,b,c))return this.data[d]&=~(1<<c),!0;a=new Map;b=d+this.delta(c);if(this.fixed.has(b))return!1;
a.set(d,this.data[d]&~(1<<c));a.set(b,this.data[b]&~(1<<(c^2)));return this.try(a)}deleteEdge(a,b){const c=a%this.w;return this.deleteEdge2((a-c)/this.w,c,b,a)}refine(a,b){let c=0;const d=new Set;for(var e=0;e<this.data.length;e++)this.data[e]&&c++,this.fixed.has(e)||d.add(e);for(;c>b;){e=!1;for(const f of a.ishuffle(d)){if(c<=b)break;this.data[f]?this.delete(f)&&(e=!0,c--):c--}if(!e)return!1}return!0}validate(){for(let a=0;a<this.h;a++)for(let b=0;b<this.w;b++){const c=a*this.w+b,d=this.data[c];
if(a&&!(this.data[c-this.w]&4)!==!(d&1))throw Error(`invalid above ${a}${b}`);if(b&&!(this.data[c-1]&8)!==!(d&2))throw Error(`invalid left of ${a}${b}`);}}addEdge(a,b,c){const d=a*this.w+b;this.data[d]|=1<<c;this.isBorder2(a,b,c)||(this.data[d+this.delta(c)]|=1<<(c^2))}consolidate(a,b){const c=new Ca;for(var d=0;d<this.data.length;d++)!this.fixed.has(d)&&this.data[d]&&c.add(this.data[d]);for(d=1E3;c.unique()>b&&--d;){var e=[...c].sort((a,b)=>b[1]-a[1]);const d=e[b][1];e=new Set(e.filter((a)=>a[1]<=
d).map((a)=>a[0]));e=this.findEligibleConsolidates(e);if(!e.length)return[];for(const [b,d]of a.pick(e))this.data[b]&&c.delete(this.data[b]),d&&c.add(d),this.data[b]=d}return d?[...c].map((a)=>a[0]):[]}consolidateFixed(a,b){const c=new Ca;for(var d=0;d<this.data.length;d++){var e=this.data[d];!this.fixed.has(d)&&b.has(e)&&c.add(e)}for(d=1E3;c.unique()&&--d;){e=this.findEligibleConsolidates(b);if(!e.length)return!1;for(const [d,g]of a.pick(e))e=this.data[d],b.has(e)&&c.delete(e),b.has(g)&&c.add(g),
this.data[d]=g}return d?!0:!1}findEligibleConsolidates(a){const b=[],c=[];for(let e=0;e<this.data.length;e++){if(this.fixed.has(e))continue;const f=this.data[e];if(a.has(f))for(let g=0;4>g;g++){if(this.isBorder(e,g))continue;var d=this.delta(g);if(this.fixed.has(e+d))continue;const h=1<<g;if(a.has(f^h))continue;const k=1<<(g^2),p=this.data[e+d];d=new Map([[e,f^h],[e+d,p^k]]);if(this.check(d)&&(b.push(d),!a.has(p^k)&&a.has(p))){c.push(d);break}}}return c.length?c:b}try(a){if(!this.check(a))return!1;
for(const [b,c]of a)this.data[b]=c;return!0}check(a){var b;const c=new yg;for(let d=0;d<this.h;d++)for(let e=0;e<this.w;e++){const f=d*this.w+e,g=null!==(b=null===a||void 0===a?void 0:a.get(f))&&void 0!==b?b:this.data[f];g&&c.union([f]);0<d&&g&1&&c.union([f,f-this.w]);0<e&&g&2&&c.union([f,f-1]);d<this.h-1&&g&4&&c.union([f,f+this.w]);e<this.w-1&&g&8&&c.union([f,f+1])}return 1===c.roots().length}addPath(a,b){var c,d,e;if(this.size){var f=[];for(e=0;e<this.data.length;e++)this.data[e]&&15!==this.data[e]&&
f.push(e);if(!f.length)return!1;e=a.pick(f);f=e%this.w;e=(e-f)/this.w}else e=a.nextInt(this.h),f=a.nextInt(this.w);const g=new Map;let h=e*this.w+f,k=0,p=!0;for(;;){let u=!1;const y=null!==(c=g.get(h))&&void 0!==c?c:this.data[h];let G=!1;for(let b of a.ishuffle([0,1,2,3])){var m=1<<b;if(y&m)continue;m|=y;if(this.valid&&!this.valid.has(m))continue;const a=e+Dj[b],c=f+Ej[b];if(0>a||0>c||a>=this.h||c>=this.w)continue;const k=a*this.w+c,A=null!==(d=g.get(k))&&void 0!==d?d:this.data[k],ea=A|1<<(b^2);if(A){if(A===
ea||this.valid&&!this.valid.has(ea))continue;u=!0}p=!this.valid||this.valid.has(ea);g.set(h,m);g.set(k,ea);f=c;e=a;h=k;G=!0;break}if(!G)break;if(u||this.data[h])break;this.size++||this.size++;if(p&&b&&this.size>=b)break;if(p&&a.nextInt(15)<k++)break}if(!g.size||!p)return!1;for(const [a,b]of g)this.data[a]=b;return!0}toGrid(a){const b=new Cg(this.h,this.w);for(let c=0;c<this.h;c++)for(let d=0;d<this.w;d++){const e=this.data[c*this.w+d];if(!e)continue;const f=c<<12|d<<4|2056;b.set(f,a);for(let c=0;4>
c;c++){if(!(e&1<<c))continue;const d=c&1?8:2048;b.set(c&2?f+d:f-d,a)}}return b}delta(a){return(a&2?1:-1)*(a&1?1:this.w)}show(){const a=[];for(let b=0;b<this.h;b++){let c="";for(let a=0;a<this.w;a++)c+=" \u2575\u2574\u2518\u2577\u2502\u2510\u2524\u2576\u2514\u2500\u2534\u250c\u251c\u252c\u253c"[this.data[b*this.w+a]];a.push(c)}return a.join("\n")}}
class Fj{constructor(a,b,c){this.grid=a;this._i=b*a.w+c}get x(){return this._i%this.grid.w}get y(){return Math.floor(this._i/this.grid.w)}go(a){var b=this.grid.delta(a);b=this._i+b;this.grid.data[this._i]|=1<<a;this.grid.data[this._i=b]|=1<<(a^2)}directedPath(a,b,c){for(;;){const d=this.y,e=this.x,f=[];b<d&&f.push(0);c<e&&f.push(1);b>d&&f.push(2);c>e&&f.push(3);if(!f.length)break;this.go(a.pick(f))}}}const Dj=[-1,0,1,0],Ej=[0,-1,0,1];class Gj{constructor(a){this.location=a}shuffle(a){const b=this.location.meta;Hj(b,a);a.nextInt(2)&&Ij(this.location.rom);const c=[...b.exits()].filter((a)=>"stair:up"===a[1]),d=[...b.exits()].filter((a)=>"stair:down"===a[1]);a.shuffle(c);a.shuffle(d);for(var e of[...b.exits()])if(e[2][0]>>>8!==this.location.id){var f=("stair:up"===e[1]?c:d).pop();b.setExit(f[0],f[1],e[2])}if(c.length!==d.length)throw Error("length mismatch");a=a.shuffle([...d]);e=this.location.id<<8;for(f=0;f<c.length;f++)b.setExitOneWay(c[f][0],
c[f][1],[e|d[f][0],d[f][1]]),b.setExitOneWay(a[f][0],a[f][1],[e|c[f][0],c[f][1]])}}function Hj(a,b){const c=b.nextInt(2)+6;b=b.nextInt(3)+2;if(7!==c||3!==b){var {branchNWSE:d,branchNWE:e,branchWSE:f,branchNWE_upStair:g,deadEndW:h,deadEndE:k}=a.rom.metascreens,p=c<<4|b,m=f;7===c&&1===b&&(m=k);7===c&&5===b&&(m=h);a.set2d(99,[[d],[d],[d]]);a.set2d(p-16,[[e],[g],[m]]);a.moveExit(115,p)}}
function Ij(a){const b=a.locations.Pyramid_Draygon.meta,c=a.locations.Pyramid_Main.meta,{metascreens:{hallSE:d,deadEndW_downStair:e,wideHallNE:f,wideHallNW:g,fortressArena_through:h,deadEndS_stairs:k}}=a;b.width=2;b.set2d(0,[[null,k],[null,h],[f,g]]);b.moveExit(32,1);c.set2d(3,[[d,e]]);c.moveExit(3,4);c.attach(4,b,1)};class Jj extends I{constructor(){super(...arguments);this.maxAttempts=250}initialFill(a){let b;if(b=this.initialFillEarly(a),!b.ok)return b;this.initialFillLate(a);if(b=this.connectEarlyToLate(a),!b.ok)return b;a.count=[...a.grid.screens()].filter((b)=>a.grid.get(b+2056)).length;return lj}initialFillEarly(a){const b=new Cj(a.h,a.w,this.getValidEarlyScreens());let c=0;const d=this.targetEarly();for(;20>c++&&b.size<d;)b.addPath(this.random,d)&&(c=0);a.grid.data=b.toGrid(this.early).data;this.addAllFixed(a);
return lj}initialFillLate(a){for(var b=0;b<a.h;b++)for(var c=0;c<a.w;c++){var d=b<<12|c<<4|2056;a.grid.get(d)||a.grid.set(d,"c")}for(b=0;b<a.h;b++)for(c=0;c<a.w;c++)for(const e of[8,2048]){d=b<<12|c<<4|2056;const f=d+e,g=d+2*e;a.grid.isBorder(f)||a.grid.get(f)||"c"!==a.grid.get(d)||"c"!==a.grid.get(g)||a.grid.set(f,"c")}}connectEarlyToLate(a){for(const d of this.random.ishuffle(a.grid.screens()))for(const e of[8,2048]){var b=d|2056;const f=b+e;var c=b+2*e;a.grid.isBorder(f)||a.grid.get(f)||(a.grid.set(f,
"c"),b=this.extract(a.grid,b-2056),c=this.extract(a.grid,c-2056),this.orig.tileset.getMetascreensFromTileString(b).length&&this.orig.tileset.getMetascreensFromTileString(c).length||a.grid.set(f,""))}return lj}pruneDisconnected(a){const b=new Set(a.grid.partition().values());let c=0;for(const d of b)if([...d].some((b)=>a.grid.get(b)===this.early))c+=[...d].filter((a)=>2056===(a&2056)).length;else for(const b of d){if(a.fixed.has(b))return{ok:!1,fail:`fixed tile ${w(b)} disconnected`};a.grid.set(b,
"")}return c<this.params.size?(console.error(a.grid.show()),{ok:!1,fail:"too much disconnected"}):lj}addAllFixed(a){for(let b=0;b<a.grid.data.length;b++)a.grid.data[b]&&a.fixed.add(a.grid.coord(b))}getValidEarlyScreens(){if(!this.validEarlyScreens){const a=new Set;for(const b of this.orig.tileset){const c=b.edgeIndex(this.early);null!=c&&a.add(c)}this.validEarlyScreens=a}return this.validEarlyScreens}addEarlyFeatures(a){var b,c;if(!this.addArenas(a,null!==(c=null===(b=this.params.features)||void 0===
b?void 0:b.arena)&&void 0!==c?c:0))return{ok:!1,fail:"addArenas"};let d;return(d=this.pruneDisconnected(a),d.ok)?super.addEarlyFeatures(a):d}}
class Kj extends Jj{constructor(){super(...arguments);this.early="w";this.maxAttempts=250}targetEarly(){var a;const b=null===(a=this.params.features)||void 0===a?void 0:a.wide;return null!=b?b+2+this.random.nextInt(3):0}initialFillEarly(a){function b(b,c){const d=b%e.w;b=(b-d)/e.w<<12|d<<4|2056;a.grid.set(b,c);for(const c of[-2056,-2048,-2040,-8,0,8,2040,2048,2056])a.fixed.add(b+c)}var c,d;const e=new Cj(a.h,a.w);e.fill();var f=v(e.data.length).slice(e.w),g=this.random.pick(f);if(!e.deleteEdge(g,
1))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(g,2))return{ok:!1,fail:"initial stair"};if(!e.deleteEdge(g,3))return{ok:!1,fail:"initial stair"};e.fixed.add(g);var h=new Set(f);h.delete(g);f=[];for(const a of this.random.ishuffle(h)){h=function(a){if(!e.delete(a))return!1;e.fixed.add(a);return!0};var k=null!==(d=null===(c=this.params.features)||void 0===c?void 0:c.arena)&&void 0!==d?d:0;if(f.length>=k)break;if(a>e.data.length-2*e.w)continue;if(e.fixed.has(a))continue;k=!e.isBorder(a,1);const b=
!e.isBorder(a,3);if(!(k&&e.fixed.has(a-1)||b&&e.fixed.has(a+1)||e.fixed.has(a-e.w)||e.fixed.has(a+e.w))&&e.data[a]&4){if(!h(a-e.w))return{ok:!1,fail:"initial arena"};if(k&&!h(a-1))return{ok:!1,fail:"initial arena"};if(b&&!h(a+1))return{ok:!1,fail:"initial arena"};h=a+e.w;if(5!==(e.data[h]&5))return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(h,1))return{ok:!1,fail:"initial arena"};if(!e.deleteEdge(h,3))return{ok:!1,fail:"initial arena"};e.deleteEdge(h+e.w,2);e.fixed.add(h);f.push(a);e.fixed.add(a)}}if(!e.refine(this.random,
this.targetEarly()))return{ok:!1,fail:"refine"};c=new Set;for(d=1;16>d;d++)this.getValidEarlyScreens().has(d)||c.add(d);if(!e.consolidateFixed(this.random,c))return{ok:!1,fail:"consolidate"};a.grid.data=e.toGrid("w").data;b(g,">");for(const a of f)b(a,"a");g=3;for(const b of a.grid.screens())a.grid.get(b+2056)&&g++;a.size=g;return lj}addStairs(a,b,c){return super.addStairs(a,b,c?c-1:0)}addArenas(){return!0}connectEarlyToLate(a){for(let b=0;b<a.h;b++){const c=b<<12|2056;for(let b=0;b<a.w;b++){const d=
c|b<<4;"a"===a.grid.get(d)&&a.grid.set(d-2048,"c")}}return lj}preinfer(a){var b=new Map;for(var c=0;c<a.grid.data.length;c++)"w"===a.grid.data[c]&&b.set(a.grid.coord(c),"");b=a.grid.partition(b);c=new Set;for(const [d,e]of b)"<"===a.grid.get(d)&&c.add(e);return 2>c.size?{ok:!1,fail:"stairs bunched"}:lj}refineMetascreens(a,b){for(const a of b.allPos())b.get(a).hasFeature("arena")&&b.set(a,b.rom.metascreens.fortressArena_through);return lj}refineEdges(){return!0}};class Lj extends Jj{constructor(){super(...arguments);this.early="r";this.maxAttempts=250}targetEarly(){var a,b;return null!==(b=null===(a=this.params.features)||void 0===a?void 0:a.river)&&void 0!==b?b:0}preinfer(a){if(2>[...this.orig.exits()].length)return lj;var b=new Map;for(var c=0;c<a.grid.data.length;c++)"r"===a.grid.data[c]&&b.set(a.grid.coord(c),"");b=a.grid.partition(b);c=[];for(let d=0;d<a.grid.data.length;d++)("<"===a.grid.data[d]||">"===a.grid.data[d]||a.grid.data[d]&&a.grid.isBorder(a.grid.coord(d)))&&
c.push(b.get(a.grid.coord(d)));return(new Set(c)).size<c.length?{ok:!1,fail:"river didn't matter"}:super.preinfer(a)}addLateFeatures(){return lj}addArenas(a,b){if(!b)return!0;const c=a.grid;for(const d of this.random.ishuffle(a.grid.screens())){const e=d|2056,f=e-8,g=f-8,h=e+8,k=h+8,p=e-2048,m=e+2048;if("c"!==c.get(e))continue;if("c"!==c.get(p))continue;if("c"!==c.get(m))continue;const u=c.isBorder(f)?"":this.extract(c,g-2056),y=c.isBorder(h)?"":this.extract(c,k-2056);if(!/[^ c]/.test(u+y)&&(c.isBorder(f)||
(c.set(f,""),c.set(g,""),c.set(g-8,""),c.set(g-2048,""),c.set(g+2048,"")),c.isBorder(h)||(c.set(h,""),c.set(k,""),c.set(k+8,""),c.set(k-2048,""),c.set(k+2048,"")),a.fixed.add(e),a.fixed.add(p),a.fixed.add(m),c.set(e,"a"),b--,!b))return this.pruneDisconnected(a),!0}return!1}}
class Mj extends Lj{constructor(){super(...arguments);this.addBlocks=!1}initialFillEarly(a){const b=new Cj(a.h,a.w,this.getValidEarlyScreens()),c=2+this.random.nextInt(a.w-4);var d=2+this.random.nextInt(a.w-4);d=new Fj(b,a.h-1,d);d.go(0);d.directedPath(this.random,1,c);d.go(0);a.grid.data=b.toGrid("r").data;this.addAllFixed(a);return lj}addEdges(a){var b=-1;const c=a.h-1<<12|2056;for(var d=0;d<a.w;d++)"r"===a.grid.get(c|d<<4)&&(b=d);if(0>b)throw Error("no river on bottom edge");d=c|this.random.nextInt(b)<<
4;b=c|b+1+this.random.nextInt(a.w-1-b)<<4;a.grid.set(d,">");a.grid.set(d-8,"");a.grid.set(d+8,"");a.grid.set(b,">");a.grid.set(b-8,"");a.grid.set(b+8,"");a.fixed.add(d);a.fixed.add(b);return lj}addStairs(){return lj}checkMeta(a,b){a=a.traverse(b?{flight:!0,with:b}:{flight:!0});return(new Set(a.values())).size===this.maxPartitions}};class Nj extends I{build(a=this.pickHeight(),b=this.pickWidth()){function c(a,b){h.delete2(a,b);h.fixed.add(a*h.w+b)}var d,e,f,g=this.orig.rom;const h=new Cj(a,b);h.fill();var k=28>a*b?0:this.random.nextInt(a-1),p=this.random.nextInt(b);h.fixed.add(k*h.w+p);p&&c(k,p-1);p<h.w-1&&c(k,p+1);k&&(c(k-1,p),p&&c(k-1,p-1),p<h.w-1&&c(k-1,p+1));const m=new Set;for(var u=0;4>u;u++){var y=u&1?a:b,G=this.random.shuffle(v(y));y=u&2?y:0;let c=null!==(e=null===(d=this.params.edges)||void 0===d?void 0:d[u])&&void 0!==
e?e:0;for(;c&&G.length;){const a=u&1?G.pop():y,b=u&1?y:G.pop(),d=a*h.w+b;h.data[d]&&!h.fixed.has(d)&&(h.addEdge(a,b,u),m.add(a<<4|b),c--)}if(c)return{ok:!1,fail:`could not add all edges: ${u} ${c}\n${h.toGrid("c").show()}\n${h.data}`}}console.log(h.toGrid("c").show());d=0;e=h.h*h.w*(.15*this.random.next()+.4);for(var A of this.random.ishuffle(v(h.data.length<<2)))if(u=A>>>2,G=A&3,h.isBorder(u,G)&&h.deleteEdge(u,G)&&++d>=e)break;d=new Set;e=new Set;const T=[];A=[];let ma;for(var M of this.orig.tileset)if(M.hasFeature("arena"))ma=
M;else if(M.hasFeature("empty"))T[0]=M;else{u=M.edgeIndex("s");if(null==u)throw Error("bad edges");((null===(f=M.data.exits)||void 0===f?0:f.some((a)=>!a.type.startsWith("edge")))?A:T)[u]=M;(0>M.sid?e:d).add(M.sid)}if(!ma)throw Error("never found arena");const Z=new Set(h.consolidate(this.random,d.size).map((a)=>T[a].sid));if(!Z.size)return{ok:!1,fail:"consolidate failed"};f=[...e].filter((a)=>Z.has(a));M=[...d].filter((a)=>!Z.has(a));if(f.length>M.length)throw Error("out of space");if(f.length){for(d=
-1;g.metascreens.getById(d).length;)d--;for(e=0;e<f.length;e++)g.metascreens.renumber(M[e],d),g.metascreens.renumber(f[e],M[e]),d=f[e];g.metascreens.renumber(d,f.pop())}a=new ij(this.orig.id,this.orig.tileset,a,b);for(b=0;b<h.h;b++)for(g=0;g<h.w;g++)a.set(b<<4|g,b===k&&g===p?ma:T[h.data[b*h.w+g]]);k=[...this.orig.exits()].filter((a)=>!a[1].startsWith("edge")).length;for(const b of this.random.ishuffle(a.allPos())){if(!k)break;!m.has(b)&&(p=A[h.data[(b>>>4)*h.w+(b&15)]])&&(a.set(b,p),k--)}return k?
{ok:!1,fail:"could not place all doors"}:{ok:!0,value:a}}};let Oj=0;class Pj{constructor(){this.name=`Area ${++Oj}`}}class Qj extends Pj{constructor(){super(...arguments);this.type="overworld"}}class Rj extends Pj{constructor(){super(...arguments);this.type="town"}}class Sj extends Pj{constructor(){super(...arguments);this.type="connector";this.exits=[2,2]}}class Tj extends Pj{constructor(){super(...arguments);this.type="terminal";this.exits=[1,1]}}var Uj;
(function(a){a.Unused=new Tj;a.ValleyOfWind=new class extends Qj{constructor(){super(...arguments);this.exits=[3,6]}};a.CordelPlain=new class extends Qj{constructor(){super(...arguments);this.exits=[5,8]}};a.WaterfallValley=new class extends Qj{constructor(){super(...arguments);this.exits=[6,6]}};a.AngrySea=new class extends Qj{constructor(){super(...arguments);this.exits=[0,0]}};a.GoaValley=new class extends Qj{constructor(){super(...arguments);this.exits=[0,0]}};a.Desert1=new class extends Qj{constructor(){super(...arguments);
this.exits=[0,0]}};a.Desert2=new class extends Qj{constructor(){super(...arguments);this.exits=[0,0]}};a.Leaf=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.Brynmaer=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.Oak=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.Amazones=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.Nadare=new class extends Rj{constructor(){super(...arguments);this.exits=
[0,0]}};a.Portoa=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.Joel=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.ZombieTown=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.Swan=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.Shyron=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.Goa=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};
a.Sahara=new class extends Rj{constructor(){super(...arguments);this.exits=[0,0]}};a.WindmillCave=new class extends Sj{};a.SealedCave=new class extends Sj{};a.ZebuCave=new class extends Sj{};a.MtSabreWest=new class extends Sj{};a.MtSabreNorth=new class extends Sj{};a.LimeTreeValley=new class extends Sj{};a.PortoaPalace=new class extends Sj{};a.FishermanHouse=new class extends Sj{};a.UndergroundChannel=new class extends Sj{};a.JoelPassage=new class extends Sj{};a.EvilSpiritIslandEntrance=new class extends Sj{};
a.EvilSpiritIsland=new class extends Sj{};a.KirisaPlantCave=new class extends Sj{};a.SwanGate=new class extends Sj{};a.MtHydra=new class extends Sj{};a.GoaFortress=new class extends Sj{};a.OasisEntrance=new class extends Sj{};a.OasisCave=new class extends Sj{};a.DesertCave1=new class extends Sj{};a.SaharaMeadow=new class extends Sj{};a.DesertCave2=new class extends Sj{};a.EastCave=new class extends Sj{};a.Swamp=new class extends Sj{};a.Mezame=new class extends Tj{};a.Windmill=new class extends Tj{};
a.StomHouse=new class extends Tj{};a.WaterfallCave=new class extends Tj{};a.KirisaMeadow=new class extends Tj{};a.FogLampCave=new class extends Tj{};a.LimeTreeLake=new class extends Tj{};a.Lighthouse=new class extends Tj{};a.SaberaFortress=new class extends Tj{};a.ShyronTemple=new class extends Tj{};a.Styx=new class extends Tj{};a.FortressBasement=new class extends Tj{};a.Pyramid=new class extends Tj{};a.Crypt=new Tj;a.Tower=new Tj})(Uj||(Uj={}));
for(const [a,b]of Object.entries(Uj))b.name=a.replace(/([a-z])([A-Z0-9])/g,"$1 $2").replace("Of","of");var L=Uj;const {$0a:Vj,$0b:Wj,$0c:Xj,$0d:Yj}=z,Zj={subArea:"cave",music:(a)=>`${a.name}-Cave`,palette:(a)=>`${a.name}-Cave`},N={subArea:"house",palette:()=>Symbol()},ak={subArea:"house",palette:()=>Symbol(),music:(a)=>`${a.name}-FortuneTeller`},bk={name:"mesia",music:(a)=>`${a.name}-Mesia`,palette:(a)=>"Tower"===a.name?a.name:`${a.name}-Mesia`},ck={name:"dyna",music:(a)=>`${a.name}-Dyna`,palette:(a)=>`${a.name}-Dyna`},dk={name:"goa 1",music:"goa 1",palette:"goa 1"},ek={name:"goa 2",music:"goa 2",palette:"goa 2"},
fk={name:"goa 3",music:"goa 3",palette:"goa 3"},gk=Object.assign({},fk,{palette:"goa 3 upper"}),hk={name:"goa 4",music:"goa 4",palette:"goa 4"},ik=Object.assign({},hk,{palette:"goa 4 lower"}),Q=(()=>{function a(a,e){e=void 0===e?{}:e;e=Object.assign({},e);c=e.area=e.area||c;return b(a,e)}const b=ee();let c;a.commit=(a)=>{b.commit(a,(b,c,d)=>{b=Hd(b);const e=d.area,f="function"===typeof d.music?d.music(e):null!=d.music?d.music:e.name,g="function"===typeof d.palette?d.palette(e):d.palette||e.name;b=
{area:e,name:b,music:f,palette:g};null!=d.subArea&&(b.subArea=d.subArea);null!=d.bossScreen&&(b.bossScreen=d.bossScreen);d=new jk(a.rom,c,b);0<=c&&(a[c]=d);return d})};return a})();
class kk extends Array{constructor(a){super(256);this.rom=a;this.MezameShrine=Q(0,{area:L.Mezame});this.Leaf_OutsideStart=Q(1,{music:1});this.Leaf=Q(2,{area:L.Leaf});this.ValleyOfWind=Q(3,{area:L.ValleyOfWind});this.SealedCave1=Q(4,{area:L.SealedCave});this.SealedCave2=Q(5);this.SealedCave6=Q(6);this.SealedCave4=Q(7);this.SealedCave5=Q(8);this.SealedCave3=Q(9);this.SealedCave7=Q(10,{bossScreen:145});this.SealedCave8=Q(12);this.WindmillCave=Q(14,{area:L.WindmillCave});this.Windmill=Q(15,{area:L.Windmill,
music:0});this.ZebuCave=Q(16,{area:L.ZebuCave});this.MtSabreWest_Cave1=Q(17,Object.assign({},{area:L.MtSabreWest},Zj));this.CordelPlainWest=Q(20,{area:L.CordelPlain});this.CordelPlainEast=Q(21);this.Brynmaer=Q(24,{area:L.Brynmaer});this.OutsideStomHouse=Q(25,{area:L.StomHouse,music:0});this.Swamp=Q(26,{area:L.Swamp,bossScreen:124});this.Amazones=Q(27,{area:L.Amazones,fixed:[13,14]});this.Oak=Q(28,{area:L.Oak});this.StomHouse=Q(30,{area:L.StomHouse});this.MtSabreWest_Lower=Q(32,{area:L.MtSabreWest});
this.MtSabreWest_Upper=Q(33);this.MtSabreWest_Cave2=Q(34,Zj);this.MtSabreWest_Cave3=Q(35,Zj);this.MtSabreWest_Cave4=Q(36,Zj);this.MtSabreWest_Cave5=Q(37,Zj);this.MtSabreWest_Cave6=Q(38,Zj);this.MtSabreWest_Cave7=Q(39,Zj);this.MtSabreNorth_Main=Q(40,{area:L.MtSabreNorth,bossScreen:181});this.MtSabreNorth_Middle=Q(41);this.MtSabreNorth_Cave2=Q(42,Zj);this.MtSabreNorth_Cave3=Q(43,Zj);this.MtSabreNorth_Cave4=Q(44,Zj);this.MtSabreNorth_Cave5=Q(45,Zj);this.MtSabreNorth_Cave6=Q(46,Zj);this.MtSabreNorth_PrisonHall=
Q(47,Zj);this.MtSabreNorth_LeftCell=Q(48,Zj);this.MtSabreNorth_LeftCell2=Q(49,Zj);this.MtSabreNorth_RightCell=Q(50,Zj);this.MtSabreNorth_Cave8=Q(51,Zj);this.MtSabreNorth_Cave9=Q(52,Zj);this.MtSabreNorth_SummitCave=Q(53,Zj);this.MtSabreNorth_Cave1=Q(56,Zj);this.MtSabreNorth_Cave7=Q(57,Zj);this.Nadare_Inn=Q(60,Object.assign({},{area:L.Nadare},N));this.Nadare_ToolShop=Q(61,N);this.Nadare_BackRoom=Q(62,N);this.WaterfallValleyNorth=Q(64,{area:L.WaterfallValley});this.WaterfallValleySouth=Q(65);this.LimeTreeValley=
Q(66,{area:L.LimeTreeValley,music:0});this.LimeTreeLake=Q(67,{area:L.LimeTreeLake,music:0});this.KirisaPlantCave1=Q(68,{area:L.KirisaPlantCave});this.KirisaPlantCave2=Q(69);this.KirisaPlantCave3=Q(70);this.KirisaMeadow=Q(71,{area:L.KirisaMeadow});this.FogLampCave1=Q(72,{area:L.FogLampCave});this.FogLampCave2=Q(73);this.FogLampCave3=Q(74);this.FogLampCaveDeadEnd=Q(75);this.FogLampCave4=Q(76);this.FogLampCave5=Q(77);this.FogLampCave6=Q(78);this.FogLampCave7=Q(79);this.Portoa=Q(80,{area:L.Portoa});this.Portoa_FishermanIsland=
Q(81,{area:L.FishermanHouse,music:0});this.MesiaShrine=Q(82,Object.assign({},{area:L.LimeTreeLake},bk));this.WaterfallCave1=Q(84,{area:L.WaterfallCave});this.WaterfallCave2=Q(85);this.WaterfallCave3=Q(86);this.WaterfallCave4=Q(87);this.TowerEntrance=Q(88,{area:L.Tower});this.Tower1=Q(89);this.Tower2=Q(90);this.Tower3=Q(91);this.TowerOutsideMesia=Q(92);this.TowerOutsideDyna=Q(93);this.TowerMesia=Q(94,bk);this.TowerDyna=Q(95,ck);this.AngrySea=Q(96,{area:L.AngrySea});this.BoatHouse=Q(97);this.JoelLighthouse=
Q(98,{area:L.Lighthouse,music:0});this.UndergroundChannel=Q(100,{area:L.UndergroundChannel});this.ZombieTown=Q(101,{area:L.ZombieTown});this.EvilSpiritIsland1=Q(104,{area:L.EvilSpiritIslandEntrance,music:1});this.EvilSpiritIsland2=Q(105,{area:L.EvilSpiritIsland});this.EvilSpiritIsland3=Q(106);this.EvilSpiritIsland4=Q(107);this.SaberaPalace1=Q(108,{area:L.SaberaFortress,bossScreen:253});this.SaberaPalace2=Q(109);this.SaberaPalace3=Q(110,{bossScreen:253});this.JoelSecretPassage=Q(112,{area:L.JoelPassage});
this.Joel=Q(113,{area:L.Joel});this.Swan=Q(114,{area:L.Swan,music:1});this.SwanGate=Q(115,{area:L.SwanGate,music:1});this.GoaValley=Q(120,{area:L.GoaValley});this.MtHydra=Q(124,{area:L.MtHydra});this.MtHydra_Cave1=Q(125,Zj);this.MtHydra_OutsideShyron=Q(126,{fixed:[13,14]});this.MtHydra_Cave2=Q(127,Zj);this.MtHydra_Cave3=Q(128,Zj);this.MtHydra_Cave4=Q(129,Zj);this.MtHydra_Cave5=Q(130,Zj);this.MtHydra_Cave6=Q(131,Zj);this.MtHydra_Cave7=Q(132,Zj);this.MtHydra_Cave8=Q(133,Zj);this.MtHydra_Cave9=Q(134,
Zj);this.MtHydra_Cave10=Q(135,Zj);this.Styx1=Q(136,{area:L.Styx});this.Styx2=Q(137);this.Styx3=Q(138);this.Shyron=Q(140,{area:L.Shyron});this.Goa=Q(142,{area:L.Goa});this.GoaFortressBasement=Q(143,{area:L.FortressBasement,music:0});this.Desert1=Q(144,{area:L.Desert1});this.OasisCaveMain=Q(145,{area:L.OasisCave});this.DesertCave1=Q(146,{area:L.DesertCave1,music:0});this.Sahara=Q(147,{area:L.Sahara});this.SaharaOutsideCave=Q(148,{music:0});this.DesertCave2=Q(149,{area:L.DesertCave2,music:1});this.SaharaMeadow=
Q(150,{area:L.SaharaMeadow,music:0});this.Desert2=Q(152,{area:L.Desert2});this.Pyramid_Entrance=Q(156,{area:L.Pyramid});this.Pyramid_Branch=Q(157);this.Pyramid_Main=Q(158);this.Pyramid_Draygon=Q(159);this.Crypt_Entrance=Q(160,{area:L.Crypt});this.Crypt_Hall1=Q(161);this.Crypt_Branch=Q(162);this.Crypt_DeadEndLeft=Q(163);this.Crypt_DeadEndRight=Q(164);this.Crypt_Hall2=Q(165);this.Crypt_Draygon2=Q(166);this.Crypt_Teleporter=Q(167,{music:"Crypt-Teleporter"});this.GoaFortress_Entrance=Q(168,{area:L.GoaFortress,
music:1});this.GoaFortress_Kelbesque=Q(169,Object.assign({},{bossScreen:115},dk));this.GoaFortress_Zebu=Q(170,Object.assign({},dk,{palette:1}));this.GoaFortress_Sabera=Q(171,ek);this.GoaFortress_Tornel=Q(172,Object.assign({},{bossScreen:145},ek,{palette:1}));this.GoaFortress_Mado1=Q(173,fk);this.GoaFortress_Mado2=Q(174,gk);this.GoaFortress_Mado3=Q(175,gk);this.GoaFortress_Karmine1=Q(176,hk);this.GoaFortress_Karmine2=Q(177,hk);this.GoaFortress_Karmine3=Q(178,hk);this.GoaFortress_Karmine4=Q(179,hk);
this.GoaFortress_Karmine5=Q(180,hk);this.GoaFortress_Karmine6=Q(181,ik);this.GoaFortress_Karmine7=Q(182,Object.assign({},{bossScreen:253},ik));this.GoaFortress_Exit=Q(183,{music:0});this.OasisCave_Entrance=Q(184,{area:L.OasisEntrance,music:2});this.GoaFortress_Asina=Q(185,Object.assign({},{area:L.GoaFortress},gk,{bossScreen:145}));this.GoaFortress_Kensu=Q(186,hk);this.Goa_House=Q(187,Object.assign({},{area:L.Goa},N));this.Goa_Inn=Q(188,N);this.Goa_ToolShop=Q(190,N);this.Goa_Tavern=Q(191,N);this.Leaf_ElderHouse=
Q(192,Object.assign({},{area:L.Leaf},N));this.Leaf_RabbitHut=Q(193,N);this.Leaf_Inn=Q(194,N);this.Leaf_ToolShop=Q(195,N);this.Leaf_ArmorShop=Q(196,N);this.Leaf_StudentHouse=Q(197,N);this.Brynmaer_Tavern=Q(198,Object.assign({},{area:L.Brynmaer},N));this.Brynmaer_PawnShop=Q(199,N);this.Brynmaer_Inn=Q(200,N);this.Brynmaer_ArmorShop=Q(201,N);this.Brynmaer_ItemShop=Q(203,N);this.Oak_ElderHouse=Q(205,Object.assign({},{area:L.Oak},N));this.Oak_MotherHouse=Q(206,N);this.Oak_ToolShop=Q(207,N);this.Oak_Inn=
Q(208,N);this.Amazones_Inn=Q(209,Object.assign({},{area:L.Amazones},N));this.Amazones_ItemShop=Q(210,N);this.Amazones_ArmorShop=Q(211,N);this.Amazones_Elder=Q(212,N);this.Nadare=Q(213,{area:L.Nadare});this.Portoa_FishermanHouse=Q(214,Object.assign({},{area:L.FishermanHouse},N,{music:0}));this.Portoa_PalaceEntrance=Q(215,{area:L.PortoaPalace});this.Portoa_FortuneTeller=Q(216,Object.assign({},{area:L.Portoa,fixed:[13,14]},ak));this.Portoa_PawnShop=Q(217,N);this.Portoa_ArmorShop=Q(218,N);this.Portoa_Inn=
Q(220,N);this.Portoa_ToolShop=Q(221,N);this.PortoaPalace_Left=Q(222,Object.assign({},{area:L.PortoaPalace},N));this.PortoaPalace_ThroneRoom=Q(223,N);this.PortoaPalace_Right=Q(224,N);this.Portoa_AsinaRoom=Q(225,Object.assign({},{area:L.UndergroundChannel},N,{music:"asina"}));this.Amazones_ElderDownstairs=Q(226,Object.assign({},{area:L.Amazones},N));this.Joel_ElderHouse=Q(227,Object.assign({},{area:L.Joel},N));this.Joel_Shed=Q(228,N);this.Joel_ToolShop=Q(229,N);this.Joel_Inn=Q(231,N);this.ZombieTown_House=
Q(232,Object.assign({},{area:L.ZombieTown},N));this.ZombieTown_HouseBasement=Q(233,N);this.Swan_ToolShop=Q(235,Object.assign({},{area:L.Swan},N));this.Swan_StomHut=Q(236,N);this.Swan_Inn=Q(237,N);this.Swan_ArmorShop=Q(238,N);this.Swan_Tavern=Q(239,N);this.Swan_PawnShop=Q(240,N);this.Swan_DanceHall=Q(241,N);this.Shyron_Temple=Q(242,{area:L.ShyronTemple,bossScreen:112});this.Shyron_TrainingHall=Q(243,Object.assign({},{area:L.Shyron},N));this.Shyron_Hospital=Q(244,N);this.Shyron_ArmorShop=Q(245,N);this.Shyron_ToolShop=
Q(246,N);this.Shyron_Inn=Q(247,N);this.Sahara_Inn=Q(248,Object.assign({},{area:L.Sahara},N));this.Sahara_ToolShop=Q(249,N);this.Sahara_ElderHouse=Q(250,N);this.Sahara_PawnShop=Q(251,N);this.EastCave1=Q(-1,{area:L.EastCave});this.EastCave2=Q(-1);this.EastCave3=Q(-1);this.FishermanBeach=Q(-1,Object.assign({},{area:L.FishermanHouse},N));this.locsByScreen=new n(()=>[]);Q.commit(this);for(let b=0;256>b;b++)this[b]?this.indexScreens(this[b]):this[b]=new jk(a,b,{area:L.Unused,name:"",music:"",palette:""})}indexScreens(a){for(const b of a.screens)for(const c of b)this.locsByScreen.get(c).push(a)}renumberScreen(a,
b){var c=this.locsByScreen.get(a);this.locsByScreen.set(b,c);this.locsByScreen.delete(a);for(const d of c)for(const e of d.screens)for(c=0;c<e.length;c++)e[c]===a&&(e[c]=b)}allocate(a){for(const b of this)if(!b.used)return a.id=b.id,a.used=!0,this.indexScreens(a),this[b.id]=a;throw Error("No unused location");}write(){const a=this.rom.assembler();je(a,Vj,34040,40960);je(a,Wj,40960,48640);je(a,Xj,37881,40960);je(a,Yj,40960,44032);je(a,Yj,44544,49152);for(const b of this)b.assemble(a);return[a.module()]}location(){}}
class jk extends mg{constructor(a,b,c){super(a,b);this.data=c;this._meta=this._isShop=void 0;var d=0<=b?Qd(a.prg,this.mapDataPointer)+49152:0;if(this.used=49152<d&&!!this.name){var e=Qd(a.prg,d)+49152;b=Qd(a.prg,d+2)+49152;c=Qd(a.prg,d+4)+49152;var f=Qd(a.prg,d+6)+49152,g=Qd(a.prg,d+8)+49152,h=this.used&&e!==d+10,k=f-c;this.exits=(()=>{const b=[];let c=f;for(;!(a.prg[c]&128);)255!=a.prg[c+2]&&b.push(x.from(a.prg,c)),c+=4;255!==a.prg[c]&&(h=!!(a.prg[c]&64),k=(a.prg[c]&31)<<2);return b})();d=h?Qd(a.prg,
d+10)+49152:0;this.bgm=this.originalBgm=a.prg[e];this.layoutWidth=a.prg[e+1];this.layoutHeight=a.prg[e+2];this.animation=a.prg[e+3];var p=a.prg[e+4]?256:0;this.screens=v(this.height,(b)=>Id(a.prg,e+5+b*this.width,this.width).map((a)=>p|a));this.tilePalettes=Id(a.prg,b,3);this.originalTilePalettes=Id(this.tilePalettes,0,3);this.tileset=a.prg[b+3];this.tileEffects=a.prg[b+4];this.tilePatterns=Id(a.prg,b+5,2);this.entrances=Md(4,a.prg.slice(c,c+k),(a)=>x.from(a));this.flags=Kd(a.prg,g,2,255,Infinity,
(a)=>x.from(a));this.pits=d?Kd(a.prg,d,4,255,Infinity,(a)=>x.from(a)):[];b=Qd(a.prg,this.npcDataPointer)+65536;this.spritePalettes=(c=65536!==b)?Id(a.prg,b+1,2):[0,0];this.spritePatterns=c?Id(a.prg,b+3,2):[0,0];this.spawns=c?Kd(a.prg,b+5,4,255,Infinity,(a)=>x.from(a)):[]}else this.animation=this.layoutHeight=this.layoutWidth=this.bgm=this.originalBgm=0,this.screens=[[0]],this.tilePalettes=[36,1,38],this.originalTilePalettes=[36,1,38],this.tileset=128,this.tileEffects=179,this.tilePatterns=[2,4],this.exits=
[],this.entrances=[],this.flags=[],this.pits=[],this.spawns=[],this.spritePalettes=[0,0],this.spritePatterns=[0,0]}set meta(a){this._meta=a}get meta(){this.ensureMeta();return this._meta}ensureMeta(){this._meta||(this._meta=ij.of(this))}set musicGroup(a){this._musicGroup=a}get musicGroup(){this.ensureMusicGroup();return this._musicGroup}ensureMusicGroup(){if(null==this._musicGroup){const a=this.data.music;this._musicGroup="number"!==typeof a?a:this.rom.locations[this.exits[a].dest].musicGroup}}set colorGroup(a){this._colorGroup=
a}get colorGroup(){this.ensureColorGroup();return this._colorGroup}ensureColorGroup(){if(null==this._colorGroup){const a=this.data.music;this._colorGroup="number"!==typeof a?a:this.rom.locations[this.exits[a].dest].colorGroup}}lazyInitialization(){this.ensureMeta();this.ensureMusicGroup();this.ensureColorGroup()}get name(){return this.data.name}get mapDataPointer(){if(0>this.id)throw Error(`no mapdata pointer for ${this.name}`);return 82688+(this.id<<1)}get npcDataPointer(){if(0>this.id)throw Error(`no npcdata pointer for ${this.name}`);
return 102913+(this.id<<1)}get hasSpawns(){return 0<this.spawns.length}mapPlane(){const a=new Set;for(const b of this.screens)for(const c of b)a.add(c>>>8);if(1!==a.size)throw Error(`Non-unique screen page: ${[...a].join(", ")}`);return a[Symbol.iterator]().next().value}isShop(){null==this._isShop&&(this._isShop=0<=this.rom.shops.findIndex((a)=>a.location===this.id));return this._isShop}spawn(a){const b=this.spawns[a-13];if(!b)throw Error(`Expected spawn $${w(a)}`);return b}get width(){return this.layoutWidth+
1}set width(a){this.layoutWidth=a-1}get height(){return this.layoutHeight+1}set height(a){this.layoutHeight=a-1}findOrAddEntrance(a,b){for(let c=0;c<this.entrances.length;c++){const d=this.entrances[c];if(d.screen===a&&d.coord===b)return c}this.entrances.push(x.of({screen:a,coord:b}));return this.entrances.length-1}assemble(a){if(this.used){var b=this.id.toString(16).padStart(2,"0"),c=this.spawns.length?this.spritePalettes:[255,255],d=[],e=[0,...c,...this.spawns.length?this.spritePatterns:[255,255],
...Od(this.spawns),255];a.segment("0c","0d");a.reloc(`NpcData_${b}`);var f=a.pc();a.byte(...e);a.org(37377+(this.id<<1),`NpcData_${b}_Ptr`);a.word(f);a.segment("0a","0b");e=[];for(var g of Od(this.screens))e.push(g&255);g=this.rom.compressedMapData?[this.bgm,this.layoutHeight<<4|this.layoutWidth,this.mapPlane()<<2|this.animation,...e]:[this.bgm,this.layoutWidth,this.layoutHeight,this.animation,this.mapPlane()?128:0,...e];a.reloc(`MapData_${b}_Layout`);e=a.pc();a.byte(...g);d.push(e);a.reloc(`MapData_${b}_Graphics`);
g=a.pc();a.byte(...this.tilePalettes,this.tileset,this.tileEffects,...this.tilePatterns);d.push(g);if(1===this.height){for(var h of this.entrances)h.used&&191<h.y&&(h.y=191);for(var k of this.exits)12<k.yt&&(k.yt=12)}a.reloc(`MapData_${b}_Entrances`);h=a.pc();a.byte(...Od(this.entrances));d.push(h);a.reloc(`MapData_${b}_Exits`);h=a.pc();a.byte(...Od(this.exits),128|(this.pits.length?64:0)|this.entrances.length);d.push(h);a.reloc(`MapData_${b}_Flags`);h=a.pc();a.byte(...Od(this.flags),255);d.push(h);
h=Od(this.pits);h.length&&(a.reloc(`MapData_${b}_Pits`),k=a.pc(),a.byte(...h),d.push(k));a.reloc(`MapData_${b}`);h=a.pc();a.word(...d);a.org(33536+(this.id<<1),`MapData_${b}_Ptr`);a.word(h);b=this.bossId();if(null!=b&&95!==this.id){d=this.rom.bossKills[b].base;h=[,,,166===this.id?0:this.bgm,,...this.tilePalettes,,,,this.spritePalettes[0],,,,,,,,this.animation];a.segment("0f");for(k=0;k<h.length;k++)g=h[k],null!=g&&(a.org(d+k,`Boss_${b}_${k}`),a.byte(g));a.org(47041+5*b,`Boss_${b}_Post`);a.byte(c[1])}}}allScreens(){const a=
new Set;for(const b of this.screens)for(const c of b)a.add(this.rom.screens[c]);return a}bossId(){for(let a=0;14>a;a++)if(this.rom.prg[129373+a]===this.id)return a}hasDolphin(){return 96===this.id||100===this.id||104===this.id}reachableTiles(a){a=void 0===a?!1:a;this.hasDolphin()&&(a=!0);const b=new Set(this.exits.map((a)=>a.screen<<8|a.tile));var c=new yg;const d=this.rom.tilesets[this.tileset],e=this.rom.tileEffects[this.tileEffects-179];var f=new Set;for(let c=0;c<this.height;c++){const h=this.screens[c];
for(let k=0;k<this.width;k++){const m=this.rom.screens[h[k]],p=c<<4|k,G=this.flags.find((a)=>a.screen===p);for(let c=0;240>c;c++){const h=p<<8|c;if(b.has(h))continue;let k=m.tiles[c];var g=e.effects[k];g=a?g&4:g&6;G&&g&&32>k&&d.alternates[k]!=k&&(k=d.alternates[k],g=e.effects[k],g=a?g&4:g&6);g||f.add(h)}}}for(let b of f)a=15===(b&15)?b+241:b+1,f.has(a)&&c.union([b,a]),a=224===(b&240)?b+3872:b+16,f.has(a)&&c.union([b,a]);f=c.map();c=new Set;for(var h of this.entrances)h.used&&c.add(f.get(h.screen<<
8|h.tile)||new Set);h=new Map;for(const a of c)for(const b of a)h.set(b,e.effects[this.rom.screens[this.screens[b>>>12][b>>>8&15]].tiles[b&255]]);return h}screenMover(){const a=new n(()=>[]),b=Qa.concat(this.spawns,this.exits,this.entrances);for(const c of b)a.get(c.screen).push(c);return(b,d)=>{for(const c of a.get(b))c.screen=d}}moveScreen(a,b){const c=Qa.concat(this.spawns,this.exits,this.entrances);for(const d of c)d.screen===a&&(d.screen=b)}monsterPlacer(a){const b=this.data.bossScreen,c=this.reachableTiles(!1),
d=new Map([...c.keys()].map((a)=>[a,0])),e=[],f=[],g=[],h=[],k=[],p=this.hasDolphin()?37:39;for(const a of d){const [k,m]=a;{const a=this.screens[k>>>12][k>>>8&15];if(a!==b){for(const a of lk(k,this.width,this.height))d.has(a)||d.set(a,m+1);m||c.get(k)&p||e.push(k);26===this.id?240===this.rom.screens[a].tiles[k&255]&&h.push(k):2<=m&&4>=m&&h.push(k);3<=m&&7>=m&&f.push(k);12<=m&&g.push(k)}}}return(b)=>{var c=b.placement();c=[..."normal"===c?e:"moth"===c?f:"bird"===c?g:"plant"===c?h:Da(c)];a:for(;c.length;){var d=
a.nextInt(c.length),[m]=c.splice(d,1);d=(m&3840)>>>4|m&15;m=(m&61440)>>>8|(m&240)>>>4;const e=b.clearance();for(const a of k){const [,b,c,f]=a;if(Math.pow(m-c,2)+Math.pow(d-b,2)<Math.pow(e+f,2))continue a}for(const a of this.entrances){const {x:b,y:c,used:f}=a;if(f&&Math.pow(m-(c>>4),2)+Math.pow(d-(b>>4),2)<Math.pow(e+1,2))continue a}k.push([b,d,m,e]);return(m&240|(d&240)>>>4)<<8|(m&15)<<4|d&15}}}resizeScreens(a,b,c,d,e){e=void 0===e?0:e;const f=this.width+b+d;c=this.height+a+c;d=Array.from({length:c},
(c,d)=>{d-=a;return Array.from({length:f},(a,c)=>{c-=b;return 0>d||0>c||d>=this.height||c>=this.width?e:this.screens[d][c]})});this.width=f;this.height=c;this.screens=d;for(const c of this.flags)c.xs+=b,c.ys+=a;for(const c of this.pits)c.fromXs+=b,c.fromYs+=a;for(const c of[...this.spawns,...this.exits])c.xt+=16*b,c.yt+=16*a;for(const c of this.entrances)c.used&&(c.x+=256*b,c.y+=256*a)}writeScreens2d(a,b){const c=a&15;a>>>=4;for(let d=0;d<b.length;d++){const e=b[d];for(let b=0;b<e.length;b++){let f=
e[b];null!=f&&(0>f&&(f=~f,this.flags.push(x.of({screen:a+d<<4|c+b,flag:this.rom.flags.AlwaysTrue.id}))),this.screens[a+d][c+b]=f)}}}connect(a,b,c){var d=0>a?256:0,e=0>c?256:0;a=0>a?~a:a;c=0>c?~c:c;const f=a>>>4,g=a&15,h=c>>>4,k=c&15,[p,m]=mk[d|this.screens[f][g]],[u,y]=mk[e|b.screens[h][k]];d=this.entrances.length;e=b.entrances.length;this.entrances.push(x.of({y:f<<8|p>>>8,x:g<<8|p&255}));b.entrances.push(x.of({y:h<<8|u>>>8,x:k<<8|u&255}));for(const c of m)this.exits.push(x.of({screen:a,tile:c,dest:b.id,
entrance:e}));for(const a of y)b.exits.push(x.of({screen:c,tile:a,dest:this.id,entrance:d}))}neighborForEntrance(a){const b=this.entrances[a];if(!b)throw Error(`no entrance ${w(this.id)}:${a}`);for(const a of this.exits){if(a.screen!==b.screen)continue;const c=Math.abs(a.y-b.y);if(24>Math.abs(a.x-b.x)&&24>c)return this.rom.locations[a.dest]}throw Error(`no exit found near ${w(this.id)}:${a}`);}toString(){return`${super.toString()} ${this.name}`}}
function lk(a,b,c){const d=[],e=a&61680,f=a&3855;e<(c-1<<12|224)&&d.push(224===(a&240)?a+3872:a+16);e&&d.push(0===(a&240)?a-3872:a-16);f<(b-1<<8|15)&&d.push(15===(a&15)?a+241:a+1);f&&d.push(0===(a&15)?a-241:a-1);return d}const mk={21:[37024,[137,138]],25:[24720,[88,89]],150:[16432,[50,51]],151:[44848,[178,179]],152:[16592,[60,61]],153:[45008,[188,189]],154:[8064,[39,40]],158:[57216,[231,232]],193:[20640,[73,74]],194:[24752,[90,91]],410:[53376,[199,200]]};
var nk={get Entrance(){return Hg},get Exit(){return Ig},get Flag(){return Jg},get Pit(){return Kg},get Spawn(){return Lg}};function ok(a){if(!a.compressedMapData){a.compressedMapData=!0;for(let b=0;3>b;b++)a.metascreens.renumber(256|b,320|b),delete a.screens[256|b]}};function pk(a,b){var c=a.objects[159],d=a.objects[127];const e=a.objects[141];e.used=!0;e.name="Crumbling Horizontal Platform";e.sfx=c.sfx;c.data.forEach((a,b)=>e.data[b]=a);e.data[3]=d.data[3];c=new Set([47,61]);d=new Set([46,79]);for(const e of a.locations)if(e.pits.length){a=1>b.nextInt(3);for(const b of e.spawns)b.isMonster()&&(d.has(b.id)&&(b.id=(a?159:126)-80),c.has(b.id)&&(b.id=(a?141:127)-80))}};const {$04:qk,$05:rk,$0e:sk,$1b:tk,$fe:uk}=z;
class vk extends ng{constructor(a){super(205);this.rom=a;this.GoaSoldier=new R(this,11);this.LeafElder=new R(this,13);this.LeafElderDaughter=new R(this,17);this.LeafRabbit=new R(this,19);this.WindmillGuard=new R(this,20);this.SleepingWindmillGuard=new R(this,21);this.Akahana=new R(this,22);this.OakElder=new R(this,29);this.OakMother=new R(this,30);this.OakChild=new R(this,31);this.Aryllis=new R(this,35);this.AmazonesGuard=new R(this,37);this.AryllisRightAttendant=new R(this,38);this.AryllisLeftAttendant=
new R(this,39);this.Nadare=new R(this,40);this.SoldierGuard=new R(this,45);this.PortoaThroneRoomBackDoorGuard=new R(this,51);this.PortoaPalaceFrontGuard=new R(this,52);this.PortoaQueen=new wk(this,56);this.FortuneTeller=new R(this,57);this.WaterfallCaveAdventurers=new R(this,58);this.JoelElder=new R(this,61);this.Clark=new R(this,68);this.ShyronGuard=new R(this,78);this.Brokahana=new R(this,84);this.SaharaBunny=new R(this,89);this.Deo=new R(this,90);this.SaharaElder=new R(this,91);this.SaharaElderDaughter=
new R(this,92);this.Zebu=new R(this,94);this.Tornel=new R(this,95);this.Stom=new R(this,96);this.MesiaRecording=new R(this,97);this.Asina=new R(this,98);this.HurtDolphin=new R(this,99);this.Fisherman=new R(this,100);this.KensuInCabin=new R(this,104);this.Dolphin=new xk(this,105);this.SleepingKensu=new R(this,107);this.KensuDisguisedAsDancer=new R(this,108);this.KensuDisguisedAsSoldier=new R(this,109);this.AztecaInShyron=new R(this,110);this.DeadAkahana=new R(this,112);this.DeadStomsGirlfriend=new R(this,
113);this.DeadStom=new R(this,114);this.KensuInSwan=new R(this,116);this.SlimedKensu=new R(this,117);this.FishermanDaughter=new R(this,123);this.Kensu=new R(this,126);this.AkahanaInBrynmaer=new R(this,130);this.AztecaInPyramid=new R(this,131);this.SaberaDisguisedAsMesia=new R(this,132);this.StonedWaterfallCaveAdventurers=new R(this,133);this.StonedAkahana=new R(this,136);this.Mesia=new R(this,142);this.Vampire1=new R(this,192);this.Insect=new R(this,193);this.Kelbesque1=new R(this,194);this.Rage=
new R(this,195);this.Kelbesque2=new R(this,197);this.Sabera2=new R(this,198);this.Mado2=new R(this,199);this.Karmine=new R(this,200);this.StatueOfMoon=new R(this,201);this.StatueOfSun=new R(this,202);this.Draygon=new R(this,203);this.Vampire2=new R(this,204);for(var b in this){const a=this[b];this.hasOwnProperty(b)&&a instanceof R&&(this[a.id]=a,a.name=Hd(b))}for(b=0;205>b;b++)this[b]||(this[b]=new R(this,b));const c=yk.readAddress(a.prg);this.movementScripts=v(16,(b)=>{b=c.plus(2*b).readAddress(a.prg).offset;
const d=[];for(;128>a.prg[b];)d.push(a.prg[b++]);return{steps:d,terminate:a.prg[b]}})}write(){const a=this.rom.assembler();for(var b of this)b&&b.used&&b.assemble(a);je(a,tk,44804,44969);b=[];a.segment("1b","fe","ff");let c=0;for(var d of this.movementScripts){const e=(a.reloc(`MovementScript_${w(c++)}`),a.pc());a.byte(...d.steps,d.terminate);b.push(e)}d=(a.reloc("MovementScriptTable"),a.pc());a.word(...b);yk.loc(a,"MovementScriptTablePtr");a.word(d);yk.plus(5).loc(a,"MovementScriptTablePlus1Ptr");
a.word({op:"+",args:[d,{op:"num",num:1}]});return[a.module()]}}
class R extends mg{constructor(a,b){super(a.rom,b);this.npcs=a;this.spawnConditions=new Map;this.localDialogs=new Map;a=a.rom;if(204<b)throw Error(`Unavailable: ${b}`);this._used=!zk.has(b)&&(143>b||192<=b);(b=196>b?this.dialogPointer.readAddress(a.prg):null)&&35641===b.org&&(b=null);this.data=Id(a.prg,this.dataBase.offset,4);for(var c=this.spawnPointer.readAddress(a.prg).offset,d;this.used&&255!==(d=a.prg[c++]);){const b=de.read(a.prg,c);c+=2*b.length;this.spawnConditions.set(d,b)}this.globalDialogs=
[];if(b){for(d=b.offset;;){const [b,c]=Ak.parse(a.prg,d);d+=4;b.condition&&this.globalDialogs.push(b);if(c)break}for(b=[];;){c=a.prg[d++];if(255===c)break;b.push([c,a.prg[d++]])}b.length||b.push([-1,0]);c=d;for(const [e,f]of b)for(b=[],this.localDialogs.set(e,b),d=c+f;;){const [c,e]=Bk.parse(a.prg,d);d+=c.byteLength();b.push(c);if(e)break}}}get dataBase(){return ie.of(this.id&128?rk:qk,33008|(this.id&252)<<6|(this.id&3)<<2)}get spawnPointer(){return ie.of(sk,34272+(this.id<<1))}get dialogPointer(){return ie.of(sk,
35165+(this.id<<1))}get used(){return this._used}set used(a){if(a&&136<this.id&&192>this.id&&142!==this.id)throw Error(`invalid: ${this.id}`);this._used=a}spawnConditionsBytes(){const a=[];for(const [b,c]of this.spawnConditions)a.push(b,...de.bytes(c));a.push(255);return a}dialog(a){a=a?a.id:-1;const b=this.localDialogs.get(a);if(b)return b;throw Error(`No local dialog for NPC ${w(this.id)} at ${w(a)}`);}spawns(a){const b=a.id;if(a=this.spawnConditions.get(a.id))return a;throw Error(`No spawn condition for NPC ${w(this.id)} at ${w(b)}`);
}hasDialog(){const a=!(!this.globalDialogs.length&&!this.localDialogs.size);if(142<this.id&&195!==this.id&&a)throw Error(`invalid: ${this.id}`);return a}*allDialogs(){yield*this.globalDialogs;for(const a of this.localDialogs.values())yield*a}dialogBytes(){function a(a){const b=[];for(let c=0;c<a.length;c++)b.push(...a[c].bytes(c===a.length-1));return b}if(!this.hasDialog())return[];const b=[];this.globalDialogs.length?b.push(...a(this.globalDialogs)):b.push(128,0,0,0);const c=[],d=new Map;for(const [e,
f]of this.localDialogs){const g=a(f),h=g.join(","),k=d.get(h);null!=k?b.push(e,k):(d.set(h,c.length),-1!==e&&b.push(e,c.length),c.push(...g))}c.length&&b.push(255,...c);return b}link(a){this.spawnConditions=this.rom.npcs[a].spawnConditions;this.linkDialog(a)}linkDialog(a){a=this.rom.npcs[a];this.globalDialogs=a.globalDialogs;this.localDialogs=a.localDialogs}localDialog(a,b){null==b&&(b=a,a=-1);const c=this.localDialogs.get(a);if(null==c||b>=c.length)throw Error(`No local dialog ${b} for location ${w(a)}`);
return c[b]}isParalyzable(){for(let a=217176;217196>a;a++)if(this.rom.prg[a]===this.id)return!1;return!0}assemble(a){if(this.used){var b=w(this.id);this.dataBase.loc(a,"PersonData_${id}");a.byte(...this.data);a.segment("0e","fe","ff");a.reloc(`SpawnCondition_${b}`);var c=a.pc();a.byte(...this.spawnConditionsBytes());this.spawnPointer.loc(a,`SpawnCondition_${b}_Pointer`);a.word(c);this.hasDialog()&&(a.segment("0e","fe","ff"),a.reloc(`Dialog_${b}`),c=a.pc(),a.byte(...this.dialogBytes()),this.dialogPointer.loc(a,
`Dialog_${b}_Pointer`),a.word(c))}}}class Ak{constructor(a,b){this.condition=a;this.message=b}static of(a,b){const [c,d,e=0]=b;return new Ak(a,x.of({part:c,index:d,action:e}))}static parse(a,b=0){const c=Pd(a,b);a=x.from(a,b+2);b=c&1023;const d=!!(c&32768);c&8192&&(b=~b);return[new Ak(b,a),d]}bytes(a){let b=this.condition;0>b&&(b=~b|8192);a&&(b|=32768);return[b>>>8,b&255,...this.message.data]}}
class Bk{constructor(a,b,c,d){this.condition=a;this.message=b;this.update=c;this.flags=d}clone(){return Bk.parse(this.bytes(!1))[0]}static parse(a,b=0){const c=Pd(a,b),d=x.from(a,b+2),e=a[b+4];let f=c&1023;const g=!!(c&32768);c&8192&&(f=~f);a=c&16384?$d.read(a,b+5):[];return[new Bk(f,d,e,a),g]}static of(a,b,c=[]){const [d,e,f=0]=b;return new Bk(a,x.of({part:d,index:e,action:f}),0,c)}byteLength(){return 5+2*this.flags.length}bytes(a){let b=this.condition;0>b&&(b=~b|8192);a&&(b|=32768);this.flags.length&&
(b|=16384);return[b>>>8,b&255,...this.message.data,this.update,...$d.bytes(this.flags)]}}const zk=new Set([49,59,60,102,103,106,115,116,130,134,135,137,138,139,140,141,196]);class wk extends R{get expectedSword(){return this.localDialog(3).condition&255}set expectedSword(a){this.localDialog(3).condition=512|a}}
class xk extends R{constructor(a,b){super(a,b);const c=a.rom.prg,d=Ck.readAddress(c).offset;this.spawnScripts=v(9,(a)=>({entrance:x.from(c,d+5*a),movement:c[d+5*a+4]}));this.channelSpawn=Dk(Ek.read(c)/5);this.evilSpiritIslandSpawn=Dk(Fk.read(c)/5)}assemble(a){super.assemble(a);a.segment("fe");a.org(54952);a.free(45);a.segment("fe","ff");a.reloc("DolphinSpawnTable");const b=a.pc();for(;!this.spawnScripts[this.spawnScripts.length-1].entrance.used;)this.spawnScripts.pop();for(var c=0;c<this.rom.locations.AngrySea.entrances.length;c++){const b=
this.spawnScripts[c];b?a.byte(...b.entrance.data,b.movement):a.byte(255,15,255,15,15)}Ek.loc(a,"DolphinChannelSpawn");a.byte(5*this.channelSpawn);Fk.loc(a,"DolphinEvilSpiritIslandSpawn");a.byte(5*this.evilSpiritIslandSpawn);Ck.loc(a,"DolphinSpawnTablePtr");a.word(b);for(c=0;4>c;c++)Gk.plus(5*c).loc(a,`DolphinSpawnTablePlus${c+1}Ptr`),a.word({op:"+",args:[b,{op:"num",num:c+1}]})}}var Hk,Ik=Hk||(Hk={});Ik.UP=0;Ik.RIGHT=2;Ik.DOWN=4;Ik.LEFT=6;Ik.DOLPHIN=255;Ik.DESPAWN=254;
const Ek=ie.of(uk,54884),Fk=ie.of(uk,54892),Ck=ie.of(uk,54906),Gk=ie.of(uk,54926),yk=ie.of(tk,44627);function Dk(a){if(a!==Math.floor(a))throw Error(`Expected integer: ${a}`);return a};function Jk(a,b,...c){for(let d=0;d<c.length;d++)a[b+d]=c[d]}
function Kk(a){a[107924]=255;a[118213]=168;a[106870]=255;a[108620]=255;a[120899]=160;a[122987]&=7;a[122991]&=7;a[122995]&=7;a[122999]&=7;a[123003]&=7;a[123012]&=7;a[123035]&=7;a[123065]&=7;a[123141]=47;a[123511]=0;a[123750]=64;a[123761]=0;a[123783]=0;a[123793]=0;Jk(a,106856,51,51);Jk(a,107662,51,51);a[105393]=112;a[105397]=113;a[105079]=114;a[105963]=115;a[106565]=116;a[106721]=117;a[106725]=118;a[106729]=119;a[108037]=120;a[107457]=121;a[107461]=122;a[107465]=123;Jk(a,123063,192,0);Jk(a,123690,192,
0);Jk(a,123696,192,0);Jk(a,123702,192,0);Jk(a,123104,192,0);Jk(a,123110,192,0);a[116739]=0;Jk(a,116749,162,179);a[109190]=254;Jk(a,251605,37,41,57,58,59,71,60,62,132,70,178,66,180,65,255)}
function Lk(a,b){{const {flags:{WarpZombie:b},locations:{ZombieTown:d}}=a;a.flags.insertZombieWarpFlag();a.messages.parts[33][0].text=" {1a:Leaf}      {16:Brynmaer} {1d:Oak} \n{0c:Nadare}'s  {1e:Portoa}   {14:Amazones} \n{19:Joel}      Zombie   {20:Swan} \n{23:Shyron}    {18:Goa}      {21:Sahara}";var c=a.nextFreeTrigger();c.used=!0;c.conditions=[];c.message=x.of({});c.flags=[b.id];for(const a of d.spawns)a.isTrigger()&&138===a.id&&(a.id=c.id);a.townWarp.locations.splice(7,0,d.id);if(255!==a.townWarp.locations.pop())throw Error("unexpected");
}a.items.GlowingLamp.itemUseData[0].message.action=11;c=a.nextFreeTrigger();c.used=!0;c.conditions=[~a.flags.AlwaysTrue.id];c.message=x.of({action:4});c.flags=[a.flags.AlwaysTrue.id];a.locations.MezameShrine.spawns.push(nk.Spawn.of({tile:136,type:2,id:c.id}));a.objects[16].atk=3;a.objects[17].atk=6;a.objects[18].atk=8;a.objects[24].atk=3;a.objects[19].atk=5;a.objects[25].atk=5;a.objects[23].atk=7;a.objects[26].atk=7;a.objects[20].atk=3;a.objects[21].atk=6;a.objects[22].atk=8;a.objects[28].atk=3;a.objects[29].atk=
3;a.objects[30].atk=5;a.objects[27].atk=7;a.objects[31].atk=7;b.slowDownTornado()&&(c=a.objects[18],c.speed=7,c.data[12]=96);a.items.OpelStatue.selectedItemValue=0;for(var d of[96,100,101,102,103,104,105,106,107,108,109,111])for(var e of[0,1,2])a.patterns[d<<6|e].pixels=a.patterns[6016|e].pixels;a.objects[12].metasprite=169;for(const b of a.locations)for(const a of b.spawns)a.isChest()&&(a.timed=!1);d=a.trigger(160);d.used=!0;d.conditions=[];d.flags=[];d.message=x.of({part:0,index:0,action:21});a.objects[94].data[13]=
254;a.items.InsectFlute.itemUseData[0].flags=[a.flags.UsedInsectFlute.id];{const {flags:{BallOfWind:b,TornadoBracelet:c},npcs:{Tornel:e}}=a;d=e.localDialogs.get(33);d=[d[0],d[2],d[2].clone(),d[1]];d[1].condition=~c.id;d[2].condition=~b.id;d[3].condition=-1;e.localDialogs.set(33,d)}d=a.locations;d.GoaFortress_Kelbesque.spawns[0].x-=16;d.GoaFortress_Zebu.spawns.splice(1,1);d.GoaFortress_Tornel.spawns.splice(2,1);d.GoaFortress_Asina.spawns.splice(2,1);d.GoaFortress_Kensu.spawns.splice(3,1);d.GoaFortress_Kensu.spawns.splice(1,
1);Mk(a,b);a.npcs[13].localDialogs.get(53)[0].message.action=23;if(b.requireHealedDolphinToRide()){{const {flags:{InjuredDolphin:b,ShellFlute:c},npcs:{Fisherman:e,FishermanDaughter:f}}=a;e.spawnConditions.set(214,[c.id,b.id]);d=f.localDialogs.get(-1);d.unshift(d[0].clone());d[0].condition=~b.id;d[1].condition=~c.id}}if(b.saharaRabbitsRequireTelepathy()){{const {flags:{Telepathy:b},npcs:{Deo:c,SaharaBunny:d}}=a;d.globalDialogs.push(Ak.of(~b.id,[26,18]));c.globalDialogs.push(Ak.of(~b.id,[26,19]))}}b.leatherBootsGiveSpeed()&&
(d=a.items[47],d.menuName="Speed Boots",d.messageName="Speed Boots",b.changeGasMaskToHazmatSuit()&&(d=a.items[41],d.menuName="Hazmat Suit",d.messageName="Hazmat Suit"));for(d=5;12>d;d+=2)a.items[d].menuName=a.items[d].menuName.replace("Ball","Orb"),a.items[d].messageName=a.items[d].messageName.replace("Ball","Orb");{const {items:{AlarmFlute:b},locations:{WaterfallCave4:c},npcs:{WindmillGuard:k}}=a;a.itemGets[49].inventoryRowStart=32;b.unique=!0;b.basePrice=0;k.data[1]=49;d=[[33,.72],[31,.9]];e=0;
for(var f of a.shops)if(f.type===xg.TOOL)for(let b=0,c=f.contents.length;b<c;b++){if(49!==f.contents[b])continue;const [c,g]=d[e++%d.length];f.contents[b]=c;a.shopDataTablesAddress&&(f.prices[b]=Math.round(f.prices[b]*g))}a.itemGets[91].itemId=29;c.spawn(25).id=16}{const {flags:{Karmine:b,Mado1:c},npcs:{Brokahana:d}}=a;f=d.localDialogs.get(-1);if(!f)throw Error(`asserted but falsy: ${f}`);f=f[0];if(f.condition!==~b.id)throw Error(`Bad brokahana condition: ${f.condition}`);f.condition=~c.id}b.teleportOnThunderSword()?
({flags:{WarpShyron:f}}=a,a.itemGets[3].flags.push(f.id),a.townWarp.thunderSwordWarp=[a.locations.Shyron.id,65]):a.itemGets[3].acquisitionAction.action=22;({tiles:f}=a.screens[161]);f[40]=159;f[55]=35;f[56]=35;f[57]=33;f[71]=141;f[72]=143;f[86]=153;f[87]=154;f[88]=140;if(b.fogLampNotRequired()){{const {flags:{AlwaysTrue:c,InjuredDolphin:d,FogLamp:e,KensuInCabin:p,ReturnedFogLamp:m},items:{ShellFlute:u},locations:{BoatHouse:y,Portoa_FishermanHouse:G},npcs:A}=a;f=b.requireHealedDolphinToRide();u.itemUseData[0].want=
f?d.id:c.id;A.KensuInCabin.data[0]=103;A.KensuInCabin.localDialogs.get(-1)[0].message.action=10;A.KensuInCabin.localDialogs.get(-1)[0].flags=[];A.KensuInCabin.spawnConditions.set(y.id,[m.id,~p.id]);A.Fisherman.spawnConditions.set(G.id,[e.id]);a.itemGets[100].flags=[];a.itemGets[103].copyFrom(a.itemGets[100])}}a.trigger(138).conditions=[~a.flags.CurrentlyRidingDolphin.id];a.messages.parts[29][16].text="The cave entrance appears\nto be underwater. You'll\nneed to swim.";{const {CordelPlainEast:b,KirisaMeadow:c,
UndergroundChannel:d}=a.locations;for(const a of[b,c,d])for(const b of a.spawns)b.isChest()&&(b.data[2]|=32)}{const {CordelPlainEast:c,CordelPlainWest:d}=a.locations;for(const a of c.spawns)(a.isChest()||b.disableTeleportSkip()&&a.isTrigger())&&d.spawns.push(a.clone())}if(b.disableRabbitSkip())for(const b of a.locations.MtSabreNorth_Main.spawns)b.isTrigger()&&134===b.id&&1856===b.x&&(b.x+=16,b.y+=16);b.disableRageSkip()&&(a.metatilesets.lime.getTile(124).setEffects(6),a.metatilesets.lime.getTile(127).setEffects(6),
a.metatilesets.lime.getTile(123).setTiles([127,127,127,127]).setAttrs(0).setEffects(6),a.screens[116].set2d(144,[[123,123,123,123,123,123,123,null,null,123,123,123,123,123,123,123],[123,123,123,123,123,123,123,null,null,123,123,123,123,123,123,123]]));for(const b in[4,5,8,9])a.tileEffects[9].effects[b]=24,a.tileEffects[2].effects[b]=24;if(b.chargeShotsOnly()){for(const b of[8,9,39])a.objects[b].collisionPlane=0;a.npcs.Brokahana.data[0]=a.items.FruitOfLime.id}if(b.orbsOptional())for(const b of[16,
20,24,29])a.objects[b].terrainSusceptibility&=-5,a.objects[b].level=2;if(b.noBowMode()){{const {flags:{UsedBowOfTruth:b},locations:{Crypt_Draygon2:c,Crypt_Hall2:d,MezameShrine:e}}=a;let f;for(const b of e.spawns)b.isTrigger()&&136===b.tile&&(f=a.trigger(b.id));if(!f)throw Error("Could not find start trigger");f.flags.push(b.id);a.tileEffects[6].effects[88]=0;e.exits.push(nk.Exit.of({tile:104,dest:c.id,entrance:0}));for(let a of c.exits)a.dest===d.id&&(a.dest=e.id,a.entrance=1);for(let a of d.exits)a.dest===
c.id&&(a.dest=e.id,a.entrance=0)}}a.messages.parts[32][15].text+="\nItem: [:ITEM:]"}
function Mk(a,b){function c(a,b){const c=a.indexOf(b);if(0>c)throw Error(`Could not find element ${b} in ${a}`);a.splice(c,1)}function d(a){a.reverse();for(let b=0;b<a.length;b++){const c=a[b+1];a[b].condition=c?~c.condition:-1}}const {locations:{BoatHouse:e,Brynmaer:f,Crypt_Draygon2:g,Joel_Shed:h,MtSabreNorth_SummitCave:k,MtSabreWest_Upper:p,PortoaPalace_ThroneRoom:m,Portoa_AsinaRoom:u,Portoa_FortuneTeller:y,Shyron_Temple:G,StomHouse:A,Swan_DanceHall:T,Swan_Tavern:ma,WindmillCave:M,WaterfallCave4:Z,
WaterfallValleyNorth:ea,ZebuCave:pa,ZombieTown_HouseBasement:P},items:{GlowingLamp:ec,KeyToPrison:ub,LovePendant:ab,StatueOfOnyx:Mb},npcs:{Akahana:pb,AkahanaInBrynmaer:gb,Asina:Bb,AztecaInShyron:fc,Clark:gc,Draygon:eb,FortuneTeller:Td,Kensu:hb,KensuInCabin:Ua,KensuInSwan:Ka,LeafRabbit:Sa,OakChild:Ta,OakElder:Nb,OakMother:vb,PortoaPalaceFrontGuard:hc,PortoaQueen:qb,PortoaThroneRoomBackDoorGuard:Ob,Rage:Pb,Stom:Qb,StonedAkahana:Cb,Tornel:uc,WindmillGuard:Vc,Zebu:vc},flags:O}=a;hb.localDialogs.delete(ma.id);
Ka.link(hb.id);Ka.used=!0;Ka.data=[...hb.data];hb.data[0]=ec.id;T.spawns.find((a)=>a.isNpc()&&a.id===hb.id).id=Ka.id;ab.itemUseData[0].want=256|Ka.id;Cb.linkDialog(pb.id);gb.used=!0;gb.link(pb.id);gb.data=[...pb.data];f.spawns.find((a)=>a.isNpc()&&a.id===pb.id).id=gb.id;Mb.itemUseData[0].want=256|gb.id;Sa.dialog()[2].condition=O.RescuedLeafElder.id;Sa.dialog()[2].flags.push(O.TalkedToLeafRabbit.id);Sa.dialog()[3].flags.push(O.TalkedToLeafRabbit.id);Vc.spawns(M)[1]=~O.WindmillGuardAlarmFluteTradein.id;
c(pb.spawns(Z),~O.BehindWhirlpool.id);c(Cb.spawns(Z),~O.BehindWhirlpool.id);Nb.dialog()[0].message.action=3;Nb.dialog()[1].message.action=3;Nb.dialog()[2].message.action=3;Nb.dialog()[3].message.action=3;(()=>{const [a,b,c,d]=vb.dialog();d.condition=~O.RescuedChild.id;b.condition=-1;vb.dialog().splice(0,4,d,c,a,b)})();for(const b of[32,33,34,124,125])d(a.npcs[b].dialog());Ta.dialog().unshift(...Ta.dialog().splice(1,1));Ob.spawnConditions.set(m.id,[~O.QueenNotInThroneRoom.id,~O.MesiaRecording.id]);
hc.dialog()[1].condition=O.MesiaRecording.id;qb.dialog()[3].condition=O.SwordOfWater.id;qb.dialog()[3].message.action=3;qb.dialog()[4].flags.push(O.PortoaQueenGoingAway.id);qb.spawns(m)[1]=~O.MesiaRecording.id;qb.spawns(u)[0]=O.MesiaRecording.id;qb.dialog()[1].condition=O.MesiaRecording.id;Td.spawns(y)[1]=~O.MesiaRecording.id;gc.spawnConditions.set(P.id,[~O.Clark.id]);gc.spawnConditions.set(h.id,[O.Clark.id]);vc.localDialogs.set(pa.id,[Bk.of(~O.TalkedToZebuInCave.id,[0,26],[O.TalkedToZebuInCave.id]),
Bk.of(O.LeafVillagersRescued.id,[0,29]),Bk.of(O.LeafAbduction.id,[0,28]),Bk.of(O.ZebuAtWindmill.id,[0,29]),Bk.of(O.UsedWindmillKey.id,[0,27,3]),Bk.of(-1,[0,29])]);c(vc.spawns(pa),~O.BehindWhirlpool.id);uc.spawnConditions.delete(p.id);Qb.spawnConditions.delete(A.id);Bb.data[1]=a.items.FluteOfLime.id;Bb.dialog(u)[0].message.action=17;Bb.dialog(u)[2].message.action=17;c(Bb.spawns(u),~O.CalmedAngrySea.id);Ua.spawnConditions.set(e.id,[~O.AbleToRideDolphin.id,O.ReturnedFogLamp.id]);Ua.dialog()[0].message.action=
2;fc.spawns(G).push(~O.ShyronMassacre.id);a.trigger(130).conditions.push(~O.ShyronMassacre.id);Pb.dialog()[0].condition=O.SwordOfWater.id;eb.spawnConditions.set(g.id,[~O.Draygon2.id]);vc.dialog(G).unshift(...vc.dialog(G).splice(1,1));a.trigger(128).conditions=[~O.ShyronMassacre.id,O.TalkedToZebuInShyron.id,O.SwordOfThunder.id];a.trigger(129).conditions=[];b.barrierRequiresCalmSea()&&a.trigger(132).conditions.push(O.CalmedAngrySea.id);a.trigger(140).conditions.push(O.TalkedToZebuInCave.id);a.trigger(141).used=
!1;for(const a of k.spawns)a.isTrigger()&&141===a.id&&(a.id=178);(function(a,b){b=a.findIndex(b);if(0>b)throw Error(`Could not find element in ${a}`);a.splice(b,1)})(ea.spawns,(a)=>a.isTrigger()&&141===a.id);a.trigger(178).conditions.push(O.Kelbesque1.id);a.trigger(178).flags.push(~O.LeafVillagersCurrentlyAbducted.id,~O.LeafElderCurrentlyAbducted.id,O.LeafVillagersRescued.id);a.trigger(140).conditions.push(~O.Kelbesque1.id);a.trigger(134).conditions.push(~O.Kelbesque1.id);c(ub.itemUseData[0].flags,
~O.LeafVillagersCurrentlyAbducted.id);Nk(a.trigger(187).conditions,~O.Rage.id,~O.MesiaRecording.id)}function Nk(a,b,c){for(let d=0;d<a.length;d++)if(a[d]===b){a[d]=c;return}throw Error(`Could not find ${b} in ${a.join(",")}`);};const {$0e:Ok,$0f:Pk,$10:Qk,$1a:Rk}=z,Sk=ie.of(Ok,33689),Tk=ie.of(Ok,39906),Uk=ie.of(Qk,36848),Vk=ie.of(Qk,36923),Wk=ie.of(Qk,36998),Xk=ie.of(Rk,35776),Yk=ie.of(Rk,35785),Zk=[["Sword","\n\x0B\f"],[" of ","\\]"],["Bracelet","<=>["],["Shield","\r\u000e\u000f"],["Armor","{\u0011\u0012"],["Magic","#%("],["Power","\u0013\u0014\u0015"],["Item","\u0016\u0017^"]];
class S extends mg{constructor(a,b,c={}){super(a.rom,b);this.items=a;const d=this.rom;a[b]=this;this.itemUseData=[];this.trades=c.trades||[];this.use=c.use||!1;this.weight=c.weight||1;this.valueAddr=null!=c.valueAddr?ie.of(Ok,c.valueAddr):void 0;null!=this.valueAddr&&(this.value=this.valueAddr.read(d.prg));if(this.use){this.itemUseJump=this.itemUseJumpPointer.readAddress(d.prg,Ok,Pk);b=a.itemUseJumps[this.itemUseJump.org];if(!b)throw Error(`Bad ItemUseJump: ${this.itemUseJump}`);a=this.itemUseDataPointer.readAddress(d.prg,
Ok,Pk);for(var e of b)b=$k.from(e,d.prg,a),this.itemUseData.push(b),a=a.plus(b.length)}this.itemDataValue=this.itemDataPointer.read(d.prg);this.selectedItemValue=this.selectedItemPointer.read(d.prg);e=this.menuNamePointer.readAddress(d.prg);this.menuName=Zk.reduce((a,[b,c])=>a.replace(c,b),Rd(d.prg,e.offset,255))}get messageName(){return this.rom.messages.itemNames[this.id]}set messageName(a){this.rom.messages.itemNames[this.id]=a}get basePrice(){return this.rom.shops.basePrices[this.id]}set basePrice(a){this.rom.shops.basePrices[this.id]=
a}get itemUseJumpPointer(){return Sk.plus(this.id<<1)}get itemUseDataPointer(){return Tk.plus(this.id<<1)}get itemDataPointer(){return Uk.plus(this.id)}get selectedItemPointer(){return Vk.plus(this.id)}get menuNamePointer(){return Wk.plus(this.id<<1)}itemUseMessages(){const a=new Map;for(const {message:b}of this.itemUseData)a.set(b.mid,b);return[...a.values()]}setName(a){this.messageName=this.menuName=a}get palette(){return this.itemDataValue&3}set palette(a){this.itemDataValue=this.itemDataValue&
-4|a&3}get unique(){return!!(this.itemDataValue&64)}set unique(a){this.itemDataValue=this.itemDataValue&-65|(a?64:0)}get worn(){return!!(this.itemDataValue&32)}set worn(a){this.itemDataValue=this.itemDataValue&-33|(a?32:0)}get solid(){return!!(this.itemDataValue&128)}set solid(a){this.itemDataValue=this.itemDataValue&-129|(a?128:0)}assemble(a){const b=w(this.id);this.itemDataPointer.loc(a,`ItemData_${b}`);a.byte(this.itemDataValue);this.selectedItemPointer.loc(a,`ItemSelectedValue_${b}`);a.byte(this.selectedItemValue);
var c=Zk.reduce((a,[b,c])=>a.replace(b,c),this.menuName);a.segment(Qk);a.reloc(`ItemMenuName_${w(this.id)}`);const d=a.pc();a.byte(c,255);this.menuNamePointer.loc(a,`ItemMenuName_${b}`);a.word(d);if(this.itemUseJump){this.itemUseJumpPointer.loc(a,`ItemUseJump_${b}_Ptr`);a.word(this.itemUseJump.org);c=[];for(var e of this.itemUseData)c.push(...e.bytes());a.segment(Ok.name,Pk.name);a.reloc(`ItemUseData_${b}`);e=a.pc();a.byte(...c);this.itemUseDataPointer.loc(a,`ItemUseData_${b}_Ptr`);a.word(e)}this.valueAddr&&
(this.valueAddr.loc(a,`ItemValue_${b}`),a.byte(this.value))}isMagic(){return 65<=this.id&&72>=this.id}}
class $k{constructor(a,b,c,d){this.kind=a;this.want=b;this.message=c;this.flags=d}static from(a,b,c){({offset:c}=c);var d=0;if("expect"===a||"screen"===a)d=b[c+1]<<8|b[c],c+=2;else if("flag"===a){d=ce.read(b,c);d.length||d.push(-1);if(1<d.length)throw Error(`Flag list too long: ${d}`);d=d[0];c+=2}else"location"===a?d=b[c++]:"empty"!==a&&Da(a);const e=x.from(b,c);b=be.read(b,c+2);return new $k(a,d,e,b)}bytes(){const a=[];if("expect"===this.kind||"screen"===this.kind)a.push(this.want&255,this.want>>>
8&255);else if("flag"===this.kind){const b=ce.bytes([this.want]);if(2!==b.length)throw Error(`bad data: ${b}`);a.push(...b)}else"location"===this.kind?a.push(this.want):"empty"!==this.kind&&Da(this.kind);a.push(...this.message.data);a.push(...be.bytes(this.flags));return a}tradeNpc(){return"expect"!==this.kind||1!==this.want>>>8?null:this.want&255}get length(){return 2*(1+Math.max(1,this.flags.length))+("empty"===this.kind?0:"location"===this.kind?1:2)}}
class al extends S{get defense(){return this.items.shieldDefense[this.id-12]}set defense(a){this.items.shieldDefense[this.id-12]=a}}class bl extends S{get defense(){return this.items.armorDefense[this.id-20]}set defense(a){this.items.armorDefense[this.id-20]=a}}
class cl extends ng{constructor(a){super(73);this.rom=a;this.itemUseJumps=dl;this.SwordOfWind=new S(this,0);this.SwordOfFire=new S(this,1);this.SwordOfWater=new S(this,2);this.SwordOfThunder=new S(this,3);this.Crystalis=new S(this,4);this.BallOfWind=new S(this,5);this.TornadoBracelet=new S(this,6);this.BallOfFire=new S(this,7);this.FlameBracelet=new S(this,8);this.BallOfWater=new S(this,9);this.BlizzardBracelet=new S(this,10);this.BallOfThunder=new S(this,11);this.StormBracelet=new S(this,12);this.CarapaceShield=
new al(this,13);this.BronzeShield=new al(this,14);this.PlatinumShield=new al(this,15);this.MirroredShield=new al(this,16);this.CeramicShield=new al(this,17);this.SacredShield=new al(this,18);this.BattleShield=new al(this,19);this.PsychoShield=new al(this,20);this.TannedHide=new bl(this,21);this.LeatherArmor=new bl(this,22);this.BronzeArmor=new bl(this,23);this.PlatinumArmor=new bl(this,24);this.SoldierSuit=new bl(this,25);this.CeramicSuit=new bl(this,26);this.BattleArmor=new bl(this,27);this.PsychoArmor=
new bl(this,28);this.MedicalHerb=new S(this,29,{use:!0,trades:[0],valueAddr:34026});this.Antidote=new S(this,30,{use:!0});this.LysisPlant=new S(this,31,{use:!0});this.FruitOfLime=new S(this,32,{use:!0});this.FruitOfPower=new S(this,33,{use:!0,valueAddr:34060});this.MagicRing=new S(this,34,{use:!0});this.FruitOfRepun=new S(this,35,{use:!0});this.WarpBoots=new S(this,36,{use:!0});this.StatueOfOnyx=new S(this,37,{use:!0,trades:[0]});this.OpelStatue=new S(this,38,{use:!0});this.InsectFlute=new S(this,
39,{use:!0});this.FluteOfLime=new S(this,40,{use:!0,trades:[0,1,2,3]});this.GasMask=new S(this,41);this.PowerRing=new S(this,42);this.WarriorRing=new S(this,43);this.IronNecklace=new S(this,44);this.DeosPendant=new S(this,45);this.RabbitBoots=new S(this,46);this.LeatherBoots=new S(this,47);this.ShieldRing=new S(this,48);this.AlarmFlute=new S(this,49,{use:!0,trades:[0,1]});this.WindmillKey=new S(this,50,{use:!0});this.KeyToPrison=new S(this,51,{use:!0});this.KeyToStyx=new S(this,52,{use:!0});this.FogLamp=
new S(this,53,{use:!0,trades:[0]});this.ShellFlute=new S(this,54,{use:!0});this.EyeGlasses=new S(this,55,{use:!0});this.BrokenStatue=new S(this,56,{use:!0});this.GlowingLamp=new S(this,57,{use:!0});this.StatueOfGold=new S(this,58,{use:!0});this.LovePendant=new S(this,59,{use:!0,trades:[0]});this.KirisaPlant=new S(this,60,{use:!0,trades:[0]});this.IvoryStatue=new S(this,61,{use:!0,trades:[0]});this.BowOfMoon=new S(this,62,{use:!0});this.BowOfSun=new S(this,63,{use:!0});this.BowOfTruth=new S(this,64,
{use:!0});this.Refresh=new S(this,65);this.Paralysis=new S(this,66);this.Telepathy=new S(this,67);this.Teleport=new S(this,68);this.Recover=new S(this,69);this.Barrier=new S(this,70);this.Change=new S(this,71);this.Flight=new S(this,72);this.armorDefense=Id(a.prg,Xk.offset,9);this.shieldDefense=Id(a.prg,Yk.offset,9)}write(){const a=this.rom.assembler();Xk.loc(a);a.byte(...this.armorDefense);Yk.loc(a);a.byte(...this.shieldDefense);const b=Array(10).fill(0);for(const c of this)c.assemble(a),c.unique&&
(b[c.id>>>3]|=1<<(c.id&7));ke(a,[Ok,Pk],"KeyItemData");a.byte(...b);return[a.module()]}}const dl={33849:["expect"],33858:["screen"],33872:["empty"],33873:["screen"],33887:["location"],33937:["expect"],33961:["expect","expect"],33971:["location"],34E3:["expect"],34011:[],34016:["expect","empty"],34055:["empty"],34077:["empty"],34084:["empty"],34095:["empty"],34106:["empty"],34122:["empty"],34148:["empty"],34149:["expect"],34155:["flag"],34181:["empty"],34206:["expect","expect","expect","expect"]};function el(a,b,c){if(b.randomizeTrades()){var {items:{StatueOfOnyx:d,FogLamp:e,LovePendant:f,KirisaPlant:g,IvoryStatue:h},locations:{Swan_DanceHall:k},npcs:{KensuInSwan:p}}=a,m=new Map,u=[[d,0,"Akahana"],[e,0,"Fisherman"],[f,0,"Kensu"],[g,0,"Aryllis"],[h,0,"Slimed Kensu"]],y=u.map(([a,b,c])=>{if(0>a.trades.indexOf(b)||b>=a.itemUseData.length)throw Error(`not a trade: ${a} ${b}`);return[a.itemUseData[b],a.id,c]});c.shuffle(y);for(const [c,d]of u){const [e,f,g]=y.pop();c.itemUseData[d]=e;a.spoiler&&
a.spoiler.addTrade(c.id,c.messageName,g);291===e.want?a.prg[251061]=c.id-28:356===e.want&&b.fogLampNotRequired()&&([...a.npcs[100].spawnConditions.values()][0][0]=512|c.id);m.set(f,c.id)}a.itemGets.actionGrants=new Map([...a.itemGets.actionGrants].map(([a,b])=>{var c;return[null!==(c=m.get(a))&&void 0!==c?c:a,b]}));b=a.items[c.nextInt(4)];a.npcs[195].localDialogs.get(-1)[0].condition=512|b.id;a.spoiler&&a.spoiler.addTrade(b.id,b.messageName,"Rage");a.npcs[56].localDialogs.get(-1)[3].condition=512|
b.id;c=a.items[2*c.nextInt(4)+6];for(const d of a.npcs[95].localDialogs.values())for(b=2;b<d.length;b++)if(3===d[b].message.action){d[b-2].condition=~(512|c.id-1);d[b-1].condition=~(512|c.id);a.spoiler&&a.spoiler.addTrade(c.id,c.messageName,"Tornel");break}p.dialog(k)[0].message.mid="13:00"}}function fl(a){const b=new Map;for(const c of a.items)for(const a of c.trades)b.set(c.itemUseData[a].want&255,c.id);return b};function gl(a){function b(b){const c=pa.get(b.id);if(!c)throw Error(`No trade-in for ${b.name}`);return a.items[c]}function c(a){e(a,/teach\s+you\s+the\s+magic\s+of/,"bestow upon you the")}function d(b){"number"===typeof b?b=a.items[a.itemGets[b&255].itemId]:b instanceof S||(b=b.item);return`[${w(b.id)}:${b.messageName}]`}function e(b,c,d){const [e,f]=b.split(":").map((a)=>parseInt(a,16));b=a.messages.parts[e][f];b.text=b.text.replace(c,d)}const {flags:{AkahanaStatueOfOnyxTradein:f,AsinaInBackRoom:g,
BehindWhirlpool:h,KensuInSwan:k,MtSabreNorthSummit:p,MtSabreWestTornel:m,PortoaQueen:u,Rage:y,RepairedStatue:G,SlimedKensu:A,StomFightReward:T,ZebuAtWindmill:ma},npcs:{AkahanaInBrynmaer:M,Aryllis:Z,Fisherman:ea}}=a;e("03:06",",","");const pa=fl(a);ma.item.isMagic()||c("00:1b");e("00:1b","[41:Refresh]",d(ma.item));var P=b(M);e("02:01","an unusual statue",hl(P));e("02:02","a statue",`the ${il(P)}`);e("02:02","[29:Gas Mask]",d(f));T.item.isMagic()||c("03:01");e("03:01","[43:Telepathy]",d(T));P=jl(a);
e("03:01","[06:Tornado Bracelet]",d(P));e("05:0a","[06:Tornado Bracelet]",d(P));e("05:0a","[44:Teleport]",d(m));P=b(ea);e("09:01","[35:Fog Lamp]",d(P));e("09:04","[35:Fog Lamp]",d(P));e("09:05","[35:Fog Lamp]",d(P));e("09:06","lamp",il(P));P=a.npcs.PortoaQueen.dialog()[3].condition;e("0a:0c","[28:Flute of Lime]",d(u));e("0a:0d","[02:Sword of Water]",d(P));g.item.isMagic()||c("0b:01");e("0b:01","[45:Recover]",d(g));h.item.isMagic()||(c("0b:01"),c("1d:12"));e("0b:01","[46:Barrier]",d(h));e("1d:12",
"[46:Barrier]",d(h));(P=function(...b){var c=[(a)=>kl.has(a),(a)=>ll.has(a),(b)=>a.items[a.itemGets[b].itemId].unique];for(const d of c)for(const e of b){c=a.locations[e];for(const b of c.spawns)if(b.isChest()&&(c=a.slots[b.id],72>=c&&d(c)))return a.items[c]}}(79,78,77,76,71,70,69,68,75,74,73,72))?e("0d:00","[35:Fog Lamp]",d(P)):e("0d:00","that a [35:Fog Lamp] was","there was treasure");P=a.npcs.Rage.dialog()[0].condition;e("0e:03","[02:Sword of Water]",d(P));e("0e:03","[09:Ball of Water]",d(y));
e("10:0c","that's","is");e("10:0c",/, is in the\+lighthouse/,"");P=b(Z);e("12:05","[3c:Kirisa Plant]",d(P));e("12:10","the plant",`the ${il(P)}`);e("12:10","[3c:Kirisa Plant]",d(P));P=`Our illustrious chief seeks ${hl(P)}.`;e("12:09",/[^]*/,P);e("12:0a",/[^]*/,P);P=b(a.npcs.KensuInSwan);e("13:02","[3b:Love Pendant]",d(P));e("13:00","pendant",il(P));k.item.isMagic()||c("13:02");e("13:02","[47:Change]",d(k));P=b(a.npcs.SlimedKensu);e("18:06","[3d:Ivory Statue]",d(P));e("18:07","[3d:Ivory Statue]",d(P));
e("18:06","It's in a room","{0b:Karmine} is");A.item.isMagic()||e("18:07","teach","give");e("18:07","[48:Flight]",d(A));p.item.isMagic()||c("1c:10");e("1c:10","[42:Paralysis]",d(p));e("20:06","Statue of Gold",d(G))}const kl=new Set([62,63,64]),ll=new Set([0,1,2,3,65,66,67,68,69,70,71,72]);function jl(a){var {Tornel:b}=a.npcs;for(const c of b.localDialogs.values())for(b=2;b<c.length;b++){const d=~c[b].condition;if(516<d&&524>=d&&!(d&1))return a.items[d&255]}return a.items.TornadoBracelet}
function hl(a){const b=a.rom.items;switch(a){case b.StatueOfOnyx:return"an unusual statue";case b.FluteOfLime:return"a rare instrument";case b.FogLamp:return"a brilliant lamp";case b.LovePendant:return"a beautiful charm";case b.KirisaPlant:return"a fragrant plant";case b.IvoryStatue:return"an exotic statue"}throw Error("impossible");}
function il(a){const b=a.rom.items;switch(a){case b.StatueOfOnyx:return"statue";case b.FluteOfLime:return"instrument";case b.FogLamp:return"lamp";case b.LovePendant:return"pendant";case b.KirisaPlant:return"plant";case b.IvoryStatue:return"statue"}throw Error("impossible");};function ml(a){const {locations:{AngrySea:b},npcs:{Dolphin:c},metascreens:{beachCabinEntrance:d,beachCave:e,beachExitN:f,boatChannel:g}}=a;c.spawnScripts=[];a=new Set(v(16,(a)=>a));for(let h=0;h<b.entrances.length;h++){let k=b.entrances[h],p=b.meta.get(k.screen),m;if(p===g){if(b.meta.get(k.screen-1)!==d)throw Error(`Bad boatChannel entrance ${k}`);k=nk.Entrance.of({screen:k.screen-1,tile:0});p=d}p===d?m={entrance:nk.Entrance.of({screen:k.screen-17,coord:47336}),movement:5}:p===e?m={entrance:nk.Entrance.of({screen:k.screen,
coord:59400}),movement:8}:p===f&&(m={entrance:nk.Entrance.of({screen:k.screen,coord:55544}),movement:9});m&&(a.delete(h),c.spawnScripts[h]=m)}[c.channelSpawn,c.evilSpiritIslandSpawn]=a;c.spawnScripts[c.channelSpawn]={entrance:nk.Entrance.of({x:424,y:120}),movement:6};c.spawnScripts[c.evilSpiritIslandSpawn]={entrance:nk.Entrance.of({x:424,y:120}),movement:7}};function nl(a){var b,c=new Set;for(var d of a.locations)for(var e of null!==(b=d.pits)&&void 0!==b?b:[])c.add(e.dest<<8|e.toScreen);for(const f of c){b=a.locations[f>>8];const g=f&255;c=b.exits.filter((a)=>a.screen===g);e=b.entrances.filter((a)=>a.screen===g);c=new Map(c.map((a)=>[a.tile,a]));d=new yg;for(const a of c.keys())for(const b of ol)c.has(a+b)&&d.union([a,a+b]);d=d.map();for(const a of e)for(const g of ol){e=d.get(a.tile+g);for(const a of null!==e&&void 0!==e?e:[])e=c.get(a),e=nk.Exit.of({screen:f&
255,tile:a+g,dest:e.dest,entrance:e.entrance}),b.exits.push(e)}}}const ol=[1,-1,16,-16];function pl(a,b){var c=[...a.townWarp.locations].filter((a)=>255!==a);b=b.nextInt(c.length);const d=c[b];let e=64;if(d===a.locations.Shyron.id||d===a.locations.Shyron_Temple.id)e=65;a.townWarp.thunderSwordWarp=[d,e];c=768-c.length+b;a=a.itemGets[3].flags;for(b=0;b<a.length;b++)if(765===a[b]){a[b]=c;return}a.push(c)};function ql(a,b,c){var d=new Set(v(256,(a)=>a).filter((b)=>b in a.objects));for(var [e]of rl)d.delete(e);for(const [b,c]of rl)for(var f of d)a.objects[b].base===a.objects[f].base&&(rl.set(f,c),d.delete(b));for(var g of[200,249,250])a.objects[g].attackType=240<g?254:255,a.objects[g].statusEffect=0;a.objects[125].elements|=8;e=new Set([87,94,104,125,136,151,155,158]);d=new Set([80,83,95,105]);for(const [h,{sdef:k,swrd:p,hits:m,satk:u,dgld:y,sexp:G}]of rl)f=a.objects[h].data,g=e.has(h)?1:0,f[2]|=128,
f[6]=m,f[7]=u,f[8]=k|p<<4,f[16]=f[16]&15|y<<4,f[17]=G,(g?b.shuffleBossElements():b.shuffleMonsterElements())&&!d.has(h)&&(f=[...a.objects[h].elements.toString(2).padStart(4,"0")],c.shuffle(f),a.objects[h].elements=Number.parseInt(f.join(""),2));if(b.shuffleMonsterElements()){b=c.nextInt(4);a.prg[217645]=b+1;for(const c of d)a.objects[c].elements=1<<b}}
const rl=new Map([[63,"p","Sorceror shot",,,,19,,,],[75,"m","wraith??",2,,2,22,4,61],[79,"m","wraith",1,,2,20,4,61],[80,"m","Blue Slime",,,1,16,2,32],[81,"m","Weretiger",,,1,21,4,40],[82,"m","Green Jelly",4,,3,16,4,36],[83,"m","Red Slime",6,,4,16,4,48],[84,"m","Rock Golem",6,,11,24,6,85],[85,"m","Blue Bat",,,,4,,32],[86,"m","Green Wyvern",4,,4,24,6,52],[87,"b","Vampire",3,,12,18,,110],[88,"m","Orc",3,,4,21,4,57],[89,"m","Red Flying Swamp Insect",3,,1,21,4,57],[90,"m","Blue Mushroom",2,,1,21,4,44],
[91,"m","Swamp Tomato",3,,2,35,4,52],[92,"m","Flying Meadow Insect",3,,3,23,4,81],[93,"m","Swamp Plant",,,,,,36],[94,"b","Insect",,1,8,6,,100],[95,"m","Large Blue Slime",5,,3,20,4,52],[96,"m","Ice Zombie",5,,7,14,4,57],[97,"m","Green Living Rock",,,1,9,4,28],[98,"m","Green Spider",4,,4,22,4,44],[99,"m","Red/Purple Wyvern",3,,4,30,4,65],[100,"m","Draygonia Soldier",6,,11,36,4,89],[101,"m","Ice Entity",3,,2,24,4,52],[102,"m","Red Living Rock",,,1,13,4,40],[103,"m","Ice Golem",7,2,11,28,4,81],[104,"b",
"Kelbesque",4,6,12,29,,120],[105,"m","Giant Red Slime",7,,40,90,4,102],[106,"m","Troll",2,,3,24,4,65],[107,"m","Red Jelly",2,,2,14,4,44],[108,"m","Medusa",3,,4,36,8,77],[109,"m","Red Crab",2,,1,21,4,44],[110,"m","Medusa Head",,,1,29,4,36],[111,"m","Evil Bird",,,2,30,6,65],[113,"m","Red/Purple Mushroom",3,,5,19,6,69],[114,"m","Violet Earth Entity",3,,3,18,6,61],[115,"m","Mimic",,,3,26,15,73],[116,"m","Red Spider",3,,4,22,6,48],[117,"m","Fishman",4,,6,19,5,61],[118,"m","Jellyfish",,,3,14,3,48],[119,
"m","Kraken",5,,11,25,7,73],[120,"m","Dark Green Wyvern",4,,5,21,5,61],[121,"m","Sand Monster",5,,8,6,4,57],[123,"m","Wraith Shadow 1",,,,9,7,44],[124,"m","Killer Moth",,,2,35,,77],[125,"b","Sabera",3,7,13,24,,110],[128,"m","Draygonia Archer",1,,3,20,6,61],[129,"m","Evil Bomber Bird",,,1,19,4,65],[130,"m","Lavaman/blob",3,,3,24,6,85],[132,"m","Lizardman (w/ flail(",2,,3,30,6,81],[133,"m","Giant Eye",3,,5,33,4,81],[134,"m","Salamander",2,,4,29,8,77],[135,"m","Sorceror",2,,5,31,6,65],[136,"b","Mado",
4,8,10,30,,110],[137,"m","Draygonia Knight",2,,3,24,4,77],[138,"m","Devil",,,1,18,4,52],[139,"b","Kelbesque 2",4,6,11,27,,110],[140,"m","Wraith Shadow 2",,,,17,4,48],[144,"b","Sabera 2",5,7,21,27,,120],[145,"m","Tarantula",3,,3,21,6,73],[146,"m","Skeleton",,,4,30,6,69],[147,"b","Mado 2",4,8,11,25,,120],[148,"m","Purple Giant Eye",4,,10,23,6,102],[149,"m","Black Knight (w/ flail)",3,,7,26,6,89],[150,"m","Scorpion",3,,5,29,2,73],[151,"b","Karmine",4,,14,26,,110],[152,"m","Sandman/blob",3,,5,36,6,98],
[153,"m","Mummy",5,,19,36,6,110],[154,"m","Tomb Guardian",7,,60,37,6,106],[155,"b","Draygon",5,6,16,41,,110],[158,"b","Draygon 2",7,6,28,40,,,],[160,"m","Ground Sentry (1)",4,,6,26,,73],[161,"m","Tower Defense Mech (2)",5,,8,36,,85],[162,"m","Tower Sentinel",,,1,,,32],[163,"m","Air Sentry",3,,2,26,,65],[165,"b","Vampire 2",3,,12,27,,100],[164,"b","Dyna",6,5,32,,,,],[180,"b","dyna pod",6,5,48,26,,,],[184,"p","dyna counter",15,,,42,,,],[185,"p","dyna laser",15,,,42,,,],[186,"p","dyna bubble",,,,36,
,,],[188,"m","vamp2 bat",,,,16,,15],[191,"p","draygon2 fireball",,,,26,,,],[193,"m","vamp1 bat",,,,16,,15],[195,"p","giant insect spit",,,,35,,,],[196,"m","summoned insect",4,,2,42,,98],[197,"p","kelby1 rock",,,,22,,,],[198,"p","sabera1 balls",,,,19,,,],[199,"p","kelby2 fireballs",,,,11,,,],[200,"p","sabera2 fire",,,1,6,,,],[201,"p","sabera2 balls",,,,17,,,],[202,"p","karmine balls",,,,25,,,],[203,"p","sun/moon statue fireballs",,,,39,,,],[204,"p","draygon1 lightning",,,,37,,,],[205,"p","draygon2 laser",
,,,36,,,],[206,"p","draygon2 breath",,,,36,,,],[224,"p","evil bomber bird bomb",,,,2,,,],[226,"p","summoned insect bomb",,,,47,,,],[227,"p","paralysis beam",,,,23,,,],[228,"p","stone gaze",,,,33,,,],[229,"p","rock golem rock",,,,24,,,],[230,"p","curse beam",,,,10,,,],[231,"p","mp drain web",,,,11,,,],[232,"p","fishman trident",,,,15,,,],[233,"p","orc axe",,,,24,,,],[234,"p","Swamp Pollen",,,,37,,,],[235,"p","paralysis powder",,,,17,,,],[236,"p","draygonia solider sword",,,,28,,,],[237,"p","ice golem rock",
,,,20,,,],[238,"p","troll axe",,,,27,,,],[239,"p","kraken ink",,,,24,,,],[240,"p","draygonia archer arrow",,,,12,,,],[241,"p","??? unused",,,,16,,,],[242,"p","draygonia knight sword",,,,9,,,],[243,"p","moth residue",,,,19,,,],[244,"p","ground sentry laser",,,,13,,,],[245,"p","tower defense mech laser",,,,23,,,],[246,"p","tower sentinel laser",,,,8,,,],[247,"p","skeleton shot",,,,11,,,],[248,"p","lavaman shot",,,,14,,,],[249,"p","black knight flail",,,,18,,,],[250,"p","lizardman flail",,,,21,,,],[252,
"p","mado shuriken",,,,36,,,],[253,"p","guardian statue missile",,,,23,,,],[254,"p","demon wall fire",,,,23,,,]].map(([a,b,c,d=0,e=0,f=0,g=0,h=0,k=0])=>[a,{id:a,type:b,name:c,sdef:d,swrd:e,hits:f,satk:g,dgld:h,sexp:k}]));function sl(a){console.log("flip sabera entrance");const b=a[0];b.set2d(113,[[b.rom.metascreens.deadEndE_upStair],[b.rom.metascreens.caveEmpty]]);b.moveExits([129,"stair:down",113,"stair:up"]);a[1]=113;a[2]="stair:up"}function tl(a,b){console.log("flip karmine entrance");const c=a[0],d=c.rom.metascreens;c.set2d(32,[[d.caveEmpty,d.hallNS],[d.deadEndE_upStair,d.hallNW]]);c.replaceMonsters(b);c.moveExits([48,"stair:down",48,"stair:up"]);a[2]="stair:up"}
function ul(a){console.log("flip karmine exit");const b=a[0],c=b.rom.metascreens;b.set2d(1,[[c.deadEndS_stairs,c.caveEmpty]]);b.moveExits([2,"stair:down",1,"stair:up"]);a[1]=1;a[2]="stair:up"}function vl(a){console.log("flip generic exit");const b=a[0],c=b.rom.metascreens;2>b.width&&(b.width=2);b.set2d(0,[[c.hallSE,c.deadEndW_downStair]]);b.moveExits([0,"stair:up",1,"stair:down"]);a[1]=1;a[2]="stair:down"}
function wl(a,b){const c=a.locations;var d=[0,1,2,3];b.shuffle(d);const e=[[c.GoaFortress_Kelbesque.meta,131,"stair:down"],[c.GoaFortress_Sabera.meta,129,"stair:down",sl],[c.GoaFortress_Mado1.meta,114,"stair:down"],[c.GoaFortress_Karmine1.meta,48,"stair:down",tl]],f=[[c.GoaFortress_Zebu.meta,0,"stair:up",vl],[c.GoaFortress_Tornel.meta,0,"stair:up",vl],[c.GoaFortress_Asina.meta,0,"stair:up",vl],[c.GoaFortress_Kensu.meta,2,"stair:down",ul]],g=[[c.GoaFortress_Entrance.meta,0,"edge:top"]],h=[];var k=
!0;let p=g[0];for(const c of d){var m=k||e[c][3]||g[g.length-1][3];d=m?b.pick([!1,!0]):!0;console.log(`FLOOR ${c}: up ${k} flexible ${!!m} reverse ${d}`);m=d?f[c]:e[c];console.log(`push b ${a.locations[m[0].id].name}`);h.push(m);k!==("stair:down"===m[2])&&(m[3]?(k=m,k[3](k,b),k[3]=void 0):(k=p,k[3](k,b),k[3]=void 0));g.push(p=d?e[c]:f[c]);console.log(`push a ${a.locations[p[0].id].name}`);k="stair:up"===p[2]}k&&(a=p,a[3](a,b),a[3]=void 0);h.push([c.GoaFortress_Exit.meta,1,"stair:up"]);for(b=0;b<g.length;b++)g[b][0].attach(g[b][1],
h[b][0],h[b][1],g[b][2],h[b][2])};function xl(a,b,c){b=a.locations;{const {swamp:b}=a.metatilesets,c=a.metascreens,f=[[3,218,172],[4,228,170],[5,229,170],[6,230,170],[7,231,170],[8,240,170],[9,241,170],[10,242,170],[11,243,170],[12,220,170],[13,221,170]];for(const [a,c,d]of f)b.getTile(a).copyFrom(c).setAlternative(d);c.swampEmpty.screen.set2d(0,[[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[168,204],[210,204],[210,204],[210,204],[210,226],[226,200]]);c.swampE.screen.set2d(76,[[8,9],[12,11],[3,3]]);
c.swampWSE.screen.set2d(37,[[,,4],[8,9,5],[,10,6],[,11,7],[,3,3]]);c.swampW.screen.set2d(36,[[4],[],[6],[7,13],[3,3]]);c.swampWS.screen.set2d(71,[[8,9],[12,11],[3,3]]);c.registerFix(K.SwampDoors,0)}Bj(a,c);a=[new I(b.EastCave1),new I(b.EastCave2),new I(b.EastCave3),new tj(b.SealedCave2,b.SealedCave1),new I(b.SealedCave3),new I(b.SealedCave4),new I(b.SealedCave5),new I(b.SealedCave6),new I(b.SealedCave7),new I(b.SealedCave8),new I(b.WindmillCave),new I(b.ZebuCave),new Nj(b.Swamp),new I(b.MtSabreWest_Cave1),
new I(b.MtSabreWest_Cave2),new I(b.MtSabreWest_Cave3),new I(b.MtSabreWest_Cave4),new I(b.MtSabreWest_Cave5),new I(b.MtSabreWest_Cave6),new rj(b.MtSabreWest_Cave7),new I(b.MtSabreNorth_Cave1),new I(b.MtSabreNorth_Cave2),new I(b.MtSabreNorth_Cave3),new I(b.MtSabreNorth_Cave4),new I(b.MtSabreNorth_Cave5),new I(b.MtSabreNorth_Cave6),new I(b.MtSabreNorth_Cave7),new I(b.MtSabreNorth_Cave8),new I(b.MtSabreNorth_Cave9),new I(b.MtSabreNorth_LeftCell2),new I(b.MtSabreNorth_SummitCave),new I(b.KirisaPlantCave1),
new I(b.KirisaPlantCave2),new I(b.KirisaPlantCave3),new I(b.FogLampCave1),new I(b.FogLampCave2),new I(b.FogLampCave3),new sj(b.FogLampCaveDeadEnd),new tj(b.FogLampCave4,b.FogLampCave5,!0),new tj(b.FogLampCave6,b.FogLampCave7),new rj(b.WaterfallCave1),new I(b.WaterfallCave2),new oj(b.WaterfallCave3),new Mj(b.WaterfallCave4),new Lj(b.EvilSpiritIsland2),new Lj(b.EvilSpiritIsland4),new Kj(b.SaberaPalace1),new I(b.JoelSecretPassage),new I(b.MtHydra_Cave1),new I(b.MtHydra_Cave2),new I(b.MtHydra_Cave3),
new I(b.MtHydra_Cave4),new I(b.MtHydra_Cave5),new I(b.MtHydra_Cave6),new oj(b.MtHydra_Cave7),new I(b.MtHydra_Cave8),new I(b.MtHydra_Cave9),new I(b.MtHydra_Cave10),new oj(b.Styx1),new I(b.DesertCave1),new I(b.DesertCave2),new I(b.Pyramid_Branch),new Gj(b.Pyramid_Main),new pj(b.Crypt_Entrance),new oj(b.Crypt_Hall1),new I(b.Crypt_DeadEndLeft),new I(b.Crypt_DeadEndRight),new Aj(b.GoaFortress_Kelbesque),new Lj(b.GoaFortress_Sabera),new I(b.GoaFortress_Mado1),new I(b.GoaFortress_Karmine1),new I(b.GoaFortress_Karmine2),
new I(b.GoaFortress_Karmine4),new qj(b.GoaFortress_Karmine6)];for(const b of a)b.shuffle(c)};function yl(a,b,c){const d=[],e=[];for(const c of a.locations)for(const g of c.spawns)if(g.isChest()){var f=a.slots[g.id];112<=f&&e.push(g.id);if(b.preserveUniqueChecks()&&(f=a.itemGets[f],f=a.items[null===f||void 0===f?void 0:f.itemId],null===f||void 0===f?0:f.unique))continue;g.isInvisible()||d.push(g.id)}c.shuffle(d);Qa.zip(e,d,(b,c)=>a.slots.swap(b,c))};function zl(a,b){for(const c of a.locations)c.meta.replaceMonsters(b)};class Al{constructor(a){this.rom=a;this.monsterConstraints=new Map;this.npcConstraints=new Map;this.allSpritePalettes=new Set;var b=new n(()=>[]);for(var c of a.locations)if(c.used)for(var d=0;d<c.spawns.length;d++){const a=c.spawns[d];a.used&&(a.isMonster()?b.get(a.monsterId).push([c,d,a]):(a.isNpc()||a.isBoss())&&b.get(~a.id).push([c,d,a]))}for(const [e,f]of b)if(0>e){b=a.npcs[~e];c=[b.data[3]];if(!a.metasprites[c[0]])throw Error(`bad NPC: ${~e}`);208===b.data[2]&&c.push(192);b=this.computeConstraint(c,
f,!0,128>b.data[2]?b.data[2]&112:0);95===~e&&(b=b.ignorePalette());this.npcConstraints.set(~e,b)}else{c=Rg.ALL;b=this.rom.objects[e];if(!(b instanceof cj))throw Error(`expected monster: ${b} from ${f}`);for(const g of Bl(a,b)){d=gj.get(g.action);d=this.computeConstraint((d&&d.metasprites||(()=>[g.metasprite]))(g),f,g.id===e,g.data[1]);d=c.meet(d);if(!d)throw Error(`Bad meet for ${e} with ${g.id}`);d&&(c=d);if(g.data[4]&2&&(d=this.computeConstraint([g.data[20]],f,!1,g.data[1]),c=c.meet(d),!c))throw Error(`Bad meet for ${e} bonus ${g.id}`);
}this.monsterConstraints.set(b.id,c);b.constraint=c}}getMonsterConstraint(a,b){const c=this.monsterConstraints.get(b)||Rg.NONE;return 88!==(a&88)&&this.rom.objects[b].goldDrop?c.meet(Rg.COIN)||Rg.NONE:c}getNpcConstraint(a,b){const c=this.npcConstraints.get(b)||Rg.NONE;return 30===a&&96===b?c.meet(Rg.STOM_FIGHT):160===a&&201===b?c.meet(Rg.GUARDIAN_STATUE):c}shufflePalettes(a){const b=[...this.allSpritePalettes];for(const [c,d]of this.monsterConstraints)this.monsterConstraints.set(c,d.shufflePalette(a,
b));for(const [c,d]of this.npcConstraints)this.npcConstraints.set(c,d.shufflePalette(a,b))}configure(a,b){if(b.used){var c=b.isMonster()?this.monsterConstraints.get(b.monsterId):b.isNpc()?this.npcConstraints.get(b.id):b.isChest()?112>b.id?Rg.TREASURE_CHEST:Rg.MIMIC:void 0;if(c){if(3===c.shift||2<=c.float.length)throw Error("don't know what to do with two floats");if(!c.float.length)b.patternBank=Number(2===c.shift);else if(c.float[0].has(a.spritePatterns[0]))b.patternBank=0;else if(c.float[0].has(a.spritePatterns[1]))b.patternBank=
1;else if(b.isMonster())throw Error("no matching pattern bank");}}}computeConstraint(a,b,c,d=0){const e=new Set,f=new Set;for(const b of a.map((a)=>this.rom.metasprites[a])){for(const a of b.palettes())f.add(a);for(const a of b.patternBanks(d))e.add(a)}c=c&&1==e.size&&2===[...e][0];a=new Map;for(const [d,,e]of b)a.set(e.patternBank&&c?~d.id:d.id,e);b=void 0;for(let [d,h]of a){a=this.rom.locations[0>d?~d:d];for(const b of f)1<b&&this.allSpritePalettes.add(a.spritePalettes[b-2]);a=Rg.fromSpawn(f,e,
a,h,c);b=b?b.join(a):a;!c&&h.patternBank&&(b=b.shifted())}if(!b)throw Error("Expected child to appear");return b}}function*Bl(a,b){yield b;var c=b.spawnedReplacement();c&&(yield*Bl(a,c));(c=b.spawnedChild())&&(yield*Bl(a,c));80===b.id&&(yield a.objects[95]);83===b.id&&(yield a.objects[105])};function Cl(a,b,c){const d=new Al(a);b.shuffleSpritePalettes()&&d.shufflePalettes(c);b=new Dl(b,{});for(const c of a.locations)c.used&&b.populate(c);b.shuffle(c,d)}
class Dl{constructor(a,b){this.flags=a;this.report=b;this.monsters=[];this.used=[];this.locations=[]}populate(a){var b=El[a.id]||{},c=Object.assign({},b);const d=void 0===b.skip?!1:b.skip;b=void 0===b.tower?!1:b.tower;c=(delete c.maxFlyers,delete c.nonFlyers,delete c.skip,delete c.tower,delete c.fixedSlots,c);for(var e of Object.keys(c))throw Error(`Unexpected property '${e}' in MONSTER_ADJUSTMENTS[${a.id}]`);var f=!0===d||!this.flags.shuffleTowerMonsters()&&b||!a.spritePatterns||!a.spritePalettes;
e=[];c=[];b=12;for(const d of f?[]:a.spawns){++b;if(!d.used||!d.isMonster())continue;f=d.monsterId;if(!rl.has(f)||"m"!==rl.get(f).type)continue;var g=a.rom.objects[f];if(!(g instanceof cj))continue;if(g.isUntouchedMonster())continue;const k=d.patternBank,m=a.spritePatterns[k];var h=g.palettes(!0);g=h.includes(2)?a.spritePalettes[0]:void 0;h=h.includes(3)?a.spritePalettes[1]:void 0;e.push({id:f,pat:m,pal2:g,pal3:h,patBank:k});(this.report[`start-${f.toString(16)}`]=this.report[`start-${f.toString(16)}`]||
[]).push("$"+a.id.toString(16));c.push(b)}if(!e.length||d)c=[];this.locations.push({location:a,slots:c});this.monsters.push(...e)}shuffle(a,b){this.report["pre-shuffle locations"]=this.locations.map((a)=>a.location.id);this.report["pre-shuffle monsters"]=this.monsters.map((a)=>a.id);a.shuffle(this.locations);a.shuffle(this.monsters);this.report["post-shuffle locations"]=this.locations.map((a)=>a.location.id);for(this.report["post-shuffle monsters"]=this.monsters.map((a)=>a.id);this.locations.length;){const {location:e,
slots:f}=this.locations.pop(),g=this.report["$"+e.id.toString(16).padStart(2,"0")]=[],{maxFlyers:h=0,nonFlyers:k={},tower:p=!1}=El[e.id]||{};if(p)continue;let m=h,u=Rg.forLocation(e.id);e.bossId();for(const a of e.spawns)if(a.isChest()&&!a.isInvisible())u=112>a.id?u.meet(Rg.TREASURE_CHEST,!0):u.meet(Rg.MIMIC,!0);else if(a.isNpc()||a.isBoss()){var c=b.getNpcConstraint(e.id,a.id);u=u.meet(c,!0);!a.isNpc()||107!==a.id&&104!==a.id||(u=u.meet(Rg.KENSU_CHEST,!0))}else a.isMonster()&&Fl(e.rom,a.monsterId)?
(c=b.getMonsterConstraint(e.id,a.monsterId),u=u.meet(c,!0)):a.isShootingWall(e)&&(u=u.meet(Rg.SHOOTING_WALL,!0));g.push(`Initial pass: ${u.fixed.map((a)=>Infinity>a.size?"["+[...a].join(", ")+"]":"all")}`);const y=new Map;c=(a)=>{var c=e.rom.objects[a.id];if(c.monsterClass){var d=y.get(c.monsterClass);if(null!=d&&d!==a.id)return!1}d=Gl.has(a.id);var h=Hl.has(a.id);if(d){if(!m)return!1;--m}const p=b.getMonsterConstraint(e.id,a.id);let A=u.tryMeet(p);!A&&Infinity>u.pal2.size&&Infinity>u.pal3.size&&
this.flags.shuffleSpritePalettes()&&(A=u.tryMeet(p,!0));if(!A)return!1;if(G){var pa=e.rom.objects[a.id];if(!(pa instanceof cj))throw Error(`non-monster: ${pa}`);pa=G(pa);if(null==pa)return!1}g.push(`  Adding ${a.id.toString(16)}: ${A}`);u=A;c.monsterClass&&y.set(c.monsterClass,a.id);c=0;if(d||h)for(d=0;d<f.length;d++){if(f[d]in k){c=d;break}}else for(d=0;d<f.length;d++)if(!(f[d]in k)){c=d;break}(this.report[`mon-${a.id.toString(16)}`]=this.report[`mon-${a.id.toString(16)}`]||[]).push("$"+e.id.toString(16));
d=f[c];h=e.spawns[d-13];G?(h.screen=pa>>>8,h.tile=pa&255):d in k&&(h.y+=16*k[d][0],h.x+=16*k[d][1]);h.monsterId=a.id;g.push(`    slot ${d.toString(16)}: ${h}`);f.splice(c,1);return!0};const G=f.length&&this.flags.randomizeMaps()?e.monsterPlacer(a):null;if(m&&f.length)for(var d=0;d<Math.min(40,this.monsters.length);d++)Gl.has(this.monsters[d].id)&&c(this.monsters[d])&&this.monsters.splice(d,1);for(d=0;d<this.monsters.length&&f.length;d++)if(c(this.monsters[d])){const [a]=this.monsters.splice(d,1);
Gl.has(a.id)||this.used.push(a);d--}for(d=0;d<this.used.length&&f.length;d++)c(this.used[d])&&(this.used.push(...this.used.splice(d,1)),d--);u.fix(e,a);if(f.length){console.error(`Failed to fill location ${e.id.toString(16)}: ${f.length} remaining`);for(const a of f)c=e.spawns[a-13],c.x=c.y=0,c.id=176,c.data[0]=254}for(const a of e.spawns)b.configure(e,a)}}}function Fl(a,b){a=a.objects[b];return a instanceof cj&&a.isUntouchedMonster()}
const Gl=new Set([89,92,110,111,129,138,163,196]),Hl=new Set([85,93,124,188,193]),El={[3]:{fixedSlots:{pat1:96},maxFlyers:2},[7]:{nonFlyers:{[15]:[0,-3],[16]:[-10,0],[17]:[0,4]}},[20]:{maxFlyers:2},[21]:{maxFlyers:2},[26]:{fixedSlots:{pal3:35,pat1:79},maxFlyers:2,nonFlyers:{[16]:[4,0],[17]:[5,0],[18]:[4,0],[19]:[5,0],[20]:[4,0],[21]:[4,0]}},[27]:{skip:!0},[32]:{maxFlyers:1},[33]:{fixedSlots:{pat1:80},maxFlyers:1},[39]:{nonFlyers:{[13]:[0,16]}},[40]:{maxFlyers:1},[41]:{maxFlyers:1},[43]:{nonFlyers:{[20]:[32,
-8]}},[64]:{maxFlyers:2,nonFlyers:{[19]:[12,-16]}},[65]:{maxFlyers:2,nonFlyers:{[21]:[0,-6]}},[66]:{maxFlyers:2,nonFlyers:{[13]:[0,8],[14]:[-8,8]}},[71]:{maxFlyers:1,nonFlyers:{[13]:[-8,-8]}},[74]:{maxFlyers:1,nonFlyers:{[14]:[4,0],[15]:[0,-3],[16]:[0,4]}},[76]:{},[77]:{maxFlyers:1},[78]:{maxFlyers:1},[79]:{},[87]:{fixedSlots:{pat1:77}},[89]:{tower:!0},[90]:{tower:!0},[91]:{tower:!0},[96]:{fixedSlots:{pal3:8,pat1:82},maxFlyers:2,skip:!0},[100]:{fixedSlots:{pal3:8,pat1:82},skip:!0},[104]:{fixedSlots:{pal3:8,
pat1:82},skip:!0},[105]:{maxFlyers:1,nonFlyers:{[23]:[4,6]}},[106]:{maxFlyers:1,nonFlyers:{[21]:[0,24]}},[108]:{maxFlyers:1,nonFlyers:{[23]:[0,24]}},[109]:{maxFlyers:1,nonFlyers:{[17]:[16,0],[27]:[0,0],[28]:[6,0]}},[120]:{maxFlyers:1,nonFlyers:{[22]:[-8,-8]}},[124]:{maxFlyers:1,nonFlyers:{[21]:[-39,84]}},[132]:{nonFlyers:{[18]:[0,-4],[19]:[0,4],[20]:[-6,0],[21]:[14,12]}},[136]:{maxFlyers:1},[137]:{maxFlyers:1},[138]:{maxFlyers:1,nonFlyers:{[13]:[7,0],[14]:[0,0],[15]:[7,3],[16]:[0,6],[17]:[11,-16]}},
[143]:{skip:!0},[144]:{maxFlyers:2,nonFlyers:{[20]:[-11,-3],[21]:[0,16]}},[145]:{maxFlyers:2,nonFlyers:{[24]:[0,14],[25]:[4,-16]}},[152]:{maxFlyers:2,nonFlyers:{[20]:[-6,6],[21]:[0,-16]}},[158]:{maxFlyers:2},[162]:{maxFlyers:1,nonFlyers:{[18]:[0,11],[19]:[6,0]}},[165]:{nonFlyers:{[23]:[6,6],[24]:[-6,0],[25]:[-1,-7]}},[166]:{skip:!0},[168]:{skip:!0},[169]:{maxFlyers:2,nonFlyers:{[22]:[26,-16],[23]:[0,32]}},[171]:{maxFlyers:2,nonFlyers:{[13]:[1,0],[14]:[2,-2]}},[173]:{maxFlyers:2,nonFlyers:{[24]:[0,
8],[25]:[0,-8]}},[175]:{nonFlyers:{[13]:[0,0],[14]:[0,0],[19]:[59,-38]}},[180]:{maxFlyers:2,nonFlyers:{[17]:[6,0],[18]:[0,6]}},[215]:{skip:!0}};class Il{constructor(a,b,c){this.rom=a;this.flags=b;this.random=c}shuffle(){this.shuffleBackgrounds()}shuffleBackgrounds(){var a=new n(()=>[]);for(var b of this.rom.locations)a.get(b.colorGroup).push(b);b=[new Map,new Map];for(var c of a.values())for(var d of c)for(let a=0;2>a;a++)for(let c=0;2>c;c++){let e=b[a].get(d.tilePatterns[c]);e||b[a].set(d.tilePatterns[c],e=new Set);e.add(d.tilePalettes[a])}for(const e of a.values()){c=e[0];a=[new Set,new Set];for(d=0;2>d;d++)a[d]=new Set([...b[d].get(c.tilePatterns[0]),
...b[d].get(c.tilePatterns[1])]);c=this.random.pick([...a[0]]);a=this.random.pick([...a[1]]);for(const b of e)b.tilePalettes[0]=c,b.tilePalettes[1]=a}}};function Jl(a,b){if(b.eastCave){{b=b.eastCave;const {locations:{EastCave1:d,EastCave2:e,EastCave3:f,SealedCave1:g,ValleyOfWind:h},metascreens:{boundaryE_cave:k,branchNSE:p,branchNWE:m,branchNWSE:u,branchNWS:y,branchWSE:G,caveEmpty:A,deadEndE:T,deadEndE_downStair:ma,deadEndE_upStair:M,deadEndN_stairs:Z,deadEndS:ea,deadEndS_stairs:pa,deadEndW:P,deadEndW_downStair:ec,hallNE:ub,hallNS:ab,hallNW:Mb,hallSE:pb,hallWS:gb,hallWE:Bb,hallNS_entrance:fc,hallNS_ramp:gc,hallNS_wall:eb}}=a;a.locations.allocate(d);
a.locations.allocate(e);b.exit2&&a.locations.allocate(f);for(var c of[d,e,f])c.bgm=c.originalBgm=23,c.entrances=[],c.exits=[],c.pits=[],c.spawns=[],c.flags=[],c.width=c.height=1,c.screens=[[128]],c.tilePalettes=[26,27,5],c.originalTilePalettes=[26,27,5],c.tileset=136,c.tileEffects=181,c.tilePatterns=[20,2],c.spritePatterns=[...g.spritePatterns],c.spritePalettes=[...g.spritePalettes];d.meta=new ij(d.id,a.metatilesets.cave,5,5);d.meta.set2d(0,[[T,gb,A,pb,P],[A,ab,pb,Mb,A],[pb,u,y,A,A],[ab,gc,ub,Bb,
gb],[fc,ub,P,M,Mb]]);e.meta=new ij(e.id,a.metatilesets.cave,5,5);e.meta.set2d(0,[[T,gb,ea,A,ea],[A,ab,ab,A,ab],[A,p,m,G,Mb],[A,gc,A,ub,gb],[T,Mb,A,A,Z]]);h.meta.set2d(51,[[k]]);a.tileEffects[0].effects[192]=0;d.meta.attach(67,e.meta,68);d.meta.attach(64,h.meta,51);b.exit1&&(d.meta.set2d(4,[[ec]]),Kl(d,4,b.exit1));b.exit2&&(f.meta=new ij(f.id,a.metatilesets.cave,3,1),f.meta.set2d(0,[[pa],[eb],[fc]]),f.spawns.push(x.from([24,7,35,0])),f.flags.push(x.of({screen:16,flag:a.flags.alloc(512)})),e.meta.set2d(64,
[[ma]]),e.meta.attach(64,f.meta,0),Kl(f,32,b.exit2));d.spawns.push(x.of({screen:33,tile:135,timed:!0,id:2}),x.of({screen:18,tile:136,timed:!1,id:2}),x.of({screen:19,tile:137,timed:!0,id:2}),x.of({screen:50,tile:104,timed:!1,id:2}),x.of({screen:65,tile:136,timed:!0,id:2}),x.of({screen:51,tile:152,timed:!0,id:2}),x.of({screen:3,tile:136,timed:!0,id:2}));e.spawns.push(x.of({screen:1,tile:136,timed:!0,id:2}),x.of({screen:17,tile:72,timed:!1,id:2}),x.of({screen:18,tile:119,timed:!0,id:2}),x.of({screen:20,
tile:40,timed:!1,id:2}),x.of({screen:35,tile:133,timed:!0,id:2}),x.of({screen:49,tile:136,timed:!0,id:2}),x.of({screen:51,tile:138,timed:!1,id:2}),x.of({screen:52,tile:152,timed:!0,id:2}),x.of({screen:65,tile:130,timed:!0,id:2}),x.of({y:272,x:1144,type:2,id:89}),x.of({y:112,x:264,type:2,id:124}));a.slots.swap(49,89)}}else if(b.classicLimeTreeToLeaf){{const {locations:{ValleyOfWind:b,LimeTreeValley:c},metascreens:{exitE:f,exitW_southwest:g,overworldEmpty_alt:h}}=a;b.meta.set2d(84,[[f]]);c.meta.set2d(16,
[[g],[h]]);b.meta.attach(84,c.meta,16)}}{const {TowerEntrance:b,Crypt_Teleporter:c}=a.locations;c.meta.attach(0,b.meta,0,"teleporter","teleporter")}{const {flags:{OpenedSwanGate:b},locations:{SwanGate:c},npcs:{SoldierGuard:f}}=a;c.spawns.push(x.of({xt:10,yt:2,type:1,id:45}),x.of({xt:11,yt:2,type:1,id:45}));f.localDialogs.get(c.id)[0].flags.push(b.id)}c=a.locations.GoaFortress_Kensu;c.exits.splice(0,c.exits.length-4);c.meta=ij.of(c);Ll(a)}
(function(a){a.generateOptions=function(a,c){const b={};if(a.addEastCave()){b.eastCave={};a=["cordel","lime","goa","desert"];let d=c.nextInt(4);[b.eastCave.exit1]=a.splice(d,1);b.eastCave.exit2=c.pick(a)}else a.connectLimeTreeToLeaf()&&(b.classicLimeTreeToLeaf=!0);return b}})(Jl||(Jl={}));
function Kl(a,b,c){const {locations:{CordelPlainEast:d,CordelPlainWest:e,Desert2:f,GoaValley:g,LimeTreeValley:h},metascreens:{bendNE:k,bendSE:p,boundaryN_trees:m,boundaryW_cave:u,cornerNE:y,cornerNW:G,cornerSE:A,cornerSE_cave:T,cornerSW:ma}}=a.rom;let M,Z;switch(c){case "lime":M=h;Z=16;M.resizeScreens(0,1,0,0);M.meta.spliceColumns(0,1,2,[[G,m],[u,p],[ma,A]]);break;case "cordel":c=[[u,p],[ma,A]];M=d;Z=85;M.meta.set2d(85,c);e.meta.set2d(85,c);break;case "goa":M=g;Z=17;M.meta.set2d(1,[[G,y],[u,k]]);
break;case "desert":M=f,Z=83,M.meta.set2d(83,[[T]])}a.meta.attach(b,M.meta,Z)}function Ll(a){a.locations.ZebuCave.spawns.find((a)=>a.isTrigger()).yt+=3}var Ml=Jl;const Nl="Curious Key;Bronze Key;Silver Key;Ancient Key;Small Key;Shiny Key;Mysterious Key;Magic Key;Piano Key".split(";"),Ol="Wooden Flute;Metal Flute;Horn of Plenty;Ocarina;Pan Pipes;Bugle;Bagpipes;Kazoo;Magic Whistle;Dog Whistle;Recorder;Accordion;Harmonica;Sousaphone;Trombone;Violin;Cello".split(";"),Pl="Bronze Lamp;Magic Lamp;Dull Lamp;Shimmering Lamp;Oil Lamp;Broken Lamp;Frog Lamp;Smog Lamp".split(";"),Ql="Rusty Statue;Forbidden Statue;Golden Idol;Strange Statue;Glass Statue;Burt Figurine;Draygon Figurine;Karmine Figurine;Mado Figurine;Sabera Figurine;Kelbesque Figurine;Copper Statue;White Statue;Invisible Statue;Mattrick Figurine;Dragondarch Statue;Overswarm Statue;Trueblue83 Statue;Flail Guy Trophy;Metroid Amiibo".split(";");
function Rl(a,b,c){if(b.unidentifiedItems()){var d=(...b)=>b.map((b)=>a.items[b]);b=d(50,51,52);var e=d(39,40,49,54),f=d(53,57);d=d(37,56,58,61);for(const [g,[...h]]of[[b,Nl],[e,Ol],[f,Pl],[d,Ql]]){c.shuffle(h);b=c.shuffle([0,1,2,3]);for(const c of g)e=h.pop(),a.spoiler&&a.spoiler.addUnidentifiedItem(c.id,c.messageName,e),c.menuName=c.messageName=e,c.palette=b.pop()}}};function Sl(a){({locations:a}=a);const {CordelPlainEast:b,CordelPlainWest:c,WaterfallValleyNorth:d,WaterfallValleySouth:e}=a;b.meta.reconcileExits(c.meta);for(const a of d.meta.allPos()){const b=d.meta.get(a),c=e.meta.get(a);b.isEmpty()&&!c.isEmpty()?d.meta.set(a,c):c.isEmpty()&&!b.isEmpty()&&e.meta.set(a,b)}for(const b of a)b.used&&(b.exits=[],b.entrances=[]);for(const b of a)b.used&&b.meta.write()};const Tl=1/2147483563;
class Ul{constructor(a=Math.floor(4294967296*Math.random())){this.iy=this.idum2=this.idum=0;this.iv=[];this.z1=null;this.seed(a)}static newSeed(){return Math.floor(4294967296*Math.random())}seed(a){this.idum2=this.idum=Math.max(1,Math.floor(a));this.iy=0;this.iv=Array(32).fill(0);for(a=39;0<=a;a--){const b=Math.floor(this.idum/53668);this.idum=40014*(this.idum-53668*b)-12211*b;0>this.idum&&(this.idum+=2147483563);32>a&&(this.iv[a]=this.idum)}this.iy=this.iv[0]}next(){var a=Math.floor(this.idum/53668);
this.idum=40014*(this.idum-53668*a)-12211*a;0>this.idum&&(this.idum+=2147483563);a=Math.floor(this.idum2/52774);this.idum2=40692*(this.idum2-52774*a)-3791*a;0>this.idum2&&(this.idum2+=2147483399);a=Math.floor(this.iy/67108862);this.iy=this.iv[a]-this.idum2;this.iv[a]=this.idum;1>this.iy&&(this.iy+=2147483562);return Math.min(Tl*this.iy,.99999988)}nextInt(a){return Math.floor(this.next()*a)}nextNormal(a=0,b=1,c=-Infinity,d=Infinity){for(;;){let e=this.z1;if(null==e){const a=Math.sqrt(-2*Math.log(this.next())),
b=Vl*this.next();e=a*Math.cos(b);this.z1=a*Math.sin(b)}else this.z1=null;e=a+e*b;if(e>=c&&e<=d)return e}}shuffle(a){for(let b=a.length;b;){const c=this.nextInt(b--);[a[b],a[c]]=[a[c],a[b]]}return a}*ishuffle(a){const b=[];if(!Array.isArray(a)){if("size"in a){var c=a[Symbol.iterator]();for(var d=0;d<a.size;d++){const e=d+this.nextInt(a.size-d);for(;b.length<=e;)b.push(c.next().value);yield b[e];b[e]=b[d]}return}a=[...a]}if(!Array.isArray(a))throw Error("impossible");for(c=0;c<a.length;c++)d=c+this.nextInt(a.length-
c),yield d in b?b[d]:a[d],b[d]=c in b?b[c]:a[c]}pick(a){if(!a.length)throw Error("empty array");return a[this.nextInt(a.length)]}pickWeighted(a){if(!a.length)throw Error("empty array");var b=0;for(const [c]of a)b+=c;b*=this.next();for(const [c,d]of a){if(b<c)return d;b-=c}throw Error("bad weights");}bitGenerator(){let a=0,b=0;return()=>{a||(a=32,b=this.nextInt(4294967296));a--;const c=!(b&1);b>>>=1;return c}}}const Vl=2*Math.PI;class Wl extends mg{constructor(a,b){super(a,b);this.data=Id(a.prg,this.base,4)}get base(){return(this.id<<2)+171008}get slotRangeLower(){return this.data[0]}set slotRangeLower(a){this.data[0]=a}get slotRangeUpper(){return this.data[1]}set slotRangeUpper(a){this.data[1]=a}get objectId(){return this.data[2]}set objectId(a){this.data[2]=a}get count(){return this.data[3]}set count(a){this.data[3]=a}write(){const a=this.rom.assembler();a.segment("14");a.org(39936+(this.id<<2));a.byte(...this.data);return[a.module()]}}
;class Xl extends mg{constructor(a,b){super(a,b);this.base=Qd(a.prg,this.pointer);this.data=a.prg.slice(this.base+81920,this.base+81941);this.palettes=this.data.subarray(5,13);this.patterns=this.data.subarray(13,19)}get pointer(){return 129387+2*this.id}get routine(){const a=Qd(this.data,0);return a&&a+81920}set routine(a){var b=this.data;a=a?a-81920:0;b[0]=a&255;b[1]=a>>>8}get restoreMusic(){return this.data[3]}set restoreMusic(a){this.data[3]=a}get itemDrop(){return this.data[4]}set itemDrop(a){this.data[4]=
a}get restoreAnimation(){return this.data[19]}set restoreAnimation(a){this.data[19]=a}get explode(){return!!this.data[20]}set explode(a){this.data[20]=a?1:0}write(){if(!this.base)return[];const a=this.rom.assembler();a.segment("0f");a.org(this.base);a.byte(this.data[0],this.data[1]);a.org(this.base+4);a.byte(this.data[4]);return[a.module()]}};const {$0f:Yl,$1b:Zl}=z;
class Tp{constructor(a){this.rom=a;this.Vampire1=new Up(this,{flag:this.rom.flags.Vampire1,kill:0,npc:this.rom.npcs.Vampire1,shuffled:!0,sword:1});this.Insect=new Up(this,{flag:this.rom.flags.GiantInsect,kill:1,npc:this.rom.npcs.Insect,sword:1});this.Kelbesque1=new Up(this,{flag:this.rom.flags.Kelbesque1,kill:2,npc:this.rom.npcs.Kelbesque1,shuffled:!0});this.Rage=new Up(this,{flag:this.rom.flags.Rage,kill:3,npc:this.rom.npcs.Rage});this.Sabera1=new Up(this,{address:222574,flag:this.rom.flags.Sabera1,
kill:4,npc:this.rom.npcs.SaberaDisguisedAsMesia,shuffled:!0});this.Vampire2=new Up(this,{flag:this.rom.flags.Vampire2,kill:12,npc:this.rom.npcs.Vampire2,shuffled:!0,sword:1});this.Mado1=new Up(this,{address:251936,flag:this.rom.flags.Mado1,kill:5,shuffled:!0});this.Kelbesque2=new Up(this,{flag:this.rom.flags.Kelbesque2,kill:6,npc:this.rom.npcs.Kelbesque2,shuffled:!0});this.Sabera2=new Up(this,{flag:this.rom.flags.Sabera2,kill:7,npc:this.rom.npcs.Sabera2,shuffled:!0});this.Mado2=new Up(this,{flag:this.rom.flags.Mado2,
kill:8,npc:this.rom.npcs.Mado2,shuffled:!0});this.Karmine=new Up(this,{flag:this.rom.flags.Karmine,kill:9,npc:this.rom.npcs.Karmine,shuffled:!0,sword:2});this.Draygon1=new Up(this,{flag:this.rom.flags.Draygon1,kill:10,npc:this.rom.npcs.Draygon,shuffled:!0,sword:2});this.StatueOfMoon=new Up(this,{flag:this.rom.flags.UsedBowOfMoon,npc:this.rom.npcs.StatueOfMoon});this.StatueOfSun=new Up(this,{flag:this.rom.flags.UsedBowOfSun,npc:this.rom.npcs.StatueOfSun});this.Draygon2=new Up(this,{flag:this.rom.flags.Draygon2,
kill:11,npc:this.rom.npcs.Draygon});this.Dyna=new Up(this,{kill:13,object:164});this.musics=[new Vp(Yl,42168,[this.Vampire1,this.Vampire2]),new Vp(Yl,42640,[this.Insect]),new Vp(Yl,43419,[this.Kelbesque1,this.Kelbesque2]),new Vp(Yl,44209,[this.Sabera1,this.Sabera2]),new Vp(Yl,44559,[this.Mado1,this.Mado2]),new Vp(Yl,44931,[this.Karmine]),new Vp(Yl,45447,[this.Draygon1]),new Vp(Yl,45841,[this.Draygon2]),new Vp(Zl,48176,[this.Dyna])];this.all=[];for(const b in this)this.hasOwnProperty(b)&&(a=this[b],
a instanceof Up&&(a.name=Hd(b),this.all.push(a)))}isBossFlag(a){return(this.flags||(this.flags=(()=>{const a=new Set;for(const b of this.all)null!=b.flag&&a.add(b.flag.id);return a})())).has(a)}fromLocation(a){return this.all.find((b)=>b.location===a)}fromBossKill(a){return this.all.find((b)=>b.kill===a)}fromObject(a){return this.all.find((b)=>b.object===a)}[Symbol.iterator](){return this.all[Symbol.iterator]()}write(){const a=this.rom.assembler();for(const b of this.musics)b.addr.loc(a),a.byte(b.bgm);
return[a.module()]}}class Vp{constructor(a,b,c){this.bosses=c;this.addr=ie.of(a,b);this.bgm=this.addr.read(c[0].bosses.rom.prg)}}
class Up{constructor(a,{flag:b,npc:c,kill:d,shuffled:e,address:f,sword:g=3,object:h}){this.bosses=a;({prg:a}=a.rom);this.flag=b;this.npc=c;this.object=f?a[f]:c?c.data[1]:null!==h&&void 0!==h?h:aa("address, npc, or object is required");this.swordLevel=g;this.shuffled=!!e;this.kill=d;null!=d&&(b=81920+Qd(a,129387+2*d),b=a[b+4],255!==b&&(this.drop=b),this.location=a[129373+d])}};class Wp{constructor(a){this.rom=a;this.values=Id(a.prg,Xp.offset,16)}write(){const a=this.rom.assembler();Xp.loc(a);a.word(...this.values);return[a.module()]}}const Xp=ie.of(z.$1a,35806);const Yp=Symbol(),Zp={assumeFalse:!0},$p={assumeTrue:!0},aq={track:!0},bq={};
class cq{constructor(a,b,c,d){var e;this.flags=a;this.name=b;this.id=c;this.fixed=d.fixed||!1;this.obsolete=d.obsolete;this.logic=null!==(e=d.logic)&&void 0!==e?e:aq}get c(){return this.id}get r(){return[[this.id]]}get debug(){return this.id.toString(16).padStart(3,"0")+" "+this.name}get item(){if(256>this.id||383<this.id)throw Error(`not a slot: ${this.id}`);const a=this.flags.rom.items[this.flags.rom.itemGets[this.flags.rom.slots[this.id&255]].itemId];if(!a)throw Error("no item");return a}}
function U(a){"number"===typeof a&&(a=((a)=>()=>a)(a));return{obsolete:a,[Yp]:!0}}function dq(a,b){b=void 0===b?bq:b;return{id:a,fixed:!0,[Yp]:!0,logic:b}}function V(a){return dq(a,aq)}function eq(a,b){b=void 0===b?bq:b;return{id:a,[Yp]:!0,logic:b}}function W(a,b){b=void 0===b?bq:b;return{name:a,[Yp]:!0,logic:b}}function fq(a,b){b=void 0===b?bq:b;return{name:a,[Yp]:!0,logic:b}}function gq(a){const b=hq.get(a)||1024;hq.set(a,b+1);return{id:b,[Yp]:!0,logic:aq}}const hq=new WeakMap;
class iq{constructor(a){this.rom=a;this[0]=dq(0,Zp);this[1]=dq(1);this[2]=dq(2);this[3]=dq(3);this[4]=dq(4);this[5]=dq(5);this[6]=dq(6);this[7]=dq(7);this[8]=dq(8);this[9]=dq(9);this.UsedWindmillKey=dq(10,aq);this[11]=U(256);this[12]=fq("Leaf villager");this.LeafVillagersRescued=eq(13);this[14]=U((a)=>{var b;return 133===(null===(b=a.trigger)||void 0===b?void 0:b.id)?323:579});this.WokeWindmillGuard=eq(15,aq);this.TurnedInKirisaPlant=eq(16);this[17]=W("Welcomed to Amazones");this[18]=W("Treasure hunter dead");
this[19]=U(312);this[22]=W("Portoa queen Rage hint");this[23]=U(258);this.EnteredUndergroundChannel=eq(24,aq);this[25]=fq("Portoa queen tired of talking");this[26]=W("Initial talk with Portoa queen");this.MesiaRecording=eq(27,aq);this[28]=U(272);this.TalkedToFortuneTeller=eq(29,aq);this.QueenRevealed=eq(30,aq);this[31]=U(265);this.QueenNotInThroneRoom=eq(32);this.ReturnedFogLamp=eq(33,aq);this[34]=W("Sahara elder");this[35]=W("Sahara elder daughter");this[36]=U(317);this[37]=U(310);this[38]=U(765);
this.ShyronMassacre=dq(39,aq);this.ChangeWoman=dq(40);this.ChangeAkahana=dq(41);this.ChangeSoldier=dq(42);this.ChangeStom=dq(43);this[45]=W("Shyron sages");this[46]=U(301);this.UsedBowOfTruth=dq(47);this[49]=W("Zombie town");this[50]=U(311);this[52]=W("Akahana in waterfall cave");this.CuredAkahana=eq(53,aq);this[54]=W("Akahana Shyron");this[55]=U(322);this.LeafAbduction=eq(56,aq);this[57]=U(321);this.TalkedToZebuInCave=eq(58,aq);this.TalkedToZebuInShyron=eq(59,aq);this[60]=U(315);this[61]=W("Asina in Shyron temple");
this.FoundKensuInDanceHall=eq(62,aq);this[63]=U((a)=>{var b;return 186===(null===(b=a.trigger)||void 0===b?void 0:b.id)?580:324});this[64]=W("Tornel in Shyron temple");this[65]=U(263);this[68]=U(263);this.RescuedChild=dq(69,aq);this.UsedInsectFlute=dq(70);this.RescuedLeafElder=eq(71);this[72]=W("Treasure hunter embarked");this[73]=U(257);this[74]=W("Boat owner");this[75]=fq("Shyron sick men");this[76]=fq("Shyron training men 1");this[77]=fq("Shyron training men 2");this[78]=U(262);this[79]=U(299);
this.GivenStatueToAkahana=eq(80);this[81]=U(326);this.TalkedToDwarfMother=eq(82,aq);this.LeadingChild=dq(83,aq);this[85]=W("Zebu rescued");this[86]=W("Tornel rescued");this[87]=W("Asina rescued");this.MtSabreGuardsDespawned=eq(91,$p);this[94]=U(653);this[95]=U(515);this.TalkedToStomInSwan=eq(97,aq);this[98]=U(337);this[99]=U(327);this.CuredKensu=eq(101,aq);this[103]=U(267);this[104]=U(260);this.StonedPeopleCured=eq(106,aq);this[108]=U(284);this.CurrentlyRidingDolphin=dq(-111,aq);this.ParalyzedKensuInTavern=
dq(112);this.ParalyzedKensuInDanceHall=dq(113);this.FoundKensuInTavern=eq(114,aq);this[115]=W("Startled man in Leaf");this[117]=U(313);this[118]=W("Kensu in Goa");this[119]=U(264);this[120]=U(268);this[121]=U(320);this[122]=U(266);this[123]=U(265);this[125]=U(319);this[126]=W("Mt Sabre guards 1");this[127]=W("Mt Sabre guards 2");this.AlarmFluteUsedOnce=dq(118);this.FluteOfLimeUsedOnce=dq(119);this[130]=U(320);this[131]=W("Rescued Leaf elder");this.LeafVillagersCurrentlyAbducted=eq(132);this.LeafElderCurrentlyAbducted=
eq(133);this[135]=U(261);this[136]=U(306);this[137]=W("Dead Stom's girlfriend");this[138]=W("Dead Stom");this[139]=U(566);this[141]=U(311);this[143]=U(643);this[144]=W("Stoned people gone");this[146]=U(296);this[150]=fq("Leaf elder daughter");this[151]=fq("Leaf villager");this[152]=W("Nadare villager");this.AbleToRideDolphin=eq(155,aq);this.PortoaQueenGoingAway=eq(156);this[160]=U(295);this[163]=fq("Portoa queen/fortune teller");this.WokeKensuInLighthouse=eq(164,aq);this[165]=U(305);this[166]=W("Oak elder 1");
this[167]=fq("Swan dancer");this[168]=W("Oak elder 2");this.TalkedToLeafRabbit=eq(169,aq);this[170]=U(285);this[171]=U(336);this[173]=U(338);this[174]=U(339);this[175]=U(340);this[176]=U(341);this[177]=U(342);this[178]=U(343);this[179]=U(344);this[180]=U(345);this[181]=U(346);this[182]=U(287);this[183]=U(348);this[184]=U(349);this[185]=U(286);this[186]=U(350);this[187]=U(351);this[188]=U(352);this[189]=U(288);this[190]=U(289);this[191]=U(354);this[192]=U(355);this[193]=U(356);this[194]=U(290);this[195]=
U(357);this[196]=U(358);this[197]=U(363);this[198]=U(364);this[199]=U(291);this[200]=U(292);this[201]=U(362);this[202]=U(317);this[203]=U(298);this[204]=U(284);this[205]=U(276);this[206]=U(293);this[207]=U(307);this[208]=U(296);this[209]=U(309);this[210]=U(361);this[211]=U(294);this[212]=U(347);this[213]=fq("Portoa queen 1");this[214]=fq("Portoa queen 2");this[215]=fq("Portoa queen 3");this[216]=W("Kensu rescued");this[217]=fq("Stoned pair");this[218]=W("Kensu gone from tavern");this[219]=fq("In Sabera's trap");
this[220]=U(367);this[221]=U(368);this[222]=U(300);this[223]=U(283);this[224]=W("Dead Akahana");this[228]=U(316);this[229]=U(366);this[230]=U(365);this[231]=U(303);this[232]=W("Dead Shyron villager");this[233]=W("Dead Shyron guard");this[234]=W("Tower message 1");this[235]=W("Tower message 2");this[236]=W("Tower message 3");this[237]=W("Mesia");this.TalkedToZebuStudent=eq(238,aq);this[256]=U(302);this[257]=U(263);this[258]=U(264);this[259]=U(265);this[261]=U(294);this[262]=U(291);this[263]=U(274);
this[264]=U(317);this.UsedBowOfMoon=eq(265);this.UsedBowOfSun=eq(266);this[267]=U(284);this[268]=U(353);this.LeafElder=V(-257);this.OakElder=V(-258);this.WaterfallCaveSwordOfWaterChest=V(-259);this.StxyLeftUpperSwordOfThunderChest=V(-260);this.MesiaInTower=V(260);this.SealedCaveBallOfWindChest=V(-262);this.MtSabreWestTornadoBraceletChest=V(-263);this.GiantInsect=V(-264);this.Kelbesque1=V(-265);this.Rage=V(-266);this.AryllisBasementChest=V(-267);this.Mado1=V(-268);this.StormBraceletChest=V(-269);this.WaterfallCaveRiverLeftChest=
V(272);this.Mado2=V(274);this.StxyRightMiddleChest=V(276);this.BattleArmorChest=V(283);this.Draygon1=V(284);this.SealedCaveSmallRoomBackChest=V(285);this.SealedCaveBigRoomNortheastChest=V(286);this.FogLampCaveFrontChest=V(287);this.MtHydraRightChest=V(288);this.SaberaUpstairsLeftChest=V(289);this.EvilSpiritIslandLowerChest=V(290);this.Sabera2=V(291);this.SealedCaveSmallRoomFrontChest=V(292);this.CordelGrass=V(293);this.Kelbesque2=V(294);this.OakMother=V(295);this.PortoaQueen=V(296);this.AkahanaStatueOfOnyxTradein=
V(297);this.OasisCaveFortressBasementChest=V(298);this.Brokahana=V(299);this.EvilSpiritIslandRiverLeftChest=V(300);this.Deo=V(301);this.Vampire1=V(302);this.OasisCaveNorthwestChest=V(303);this.AkahanaFluteOfLimeTradein=V(304);this.ZebuStudent=V(305);this.WindmillGuardAlarmFluteTradein=V(306);this.MtSabreNorthBackOfPrisonChest=V(307);this.ZebuInShyron=V(308);this.FogLampCaveBackChest=V(309);this.InjuredDolphin=V(310);this.Clark=V(311);this.Sabera1=V(312);this.KensuInLighthouse=V(313);this.RepairedStatue=
V(314);this.UndergroundChannelUnderwaterChest=V(315);this.KirisaMeadow=V(316);this.Karmine=V(317);this.Aryllis=V(318);this.MtHydraSummitChest=V(319);this.AztecaInPyramid=V(320);this.ZebuAtWindmill=V(321);this.MtSabreNorthSummit=V(322);this.StomFightReward=V(323);this.MtSabreWestTornel=V(324);this.AsinaInBackRoom=V(325);this.BehindWhirlpool=V(326);this.KensuInSwan=V(327);this.SlimedKensu=V(328);this.SealedCaveBigRoomSouthwestChest=V(336);this.MtSabreWestRightChest=V(338);this.MtSabreNorthMiddleChest=
V(339);this.FortressMadoHellwayChest=V(340);this.SaberaUpstairsRightChest=V(341);this.MtHydraFarLeftChest=V(342);this.StxyLeftLowerChest=V(343);this.KarmineBasementLowerMiddleChest=V(344);this.EastCaveNortheastChest=V(345);this.OasisCaveEntranceAcrossRiverChest=V(346);this.EvilSpiritIslandExitChest=V(348);this.FortressSaberaMiddleChest=V(349);this.MtSabreNorthUnderBridgeChest=V(350);this.KirisaPlantCaveChest=V(351);this.FortressMadoUpperNorthChest=V(352);this.Vampire2=V(353);this.FortressSaberaNorthwestChest=
V(354);this.FortressMadoLowerCenterNorthChest=V(355);this.OasisCaveNearEntranceChest=V(356);this.MtHydraLeftRightChest=V(357);this.FortressSaberaSoutheastChest=V(358);this.KensuInCabin=V(359);this.MtSabreWestNearKensuChest=V(361);this.MtSabreWestLeftChest=V(362);this.FortressMadoUpperBehindWallChest=V(363);this.PyramidChest=V(364);this.CryptRightChest=V(365);this.KarmineBasementLowerLeftChest=V(366);this.FortressMadoLowerSoutheastChest=V(367);this.FogLampCaveMiddleNorthMimic=V(368);this.FogLampCaveMiddleSouthwestMimic=
V(369);this.WaterfallCaveFrontMimic=V(370);this.EvilSpiritIslandRiverRightMimic=V(371);this.MtHydraFinalCaveMimic=V(372);this.StxyLeftNorthMimic=V(373);this.StxyRightNorthMimic=V(374);this.StxyRightSouthMimic=V(375);this.CryptLeftPitMimic=V(376);this.KarmineBasementUpperMiddleMimic=V(377);this.KarmineBasementUpperRightMimic=V(378);this.KarmineBasementLowerRightMimic=V(379);this.SwordOfWind=V(512);this.SwordOfFire=V(513);this.SwordOfWater=V(514);this.SwordOfThunder=V(515);this.Crystalis=V(516);this.BallOfWind=
V(517);this.TornadoBracelet=V(518);this.BallOfFire=V(519);this.FlameBracelet=V(520);this.BallOfWater=V(521);this.BlizzardBracelet=V(522);this.BallOfThunder=V(523);this.StormBracelet=V(524);this.CarapaceShield=V(525);this.BronzeShield=V(526);this.PlatinumShield=V(527);this.MirroredShield=V(528);this.CeramicShield=V(529);this.SacredShield=V(530);this.BattleShield=V(531);this.PsychoShield=V(532);this.TannedHide=V(533);this.LeatherArmor=V(534);this.BronzeArmor=V(535);this.PlatinumArmor=V(536);this.SoldierSuit=
V(537);this.CeramicSuit=V(538);this.BattleArmor=V(539);this.PsychoArmor=V(540);this.MedicalHerb=V(541);this.Antidote=V(542);this.LysisPlant=V(543);this.FruitOfLime=V(544);this.FruitOfPower=V(545);this.MagicRing=V(546);this.FruitOfRepun=V(547);this.WarpBoots=V(548);this.StatueOfOnyx=V(549);this.OpelStatue=V(550);this.InsectFlute=V(551);this.FluteOfLime=V(552);this.GasMask=V(553);this.PowerRing=V(554);this.WarriorRing=V(555);this.IronNecklace=V(556);this.DeosPendant=V(557);this.RabbitBoots=V(558);this.LeatherBoots=
V(559);this.ShieldRing=V(560);this.AlarmFlute=V(561);this.WindmillKey=V(562);this.KeyToPrison=V(563);this.KeyToStxy=V(564);this.FogLamp=V(565);this.ShellFlute=V(566);this.EyeGlasses=V(567);this.BrokenStatue=V(568);this.GlowingLamp=V(569);this.StatueOfGold=V(570);this.LovePendant=V(571);this.KirisaPlant=V(572);this.IvoryStatue=V(573);this.BowOfMoon=V(574);this.BowOfSun=V(575);this.BowOfTruth=V(576);this.Refresh=V(577);this.Paralysis=V(578);this.Telepathy=V(579);this.Teleport=V(580);this.Recover=V(581);
this.Barrier=V(582);this.Change=V(583);this.Flight=V(584);this.CalmedAngrySea=V(643);this.OpenedJoelShed=V(647);this.Draygon2=V(653);this.OpenedCrypt=V(654);this.OpenedStxy=V(688);this.OpenedSwanGate=V(691);this.OpenedPrison=V(728);this.OpenedSealedCave=V(750);this.AlwaysTrue=dq(752,$p);this.WarpLeaf=V(757);this.WarpBrynmaer=V(758);this.WarpOak=V(759);this.WarpNadare=V(760);this.WarpPortoa=V(761);this.WarpAmazones=V(762);this.WarpJoel=V(763);this.WarpZombie=V(-764);this.WarpSwan=V(764);this.WarpShyron=
V(765);this.WarpGoa=V(766);this.WarpSahara=V(767);this.Sword=gq(this);this.Money=gq(this);this.BreakStone=gq(this);this.BreakIce=gq(this);this.FormBridge=gq(this);this.BreakIron=gq(this);this.TravelSwamp=gq(this);this.ClimbWaterfall=gq(this);this.BuyHealing=gq(this);this.BuyWarp=gq(this);this.ShootingStatue=gq(this);this.ClimbSlope8=gq(this);this.ClimbSlope9=gq(this);this.WildWarp=gq(this);this.unallocated=new Map;for(var b in this){if(!this.hasOwnProperty(b))continue;var c=this[b];if(!c[Yp])continue;
var d=Number(b);const a="number"===typeof c.id?c.id:d;if(isNaN(a))throw Error(`Bad flag: ${b}`);d=c.name||(isNaN(d)?Hd(b):"Flag "+a.toString(16).padStart(3,"0"));c=new cq(this,d,a,c);this[b]=c;0>c.id?this.unallocated.set(~c.id,c):this[c.id]||(this[c.id]=c)}for(b=256;384>b;b++)c=`Check ${w(b&255)}`,this[b]?this[b].fixed||this.unallocated.has(b)||this.unallocated.set(b,new cq(this,c,~b,{fixed:!0})):this[b]=new cq(this,c,b,{fixed:!0});for(b=384;640>b;b++)this[b]||(this[b]=new cq(this,(512>b?"Buffer ":
"Item ")+w(b),b,{fixed:!0}));for(const b of a.locations)for(const a of b.flags)this[a.flag]||(this[a.flag]=jq(this,a.flag))}defrag(){function a(a){return()=>a}var b=new Map,c=new Set;for(var d=0;768>d;d++){const a=this[d],e=null===a||void 0===a?void 0:a.obsolete;e?(b.set(d,(b)=>b.set?-1:e.call(a,b)),delete this[d]):a||c.add(d)}d=0;let e=767;for(;d<e;){if(this[d]||this.unallocated.has(d)){d++;continue}const c=this[e];c&&!c.fixed&&(b.set(e,a(d)),c.id=d,this[d]=c,delete this[e],d++);e--}this.remapFlags(b,
c);for(const a of this.unallocated){const [b,c]=a;this[b]||(this.unallocated.delete(b),(this[b]=c).id=b)}b=[];for(c=0;768>c;c++)this[c]||b.push(c.toString(16).padStart(3,"0"));console.log(`Free flags: ${b.join(" ")}`)}insertZombieWarpFlag(){const a=new Map;if(this[756])throw Error("No space to insert warp flag");const b=~this.WarpZombie.id;if(0>b)throw Error("Bad WarpZombie id");for(let c=756;c<b;c++)this[c]=this[c+1],this[c].id=c,a.set(c+1,()=>c);this.WarpZombie.id=b;this[b]=this.WarpZombie;this.remapFlags(a)}remap(a,
b){this.remapFlags(new Map([[a,()=>b]]))}remapFlags(a,b){function c(c,d){for(let f=c.length-1;0<=f;f--){var e=c[f];0>e&&(e=~e);if(b&&b.has(e))throw Error(`SHOULD BE UNUSED: ${w(e)}`);e=a.get(e);null!=e&&(e=e(Object.assign({},d,{index:f})),0<=e?c[f]=0>c[f]?~e:e:c.splice(f,1))}}function d(c,d){var e=0>c?~c:c;if(b&&b.has(e))throw Error(`SHOULD BE UNUSED: ${w(e)}`);e=a.get(e);if(null==e)return c;d=e(d);if(0>d)throw Error("Bad flag delete");return 0>c?~d:d}for(var e of this.rom.locations)if(e.used)for(const a of e.flags)a.flag=
d(a.flag,{location:e});for(const a of this.rom.npcs)if(a.used){for(const b of a.spawnConditions){const [d,e]=b;c(e,{npc:a,spawn:d})}for(const b of a.globalDialogs)b.condition=d(b.condition,{npc:a,dialog:!0});for(const b of a.localDialogs){[,e]=b;for(const b of e)b.condition=d(b.condition,{npc:a,dialog:!0}),c(b.flags,{npc:a,dialog:!0,set:!0})}}for(const a of this.rom.triggers)a.used&&(c(a.conditions,{trigger:a}),c(a.flags,{trigger:a,set:!0}));for(const a of this.rom.itemGets)c(a.flags,{set:!0});for(const a of this.rom.items)for(const b of a.itemUseData)"flag"===
b.kind&&(b.want=d(b.want,{})),c(b.flags,{set:!0})}alloc(a){if(512!==(void 0===a?0:a))throw Error("Cannot allocate outside 2xx");for(a=640;768>a;)return this[a]||(this[a]=jq(this,a)),a;throw Error("No free flags.");}free(a){delete this[a]}}function jq(a,b){return new cq(a,"Wall "+w(b&255),b,{fixed:!0})};class kq extends mg{constructor(a,b){super(a,b);this.coordinates=Id(a.prg,this.base,4)}get base(){return 218769+(this.id<<2)}get w(){return this.coordinates[1]}set w(a){this.coordinates[1]=a}get x0(){return Jd(this.coordinates[0])}set x0(a){this.coordinates[0]=0>a?a+256:a}get x1(){return this.x0+this.w}get h(){return this.coordinates[3]}set h(a){this.coordinates[3]=a}get y0(){return Jd(this.coordinates[2])}set y0(a){this.coordinates[2]=0>a?a+256:a}get y1(){return this.y0+this.h}write(){const a=this.rom.assembler();
a.segment("1a");a.org(38545+(this.id<<2));a.byte(...this.coordinates);return[a.module()]}};const {$0e:lq,$0f:mq,$14:nq,$fe:oq,$ff:pq}=z,qq=ie.of(lq,39680),rq=ie.of(lq,40294);
class sq extends ng{constructor(a){super(113);this.rom=a;this.actionGrants=new Map;for(let b=0;113>b;b++)this[b]=new tq(a,b);this.actionGrants.set(37,41);this.actionGrants.set(57,58);this.actionGrants.set(59,71);this.actionGrants.set(60,62);this.actionGrants.set(132,70);this.actionGrants.set(178,66);this.actionGrants.set(180,65)}write(){const a=this.rom.assembler();for(const b of this)b.assemble(a);ke(a,[nq,oq,pq],"GrantItemTable");for(const [b,c]of this.actionGrants)a.byte(b,c);return[a.module()]}}
class tq extends mg{constructor(a,b){super(a,b);this._itemId=this.itemPointer.read(a.prg);const c=this.tablePointer.readAddress(a.prg,lq,mq);let d=c.offset;this.inventoryRowStart=a.prg[d++];this.inventoryRowLength=a.prg[d++];this.acquisitionAction=x.from(a.prg,d);this.flags=ae.read(a.prg,d+2);this.key=254===a.prg[d+2+2*this.flags.length+1];0!==b&&c.org===Qd(a.prg,122214)&&(this.key=!1,this.flags=[])}get itemPointer(){return rq.plus(this.id)}get tablePointer(){return qq.plus(this.id<<1)}get itemId(){return this._itemId}set itemId(a){if(73>
this.id)throw Error(`${this.id}`);this._itemId=a}isLosable(){return uq.has(this.inventoryRowStart)}copyFrom(a){this.inventoryRowStart=a.inventoryRowStart;this.inventoryRowLength=a.inventoryRowLength;this.acquisitionAction=a.acquisitionAction;this.flags=[...a.flags];this.key=a.key}assemble(a){this.itemPointer.loc(a);a.byte(this.itemId);const b=[this.inventoryRowStart,this.inventoryRowLength,...this.acquisitionAction.data,...ae.bytes(this.flags),this.key?254:255];a.segment(lq.name,mq.name);a.reloc(`ItemGetData ${w(this.id)}`);
const c=a.pc();a.byte(...b);this.tablePointer.loc(a);a.word(c)}}const uq=new Set([4,8,16]);const {$14:vq,$15:wq,$16_a:xq,$17:yq}=z,zq=new Map([[6,"{}"],[7,"[]"]]);
class Aq{constructor(a,b,c,d,e){this.messages=a;this.part=b;this.id=c;this.bytes=[];this.hex="";a=a.rom.prg;b=[];for(c=d;d&&a[c];c++){const f=a[c];this.bytes.push(f);if(1===f){if(c!==d&&3!==a[c-1])throw Error(`Unexpected start message signal at ${c.toString(16)}`);}else if(2===f)b.push("\n ");else if(3===f)b.push(`${Bq.CONTINUED}\n`);else if(4===f)b.push("{:HERO:}");else if(8===f)b.push("[:ITEM:]");else if(5<=f&&9>=f){const d=a[++c];this.bytes.push(d);if(9===f){b.push(" ".repeat(d));continue}const h=
zq.get(f);h&&(b.push(h[0]),b.push(d.toString(16).padStart(2,"0")),b.push(":"));b.push(e(d,f));h&&b.push(h[1]);Cq[String.fromCharCode(a[c+1])]||b.push(" ")}else if(128<=f)b.push(e(f,0)),Cq[String.fromCharCode(a[c+1])]||b.push(" ");else if(32<=f)b.push(String.fromCharCode(f));else throw Error(`Non-exhaustive switch: ${f} at ${c.toString(16)}`);}this.text=b.join("")}get mid(){return`${w(this.part)}:${w(this.id)}`}fixText(){function a(a,b=a.length){29<f+b&&c();" "===a?(d.push(...h," "),h=[]):/^[[{]:/.test(a)?
h.push({toString:()=>a,length:b}):h.push(a);f+=b;g=a.endsWith(" ")}function b(b){b=b.split(/\s+/);for(let c=0;c<b.length;c++)c&&(g||a(" "),g=!0),a(b[c])}function c(){f=1+h.reduce((a,b)=>a+b.length,0);3<++e?(d.push("#\n "),e=0):d.push("\n ");g=!0}if(!this.checkText()){var d=[],e=0,f=0,g=!1,h=[],k=new Map;for(var p=0;p<this.text.length;p++){var m=this.text[p],u=this.text[p+1];/[\s\n#]/.test(m)?(g||a(" "),g=!0):"{"===m?(":"===u?a("{:HERO:}",6):(m=this.text.indexOf(":",p),m=Number.parseInt(this.text.substring(p+
1,m),16),u=this.messages.extraWords[6][m],k.set(u,`{${m.toString(16)}:${u}}`),b(u)),p=this.text.indexOf("}",p)):"["===m?(":"===u?a("[:ITEM:]",Math.max(...this.messages.rom.items.map((a)=>a.messageName.length))):(m=this.text.indexOf(":",p),m=Number.parseInt(this.text.substring(p+1,m),16),u=this.messages.rom.items[m].messageName,k.set(u,`[${m.toString(16)}:${u}]`),b(u)),p=this.text.indexOf("]",p)):a(m)}d.push(...h);p=d.join("");for(const [a,b]of k)p.includes(a)&&(p=p.split(a).join(b));this.text=p}}checkText(){let a=
0,b=0;for(let d=0;d<this.text.length;d++){const e=this.text[d];var c=this.text[d+1];if("\n"===e){if(a++,b=1,3<a)return!1}else if("#"===e)"\n"===c&&d++,a=b=0;else if("{"===e||"["===e){if(":"===c){if(b="{"===e?b+6:b+Math.max(...this.messages.rom.items.map((a)=>a.messageName.length)),28<b)return!1}else c=this.text.indexOf(":",d),c=Number.parseInt(this.text.substring(d+1,c),16),b+=("{"===e?this.messages.extraWords[6][c]:this.messages.rom.items[c].messageName).length;d=this.text.indexOf(Dq[e],d)}else b++;
if(29<b&&" "!==e)return!1}return!0}}const Cq={"\x00":!0," ":!0,"!":!0,"'":!0,",":!0,".":!0,":":!0,";":!0,"?":!0,_:!0,"\n":!0,"#":!0},Eq=ie.of(vq,34564),Fq=ie.of(vq,34442),Gq=ie.of(vq,34517),Hq=ie.of(vq,34537),Iq=ie.of(vq,34697),Jq=ie.of(vq,34113),Kq=ie.of(vq,34380),Lq=ie.of(vq,34124),Mq={21:wq,22:xq,23:yq};
class Bq{constructor(a){this.rom=a;this.partCount=34;this.commonWords=[];this.uncommonWords=[];this.personNames=[];this.itemNames=[];this.parts=[];const b=Eq.readAddress(a.prg);var c=Fq.readAddress(a.prg),d=Gq.readAddress(a.prg),e=Hq.readAddress(a.prg),f=Jq.readAddress(a.prg);const g=Lq.readAddress(a.prg),h={5:c,6:d,7:e};this.extraWords={5:this.uncommonWords,6:this.personNames,7:this.itemNames};const k=(b,c,d)=>{let e=b[d];if(null!=e)return e;e=Rd(a.prg,c.plus(2*d).readAddress(a.prg).offset);return b[d]=
e};c=(a,c)=>c?k(this.extraWords[c],h[c],a):k(this.commonWords,b,a-128);for(d=0;73>d;d++)c(d,7);f=f.offset;this.banks=Id(a.prg,f,this.partCount);for(d=this.partCount-1;0<=d;d--){e=g.plus(2*d).readAddress(a.prg);const b=f-e.offset>>>1;f=e.offset;const h=Mq[this.banks[d]],k=this.parts[d]=[];for(let f=0;f<b;f++){const b=e.plus(2*f).readAddress(a.prg,h);k[f]=new Aq(this,d,f,b.offset,c)}}}*messages(a){for(const b of this.parts)if(a)for(const c of b)a.has(c.mid)&&(yield c);else yield*b}uses(){function a(a,
c){a="string"===typeof a?a:a.mid;const d=b.get(a)||new Set;d.add(c);b.set(a,d)}const b=new Map;for(var c of this.rom.triggers)c.message.nonzero()&&a(c.message,`Trigger $${w(c.id)}`);for(const b of this.rom.items)for(const c of b.itemUseMessages())c.nonzero()&&a(c,`Item $${w(b.id)}`);for(const b of this.rom.npcs){for(const c of b.globalDialogs)a(c.message,`NPC $${w(b.id)}`);for(const [d,f]of b.localDialogs){c=0<=d?` @ $${w(d)}`:"";for(const d of f)a(d.message,`NPC $${w(b.id)}${c}`)}}for(const b of this.rom.telepathy.sages){for(const c of b.defaultMessages)a(c,
`Telepathy ${b.sage}`);for(const c of b.messageGroups)for(const [,...d]of c.messages)for(const c of d)a(c,`Telepathy ${b.sage}`)}for(const b of Nq)a(b,"Hardcoded");return b}buildAbbreviationTable(a=this.uses()){const b=[];var c=new Map;const d=new Map;for(var e of this.messages(a)){e.fixText();a=e.mid;var f=c.get(e.text);if(f=null!=f&&d.get(f))f.push(a);else{c.set(e.text,a);d.set(a,[]);f=e.text;var g=[];for(let c=0,d=f.length;c<=d;c++){var h=f[c],k=Dq[h];if(Cq[h]||k||c===d){var p=f[c+1];k&&(c=Math.max(c,
f.indexOf(k,c)));if(g.length){k=" "!==h&&"'"!==h||!p||Cq[p]?"":h;p=g.join("");var m=b.length;h=p.length+(" "===h?1:0);g=[];b.push({str:p,id:m,chain:k,bytes:h,used:0,suffixes:new Set,mid:a})}}else g.push(h)}}}c=new Map;for(e=b.length-1;0<=e;e--)for(a=b[e],f=a.bytes-2;0<=f;f--)for(g=a.str.substring(f),h=0,k=a,p=a.bytes-f-1;;){(m=c.get(g))||c.set(g,m={chains:h,missing:f,saving:-g.length,str:g,words:new Set});m.words.add(e);m.saving+=p;for(let a=h;0<=a;a--)b[e+a].suffixes.add(m);if(!k.chain)break;g+=
k.chain;k=b[e+ ++h];g+=k.str;p+=k.bytes}e=new Set;a=[];f=({saving:a},{saving:b})=>b-a;g=[...c.values()].sort(f);for(h=0;g.length&&1250>h;){e.has(g[0].str)&&(g.sort(f),e.clear());const {str:u,saving:y,missing:G,words:A,chains:T}=g.shift();if(0>=y)break;h+=u.length+3;k=a.length;p=new Set;for(const a of A){m=b[a];for(const a of[m.mid,...d.get(m.mid)||[]])p.add(a)}a.push({bytes:128>k?[k+128]:[5,k-128],mids:p,str:u});for(const a of A)for(k=0;k<=T;k++){p=b[a+k];m=p.bytes-(k?0:G);for(const a of p.suffixes)a.saving-=
m-p.used,e.add(a.str);p.used=m}if(128===a.length){for(const a of c.values())a.saving-=a.words.size;g.sort(f);e.clear()}}return a}compress(){var a=this.uses(),b=this.buildAbbreviationTable(a);const c=new Map;this.commonWords.splice(0,this.commonWords.length);this.uncommonWords.splice(0,this.uncommonWords.length);for(var d of b){1===d.bytes.length?this.commonWords[d.bytes[0]&127]=d.str:this.extraWords[d.bytes[0]][d.bytes[1]]=d.str;for(var e of d.mids)(b=c.get(e))||c.set(e,b=[]),b.push(d)}for(var f of c.values())f.sort(({str:{length:a}},
{str:{length:b}})=>b-a);for(const g of this.messages(a)){a=g.text;a=a.replace(/([\[{])([^\]}]*)[\]}](.|$)/g,(a,b,c,d)=>{if(d&&!Cq[d])return a;" "===d&&(d="");if("["===b&&":ITEM:"===c)return`[8]${d}`;if("{"===b&&":HERO:"===c)return`[4]${d}`;c=/^([0-9a-f]+):/.exec(c);if(!c)throw Error(`Bad message text: ${a}`);a=Number.parseInt(c[1],16);return`[${"{"===b?6:7}][${a}]${d}`});for(const {str:b,bytes:d}of c.get(g.mid)||[])a=a.replace(new RegExp(b+"( [ &0-9]|.|$)","g"),(a,b)=>{if(b&&!Cq[b])return a;" "===
b&&(b="");return d.map((a)=>`[${a}]`).join("")+b});d=["[01]"];e=[];e.push(1);for(let c=0,g=a.length;c<g;c++)if(f=a[c],f===Bq.CONTINUED)e.push(3,1),d.push("[03][01]"),"\n"===a[c+1]&&c++;else if("\n"===f)e.push(2)," "===a[c+1]&&c++,d.push("[02]");else if("["===f){f=a.indexOf("]",c);if(0>=f)throw Error(`bad text: ${a}`);b=Number(a.substring(c+1,f));if(isNaN(b))throw Error(`bad text: ${a}`);e.push(b);d.push(`[${w(b)}]`);c=f}else if(" "===f&&" "===a[c+1]){for(f=c+2;" "===a[f];)f++;e.push(9,f-c);d.push(`[09][${w(f-
c)}]`);c=f-1}else e.push(f.charCodeAt(0)),d.push(f);e.push(0);d.push("[0]");g.bytes=e;g.hex=d.join("")}}write(){function a(a,c,...d){a.loc(b);b.word(c);let e=0;for(const f of d)a.plus(f).loc(b),b.word({op:"+",args:[c,{op:"num",num:++e}]})}const b=this.rom.assembler();je(b,vq,32768,34048);je(b,vq,34080,34088);je(b,vq,34182,34195);je(b,vq,35072,37888);je(b,vq,38533,38662);je(b,vq,40576,40960);je(b,wq,40960,49152);je(b,xq,40960,49152);je(b,yq,40960,48128);var c=v(this.partCount,()=>[]);for(var d=0;d<
this.partCount;d++){var e=c[d];const a=this.parts[d];b.segment(Mq[this.banks[d]].name);for(const c of a)b.reloc(`Message_${c.mid}`),e.push(b.pc()),b.byte(...c.bytes,0)}d=[];b.segment(vq.name);b.reloc("MessagesTable");for(e=0;e<this.partCount;e++)d.push(b.pc()),b.word(...c[e]);c=b.pc();b.byte(...this.banks);b.reloc("MessageParts");e=b.pc();b.word(...d);a(Jq,c);a(Kq,c);a(Lq,e,5);c=[["CommonWords",this.commonWords,[Eq]],["UncommonWords",this.uncommonWords,[Fq]],["PersonNames",this.personNames,[Gq]],
["ItemNames",this.itemNames,[Hq,Iq]]];for(const [e,g,h]of c){c=[];d=0;for(const a of g)a?(b.reloc(`${e}_${w(d++)}`),c.push(b.pc()),b.byte(a,0)):c.push(0);b.reloc(e);d=b.pc();b.word(...c);for(const b of h)a(b,d,5)}return[b.module()]}}Bq.CONTINUED="#";const Dq={"{":"}","[":"]"},Nq=new Set("20:1d 1b:0f 1b:10 1b:11 1b:12 1b:05 1b:06 1b:07 1f:00 13:00 0b:01 20:0c 20:0f 1c:11 0e:05 16:00 16:02 16:04 16:06 20:11 21:00 21:02 21:01 06:00 18:00 18:02 18:04 18:08 1b:03 1b:00 1b:00 1b:04 06:01 10:13 19:05 20:14 20:15 20:17 20:02 20:0d 20:19 20:1a 20:1b 03:01 03:02 10:10 10:11 10:12 0c:04 0c:05 03:03 20:0e 20:13".split(" "));const Oq={empty:1,pit:2,arena:4,spikes:8,wide:16,river:32,bridge:64,wall:128,ramp:256,overpass:512,underpass:1024,whirlpool:2048,"stair:up":65536,"stair:down":131072,portoa1:117440512,portoa2:184549376,portoa3:218103808,lake:234881024,lighthouse:318767104,cabin:352321536,windmill:369098752,altar:419430400,pyramid:436207616,crypt:469762048,manual:1073741824,consolidate:2147483648};
function X(a){if(1!=a.length)throw Error("Bad icon input");a=a[0].split("\n");const b=a.slice(1).map((a)=>a.replace(/^\s*\||\|\s*$/g,""));return{short:/\S/.test(a[0])?a[0][0]:b[1][1],full:[b[0],b[1],b[2]]}}function Pq(a,...b){a=a.split(/\s+/g);a[0]||a.shift();a[a.length-1]||a.pop();if(240!==a.length)throw Error(`Bad screen definition: ${a.length}`);const c=new Map(b);return Uint8Array.from(a,(a)=>{var b;return null!==(b=c.get(a))&&void 0!==b?b:parseInt(a,16)})}
function Qq(a,b){b=void 0===b?2:b;const c=a>>>4,d=a&15;return 1===b?{type:"stair:up",dir:2,entrance:(c<<12)+(14===c?10240:6144)|(d<<4)+8,exits:[a]}:{type:"stair:up",dir:0,entrance:c<<12|(d<<4)+(b<<3),exits:v(b,(b)=>a-16+b)}}
function Rq(a,b){b=void 0===b?2:b;const c=a>>>4,d=a&15;return 1===b?{type:"stair:down",dir:2,entrance:(c<<12)-2048|(d<<4)+8,exits:[a],allowedExits:[a+16,a-16]}:{type:"stair:down",dir:2,entrance:c<<12|3840|(d<<4)+(b<<3),exits:v(b,(b)=>a+16+b),allowedExits:[...v(b,(b)=>a+32+b),...v(b,(b)=>a+b)]}}function Sq(a,b){b=void 0===b?"cave":b;return Object.assign({},Qq(a+16),{type:b})}function Y(a,b){b=void 0===b?"door":b;return Object.assign({},Qq(a,1),{type:b})}
function Tq(a){var {left:b=7,width:c=2,top:d=2,manual:e=!1}=void 0===a?{}:a;return{type:"edge:top",manual:e,dir:0,entrance:d+1<<12|(b<<4)+(c<<3),exits:v(c,(a)=>d<<4|a+b)}}function Uq(a){var {left:b=7,width:c=2,shift:d=0,type:e="edge:bottom",manual:f=!1}=void 0===a?{}:a;return{type:e,manual:f,dir:2,entrance:57088|(b<<4)+(c<<3)+16*d,exits:v(c,(a)=>224|a+b)}}
function Vq(a){var {left:b=7,width:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:bottom",dir:2,entrance:44800|(b<<4)+(c<<3)+16*d,exits:v(c,(a)=>176|a+b)}}function Wq(a){var {top:b=7,height:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:left",dir:1,entrance:(b<<12)+(16*d<<8)+(c<<11)|16,exits:v(c,(a)=>a+b<<4)}}function Xq(a){var {top:b=7,height:c=2,shift:d=0}=void 0===a?{}:a;return{type:"edge:right",dir:3,entrance:(b<<12)+(16*d<<8)+(c<<11)|239,exits:v(c,(a)=>a+b<<4|15)}}
function Yq(a,b){return{type:"seamless:up",dir:0,get entrance(){throw Error("does not make sense");},exits:v(void 0===b?2:b,(b)=>a+b)}}function Zq(a,b){return{type:"seamless:down",dir:2,get entrance(){throw Error("does not make sense");},exits:v(void 0===b?2:b,(b)=>a+b)}};class $q{constructor(a,b,c){var d,e,f;this.rom=a;this.uid=b;this.data=c;this._tilesets=new Set;this.used=!1;this.neighbors=[new n((a)=>this._checkNeighbor(a,0)),new n((a)=>this._checkNeighbor(a,1))];for(const a of Object.values(c.tilesets))a.requires||(this.used=!0);a=0;for(var g of null!==(d=c.feature)&&void 0!==d?d:[])d=Oq[g],null!=d&&(a|=d);for(const b of null!==(e=c.exits)&&void 0!==e?e:[])if("stair:down"===b.type||"stair:up"===b.type)a|=Oq[b.type];this._features=a;this._isEmpty=!!(a&Oq.empty);
this.flag=c.flag;this.connections=c=[[[]],[[]],[[]],[[]]];for(e=0;4>e;e++)for(const a of null!==(f=this.data.connect)&&void 0!==f?f:"")ar[e].includes(a)?c[e].push([]):(g=parseInt(a,16))&&c[e][c[e].length-1].push((g&3)<<(g&4)|(g&8?g&4?256:4096:0))}get features(){return this._features}get manual(){return!!(this._features&br)}get counted(){return!!(this._features&cr)}hasFeature(a){return!!(this._features&Oq[a])}hasFeatures(a){return(this._features&a)===a}withFeature(){throw Error();}isEmpty(){return this._isEmpty}withObstruction(){throw Error();
}isCompatibleWithTileset(a){for(const b of this._tilesets)if(b.tilesetId===a)return!0;return!1}replace(a,b){const {tiles:c}=this.screen;for(let d=0;d<c.length;d++)c[d]===a&&(c[d]=b);return this}remove(){for(const a in this.data.tilesets)this.rom.metatilesets[a].deleteScreen(this)}get sid(){return this.data.id}set sid(a){this.sid!==a&&this.rom.metascreens.renumber(this.sid,a)}get screen(){const {sid:a,rom:{screens:b}}=this;return 0>a?b.unallocated[~a]:b[a]}unsafeSetId(a){this.data.id=a;for(const a of this._tilesets)a.invalidate()}unsafeAddTileset(a){this._tilesets.add(a)}unsafeRemoveTileset(a){this._tilesets.delete(a)}edgeExits(){var a;
let b=0;for(const c of null!==(a=this.data.exits)&&void 0!==a?a:[])a=dr[c.type],null!=a&&(b|=1<<a);return b}edgeIndex(a){var b;let c=0;const d=null!==(b=this.data.edges)&&void 0!==b?b:"";for(b=0;4>b;b++)if(" "!==d[b]){if(d[b]!==a)return;c|=1<<b}return c}findExitType(a,b,c){var d,e;for(const f of null!==(d=this.data.exits)&&void 0!==d?d:[])if(f.type.startsWith("seamless")===c&&(d=b&&"edge:bottom"===f.type&&192<=a?a+32:a,f.exits.includes(d)||(null!==(e=f.allowedExits)&&void 0!==e?e:[]).includes(d)))return f}findEntranceType(a,
b){var c,d;for(const e of null!==(c=this.data.exits)&&void 0!==c?c:[]){if(e.type.startsWith("seamless"))continue;c=b&&"edge:bottom"===e.type&&48896<=a?a+8192:a;const f=(c&240)>>4|(c&61440)>>8;if(e.entrance===c||e.exits.includes(f)||(null!==(d=e.allowedExits)&&void 0!==d?d:[]).includes(f))return e.type}}addCustomFlag(a){this.flag=a?"custom:true":"custom:false"}checkNeighbor(a,b){return(b&2?this:a).neighbors[b&1].get(b&2?a:this)}_checkNeighbor(a,b){const c=this.data.edges;a=a.data.edges;if(c&&a){const d=
b^2;if("*"!==c[d]&&c[d]===a[b])return!0}return!1}}const dr={"edge:top":0,"edge:left":1,"edge:bottom":2,"edge:right":3},ar=["|:","|:=-","|","|="],er=new Set("arena portoa1 portoa2 portoa3 lake overpass underpass lighthouse cabin windmill altar pyramid crypt".split(" ")),fr=new Set("pit spikes bridge wall ramp whirlpool".split(" ")),br=[...er].map((a)=>Oq[a]).reduce((a,b)=>a|b),cr=[...fr].map((a)=>Oq[a]).reduce((a,b)=>a|b);class gr{constructor(a){this.rom=a;this.length=0;this.screensByFix=new n(()=>[]);this.screensById=new n(()=>[]);this.overworldEmpty=this.metascreen({id:0,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"   |   |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryW_trees=this.metascreen({id:1,icon:X`
      |\u2588\u258c |
      |\u2588\u258c^|
      |\u2588\u258c |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},desert:{requires:[K.DesertRocks]},sea:{requires:[K.SeaTrees]}},edges:"> >o"});this.boundaryW=this.metascreen({id:2,icon:X`
      |\u2588\u258c |
      |\u2588\u258c |
      |\u2588\u258c |`,tile:" oo| oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"> >o"});this.boundaryE_rocks=this.metascreen({id:3,icon:X`
      |.\u2590\u2588|
      | \u2590\u2588|
      |.\u2590\u2588|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},desert:{requires:[K.DesertRocks]},sea:{requires:[K.SeaRocks]}},edges:"<o< "});this.boundaryE=this.metascreen({id:4,icon:X`
      | \u2590\u2588|
      | \u2590\u2588|
      | \u2590\u2588|`,tile:"oo |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<o< "});this.longGrassS=this.metascreen({id:5,icon:X`
      |vv |
      | vv|
      |   |`,tile:"olo|ooo|   ",tilesets:{river:{},grass:{requires:[K.GrassLongGrass]}},edges:"looo"});this.longGrassN=this.metascreen({id:6,icon:X`
      |   |
      | vv|
      |vv |`,tile:"   |ooo|olo",tilesets:{river:{},grass:{requires:[K.GrassLongGrass]}},edges:"oolo"});this.boundaryS_rocks=this.metascreen({id:7,icon:X`
      | . |
      |\u2584\u2584\u2584|
      |\u2588\u2588\u2588|`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},desert:{requires:[K.DesertRocks]},sea:{requires:[K.SeaRocks]}},edges:"o^ ^"});this.fortressTownEntrance=this.metascreen({id:8,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2229\u2588|
      |   |`,placement:"manual",tile:["   |oFo|ooo","oo |oFo|ooo"],tilesets:{grass:{}},edges:" vov",exits:[Object.assign({},Qq(166,3),{type:"fortress"})]});this.bendSE_longGrass=this.metascreen({id:9,icon:X`\u2597
      | v |
      |vv\u2584|
      | \u2590\u2588|`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.exitW_cave=this.metascreen({id:10,icon:X`\u2229
      |\u2588\u2229\u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:["   |o< |   ","   |x< |   "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[K.SeaCaveEntrance]}},edges:" n  ",exits:[Sq(72),Wq({top:6})]});this.bendNE_grassRocks=this.metascreen({id:11,icon:X`\u259d
      |.\u2590\u2588|
      |  \u2580|
      |;;;|`,tile:"oo |ooo|ogo",tilesets:{grass:{},river:{requires:[K.RiverShortGrass]},desert:{requires:[K.DesertShortGrass,K.DesertRocks]}},edges:"<osv"});this.cornerNW=this.metascreen({id:12,icon:X`\u259b
      |\u2588\u2588\u2588|
      |\u2588 \u2580|
      |\u2588\u258c |`,tile:"   | oo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"  >v"});this.overworldEmpty_alt=this.metascreen({id:12,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,placement:"manual",tilesets:{grass:{},river:{},sea:{},desert:{}},feature:["empty","manual"],edges:"    ",match:()=>!1,delete:!0});this.cornerNE=this.metascreen({id:13,icon:X`\u259c
      |\u2588\u2588\u2588|
      |\u2580\u2588\u2588|
      | \u2590\u2588|`,tile:"   |oo |oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:" v< "});this.cornerSW=this.metascreen({id:14,icon:X`\u2599
      |\u2588\u258c |
      |\u2588\u2588\u2584|
      |\u2588\u2588\u2588|`,tile:" oo| oo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">  ^"});this.cornerSE=this.metascreen({id:15,icon:X`\u259f
      | \u2590\u2588|
      |\u2584\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"oo |oo |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  "});this.exitE=this.metascreen({id:16,icon:X`\u2576
      | \u2590\u2588|
      |   |
      | \u2590\u2588|`,tile:["oo |ooo|oo ","oo |oox|oo "],tilesets:{grass:{},river:{},desert:{requires:[K.DesertRocks]}},edges:"<o<n",exits:[Xq({top:6})]});this.boundaryN_trees=this.metascreen({id:17,icon:X`
      |\u2588\u2588\u2588|
      |\u2580\u2580\u2580|
      | ^ |`,tile:"   |ooo|ooo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[K.SeaTrees]}},edges:" vov"});this.bridgeToPortoa=this.metascreen({id:18,icon:X`\u2574
      |\u2550  |
      |\u255e\u2550\u2550|
      |\u2502  |`,placement:"manual",tile:"roo|1rr| oo",tilesets:{river:{}},feature:["portoa3"],edges:"2*>r",exits:[Wq({top:1})]});this.slopeAbovePortoa=this.metascreen({id:19,icon:X`
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2580|
      |\u2502  |`,placement:"manual",tile:" \u2193 | oo|roo",tilesets:{river:{}},feature:["portoa2"],edges:"1*2v"});this.riverBendSE=this.metascreen({id:20,icon:X`
      |w  |
      | \u2554\u2550|
      | \u2551 |`,tile:"ooo|orr|oro",tilesets:{river:{}},edges:"oorr"});this.boundaryW_cave=this.metascreen({id:21,icon:X`
      |\u2588\u258c |
      |\u2588\u2229 |
      |\u2588\u258c |`,tile:" oo| <o| oo",tilesets:{grass:{},river:{},desert:{},sea:{requires:[K.SeaCaveEntrance]}},edges:"> >o",exits:[Sq(137)]});this.exitN=this.metascreen({id:22,icon:X`\u2575
      |\u2588 \u2588|
      |\u2580 \u2580|
      | ^ |`,tile:[" o |ooo|ooo"," x |ooo|ooo"],tilesets:{grass:{},river:{},desert:{}},edges:"nvov",exits:[Tq()]});this.riverWE_woodenBridge=this.metascreen({id:23,icon:X`\u2550
      |   |
      |\u2550\u2551\u2550|
      |   |`,tile:"ooo|ror|ooo",tilesets:{river:{}},edges:"oror",exits:[Yq(119),Zq(135)]});this.riverBoundaryE_waterfall=this.metascreen({id:24,icon:X`\u2561
      | \u2590\u2588|
      |\u2550\u2550/|
      | \u2590\u2588|`,tile:"oo |rr |oo ",tilesets:{river:{}},edges:"<r< "});this.boundaryE_cave=this.metascreen({id:25,icon:X`
      | \u2590\u2588|
      |v\u2229\u2588|
      |v\u2590\u2588|`,tile:"oo |o< |oo ",tilesets:{river:{},grass:{requires:[K.GrassLongGrass]},desert:{requires:[K.DesertLongGrass]}},edges:"<o< ",exits:[Sq(88)]});this.exitW_southwest=this.metascreen({id:26,icon:X`\u2574
      |\u2588\u258c |
      |\u2580 \u2584|
      |\u2584\u2588\u2588|`,tile:" oo|Boo|   ",tilesets:{grass:{},river:{},desert:{requires:[K.DesertRocks]},sea:{requires:[K.SeaRocks]}},edges:">* ^",exits:[Wq({top:11})]});this.nadare=this.metascreen({id:27,tilesets:{house:{}},exits:[Vq(),Y(35),Y(37,"door2"),Y(42,"door3")]});this.townExitW=this.metascreen({id:28,icon:X`\u2574
      |\u2588\u258c |
      |\u2580 ^|
      |\u2588\u258c |`,tile:" oo|8oo| oo",tilesets:{grass:{},river:{}},edges:">n>o",exits:[Wq({top:8,height:3,shift:-.5})]});this.shortGrassS=this.metascreen({id:29,icon:X` |
      |;;;|
      | v |
      |   |`,tile:"ogo|ooo|ooo",tilesets:{grass:{},river:{requires:[K.RiverShortGrass,K.GrassLongGrassRemapping]}},edges:"sooo"});this.townExitS=this.metascreen({id:30,icon:X`\u2577
      | ^ |
      |\u2584 \u2584|
      |\u2588 \u2588|`,tile:["ooo|ooo| o ","ooo|ooo| x "],tilesets:{grass:{},river:{},desert:{requires:[K.DesertRocks,K.DesertTownEntrance]}},edges:"o^n^",exits:[Uq()]});this.swanGate=this.metascreen({id:31,tilesets:{town:{}},exits:[Wq({top:3}),Xq({top:9})],flag:"custom:false"});this.riverBranchNSE=this.metascreen({id:32,icon:X`
      | \u2551 |
      | \u2560\u2550|
      | \u2551 |`,tile:"oro|orr|oro",tilesets:{river:{}},edges:"rorr"});this.riverWE=this.metascreen({id:33,icon:X`
      |   |
      |\u2550\u2550\u2550|
      |   |`,tile:"ooo|rrr|ooo",tilesets:{river:{}},edges:"oror"});this.riverBoundaryS_waterfall=this.metascreen({id:34,icon:X`\u2568
      | \u2551 |
      |\u2584\u2551\u2584|
      |\u2588/\u2588|`,tile:"oro|oro|   ",tilesets:{river:{}},edges:"r^ ^"});this.shortGrassSE=this.metascreen({id:35,icon:X`
      |;;;|
      |;  |
      |; ^|`,tile:"ogo|goo|ooo",tilesets:{grass:{}},edges:"ssoo"});this.shortGrassNE=this.metascreen({id:36,icon:X` |
      |;  |
      |;v |
      |;;;|`,tile:"ooo|goo|ogo",tilesets:{grass:{}},edges:"osso"});this.stomHouseOutside=this.metascreen({id:37,icon:X`\u2229
      |\u2588\u2588\u2588|
      |\u258c\u2229\u2590|
      |\u2588 \u2588|`,placement:"manual",tile:["   | H | o ","   | H | x "],tilesets:{grass:{}},exits:[Y(104),Uq({shift:.5})]});this.bendNW_trees=this.metascreen({id:38,icon:X`\u2598
      |\u2588\u258c |
      |\u2580 ^|
      | ^^|`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[K.DesertRocks,K.DesertTrees]},sea:{requires:[K.SeaRocks,K.SeaTrees]}},edges:">voo"});this.shortGrassSW=this.metascreen({id:39,icon:X`
      |;;;|
      |  ;|
      |^ ;|`,tile:"ogo|oog|ooo",tilesets:{grass:{},river:{requires:[K.RiverShortGrass]}},edges:"soos"});this.riverBranchNWS=this.metascreen({id:40,icon:X`
      | \u2551 |
      |\u2550\u2563 |
      | \u2551 |`,tile:"oro|rro|oro",tilesets:{river:{}},edges:"rrro"});this.shortGrassNW=this.metascreen({id:41,icon:X`
      |  ;|
      | v;|
      |;;;|`,tile:"ooo|oog|ogo",tilesets:{grass:{},river:{requires:[K.RiverShortGrass,K.GrassLongGrassRemapping]}},edges:"ooss"});this.valleyBridge=this.metascreen({id:42,icon:X` |
      |\u259b\u2551\u259c|
      | \u2551 |
      |\u2599\u2551\u259f|`,tile:[" o | o | o "," x | o | o "," o | o | x "],tilesets:{grass:{},river:{}},edges:"n n ",exits:[Yq(119),Zq(135),Tq(),Uq()]});this.exitS_cave=this.metascreen({id:43,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u258c \u2590|
      |\u2588 \u2588|`,tile:["   | < | o ","   | < | x "],tilesets:{grass:{},river:{},desert:{},sea:{requires:[K.SeaCaveEntrance]}},edges:"  n ",exits:[Sq(103),Uq()]});this.outsideWindmill=this.metascreen({id:44,icon:X`\u2573
      |\u2588\u2588\u2573|
      |\u2588\u2229\u2588|
      |\u2588 \u2588|`,placement:"manual",tile:["   | W | o ","   | W | x "],tilesets:{grass:{}},flag:"custom:false",feature:["windmill"],edges:"  n ",exits:[Sq(99),Uq(),Y(137,"windmill"),Y(140)]});this.townExitW_cave=this.metascreen({id:45,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u2584\u2584\u2588|
      |\u2588\u2588\u2588|`,tile:"   |x< |   ",tilesets:{grass:{}},edges:" n  ",exits:[Sq(74),Wq({top:5,height:3,shift:-.5})],flag:"custom:true"});this.riverNS=this.metascreen({id:46,icon:X`
      | \u2551 |
      | \u2551 |
      | \u2551 |`,tile:"oro|ooo|oro",tilesets:{river:{}},edges:"roro",mod:"bridge"});this.riverNS_bridge=this.metascreen({id:47,icon:X`
      | \u2551 |
      |w\u254fw|
      | \u2551 |`,placement:"mod",tile:"oro|oro|oro",tilesets:{river:{}},feature:["bridge"],edges:"roro",wall:119});this.riverBendWS=this.metascreen({id:48,icon:X`
      | w\u259c|
      |\u2550\u2557w|
      | \u2551 |`,tile:"oo |rro|oro",tilesets:{river:{}},edges:"<rrv"});this.boundaryN_waterfallCave=this.metascreen({id:49,icon:X`
      |\u259b/\u2588|
      |\u2598\u2551\u2580|
      | \u2551 |`,tile:"   |oro|oro",tilesets:{river:{}},edges:" vrv",exits:[{type:"cave",dir:0,entrance:28767,exits:[102,118]}]});this.open_trees=this.metascreen({id:50,icon:X`
      | ^ |
      |^ ^|
      | ^ |`,tile:"ooo|ooo|ooo",tilesets:{grass:{},river:{},desert:{requires:[K.DesertTrees,K.DesertRocks]}},edges:"oooo"});this.exitS=this.metascreen({id:51,icon:X`\u2577
      | w |
      |\u2584 \u2584|
      |\u2588 \u2588|`,tile:["ooo|ooo| o ","ooo|ooo| x |"],tilesets:{grass:{},river:{},desert:{requires:[K.DesertMarsh]},sea:{requires:[K.SeaMarsh]}},edges:"o^n^",exits:[Uq()]});this.bendNW=this.metascreen({id:52,icon:X`\u2598
      |\u2588\u258c |
      |\u2580\u2580 |
      |   |`,tile:" oo|ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:">voo"});this.bendNE=this.metascreen({id:53,icon:X`\u259d
      | \u2590\u2588|
      |  \u2580|
      |   |`,tile:"oo |ooo|ooo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<oov"});this.bendSE=this.metascreen({id:54,icon:X`\u2597
      |   |
      | \u2584\u2584|
      | \u2590\u2588|`,tile:"ooo|ooo|oo ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"oo<^"});this.bendWS=this.metascreen({id:55,icon:X`\u2596
      |   |
      |\u2584\u2584 |
      |\u2588\u258c |`,tile:"ooo|ooo| oo",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^>o"});this.towerPlain_upStair=this.metascreen({id:56,icon:X`\u2534
      | \u250a |
      |\u2500\u2534\u2500|
      |   |`,tile:" t |ttt|   ",tilesets:{tower:{}},edges:"st t",exits:[Zq(8,2),Tq({left:8})]});this.towerRobotDoor_downStair=this.metascreen({id:57,icon:X`\u252c
      | \u2229 |
      |\u2500\u252c\u2500|
      | \u250a |`,tile:"   |ttt| t ",tilesets:{tower:{}},edges:" tst",exits:[Yq(232,2)]});this.towerDynaDoor=this.metascreen({id:58,icon:X`\u2229
      | \u2229 |
      |\u2514\u252c\u2518|
      | \u250a |`,tile:"   | < | t ",tilesets:{tower:{}},edges:"  s ",exits:[Sq(103,"door")]});this.towerLongStairs=this.metascreen({id:59,icon:X`
      | \u250a |
      | \u250a |
      | \u250a |`,tile:" t | t | t ",tilesets:{tower:{}},edges:"s s ",exits:[Uq()]});this.towerMesiaRoom=this.metascreen({id:60,tilesets:{tower:{}},exits:[Vq()]});this.towerTeleporter=this.metascreen({id:61,tilesets:{tower:{}},exits:[Vq(),Sq(87,"teleporter")]});this.caveAbovePortoa=this.metascreen({id:62,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2229\u2588|
      |\u2588\u2193\u2588|`,placement:"manual",tile:"   | < | \u2193 ",tilesets:{river:{}},edges:"  1 ",feature:["portoa1"],exits:[Sq(102)]});this.cornerNE_flowers=this.metascreen({id:63,icon:X`\u259c
      |\u2588\u2588\u2588|
      |\u2580*\u2588|
      | \u2590\u2588|`,tile:"   |oo |oo ",tilesets:{grass:{}},edges:" v< "});this.towerEdge=this.metascreen({id:64,icon:X` |
      |   |
      |\u2524 \u251c|
      |   |`,tile:"   |t t|   ",tilesets:{tower:{}},edges:" t t"});this.towerEdgeW=this.metascreen({id:64,icon:X` |
      |   |
      |\u2524  |
      |   |`,tile:"   |t  |   ",tilesets:{tower:{}},edges:" t  "});this.towerEdgeE=this.metascreen({id:64,icon:X` |
      |   |
      |  \u251c|
      |   |`,tile:"   |  t|   ",tilesets:{tower:{}},edges:"   t"});this.towerRobotDoor=this.metascreen({id:65,icon:X`\u2500
      | O |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ttt|   ",tilesets:{tower:{}},edges:" t t"});this.towerDoor=this.metascreen({id:66,icon:X`\u2229
      | \u2229 |
      |\u2500\u2534\u2500|
      |   |`,tile:"   |t<t|   ",tilesets:{tower:{}},edges:" t t",exits:[Sq(88)]});this.house_bedroom=this.metascreen({id:67,tilesets:{house:{}},exits:[Vq()]});this.shed=this.metascreen({id:68,tilesets:{house:{}},exits:[Vq(),Sq(73)],flag:"custom:false"});this.tavern=this.metascreen({id:69,tilesets:{house:{}},exits:[Vq()]});this.house_twoBeds=this.metascreen({id:70,tilesets:{house:{}},exits:[Vq()]});this.throneRoom_amazones=this.metascreen({id:71,tilesets:{house:{}},exits:[Vq({width:3}),Rq(76,1)]});
this.house_ruinedUpstairs=this.metascreen({id:72,tilesets:{house:{}},exits:[Vq(),Rq(156,1)]});this.house_ruinedDownstairs=this.metascreen({id:73,tilesets:{house:{}},exits:[Qq(86,1)]});this.foyer=this.metascreen({id:74,tilesets:{house:{}},exits:[Vq({shift:.5}),Y(40),Y(83,"door2"),Y(92,"door3")]});this.throneRoom_portoa=this.metascreen({id:75,tilesets:{house:{}},exits:[Vq(),Y(43)]});this.fortuneTeller=this.metascreen({id:76,tilesets:{house:{}},exits:[Vq(),Y(86),Y(89,"door2")]});this.backRoom=this.metascreen({id:77,
tilesets:{house:{}},exits:[Vq()]});this.dojo=this.metascreen({id:78,tilesets:{house:{}},exits:[Vq({shift:-.5})]});this.windmillInside=this.metascreen({id:79,tilesets:{house:{}},exits:[Vq({left:9,width:1})]});this.horizontalTownMiddle=this.metascreen({id:80,tilesets:{town:{}},exits:[Y(76),Y(85,"door2")]});this.brynmaerRight_exitE=this.metascreen({id:81,tilesets:{town:{type:"horizontal"}},exits:[Xq({top:8}),Y(65)]});this.brynmaerLeft_deadEnd=this.metascreen({id:82,tilesets:{town:{type:"horizontal"}},
exits:[Y(73),Y(76,"door2")]});this.swanLeft_exitW=this.metascreen({id:83,tilesets:{town:{type:"horizontal"}},exits:[Wq({top:9}),Y(73),Y(94,"door2")]});this.swanRight_exitS=this.metascreen({id:84,tilesets:{town:{type:"horizontal"}},exits:[Uq({left:3}),Y(65),Y(67,"door2"),Y(87,"door3")]});this.horizontalTownLeft_exitN=this.metascreen({id:85,tilesets:{town:{type:"horizontal"}},exits:[Tq({left:13}),Y(70),Y(75,"door2")]});this.amazonesRight_deadEnd=this.metascreen({id:86,tilesets:{town:{type:"horizontal"}},
exits:[Y(64),Y(88,"door2")]});this.saharaRight_exitE=this.metascreen({id:87,tilesets:{town:{type:"horizontal"}},exits:[Xq({top:7}),Y(64),Y(102,"door2")]});this.portoaNW=this.metascreen({id:88,tilesets:{town:{type:"square"}},exits:[Sq(71,"fortress"),Uq()]});this.portoaNE=this.metascreen({id:89,tilesets:{town:{type:"square"}},exits:[Y(99),Y(138,"door2"),Uq({left:3,width:4})]});this.portoaSW_exitW=this.metascreen({id:90,tilesets:{town:{type:"square"}},exits:[Wq({top:9}),Y(134),Tq()]});this.portoaSE_exitE=
this.metascreen({id:91,tilesets:{town:{type:"square"}},exits:[Xq({top:9}),Y(122),Y(135,"door2")]});this.dyna=this.metascreen({id:92,tilesets:{tower:{}},exits:[{type:"stair:down",manual:!0,dir:2,entrance:49024,exits:[]}]});this.portoaFisherman=this.metascreen({id:93,tilesets:{town:{type:"square"}},exits:[Xq({top:6}),Wq({top:4,height:6,shift:.5}),Y(104)]});this.verticalTownTop_fortress=this.metascreen({id:94,tilesets:{town:{type:"vertical"}},exits:[Sq(71),Uq()]});this.shyronMiddle=this.metascreen({id:95,
tilesets:{town:{type:"vertical"}},exits:[Y(84),Y(91,"door2"),Tq()]});this.shyronBottom_exitS=this.metascreen({id:96,tilesets:{town:{type:"vertical"}},exits:[Uq({left:3}),Y(4),Y(6,"door2"),Y(153,"door3")]});this.zombieTownMiddle=this.metascreen({id:97,tilesets:{town:{type:"vertical"}},exits:[Y(153),Tq()]});this.zombieTownBottom_caveExit=this.metascreen({id:98,tilesets:{town:{type:"vertical"}},exits:[Sq(146),Y(35),Y(77,"door2")]});this.leafNW_houseShed=this.metascreen({id:99,tilesets:{town:{type:"square"}},
exits:[Y(140),Y(149,"door2")]});this.squareTownNE_house=this.metascreen({id:100,tilesets:{town:{type:"square"}},exits:[Tq({left:1}),Y(183)]});this.leafSW_shops=this.metascreen({id:101,tilesets:{town:{type:"square"}},exits:[Y(119),Y(138,"door2")]});this.leafSE_exitE=this.metascreen({id:102,tilesets:{town:{type:"square"}},exits:[Xq({top:3,height:3,shift:-.5}),Y(132)]});this.goaNW_tavern=this.metascreen({id:103,tilesets:{town:{type:"square"}},exits:[Y(186)]});this.squareTownSW_exitS=this.metascreen({id:104,
tilesets:{town:{type:"square"}},exits:[Uq({left:8}),Y(132)]});this.goaSE_shop=this.metascreen({id:105,tilesets:{town:{type:"square"}},exits:[Y(130)]});this.joelNE_shop=this.metascreen({id:106,tilesets:{town:{type:"square"}},exits:[Y(167)]});this.joelSE_lake=this.metascreen({id:107,tilesets:{town:{type:"square"}}});this.oakNW=this.metascreen({id:108,tilesets:{town:{type:"square"}},exits:[Y(231)]});this.oakNE=this.metascreen({id:109,tilesets:{town:{type:"square"}},exits:[Y(96)]});this.oakSW=this.metascreen({id:110,
tilesets:{town:{type:"square"}},exits:[Y(124)]});this.oakSE=this.metascreen({id:111,tilesets:{town:{type:"square"}},exits:[Uq({left:0,shift:.5}),Y(151)]});this.temple=this.metascreen({id:112,tilesets:{house:{}},exits:[Vq()]});this.wideDeadEndN=this.metascreen({id:113,icon:X`
      | \u2503 |
      | > |
      |   |`,tile:" w | > |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",exits:[Rq(199)],statues:[4]});this.goaWideDeadEndN=this.metascreen({id:113,icon:X`
      |\u2575\u2503\u2575|
      | > |
      |   |`,tile:" w | > |   ",tilesets:{labyrinth:{}},edges:"w   ",connect:"1|2|3",exits:[Rq(199)],statues:[4]});this.wideHallNS=this.metascreen({id:114,icon:X`
      | \u2503 |
      | \u2503 |
      | \u2503 |`,tile:" w | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2a",statues:[1,7,13]});this.goaWideHallNS=this.metascreen({id:114,icon:X`
      |\u2502\u2503\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2503\u2502|`,tile:" w | w | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"19|2a|3b",statues:[1,7,13]});this.goaWideHallNS_blockedRight=this.metascreen({id:114,icon:X`
      |\u2502\u2503\u2502|
      |\u2502\u2503 |
      |\u2502\u2503\u2502|`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[157]}},edges:"w w ",connect:"19|2a|3|b"});this.goaWideHallNS_blockedLeft=this.metascreen({id:114,icon:X`
      |\u2502\u2503\u2502|
      | \u2503\u2502|
      |\u2502\u2503\u2502|`,placement:"mod",tile:" w | w | w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[81]}},edges:"w w ",connect:"1|9|2a|3b"});this.goaWideArena=this.metascreen({id:115,icon:X`<
      |\u257b<\u257b|
      |\u2521\u2501\u2529|
      |\u2502\u257b\u2502|`,placement:"manual",tile:"   | < | w ",tilesets:{labyrinth:{}},feature:["arena"],edges:"w w ",connect:"9b|a",exits:[Qq(55)]});this.limeTreeLake=this.metascreen({id:116,tilesets:{lime:{}},exits:[Vq(),Sq(71)],feature:["bridge"],wall:103});this.swampNW=this.metascreen({id:117,icon:X`
      | \u2502 |
      |\u2500\u2518 |
      |   |`,tile:" c |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss  ",connect:"26",exits:[Tq({left:6,width:4}),Wq({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampE=this.metascreen({id:118,icon:X`
      |   |
      | \u2576\u2500|
      |   |`,tile:"   | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"   s",connect:"e",exits:[],poi:[[0]]});this.swampE_door=this.metascreen({id:118,icon:X`\u2229
      | \u2229 |
      | \u2576\u2500|
      |   |`,tile:"   | <c|   ",tilesets:{swamp:{requires:[K.SwampDoors]}},feature:["consolidate"],flag:"always",edges:"   s",connect:"e",exits:[Sq(92,"swamp")]});this.swampNWSE=this.metascreen({id:119,icon:X`
      | \u2502 |
      |\u2500\u253c\u2500|
      | \u2502 |`,tile:" c |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ssss",connect:"26ae",exits:[Tq({left:6,width:4}),Wq({top:7,height:4,shift:-.5}),Uq({left:6,width:4}),Xq({top:7,height:4,shift:-.5})]});this.swampNWS=this.metascreen({id:120,icon:X`
      | \u2502 |
      |\u2500\u2524 |
      | \u2502 |`,tile:" c |cc | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"sss ",connect:"26a",exits:[Tq({left:6,width:4}),Wq({top:7,height:4,shift:-.5}),Uq({left:6,width:4})]});this.swampNE=this.metascreen({id:121,icon:X`
      | \u2502 |
      | \u2514\u2500|
      |   |`,tile:" c | cc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s  s",connect:"2e",exits:[Tq({left:6,width:4}),Xq({top:7,height:4,shift:-.5})],poi:[[2]]});this.swampWSE=this.metascreen({id:122,icon:X`
      |   |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |ccc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" sss",connect:"6ae",exits:[Wq({top:7,height:4,shift:-.5}),Uq({left:6,width:4}),Xq({top:7,height:4,shift:-.5})]});this.swampWSE_door=this.metascreen({id:122,icon:X`\u2229
      | \u2229 |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |c<c| c ",tilesets:{swamp:{requires:[K.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" sss",connect:"6ae",exits:[Sq(86,"swamp")]});this.swampW=this.metascreen({id:123,icon:X`
      |   |
      |\u2500\u2574 |
      |   |`,tile:"   |cc |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s  ",connect:"6",poi:[[0]]});this.swampW_door=this.metascreen({id:123,icon:X`\u2229
      | \u2229 |
      |\u2500\u2574 |
      |   |`,tile:"   |c< |   ",tilesets:{swamp:{requires:[K.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" s  ",connect:"6",exits:[Sq(84,"swamp")]});this.swampArena=this.metascreen({id:124,icon:X`
      |   |
      |\u2517\u252f\u251b|
      | \u2502 |`,tile:"   | a | c ",tilesets:{swamp:{}},feature:["arena"],edges:"  s ",connect:"a"});this.swampNWE=this.metascreen({id:125,icon:X`
      | \u2502 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"ss s",connect:"26e",exits:[Tq({left:6,width:4}),Wq({top:7,height:4}),Xq({top:7,height:4})]});this.swampWS=this.metascreen({id:126,icon:X`
      |   |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |cc | c ",tilesets:{swamp:{requires:[K.SwampDoors]}},feature:["consolidate"],update:[[K.SwampDoors,(a,c,d)=>{d.metascreens.swampWS_door.flag="always";return!0}]],edges:" ss ",connect:"6a",exits:[Wq({top:7,height:4}),Uq({left:6,width:4})],poi:[[2]]});this.swampWS_door=this.metascreen({id:126,icon:X`\u2229
      | \u2229 |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |c< | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:" ss ",connect:"6a",exits:[Sq(87,"swamp")]});this.swampEmpty=this.metascreen({id:127,icon:X`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{swamp:{}},feature:["empty"],edges:"    ",connect:"",delete:!0});this.swampN=this.metascreen({id:-113,icon:X`
      | \u2502 |
      | \u2575 |
      |   |`,tile:" c | c |   ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s   ",connect:"2",poi:[[0]],definition:Pq(".  .  .  .  cf f6 c7 ad c4 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b8 b9 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b8 ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 c2 c3 b7 b8 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c2 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad b9 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b8 ad ad d2 e2 .  .  .  .\n         .  .  .  .  e3 f6 c3 c3 b8 b6 d2 .  .  .  .  .\n         .  .  .  .  .  e3 fd ad ad fc e2 .  .  .  .  .\n         .  .  .  .  .  .  ff fb fb fa .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .",
[".",200])});this.swampS=this.metascreen({id:-114,icon:X`
      |   |
      | \u2577 |
      | \u2502 |`,tile:"   | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  s ",connect:"a",poi:[[0]],definition:Pq(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  cd c9 c9 ca .  .  .  .  .  .\n         .  .  .  .  .  cd eb a0 a0 cb ca .  .  .  .  .\n         .  .  .  .  cf a0 f9 f5 f7 f8 cb cc .  .  .  .\n         .  .  .  .  cf a0 ed 08 09 a0 a0 cc .  .  .  .\n         .  .  .  .  cf db ee 0c 0b ef a0 cc .  .  .  .\n         .  .  .  .  cf d0 d1 03 03 d8 db cc .  .  .  .\n         .  .  .  .  cf f6 c7 ad ad ae d2 cc .  .  .  .\n         .  .  .  .  cf d3 ad b9 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 c2 c3 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 c5 c3 c3 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c2 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b8 b6 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .",
[".",200])});this.swampNS=this.metascreen({id:-115,icon:X`
      | \u2502 |
      | \u2502 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s s ",connect:"2a",exits:[Tq({left:6,width:4}),Uq({left:6,width:4})],definition:Pq(".  .  .  .  cf d3 b6 b6 c6 b6 f6 cc .  .  .  .\n         .  .  .  .  cf d3 b6 c3 c7 b6 f6 cc .  .  .  .\n         .  .  .  .  cf f5 c3 c7 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 b6 c6 c5 f6 cc .  .  .  .\n         .  .  .  .  cf d9 b6 c6 c3 c7 d2 cc .  .  .  .\n         .  .  .  .  cf f5 c3 c3 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf d9 ad c2 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf d9 c4 c5 c3 c3 f6 cc .  .  .  .\n         .  .  .  .  cf f5 b7 b7 b8 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d9 c2 b8 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d9 b6 c2 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf d9 b6 b6 b6 b6 d2 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 b8 b6 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b7 b7 b7 f6 cc .  .  .  .\n         .  .  .  .  cf f6 b7 b7 c7 b6 d2 cc .  .  .  .",
[".",200])});this.swampWE=this.metascreen({id:-116,icon:X`
      |   |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{swamp:{}},feature:["consolidate"],edges:" s s",connect:"6e",exits:[Wq({top:7,height:4,shift:-.5}),Xq({top:7,height:4,shift:-.5})],definition:Pq(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9 c9\n         a0 e4 e8 eb e4 a0 a0 a0 eb eb e8 f0 f1 a0 e4 a0\n         a0 e5 e9 f9 f5 f6 f6 f7 ec f9 f7 f8 f2 a0 e5 a0\n         a0 e6 f0 f1 e6 e0 08 09 ed de ea de f2 a0 e6 a0\n         db e7 db f3 e7 e1 0c 0b dd df e0 df f3 db e7 e0\n         d0 d1 da da d0 d1 03 03 d0 d1 d0 d1 da da da da\n         ad c4 ad ad ad ad ad ad ad ad ad ad ad ad ad ad\n         c2 c5 b8 c6 c4 c4 b9 c7 c4 c5 c5 c7 ad ad ad ad\n         ad ad ad ad c2 c3 c3 c3 c3 c3 c7 ad ad ad ad ad\n         fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .",
[".",200])});this.swampWE_door=this.metascreen({id:-116,icon:X`\u2229
      | \u2229 |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |c<c|   ",tilesets:{swamp:{requires:[K.SwampDoors]}},feature:["consolidate"],flag:"always",edges:" s s",connect:"6e",exits:[Sq(86,"swamp")]});this.swampSE=this.metascreen({id:-117,icon:X`
      |   |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"  ss",connect:"ae",exits:[Xq({top:7,height:4,shift:-.5}),Uq({left:6,width:4})],poi:[[2]],definition:Pq(".  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .\n         .  .  .  .  .  .  cd c9 c9 c9 c9 c9 c9 c9 c9 c9\n         .  .  .  .  .  cd a0 a0 a0 e8 04 a0 e8 a0 a0 e4\n         .  .  .  .  cf f8 a0 f0 f1 f5 f5 f7 e9 f4 f7 e5\n         .  .  .  .  cf f6 f7 f8 f2 ea 06 aa e9 f0 f1 e6\n         .  .  .  .  cf a0 dd e0 f3 e0 07 0c ea db f3 e7\n         .  .  .  .  cf db d5 d0 d1 d1 03 03 d0 d1 da da\n         .  .  .  .  cf d5 af c4 c4 ad ad ad ad ad c4 ad\n         .  .  .  .  cf d3 b9 c3 c3 b8 ad ad ad c2 b7 b8\n         .  .  .  .  cf f6 c3 c3 c3 c3 b8 ad ad ad ad ad\n         .  .  .  .  cf f6 c7 ad c2 c3 c7 fc fb fb fb fb\n         .  .  .  .  cf d3 ad ad ad ad d6 cc .  .  .  .\n         .  .  .  .  cf d3 b9 b8 ad b9 f6 cc .  .  .  .\n         .  .  .  .  cf f6 c7 ad b9 c7 d2 cc .  .  .  . \n         .  .  .  .  cf d3 b6 b9 c3 b8 d2 cc .  .  .  .",
[".",200])});this.swampSE_door=this.metascreen({id:-117,icon:X`\u2229
      | \u2229 |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | <c| c ",tilesets:{swamp:{requires:[K.SwampDoors]}},feature:["consolidate"],flag:"always",edges:"  ss",connect:"ae",exits:[Sq(90,"swamp")]});this.swampNSE=this.metascreen({id:-118,icon:X`
      | \u2502 |
      | \u251c\u2500|
      | \u2502 |`,tile:" c | cc| c ",tilesets:{swamp:{}},feature:["consolidate"],edges:"s ss",connect:"2ae",exits:[Tq({left:6,width:4}),Uq({left:6,width:4}),Xq({top:7,height:4,shift:-.5})],definition:Pq(".  .  .  .  cf d3 c4 c3 c3 c3 f7 f8 ca .  .  .\n         .  .  .  .  cf f5 c3 c3 c3 c3 f7 f7 a0 ca c9 c9\n         .  .  .  .  cf f6 c3 c3 b8 b6 d2 f7 f8 e8 e4 a0\n         .  .  .  .  cf f5 b7 c3 b7 b8 d2 f0 f1 e9 e5 de\n         .  .  .  .  cf d3 c2 b8 c2 b8 d8 db f2 ea e6 df\n         .  .  .  .  cf d3 ad ad ad ad ae d4 f3 dd e7 df\n         .  .  .  .  cf d3 ad ad ad ad ad ae d0 d1 d0 d1\n         .  .  .  .  cf d3 c2 c3 c3 b7 b8 ad ad ad ad ad\n         .  .  .  .  cf d3 ad ad c2 b7 b7 b7 b8 c4 ad ad\n         .  .  .  .  cf d3 ad ad b6 b9 b7 b7 b7 b7 b8 ad\n         .  .  .  .  cf d3 ad c4 c3 b7 b8 fc fb fb fb fb\n         .  .  .  .  cf d3 b6 ad ad ad d6 cc .  .  .  .\n         .  .  .  .  cf d3 ad ad ad ad d2 cc .  .  .  .\n         .  .  .  .  cf d3 c4 c3 b7 b8 d2 cc .  .  .  .\n         .  .  .  .  cf d3 b6 b9 b7 b7 f6 cc .  .  .  .",
[".",200])});this.caveEmpty=this.metascreen({id:128,icon:X`
      |   |
      |   |
      |   |`,tile:"   |   |   ",tilesets:{cave:{},fortress:{},labyrinth:{},pyramid:{},iceCave:{},dolphinCave:{}},feature:["empty"],edges:"    ",delete:!0});this.open=this.metascreen({id:128,icon:X`
      |   |
      |   |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{},sea:{}},edges:"oooo"});this.hallNS=this.metascreen({id:129,icon:X`
      | \u2502 |
      | \u2502 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",connect:"2a",poi:[[4]],exits:[Uq({left:6,width:4,manual:!0})]});this.hallNS_unreachable=this.metascreen({id:129,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallWE=this.metascreen({id:130,icon:X`
      |   |
      |\u2500\u2500\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",poi:[[4]]});this.hallWE_unreachable=this.metascreen({id:130,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallSE=this.metascreen({id:131,icon:X`
      |   |
      | \u250c\u2500|
      | \u2502 |`,tile:"   | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"  cc",connect:"ae",poi:[[2]]});this.hallSE_unreachable=this.metascreen({id:131,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallWS=this.metascreen({id:132,icon:X`
      |   |
      |\u2500\u2510 |
      | \u2502 |`,tile:"   |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" cc ",connect:"6a",poi:[[2]]});this.hallWS_unreachable=this.metascreen({id:132,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallNE=this.metascreen({id:133,icon:X`
      | \u2502 |
      | \u2514\u2500|
      |   |`,tile:" c | cc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c  c",connect:"2e",poi:[[2]]});this.hallNE_unreachable=this.metascreen({id:133,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallNW=this.metascreen({id:134,icon:X`
      | \u2502 |
      |\u2500\u2518 |
      |   |`,tile:" c |cc |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc  ",connect:"26",poi:[[2]]});this.hallNW_unreachable=this.metascreen({id:134,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.branchNSE=this.metascreen({id:135,icon:X`
      | \u2502 |
      | \u251c\u2500|
      | \u2502 |`,tile:" c | cc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c cc",connect:"2ae",poi:[[3]]});this.branchNSE_unreachable=this.metascreen({id:135,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.branchNWSE=this.metascreen({id:136,icon:X`
      | \u2502 |
      |\u2500\u253c\u2500|
      | \u2502 |`,tile:" c |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cccc",connect:"26ae",poi:[[3]]});this.branchNWSE_unreachable=this.metascreen({id:136,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.branchNWS=this.metascreen({id:137,icon:X`
      | \u2502 |
      |\u2500\u2524 |
      | \u2502 |`,tile:" c |cc | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"ccc ",connect:"26a",poi:[[3]]});this.branchNWS_unreachable=this.metascreen({id:137,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.branchWSE=this.metascreen({id:138,icon:X`
      |   |
      |\u2500\u252c\u2500|
      | \u2502 |`,tile:"   |ccc| c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" ccc",connect:"6ae",poi:[[3]]});this.branchWSE_unreachable=this.metascreen({id:138,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.branchNWE=this.metascreen({id:139,icon:X`
      | \u2502 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"cc c",connect:"26e",poi:[[3]],exits:[Zq(6,4)]});this.branchNWE_unreachable=this.metascreen({id:139,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallNS_ramp=this.metascreen({id:140,icon:X`
      | \u250b |
      | \u250b |
      | \u250b |`,tile:" c | / | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["ramp"],edges:"c c ",connect:"2a"});this.hallNS_ramp_unreachable=this.metascreen({id:140,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallNS_overBridge=this.metascreen({id:141,icon:X`
      | \u257d |
      |\u2500\u2503\u2500|
      | \u257f |`,tile:" c | b | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["overpass"],edges:"cbcb",connect:"2a"});this.hallWE_underBridge=this.metascreen({id:142,icon:X`
      | \u257d |
      |\u2500\u2500\u2500|
      | \u257f |`,tile:"   |cbc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["underpass"],edges:"bcbc",connect:"6e"});this.hallNS_wall=this.metascreen({id:143,icon:X`
      | \u2502 |
      | \u2506 |
      | \u2502 |`,tile:" c | c | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c c ",feature:["wall"],connect:"2=a",wall:135,mod:"wall"});this.hallNS_wall_unreachable=this.metascreen({id:143,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallWE_wall=this.metascreen({id:144,icon:X`
      |   |
      |\u2500\u2504\u2500|
      |   |`,tile:"   |ccc|   ",tilesets:{cave:{},iceCave:{}},feature:["wall"],edges:" c c",connect:"6=e",wall:103,mod:"wall"});this.hallWE_wall_unreachable=this.metascreen({id:144,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallNS_arena=this.metascreen({id:145,icon:X`
      |\u250c\u2538\u2510|
      |\u2502&\u2502|
      |\u2514\u252c\u2518|`,tile:[" n | a | c "," c | a | c "," c | a | w "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["arena"],edges:"n c ",connect:"2a",poi:[[1,96,120]],exits:[Tq(),Uq({left:6,width:4,manual:!0}),Yq(230,4)]});this.hallNS_arena_unreachable=this.metascreen({id:145,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.hallNS_arenaWall=this.metascreen({id:146,
icon:X`
      |\u250c\u2504\u2510|
      |\u2502&\u2502|
      |\u2514\u252c\u2518|`,placement:"manual",tile:[" n | a | c "," c | a | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["arena","wall"],edges:"n c ",connect:"2=a",wall:39,mod:"wall",poi:[[1,96,120]],exits:[Uq({left:6,width:4,manual:!0}),Tq({top:1})]});this.branchNWE_wall=this.metascreen({id:148,icon:X`
      | \u2506 |
      |\u2500\u2534\u2500|
      |   |`,tile:" c |ccc|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wall"],edges:"cc c",connect:"2=6e",exits:[Tq({left:6,width:4})],mod:"wall",wall:55});this.branchNWE_wall_unreachable=this.metascreen({id:148,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.branchNWE_upStair=this.metascreen({id:149,icon:X`<
      | < |
      |\u2500\u2534\u2500|
      |   |`,tile:"   |c<c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c c",connect:"6e",exits:[Qq(71)]});this.branchNWE_upStair_unreachable=this.metascreen({id:149,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.deadEndW_upStair=this.metascreen({id:150,icon:X`<
      | < |
      |\u2500\u2518 |
      |   |`,tile:"   |c< |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[Qq(66)]});this.deadEndW_upStair_unreachable=this.metascreen({id:150,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,32),delete:!0});this.deadEndW_downStair=this.metascreen({id:151,icon:X`>
      |   |
      |\u2500\u2510 |
      | > |`,tile:"   |c> |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:" c  ",connect:"6",exits:[Rq(162)]});this.deadEndW_downStair_unreachable=this.metascreen({id:151,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,32),delete:!0});this.deadEndE_upStair=this.metascreen({id:152,icon:X`<
      | < |
      | \u2514\u2500|
      |   |`,tile:"   | <c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[Qq(76)]});this.deadEndE_upStair_unreachable=this.metascreen({id:152,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,208),delete:!0});this.deadEndE_downStair=this.metascreen({id:153,icon:X`>
      |   |
      | \u250c\u2500|
      | > |`,tile:"   | >c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"   c",connect:"e",exits:[Rq(172)]});this.deadEndE_downStair_unreachable=this.metascreen({id:153,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,208),delete:!0});this.deadEndNS_stairs=this.metascreen({id:154,icon:X`
      | > |
      |   |
      | < |`,placement:"manual",tile:" > |   | < ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c c ",connect:"2|a",exits:[Rq(23),Qq(215)],match:(a)=>a(264,120)&&a(-48,120)});this.deadEndNS_stairs_unreachable=this.metascreen({id:154,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(264,120)&&!a(-48,120),delete:!0});this.deadEndN_stairs=this.metascreen({id:154,icon:X`
      | > |
      |   |
      |   |`,tile:[" c | > |   "," > |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c   ",connect:"2",exits:[Rq(23)],match:(a)=>!a(264,120)&&a(-48,120)});this.deadEndS_stairs=this.metascreen({id:154,icon:X`
      |   |
      |   |
      | < |`,tile:["   | < | c ","   |   | < "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"  c ",connect:"a",exits:[Qq(215)],match:(a)=>!a(-48,120)&&a(264,120)});this.deadEndNS=this.metascreen({id:155,icon:X`
      | \u2575 |
      |   |
      | \u2577 |`,placement:"manual",tile:" c |   | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c c ",connect:"2|a",poi:[[0,272,120],[0,-48,120]],match:(a)=>a(-48,120)&&a(272,120)});this.deadEndNS_unreachable=this.metascreen({id:155,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(-48,120)&&!a(272,120),delete:!0});this.deadEndN=this.metascreen({id:155,icon:X`
      | \u2575 |
      |   |
      |   |`,tile:[" c | c |   "," c |   |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"c   ",connect:"2",poi:[[0,-48,120]],match:(a)=>!a(272,120)&&a(-48,120)});this.deadEndS=this.metascreen({id:155,icon:X`
      |   |
      |   |
      | \u2577 |`,tile:["   | c | c ","   |   | c "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"  c ",connect:"a",poi:[[0,272,120]],match:(a)=>!a(-48,120)&&a(272,120)});this.deadEndWE=this.metascreen({id:156,icon:X`
      |   |
      |\u2574 \u2576|
      |   |`,placement:"manual",tile:"   |c c|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:" c c",connect:"6|e",poi:[[0,112,264],[0,112,-40]],match:(a)=>a(112,-40)&&a(112,264)});this.deadEndWE_unreachable=this.metascreen({id:156,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(112,-40)&&!a(112,264),delete:!0});this.deadEndW=this.metascreen({id:156,icon:X`
      |   |
      |\u2574  |
      |   |`,tile:["   |cc |   ","   |c  |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:" c  ",connect:"6",poi:[[0,112,-40]],match:(a)=>!a(112,264)&&a(112,-40)});this.deadEndE=this.metascreen({id:156,icon:X`
      |   |
      |  \u2576|
      |   |`,tile:["   | cc|   ","   |  c|   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],edges:"   c",connect:"e",poi:[[0,112,264]],match:(a)=>!a(112,-40)&&a(112,264)});this.hallNS_entrance=this.metascreen({id:158,icon:X`\u257d
      | \u2502 |
      | \u2502 |
      | \u257d |`,tile:" c | c | n ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},edges:"c n ",connect:"2a",exits:[Uq()]});this.hallNS_entrance_unreachable=this.metascreen({id:158,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.channelExitSE=this.metascreen({id:159,icon:X`
      |   |
      | \u2554\u2550|
      | \u2551 |`,tilesets:{dolphinCave:{}},feature:["river"],exits:[Uq({left:5})]});this.channelBendWS=this.metascreen({id:160,icon:X`
      |\u2588  |
      |\u2550\u2557 |
      |\u2588\u2551 |`,tilesets:{dolphinCave:{}},feature:["river"]});this.channelHallNS=this.metascreen({id:161,icon:X`
      | \u2551 |
      | \u2560\u2508|
      | \u2551 |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],wall:139});this.channelEntranceSE=this.metascreen({id:162,icon:X`
      |   |
      | \u2554\u2508|
      |\u2577\u2551 |`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[Uq({left:2})],wall:124});this.channelCross=this.metascreen({id:163,icon:X`
      | \u2551 |
      |\u2550\u256c\u2550|
      |\u2577\u2551\u2577|`,tilesets:{dolphinCave:{}},feature:["river"],exits:[Uq({left:3}),Uq({left:11,type:"door"})]});this.channelDoor=this.metascreen({id:164,icon:X`\u2229
      | \u2229\u2588|
      |\u2508\u2550\u2550|
      |  \u2588|`,tilesets:{dolphinCave:{}},feature:["river","bridge"],exits:[Y(56)],wall:115});this.mountainFloatingIsland=this.metascreen({id:165,icon:X`*
      |\u2550\u2557\u2588|
      |*\u2551 |
      |\u2550\u2563\u2588|`,placement:"manual",tile:"   | ap|   ",tilesets:{mountainRiver:{}},edges:"  wp",connect:"e"});this.mountainPathNE_stair=this.metascreen({id:166,icon:X`\u2514
      |\u2588\u250b\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:" / | pp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"l  p",connect:"2e",exits:[Tq()]});this.mountainBranchNWE=this.metascreen({id:167,icon:X`\u2534
      |\u2588 \u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:" p |ppp|  ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp p",connect:"26e"});this.mountainPathWE_iceBridge=this.metascreen({id:168,icon:X`\u256b
      |\u2588\u2551\u2588|
      | \u2506 |
      |\u2588\u2551\u2588|`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},feature:["bridge"],edges:"wpwp",connect:"6-e:2a",wall:135});this.mountainPathSE=this.metascreen({id:169,icon:X`\u250c
      |\u2588\u2588\u2588|
      |\u2588  |
      |\u2588 \u2588|`,tile:"   | pp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:"  pp",connect:"ae",exits:[Xq({top:6,height:4}),Uq({left:6,width:4})]});this.mountainDeadEndW_caveEmpty=this.metascreen({id:170,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u2590 \u2590|
      |\u2588\u2588\u2588|`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[Sq(56)]});this.mountainPathNE=this.metascreen({id:171,icon:X`\u2514
      |\u2588 \u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:" p | pp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"p  p",connect:"2e",exits:[Xq({top:6,height:4}),Tq({left:6,width:4})]});this.mountainBranchWSE=this.metascreen({id:172,icon:X`\u252c
      |\u2588\u2588\u2588|
      |   |
      |\u2588 \u2588|`,tile:"   |ppp| p ",tilesets:{mountain:{},mountainRiver:{}},edges:" ppp",connect:"6ae"});this.mountainPathW_cave=this.metascreen({id:173,icon:X`\u2229
      |\u2588\u2229\u2588|
      |  \u2590|
      |\u2588\u2588\u2588|`,tile:"   |p< |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6",exits:[Sq(85)]});this.mountainPathE_slopeS=this.metascreen({id:174,icon:X`\u2553
      |\u2588\u2588\u2588|
      |\u2588  |
      |\u2588\u2193\u2588|`,tile:"   | pp| \u2193 ",tilesets:{mountain:{}},edges:"  sp",connect:"ae"});this.mountainPathNW=this.metascreen({id:175,icon:X`\u2518
      |\u2588 \u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:" p |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"pp  ",connect:"26",exits:[Wq({top:6,height:4}),Tq({left:6,width:4})]});this.mountainCave_empty=this.metascreen({id:176,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u258c \u2590|
      |\u2588\u2588\u2588|`,tile:"   | < |   ",tilesets:{mountain:{},mountainRiver:{}},edges:"    ",connect:"",exits:[Sq(88)]});this.mountainPathE_cave=this.metascreen({id:177,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:"   | <p|   ",tilesets:{mountain:{},mountainRiver:{}},edges:"   p",connect:"e",exits:[Sq(87)]});this.mountainPathWE_slopeN=this.metascreen({id:178,icon:X`\u2568
      |\u2588\u2193\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:" \u2193 |ppp|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e"});this.mountainDeadEndW=this.metascreen({id:179,icon:X`\u2574
      |\u2588\u2588\u2588|
      |  \u2588|
      |\u2588\u2588\u2588|`,tile:"   |pp |   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p  ",connect:"6"});this.mountainPathWE=this.metascreen({id:180,icon:X`\u2500
      |\u2588\u2588\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:"   |ppp|   ",tilesets:{mountain:{},mountainRiver:{}},edges:" p p",connect:"6e",exits:[Wq({top:6,height:4}),Xq({top:6,height:4})]});this.mountainArena_gate=this.metascreen({id:181,icon:X`#
      |\u2588#\u2588|
      |\u258c \u2590|
      |\u2588\u250b\u2588|`,tile:"   | < | / ",tilesets:{mountain:{},mountainRiver:{}},feature:["arena"],edges:"  l ",connect:"a",exits:[Object.assign({},Qq(71,3),{type:"cave"})],flag:"custom:false"});this.mountainPathN_slopeS_cave=this.metascreen({id:182,icon:X`\u2229
      |\u2588\u250b\u2229|
      |\u258c \u2590|
      |\u2588\u2193\u2588|`,tile:" / | < | \u2193 ",tilesets:{mountain:{}},edges:"l s ",connect:"2a",exits:[Sq(90),Tq()]});this.mountainPathWE_slopeNS=this.metascreen({id:183,icon:X`\u256b
      |\u2588\u2193\u2588|
      |   |
      |\u2588\u2193\u2588|`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"26ae"});this.mountainPathWE_slopeN_cave=this.metascreen({id:184,icon:X`\u2229
      |\u2588\u2193\u2229|
      |   |
      |\u2588\u2588\u2588|`,tile:" \u2193 |p<p|   ",tilesets:{mountain:{}},edges:"sp p",connect:"26e",exits:[Sq(92)]});this.mountainPathWS=this.metascreen({id:185,icon:X`\u2510
      |\u2588\u2588\u2588|
      |  \u2588|
      |\u2588 \u2588|`,tile:"   |pp | p ",tilesets:{mountain:{},mountainRiver:{}},edges:" pp ",connect:"6a",exits:[Wq({top:6,height:4}),Uq({left:6,width:4})]});this.mountainSlope=this.metascreen({id:186,icon:X`\u2193
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2588|
      |\u2588\u2193\u2588|`,tile:" \u2193 | \u2193 | \u2193 ",tilesets:{mountain:{}},edges:"s s ",connect:"2a"});this.mountainRiver=this.metascreen({id:186,icon:X`\u2551
      |\u2588\u2551\u2588|
      |\u2588\u2551\u2588|
      |\u2588\u2551\u2588|`,tile:[" r | r | r "," r | r |   "],tilesets:{mountainRiver:{}},edges:"w w ",connect:"2:e"});this.mountainPathE_gate=this.metascreen({id:187,icon:X`\u2229
      |\u2588\u2229\u2588|
      |\u2588  |
      |\u2588\u2588\u2588|`,tile:"   | <p|   ",tilesets:{mountain:{}},edges:"   p",connect:"e",exits:[Sq(87,"gate")]});this.mountainPathWE_inn=this.metascreen({id:188,icon:X`\u2229
      |\u2588\u2229\u2588|
      |   |
      |\u2588\u2588\u2588|`,tile:"   |p<p|   ",placement:"manual",tilesets:{mountain:{}},edges:" p p",connect:"6e",exits:[Y(118)]});this.mountainPathWE_bridgeOverSlope=this.metascreen({id:189,icon:X`\u2550
      |\u2588\u2193\u2588|
      | \u2550 |
      |\u2588\u2193\u2588|`,tile:" \u2193 |ppp| \u2193 ",tilesets:{mountain:{}},edges:"spsp",connect:"6e",exits:[Yq(182,4)]});this.mountainPathWE_bridgeOverRiver=this.metascreen({id:189,icon:X`\u2550
      |\u2588\u2551\u2588|
      | \u2550 |
      |\u2588\u2551\u2588|`,tile:[" r |ppp| r "," r |ppp|   "],tilesets:{mountainRiver:{}},edges:"wpwp",connect:"6e|2|a"});this.mountainSlope_underBridge=this.metascreen({id:190,icon:X`\u2193
      |\u2588\u2193\u2588|
      | \u2550 |
      |\u2588\u2193\u2588|`,tile:" \u2193 |p\u2193p| \u2193 ",placement:"manual",tilesets:{mountain:{}},edges:"spsp",connect:"2a",exits:[Zq(198,4)]});this.mountainEmpty=this.metascreen({id:191,icon:X`
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|
      |\u2588\u2588\u2588|`,tile:"   |   |   ",tilesets:{mountain:{},mountainRiver:{}},feature:["empty"],edges:"    ",delete:!0});this.boundaryS=this.metascreen({id:192,icon:X`
      |   |
      |\u2584\u2584\u2584|
      |\u2588\u2588\u2588|`,tile:"ooo|ooo|   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"o^ ^"});this.boundaryN_cave=this.metascreen({id:193,icon:X`
      |\u2588\u2588\u2588|
      |\u2580\u2229\u2580|
      |   |`,tile:"   |o<o|ooo",tilesets:{grass:{},sea:{},desert:{},river:{requires:[K.SeaCaveEntrance]}},edges:" vov",exits:[Sq(73)]});this.cornerSE_cave=this.metascreen({id:194,icon:X`
      | \u2590\u2588|
      |\u2584\u2229\u2588|
      |\u2588\u2588\u2588|`,tile:"oo |o< |   ",tilesets:{grass:{},river:{},sea:{},desert:{}},edges:"<^  ",exits:[Sq(90)]});this.waterfall=this.metascreen({id:195,icon:X`
      |   |
      |\u2193\u2193\u2193|
      |   |`,tile:"ooo|\u2193\u2193\u2193|ooo",tilesets:{sea:{}},edges:"oooo"});this.whirlpoolBlocker=this.metascreen({id:196,icon:X`
      |   |
      |\u2588\u2573\u2588|
      |   |`,tile:"ooo|\u2193#\u2193|ooo",tilesets:{sea:{}},feature:["whirlpool"],flag:"calm",edges:"oooo"});this.beachExitN=this.metascreen({id:197,icon:X`
      |\u2588 \u2588|
      |\u2588\u2571\u2580|
      |\u2588\u258c |`,placement:"manual",tile:" x | bo| oo",tilesets:{sea:{}},edges:"n >v",exits:[Tq({left:9})]});this.whirlpoolOpen=this.metascreen({id:198,icon:X`
      |   |
      | \u2573 |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{sea:{}},feature:["whirlpool"],edges:"oooo",flag:"calm"});this.quicksandOpen=this.metascreen({id:198,icon:X`
      |   |
      | \u2573 |
      |   |`,tile:"ooo|ooo|ooo",tilesets:{desert:{}},feature:["whirlpool"],edges:"oooo"});this.lighthouseEntrance=this.metascreen({id:199,icon:X`
      |\u2597\u259f\u2588|
      |\u2590\u2229\u259b|
      |\u259d\u2580\u2598|`,placement:"manual",tile:"oo |oLo|ooo",tilesets:{sea:{}},feature:["lighthouse"],edges:"<oov",exits:[Sq(42),Y(117)]});this.beachCave=this.metascreen({id:200,icon:X`
      |\u2588\u2229\u2588|
      |\u2580\u2572\u2588|
      |   |`,placement:"manual",tile:"   |o<o|ooo",tilesets:{sea:{}},edges:" vov",exits:[Sq(40)]});this.beachCabinEntrance=this.metascreen({id:201,icon:X`
      | \u2229\u2588|
      | \u2572\u2580|
      |\u2588\u2584\u2584|`,placement:"manual",tile:"oo |oC8|   ",tilesets:{sea:{}},feature:["cabin"],edges:"<^ b",exits:[Y(85),Xq({top:8,height:3})]});this.oceanShrine=this.metascreen({id:202,icon:X`
      |\u2597\u2584\u2596|
      |\u2590*\u258c|
      |\u259d \u2598|`,placement:"manual",tile:"ooo|oAo|ooo",tilesets:{sea:{}},feature:["altar"],edges:"oooo"});this.pyramidEntrance=this.metascreen({id:203,icon:X`
      | \u2584 |
      |\u259f\u2229\u2599|
      | \u2573 |`,placement:"manual",tile:"ooo|oPo|ooo",tilesets:{desert:{}},feature:["pyramid"],edges:"oooo",exits:[Sq(167)]});this.cryptEntrance=this.metascreen({id:204,icon:X`
      | \u2573 |
      |\u2590>\u258c|
      |\u259d\u2580\u2598|`,placement:"manual",tile:"ooo|oYo|ooo",tilesets:{desert:{}},feature:["crypt"],edges:"oooo",exits:[Rq(103)]});this.oasisLake=this.metascreen({id:205,icon:X`
      | ^ |
      |vOv|
      | vv|`,tile:"ooo|ooo|oro",placement:"manual",tilesets:{desert:{}},feature:["lake"],edges:"oo3o"});this.desertCaveEntrance=this.metascreen({id:206,icon:X`
      |\u2597\u2584\u2596|
      |\u259c\u2229\u259b|
      | \u2573 |`,tile:"ooo|o<o|ooo",tilesets:{desert:{},sea:{requires:[K.SeaCaveEntrance]}},edges:"oooo",exits:[Sq(167)]});this.oasisCave=this.metascreen({id:207,icon:X`
      | vv|
      |\u2584\u2229v|
      |\u2588\u258c |`,placement:"manual",tile:"oro|o<o| oo",tilesets:{desert:{}},edges:"3^>o",exits:[Qq(55)]});this.channelEndW_cave=this.metascreen({id:208,icon:X`
      |\u2588\u2588\u2229|
      |\u2550\u2550 |
      |\u2588\u2588\u2588|`,tile:"   |r< |   ",tilesets:{dolphinCave:{}},feature:["river"],exits:[Qq(87)]});this.boatChannel=this.metascreen({id:209,icon:X`
      |\u2588\u2588\u2588|
      |\u2580\u2580\u2580|
      |\u2584\u2584\u2584|`,tile:["   |888|   ","   |88x|   "],tilesets:{sea:{}},edges:" b b",exits:[Object.assign({},Xq({top:8,height:3}),{entrance:40168}),Wq({top:8,height:3})]});this.channelWE=this.metascreen({id:210,icon:X`
      |\u2588\u2588\u2588|
      |\u2550\u2550\u2550|
      |\u2588\u2588\u2588|`,tile:"   |rrr|   ",tilesets:{dolphinCave:{}},feature:["river"]});this.riverCaveNWSE=this.metascreen({id:211,icon:X`
      |\u2518\u2551\u2514|
      |\u2550\u256c\u2550|
      |\u252c\u2507\u252c|`,tile:" r |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"rrrr",connect:"15:3d:79-bf",wall:182,poi:[[4,0,152]]});this.riverCaveNS=this.metascreen({id:212,icon:X`
      |\u2502\u2551\u2502|
      |\u2502\u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3b",mod:"bridge"});this.riverCaveWE=this.metascreen({id:213,icon:X`
      |\u2500\u2500\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u2500\u2500|`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" r r",connect:"5d:7f",mod:"bridge"});this.riverCaveNS_bridge=this.metascreen({id:214,icon:X`
      |\u2502\u2551\u2502|
      |\u251c\u2507\u2524|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r r ",connect:"19-3b",wall:135});this.riverCaveWE_bridge=this.metascreen({id:215,icon:X`
      |\u2500\u252c\u2500|
      |\u2550\u2505\u2550|
      |\u2500\u2534\u2500|`,tile:"   |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:" r r",connect:"5d-7f",wall:134});this.riverCaveSE=this.metascreen({id:216,icon:X`
      |\u250c\u2500\u2500|
      |\u2502\u2554\u2550|
      |\u2502\u2551\u250c|`,tile:"   | rr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"  rr",connect:"9d:bf"});this.riverCaveWS=this.metascreen({id:217,icon:X`
      |\u2500\u2500\u2510|
      |\u2550\u2557\u2502|
      |\u2510\u2551\u2502|`,tile:"   |rr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rr ",connect:"5b:79"});this.riverCaveNE=this.metascreen({id:218,icon:X`
      |\u2502\u2551\u2514|
      |\u2502\u255a\u2550|
      |\u2514\u2500\u2500|`,tile:" r | rr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r  r",connect:"1f:3d"});this.riverCaveNW=this.metascreen({id:219,icon:X`
      |\u2518\u2551\u2502|
      |\u2550\u255d\u2502|
      |\u2500\u2500\u2518|`,tile:" r |rr |   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr  ",connect:"15:37"});this.riverCaveWE_passageN=this.metascreen({id:220,icon:X`\u2567
      |\u2500\u2534\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u2500\u2500|`,tile:" c |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"cr r",connect:"25d:7f"});this.riverCaveWE_passageS=this.metascreen({id:221,icon:X`\u2564
      |\u2500\u2500\u2500|
      |\u2550\u2550\u2550|
      |\u2500\u252c\u2500|`,tile:"   |rrr| c ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rcr",connect:"5d:7bf"});this.riverCaveNS_passageW=this.metascreen({id:222,icon:X`\u2562
      |\u2502\u2551\u2502|
      |\u2524\u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r |cr | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rcr ",connect:"169:3b"});this.riverCaveNS_passageE=this.metascreen({id:223,icon:X`\u255f
      |\u2502\u2551\u2502|
      |\u2502\u2551\u251c|
      |\u2502\u2551\u2502|`,tile:" r | rc| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r rc",connect:"19:3be"});this.wideHallNE=this.metascreen({id:224,icon:X`
      | \u2503 |
      | \u2517\u2501|
      |   |`,tile:" w | ww|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w  w",connect:"2e"});this.goaWideHallNE=this.metascreen({id:224,icon:X`
      |\u2502\u2503\u2514|
      |\u2502\u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{}},edges:"w  w",connect:"1f|2e|3d"});this.goaWideHallNE_blockedLeft=this.metascreen({id:224,icon:X`
      |\u2502\u2503\u2514|
      | \u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[97]}},edges:"w  w",connect:"1|f|2e|3d"});this.goaWideHallNE_blockedRight=this.metascreen({id:224,icon:X`
      |\u2502\u2503 |
      |\u2502\u2517\u2501|
      |\u2514\u2500\u2500|`,tile:" w | ww|   ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[13]}},edges:"w  w",connect:"1f|2e|3|d"});this.wideHallNW=this.metascreen({id:225,icon:X`
      | \u2503 |
      |\u2501\u251b |
      |   |`,tile:" w |ww |   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww  ",connect:"26"});this.goaWideHallNW=this.metascreen({id:225,icon:X`
      |\u2518\u2503\u2502|
      |\u2501\u251b\u2502|
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],removeWall:109}},edges:"ww  ",connect:"15|26|37"});this.goaWideHallNW_blockedRight=this.metascreen({id:225,icon:X`
      |\u2518\u2503\u2502|
      |\u2501\u251b |
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{}},edges:"ww  ",connect:"15|26|3|7"});this.goaWideHallNW_blockedLeft=this.metascreen({id:225,icon:X`
      | \u2503\u2502|
      |\u2501\u251b\u2502|
      |\u2500\u2500\u2518|`,tile:" w |ww |   ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[1],removeWall:109}},edges:"ww  ",connect:"1|5|26|37"});this.wideHallSE=this.metascreen({id:226,icon:X`
      |   |
      | \u250f\u2501|
      | \u2503 |`,tile:"   | ww| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  ww",connect:"ae"});this.goaWideHallSE=this.metascreen({id:226,icon:X`
      |\u250c\u2500\u2500|
      |\u2502\u250f\u2501|
      |\u2502\u2503\u250c|`,tile:"   | ww| w ",tilesets:{labyrinth:{}},edges:"  ww",connect:"9d|ae|bf"});this.goaWideHallSE_blockedLeft=this.metascreen({id:226,icon:X`
      |\u250c\u2500\u2500|
      | \u250f\u2501|
      |\u2502\u2503\u250c|`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[97]}},edges:"  ww",connect:"9|d|ae|bf"});this.goaWideHallSE_blockedRight=this.metascreen({id:226,icon:X`
      |\u250c\u2500\u2500|
      |\u2502\u250f\u2501|
      |\u2502\u2503 |`,tile:"   | ww| w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[221]}},edges:"  ww",connect:"9d|ae|b|f"});this.wideHallWS=this.metascreen({id:227,icon:X`
      |   |
      |\u2501\u2513 |
      | \u2503 |`,tile:"   |ww | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" ww ",connect:"6a"});this.goaWideHallWS=this.metascreen({id:227,icon:X`
      |\u2500\u2500\u2510|
      |\u2501\u2513\u2502|
      |\u2510\u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],removeWall:157}},edges:" ww ",connect:"5b|6a|79"});this.goaWideHallWS_blockedRight=this.metascreen({id:227,icon:X`
      |\u2500\u2500\u2510|
      |\u2501\u2513 |
      |\u2510\u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{}},edges:" ww ",connect:"5|b|6a|79"});this.goaWideHallWS_blockedLeft=this.metascreen({id:227,icon:X`
      |\u2500\u2500\u2510|
      |\u2501\u2513\u2502|
      | \u2503\u2502|`,tile:"   |ww | w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[209],removeWall:157}},edges:" ww ",connect:"5b|6a|7|9"});this.goaWideHallNS_stairs=this.metascreen({id:228,icon:X`
      |\u251c\u2528\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2520\u2524|`,tile:" w | H | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"1239ab"});this.goaWideHallNS_stairsBlocked13=this.metascreen({id:228,icon:X`
      |\u2514\u2528\u2502|
      |\u2577\u2503\u2575|
      |\u2502\u2520\u2510|`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[65,141]}},edges:"w w ",connect:"12ab|3|9"});this.goaWideHallNS_stairsBlocked24=this.metascreen({id:228,icon:X`
      |\u250c\u2528\u2502|
      |\u2502\u2503\u2502|
      |\u2502\u2520\u2518|`,tile:" w | H | w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[1,205]}},edges:"w w ",connect:"1|239a|b"});this.wideHallNS_deadEnds=this.metascreen({id:229,icon:X`
      | \u2579 |
      |   |
      | \u257b |`,tile:" w |   | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w w ",connect:"2|a",match:(a)=>a(272,120)&&a(-48,120)});this.wideHall_deadEndN=this.metascreen({id:229,icon:X`
      | \u2579 |
      |   |
      |   |`,tile:[" w |   |   "," w | w |   "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"w   ",connect:"2",match:(a)=>!a(272,120)&&a(-48,120)});this.wideHall_deadEndS=this.metascreen({id:229,icon:X`
      |   |
      |   |
      | \u257b |`,tile:["   |   | w ","   | w | w "],tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"  w ",connect:"a",match:(a)=>a(272,120)&&!a(-48,120)});this.goaWideHallNS_deadEnd=this.metascreen({id:229,icon:X`
      |\u2502\u2579\u2502|
      |\u251c\u2500\u2524|
      |\u2502\u257b\u2502|`,tile:" w | = | w ",tilesets:{labyrinth:{}},edges:"w w ",connect:"139b|2|a"});this.goaWideHallNS_deadEndBlocked24=this.metascreen({id:229,icon:X`
      |\u2575\u2579\u2502|
      |\u250c\u2500\u2518|
      |\u2502\u257b\u2577|`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[97,173]}},edges:"w w ",connect:"1|2|39|a|b"});this.goaWideHallNS_deadEndBlocked13=this.metascreen({id:229,icon:X`
      |\u2502\u2579\u2575|
      |\u2514\u2500\u2510|
      |\u2577\u257b\u2502|`,tile:" w | = | w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[109,161]}},edges:"w w ",connect:"1b|2|3|9|a"});this.wideHallNWSE=this.metascreen({id:230,icon:X`
      | \u2503 |
      |\u2501\u254b\u2501|
      | \u2503 |`,tile:" w |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"wwww",connect:"26ae"});this.goaWideHallNWSE=this.metascreen({id:230,icon:X`
      |\u2518\u2503\u2514|
      |\u2501\u254b\u2501|
      |\u2510\u2503\u250c|`,tile:" w |www| w ",tilesets:{labyrinth:{}},edges:"wwww",connect:"26ae|15|3d|79|bf"});this.goaWideHallNWSE_blocked13=this.metascreen({id:230,icon:X`
      |\u2518\u2503 |
      |\u2501\u254b\u2501|
      | \u2503\u250c|`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[13,209]}},edges:"wwww",connect:"26ae|15|3|d|7|9|bf"});this.goaWideHallNWSE_blocked24=this.metascreen({id:230,icon:X`
      | \u2503\u2514|
      |\u2501\u254b\u2501|
      |\u2510\u2503 |`,tile:" w |www| w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[1,221]}},edges:"wwww",connect:"26ae|1|5|3d|79|b|f"});this.wideHallNWE=this.metascreen({id:231,icon:X`
      | \u2503 |
      |\u2501\u253b\u2501|
      |   |`,tile:" w |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:"ww w",connect:"26e"});this.goaWideHallNWE=this.metascreen({id:231,icon:X`
      |\u2518\u2503\u2514|
      |\u2501\u253b\u2501|
      |\u2500\u2500\u2500|`,tile:" w |www|   ",tilesets:{labyrinth:{}},edges:"ww w",connect:"26e|15|3d|7f"});this.goaWideHallNWE_blockedTop=this.metascreen({id:231,icon:X`
      | \u2503 |
      |\u2501\u253b\u2501|
      |\u2500\u2500\u2500|`,tile:" w |www|   ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[1,13]}},edges:"ww w",connect:"26e|1|5|3|d|7f"});this.wideHallWSE=this.metascreen({id:232,icon:X`
      |   |
      |\u2501\u2533\u2501|
      | \u2503 |`,tile:"   |www| w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" www",connect:"6ae"});this.goaWideHallWSE=this.metascreen({id:232,icon:X`
      |\u2500\u2500\u2500|
      |\u2501\u2533\u2501|
      |\u2510\u2503\u250c|`,tile:"   |www| w ",tilesets:{labyrinth:{}},edges:" www",connect:"6ae|5d|79|bf"});this.goaWideHallWSE_blockedBottom=this.metascreen({id:232,icon:X`
      |\u2500\u2500\u2500|
      |\u2501\u2533\u2501|
      | \u2503 |`,tile:"   |www| w ",tilesets:{labyrinth:{requires:[K.LabyrinthParapets],addWall:[209,221]}},edges:" www",connect:"6ae|5d|7|9|b|f"});this.wideHallNS_wallTop=this.metascreen({id:233,icon:X`
      | \u2506 |
      | \u2503 |
      | \u2503 |`,tile:" n | w | w ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide","wall"],edges:"c w",connect:"2a",exits:[Tq({left:6,width:4})],wall:55,statues:[10]});this.goaWideHallNS_wallTop=this.metascreen({id:233,icon:X`
      | \u2506 |
      |\u2577\u2503\u2577|
      |\u2502\u2503\u2502|`,tile:" n | w | w ",tilesets:{labyrinth:{}},feature:["wall"],edges:"c w ",connect:"2a|9|b",exits:[Tq({left:6,width:4})],wall:55,statues:[10]});this.wideHallWE=this.metascreen({id:234,icon:X`
      |   |
      |\u2501\u2501\u2501|
      |   |`,tile:"   |www|   ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["wide"],edges:" w w",connect:"6e"});this.goaWideHallWE=this.metascreen({id:234,icon:X`
      |\u2500\u2500\u2500|
      |\u2501\u2501\u2501|
      |\u2500\u2500\u2500|`,tile:"   |www|   ",tilesets:{labyrinth:{}},edges:" w w",connect:"5d|6e|7f"});this.pitWE=this.metascreen({id:235,tile:"   |cpc|   ",icon:X`
      |   |
      |\u2500\u2573\u2500|
      |   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:" c c",connect:"6e",platform:{type:"horizontal",coord:28728}});this.pitNS=this.metascreen({id:236,icon:X`
      | \u2502 |
      | \u2573 |
      | \u2502 |`,tile:" c | p | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["pit"],edges:"c c ",connect:"2a",platform:{type:"vertical",coord:16504}});this.pitNS_unreachable=this.metascreen({id:236,icon:X`\n|   |\n|   |\n|   |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["empty"],placement:"manual",match:(a)=>!a(128,128),delete:!0});this.spikesNS_hallS=this.metascreen({id:237,icon:X`
      | \u2591 |
      | \u2591 |
      | \u2502 |`,tile:" s | s | c ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s c ",connect:"2a"});this.spikesNS_hallN=this.metascreen({id:238,icon:X`
      | \u2502 |
      | \u2591 |
      | \u2591 |`,tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},tile:" c | s | s ",feature:["spikes"],edges:"c s ",connect:"2a"});this.spikesNS_hallWE=this.metascreen({id:239,icon:X`
      | \u2591 |
      |\u2500\u2591\u2500|
      | \u2591 |`,tile:" s |csc| s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"scsc",connect:"26ae"});this.spikesNS_hallW=this.metascreen({id:-225,icon:X`
      | \u2591 |
      |\u2500\u2591 |
      | \u2591 |`,tilesets:yj(K.ExtraSpikes,{cave:{},fortress:{},pyramid:{},iceCave:{}}),tile:" s |cs | s ",feature:["spikes"],edges:"scs ",connect:"26a"});this.spikesNS_hallE=this.metascreen({id:-226,icon:X`
      | \u2591 |
      | \u2591\u2500|
      | \u2591 |`,tilesets:yj(K.ExtraSpikes,{cave:{},fortress:{},pyramid:{},iceCave:{}}),tile:" s | sc| s ",feature:["spikes"],edges:"s sc",connect:"2ae"});this.riverCave_deadEndsNS=this.metascreen({id:240,icon:X`
      | \u2568 |
      |   |
      | \u2565 |`,tile:" r |   | r ",placement:"manual",tilesets:{cave:{},fortress:{}},feature:["empty","river"],edges:"r r ",connect:"1:3|9:b",poi:[[1,-48,72],[1,-48,152],[1,272,72],[1,272,152]]});this.riverCave_deadEndsN=this.metascreen({id:240,icon:X`
      | \u2568 |
      |   |
      |   |`,tile:[" r |   |   "," r | r |   "],tilesets:{cave:{},fortress:{}},feature:["empty","river"],edges:"r   ",connect:"1:3",poi:[[1,-48,72],[1,-48,152]],match:(a)=>!a(264,72)&&!a(264,152),mod:"bridge"});this.riverCave_deadEndsS=this.metascreen({id:240,icon:X`
      |   |
      |   |
      | \u2565 |`,tile:["   |   | r ","   | r | r "],tilesets:{cave:{},fortress:{}},feature:["empty","river"],edges:"  r ",connect:"9:b",poi:[[1,272,72],[1,272,152]],match:(a)=>!a(-48,72)&&!a(-48,152),mod:"bridge"});this.riverCave_deadEndsWE=this.metascreen({id:241,icon:X`
      |   |
      |\u2561 \u255e|
      |   |`,tile:"   |r r|   ",tilesets:{cave:{},fortress:{}},feature:["empty","river"],edges:" r r",connect:"5:7|d:f",poi:[[1,96,264],[1,160,264],[1,96,-40],[1,160,-40]]});this.riverCave_deadEndsW=this.metascreen({id:241,icon:X`
      |   |
      |\u2561  |
      |   |`,tile:["   |r  |   ","   |rr |   "],tilesets:{cave:{},fortress:{}},feature:["empty","river"],edges:" r  ",connect:"5:7",poi:[[1,96,-40],[1,160,-40]],match:(a)=>!a(96,264)&&!a(160,264)});this.riverCave_deadEndsE=this.metascreen({id:241,icon:X`
      |   |
      |  \u255e|
      |   |`,tile:["   |  r|   ","   | rr|   "],tilesets:{cave:{},fortress:{}},feature:["empty","river"],edges:"   r",connect:"d:f",poi:[[1,96,264],[1,160,264]],match:(a)=>!a(96,-40)&&!a(160,-40)});this.riverCaveN_bridge=this.metascreen({id:242,icon:X`
      | \u2507 |
      | \u2568 |
      |   |`,tile:" r | r |   ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"r   ",connect:"1-3",wall:23,match:(a)=>!a(208,72)&&!a(208,152)});this.riverCaveS_bridge=this.metascreen({id:242,icon:X`
      |   |
      | \u2565 |
      | \u2507 |`,tile:"   | r | r ",tilesets:{cave:{},fortress:{}},feature:["river","bridge"],edges:"  r ",connect:"9-b",wall:198,match:(a)=>!a(16,72)&&!a(16,152)});this.riverCaveWSE=this.metascreen({id:243,icon:X`
      |\u2500\u2500\u2500|
      |\u2550\u2566\u2550|
      |\u2510\u2551\u250c|`,tile:"   |rrr| r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:" rrr",connect:"5d:79:bf"});this.riverCaveNWE=this.metascreen({id:244,icon:X`
      |\u2518\u2551\u2514|
      |\u2550\u2569\u2550|
      |\u2500\u2500\u2500|`,tile:" r |rrr|   ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"rr r",connect:"15:3d:7f"});this.riverCaveNS_blockedRight=this.metascreen({id:245,icon:X`
      |\u2502\u2551\u2502|
      |\u2502\u2551 |
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"19:3:b",poi:[[0,192,152],[0,64,152]],mod:"block"});this.riverCaveNS_blockedLeft=this.metascreen({id:246,icon:X`
      |\u2502\u2551\u2502|
      | \u2551\u2502|
      |\u2502\u2551\u2502|`,tile:" r | r | r ",tilesets:{cave:{},fortress:{}},feature:["river"],edges:"r r ",connect:"1:3b:9",poi:[[0,176,72],[0,48,72]],mod:"block"});this.spikesNS=this.metascreen({id:247,icon:X`
      | \u2591 |
      | \u2591 |
      | \u2591 |`,tile:" s | s | s ",tilesets:{cave:{},fortress:{},pyramid:{},iceCave:{}},feature:["spikes"],edges:"s s ",connect:"2a"});this.cryptArena_statues=this.metascreen({id:248,icon:X`<
      |&<&|
      |\u2502 \u2502|
      |\u2514\u252c\u2518|`,tile:"   | a | c ",tilesets:{pyramid:{}},feature:["arena"],edges:"  c ",connect:"a",exits:[Object.assign({},Qq(87),{type:"crypt"})],flag:"custom:false"});this.pyramidArena_draygon=this.metascreen({id:249,icon:X`
      |\u250c\u2500\u2510|
      |\u2502\u2573\u2502|
      |\u2514\u252c\u2518|`,tile:"   | a | w ",tilesets:{pyramid:{}},feature:["arena","pit"],edges:"  w ",connect:"a"});this.cryptArena_draygon2=this.metascreen({id:250,icon:X`
      |\u250f\u2537\u2513|
      |\u2503&\u2503|
      |\u2517\u2533\u251b|`,tile:" x | a | w ",tilesets:{pyramid:{}},feature:["arena"],edges:"c w ",connect:"2a",exits:[Tq({left:6,width:4})],flag:"custom:false"});this.cryptArena_entrance=this.metascreen({id:251,icon:X`
      | \u2503 |
      | \u2503 |
      | \u257f |`,tile:" w | w | x ",tilesets:{pyramid:{}},edges:"w n ",connect:"2a",exits:[Uq()]});this.cryptTeleporter=this.metascreen({id:252,tilesets:{pyramid:{},tower:{}},exits:[Uq({left:6,width:4}),Sq(87,"teleporter")]});this.fortressArena_through=this.metascreen({id:253,icon:X`\u257d
      |\u250c\u2534\u2510|
      |\u2502 \u2502|
      |\u2515\u2533\u2519|`,tile:[" c | a | w "," n | a | w "],tilesets:{fortress:{},pyramid:{}},feature:["arena"],edges:"n w ",connect:"2a",exits:[Tq()]});this.fortressTrap=this.metascreen({id:254,icon:X`
      |\u2514\u2500\u2518|
      | \u2573 |
      |\u2576\u252c\u2574|`,tile:"   | a | c ",tilesets:{fortress:{},pyramid:{}},feature:["pit"],edges:"  n ",connect:"a",exits:[Uq()]});this.shrine=this.metascreen({id:255,tilesets:{shrine:{}},exits:[Uq({left:6,width:5})]});this.inn=this.metascreen({id:256,tilesets:{house:{}},exits:[Object.assign({},Y(134),{entrance:37992})]});this.toolShop=this.metascreen({id:257,tilesets:{house:{}},exits:[Object.assign({},Y(134),{entrance:37992})]});this.armorShop=this.metascreen({id:258,tilesets:{house:{}},exits:[Object.assign({},
Y(134),{entrance:37992})]});for(const b in this)a=this[b],a instanceof $q&&(a.name=b)}metascreen(a){const b=new $q(this.rom,this.length,a);this[this.length++]=b;this.screensById.get(b.sid).push(b);for(const c in a.tilesets){const d=c,e=a.tilesets[d];if(e.requires)for(const a of e.requires)this.screensByFix.get(a).push(b);else this.rom.metatilesets[d].addScreen(b)}return b}getById(a,b){a=this.screensById.has(a)?[...this.screensById.get(a)]:[];null!=b&&(a=a.filter((a)=>a.isCompatibleWithTileset(b)));
return a}registerFix(a,b){for(const d of this.screensByFix.get(a)){var c=(d.data.update||[]).find((b)=>b[0]===a);if(c){if(null==b)throw Error("Seed required for update");if(!c[1](d,b,this.rom))continue}for(const b in d.data.tilesets){c=b;const e=d.data.tilesets[c];if(!e.requires)continue;const g=e.requires.indexOf(a);0>g||(e.requires.splice(g,1),e.requires.length||this.rom.metatilesets[c].addScreen(d))}}}renumber(a,b){var c=this.screensById.get(b);if(c.length)throw Error(`ID already used: ${b}: ${c}`);
let d;for(var e of this.getById(a))e.data.definition&&(d=e.data.definition,e.data.definition=void 0),e.unsafeSetId(b),c.push(e);this.screensById.delete(a);e=this.rom.screens.getScreen(a);0<=a&&0>b&&(c[0].data.definition=Uint8Array.from(e.tiles));c=e.clone(b);this.rom.screens.setScreen(b,c);e.used=!1;0>a&&(this.rom.screens.deleteScreen(a),d&&0<=b&&(c.tiles=Array.from(d)));this.rom.locations.renumberScreen(a,b)}checkExitTypes(){var a;for(const b in this){const c=this[b],d=new Set;for(const e of(null===
(a=null===c||void 0===c?void 0:c.data)||void 0===a?void 0:a.exits)||[])d.has(e.type)&&console.log(`duplicate: ${b} ${e.type}`),d.add(e.type)}}};class hr extends mg{constructor(a,b){super(a,b);this.mirrored=null;this.pointer=230492+(this.id<<1);this.base=Qd(a.prg,this.pointer)+196608;this.used=229376<=this.base;if(255===a.prg[this.base]){const c=Qd(a.prg,this.base+1);for(let b=0;256>b;b++)if(Qd(a.prg,230492+(b<<1))===c){this.mirrored=b;break}if(null==this.mirrored)throw Error(`could not find mirrored sprite for ${w(b)}: ${w(c)}`);this.frames=this.frameMask=this.size=0;this.sprites=[]}else this.mirrored=null,this.size=a.prg[this.base],this.frameMask=
a.prg[this.base+1],this.frames=this.frameMask+1,this.sprites=v(this.frames,(b)=>{b=this.base+2+4*b*this.size;const c=[];for(let d=0;d<this.size&&128!==a.prg[b+4*d];d++)c.push(Id(a.prg,b+4*d,4));return c})}patternBanks(a=0){if(!this.used)return[];let b=this;b.mirrored&&(b=this.rom.metasprites[b.mirrored]);const c=new Set;for(const d of b.sprites)for(const [b,,,f]of d){if(128===b)break;c.add(f+a>>>6&255)}return[...c]}palettes(){if(!this.used)return[];let a=this;a.mirrored&&(a=this.rom.metasprites[a.mirrored]);
const b=new Set;for(const c of a.sprites)for(const [a,,e]of c){if(128===a)break;b.add(e&3)}return[...b]}};class ir{constructor(a){this.rom=a;this._all=[];this.grass=this.tileset(128,{patterns:[0,12]});this.town=this.tileset(132,{});this.cave=this.tileset(136,{});this.dolphinCave=this.tileset(136,{});this.pyramid=this.tileset(140,{});this.river=this.tileset(144,{animated:[0,1],patterns:[20,0]});this.sea=this.tileset(148,{});this.lime=this.tileset(148,{});this.mountain=this.tileset(148,{});this.shrine=this.tileset(152,{});this.desert=this.tileset(156,{});this.mountainRiver=this.tileset(156,{});this.swamp=
this.tileset(160,{consolidated:!0});this.house=this.tileset(160,{});this.fortress=this.tileset(164,{});this.labyrinth=this.tileset(164,{});this.iceCave=this.tileset(168,{});this.tower=this.tileset(172,{});for(const b in this)a=this[b],a instanceof jr&&(a.name=b)}tileset(a,b){a=new jr(this.rom,a,b);this._all.push(a);return a}[Symbol.iterator](){return this._all[Symbol.iterator]()}}
class jr{constructor(a,b,c){this.rom=a;this.tilesetId=b;this.data=c;this._screens=new Set;this._cache=void 0}[Symbol.iterator](){return this._screens[Symbol.iterator]()}get cache(){this._cache||(this._cache=new kr(this));return this._cache}get tileset(){return this.rom.tilesets[this.tilesetId]}get empty(){const a=this.cache.empty;if(!a)throw Error(`No empty screen for ${this.name}`);return a}effects(){return this.tileset.effects()}getTile(a){return this.tileset.getTile(a)}addScreen(a){this._screens.add(a);
a.unsafeAddTileset(this);this.invalidate()}deleteScreen(a){this._screens.delete(a);a.unsafeRemoveTileset(this);this.invalidate()}getMetascreens(a){var b;return null!==(b=this.cache.fromId.get(a))&&void 0!==b?b:[]}getExits(a){return this.cache.exits.get(a)}getMetascreensFromTileString(a){return this.cache.tiles.has(a)?this.cache.tiles.get(a):[]}getScreensWithOnlyFeatures(...a){let b=0;for(const c of a)b|=Oq[c];a=[];for(const c of this)c.features&~b||a.push(c);return a}withMod(a,b){const c=[];for(const d of this.cache.tiles.get(a))d.data.mod===
b&&c.push(d);return c}invalidate(){this._cache=void 0}}var lr,mr=lr||(lr={});mr.N=0;mr.W=1;mr.S=2;mr.E=3;
class kr{constructor(a){var b,c;this.tileset=a;this.fromId=new n(()=>[]);this.exits=new n(()=>[]);this.tiles=new n(()=>[]);let d=void 0;for(const e of a){0<=e.sid&&this.fromId.get(e.sid).push(e);d||"    "!==e.data.edges||"manual"===e.data.placement||!e.hasFeature("empty")||(null===(b=e.data.exits)||void 0===b?0:b.length)||(d=e);for(const a of null!==(c=e.data.exits)&&void 0!==c?c:[])this.exits.get(a.type).push(e);const a="string"===typeof e.data.tile?[e.data.tile]:e.data.tile;for(const b of null!==
a&&void 0!==a?a:[])this.tiles.get(b.replace(/\|/g,"")).push(e)}this.empty=null!==d&&void 0!==d?d:a.rom.metascreens.caveEmpty}};class nr extends Array{constructor(a){super(256);this.rom=a;a=new Map;for(var b in or){const c=or[b];a.set(c[1],[b,c])}for(b=0;256>b;b++)if(a.has(b)){const [c,d]=a.get(b);this[b]=this[c]=new cj(this.rom,d)}else this[b]=new Ug(this.rom,b)}static get [Symbol.species](){return Array}}
const pr={monsterClass:"BIRD"},qr={monsterClass:"BRAIN"},rr={monsterClass:"ENTITY"},sr={monsterClass:"EYE"},tr={monsterClass:"GOLEM"},ur={monsterClass:"JELLY"},vr={monsterClass:"MOSQUITO"},wr={monsterClass:"MUSHROOM"},xr={monsterClass:"PUDDLE"},yr={monsterClass:"SLIME"},zr={monsterClass:"SOLDIER"},Ar={monsterClass:"SPIDER"},Br={monsterClass:"WRAITH"},Cr={monsterClass:"WYVERN"},Dr={monsterClass:"ZOMBIE"},or=Object.assign({},{wraith1:["Wraith 1",75,28,Br],wraith2:["Wraith 2",79,28,Br],blueSlime:["Blue Slime",
80,1,yr],weretiger:["Weretiger",81,1],greenJelly:["Green Jelly",82,4,ur],redSlime:["Red Slime",83,4,yr],rockGolem:["Rock Golem",84,4,tr],blueBat:["Blue Bat",85,4],greenWyvern:["Green Wyvern",86,4,Cr],orc:["Orc",88,6],redMosquito:["Red Mosquito",89,10,vr],blueMushroom:["Blue Mushroom",90,10,wr],swampTomato:["Swamp Tomato",91,10],blueMosquito:["Blue Mosquito",92,23,vr],swampPlant:["Swamp Plant",93,10],largeBlueSlime:["Large Blue Slime",95,11,yr],iceZombie:["Ice Zombie",96,12,Dr],greenBrain:["Green Brain",
97,12,qr],greenSpider:["Green Spider",98,12,Ar],redWyvern:["Red Wyvern",99,12,Cr],soldier:["Soldier",100,14,zr],iceEntity:["Ice Entity",101,14,rr],redBrain:["Red Brain",102,14,qr],iceGolem:["Ice Golem",103,14,tr],largeRedSlime:["Large Red Slime",105,18,yr],troll:["Troll",106,18],redJelly:["Red Jelly",107,18,ur],medusa:["Medusa",108,19],crab:["Crab",109,19],medusaHead:["Medusa Head",110,20],bird:["Bird",111,20,pr],redMushroom:["Red Mushroom",113,21,wr],earthEntity:["Earth Entity",114,22,rr],mimic:["Mimic",
115,22],redSpider:["Red Spider",116,22,Ar],fishman:["Fishman",117,25],jellyfish:["Jellyfish",118,25],kraken:["Kraken",119,25],darkGreenWyvern:["Dark Green Wyvern",120,27,Cr],sandZombie:["Sand Zombie",121,38,Dr],wraithShadow1:["Wraith Shadow 1",123,28,Br],moth:["Moth",124,28,{difficulty:3}],archer:["Archer",128,33,zr],bomberBird:["Bomber Bird",129,33,pr],lavaBlob:["Lava Blob",130,37,xr],flailGuy:["Flail Guy",132,37],blueEye:["Blue Eye",133,37,sr],salamander:["Salamander",134,37],sorceror:["Sorceror",
135,37],mado1:["Mado 1",136,37],knight:["Knight",137,41,{difficulty:1}],devil:["Devil",138,41],wraitShadow2:["Wraith Shadow 2",140,41,Br],tarantula:["Tarantula",145,41],skeleton:["Skeleton",146,41],purpleEye:["Purple Eye",148,41,sr],flailKnight:["Flail Knight",149,41],scorpion:["Scorpion",150,41],sandBlob:["Sand Blob",152,44,xr],mummy:["Mummy",153,44],warlock:["Warlock",154,46],brownRobot:["Brown Robot",160,47,{difficulty:1}],whiteRobot:["White Robot",161,47],towerSentinel:["Tower Sentinel",162,47],
helicopter:["Helicopter",163,47]},{verticalPlatform:["Vertical Platform",126,28],horizotalPlatform:["Horizontal Platform",127,28],glitch1:["Glitch",141,41],glitch2:["Glitch",142,41],guardianStatue:["Guardian Statue",143,41],statueOfSun:["Statue of Sun",156,47],statueOfMoon:["Statue of Moon",157,47],crumblingVerticalPlatform:["Crumbling Vertical Platform",159,47],glitch3:["Glitch",166,41]},{vampire1:["Vampire 1",87,5],giantInsect:["Giant Insect",94,11],kelbesque1:["Kelbesque 1",104,15],sabera1:["Sabera 1",
125,29],kelbesque2:["Kelbesque 2",139,41],sabera2:["Sabera 2",144,41],mado2:["Mado 2",147,41],karmine:["Karmine",151,41],draygon1:["Draygon 1",155,45],draygon2:["Draygon 2",158,47],dyna:["Dyna",164,47],vampire2:["Vampire 2",165,28],dynaPod:["Dyna Pod",180,47]},{sorcerorShot:["Sorceror Shot",63,37],paralysisPowderSource:["Paralysis Powder Source",77,23],dynaCounter:["Dyna Counter",184,47],dynaLaser:["Dyna Laser",185,47],dynaBubble:["Dyna Bubble",186,47],vampire2Bat:["Vampire 2 Bat",188,28],brownRobotLaserSource:["Brown Robot Laser Source",
190,47],draygon2Fireball:["Draygon 2 Fireball",191,47],vampire1Bat:["Vampire 1 Bat",193,5],giantInsectFireball:["Giant Insect Fireball",195,11],greenMosquito:["Green Monsquito",196,11],kelbesque1Rock:["Kelbesque 1 Rock",197,15],sabera1Balls:["Sabera 1 Balls",198,29],kelbesque2Fire:["Kelbesque 2 Fire",199,41],sabera2Fire:["Sabera 2 Fire",200,41],sabera2Balls:["Sabera 2 Balls",201,41],karmineBalls:["Karmine Balls",202,41],statueBalls:["Statue Balls",203,47],draygon1Lightning:["Draygon 1 Lightning",
204,45],draygon2Laser:["Draygon 2 Laser",205,47],draygon2Breath:["Draygon 2 Breath",206,47],birdBomb:["Bird Bomb",224,33],greenMosquitoShot:["Green Mosquito Shot",226,11],paralysisBeam:["Paralysis Beam",227,25],stoneGaze:["Stone Gaze",228,19],rockGolemRock:["Rock Golem Rock",229,4],curseBeam:["Curse Beam",230,41],mpDrainWeb:["MP Drain Web",231,41],fishmanTrident:["Fishman Triden",232,25],orcAxe:["Orc Axe",233,6],swampPollen:["Swamp Pollen",234,10],paralysisPowder:["Paralysis Powder",235,23],soldierSword:["Soldier Sword",
236,14],iceGolemRock:["Ice Golem Rock",237,14],trollAxe:["Troll Axe",238,18],krakenInk:["Kraken Ink",239,25],archerArrow:["Archer Arrow",240,33],knightSword:["Knight Sword",242,41],mothResidue:["Moth Residue",243,28],brownRobotLaser:["Brown Robot Laser",244,47],whiteRobotLaser:["White Robot Laser",245,47],towerSentinelLaser:["Tower Sentinel Laser",246,47],skeletonShot:["Skeleton Shot",247,41],blobShot:["Blob Shot",248,37],flailKnightFlail:["Flail Knight Flail",249,41],flailGuyFlail:["Flail Guy Flail",
250,37],madoShuriken:["Mado Shuriken",252,37],guardianStatueMissile:["Guardian Statue Missile",253,36],demonWallFire:["Demon Wall Fire",254,37]});var Er;(function(a){a.bit=(a,c)=>new Fr(a,c);a.byte=(a)=>new Gr(a);a.address=(a)=>new Hr(a)})(Er||(Er={}));class Fr{constructor(a,b){this.address=a;this.bit=b}get(a){return!!(a[this.address]&1<<this.bit)}set(a,b){const c=1<<this.bit;a[this.address]=b?a[this.address]|c:a[this.address]&~c}}class Gr{constructor(a){this.address=a}get(a){return a[this.address]}set(a,b){a[this.address]=b&255}}
class Hr{constructor(a){this.address=a}get(a){return a[this.address]<<16|a[this.address+1]<<8|a[this.address+2]}set(a,b){a[this.address]=b>>>16&255;a[this.address+1]=b>>>8&255;a[this.address+2]=b&255}}var Ir=Er;class Jr extends mg{constructor(a,b){super(a,b);this.base=(b&3)<<2|(b&252)<<6|16624;this.colors=Id(a.prg,this.base,4)}color(a){return this.colors[a]&63}};class Kr extends mg{constructor(a,b,c){super(a,b);this.pixels=c||Id(a.chr,b<<4,16)}pixelAt(a,b){return(this.pixels[a|8]>>b&1)<<1|this.pixels[a]>>b&1}flipH(){return new Kr(this.rom,-1,this.pixels.map(Nd))}flipV(){return new Kr(this.rom,-1,v(16,(a)=>this.pixels[a&8|~a&7]))}flip(a){let b=this;a&Lr.HORIZONTAL&&(b=b.flipH());a&Lr.VERTICAL&&(b=b.flipV());return b}write(){const a=this.id<<4;this.rom.chr.subarray(a,a+16).set(this.pixels);return[]}}var Lr,Mr=Lr||(Lr={});Mr[Mr.HORIZONTAL=64]="HORIZONTAL";
Mr[Mr.VERTICAL=128]="VERTICAL";class Nr{constructor(a){this.rom=a;this.values=Id(a.prg,Or.offset,64)}write(){const a=this.rom.assembler();Or.loc(a);a.byte(...this.values);return[a.module()]}}const Or=ie.of(z.$1a,38884);const {$0d:Pr,$fe:Qr,$ff:Rr}=z;
class Sr{constructor(a){this.rom=a;this.patk=Array(48).fill(0);this.pdef=Array(48).fill(0);this.php=Array(48).fill(0);this.exp=Array(48).fill(0);this.setPAtkFormula((a)=>5+15*a/32);this.setPDefFormula((a)=>a);this.setPhpFormula((a)=>48+5.5*a);this.setExpScalingFactor(1)}setExpScalingFactor(a){this.setExpFormula((b)=>Math.floor(4*Math.pow(2,(16+9*b)/32)*a))}setPAtkFormula(a){this.patk=this.patk.map((b,c)=>Math.round(8*a(c)))}setPDefFormula(a){this.pdef=this.pdef.map((b,c)=>Math.round(4*a(c)))}setPhpFormula(a){this.php=
this.php.map((b,c)=>Math.min(255,Math.max(5,Math.round(a(c)))))}setExpFormula(a){this.exp=this.exp.map((b,c)=>{b=a(c);return 128>b?b:Math.min(255,128+(b>>4))})}write(){const a=this.rom.assembler();ke(a,[Pr,Qr,Rr],"DiffAtk");a.byte(...this.patk);ke(a,[Pr,Qr,Rr],"DiffDef");a.byte(...this.pdef);ke(a,[Pr,Qr,Rr],"DiffHP");a.byte(...this.php);ke(a,[Pr,Qr,Rr],"DiffExp");a.byte(...this.exp);return[a.module()]}};class Tr extends mg{constructor(a,b){super(a,b);this.used=!0;this.tiles=Id(a.prg,(255<b?64+b:b)<<8,240)}clone(a){a=new Tr(this.rom,a);a.used=this.used;a.tiles=[...this.tiles];return a}allTilesSet(){return new Set(this.tiles)}set2d(a,b){const c=a&15;a>>>=4;for(let d=0;d<b.length;d++){const e=b[d];for(let b=0;b<e.length;b++){const f=e[b];null!=f&&(this.tiles[a+d<<4|c+b]=f)}}}assemble(a){const b=this.id.toString(16).padStart(2,"0");let c=this.tiles;if(this.rom.compressedMapData||256>this.id){const b=
(this.id>>5).toString(16).padStart(2,"0");a.segment(b);"0a"===b&&(c=c.slice(192))}else a.segment("0a"),c=c.slice(0,192);a.org(32768|(this.id&63)<<8,`Screen_${b}`);a.byte(...c)}}
class Ur extends Array{constructor(a){super(259);this.rom=a;this.unallocated=[];for(let b=0;259>b;b++)this[b]=new Tr(a,b)}getScreen(a){const b=0>a?this.unallocated:this,c=0>a?~a:a;return b[c]||(b[c]=new Tr(this.rom,a))}setScreen(a,b){(0>a?this.unallocated:this)[0>a?~a:a]=b}deleteScreen(a){delete (0>a?this.unallocated:this)[0>a?~a:a]}write(){const a=this.rom.assembler();for(const b of this)(null===b||void 0===b?0:b.used)&&b.assemble(a);return[a.module()]}};const {$0e:Vr}=z;class Wr extends Array{constructor(a){super(128);this.rom=a;for(a=0;128>a;a++)this[a]=a}swap(a,b){if(a!==b){var c=this[a];this[a]=this[b];this[b]=c}}write(){const a=this.rom.assembler();ke(a,[Vr],"CheckToItemGetMap");a.byte(...this);return[a.module()]}};const {$0e:Xr,$fe:Yr,$ff:Zr}=z;var $r,as=$r||($r={});as[as.TORNEL=0]="TORNEL";as[as.ZEBU=1]="ZEBU";as[as.ASINA=2]="ASINA";as[as.KENSU=3]="KENSU";var bs,cs=bs||(bs={});cs[cs.INSUFFICIENT_MAGIC=0]="INSUFFICIENT_MAGIC";cs[cs.FREE_MAGIC=1]="FREE_MAGIC";cs[cs.IGNORED=2]="IGNORED";cs[cs.DEFAULT=3]="DEFAULT";
class ds{constructor(a){this.rom=a;this.sages=v(4,(a)=>new es(this,a));this.resultTable=Id(a.prg,115247,64);a.telepathyTablesAddress?(this.groupsByLocation=[],this.minimumLevels=[]):(this.groupsByLocation=Id(a.prg,121076,256),this.minimumLevels=Id(a.prg,115219,7))}write(){var a=this.rom.telepathyTablesAddress;const b=this.rom.assembler();b.segment(Xr.name,Yr.name,Zr.name);if(a)for(je(b,Xr,39156,39680),a=this.sages.map((a,c)=>{b.reloc(`Telepathy_Sage_${c}`);c=b.pc();b.byte(...a.messageGroups[0].bytes());
return c}),b.org(33327,"Telepathy_ResultTable"),b.byte(...this.resultTable.map((a)=>4>a?a:a>>>1)),b.reloc("TelepathyTable"),b.export("TelepathyTable"),b.label("TelepathyTable"),b.word(...a),a=1;4>a;a++)for(var c=0;4>c;c++)b.byte(...this.sages[c].defaultMessages[a].data);else{je(b,Xr,39500,39680);b.org(33327,"Telepathy_ResultTable");b.byte(...this.resultTable);b.org(33299,"Telepathy_LevelsTable");b.byte(...this.minimumLevels);b.org(39156,"Telepathy_LocationTable");b.byte(...this.groupsByLocation);
b.org(39468,"Telepathy_VanillaDefaultsTable");for(a=0;4>a;a++)for(c=0;4>c;c++)b.byte(...this.sages[c].defaultMessages[a].data);a=[];for(c=0;4>c;c++){const d=this.sages[c];for(let e=0,f=d.messageGroups.length;e<f;e++)b.reloc(`Telepathy_Sage_${c}_Group_${e}`),a[4*e+c]=b.pc(),b.byte(...d.messageGroups[e].bytes())}b.org(39412,"Telepathy_VanillaMainTable");b.word(...a)}return[b.module()]}}
class es{constructor(a,b){this.telepathy=a;this.sage=b;const c=a.rom;let d,e;c.telepathyTablesAddress?(e=d=c.telepathyTablesAddress+2*b,a=1):(d=121388+2*b,e=121332+2*b,a=7);this.defaultMessages=v(4,(a)=>x.from(c.prg,d+8*a));this.messageGroups=v(a,(a)=>fs.from(c.prg,e+8*a))}}
class fs{constructor(a){this.messages=a}bytes(){const a=[];for(let b=0,c=this.messages.length;b<c;b++){const [d,e,f]=this.messages[b];let g=0<=d?d:8192|~d;b===c-1&&(g|=32768);f&&(g|=16384);a.push(g>>=8,g&255,...e.data,...f?f.data:[])}return a}static from(a,b){const c=new fs([]);b=Qd(a,b)+81920;let d=0;for(;!(d&32768);){d=Pd(a,b);b+=2;var e=d&8191;d&8192&&(e=~e);e=[e,x.from(a,b)];b+=2;d&16384&&(e.push(x.from(a,b)),b+=2);c.messages.push(e)}return c}};class gs extends mg{constructor(a,b){super(a,b);this.base=255865+(b<<3);this.pages=Id(a.prg,this.base,8)}};class hs extends mg{constructor(a,b){super(a,b);this.effects=Id(a.prg,this.base,256)}get base(){return this.id<<8&8191|73728}get org(){return this.id<<8&8191|40960}write(){const a=this.rom.assembler();a.segment("09","fe","ff");a.org(this.org,`TileEffects_${this.id.toString(16)}_Tiles`);a.byte(...this.effects);return[a.module()]}}hs.PIT=1;hs.NO_WALK=2;hs.IMPASSIBLE=4;hs.ALTERNATIVE=8;hs.BEHIND=16;hs.SLOPE=32;hs.SLOW=64;hs.PAIN=128;class is{constructor(a,b){this.tileset=a;this.id=b;this.copiedFrom=-1}get tiles(){return[0,1,2,3].map((a)=>this.tileset.tiles[a][this.id])}setTiles(a){for(let b=0;4>b;b++){const c=a[b];null!=c&&(this.tileset.tiles[b][this.id]=c)}return this}get alternative(){const a=32>this.id?this.tileset.alternates[this.id]:this.id;return a!==this.id?a:null}setAlternative(a){if(32<=this.id)return this;this.tileset.alternates[this.id]=null!=a?a:this.id;this.tileset.effects().effects[this.id]|=8;return this}get attrs(){return this.tileset.attrs[this.id]}setAttrs(a){this.tileset.attrs[this.id]=
a;return this}get effects(){return this.tileset.effects().effects[this.id]}setEffects(a){this.tileset.effects().effects[this.id]=a;return this}copyFrom(a){const b=new is(this.tileset,a);this.copiedFrom=a;this.setTiles(b.tiles);32>(this.id|b.id)&&this.setAlternative(b.alternative);this.setAttrs(b.attrs);this.setEffects(b.effects);return this}replaceIn(...a){if(0>this.copiedFrom)throw Error("Must copyFrom first.");for(const b of a)b.replace(this.copiedFrom,this.id);return this}};class js{constructor(a){this.rom=a;this.tilesets=[];for(let b=128;176>b;b+=4)this.tilesets.push(this[b]=new ks(a,b))}[Symbol.iterator](){return this.tilesets[Symbol.iterator]()}}
class ks extends mg{constructor(a,b){super(a,b);this.tiles=v(4,(b)=>Id(a.prg,this.tileBase|b<<8,256));this.attrs=v(256,(b)=>a.prg[this.attrBase|b>>2]>>((b&3)<<1)&3);this.alternates=Id(a.prg,this.alternatesBase,32)}get map(){return this.id&63}get tileBase(){return 65536|this.map<<8}get attrBase(){return 77824|this.map<<4}get alternatesBase(){return 81408|this.map<<3}getTile(a){return new is(this,a)}write(){const a=v(64,(a)=>{a<<=2;return this.attrs[a]&3|(this.attrs[a+1]&3)<<2|(this.attrs[a+2]&3)<<
4|(this.attrs[a+3]&3)<<6}),b=this.rom.assembler(),c=`Tileset_${this.id.toString(16).padStart(2,"0")}`;b.segment("08","09");b.org(32768|this.map<<8,`${c}_Tiles`);b.byte(...[].concat(...this.tiles));b.org(45056|this.map<<4,`${c}_Attrs`);b.byte(...a);b.org(48640|this.map<<3,`${c}_Alternates`);b.byte(...this.alternates);return[b.module()]}effects(){let a=this.id>>>2&15;168===this.id&&(a=2);172===this.id&&a--;return this.rom.tileEffects[a]}};class ls{constructor(a){this.rom=a;this.locations=Id(a.prg,ms.offset,12);this.thunderSwordWarp=[a.prg[251338],a.prg[251342]]}write(){const a=this.rom.assembler();ms.loc(a);a.label("TownWarpTable");a.byte(...this.locations);a.org(56460);a.instruction("lda","TownWarpTable,y");a.org(54729);a.instruction("lda","#"+this.thunderSwordWarp[0]);a.org(54733);a.instruction("lda","#"+this.thunderSwordWarp[1]);return[a.module()]}}const ms=ie.of(z.$fe,56408);const ns=new Set([131,135,136,137,143,147,150,152,155,156,157,158,159,170,179,181,185,190,192]);
class os extends mg{constructor(a,b){super(a,b);this.used=!ns.has(b);this.pointer=123258+((b&127)<<1);this.base=Ld(a.prg,this.pointer,81920);this.conditions=[];this.message=x.of({});this.flags=[];let c=this.base;do{b=Pd(a.prg,c);var d=b&4095;this.conditions.push(b&8192?~d:d);c+=2}while(!(b&32768));this.message=x.from(a.prg,c);do c+=2,b=Pd(a.prg,c),d=b&4095,this.flags.push(b&32768?~d:d);while(!(b&16384))}bytes(){const a=[];this.conditions.length||this.conditions.push(-1);for(var b=0;b<this.conditions.length;b++){var c=
this.conditions[b];0>c&&(c=~c|8192);b===this.conditions.length-1&&(c|=32768);a.push(c>>>8,c&255)}a.push(...this.message.data);this.flags.length||this.flags.push(-1);for(b=0;b<this.flags.length;b++)c=this.flags[b],0>c&&(c=~c|32768),b===this.flags.length-1&&(c|=16384),a.push(c>>>8,c&255);return a}write(){if(!this.used)return[];const a=this.rom.assembler(),b=`Trigger_${w(this.id)}`;a.segment("0f");a.reloc(b);const c=a.pc();a.byte(...this.bytes());a.org(41338+2*(this.id&127),b+"_Ptr");a.word(c);return[a.module()]}}
;class ps{constructor(a){this.rom=a;this.locations=Id(a.prg,qs.offset,16)}write(){const a=this.rom.assembler();qs.loc(a);a.label("WildWarpLocations");a.byte(...this.locations);a.org(52185);a.instruction("lda","WildWarpLocations,y");return[a.module()]}}const qs=ie.of(z.$fe,52204);const {$0e:rs,$0f:ss,$10:ts}=z;
class us{constructor(a){this.modules=[];const b=16+(a[6]&4?512:0),c=b+16384*a[4];this.prg=a.subarray(b,c);this.chr=a.subarray(c);this.shopCount=us.SHOP_COUNT.get(a);this.scalingLevels=us.SCALING_LEVELS.get(a);this.uniqueItemTableAddress=us.UNIQUE_ITEM_TABLE.get(a);this.shopDataTablesAddress=us.SHOP_DATA_TABLES.get(a);this.telepathyTablesAddress=us.TELEPATHY_TABLES.get(a);this.omitItemGetDataSuffix=us.OMIT_ITEM_GET_DATA_SUFFIX.get(a);this.omitLocalDialogSuffix=us.OMIT_LOCAL_DIALOG_SUFFIX.get(a);this.compressedMapData=
us.COMPRESSED_MAPDATA.get(a);for(const a of vs){const [b,c,d]=a;this.prg[b]===c&&(this.prg[b]=d)}this.tilesets=new js(this);this.tileEffects=v(11,(a)=>new hs(this,a+179));this.screens=new Ur(this);this.metatilesets=new ir(this);this.metascreens=new gr(this);this.triggers=v(67,(a)=>new os(this,128|a));this.patterns=v(this.chr.length>>4,(a)=>new Kr(this,a));this.palettes=v(256,(a)=>new Jr(this,a));this.locations=new kk(this);this.tileAnimations=v(4,(a)=>new gs(this,a));this.hitboxes=v(24,(a)=>new kq(this,
a));this.objects=new nr(this);this.adHocSpawns=v(96,(a)=>new Wl(this,a));this.metasprites=v(256,(a)=>new hr(this,a));this.messages=new Bq(this);this.telepathy=new ds(this);this.itemGets=new sq(this);this.items=new cl(this);this.shops=new og(this);this.slots=new Wr(this);this.npcs=new vk(this);this.bossKills=v(14,(a)=>new Xl(this,a));this.wildWarp=new ps(this);this.townWarp=new ls(this);this.coinDrops=new Wp(this);this.flags=new iq(this);this.bosses=new Tp(this);this.scaling=new Sr(this);this.randomNumbers=
new Nr(this);for(const a of this.locations)a.used&&a.lazyInitialization()}trigger(a){if(128>a||255<a)throw Error(`Bad trigger id $${w(a)}`);return this.triggers[a&127]}get projectiles(){const a=new Set;for(const b of this.objects.filter((a)=>a instanceof cj))b.child&&a.add(this.objects[this.adHocSpawns[b.child].objectId]);return[...a].sort((a,c)=>a.id-c.id)}get monsterGraphics(){const a={};for(const b of this.locations)if(b.used&&b.hasSpawns)for(const c of b.spawns)if(!(c.data[2]&7)){const d=c.data[2]&
128?1:0,e=w(c.data[3]+80);(a[e]=a[e]||{})[`${d}:${b.spritePatterns[d].toString(16)}:${b.spritePalettes[d].toString(16)}`]={pal:b.spritePalettes[d],pat:b.spritePatterns[d],slot:d}}return a}get locationMonsters(){const a={};for(const b of this.locations){if(!b.used||!b.hasSpawns)continue;const c=a["$"+w(b.id)]={};for(const a of b.spawns)if(!(a.data[2]&7)){const b=a.data[2]&128?1:0,d=a.data[3]+80;c[`${b}:${d.toString(16)}`]=(c[`${b}:${d.toString(16)}`]||0)+1}}return a}assembler(){return new Zb}writeData(a){a=
void 0===a?this.prg:a;var b,c=this.assembler();je(c,rs,34682,35165);je(c,rs,35557,39156);je(c,rs,40422,40960);je(c,ss,40960,41222);je(c,ss,41472,41920);je(c,ts,37146,37992);const d=[...this.modules,c.module()];c=(a)=>{for(const b of a)d.push(...b.write())};d.push(...this.locations.write());c(this.objects);c(this.hitboxes);c(this.triggers);d.push(...this.npcs.write());c(this.tilesets);c(this.tileEffects);c(this.adHocSpawns);d.push(...this.itemGets.write());d.push(...this.slots.write());d.push(...this.items.write());
d.push(...this.shops.write());c(this.bossKills);c(this.patterns);d.push(...this.wildWarp.write());d.push(...this.townWarp.write());d.push(...this.coinDrops.write());d.push(...this.scaling.write());d.push(...this.bosses.write());d.push(...this.randomNumbers.write());d.push(...this.telepathy.write());d.push(...this.messages.write());d.push(...this.screens.write());c=new sc;c.base(this.prg,0);for(const a of d)c.read(a);c.link().apply(a);a===this.prg&&(a=c.exports(),this.uniqueItemTableAddress=a.get("KeyItemData").offset,
this.shopCount=11,this.shopDataTablesAddress=(null===(b=a.get("ShopData"))||void 0===b?void 0:b.offset)||0,us.SHOP_COUNT.set(this.prg,this.shopCount),us.SCALING_LEVELS.set(this.prg,this.scalingLevels),us.UNIQUE_ITEM_TABLE.set(this.prg,this.uniqueItemTableAddress),us.SHOP_DATA_TABLES.set(this.prg,this.shopDataTablesAddress||0),us.OMIT_ITEM_GET_DATA_SUFFIX.set(this.prg,this.omitItemGetDataSuffix),us.OMIT_LOCAL_DIALOG_SUFFIX.set(this.prg,this.omitLocalDialogSuffix),us.COMPRESSED_MAPDATA.set(this.prg,
this.compressedMapData))}analyzeTiles(){}disjointTilesets(){var a=[];for(var b of this.locations)if(b.used){var c=b.tileset;for(const d of b.screens)for(const b of d)(a[b]||(a[b]=new Set)).add(c)}b=v(256,()=>new yg);for(c=0;c<a.length;c++)if(a[c])for(var d of this.screens[c].allTilesSet())b[d].union([...a[c]]);for(a=0;a<b.length;a++)d=b[a].sets().map((a)=>[...a].map(w).join(" ")).join(" | "),console.log(`Tile ${w(a)}: ${d}`)}swapMetatiles(a,...b){var c=new Map,d=v(256);const e=new Map,f=(a)=>Array.isArray(a)?
a[0]:0>a?~a:a;for(var g of b){for(var h=0;h<g.length-1;h++)if(Array.isArray(g[h])){var k=g[h];e.set(k[0],k[1]);g[h]=k[0]}for(h=0;h<g.length-1;h++){k=g[h];const a=g[h+1];0>k||0>a||(c.set(a,k),d[a]=k)}}g=new Set;c=new Set;a=new Set(a);for(var p of this.locations)if(p.used&&a.has(p.tileset)){c.add(p.tileEffects);for(var m of p.allScreens())g.add(m)}for(var u of g)for(let a=0,b=u.tiles.length;a<b;a++)u.tiles[a]=d[u.tiles[a]];for(var y of a){d=this.tilesets[y];for(var G of b)for(p=0;p<G.length-1;p++){m=
f(G[p]);u=f(G[p+1]);for(a=0;4>a;a++)d.tiles[a][m]=d.tiles[a][u];d.attrs[m]=d.attrs[u];if(32>u&&d.alternates[u]!==u){if(32<=m)throw Error(`Cannot unflag: ${y} ${m} ${u} ${d.alternates[u]}`);d.alternates[m]=d.alternates[u]}}for(var A of e){const [a,b]=A;d.alternates[a]=b}}for(const a of c){y=this.tileEffects[a-179];for(const a of b)for(G=0;G<a.length-1;G++)A=f(a[G]),d=f(a[G+1]),y.effects[A]=y.effects[d];for(const a of e.keys())y.effects[a]|=8}}moveFlag(a,b){function c(c){for(let d=0;d<c.length;d++)c[d]===
a&&(c[d]=b),c[d]===~a&&(c[d]=~b)}for(const a of this.triggers)c(a.conditions),c(a.flags);for(const d of this.npcs){for(const a of d.spawnConditions.values())c(a);for(const c of[d.globalDialogs,...d.localDialogs.values()])for(const d of c)d.condition===a&&(d.condition=b),d.condition===~a&&(d.condition=~b)}if(512===(a&-256)&&512===(b&-256))for(const c of this.locations)for(const d of c.flags)d.flag===a&&(d.flag=b)}nextFreeTrigger(){for(const a of this.triggers)if(!a.used)return a;throw Error("Could not find an unused trigger.");
}moveScreens(a,b){if(!this.compressedMapData)throw Error("Must compress maps first.");const c=new Map;for(b<<=8;this.screens[b];)b++;for(var d of a)if(!(256<=d.sid)){var e=d.sid;if(!c.has(e)){var f=d.sid=b++;c.set(e,f);c.set(f,f)}}for(const g of this.locations)if(g.tileset==a.tilesetId){d=!1;b=!0;for(const a of g.screens)for(e=0;e<a.length;e++)f=c.get(a[e]),null!=f?(a[e]=f,d=!0):b=!1;if(d&&!b)throw Error("Inconsistent move");}}static load(a,b){return l.asyncExecutePromiseGeneratorFunction(function*(){const c=
yield ws(b);a&&(yield a(c));return new us(c)})}}us.OMIT_ITEM_GET_DATA_SUFFIX=Ir.bit(82624,0);us.OMIT_LOCAL_DIALOG_SUFFIX=Ir.bit(82624,1);us.COMPRESSED_MAPDATA=Ir.bit(82624,2);us.SHOP_COUNT=Ir.byte(82625);us.SCALING_LEVELS=Ir.byte(82626);us.UNIQUE_ITEM_TABLE=Ir.address(82640);us.SHOP_DATA_TABLES=Ir.address(82643);us.TELEPATHY_TABLES=Ir.address(82646);
function ws(a){a||(a=(a)=>document.body.appendChild(a));return new Promise((a)=>{if("#reset"!==window.location.hash){const b=localStorage.getItem("rom");if(b)return a(Uint8Array.from(Array(b.length/2).fill(0).map((a,c)=>Number.parseInt(b[2*c]+b[2*c+1],16))))}const b=document.createElement("input");document.body.appendChild(b);b.type="file";b.addEventListener("change",()=>{const c=b.files[0],e=new FileReader;e.addEventListener("loadend",()=>{const c=new Uint8Array(e.result),d=Array.from(c,w).join("");
localStorage.setItem("rom",d);b.remove();a(c)});e.readAsArrayBuffer(c)})})}
const vs=[[79430,2,6],[83272,86,80],[83306,0,255],[83343,56,48],[83480,96,112],[83494,168,160],[83507,21,22],[83511,21,22],[84305,168,160],[84307,152,144],[84505,120,112],[84715,9,255],[84809,128,136],[84871,32,48],[84890,1,2],[84894,1,2],[85433,8,128],[85750,104,96],[87133,255,0],[87145,120,112],[88070,152,160],[88074,152,160],[88078,88,80],[88093,0,255],[88142,219,255],[88181,120,112],[88911,120,128],[89007,240,128],[89014,223,128],[89015,150,128],[89315,223,207],[89326,110,109],[89330,110,109],
[89486,223,207],[89489,46,45],[89493,46,45],[89658,216,223],[89913,120,112],[89920,2,255],[89953,141,255],[89957,141,255],[91133,72,64],[91139,85,80],[91227,216,223],[91340,4,32],[91391,11,10],[91661,32,48],[91684,1,2],[91688,1,2],[93616,154,128],[93620,158,128],[93624,145,128],[93628,158,128],[93632,145,128],[93672,0,255],[93677,223,208],[93688,12,92],[93689,176,185],[93690,0,2],[93692,12,92],[93693,176,185],[93694,0,2],[93695,7,255],[93789,2,255],[93802,173,255],[93806,173,255],[95470,128,136],
[96193,136,128],[96197,152,160],[96199,88,80],[96298,16,1],[96343,16,1],[96596,128,120],[96674,128,120],[97162,0,64],[97168,0,64],[97230,0,64],[97236,0,64],[97294,0,64],[97300,0,64],[97358,0,64],[97364,0,64],[106242,64,128],[106243,51,50],[106976,64,192],[106977,61,52],[118533,71,72],[119569,32,160],[119570,48,0],[118777,96,224],[182928,2,0],[193907,2,0],[195300,95,0]];class xs{constructor(a){this.rom=a;this.slots=[];this.route=[];this.mazes=[];this.trades=[];this.walls=[];this.unidentifiedItems=[];this.wildWarps=[];this.flags=""}addCheck(a,b){this.route.push(new ys(this,a,b))}addSlot(a,b,c){this.slots[a&255]=new zs(this.rom,a&255,b,c&255)}addMaze(a,b,c){this.mazes.push({id:a,name:b,maze:c})}addTrade(a,b,c){this.trades.push({itemId:a,item:b,npc:c})}addUnidentifiedItem(a,b,c){this.unidentifiedItems.push({itemId:a,oldName:b,newName:c})}addWall(a,b,c){this.walls.push({location:a,
oldElement:b,newElement:c})}addWildWarp(a,b){this.wildWarps.push({id:a,name:b})}formatCondition(a){var b;return null===(b=this.rom.flags[a])||void 0===b?void 0:b.name}formatConditionList(a){const b=[];for(const c of a)a=this.rom.flags[c],(null===a||void 0===a?0:a.logic.track)&&b.push(a.name);return b.join(", ")}}
class ys{constructor(a,b,c){this.spoiler=a;this.condition=b;this.deps=c}toString(){let a=0;256===(this.condition&-128)&&(a=512|this.spoiler.rom.slots[this.condition&255]);return`${this.spoiler.formatCondition(this.condition)}${a?` (${this.spoiler.formatCondition(a)})`:""}: [${this.spoiler.formatConditionList(this.deps)}]`}}
class zs{constructor(a,b,c,d){this.slot=b;this.slotName=c;this.item=d;this.itemName=112<=d?"Mimic":a.items[a.itemGets[d].itemId].messageName;this.originalItem=112<=b?"Mimic":a.items[a.itemGets[b].itemId].messageName}toString(){return`${this.itemName}: ${this.slotName} (${this.originalItem})`}};const As="object"===typeof __VERSION__?__VERSION__:{},Bs=As.STATUS||"unstable",Cs=As.VERSION||"HEAD",Ds=As.LABEL||"HEAD",Es=As.HASH||"HEAD",Fs=As.DATE||new Date;function Gs(a){return a?/^[0-9a-f]{1,8}$/i.test(a)?Number.parseInt(a,16):qa(a):Ul.newSeed()}
function Hs(a,b){const c={_ALLOW_TELEPORT_OUT_OF_BOSS:a.hardcoreMode()&&a.shuffleBossElements(),_ALLOW_TELEPORT_OUT_OF_TOWER:!0,_AUTO_EQUIP_BRACELET:a.autoEquipBracelet(b),_BARRIER_REQUIRES_CALM_SEA:!0,_BUFF_DEOS_PENDANT:a.buffDeosPendant(),_BUFF_DYNA:a.buffDyna(),_CHECK_FLAG0:!0,_CTRL1_SHORTCUTS:a.controllerShortcuts(b),_CUSTOM_SHOOTING_WALLS:!0,_DISABLE_SHOP_GLITCH:a.disableShopGlitch(),_DISABLE_STATUE_GLITCH:a.disableStatueGlitch(),_DISABLE_SWORD_CHARGE_GLITCH:a.disableSwordChargeGlitch(),_DISABLE_TRIGGER_SKIP:!0,
_DISABLE_WARP_BOOTS_REUSE:a.disableShopGlitch(),_DISABLE_WILD_WARP:!1,_DISPLAY_DIFFICULTY:!0,_EXTRA_EXTENDED_SCREENS:!0,_EXTRA_PITY_MP:!0,_FIX_COIN_SPRITES:!0,_FIX_OPEL_STATUE:!0,_FIX_SHAKING:!0,_FIX_VAMPIRE:!0,_HARDCORE_MODE:a.hardcoreMode(),_HAZMAT_SUIT:a.changeGasMaskToHazmatSuit(),_LEATHER_BOOTS_GIVE_SPEED:a.leatherBootsGiveSpeed(),_MAX_SCALING_IN_TOWER:a.maxScalingInTower(),_NERF_FLIGHT:!0,_NERF_MADO:!0,_NEVER_DIE:a.neverDie(),_NORMALIZE_SHOP_PRICES:a.shuffleShops(),_PITY_HP_AND_MP:!0,_PROGRESSIVE_BRACELET:!0,
_RABBIT_BOOTS_CHARGE_WHILE_WALKING:a.rabbitBootsChargeWhileWalking(),_REQUIRE_HEALED_DOLPHIN_TO_RIDE:a.requireHealedDolphinToRide(),_REVERSIBLE_SWAN_GATE:!0,_SAHARA_RABBITS_REQUIRE_TELEPATHY:a.saharaRabbitsRequireTelepathy(),_SIMPLIFY_INVISIBLE_CHESTS:!0,_SOFT_RESET_SHORTCUT:!0,_TELEPORT_ON_THUNDER_SWORD:a.teleportOnThunderSword(),_TRAINER:a.trainer(),_TWELVTH_WARP_POINT:!0,_UNIDENTIFIED_ITEMS:a.unidentifiedItems(),_ZEBU_STUDENT_GIVES_ITEM:!0};return Object.keys(c).filter((a)=>c[a]).map((a)=>`.define ${a} 1\n`).join("")}
function Is(a,b,c,d,e,f){return l.asyncExecutePromiseGeneratorFunction(function*(){function g(a){return l.asyncExecutePromiseGeneratorFunction(function*(){function b(a){return l.asyncExecutePromiseGeneratorFunction(function*(){return new Kb(yield d.read(a),a,{lineContinuations:!0})})}var e=Hs(c,a);const f=new Zb(Ya.P02),g=new Sc;g.enter(cb.concat(new Kb(e,"flags.s"),yield b("init.s"),yield b("preshuffle.s"),yield b("postparse.s"),yield b("postshuffle.s")));e=new Oc(g,f);f.tokens(e);return f.module()})}
var h=16+(a[6]&4?512:0)+(a[4]<<14)+(a[5]<<13);a.length>h&&(a=a.slice(0,h));524288>a.length&&(h=new Uint8Array(a.length+262144),h.subarray(0,262160).set(a.subarray(0,262160)),h.subarray(524304).set(a.subarray(262160)),h[4]<<=1,a=h);if("number"!==typeof b)throw Error("Bad seed");h=qa(b.toString(16).padStart(8,"0")+String(c.filterOptional()))>>>0;h=new Ul(h);const k=String(c);c=c.filterRandom(h);var p=String(c);Kk(a.subarray(16));const m=new us(a);m.flags.defrag();"object"==typeof window&&(window.rom=
m);m.spoiler=new xs(m);e&&(e.spoiler=m.spoiler);p!==k&&(m.spoiler.flags=p);Lk(m,c);zj(m);Ml(m,Ml.generateOptions(c,h));m.scalingLevels=48;c.shuffleShops()&&Js(m,c,h);c.shuffleGoaFloors()&&wl(m,h);Ks(m,c,h);pk(m,h);c.nerfWildWarp()&&m.wildWarp.locations.fill(0);c.randomizeWildWarp()&&Ls(m,c,h);c.randomizeThunderTeleport()&&pl(m,h);ql(m,c,h);Rl(m,c,h);el(m,c,h);c.randomizeMaps()&&xl(m,c,h);Sl(m);zl(m,h);c.shuffleMimics()&&yl(m,c,h);c.shuffleMonsters()&&Cl(m,c,h);ok(m);m.moveScreens(m.metatilesets.house,
4);p=new zg(m,c);if(p=yield(new Ze([p.getLocationList()])).shuffle(c,h,void 0,f,m.spoiler))for(var u of p){const [a,b]=u;m.slots[a&255]=b&255}else return[a,-1];c.shuffleShops()&&Ms(m,c.bargainHunting()?h:void 0);c.buffMedicalHerb()&&(m.items.MedicalHerb.value=80,m.items.FruitOfPower.value=56);c.storyMode()&&Ns(m);c.blackoutMode()&&Os(m);Ps(m,c,h);gl(m);ml(m);c.buffDyna()&&Qs(m,c);c.trainer()&&(m.wildWarp.locations=[10,26,53,72,109,110,140,170,172,176,182,159,166,88,92,0]);c.randomizeMusic("early")&&
Rs(m,c,h);c.shuffleTilePalettes("early")&&(new Il(m,c,h)).shuffle();Ss(m,c);h.shuffle(m.randomNumbers.values);m.messages.compress();u=a.slice(16);m.modules.push(yield g("early"));m.writeData(u);m.modules.pop();m.modules.push(yield g("late"));u=Ts(a,b,k,u);c.randomizeMusic("late")&&Rs(m,c,h);c.noMusic("late")&&Us(m);c.shuffleTilePalettes("late")&&(new Il(m,c,h)).shuffle();nl(m);m.writeData();h=a.subarray(16);h.subarray(507904,524288).set(h.subarray(245760,262144));return[a,u]})}
function Ps(a){a.messages.parts[2][2].text="\n{01:Akahana} is handed a statue.#\nThanks for finding that.\nI was totally gonna sell\nit for tons of cash.#\nHere, have this lame\n[29:Gas Mask] or something.";a.messages.parts[0][14].text="It's dangerous to go alone! Take this.";a.messages.parts[0][14].fixText()}
function Js(a,b,c){b={[xg.ARMOR]:{contents:[],shops:[]},[xg.TOOL]:{contents:[],shops:[]}};for(var d of a.shops)d.used&&255!==d.location&&(a=b[d.type])&&(a.contents.push(...d.contents.filter((a)=>255!==a)),a.shops.push(d),d.contents=[]);for(const e of Object.values(b))for(d=null,a=[...e.contents],c.shuffle(a);a.length;){d&&d.length||(d&&a.shift(),d=[...e.shops,...e.shops,...e.shops,...e.shops],c.shuffle(d));const b=a[0],g=d[0];4>g.contents.length&&!g.contents.includes(b)&&(g.contents.push(b),a.shift());
d.shift()}for(const a of Object.values(b))for(const b of a.shops){for(;4>b.contents.length;)b.contents.push(255);b.contents.sort((a,b)=>a-b)}}
function Ks(a,b,c){if(b.randomizeWalls()){b=[[5,56],[17],[106],[20]];var d=new n(()=>[]);for(var e of a.locations)d.get(e.data.area).push(e);for(const g of d.values()){e=c.nextInt(4);d=c.pick(b[e]);let h=!1;for(const b of g)for(const g of b.spawns)if(g.isWall()){var f=g.data[2]&32?g.id>>>4&3:g.id&3;if(2!==f)if(3===f){const d=c.nextInt(4);a.spoiler&&a.spoiler.addWall(b.name,f,d);g.data[2]|=32;g.id=48|d}else!h&&a.spoiler&&(a.spoiler.addWall(b.name,f,e),h=!0),g.data[2]|=32,g.id=f<<4|e,b.tilePalettes[2]=
d}}}}function Us(a){for(const b of[...a.locations,...a.bosses.musics])b.bgm=0}function Rs(a,b,c){b=new n(()=>[]);const d=new Set;for(var e of a.locations){if(95===e.id||0===e.id||!e.used)continue;const a=e.musicGroup;d.add(e.bgm);b.get(a).push(e)}for(const c of a.bosses.musics)b.set(c,[c]),d.add(c.bgm);a=[...d];e=new Set;for(const d of b.values()){b=c.pick(a);for(const a of d)a.bgm=b,e.add(a)}}
function Ls(a,b,c){b=[];for(const c of a.locations)c&&c.used&&c.id&&!c.isShop()&&88!==(c.id&248)&&c!==a.locations.MesiaShrine&&c!==a.locations.LimeTreeLake&&b.push(c);c.shuffle(b);a.wildWarp.locations=[];for(const c of[...b.slice(0,15).sort((a,b)=>a.id-b.id)])a.wildWarp.locations.push(c.id),a.spoiler&&a.spoiler.addWildWarp(c.id,c.name);a.wildWarp.locations.push(0)}
function Qs(a){a.objects[184].collisionPlane=1;a.objects[184].immobile=!0;a.objects[185].collisionPlane=1;a.objects[185].immobile=!0;a.objects[51].collisionPlane=2;a.adHocSpawns[40].slotRangeLower=28;a.adHocSpawns[41].slotRangeUpper=28;a.adHocSpawns[42].slotRangeUpper=28}function Os(a){var b=Ue();for(const c of b.nodes)b=c.type,"Location"!==c.nodeType||"cave"!==b&&"fortress"!==b||a.locations[c.id].tilePalettes.fill(154)}
const Ns=(a)=>{const b=[a.flags.Kelbesque1.id,a.flags.Sabera1.id,a.flags.Mado1.id,a.flags.Kelbesque2.id,a.flags.Sabera2.id,a.flags.Mado2.id,a.flags.Karmine.id,a.flags.Draygon1.id,a.flags.SwordOfWind.id,a.flags.SwordOfFire.id,a.flags.SwordOfWater.id,a.flags.SwordOfThunder.id];a.npcs[203].spawnConditions.get(166).push(...b)};
function Ts(a,b,c,d){d=qa(d);const e=d.toString(16).padStart(8,"0").toUpperCase(),f="unstable"===Bs?Es.substring(0,7).padStart(7,"0").toUpperCase()+"     ":Cs.substring(0,12).padEnd(12," ");b=b.toString(16).padStart(8,"0").toUpperCase();const g=(b,c)=>{for(let d=0;d<c.length;d++)a[b+16+d]=c.charCodeAt(d)},h=(a,b)=>{const c=[];for(let d=0;d<a.length||d<b.length;d++)c.push(a[d]||" "),c.push(b[d]||" ");return c.join("")};g(161743,h("  VERSION     SEED      ",`  ${f}${b}`));let k;if(46<c.length){if(92<
c.length)throw Error("Flag string way too long!");k=c.substring(46,92).padEnd(46," ");c=c.substring(0,46)}c=c.padEnd(46," ");g(161791,h(c.substring(0,23),c.substring(23)));k&&g(161839,h(k.substring(0,23),k.substring(23)));g(161925,h(e.substring(0,4),e.substring(4)));g(153366,"RANDOMIZER");"unstable"===Bs&&g(153404,"BETA");return d}
function Ss(a,b){b.decreaseEnemyDamage()&&a.scaling.setPhpFormula((a)=>16+6*a);a.scaling.setExpScalingFactor(b.expScalingFactor());b.disableShopGlitch()?a.coinDrops.values=[0,5,10,15,25,40,65,105,170,275,445,600,700,800,900,1E3]:a.coinDrops.values=[0,1,2,4,8,16,30,50,100,200,300,400,500,600,700,800];a.items.CarapaceShield.defense=a.items.TannedHide.defense=3;a.items.PlatinumShield.defense=a.items.BronzeArmor.defense=9;a.items.MirroredShield.defense=a.items.PlatinumArmor.defense=13;a.items.PsychoArmor.defense=
a.items.PsychoShield.defense=20;a.items.CeramicSuit.defense=a.items.BattleShield.defense=32;a.items.CarapaceShield.defense=a.items.TannedHide.defense=2;a.items.PlatinumShield.defense=a.items.BronzeArmor.defense=10;a.items.MirroredShield.defense=a.items.PlatinumArmor.defense=14;a.items.BattleArmor.defense=24}
const Ms=(a,b)=>{for(const c of a.shops)if(c.type!==xg.PAWN)for(let a=0,e=c.prices.length;a<e;a++)c.prices[a]=128>c.contents[a]?b?b.nextNormal(1,.3,.5,1.5):1:c.type!==xg.INN?0:b?b.nextNormal(1,.5,.375,1.625):1;b=v(48,(a)=>a);a.shops.rescale=!0;a.shops.toolShopScaling=b.map((a)=>Math.round(8*Math.pow(2,a/10)));a.shops.armorShopScaling=b.map((a)=>Math.round(8*Math.pow(2,(47-a)/12)));for(b=13;39>b;b++)a.items[b].basePrice=Vs[b]},Vs={13:4,14:16,15:50,16:325,17:1E3,18:2E3,19:4E3,21:6,22:20,23:75,24:250,
25:1E3,26:4800,29:25,30:30,31:45,32:40,33:36,34:200,35:150,36:65,38:300};Array.prototype.flatMap||Object.defineProperties(Array.prototype,{flatMap:{value(a){const b=[];let c=0;for(const d of this){let e=a(d,c++);"function"!==typeof e[Symbol.iterator]&&(e=[e]);e=[...e];e.length&&b.push(...e)}return b}}});class Ws{constructor(){this.completed=this.tasks=0}addTasks(a){this.tasks+=a}addCompleted(a){this.completed+=a}value(){return this.tasks&&this.completed/this.tasks}};function Xs(a){let b=!0;for(const {name:d,flagString:e,description:f}of dd.all()){var c=document.createElement("h2");c.textContent=d;a.appendChild(c);c=document.createElement("p");c.innerHTML=f;a.appendChild(c);c=document.createElement("a");c.textContent=e;c.classList.add("button");c.classList.add("preset-flags");c.dataset.flags=e;b&&(c.dataset.defaultPreset="true");b=!1;a.appendChild(c)}}
function Ys(a){for(const {name:c,description:d,flags:e}of t.all()){var b=document.createElement("h2");b.textContent=c;a.appendChild(b);d&&(b=document.createElement("p"),b.innerHTML=d,a.appendChild(b));b=document.createElement("div");b.classList.add("flag-list");a.appendChild(b);for(const a of e.values()){const {flag:c,opts:{hard:d,name:e,text:f}}=a,m=document.createElement("div");m.textContent=`${c}: ${e}`;m.classList.add("checkbox");d&&m.classList.add("hard");if(f){const a=document.createElement("div");
a.classList.add("flag-body");a.innerHTML=f;m.appendChild(a)}b.appendChild(m)}}}
function Zs(a,b){for(const {name:c,description:d,flags:e}of t.all()){let f=!1;const g=document.createElement("h2");g.textContent=c;const h=d?document.createElement("p"):null;h&&(h.innerHTML=d);const k=document.createElement("div");k.classList.add("flag-list");for(const a of e.values()){const {flag:c,opts:{hard:d,name:e,text:g}}=a;if(!b.check(a))continue;f=!0;const h=document.createElement("div");h.textContent=`${c}: ${e}`;h.classList.add("checkbox");d&&h.classList.add("hard");if(g){const a=document.createElement("div");
a.classList.add("flag-body");a.innerHTML=g;h.appendChild(a)}k.appendChild(h)}f&&(a.appendChild(g),h&&a.appendChild(h),a.appendChild(k))}};let $s,at,bt,ct,dt=!1;window.global=window;const et="boolean"===typeof CR_PERMALINK&&CR_PERMALINK;function ft(a,...b){(window.ga||(()=>{}))("gtag_UA_131783670_1."+a,...b)}
const lt=()=>{gt();ht(!1);it();window.addEventListener("popstate",()=>{ht(!1)});document.body.addEventListener("click",jt);kt()},kt=()=>{if("latest"!==Es){const a=et?"":"Current version: ";for(const b of document.getElementsByClassName("version"))b.textContent=`${a}${Ds} (${Fs.toDateString()})`}document.body.classList.add("js-works");document.body.classList.remove("js-broken");"rc"==Bs?(document.body.classList.add("release-candidate"),document.body.classList.add("versioned")):"stable"==Bs&&document.body.classList.add("versioned")},
nt=()=>{const a=document.getElementById("seed"),b=()=>{at=a.value;mt()};a.addEventListener("keyup",b);a.addEventListener("change",b)},ht=()=>{for(const a of location.hash.substring(1).split("&")){let [b,c]=a.split("=");c=decodeURIComponent(c);"flags"===b&&($s=new fd(c));"seed"===b&&(at=decodeURIComponent(c));"race"===b&&document.body.classList.add("race");"debug"===b&&(dt=!0);for(const a of document.querySelectorAll("[data-flags]"))a.addEventListener("click",()=>{$s=new fd(a.dataset.flags);"unstable"==
Cs&&$s.set("Ds",!0);mt()})}};
function jt(a){return l.asyncExecutePromiseGeneratorFunction(function*(){for(var b=a.target,c=`${Ds}: ${$s}`,d=(new Date).getTime();b;){if("H1"===b.tagName&&b.parentElement.classList.contains("expandable")){b.parentElement.classList.toggle("expanded");break}else if("preset-apply"===b.id){ft("send","event","custom-preset");$s=new fd(document.getElementById("flagstring").value);mt();break}else if("new-seed"===b.id){ft("send","event","Main","new-seed");at=Math.floor(4294967296*Math.random()).toString(16);
mt();break}else if("generate"===b.id){ft("send","event","Main","generate",c);b=Gs(at);const [a,f]=yield ot(b);ft("send","timing","Main","generate",(new Date).getTime()-d,c);if(!a)break;c=ct.replace(/\.nes|$/,["_",b.toString(16).padStart(8,0),"_",f.toString(16).padStart(8,0),".nes"].join(""));b=a;d=document.createElement("a");document.body.appendChild(d);d.style="display: none";b=new Blob([b],{type:"octet/stream"});b=window.URL.createObjectURL(b);d.href=b;d.download=c;d.click();window.URL.revokeObjectURL(b);
d.remove();break}else if("spoiler"===b.id){ft("send","event","Main","spoiler",c);yield ot(Gs(at));ft("send","timing","Main","spoiler",(new Date).getTime()-d,c);break}b=b.parentElement}})}
const pt=(a,b,c)=>{const d=[];for(let e=0;e<c;e++)d.push(String.fromCharCode(a[b+2*e]));return d.join("")},ot=(a)=>l.asyncExecutePromiseGeneratorFunction(function*(){for(var b of document.getElementsByClassName("seed-out"))b.textContent=a.toString(16).padStart(8,"0");const c=document.getElementById("progress"),d=new Ws;b=bt.slice();let e=!1;const f=new fd(String($s));document.body.classList.add("shuffling");const g=$s.check("Ds")?{}:void 0,h=()=>{e||(c.value=d.value(),setTimeout(h,120))};h();let k;
try{[p,k]=yield Is(b,a,f,new Ve,g,d)}catch(m){document.body.classList.add("failure");var p=document.getElementById("error-text");p.textContent=m.stack;p.parentElement.parentElement.scrollIntoViewIfNeeded();document.getElementById("checksum").textContent="SHUFFLE FAILED!";throw m;}if(0>k)return document.getElementById("checksum").textContent="SHUFFLE FAILED!",[null,null];e=!0;document.body.classList.remove("shuffling");g&&g.spoiler&&(b=g.spoiler,b.flags&&qt("spoiler-flags",[b.flags]),qt("spoiler-items",
rt(b.slots.filter((a)=>a),(a)=>a.item)),qt("spoiler-route",b.route),qt("spoiler-mazes",rt(b.mazes,(a)=>a.location).map((a)=>{var {name:b,maze:c}=a;return`${b}:\n${c}`})),qt("spoiler-trades",b.trades.map((a)=>{var {item:b,npc:c}=a;return`${c}: ${b}`}).sort()),qt("spoiler-item-names",b.unidentifiedItems.map((a)=>{var {oldName:b,newName:c}=a;return`${c}: ${b}`}).sort()),qt("spoiler-walls",rt(b.walls,(a)=>a.location).map((a)=>{var {location:b,oldElement:c,newElement:d}=a;return`${b}${3===c?" (iron)":
""}: ${["wind","fire","water","thunder"][d]}`})),qt("spoiler-wild-warps",b.wildWarps.map((a)=>({name:a}=a))));document.getElementById("checksum").textContent=pt(p,161941,4)+pt(p,161942,4);return[p,k]});function rt(a,b){return[...a].sort((a,d)=>{a=b(a);d=b(d);return a<d?-1:a>d?1:0})}
const qt=(a,b)=>{for(a=document.getElementById(a);a.children.length;)a.lastChild.remove();for(const c of b){const b=document.createElement("li");b.textContent=c;a.appendChild(b)}a.previousElementSibling.classList.toggle("empty-spoiler",!b.length)},st=(a)=>{const b=a.getElementsByClassName("flag-body")[0];b&&b.remove();const [c,d]=a.textContent.split(/:\s*/),e=document.createElement("input");e.type="checkbox";e.id=`flag-${c}`;e.dataset.flag=c;e.dataset.mode="false";a.parentElement.insertBefore(e,a);
const f=document.createElement("label");f.textContent=c;f.htmlFor=e.id;a.parentElement.insertBefore(f,a);const g=document.createElement("div");a.parentElement.insertBefore(g,a);const h=document.createElement("label");h.textContent=d;h.htmlFor=e.id;g.appendChild(h);b&&g.appendChild(b);a.classList.contains("hard")&&(f.classList.add("hard"),h.classList.add("hard"),h.textContent+=" *");a.remove();e.addEventListener("change",()=>{window.FLAGS=$s;const a=$s.toggle(c);a?!0===a?(e.checked=!0,f.textContent=
c):(e.checked=!0,f.textContent=`${c[0]}${a}${c.substring(1)}`):(e.checked=!1,f.textContent=c);mt()})},mt=()=>{document.body.classList.remove("failure");for(var a of document.querySelectorAll("input[data-flag]")){var b=a.dataset.flag;const c=$s.get(b);a.checked=!1!==c;a.nextElementSibling.textContent=`${b[0]}${"boolean"===typeof c?"":c}${b.substring(1)}`}a=String($s).replace(/ /g,"");document.getElementById("seed").value=at||"";b=["#flags=",a];at&&b.push("&seed=",encodeURIComponent(at));dt&&b.push("&debug");
history.replaceState({flags:String($s),seed:at},"",String(window.location).replace(/#.*/,"")+b.join(""));if("stable"==Bs||"rc"==Bs)b=at||Math.floor(4294967296*Math.random()).toString(16),document.getElementById("race").href=`/${Cs}/race#flags=${a}&seed=${b}`;it()},it=()=>{const a=String($s);document.body.classList.toggle("spoiled",$s.check("Ds"));document.body.classList.toggle("debug-mode",/D/.test(a));for(const b of document.getElementsByClassName("flagstring-out"))b.textContent=a;document.getElementById("track-url").href=
`track#flags=${a.replace(/ /g,"")}`},gt=()=>{const a=window.localStorage.getItem("name"),b=window.localStorage.getItem("rom"),c=document.getElementById("pick-file"),d=()=>{document.body.classList.add("rom-uploaded");document.body.classList.toggle("rom-broken",466849842!=qa(bt))};a&&b&&(ct=a,bt=Uint8Array.from(Array(b.length/2).fill(0).map((a,c)=>Number.parseInt(b[2*c]+b[2*c+1],16))),d());c.addEventListener("change",()=>{const a=c.files[0],b=new FileReader;b.addEventListener("loadend",()=>{var c=new Uint8Array(b.result);
c=c.slice(0,16+(c[6]&4?512:0)+(c[4]<<14)+(c[5]<<13));c=Array.from(c,(a)=>a.toString(16).padStart(2,0)).join("");window.localStorage.setItem("rom",c);window.localStorage.setItem("name",a.name);d();ct=a.name});b.readAsArrayBuffer(a)})};
(()=>{et&&document.body.classList.add("permalink");if(null==document.getElementById("race")){lt();Zs(document.getElementById("flags"),$s);for(var a of[...document.getElementsByClassName("checkbox")])st(a);for(var b of document.querySelectorAll('.flag-list > input[type="checkbox"]'))b.checked=!0,b.disabled=!0}else{Xs(document.getElementById("presets"));Ys(document.getElementById("select-options"));gt();ht(!0);$s||document.querySelector("[data-default-preset]").click();for(const a of[...document.getElementsByClassName("checkbox")])st(a);
mt();nt();document.body.addEventListener("click",jt);window.addEventListener("popstate",(a)=>{a.state?($s=new fd(a.state.flags),at=a.state.seed):ht(!0)});dt&&(a=document.createElement("section"),a.classList.add("expandable"),b=document.createElement("h1"),b.textContent="Debug",a.appendChild(b),b=document.createElement("div"),b.id="debug",a.appendChild(b),document.querySelector("main").appendChild(a));kt()}})();}).call(this);
