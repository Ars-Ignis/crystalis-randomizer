import { hex } from '../rom/util.js';
import { buildTradeInMap } from './shuffletrades.js';
import { fail } from '../assert.js';
export function fixDialog(rom) {
    replaceMessage('03:06', ',', '');
    const tradeIns = buildTradeInMap(rom);
    const zebu = rom.npcs[0x5e];
    if (zebu.data[0] < 0x41)
        unmagic('00:1b');
    replaceMessage('00:1b', '[41:Refresh]', item(zebu.data[0]));
    const akahanaTradeIn = tradeIns.get(0x82);
    if (akahanaTradeIn) {
        replaceMessage('02:01', 'an unusual statue', vague(akahanaTradeIn));
        replaceMessage('02:02', 'a statue', `the ${commonNoun(akahanaTradeIn)}`);
    }
    const gasMaskSlot = rom.prg[0x3d7fe];
    replaceMessage('02:02', '[29:Gas Mask]', item(gasMaskSlot));
    const telepathySlot = rom.prg[0x367f4];
    if (telepathySlot < 0x41)
        unmagic('03:01');
    replaceMessage('03:01', '[43:Telepathy]', item(telepathySlot));
    const tornel = rom.npcs[0x5f];
    const tornelTradeIn = findTornelTradeIn(tornel);
    replaceMessage('03:01', '[06:Tornado Bracelet]', item(tornelTradeIn));
    replaceMessage('05:0a', '[06:Tornado Bracelet]', item(tornelTradeIn));
    replaceMessage('05:0a', '[44:Teleport]', item(tornel.data[0]));
    const fogLampTradeIn = tradeIns.get(0x64);
    if (fogLampTradeIn != null) {
        replaceMessage('09:01', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:04', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:05', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:06', 'lamp', commonNoun(fogLampTradeIn));
    }
    const queen = rom.npcs[0x38];
    replaceMessage('0a:0c', '[28:Flute of Lime]', item(queen.data[0]));
    const recoverSlot = rom.prg[0x3d1f9];
    if (recoverSlot < 0x41)
        unmagic('0b:01');
    replaceMessage('0b:01', '[45:Recover]', item(recoverSlot));
    const barrierSlot = rom.prg[0x3d6d9];
    if (barrierSlot < 0x41) {
        replaceMessage('0b:01', 'teach you\n the magic of', 'give you\n ');
        unmagic('1d:12');
    }
    replaceMessage('0b:01', '[46:Barrier]', item(barrierSlot));
    replaceMessage('1d:12', '[46:Barrier]', item(barrierSlot));
    let fogLampCaveLoot = findLoot(0x44, 0x45, 0x46, 0x47, 0x48, 0x49, 0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f);
    if (fogLampCaveLoot >= 0) {
        replaceMessage('0d:00', '[35:Fog Lamp]', item(fogLampCaveLoot));
    }
    else {
        replaceMessage('0d:00', 'that a [35:Fog Lamp] was', 'there was treasure');
    }
    const rageTradeIn = rom.npcs[0xc3].localDialogs.get(-1)[0].condition & 0xff;
    const rageItem = rom.prg[0x3d337];
    replaceMessage('0e:03', '[02:Sword of Water]', item(rageTradeIn));
    replaceMessage('0e:03', '[09:Ball of Water]', item(rageItem));
    replaceMessage('10:0c', 'that\'s', 'is');
    replaceMessage('10:0c', /, is in the\+lighthouse/, '');
    const aryllisTradeIn = tradeIns.get(0x23);
    if (aryllisTradeIn != null) {
        replaceMessage('12:05', '[3c:Kirisa Plant]', item(aryllisTradeIn));
        replaceMessage('12:10', 'the plant', `the ${commonNoun(aryllisTradeIn)}`);
        replaceMessage('12:10', '[3c:Kirisa Plant]', item(aryllisTradeIn));
        const clue = `Our illustrious chief seeks ${vague(aryllisTradeIn)}.`;
        replaceMessage('12:09', /[^]*/, clue);
        replaceMessage('12:0a', /[^]*/, clue);
    }
    const lovePendantTradeIn = tradeIns.get(0x74);
    if (lovePendantTradeIn != null) {
        replaceMessage('13:02', '[3b:Love Pendant]', item(lovePendantTradeIn));
    }
    const changeSlot = rom.prg[0x3d6de];
    if (changeSlot < 0x41) {
        replaceMessage('13:02', 'teach\s+you the magic of', 'bestow\n upon you the');
    }
    replaceMessage('13:02', '[47:Change]', item(changeSlot));
    const ivoryStatueTradeIn = tradeIns.get(0x75);
    if (ivoryStatueTradeIn != null) {
        replaceMessage('18:06', '[3d:Ivory Statue]', item(ivoryStatueTradeIn));
        replaceMessage('18:07', '[3d:Ivory Statue]', item(ivoryStatueTradeIn));
    }
    replaceMessage('18:06', `It's in a room`, '{0b:Karmine} is');
    const flightSlot = rom.prg[0x3d18f];
    if (flightSlot < 0x41)
        replaceMessage('18:07', 'teach', 'give');
    replaceMessage('18:07', '[48:Flight]', item(flightSlot));
    const paralysisSlot = rom.prg[0x3d655];
    if (paralysisSlot < 0x41)
        unmagic('1c:10');
    replaceMessage('1c:10', '[42:Paralysis]', item(paralysisSlot));
    replaceMessage('20:06', 'Statue of Gold', item(0x3a));
    function unmagic(mid) {
        replaceMessage(mid, 'teach you the magic of', 'bestow upon you the');
    }
    function item(id) {
        const item = itemget(id);
        return `[${hex(item.id)}:${item.messageName}]`;
    }
    function replaceMessage(mid, pat, repl) {
        const [part, index] = mid.split(':').map(x => parseInt(x, 16));
        const msg = rom.messages.parts[part][index];
        msg.text = msg.text.replace(pat, repl);
    }
    function findLoot(...locs) {
        for (const id of locs) {
            const loc = rom.locations[id];
            for (const spawn of loc.spawns) {
                if (spawn.isChest() && spawn.id < 0x48 && itemget(spawn.id).unique) {
                    return spawn.id;
                }
            }
        }
        return -1;
    }
    function itemget(id) {
        const itemget = rom.itemGets[id];
        return rom.items[itemget.itemId];
    }
}
function findTornelTradeIn(tornel) {
    for (const ds of tornel.localDialogs.values()) {
        for (let i = 2; i < ds.length; i++) {
            const item = ~ds[i].condition;
            if (item > 0x204 && item <= 0x20c && !(item & 1))
                return item & 0xff;
        }
    }
    return 0x06;
}
function vague(id) {
    switch (id) {
        case 0x25: return 'an unusual statue';
        case 0x28: return 'a rare instrument';
        case 0x35: return 'a brilliant lamp';
        case 0x3b: return 'a beautiful charm';
        case 0x3c: return 'a fragrant plant';
        case 0x3d: return 'an exotic statue';
    }
    fail();
    return 'a valuable item';
}
function commonNoun(id) {
    switch (id) {
        case 0x25: return 'statue';
        case 0x28: return 'instrument';
        case 0x35: return 'lamp';
        case 0x3b: return 'pendant';
        case 0x3c: return 'plant';
        case 0x3d: return 'statue';
    }
    fail();
    return 'item';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZml4ZGlhbG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3MvZml4ZGlhbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuQyxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUdsQyxNQUFNLFVBQVUsU0FBUyxDQUFDLEdBQVE7SUFFaEMsY0FBYyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFakMsTUFBTSxRQUFRLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBR3RDLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUk7UUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTVELE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUMsSUFBSSxjQUFjLEVBQUU7UUFDbEIsY0FBYyxDQUFDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUNwRSxjQUFjLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDMUU7SUFFRCxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3JDLGNBQWMsQ0FB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Q0FBQztBQUVELFNBQVMsS0FBSyxDQUFDLEVBQVU7SUFDdkIsUUFBUSxFQUFFLEVBQUU7UUFDVixLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sbUJBQW1CLENBQUM7UUFDdEMsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLG1CQUFtQixDQUFDO1FBQ3RDLEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxrQkFBa0IsQ0FBQztRQUNyQyxLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sbUJBQW1CLENBQUM7UUFDdEMsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLGtCQUFrQixDQUFDO1FBQ3JDLEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxrQkFBa0IsQ0FBQztLQUN0QztJQUNELElBQUksRUFBRSxDQUFDO0lBQ1AsT0FBTyxpQkFBaUIsQ0FBQztBQUMzQixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsRUFBVTtJQUM1QixRQUFRLEVBQUUsRUFBRTtRQUNWLEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxRQUFRLENBQUM7UUFDM0IsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLFlBQVksQ0FBQztRQUMvQixLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sTUFBTSxDQUFDO1FBQ3pCLEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxTQUFTLENBQUM7UUFDNUIsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLE9BQU8sQ0FBQztRQUMxQixLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sUUFBUSxDQUFDO0tBQzVCO0lBQ0QsSUFBSSxFQUFFLENBQUM7SUFDUCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0l0ZW19IGZyb20gJy4uL3JvbS9pdGVtLmpzJztcbmltcG9ydCB7TnBjfSBmcm9tICcuLi9yb20vbnBjLmpzJztcbmltcG9ydCB7aGV4fSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQge2J1aWxkVHJhZGVJbk1hcH0gZnJvbSAnLi9zaHVmZmxldHJhZGVzLmpzJztcbmltcG9ydCB7ZmFpbH0gZnJvbSAnLi4vYXNzZXJ0LmpzJztcblxuLyoqIEZpbmRzIHJlZmVyZW5jZXMgdG8gZ2l2ZW4gaXRlbXMgYW5kIHJlcGxhY2VzIGl0IHdpdGggdGhlIGFjdHVhbCBpdGVtcy4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmaXhEaWFsb2cocm9tOiBSb20pIHtcbiAgLy8gU3RvbSdzIFwiSSdsbCwgYmUgd2FpdGluZy4uLlwiIGRpYWxvZyAtIHRoZSBjb21tYSBpcyBqdXN0IHdyb25nLlxuICByZXBsYWNlTWVzc2FnZSgnMDM6MDYnLCAnLCcsICcnKTtcblxuICBjb25zdCB0cmFkZUlucyA9IGJ1aWxkVHJhZGVJbk1hcChyb20pO1xuICAvLyBOT1RFOiB3ZSBuZWVkIHRvIGhhcmRjb2RlIG9yaWdpbmFsIG5hbWVzIGluIGNhc2UgdGhleSB3ZXJlIHNodWZmbGVkLlxuXG4gIGNvbnN0IHplYnUgPSByb20ubnBjc1sweDVlXTtcbiAgaWYgKHplYnUuZGF0YVswXSA8IDB4NDEpIHVubWFnaWMoJzAwOjFiJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMDoxYicsICdbNDE6UmVmcmVzaF0nLCBpdGVtKHplYnUuZGF0YVswXSkpO1xuXG4gIGNvbnN0IGFrYWhhbmFUcmFkZUluID0gdHJhZGVJbnMuZ2V0KDB4ODIpO1xuICBpZiAoYWthaGFuYVRyYWRlSW4pIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMDI6MDEnLCAnYW4gdW51c3VhbCBzdGF0dWUnLCB2YWd1ZShha2FoYW5hVHJhZGVJbikpO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwMjowMicsICdhIHN0YXR1ZScsIGB0aGUgJHtjb21tb25Ob3VuKGFrYWhhbmFUcmFkZUluKX1gKTtcbiAgfVxuXG4gIGNvbnN0IGdhc01hc2tTbG90ID0gcm9tLnByZ1sweDNkN2ZlXTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAyOjAyJywgJ1syOTpHYXMgTWFza10nLCBpdGVtKGdhc01hc2tTbG90KSk7XG5cbiAgY29uc3QgdGVsZXBhdGh5U2xvdCA9IHJvbS5wcmdbMHgzNjdmNF07XG4gIGlmICh0ZWxlcGF0aHlTbG90IDwgMHg0MSkgdW5tYWdpYygnMDM6MDEnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAzOjAxJywgJ1s0MzpUZWxlcGF0aHldJywgaXRlbSh0ZWxlcGF0aHlTbG90KSk7XG5cbiAgY29uc3QgdG9ybmVsID0gcm9tLm5wY3NbMHg1Zl07XG4gIGNvbnN0IHRvcm5lbFRyYWRlSW4gPSBmaW5kVG9ybmVsVHJhZGVJbih0b3JuZWwpO1xuICByZXBsYWNlTWVzc2FnZSgnMDM6MDEnLCAnWzA2OlRvcm5hZG8gQnJhY2VsZXRdJywgaXRlbSh0b3JuZWxUcmFkZUluKSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwNTowYScsICdbMDY6VG9ybmFkbyBCcmFjZWxldF0nLCBpdGVtKHRvcm5lbFRyYWRlSW4pKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA1OjBhJywgJ1s0NDpUZWxlcG9ydF0nLCBpdGVtKHRvcm5lbC5kYXRhWzBdKSk7XG5cbiAgY29uc3QgZm9nTGFtcFRyYWRlSW4gPSB0cmFkZUlucy5nZXQoMHg2NCk7XG4gIGlmIChmb2dMYW1wVHJhZGVJbiAhPSBudWxsKSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzA5OjAxJywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA0JywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA1JywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA2JywgJ2xhbXAnLCBjb21tb25Ob3VuKGZvZ0xhbXBUcmFkZUluKSk7XG4gIH1cblxuICBjb25zdCBxdWVlbiA9IHJvbS5ucGNzWzB4MzhdO1xuICByZXBsYWNlTWVzc2FnZSgnMGE6MGMnLCAnWzI4OkZsdXRlIG9mIExpbWVdJywgaXRlbShxdWVlbi5kYXRhWzBdKSk7XG4gIC8vIFRPRE8gLSBjb25zaWRlciByZXBsYWNpbmcgMGE6MGQgYnV0IHdlIG5lZWQgdG8gYWxzbyByZXBsYWNlIGNvbmRpdGlvbj9cbiAgY29uc3QgcmVjb3ZlclNsb3QgPSByb20ucHJnWzB4M2QxZjldO1xuICBpZiAocmVjb3ZlclNsb3QgPCAweDQxKSB1bm1hZ2ljKCcwYjowMScpO1xuICByZXBsYWNlTWVzc2FnZSgnMGI6MDEnLCAnWzQ1OlJlY292ZXJdJywgaXRlbShyZWNvdmVyU2xvdCkpO1xuXG4gIGNvbnN0IGJhcnJpZXJTbG90ID0gcm9tLnByZ1sweDNkNmQ5XTtcbiAgaWYgKGJhcnJpZXJTbG90IDwgMHg0MSkge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwYjowMScsICd0ZWFjaCB5b3VcXG4gdGhlIG1hZ2ljIG9mJywgJ2dpdmUgeW91XFxuICcpO1xuICAgIHVubWFnaWMoJzFkOjEyJyk7XG4gIH1cbiAgcmVwbGFjZU1lc3NhZ2UoJzBiOjAxJywgJ1s0NjpCYXJyaWVyXScsIGl0ZW0oYmFycmllclNsb3QpKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzFkOjEyJywgJ1s0NjpCYXJyaWVyXScsIGl0ZW0oYmFycmllclNsb3QpKTtcblxuICAvLyBMb29rIGZvciBhIGtleSBpdGVtIGluIHRoZSBmb2cgbGFtcC9raXJpc2EgcGxhbnQgY2F2ZXMuXG4gIGxldCBmb2dMYW1wQ2F2ZUxvb3QgPSBmaW5kTG9vdCgweDQ0LCAweDQ1LCAweDQ2LCAweDQ3LCAweDQ4LCAweDQ5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMHg0YSwgMHg0YiwgMHg0YywgMHg0ZCwgMHg0ZSwgMHg0Zik7XG4gIGlmIChmb2dMYW1wQ2F2ZUxvb3QgPj0gMCkge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwZDowMCcsICdbMzU6Rm9nIExhbXBdJywgaXRlbShmb2dMYW1wQ2F2ZUxvb3QpKTtcbiAgfSBlbHNlIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMGQ6MDAnLCAndGhhdCBhIFszNTpGb2cgTGFtcF0gd2FzJywgJ3RoZXJlIHdhcyB0cmVhc3VyZScpO1xuICB9XG5cbiAgY29uc3QgcmFnZVRyYWRlSW4gPSByb20ubnBjc1sweGMzXS5sb2NhbERpYWxvZ3MuZ2V0KC0xKSFbMF0uY29uZGl0aW9uICYgMHhmZjtcbiAgY29uc3QgcmFnZUl0ZW0gPSByb20ucHJnWzB4M2QzMzddO1xuICByZXBsYWNlTWVzc2FnZSgnMGU6MDMnLCAnWzAyOlN3b3JkIG9mIFdhdGVyXScsIGl0ZW0ocmFnZVRyYWRlSW4pKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBlOjAzJywgJ1swOTpCYWxsIG9mIFdhdGVyXScsIGl0ZW0ocmFnZUl0ZW0pKTtcblxuICAvLyBUT0RPIC0gbWVzc2FnZSAxMDowYyBpcyBvbmx5IGhhbGYtY29ycmVjdC4gIElmIGl0ZW0gbmFtZXMgYXJlIHJhbmRvbWl6ZWRcbiAgLy8gdGhlbiBldmVuIHdpdGhvdXQgYSBsb2NhdGlvbiB0aGUgbWVzc2FnZSBpcyBzdGlsbCB1c2VmdWwuICBTbyBqdXN0IGRvIHRoYXRcbiAgLy8gZm9yIG5vdywgYW5kIHdlIGNhbiBmaW5kIGEgd2F5IHRvIGhpbnQgbGF0ZXIuXG4gIHJlcGxhY2VNZXNzYWdlKCcxMDowYycsICd0aGF0XFwncycsICdpcycpO1xuICByZXBsYWNlTWVzc2FnZSgnMTA6MGMnLCAvLCBpcyBpbiB0aGVcXCtsaWdodGhvdXNlLywgJycpO1xuXG4gIGNvbnN0IGFyeWxsaXNUcmFkZUluID0gdHJhZGVJbnMuZ2V0KDB4MjMpO1xuICBpZiAoYXJ5bGxpc1RyYWRlSW4gIT0gbnVsbCkge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxMjowNScsICdbM2M6S2lyaXNhIFBsYW50XScsIGl0ZW0oYXJ5bGxpc1RyYWRlSW4pKTtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTI6MTAnLCAndGhlIHBsYW50JywgYHRoZSAke2NvbW1vbk5vdW4oYXJ5bGxpc1RyYWRlSW4pfWApO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxMjoxMCcsICdbM2M6S2lyaXNhIFBsYW50XScsIGl0ZW0oYXJ5bGxpc1RyYWRlSW4pKTtcbiAgICAvLyBUT0RPIC0gcmVmcyBpbiAxMjowOSBhbmQgMTI6MGEgaGF2ZSBsb2NhdGlvbiwgdG9vLlxuICAgIC8vIHJlcGxhY2VNZXNzYWdlKCcxMjowOScsIC9cXHMqXFxuLiovLCAnLicpO1xuICAgIC8vIHJlcGxhY2VNZXNzYWdlKCcxMjowYScsIC9cXHMqXFxuLiovLCAnLicpO1xuICAgIGNvbnN0IGNsdWUgPSBgT3VyIGlsbHVzdHJpb3VzIGNoaWVmIHNlZWtzICR7dmFndWUoYXJ5bGxpc1RyYWRlSW4pfS5gO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxMjowOScsIC9bXl0qLywgY2x1ZSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzEyOjBhJywgL1teXSovLCBjbHVlKTtcbiAgfVxuXG4gIGNvbnN0IGxvdmVQZW5kYW50VHJhZGVJbiA9IHRyYWRlSW5zLmdldCgweDc0KTtcbiAgaWYgKGxvdmVQZW5kYW50VHJhZGVJbiAhPSBudWxsKSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzEzOjAyJywgJ1szYjpMb3ZlIFBlbmRhbnRdJywgaXRlbShsb3ZlUGVuZGFudFRyYWRlSW4pKTtcbiAgfVxuICBjb25zdCBjaGFuZ2VTbG90ID0gcm9tLnByZ1sweDNkNmRlXTtcbiAgaWYgKGNoYW5nZVNsb3QgPCAweDQxKSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzEzOjAyJywgJ3RlYWNoXFxzK3lvdSB0aGUgbWFnaWMgb2YnLCAnYmVzdG93XFxuIHVwb24geW91IHRoZScpO1xuICB9XG4gIHJlcGxhY2VNZXNzYWdlKCcxMzowMicsICdbNDc6Q2hhbmdlXScsIGl0ZW0oY2hhbmdlU2xvdCkpO1xuXG4gIGNvbnN0IGl2b3J5U3RhdHVlVHJhZGVJbiA9IHRyYWRlSW5zLmdldCgweDc1KTtcbiAgaWYgKGl2b3J5U3RhdHVlVHJhZGVJbiAhPSBudWxsKSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA2JywgJ1szZDpJdm9yeSBTdGF0dWVdJywgaXRlbShpdm9yeVN0YXR1ZVRyYWRlSW4pKTtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTg6MDcnLCAnWzNkOkl2b3J5IFN0YXR1ZV0nLCBpdGVtKGl2b3J5U3RhdHVlVHJhZGVJbikpO1xuICB9XG4gIHJlcGxhY2VNZXNzYWdlKCcxODowNicsIGBJdCdzIGluIGEgcm9vbWAsICd7MGI6S2FybWluZX0gaXMnKTtcbiAgY29uc3QgZmxpZ2h0U2xvdCA9IHJvbS5wcmdbMHgzZDE4Zl07XG4gIGlmIChmbGlnaHRTbG90IDwgMHg0MSkgcmVwbGFjZU1lc3NhZ2UoJzE4OjA3JywgJ3RlYWNoJywgJ2dpdmUnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA3JywgJ1s0ODpGbGlnaHRdJywgaXRlbShmbGlnaHRTbG90KSk7XG5cbiAgY29uc3QgcGFyYWx5c2lzU2xvdCA9IHJvbS5wcmdbMHgzZDY1NV07XG4gIGlmIChwYXJhbHlzaXNTbG90IDwgMHg0MSkgdW5tYWdpYygnMWM6MTAnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzFjOjEwJywgJ1s0MjpQYXJhbHlzaXNdJywgaXRlbShwYXJhbHlzaXNTbG90KSk7XG5cbiAgcmVwbGFjZU1lc3NhZ2UoJzIwOjA2JywgJ1N0YXR1ZSBvZiBHb2xkJywgaXRlbSgweDNhKSk7XG5cbiAgLy8gVE9ETyAtIGNvbnNpZGVyIHdhcnBpbmcgb24gYSByYW5kb20gc3dvcmQ/IC0gbWVzc2FnZSAxYzoxMVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBmdW5jdGlvbiB1bm1hZ2ljKG1pZDogc3RyaW5nKSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UobWlkLCAndGVhY2ggeW91IHRoZSBtYWdpYyBvZicsICdiZXN0b3cgdXBvbiB5b3UgdGhlJyk7XG4gIH1cbiAgZnVuY3Rpb24gaXRlbShpZDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCBpdGVtID0gaXRlbWdldChpZCk7XG4gICAgcmV0dXJuIGBbJHtoZXgoaXRlbS5pZCl9OiR7aXRlbS5tZXNzYWdlTmFtZX1dYDtcbiAgfVxuICBmdW5jdGlvbiByZXBsYWNlTWVzc2FnZShtaWQ6IHN0cmluZywgcGF0OiBzdHJpbmcgfCBSZWdFeHAsIHJlcGw6IHN0cmluZykge1xuICAgIGNvbnN0IFtwYXJ0LCBpbmRleF0gPSBtaWQuc3BsaXQoJzonKS5tYXAoeCA9PiBwYXJzZUludCh4LCAxNikpO1xuICAgIGNvbnN0IG1zZyA9IHJvbS5tZXNzYWdlcy5wYXJ0c1twYXJ0XVtpbmRleF07XG4gICAgbXNnLnRleHQgPSBtc2cudGV4dC5yZXBsYWNlKHBhdCwgcmVwbCk7XG4gIH1cbiAgZnVuY3Rpb24gZmluZExvb3QoLi4ubG9jczogbnVtYmVyW10pIHtcbiAgICBmb3IgKGNvbnN0IGlkIG9mIGxvY3MpIHtcbiAgICAgIGNvbnN0IGxvYyA9IHJvbS5sb2NhdGlvbnNbaWRdO1xuICAgICAgZm9yIChjb25zdCBzcGF3biBvZiBsb2Muc3Bhd25zKSB7XG4gICAgICAgIGlmIChzcGF3bi5pc0NoZXN0KCkgJiYgc3Bhd24uaWQgPCAweDQ4ICYmIGl0ZW1nZXQoc3Bhd24uaWQpLnVuaXF1ZSkge1xuICAgICAgICAgIHJldHVybiBzcGF3bi5pZDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gLTE7XG4gIH1cbiAgZnVuY3Rpb24gaXRlbWdldChpZDogbnVtYmVyKTogSXRlbSB7XG4gICAgY29uc3QgaXRlbWdldCA9IHJvbS5pdGVtR2V0c1tpZF07XG4gICAgcmV0dXJuIHJvbS5pdGVtc1tpdGVtZ2V0Lml0ZW1JZF07XG4gIH1cbn1cblxuZnVuY3Rpb24gZmluZFRvcm5lbFRyYWRlSW4odG9ybmVsOiBOcGMpOiBudW1iZXIge1xuICAvLyBFeHBlY3RlZCBzdHJ1Y3R1cmU6XG4gIC8vICAgLi4uXG4gIC8vICAgTk9UIGJyYWNlbGV0IC0+IC4uLlxuICAvLyAgIE5PVCBiYWxsIC0+IC4uLlxuICAvLyAgIC0+IGdpdmUgaXRlbVxuICBmb3IgKGNvbnN0IGRzIG9mIHRvcm5lbC5sb2NhbERpYWxvZ3MudmFsdWVzKCkpIHtcbiAgICBmb3IgKGxldCBpID0gMjsgaSA8IGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpdGVtID0gfmRzW2ldLmNvbmRpdGlvbjtcbiAgICAgIC8vIExvb2sgZm9yIGFueSBuZWdhdGl2ZSBjb25kaXRpb24gb24gYSBicmFjZWxldCAoZG9lc24ndCBtYXR0ZXIgd2hlcmUpXG4gICAgICBpZiAoaXRlbSA+IDB4MjA0ICYmIGl0ZW0gPD0gMHgyMGMgJiYgIShpdGVtICYgMSkpIHJldHVybiBpdGVtICYgMHhmZjtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIDB4MDY7IC8vIGRlZmF1bHQgdG8gdG9ybmFkbyBicmFjZWxldFxufVxuXG5mdW5jdGlvbiB2YWd1ZShpZDogbnVtYmVyKTogc3RyaW5nIHtcbiAgc3dpdGNoIChpZCkge1xuICAgIGNhc2UgMHgyNTogcmV0dXJuICdhbiB1bnVzdWFsIHN0YXR1ZSc7XG4gICAgY2FzZSAweDI4OiByZXR1cm4gJ2EgcmFyZSBpbnN0cnVtZW50JztcbiAgICBjYXNlIDB4MzU6IHJldHVybiAnYSBicmlsbGlhbnQgbGFtcCc7XG4gICAgY2FzZSAweDNiOiByZXR1cm4gJ2EgYmVhdXRpZnVsIGNoYXJtJztcbiAgICBjYXNlIDB4M2M6IHJldHVybiAnYSBmcmFncmFudCBwbGFudCc7XG4gICAgY2FzZSAweDNkOiByZXR1cm4gJ2FuIGV4b3RpYyBzdGF0dWUnO1xuICB9XG4gIGZhaWwoKTtcbiAgcmV0dXJuICdhIHZhbHVhYmxlIGl0ZW0nO1xufVxuXG5mdW5jdGlvbiBjb21tb25Ob3VuKGlkOiBudW1iZXIpOiBzdHJpbmcge1xuICBzd2l0Y2ggKGlkKSB7XG4gICAgY2FzZSAweDI1OiByZXR1cm4gJ3N0YXR1ZSc7XG4gICAgY2FzZSAweDI4OiByZXR1cm4gJ2luc3RydW1lbnQnO1xuICAgIGNhc2UgMHgzNTogcmV0dXJuICdsYW1wJztcbiAgICBjYXNlIDB4M2I6IHJldHVybiAncGVuZGFudCc7XG4gICAgY2FzZSAweDNjOiByZXR1cm4gJ3BsYW50JztcbiAgICBjYXNlIDB4M2Q6IHJldHVybiAnc3RhdHVlJztcbiAgfVxuICBmYWlsKCk7XG4gIHJldHVybiAnaXRlbSc7XG59XG5cbi8vIGZ1bmN0aW9uIHJlcGxhY2VEaWFsb2cobnBjOiBOcGMsIG9yaWc6IG51bWJlciB8IFJlZ0V4cCwgcmVwbGFjZW1lbnRJZDogbnVtYmVyKSB7XG4vLyAgIGNvbnN0IHJvbSA9IG5wYy5yb207XG4vLyAgIGNvbnN0IHBhdCA9IG9yaWcgaW5zdGFuY2VvZiBSZWdFeHAgPyBvcmlnIDogcGF0dGVybihyb20uaXRlbXNbb3JpZ10pO1xuLy8gICBjb25zdCByZXBsID0gcmVwbGFjZW1lbnQocm9tLml0ZW1zW3JlcGxhY2VtZW50SWRdKTtcbi8vICAgZm9yIChjb25zdCBkcyBvZiBucGMubG9jYWxEaWFsb2dzLnZhbHVlcygpKSB7XG4vLyAgICAgZm9yIChjb25zdCBkIG9mIGRzKSB7XG4vLyAgICAgICBjb25zdCBtaWQgPSBkLm1lc3NhZ2U7XG4vLyAgICAgICByZXBsYWNlTWVzc2FnZShyb20sIG1pZC5wYXJ0LCBtaWQuaW5kZXgsIHBhdCwgcmVwbCk7XG4vLyAgICAgfVxuLy8gICB9XG4vLyB9XG5cbi8vIGNvbnN0IHBhdHRlcm46IHsoaWQ6IG51bWJlciwgbmFtZTogc3RyaW5nKTogUmVnRXhwO1xuLy8gICAgICAgICAgICAgICAgIChpdGVtOiBJdGVtKTogUmVnRXhwfSA9XG4vLyAgICAgKGl0ZW06IG51bWJlciB8IEl0ZW0sIG5hbWU/OiBzdHJpbmcpID0+IHtcbi8vICAgICAgIG5hbWUgPSBuYW1lIHx8IChpdGVtIGFzIEl0ZW0pLm1lc3NhZ2VOYW1lO1xuLy8gICAgICAgY29uc3QgaWQgPSBoZXgoaXRlbSBpbnN0YW5jZW9mIEl0ZW0gPyBpdGVtLmlkIDogaXRlbSk7XG4vLyAgICAgICByZXR1cm4gbmV3IFJlZ0V4cChgXFxcXFske2lkfTpbXlxcXFxdXSpcXFxcXXwke25hbWUucmVwbGFjZSgvXFxzKy9nLCAnXFxcXHMrJyl9YCxcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICdnJyk7XG4vLyAgICAgfTtcblxuLy8gZnVuY3Rpb24gcmVwbGFjZW1lbnQoaXRlbTogSXRlbSk6IHN0cmluZyB7XG4vLyAgIHJldHVybiBgWyR7aGV4KGl0ZW0uaWQpfToke2l0ZW0ubWVzc2FnZU5hbWV9XWA7XG4vLyB9XG4iXX0=