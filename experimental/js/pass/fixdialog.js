import { hex } from '../rom/util.js';
import { buildTradeInMap } from './shuffletrades.js';
import { fail } from '../assert.js';
export function fixDialog(rom) {
    replaceMessage('03:06', ',', '');
    const tradeIns = buildTradeInMap(rom);
    const zebu = rom.npcs[0x5e];
    if (zebu.data[0] < 0x41)
        unmagic('00:1b');
    replaceMessage('00:1b', '[41:Refresh]', item(zebu.data[0]));
    const akahanaTradeIn = tradeIns.get(0x82);
    if (akahanaTradeIn) {
        replaceMessage('02:01', 'an unusual statue', vague(akahanaTradeIn));
        replaceMessage('02:02', 'a statue', `the ${commonNoun(akahanaTradeIn)}`);
    }
    const gasMaskSlot = rom.prg[0x3d7fe];
    replaceMessage('02:02', '[29:Gas Mask]', item(gasMaskSlot));
    const telepathySlot = rom.prg[0x367f4];
    if (telepathySlot < 0x41)
        unmagic('03:01');
    replaceMessage('03:01', '[43:Telepathy]', item(telepathySlot));
    const tornel = rom.npcs[0x5f];
    const tornelTradeIn = findTornelTradeIn(tornel);
    replaceMessage('03:01', '[06:Tornado Bracelet]', item(tornelTradeIn));
    replaceMessage('05:0a', '[06:Tornado Bracelet]', item(tornelTradeIn));
    replaceMessage('05:0a', '[44:Teleport]', item(tornel.data[0]));
    const fogLampTradeIn = tradeIns.get(0x64);
    if (fogLampTradeIn != null) {
        replaceMessage('09:01', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:04', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:05', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:06', 'lamp', commonNoun(fogLampTradeIn));
    }
    const queen = rom.npcs[0x38];
    replaceMessage('0a:0c', '[28:Flute of Lime]', item(queen.data[0]));
    replaceMessage('0a:0d', '[02:Sword of Water]', item(queen.localDialogs.get(-1)[3].condition & 0xff));
    const recoverSlot = rom.prg[0x3d1f9];
    if (recoverSlot < 0x41)
        unmagic('0b:01');
    replaceMessage('0b:01', '[45:Recover]', item(recoverSlot));
    const barrierSlot = rom.prg[0x3d6d9];
    if (barrierSlot < 0x41) {
        replaceMessage('0b:01', 'teach you\n the magic of', 'give you\n ');
        unmagic('1d:12');
    }
    replaceMessage('0b:01', '[46:Barrier]', item(barrierSlot));
    replaceMessage('1d:12', '[46:Barrier]', item(barrierSlot));
    let fogLampCaveLoot = findLoot(0x44, 0x45, 0x46, 0x47, 0x48, 0x49, 0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f);
    if (fogLampCaveLoot >= 0) {
        replaceMessage('0d:00', '[35:Fog Lamp]', item(fogLampCaveLoot));
    }
    else {
        replaceMessage('0d:00', 'that a [35:Fog Lamp] was', 'there was treasure');
    }
    const rageTradeIn = rom.npcs[0xc3].localDialogs.get(-1)[0].condition & 0xff;
    const rageItem = rom.prg[0x3d337];
    replaceMessage('0e:03', '[02:Sword of Water]', item(rageTradeIn));
    replaceMessage('0e:03', '[09:Ball of Water]', item(rageItem));
    replaceMessage('10:0c', 'that\'s', 'is');
    replaceMessage('10:0c', /, is in the\+lighthouse/, '');
    const aryllisTradeIn = tradeIns.get(0x23);
    if (aryllisTradeIn != null) {
        replaceMessage('12:05', '[3c:Kirisa Plant]', item(aryllisTradeIn));
        replaceMessage('12:10', 'the plant', `the ${commonNoun(aryllisTradeIn)}`);
        replaceMessage('12:10', '[3c:Kirisa Plant]', item(aryllisTradeIn));
        const clue = `Our illustrious chief seeks ${vague(aryllisTradeIn)}.`;
        replaceMessage('12:09', /[^]*/, clue);
        replaceMessage('12:0a', /[^]*/, clue);
    }
    const lovePendantTradeIn = tradeIns.get(0x74);
    if (lovePendantTradeIn != null) {
        replaceMessage('13:02', '[3b:Love Pendant]', item(lovePendantTradeIn));
    }
    const changeSlot = rom.prg[0x3d6de];
    if (changeSlot < 0x41) {
        replaceMessage('13:02', 'teach\s+you the magic of', 'bestow\n upon you the');
    }
    replaceMessage('13:02', '[47:Change]', item(changeSlot));
    const ivoryStatueTradeIn = tradeIns.get(0x75);
    if (ivoryStatueTradeIn != null) {
        replaceMessage('18:06', '[3d:Ivory Statue]', item(ivoryStatueTradeIn));
        replaceMessage('18:07', '[3d:Ivory Statue]', item(ivoryStatueTradeIn));
    }
    replaceMessage('18:06', `It's in a room`, '{0b:Karmine} is');
    const flightSlot = rom.prg[0x3d18f];
    if (flightSlot < 0x41)
        replaceMessage('18:07', 'teach', 'give');
    replaceMessage('18:07', '[48:Flight]', item(flightSlot));
    const paralysisSlot = rom.prg[0x3d655];
    if (paralysisSlot < 0x41)
        unmagic('1c:10');
    replaceMessage('1c:10', '[42:Paralysis]', item(paralysisSlot));
    replaceMessage('20:06', 'Statue of Gold', item(0x3a));
    function unmagic(mid) {
        replaceMessage(mid, 'teach you the magic of', 'bestow upon you the');
    }
    function item(id) {
        const item = itemget(id);
        return `[${hex(item.id)}:${item.messageName}]`;
    }
    function replaceMessage(mid, pat, repl) {
        const [part, index] = mid.split(':').map(x => parseInt(x, 16));
        const msg = rom.messages.parts[part][index];
        msg.text = msg.text.replace(pat, repl);
    }
    function findLoot(...locs) {
        for (const id of locs) {
            const loc = rom.locations[id];
            for (const spawn of loc.spawns) {
                if (spawn.isChest() && spawn.id < 0x48 && itemget(spawn.id).unique) {
                    return spawn.id;
                }
            }
        }
        return -1;
    }
    function itemget(id) {
        const itemget = rom.itemGets[id];
        return rom.items[itemget.itemId];
    }
}
function findTornelTradeIn(tornel) {
    for (const ds of tornel.localDialogs.values()) {
        for (let i = 2; i < ds.length; i++) {
            const item = ~ds[i].condition;
            if (item > 0x204 && item <= 0x20c && !(item & 1))
                return item & 0xff;
        }
    }
    return 0x06;
}
function vague(id) {
    switch (id) {
        case 0x25: return 'an unusual statue';
        case 0x28: return 'a rare instrument';
        case 0x35: return 'a brilliant lamp';
        case 0x3b: return 'a beautiful charm';
        case 0x3c: return 'a fragrant plant';
        case 0x3d: return 'an exotic statue';
    }
    fail();
    return 'a valuable item';
}
function commonNoun(id) {
    switch (id) {
        case 0x25: return 'statue';
        case 0x28: return 'instrument';
        case 0x35: return 'lamp';
        case 0x3b: return 'pendant';
        case 0x3c: return 'plant';
        case 0x3d: return 'statue';
    }
    fail();
    return 'item';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZml4ZGlhbG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3MvZml4ZGlhbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuQyxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUdsQyxNQUFNLFVBQVUsU0FBUyxDQUFDLEdBQVE7SUFFaEMsY0FBYyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFakMsTUFBTSxRQUFRLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBR3RDLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUk7UUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTVELE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUMsSUFBSSxjQUFjLEVBQUU7UUFDbEIsY0FBYyxDQUFDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUNwRSxjQUFjLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDMUU7SUFFRCxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3JDLGNBQWMsQ0FB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L3JvbS5qcyc7XG5pbXBvcnQge0l0ZW19IGZyb20gJy4uL3JvbS9pdGVtLmpzJztcbmltcG9ydCB7TnBjfSBmcm9tICcuLi9yb20vbnBjLmpzJztcbmltcG9ydCB7aGV4fSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQge2J1aWxkVHJhZGVJbk1hcH0gZnJvbSAnLi9zaHVmZmxldHJhZGVzLmpzJztcbmltcG9ydCB7ZmFpbH0gZnJvbSAnLi4vYXNzZXJ0LmpzJztcblxuLyoqIEZpbmRzIHJlZmVyZW5jZXMgdG8gZ2l2ZW4gaXRlbXMgYW5kIHJlcGxhY2VzIGl0IHdpdGggdGhlIGFjdHVhbCBpdGVtcy4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmaXhEaWFsb2cocm9tOiBSb20pIHtcbiAgLy8gU3RvbSdzIFwiSSdsbCwgYmUgd2FpdGluZy4uLlwiIGRpYWxvZyAtIHRoZSBjb21tYSBpcyBqdXN0IHdyb25nLlxuICByZXBsYWNlTWVzc2FnZSgnMDM6MDYnLCAnLCcsICcnKTtcblxuICBjb25zdCB0cmFkZUlucyA9IGJ1aWxkVHJhZGVJbk1hcChyb20pO1xuICAvLyBOT1RFOiB3ZSBuZWVkIHRvIGhhcmRjb2RlIG9yaWdpbmFsIG5hbWVzIGluIGNhc2UgdGhleSB3ZXJlIHNodWZmbGVkLlxuXG4gIGNvbnN0IHplYnUgPSByb20ubnBjc1sweDVlXTtcbiAgaWYgKHplYnUuZGF0YVswXSA8IDB4NDEpIHVubWFnaWMoJzAwOjFiJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMDoxYicsICdbNDE6UmVmcmVzaF0nLCBpdGVtKHplYnUuZGF0YVswXSkpO1xuXG4gIGNvbnN0IGFrYWhhbmFUcmFkZUluID0gdHJhZGVJbnMuZ2V0KDB4ODIpO1xuICBpZiAoYWthaGFuYVRyYWRlSW4pIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMDI6MDEnLCAnYW4gdW51c3VhbCBzdGF0dWUnLCB2YWd1ZShha2FoYW5hVHJhZGVJbikpO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwMjowMicsICdhIHN0YXR1ZScsIGB0aGUgJHtjb21tb25Ob3VuKGFrYWhhbmFUcmFkZUluKX1gKTtcbiAgfVxuXG4gIGNvbnN0IGdhc01hc2tTbG90ID0gcm9tLnByZ1sweDNkN2ZlXTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAyOjAyJywgJ1syOTpHYXMgTWFza10nLCBpdGVtKGdhc01hc2tTbG90KSk7XG5cbiAgY29uc3QgdGVsZXBhdGh5U2xvdCA9IHJvbS5wcmdbMHgzNjdmNF07XG4gIGlmICh0ZWxlcGF0aHlTbG90IDwgMHg0MSkgdW5tYWdpYygnMDM6MDEnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAzOjAxJywgJ1s0MzpUZWxlcGF0aHldJywgaXRlbSh0ZWxlcGF0aHlTbG90KSk7XG5cbiAgY29uc3QgdG9ybmVsID0gcm9tLm5wY3NbMHg1Zl07XG4gIGNvbnN0IHRvcm5lbFRyYWRlSW4gPSBmaW5kVG9ybmVsVHJhZGVJbih0b3JuZWwpO1xuICByZXBsYWNlTWVzc2FnZSgnMDM6MDEnLCAnWzA2OlRvcm5hZG8gQnJhY2VsZXRdJywgaXRlbSh0b3JuZWxUcmFkZUluKSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwNTowYScsICdbMDY6VG9ybmFkbyBCcmFjZWxldF0nLCBpdGVtKHRvcm5lbFRyYWRlSW4pKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzA1OjBhJywgJ1s0NDpUZWxlcG9ydF0nLCBpdGVtKHRvcm5lbC5kYXRhWzBdKSk7XG5cbiAgY29uc3QgZm9nTGFtcFRyYWRlSW4gPSB0cmFkZUlucy5nZXQoMHg2NCk7XG4gIGlmIChmb2dMYW1wVHJhZGVJbiAhPSBudWxsKSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzA5OjAxJywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA0JywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA1JywgJ1szNTpGb2cgTGFtcF0nLCBpdGVtKGZvZ0xhbXBUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzA5OjA2JywgJ2xhbXAnLCBjb21tb25Ob3VuKGZvZ0xhbXBUcmFkZUluKSk7XG4gIH1cblxuICBjb25zdCBxdWVlbiA9IHJvbS5ucGNzWzB4MzhdO1xuICByZXBsYWNlTWVzc2FnZSgnMGE6MGMnLCAnWzI4OkZsdXRlIG9mIExpbWVdJywgaXRlbShxdWVlbi5kYXRhWzBdKSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwYTowZCcsICdbMDI6U3dvcmQgb2YgV2F0ZXJdJyxcbiAgICAgICAgICAgICAgICAgaXRlbShxdWVlbi5sb2NhbERpYWxvZ3MuZ2V0KC0xKSFbM10uY29uZGl0aW9uICYgMHhmZikpO1xuICAvLyBUT0RPIC0gY29uc2lkZXIgcmVwbGFjaW5nIDBhOjBkIGJ1dCB3ZSBuZWVkIHRvIGFsc28gcmVwbGFjZSBjb25kaXRpb24/XG4gIGNvbnN0IHJlY292ZXJTbG90ID0gcm9tLnByZ1sweDNkMWY5XTtcbiAgaWYgKHJlY292ZXJTbG90IDwgMHg0MSkgdW5tYWdpYygnMGI6MDEnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBiOjAxJywgJ1s0NTpSZWNvdmVyXScsIGl0ZW0ocmVjb3ZlclNsb3QpKTtcblxuICBjb25zdCBiYXJyaWVyU2xvdCA9IHJvbS5wcmdbMHgzZDZkOV07XG4gIGlmIChiYXJyaWVyU2xvdCA8IDB4NDEpIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMGI6MDEnLCAndGVhY2ggeW91XFxuIHRoZSBtYWdpYyBvZicsICdnaXZlIHlvdVxcbiAnKTtcbiAgICB1bm1hZ2ljKCcxZDoxMicpO1xuICB9XG4gIHJlcGxhY2VNZXNzYWdlKCcwYjowMScsICdbNDY6QmFycmllcl0nLCBpdGVtKGJhcnJpZXJTbG90KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxZDoxMicsICdbNDY6QmFycmllcl0nLCBpdGVtKGJhcnJpZXJTbG90KSk7XG5cbiAgLy8gTG9vayBmb3IgYSBrZXkgaXRlbSBpbiB0aGUgZm9nIGxhbXAva2lyaXNhIHBsYW50IGNhdmVzLlxuICBsZXQgZm9nTGFtcENhdmVMb290ID0gZmluZExvb3QoMHg0NCwgMHg0NSwgMHg0NiwgMHg0NywgMHg0OCwgMHg0OSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDB4NGEsIDB4NGIsIDB4NGMsIDB4NGQsIDB4NGUsIDB4NGYpO1xuICBpZiAoZm9nTGFtcENhdmVMb290ID49IDApIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMGQ6MDAnLCAnWzM1OkZvZyBMYW1wXScsIGl0ZW0oZm9nTGFtcENhdmVMb290KSk7XG4gIH0gZWxzZSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzBkOjAwJywgJ3RoYXQgYSBbMzU6Rm9nIExhbXBdIHdhcycsICd0aGVyZSB3YXMgdHJlYXN1cmUnKTtcbiAgfVxuXG4gIGNvbnN0IHJhZ2VUcmFkZUluID0gcm9tLm5wY3NbMHhjM10ubG9jYWxEaWFsb2dzLmdldCgtMSkhWzBdLmNvbmRpdGlvbiAmIDB4ZmY7XG4gIGNvbnN0IHJhZ2VJdGVtID0gcm9tLnByZ1sweDNkMzM3XTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBlOjAzJywgJ1swMjpTd29yZCBvZiBXYXRlcl0nLCBpdGVtKHJhZ2VUcmFkZUluKSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwZTowMycsICdbMDk6QmFsbCBvZiBXYXRlcl0nLCBpdGVtKHJhZ2VJdGVtKSk7XG5cbiAgLy8gVE9ETyAtIG1lc3NhZ2UgMTA6MGMgaXMgb25seSBoYWxmLWNvcnJlY3QuICBJZiBpdGVtIG5hbWVzIGFyZSByYW5kb21pemVkXG4gIC8vIHRoZW4gZXZlbiB3aXRob3V0IGEgbG9jYXRpb24gdGhlIG1lc3NhZ2UgaXMgc3RpbGwgdXNlZnVsLiAgU28ganVzdCBkbyB0aGF0XG4gIC8vIGZvciBub3csIGFuZCB3ZSBjYW4gZmluZCBhIHdheSB0byBoaW50IGxhdGVyLlxuICByZXBsYWNlTWVzc2FnZSgnMTA6MGMnLCAndGhhdFxcJ3MnLCAnaXMnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEwOjBjJywgLywgaXMgaW4gdGhlXFwrbGlnaHRob3VzZS8sICcnKTtcblxuICBjb25zdCBhcnlsbGlzVHJhZGVJbiA9IHRyYWRlSW5zLmdldCgweDIzKTtcbiAgaWYgKGFyeWxsaXNUcmFkZUluICE9IG51bGwpIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTI6MDUnLCAnWzNjOktpcmlzYSBQbGFudF0nLCBpdGVtKGFyeWxsaXNUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzEyOjEwJywgJ3RoZSBwbGFudCcsIGB0aGUgJHtjb21tb25Ob3VuKGFyeWxsaXNUcmFkZUluKX1gKTtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTI6MTAnLCAnWzNjOktpcmlzYSBQbGFudF0nLCBpdGVtKGFyeWxsaXNUcmFkZUluKSk7XG4gICAgLy8gVE9ETyAtIHJlZnMgaW4gMTI6MDkgYW5kIDEyOjBhIGhhdmUgbG9jYXRpb24sIHRvby5cbiAgICAvLyByZXBsYWNlTWVzc2FnZSgnMTI6MDknLCAvXFxzKlxcbi4qLywgJy4nKTtcbiAgICAvLyByZXBsYWNlTWVzc2FnZSgnMTI6MGEnLCAvXFxzKlxcbi4qLywgJy4nKTtcbiAgICBjb25zdCBjbHVlID0gYE91ciBpbGx1c3RyaW91cyBjaGllZiBzZWVrcyAke3ZhZ3VlKGFyeWxsaXNUcmFkZUluKX0uYDtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTI6MDknLCAvW15dKi8sIGNsdWUpO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxMjowYScsIC9bXl0qLywgY2x1ZSk7XG4gIH1cblxuICBjb25zdCBsb3ZlUGVuZGFudFRyYWRlSW4gPSB0cmFkZUlucy5nZXQoMHg3NCk7XG4gIGlmIChsb3ZlUGVuZGFudFRyYWRlSW4gIT0gbnVsbCkge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxMzowMicsICdbM2I6TG92ZSBQZW5kYW50XScsIGl0ZW0obG92ZVBlbmRhbnRUcmFkZUluKSk7XG4gIH1cbiAgY29uc3QgY2hhbmdlU2xvdCA9IHJvbS5wcmdbMHgzZDZkZV07XG4gIGlmIChjaGFuZ2VTbG90IDwgMHg0MSkge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxMzowMicsICd0ZWFjaFxccyt5b3UgdGhlIG1hZ2ljIG9mJywgJ2Jlc3Rvd1xcbiB1cG9uIHlvdSB0aGUnKTtcbiAgfVxuICByZXBsYWNlTWVzc2FnZSgnMTM6MDInLCAnWzQ3OkNoYW5nZV0nLCBpdGVtKGNoYW5nZVNsb3QpKTtcblxuICBjb25zdCBpdm9yeVN0YXR1ZVRyYWRlSW4gPSB0cmFkZUlucy5nZXQoMHg3NSk7XG4gIGlmIChpdm9yeVN0YXR1ZVRyYWRlSW4gIT0gbnVsbCkge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxODowNicsICdbM2Q6SXZvcnkgU3RhdHVlXScsIGl0ZW0oaXZvcnlTdGF0dWVUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA3JywgJ1szZDpJdm9yeSBTdGF0dWVdJywgaXRlbShpdm9yeVN0YXR1ZVRyYWRlSW4pKTtcbiAgfVxuICByZXBsYWNlTWVzc2FnZSgnMTg6MDYnLCBgSXQncyBpbiBhIHJvb21gLCAnezBiOkthcm1pbmV9IGlzJyk7XG4gIGNvbnN0IGZsaWdodFNsb3QgPSByb20ucHJnWzB4M2QxOGZdO1xuICBpZiAoZmxpZ2h0U2xvdCA8IDB4NDEpIHJlcGxhY2VNZXNzYWdlKCcxODowNycsICd0ZWFjaCcsICdnaXZlJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxODowNycsICdbNDg6RmxpZ2h0XScsIGl0ZW0oZmxpZ2h0U2xvdCkpO1xuXG4gIGNvbnN0IHBhcmFseXNpc1Nsb3QgPSByb20ucHJnWzB4M2Q2NTVdO1xuICBpZiAocGFyYWx5c2lzU2xvdCA8IDB4NDEpIHVubWFnaWMoJzFjOjEwJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxYzoxMCcsICdbNDI6UGFyYWx5c2lzXScsIGl0ZW0ocGFyYWx5c2lzU2xvdCkpO1xuXG4gIHJlcGxhY2VNZXNzYWdlKCcyMDowNicsICdTdGF0dWUgb2YgR29sZCcsIGl0ZW0oMHgzYSkpO1xuXG4gIC8vIFRPRE8gLSBjb25zaWRlciB3YXJwaW5nIG9uIGEgcmFuZG9tIHN3b3JkPyAtIG1lc3NhZ2UgMWM6MTFcblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgZnVuY3Rpb24gdW5tYWdpYyhtaWQ6IHN0cmluZykge1xuICAgIHJlcGxhY2VNZXNzYWdlKG1pZCwgJ3RlYWNoIHlvdSB0aGUgbWFnaWMgb2YnLCAnYmVzdG93IHVwb24geW91IHRoZScpO1xuICB9XG4gIGZ1bmN0aW9uIGl0ZW0oaWQ6IG51bWJlcik6IHN0cmluZyB7XG4gICAgY29uc3QgaXRlbSA9IGl0ZW1nZXQoaWQpO1xuICAgIHJldHVybiBgWyR7aGV4KGl0ZW0uaWQpfToke2l0ZW0ubWVzc2FnZU5hbWV9XWA7XG4gIH1cbiAgZnVuY3Rpb24gcmVwbGFjZU1lc3NhZ2UobWlkOiBzdHJpbmcsIHBhdDogc3RyaW5nIHwgUmVnRXhwLCByZXBsOiBzdHJpbmcpIHtcbiAgICBjb25zdCBbcGFydCwgaW5kZXhdID0gbWlkLnNwbGl0KCc6JykubWFwKHggPT4gcGFyc2VJbnQoeCwgMTYpKTtcbiAgICBjb25zdCBtc2cgPSByb20ubWVzc2FnZXMucGFydHNbcGFydF1baW5kZXhdO1xuICAgIG1zZy50ZXh0ID0gbXNnLnRleHQucmVwbGFjZShwYXQsIHJlcGwpO1xuICB9XG4gIGZ1bmN0aW9uIGZpbmRMb290KC4uLmxvY3M6IG51bWJlcltdKSB7XG4gICAgZm9yIChjb25zdCBpZCBvZiBsb2NzKSB7XG4gICAgICBjb25zdCBsb2MgPSByb20ubG9jYXRpb25zW2lkXTtcbiAgICAgIGZvciAoY29uc3Qgc3Bhd24gb2YgbG9jLnNwYXducykge1xuICAgICAgICBpZiAoc3Bhd24uaXNDaGVzdCgpICYmIHNwYXduLmlkIDwgMHg0OCAmJiBpdGVtZ2V0KHNwYXduLmlkKS51bmlxdWUpIHtcbiAgICAgICAgICByZXR1cm4gc3Bhd24uaWQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIGZ1bmN0aW9uIGl0ZW1nZXQoaWQ6IG51bWJlcik6IEl0ZW0ge1xuICAgIGNvbnN0IGl0ZW1nZXQgPSByb20uaXRlbUdldHNbaWRdO1xuICAgIHJldHVybiByb20uaXRlbXNbaXRlbWdldC5pdGVtSWRdO1xuICB9XG59XG5cbmZ1bmN0aW9uIGZpbmRUb3JuZWxUcmFkZUluKHRvcm5lbDogTnBjKTogbnVtYmVyIHtcbiAgLy8gRXhwZWN0ZWQgc3RydWN0dXJlOlxuICAvLyAgIC4uLlxuICAvLyAgIE5PVCBicmFjZWxldCAtPiAuLi5cbiAgLy8gICBOT1QgYmFsbCAtPiAuLi5cbiAgLy8gICAtPiBnaXZlIGl0ZW1cbiAgZm9yIChjb25zdCBkcyBvZiB0b3JuZWwubG9jYWxEaWFsb2dzLnZhbHVlcygpKSB7XG4gICAgZm9yIChsZXQgaSA9IDI7IGkgPCBkcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaXRlbSA9IH5kc1tpXS5jb25kaXRpb247XG4gICAgICAvLyBMb29rIGZvciBhbnkgbmVnYXRpdmUgY29uZGl0aW9uIG9uIGEgYnJhY2VsZXQgKGRvZXNuJ3QgbWF0dGVyIHdoZXJlKVxuICAgICAgaWYgKGl0ZW0gPiAweDIwNCAmJiBpdGVtIDw9IDB4MjBjICYmICEoaXRlbSAmIDEpKSByZXR1cm4gaXRlbSAmIDB4ZmY7XG4gICAgfVxuICB9XG4gIHJldHVybiAweDA2OyAvLyBkZWZhdWx0IHRvIHRvcm5hZG8gYnJhY2VsZXRcbn1cblxuZnVuY3Rpb24gdmFndWUoaWQ6IG51bWJlcik6IHN0cmluZyB7XG4gIHN3aXRjaCAoaWQpIHtcbiAgICBjYXNlIDB4MjU6IHJldHVybiAnYW4gdW51c3VhbCBzdGF0dWUnO1xuICAgIGNhc2UgMHgyODogcmV0dXJuICdhIHJhcmUgaW5zdHJ1bWVudCc7XG4gICAgY2FzZSAweDM1OiByZXR1cm4gJ2EgYnJpbGxpYW50IGxhbXAnO1xuICAgIGNhc2UgMHgzYjogcmV0dXJuICdhIGJlYXV0aWZ1bCBjaGFybSc7XG4gICAgY2FzZSAweDNjOiByZXR1cm4gJ2EgZnJhZ3JhbnQgcGxhbnQnO1xuICAgIGNhc2UgMHgzZDogcmV0dXJuICdhbiBleG90aWMgc3RhdHVlJztcbiAgfVxuICBmYWlsKCk7XG4gIHJldHVybiAnYSB2YWx1YWJsZSBpdGVtJztcbn1cblxuZnVuY3Rpb24gY29tbW9uTm91bihpZDogbnVtYmVyKTogc3RyaW5nIHtcbiAgc3dpdGNoIChpZCkge1xuICAgIGNhc2UgMHgyNTogcmV0dXJuICdzdGF0dWUnO1xuICAgIGNhc2UgMHgyODogcmV0dXJuICdpbnN0cnVtZW50JztcbiAgICBjYXNlIDB4MzU6IHJldHVybiAnbGFtcCc7XG4gICAgY2FzZSAweDNiOiByZXR1cm4gJ3BlbmRhbnQnO1xuICAgIGNhc2UgMHgzYzogcmV0dXJuICdwbGFudCc7XG4gICAgY2FzZSAweDNkOiByZXR1cm4gJ3N0YXR1ZSc7XG4gIH1cbiAgZmFpbCgpO1xuICByZXR1cm4gJ2l0ZW0nO1xufVxuXG4vLyBmdW5jdGlvbiByZXBsYWNlRGlhbG9nKG5wYzogTnBjLCBvcmlnOiBudW1iZXIgfCBSZWdFeHAsIHJlcGxhY2VtZW50SWQ6IG51bWJlcikge1xuLy8gICBjb25zdCByb20gPSBucGMucm9tO1xuLy8gICBjb25zdCBwYXQgPSBvcmlnIGluc3RhbmNlb2YgUmVnRXhwID8gb3JpZyA6IHBhdHRlcm4ocm9tLml0ZW1zW29yaWddKTtcbi8vICAgY29uc3QgcmVwbCA9IHJlcGxhY2VtZW50KHJvbS5pdGVtc1tyZXBsYWNlbWVudElkXSk7XG4vLyAgIGZvciAoY29uc3QgZHMgb2YgbnBjLmxvY2FsRGlhbG9ncy52YWx1ZXMoKSkge1xuLy8gICAgIGZvciAoY29uc3QgZCBvZiBkcykge1xuLy8gICAgICAgY29uc3QgbWlkID0gZC5tZXNzYWdlO1xuLy8gICAgICAgcmVwbGFjZU1lc3NhZ2Uocm9tLCBtaWQucGFydCwgbWlkLmluZGV4LCBwYXQsIHJlcGwpO1xuLy8gICAgIH1cbi8vICAgfVxuLy8gfVxuXG4vLyBjb25zdCBwYXR0ZXJuOiB7KGlkOiBudW1iZXIsIG5hbWU6IHN0cmluZyk6IFJlZ0V4cDtcbi8vICAgICAgICAgICAgICAgICAoaXRlbTogSXRlbSk6IFJlZ0V4cH0gPVxuLy8gICAgIChpdGVtOiBudW1iZXIgfCBJdGVtLCBuYW1lPzogc3RyaW5nKSA9PiB7XG4vLyAgICAgICBuYW1lID0gbmFtZSB8fCAoaXRlbSBhcyBJdGVtKS5tZXNzYWdlTmFtZTtcbi8vICAgICAgIGNvbnN0IGlkID0gaGV4KGl0ZW0gaW5zdGFuY2VvZiBJdGVtID8gaXRlbS5pZCA6IGl0ZW0pO1xuLy8gICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoYFxcXFxbJHtpZH06W15cXFxcXV0qXFxcXF18JHtuYW1lLnJlcGxhY2UoL1xccysvZywgJ1xcXFxzKycpfWAsXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAnZycpO1xuLy8gICAgIH07XG5cbi8vIGZ1bmN0aW9uIHJlcGxhY2VtZW50KGl0ZW06IEl0ZW0pOiBzdHJpbmcge1xuLy8gICByZXR1cm4gYFske2hleChpdGVtLmlkKX06JHtpdGVtLm1lc3NhZ2VOYW1lfV1gO1xuLy8gfVxuIl19