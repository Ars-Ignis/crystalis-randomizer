import { paletteTypes } from '../rom/tileset.js';
import { seq } from '../rom/util.js';
import { DefaultMap } from '../util.js';
export function shufflePalettes(rom, flags, random) {
    new Shuffle(rom, flags, random).shuffle();
}
class Shuffle {
    constructor(rom, flags, random) {
        this.rom = rom;
        this.flags = flags;
        this.random = random;
    }
    shuffle() {
        this.shuffleBackgrounds();
    }
    shuffleBackgrounds() {
        if (!this.flags.shuffleTilePalettes())
            return;
        const partitions = new DefaultMap(() => []);
        for (const l of this.rom.locations) {
            partitions.get(l.data.palette).push(l);
        }
        const pal = [new Map(), new Map()];
        for (const part of partitions.values()) {
            for (const l of part) {
                for (let i = 0; i < 2; i++) {
                    for (let j = 0; j < 2; j++) {
                        let set = pal[i].get(l.tilePatterns[j]);
                        if (!set)
                            pal[i].set(l.tilePatterns[j], set = new Set());
                        set.add(l.tilePalettes[i]);
                    }
                }
            }
        }
        for (const part of partitions.values()) {
            const l = part[0];
            const s = [new Set(), new Set()];
            for (let i = 0; i < 2; i++) {
                s[i] = new Set([...pal[i].get(l.tilePatterns[0]),
                    ...pal[i].get(l.tilePatterns[1]),]);
            }
            const p0 = this.random.pick([...s[0]]);
            const p1 = this.random.pick([...s[1]]);
            for (const loc of part) {
                loc.tilePalettes[0] = p0;
                loc.tilePalettes[1] = p1;
            }
        }
    }
    shuffleBackgrounds2() {
        if (!this.flags.shuffleTilePalettes())
            return;
        function eq(a, b) {
            return a.tilePalettes[0] === b.tilePalettes[0] &&
                a.tilePalettes[1] === b.tilePalettes[1] &&
                a.tilePalettes[2] === b.tilePalettes[2];
        }
        const [] = [eq];
        const paletteSets = [new Set(), new Set()];
        for (const loc of this.rom.locations) {
            if (!loc.used)
                continue;
            const tileset = this.rom.tilesets[(loc.tileset & 0x7f) >> 2];
            const types = paletteTypes(tileset.id, loc.id);
            for (let i = 0; i < 3; i++) {
                for (let i = 0; i < types[i]; i++) {
                    paletteSets[i].add(loc.tilePalettes[i]);
                }
            }
        }
        const partitions = [];
        const palettes = paletteSets.map(s => [...s]);
        for (const part of partitions) {
            const rep = part[1];
            const repTypes = paletteTypes(rep.tileset, rep.id);
            for (let attempt = 0; attempt < 1000; attempt++) {
                const pals = seq(3, i => !repTypes[i] ? rep.tilePalettes[i] :
                    this.random.pick(palettes[repTypes[i] - 1]));
                const ps = pals.map(p => this.rom.palettes[p].colors);
                let found = true;
                for (const loc of part[0]) {
                    const [, , , validator] = paletteTypes(loc.tileset, loc.id);
                    if (validator && !validator(ps[0], ps[1], ps[2])) {
                        found = false;
                        break;
                    }
                }
                if (found) {
                    for (const loc of part[0]) {
                        loc.tilePalettes = [pals[0], pals[1], pals[2]];
                    }
                }
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZXBhbGV0dGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3Mvc2h1ZmZsZXBhbGV0dGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUMvQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUd4QyxNQUFNLFVBQVUsZUFBZSxDQUFDLEdBQVEsRUFBRSxLQUFjLEVBQUUsTUFBYztJQUN0RSxJQUFJLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzVDLENBQUM7QUFFRCxNQUFNLE9BQU87SUFDWCxZQUFxQixHQUFRLEVBQ1IsS0FBYyxFQUNkLE1BQWM7UUFGZCxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQ1IsVUFBSyxHQUFMLEtBQUssQ0FBUztRQUNkLFdBQU0sR0FBTixNQUFNLENBQVE7SUFBRyxDQUFDO0lBRXZDLE9BQU87UUFDTCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQsa0JBQWtCO1FBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFO1lBQUUsT0FBTztRQWdEOUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxVQUFVLENBQXNCLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDbEMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4QztRQUVELE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxH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Q0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDaEQ7aUJBQ0Y7YUFDRjtTQUNGO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtGbGFnU2V0fSBmcm9tICcuLi9mbGFnc2V0LmpzJztcbmltcG9ydCB7UmFuZG9tfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0xvY2F0aW9ufSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHtwYWxldHRlVHlwZXN9IGZyb20gJy4uL3JvbS90aWxlc2V0LmpzJztcbmltcG9ydCB7c2VxfSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQgeyBEZWZhdWx0TWFwIH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5cbi8vIFNodWZmbGUgdGhlIHBhbGV0dGVzLlxuZXhwb3J0IGZ1bmN0aW9uIHNodWZmbGVQYWxldHRlcyhyb206IFJvbSwgZmxhZ3M6IEZsYWdTZXQsIHJhbmRvbTogUmFuZG9tKSB7XG4gIG5ldyBTaHVmZmxlKHJvbSwgZmxhZ3MsIHJhbmRvbSkuc2h1ZmZsZSgpO1xufVxuXG5jbGFzcyBTaHVmZmxlIHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20sXG4gICAgICAgICAgICAgIHJlYWRvbmx5IGZsYWdzOiBGbGFnU2V0LFxuICAgICAgICAgICAgICByZWFkb25seSByYW5kb206IFJhbmRvbSkge31cblxuICBzaHVmZmxlKCkge1xuICAgIHRoaXMuc2h1ZmZsZUJhY2tncm91bmRzKCk7XG4gIH1cblxuICBzaHVmZmxlQmFja2dyb3VuZHMoKSB7XG4gICAgaWYgKCF0aGlzLmZsYWdzLnNodWZmbGVUaWxlUGFsZXR0ZXMoKSkgcmV0dXJuO1xuXG4gICAgLy8gZnVuY3Rpb24gZXEoYTogTG9jYXRpb24sIGI6IExvY2F0aW9uKTogYm9vbGVhbiB7XG4gICAgLy8gICByZXR1cm4gYS50aWxlUGFsZXR0ZXNbMF0gPT09IGIudGlsZVBhbGV0dGVzWzBdICYmXG4gICAgLy8gICAgICAgYS50aWxlUGFsZXR0ZXNbMV0gPT09IGIudGlsZVBhbGV0dGVzWzFdICYmXG4gICAgLy8gICAgICAgYS50aWxlUGFsZXR0ZXNbMl0gPT09IGIudGlsZVBhbGV0dGVzWzJdICYmXG4gICAgLy8gICAgICAgLy8gYS50aWxlUGF0dGVybnNbMF0gPT09IGIudGlsZVBhdHRlcm5zWzBdICYmXG4gICAgLy8gICAgICAgLy8gYS50aWxlUGF0dGVybnNbMV0gPT09IGIudGlsZVBhdHRlcm5zWzFdICYmXG4gICAgLy8gICAgICAgLy8gYS50aWxlc2V0ID09PSBiLnRpbGVzZXQgJiZcbiAgICAvLyAgICAgICBhLnRpbGVFZmZlY3RzID09PSBiLnRpbGVFZmZlY3RzO1xuICAgIC8vIH1cblxuICAgIC8vIGNvbnN0IHBhbGV0dGVzID0gW1xuICAgIC8vICAgMHgwMSwgMHgwNywgXG5cbiAgICAvLyAvLyBLZXk6ICh0aWxlSWQvc2NyZWVuSWQpIDw8IDggfCB0aWxlc2V0XG4gICAgLy8gLy8gVmFsdWU6IFNldDx+cGF0dGVybiB8IHBhbGV0dGU+XG4gICAgLy8gY29uc3QgdGlsZUNhY2hlID0gbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpO1xuICAgIC8vIGNvbnN0IHNjcmVlbkNhY2hlID0gbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpO1xuXG4gICAgLy8gZnVuY3Rpb24gc2NyZWVuRGF0YShzY3JlZW46IG51bWJlciwgdGlsZXNldDogbnVtYmVyKSB7XG5cbiAgICAvLyB9XG5cbiAgICAvLyBmb3IgKGNvbnN0IGxvYyBvZiByb20ubG9jYXRpb25zKSB7XG4gICAgLy8gICBpZiAoIWxvYy51c2VkKSBjb250aW51ZTtcbiAgICAvLyAgIGNvbnN0IHRpbGVzZXQgPSByb20udGlsZXNldHNbKGxvYy50aWxlc2V0ICYgMHg3ZikgPj4gMl07XG4gICAgLy8gICBmb3IgKGNvbnN0IHNjcmVlbiBvZiBsb2MuYWxsU2NyZWVucygpKSB7XG4gICAgLy8gICAgIGNvbnN0IGdyYXBoaWNzID0gbmV3IFNldCgpO1xuICAgIC8vICAgICBmb3IgKGNvbnN0IHRpbGUgb2Ygc2NyZWVuLnRpbGVzKSB7XG4gICAgLy8gICAgICAgY29uc3QgdGlsZUlkID0gdGlsZSA8PCA4IHwgdGlsZXNldC5pZDtcbiAgICAvLyAgICAgICBjb25zdCBwcmV2ID0gdGlsZUNhY2hlLmdldCh0aWxlSWQpO1xuICAgIC8vICAgICAgIGlmIChwcmV2KSB7XG4gICAgLy8gICAgICAgICBmb3IgKGNvbnN0IGcgb2YgcHJldikgZ3JhcGhpY3MuYWRkKGcpO1xuICAgIC8vICAgICAgICAgY29udGludWU7XG4gICAgLy8gICAgICAgfVxuICAgIC8vICAgICAgIGNvbnN0IHNldCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIC8vICAgICAgIGZvciAoY29uc3QgcXVhZCBvZiB0aWxlc2V0LnRpbGVzKSB7XG4gICAgLy8gICAgICAgICBzZXQuYWRkKH5xdWFkW3RpbGVdKTtcbiAgICAvLyAgICAgICAgIGdyYXBoaWNzLmFkZCh+cXVhZFt0aWxlXSk7XG4gICAgLy8gICAgICAgfVxuICAgIC8vICAgICAgIHNldC5hZGQodGlsZXNldC5hdHRyc1t0aWxlXSk7XG4gICAgLy8gICAgICAgZ3JhcGhpY3MuYWRkKHRpbGVzZXQuYXR0cnNbdGlsZV0pO1xuICAgIC8vICAgICAgIHRpbGVDYWNoZS5zZXQodGlsZUlkLCBzZXQpO1xuICAgIC8vICAgICB9XG4gICAgLy8gICB9XG4gICAgLy8gfVxuXG4gICAgY29uc3QgcGFydGl0aW9ucyA9IG5ldyBEZWZhdWx0TWFwPHVua25vd24sIExvY2F0aW9uW10+KCgpID0+IFtdKTtcbiAgICBmb3IgKGNvbnN0IGwgb2YgdGhpcy5yb20ubG9jYXRpb25zKSB7XG4gICAgICBwYXJ0aXRpb25zLmdldChsLmRhdGEucGFsZXR0ZSkucHVzaChsKTtcbiAgICB9XG5cbiAgICBjb25zdCBwYWwgPSBbbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpLCBuZXcgTWFwPG51bWJlciwgU2V0PG51bWJlcj4+KCldO1xuXG4gICAgLy8gZmlsbCBgcGFsYCB3aXRoIGFsbCBwYWxldHRlcywgZ3JvdXBlZCBieSBwYXR0ZXJuLlxuICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0aXRpb25zLnZhbHVlcygpKSB7XG4gICAgICBmb3IgKGNvbnN0IGwgb2YgcGFydCkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI7IGkrKykge1xuICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMjsgaisrKSB7XG4gICAgICAgICAgICAvLyBUT0RPIC0gY2hlY2sgdGhhdCBwYXR0ZXJucyBhbmQgcGFsZXR0ZXMgYWN0dWFsbHkgVVNFRD9cbiAgICAgICAgICAgIGxldCBzZXQgPSBwYWxbaV0uZ2V0KGwudGlsZVBhdHRlcm5zW2pdKTtcbiAgICAgICAgICAgIGlmICghc2V0KSBwYWxbaV0uc2V0KGwudGlsZVBhdHRlcm5zW2pdLCBzZXQgPSBuZXcgU2V0KCkpO1xuICAgICAgICAgICAgc2V0LmFkZChsLnRpbGVQYWxldHRlc1tpXSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gcmVzZXQgcGFsZXR0ZXNcbiAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGFydGl0aW9ucy52YWx1ZXMoKSkge1xuICAgICAgY29uc3QgbCA9IHBhcnRbMF07XG4gICAgICBjb25zdCBzID0gW25ldyBTZXQ8bnVtYmVyPigpLCBuZXcgU2V0PG51bWJlcj4oKV07XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI7IGkrKykge1xuICAgICAgICBzW2ldID0gbmV3IFNldDxudW1iZXI+KFsuLi5wYWxbaV0uZ2V0KGwudGlsZVBhdHRlcm5zWzBdKSEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnBhbFtpXS5nZXQobC50aWxlUGF0dGVybnNbMV0pISxdKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcDAgPSB0aGlzLnJhbmRvbS5waWNrKFsuLi5zWzBdXSk7XG4gICAgICBjb25zdCBwMSA9IHRoaXMucmFuZG9tLnBpY2soWy4uLnNbMV1dKTtcbiAgICAgIGZvciAoY29uc3QgbG9jIG9mIHBhcnQpIHtcbiAgICAgICAgbG9jLnRpbGVQYWxldHRlc1swXSA9IHAwO1xuICAgICAgICBsb2MudGlsZVBhbGV0dGVzWzFdID0gcDE7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gVE9ETyAtIHRoaXMgYWxnb3JpdGhtIGlzIG11Y2ggbGVzcyBzYXRpc2Z5aW5nLlxuICBzaHVmZmxlQmFja2dyb3VuZHMyKCkge1xuICAgIGlmICghdGhpcy5mbGFncy5zaHVmZmxlVGlsZVBhbGV0dGVzKCkpIHJldHVybjtcblxuICAgIGZ1bmN0aW9uIGVxKGE6IExvY2F0aW9uLCBiOiBMb2NhdGlvbik6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuIGEudGlsZVBhbGV0dGVzWzBdID09PSBiLnRpbGVQYWxldHRlc1swXSAmJlxuICAgICAgICAgIGEudGlsZVBhbGV0dGVzWzFdID09PSBiLnRpbGVQYWxldHRlc1sxXSAmJlxuICAgICAgICAgIGEudGlsZVBhbGV0dGVzWzJdID09PSBiLnRpbGVQYWxldHRlc1syXTtcbiAgICAgICAgICAvLyBhLnRpbGVQYXR0ZXJuc1swXSA9PT0gYi50aWxlUGF0dGVybnNbMF0gJiZcbiAgICAgICAgICAvLyBhLnRpbGVQYXR0ZXJuc1sxXSA9PT0gYi50aWxlUGF0dGVybnNbMV0gJiZcbiAgICAgICAgICAvLyBhLnRpbGVzZXQgPT09IGIudGlsZXNldCAmJlxuICAgICAgICAgIC8vIGEudGlsZUVmZmVjdHMgPT09IGIudGlsZUVmZmVjdHM7XG4gICAgfVxuICAgIGNvbnN0IFtdID0gW2VxXTtcblxuICAgIC8vIGNvbnN0IHBhbGV0dGVzID0gW1xuICAgIC8vICAgMHgwMSwgMHgwNywgXG5cbiAgICAvLyAvLyBLZXk6ICh0aWxlSWQvc2NyZWVuSWQpIDw8IDggfCB0aWxlc2V0XG4gICAgLy8gLy8gVmFsdWU6IFNldDx+cGF0dGVybiB8IHBhbGV0dGU+XG4gICAgLy8gY29uc3QgdGlsZUNhY2hlID0gbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpO1xuICAgIC8vIGNvbnN0IHNjcmVlbkNhY2hlID0gbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpO1xuXG4gICAgLy8gZnVuY3Rpb24gc2NyZWVuRGF0YShzY3JlZW46IG51bWJlciwgdGlsZXNldDogbnVtYmVyKSB7XG5cbiAgICAvLyB9XG5cbiAgICBjb25zdCBwYWxldHRlU2V0cyA9IFtuZXcgU2V0PG51bWJlcj4oKSwgbmV3IFNldDxudW1iZXI+KCldO1xuXG4gICAgZm9yIChjb25zdCBsb2Mgb2YgdGhpcy5yb20ubG9jYXRpb25zKSB7XG4gICAgICBpZiAoIWxvYy51c2VkKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IHRpbGVzZXQgPSB0aGlzLnJvbS50aWxlc2V0c1sobG9jLnRpbGVzZXQgJiAweDdmKSA+PiAyXTtcbiAgICAgIGNvbnN0IHR5cGVzID0gcGFsZXR0ZVR5cGVzKHRpbGVzZXQuaWQsIGxvYy5pZCk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7IGkrKykge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8ICh0eXBlc1tpXSBhcyBudW1iZXIpOyBpKyspIHtcbiAgICAgICAgICBwYWxldHRlU2V0c1tpXS5hZGQobG9jLnRpbGVQYWxldHRlc1tpXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBwYXJ0aXRpb25zOiBhbnlbXSA9IFtdOyAvLyB0aGlzLnJvbS5sb2NhdGlvbnMucGFydGl0aW9uKHggPT4geCwgZXEsIHRydWUpO1xuXG4gICAgY29uc3QgcGFsZXR0ZXMgPSBwYWxldHRlU2V0cy5tYXAocyA9PiBbLi4uc10pO1xuICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0aXRpb25zKSB7XG4gICAgICBjb25zdCByZXAgPSBwYXJ0WzFdOyAvLyByZXByZXNlbnRhdGl2ZSBsb2NhdGlvblxuICAgICAgY29uc3QgcmVwVHlwZXM6IG51bWJlcltdID0gcGFsZXR0ZVR5cGVzKHJlcC50aWxlc2V0LCByZXAuaWQpIGFzIGFueTtcbiAgICAgIGZvciAobGV0IGF0dGVtcHQgPSAwOyBhdHRlbXB0IDwgMTAwMDsgYXR0ZW1wdCsrKSB7XG4gICAgICAgIGNvbnN0IHBhbHMgPSBzZXEoMywgaSA9PiAhcmVwVHlwZXNbaV0gPyByZXAudGlsZVBhbGV0dGVzW2ldIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJhbmRvbS5waWNrKHBhbGV0dGVzW3JlcFR5cGVzW2ldIC0gMV0pKTtcbiAgICAgICAgY29uc3QgcHMgPSBwYWxzLm1hcChwID0+IHRoaXMucm9tLnBhbGV0dGVzW3BdLmNvbG9ycyk7XG4gICAgICAgIGxldCBmb3VuZCA9IHRydWU7XG4gICAgICAgIGZvciAoY29uc3QgbG9jIG9mIHBhcnRbMF0pIHtcbiAgICAgICAgICBjb25zdCBbLCwsIHZhbGlkYXRvcl0gPSBwYWxldHRlVHlwZXMobG9jLnRpbGVzZXQsIGxvYy5pZCk7XG4gICAgICAgICAgaWYgKHZhbGlkYXRvciAmJiAhdmFsaWRhdG9yKHBzWzBdLCBwc1sxXSwgcHNbMl0pKSB7XG4gICAgICAgICAgICBmb3VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChmb3VuZCkge1xuICAgICAgICAgIGZvciAoY29uc3QgbG9jIG9mIHBhcnRbMF0pIHtcbiAgICAgICAgICAgIGxvYy50aWxlUGFsZXR0ZXMgPSBbcGFsc1swXSwgcGFsc1sxXSwgcGFsc1syXV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=