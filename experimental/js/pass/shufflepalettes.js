import { paletteTypes } from '../rom/tileset.js';
import { seq } from '../rom/util.js';
import { DefaultMap } from '../util.js';
export function shufflePalettes(rom, flags, random) {
    new Shuffle(rom, flags, random).shuffle();
}
class Shuffle {
    constructor(rom, flags, random) {
        this.rom = rom;
        this.flags = flags;
        this.random = random;
    }
    shuffle() {
        this.shuffleBackgrounds();
    }
    shuffleBackgrounds() {
        if (!this.flags.shuffleSpritePalettes())
            return;
        const partitions = new DefaultMap(() => []);
        for (const l of this.rom.locations) {
            partitions.get(l.data.palette).push(l);
        }
        const pal = [new Map(), new Map()];
        for (const part of partitions.values()) {
            for (const l of part) {
                for (let i = 0; i < 2; i++) {
                    for (let j = 0; j < 2; j++) {
                        let set = pal[i].get(l.tilePatterns[j]);
                        if (!set)
                            pal[i].set(l.tilePatterns[j], set = new Set());
                        set.add(l.tilePalettes[i]);
                    }
                }
            }
        }
        for (const part of partitions.values()) {
            const l = part[0];
            const s = [new Set(), new Set()];
            for (let i = 0; i < 2; i++) {
                s[i] = new Set([...pal[i].get(l.tilePatterns[0]),
                    ...pal[i].get(l.tilePatterns[1]),]);
            }
            const p0 = this.random.pick([...s[0]]);
            const p1 = this.random.pick([...s[1]]);
            for (const loc of part) {
                loc.tilePalettes[0] = p0;
                loc.tilePalettes[1] = p1;
            }
        }
    }
    shuffleBackgrounds2() {
        if (!this.flags.shuffleSpritePalettes())
            return;
        function eq(a, b) {
            return a.tilePalettes[0] === b.tilePalettes[0] &&
                a.tilePalettes[1] === b.tilePalettes[1] &&
                a.tilePalettes[2] === b.tilePalettes[2];
        }
        const [] = [eq];
        const paletteSets = [new Set(), new Set()];
        for (const loc of this.rom.locations) {
            if (!loc.used)
                continue;
            const tileset = this.rom.tilesets[(loc.tileset & 0x7f) >> 2];
            const types = paletteTypes(tileset.id, loc.id);
            for (let i = 0; i < 3; i++) {
                for (let i = 0; i < types[i]; i++) {
                    paletteSets[i].add(loc.tilePalettes[i]);
                }
            }
        }
        const partitions = [];
        const palettes = paletteSets.map(s => [...s]);
        for (const part of partitions) {
            const rep = part[1];
            const repTypes = paletteTypes(rep.tileset, rep.id);
            for (let attempt = 0; attempt < 1000; attempt++) {
                const pals = seq(3, i => !repTypes[i] ? rep.tilePalettes[i] :
                    this.random.pick(palettes[repTypes[i] - 1]));
                const ps = pals.map(p => this.rom.palettes[p].colors);
                let found = true;
                for (const loc of part[0]) {
                    const [, , , validator] = paletteTypes(loc.tileset, loc.id);
                    if (validator && !validator(ps[0], ps[1], ps[2])) {
                        found = false;
                        break;
                    }
                }
                if (found) {
                    for (const loc of part[0]) {
                        loc.tilePalettes = [pals[0], pals[1], pals[2]];
                    }
                }
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZXBhbGV0dGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3Mvc2h1ZmZsZXBhbGV0dGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUMvQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUd4QyxNQUFNLFVBQVUsZUFBZSxDQUFDLEdBQVEsRUFBRSxLQUFjLEVBQUUsTUFBYztJQUN0RSxJQUFJLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzVDLENBQUM7QUFFRCxNQUFNLE9BQU87SUFDWCxZQUFxQixHQUFRLEVBQ1IsS0FBYyxFQUNkLE1BQWM7UUFGZCxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQ1IsVUFBSyxHQUFMLEtBQUssQ0FBUztRQUNkLFdBQU0sR0FBTixNQUFNLENBQVE7SUFBRyxDQUFDO0lBRXZDLE9BQU87UUFDTCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQsa0JBQWtCO1FBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixFQUFFO1lBQUUsT0FBTztRQWdEaEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxVQUFVLENBQXNCLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDbEMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4QztRQUVELE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxH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Q0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDaEQ7aUJBQ0Y7YUFDRjtTQUNGO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtGbGFnU2V0fSBmcm9tICcuLi9mbGFnc2V0LmpzJztcbmltcG9ydCB7UmFuZG9tfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0xvY2F0aW9ufSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHtwYWxldHRlVHlwZXN9IGZyb20gJy4uL3JvbS90aWxlc2V0LmpzJztcbmltcG9ydCB7c2VxfSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQgeyBEZWZhdWx0TWFwIH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5cbi8vIFNodWZmbGUgdGhlIHBhbGV0dGVzLlxuZXhwb3J0IGZ1bmN0aW9uIHNodWZmbGVQYWxldHRlcyhyb206IFJvbSwgZmxhZ3M6IEZsYWdTZXQsIHJhbmRvbTogUmFuZG9tKSB7XG4gIG5ldyBTaHVmZmxlKHJvbSwgZmxhZ3MsIHJhbmRvbSkuc2h1ZmZsZSgpO1xufVxuXG5jbGFzcyBTaHVmZmxlIHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20sXG4gICAgICAgICAgICAgIHJlYWRvbmx5IGZsYWdzOiBGbGFnU2V0LFxuICAgICAgICAgICAgICByZWFkb25seSByYW5kb206IFJhbmRvbSkge31cblxuICBzaHVmZmxlKCkge1xuICAgIHRoaXMuc2h1ZmZsZUJhY2tncm91bmRzKCk7XG4gIH1cblxuICBzaHVmZmxlQmFja2dyb3VuZHMoKSB7XG4gICAgaWYgKCF0aGlzLmZsYWdzLnNodWZmbGVTcHJpdGVQYWxldHRlcygpKSByZXR1cm47XG5cbiAgICAvLyBmdW5jdGlvbiBlcShhOiBMb2NhdGlvbiwgYjogTG9jYXRpb24pOiBib29sZWFuIHtcbiAgICAvLyAgIHJldHVybiBhLnRpbGVQYWxldHRlc1swXSA9PT0gYi50aWxlUGFsZXR0ZXNbMF0gJiZcbiAgICAvLyAgICAgICBhLnRpbGVQYWxldHRlc1sxXSA9PT0gYi50aWxlUGFsZXR0ZXNbMV0gJiZcbiAgICAvLyAgICAgICBhLnRpbGVQYWxldHRlc1syXSA9PT0gYi50aWxlUGFsZXR0ZXNbMl0gJiZcbiAgICAvLyAgICAgICAvLyBhLnRpbGVQYXR0ZXJuc1swXSA9PT0gYi50aWxlUGF0dGVybnNbMF0gJiZcbiAgICAvLyAgICAgICAvLyBhLnRpbGVQYXR0ZXJuc1sxXSA9PT0gYi50aWxlUGF0dGVybnNbMV0gJiZcbiAgICAvLyAgICAgICAvLyBhLnRpbGVzZXQgPT09IGIudGlsZXNldCAmJlxuICAgIC8vICAgICAgIGEudGlsZUVmZmVjdHMgPT09IGIudGlsZUVmZmVjdHM7XG4gICAgLy8gfVxuXG4gICAgLy8gY29uc3QgcGFsZXR0ZXMgPSBbXG4gICAgLy8gICAweDAxLCAweDA3LCBcblxuICAgIC8vIC8vIEtleTogKHRpbGVJZC9zY3JlZW5JZCkgPDwgOCB8IHRpbGVzZXRcbiAgICAvLyAvLyBWYWx1ZTogU2V0PH5wYXR0ZXJuIHwgcGFsZXR0ZT5cbiAgICAvLyBjb25zdCB0aWxlQ2FjaGUgPSBuZXcgTWFwPG51bWJlciwgU2V0PG51bWJlcj4+KCk7XG4gICAgLy8gY29uc3Qgc2NyZWVuQ2FjaGUgPSBuZXcgTWFwPG51bWJlciwgU2V0PG51bWJlcj4+KCk7XG5cbiAgICAvLyBmdW5jdGlvbiBzY3JlZW5EYXRhKHNjcmVlbjogbnVtYmVyLCB0aWxlc2V0OiBudW1iZXIpIHtcblxuICAgIC8vIH1cblxuICAgIC8vIGZvciAoY29uc3QgbG9jIG9mIHJvbS5sb2NhdGlvbnMpIHtcbiAgICAvLyAgIGlmICghbG9jLnVzZWQpIGNvbnRpbnVlO1xuICAgIC8vICAgY29uc3QgdGlsZXNldCA9IHJvbS50aWxlc2V0c1sobG9jLnRpbGVzZXQgJiAweDdmKSA+PiAyXTtcbiAgICAvLyAgIGZvciAoY29uc3Qgc2NyZWVuIG9mIGxvYy5hbGxTY3JlZW5zKCkpIHtcbiAgICAvLyAgICAgY29uc3QgZ3JhcGhpY3MgPSBuZXcgU2V0KCk7XG4gICAgLy8gICAgIGZvciAoY29uc3QgdGlsZSBvZiBzY3JlZW4udGlsZXMpIHtcbiAgICAvLyAgICAgICBjb25zdCB0aWxlSWQgPSB0aWxlIDw8IDggfCB0aWxlc2V0LmlkO1xuICAgIC8vICAgICAgIGNvbnN0IHByZXYgPSB0aWxlQ2FjaGUuZ2V0KHRpbGVJZCk7XG4gICAgLy8gICAgICAgaWYgKHByZXYpIHtcbiAgICAvLyAgICAgICAgIGZvciAoY29uc3QgZyBvZiBwcmV2KSBncmFwaGljcy5hZGQoZyk7XG4gICAgLy8gICAgICAgICBjb250aW51ZTtcbiAgICAvLyAgICAgICB9XG4gICAgLy8gICAgICAgY29uc3Qgc2V0ID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgLy8gICAgICAgZm9yIChjb25zdCBxdWFkIG9mIHRpbGVzZXQudGlsZXMpIHtcbiAgICAvLyAgICAgICAgIHNldC5hZGQofnF1YWRbdGlsZV0pO1xuICAgIC8vICAgICAgICAgZ3JhcGhpY3MuYWRkKH5xdWFkW3RpbGVdKTtcbiAgICAvLyAgICAgICB9XG4gICAgLy8gICAgICAgc2V0LmFkZCh0aWxlc2V0LmF0dHJzW3RpbGVdKTtcbiAgICAvLyAgICAgICBncmFwaGljcy5hZGQodGlsZXNldC5hdHRyc1t0aWxlXSk7XG4gICAgLy8gICAgICAgdGlsZUNhY2hlLnNldCh0aWxlSWQsIHNldCk7XG4gICAgLy8gICAgIH1cbiAgICAvLyAgIH1cbiAgICAvLyB9XG5cbiAgICBjb25zdCBwYXJ0aXRpb25zID0gbmV3IERlZmF1bHRNYXA8dW5rbm93biwgTG9jYXRpb25bXT4oKCkgPT4gW10pO1xuICAgIGZvciAoY29uc3QgbCBvZiB0aGlzLnJvbS5sb2NhdGlvbnMpIHtcbiAgICAgIHBhcnRpdGlvbnMuZ2V0KGwuZGF0YS5wYWxldHRlKS5wdXNoKGwpO1xuICAgIH1cblxuICAgIGNvbnN0IHBhbCA9IFtuZXcgTWFwPG51bWJlciwgU2V0PG51bWJlcj4+KCksIG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKV07XG5cbiAgICAvLyBmaWxsIGBwYWxgIHdpdGggYWxsIHBhbGV0dGVzLCBncm91cGVkIGJ5IHBhdHRlcm4uXG4gICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhcnRpdGlvbnMudmFsdWVzKCkpIHtcbiAgICAgIGZvciAoY29uc3QgbCBvZiBwYXJ0KSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjsgaSsrKSB7XG4gICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAyOyBqKyspIHtcbiAgICAgICAgICAgIC8vIFRPRE8gLSBjaGVjayB0aGF0IHBhdHRlcm5zIGFuZCBwYWxldHRlcyBhY3R1YWxseSBVU0VEP1xuICAgICAgICAgICAgbGV0IHNldCA9IHBhbFtpXS5nZXQobC50aWxlUGF0dGVybnNbal0pO1xuICAgICAgICAgICAgaWYgKCFzZXQpIHBhbFtpXS5zZXQobC50aWxlUGF0dGVybnNbal0sIHNldCA9IG5ldyBTZXQoKSk7XG4gICAgICAgICAgICBzZXQuYWRkKGwudGlsZVBhbGV0dGVzW2ldKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyByZXNldCBwYWxldHRlc1xuICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0aXRpb25zLnZhbHVlcygpKSB7XG4gICAgICBjb25zdCBsID0gcGFydFswXTtcbiAgICAgIGNvbnN0IHMgPSBbbmV3IFNldDxudW1iZXI+KCksIG5ldyBTZXQ8bnVtYmVyPigpXTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjsgaSsrKSB7XG4gICAgICAgIHNbaV0gPSBuZXcgU2V0PG51bWJlcj4oWy4uLnBhbFtpXS5nZXQobC50aWxlUGF0dGVybnNbMF0pISxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ucGFsW2ldLmdldChsLnRpbGVQYXR0ZXJuc1sxXSkhLF0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwMCA9IHRoaXMucmFuZG9tLnBpY2soWy4uLnNbMF1dKTtcbiAgICAgIGNvbnN0IHAxID0gdGhpcy5yYW5kb20ucGljayhbLi4uc1sxXV0pO1xuICAgICAgZm9yIChjb25zdCBsb2Mgb2YgcGFydCkge1xuICAgICAgICBsb2MudGlsZVBhbGV0dGVzWzBdID0gcDA7XG4gICAgICAgIGxvYy50aWxlUGFsZXR0ZXNbMV0gPSBwMTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBUT0RPIC0gdGhpcyBhbGdvcml0aG0gaXMgbXVjaCBsZXNzIHNhdGlzZnlpbmcuXG4gIHNodWZmbGVCYWNrZ3JvdW5kczIoKSB7XG4gICAgaWYgKCF0aGlzLmZsYWdzLnNodWZmbGVTcHJpdGVQYWxldHRlcygpKSByZXR1cm47XG5cbiAgICBmdW5jdGlvbiBlcShhOiBMb2NhdGlvbiwgYjogTG9jYXRpb24pOiBib29sZWFuIHtcbiAgICAgIHJldHVybiBhLnRpbGVQYWxldHRlc1swXSA9PT0gYi50aWxlUGFsZXR0ZXNbMF0gJiZcbiAgICAgICAgICBhLnRpbGVQYWxldHRlc1sxXSA9PT0gYi50aWxlUGFsZXR0ZXNbMV0gJiZcbiAgICAgICAgICBhLnRpbGVQYWxldHRlc1syXSA9PT0gYi50aWxlUGFsZXR0ZXNbMl07XG4gICAgICAgICAgLy8gYS50aWxlUGF0dGVybnNbMF0gPT09IGIudGlsZVBhdHRlcm5zWzBdICYmXG4gICAgICAgICAgLy8gYS50aWxlUGF0dGVybnNbMV0gPT09IGIudGlsZVBhdHRlcm5zWzFdICYmXG4gICAgICAgICAgLy8gYS50aWxlc2V0ID09PSBiLnRpbGVzZXQgJiZcbiAgICAgICAgICAvLyBhLnRpbGVFZmZlY3RzID09PSBiLnRpbGVFZmZlY3RzO1xuICAgIH1cbiAgICBjb25zdCBbXSA9IFtlcV07XG5cbiAgICAvLyBjb25zdCBwYWxldHRlcyA9IFtcbiAgICAvLyAgIDB4MDEsIDB4MDcsIFxuXG4gICAgLy8gLy8gS2V5OiAodGlsZUlkL3NjcmVlbklkKSA8PCA4IHwgdGlsZXNldFxuICAgIC8vIC8vIFZhbHVlOiBTZXQ8fnBhdHRlcm4gfCBwYWxldHRlPlxuICAgIC8vIGNvbnN0IHRpbGVDYWNoZSA9IG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKTtcbiAgICAvLyBjb25zdCBzY3JlZW5DYWNoZSA9IG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKTtcblxuICAgIC8vIGZ1bmN0aW9uIHNjcmVlbkRhdGEoc2NyZWVuOiBudW1iZXIsIHRpbGVzZXQ6IG51bWJlcikge1xuXG4gICAgLy8gfVxuXG4gICAgY29uc3QgcGFsZXR0ZVNldHMgPSBbbmV3IFNldDxudW1iZXI+KCksIG5ldyBTZXQ8bnVtYmVyPigpXTtcblxuICAgIGZvciAoY29uc3QgbG9jIG9mIHRoaXMucm9tLmxvY2F0aW9ucykge1xuICAgICAgaWYgKCFsb2MudXNlZCkgY29udGludWU7XG4gICAgICBjb25zdCB0aWxlc2V0ID0gdGhpcy5yb20udGlsZXNldHNbKGxvYy50aWxlc2V0ICYgMHg3ZikgPj4gMl07XG4gICAgICBjb25zdCB0eXBlcyA9IHBhbGV0dGVUeXBlcyh0aWxlc2V0LmlkLCBsb2MuaWQpO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyBpKyspIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAodHlwZXNbaV0gYXMgbnVtYmVyKTsgaSsrKSB7XG4gICAgICAgICAgcGFsZXR0ZVNldHNbaV0uYWRkKGxvYy50aWxlUGFsZXR0ZXNbaV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgcGFydGl0aW9uczogYW55W10gPSBbXTsgLy8gdGhpcy5yb20ubG9jYXRpb25zLnBhcnRpdGlvbih4ID0+IHgsIGVxLCB0cnVlKTtcblxuICAgIGNvbnN0IHBhbGV0dGVzID0gcGFsZXR0ZVNldHMubWFwKHMgPT4gWy4uLnNdKTtcbiAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGFydGl0aW9ucykge1xuICAgICAgY29uc3QgcmVwID0gcGFydFsxXTsgLy8gcmVwcmVzZW50YXRpdmUgbG9jYXRpb25cbiAgICAgIGNvbnN0IHJlcFR5cGVzOiBudW1iZXJbXSA9IHBhbGV0dGVUeXBlcyhyZXAudGlsZXNldCwgcmVwLmlkKSBhcyBhbnk7XG4gICAgICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8IDEwMDA7IGF0dGVtcHQrKykge1xuICAgICAgICBjb25zdCBwYWxzID0gc2VxKDMsIGkgPT4gIXJlcFR5cGVzW2ldID8gcmVwLnRpbGVQYWxldHRlc1tpXSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yYW5kb20ucGljayhwYWxldHRlc1tyZXBUeXBlc1tpXSAtIDFdKSk7XG4gICAgICAgIGNvbnN0IHBzID0gcGFscy5tYXAocCA9PiB0aGlzLnJvbS5wYWxldHRlc1twXS5jb2xvcnMpO1xuICAgICAgICBsZXQgZm91bmQgPSB0cnVlO1xuICAgICAgICBmb3IgKGNvbnN0IGxvYyBvZiBwYXJ0WzBdKSB7XG4gICAgICAgICAgY29uc3QgWywsLCB2YWxpZGF0b3JdID0gcGFsZXR0ZVR5cGVzKGxvYy50aWxlc2V0LCBsb2MuaWQpO1xuICAgICAgICAgIGlmICh2YWxpZGF0b3IgJiYgIXZhbGlkYXRvcihwc1swXSwgcHNbMV0sIHBzWzJdKSkge1xuICAgICAgICAgICAgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZm91bmQpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGxvYyBvZiBwYXJ0WzBdKSB7XG4gICAgICAgICAgICBsb2MudGlsZVBhbGV0dGVzID0gW3BhbHNbMF0sIHBhbHNbMV0sIHBhbHNbMl1dO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19