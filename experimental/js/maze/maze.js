import { Grid } from './grid.js';
import { hex } from '../rom/util.js';
const [] = [hex];
export const OK = { ok: true, value: undefined };
export class MazeShuffle {
    constructor(loc, params) {
        this.loc = loc;
        this.attempts = 0;
        this.maxAttempts = 100;
        this.orig = loc.meta;
        this.params = params !== null && params !== void 0 ? params : this.survey(this.orig);
    }
    shuffle(random) {
        if (!this.loc.used)
            return;
        this.random = random;
        while (++this.attempts <= this.maxAttempts) {
            const result = this.build();
            if (result.ok) {
                this.finish(result.value);
                return;
            }
            console.log(`Shuffle failed ${this.loc}: ${result.fail}`);
        }
        this.reportFailure();
    }
    reportFailure() {
        console.error(`Completely failed to map shuffle ${this.loc}`);
    }
    finish(newMeta) {
        newMeta.transferFlags(this.loc.meta, this.random);
        newMeta.transferExits(this.loc.meta, this.random);
        newMeta.transferSpawns(this.loc.meta, this.random);
        newMeta.transferPits(this.loc.meta);
        this.loc.meta = newMeta;
    }
    pickHeight() {
        return Math.max(1, Math.min(16, this.orig.height +
            Math.floor((this.random.nextInt(6) - 1) / 3)));
    }
    pickWidth() {
        return Math.max(1, Math.min(8, this.orig.width +
            Math.floor((this.random.nextInt(6) - 1) / 3)));
    }
    pickSize() {
        return this.params.size + (this.random.nextInt(5) < 2 ? 1 : 0);
    }
    insertTile(a, pos, tile) {
        const s = this.posToGrid(pos);
        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                const g = s + r * 0x800 + c * 8;
                if (a.fixed.has(g))
                    return false;
                const v = a.grid.get(g);
                if (v && v !== tile[r * 3 + c])
                    return false;
            }
        }
        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                const g = s + r * 0x800 + c * 8;
                a.grid.set(g, tile[r * 3 + c]);
            }
        }
        return true;
    }
    posToGrid(pos, offset = 0) {
        const y = pos >>> 4;
        const x = pos & 0xf;
        return (y << 12 | x << 4) + offset;
    }
    insertPattern(a, pattern, { top = 0, bottom = 0, left = 0, right = 0 } = {}) {
        const ph = (pattern.length - 1) >>> 1;
        const pw = (pattern[0].length - 1) >>> 1;
        const dh = top + bottom;
        const dw = left + right;
        if (a.h < ph + dh)
            return { ok: false, fail: `too short` };
        if (a.w < pw + dw)
            return { ok: false, fail: `too narrow` };
        const y0 = this.random.nextInt(a.h - ph - 1 - dh) + top;
        const x0 = this.random.nextInt(a.w - pw - 1 - dh) + left;
        const c0 = (y0 + 1) << 12 | (x0 + 1) << 4;
        Grid.writeGrid2d(a.grid, c0, pattern);
        for (let y = 0x3000; y <= 0x5000; y += 0x800) {
            for (let x = 0x30; x <= 0x40; x += 0x8) {
                a.fixed.add(c0 + (y | x));
            }
        }
        return { ok: true, value: undefined };
    }
    extract(g, c, { h = 3, w = 3, replace = undefined, } = {}) {
        const index = g.index(c);
        let out = '';
        const end = index + h * g.row;
        const { row } = g;
        for (let r = index; r < end; r += row) {
            for (let i = r; i < r + w; i++) {
                if (replace) {
                    const s = replace.get(g.coord(i));
                    if (s != null) {
                        out += (s || ' ');
                        continue;
                    }
                }
                out += (g.data[i] || ' ');
            }
        }
        return out;
    }
    canSet(a, c, v) {
        return this.canSetAll(a, new Map([[c, v]]));
    }
    canSetAll(a, replace) {
        const screens = new Set();
        for (const c of replace.keys()) {
            if (a.fixed.has(c))
                return false;
            const s = (c & ~0x808);
            const y = s >>> 12;
            const x = (s >>> 4) & 0xf;
            if (x < a.w && y < a.h)
                screens.add(s);
            if (!(c & 8) && y < a.h && x)
                screens.add(s - 0x10);
            if (!(c & 0x800) && x < a.w && y)
                screens.add(s - 0x1000);
            if (!(c & 0x808) && x && y)
                screens.add(s - 0x1010);
        }
        for (const s of screens) {
            const tile = this.extract(a.grid, s, { replace });
            if (!this.orig.tileset.getMetascreensFromTileString(tile).length) {
                return false;
            }
        }
        return true;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF6ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9tYXplL21hemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBd0IsTUFBTSxXQUFXLENBQUM7QUFFdkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXJDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFnQ2pCLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBaUIsRUFBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsQ0FBQztBQUU3RCxNQUFNLE9BQWdCLFdBQVc7SUFRL0IsWUFBcUIsR0FBYSxFQUFFLE1BQWU7UUFBOUIsUUFBRyxHQUFILEdBQUcsQ0FBVTtRQUpsQyxhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsZ0JBQVcsR0FBRyxHQUFHLENBQUM7UUFJaEIsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxhQUFOLE1BQU0sY0FBTixNQUFNLEdBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELE9BQU8sQ0FBQyxNQUFjO1FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUk7WUFBRSxPQUFPO1FBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDMUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzVCLElBQUksTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDYixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFD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LENBQUMsQ0FBQztTQUNsRTtRQUNELEtBQUssTUFBTSxDQUFDLElBQUksT0FBTyxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBQyxPQUFPLEVBQUMsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUU7Z0JBQ2hFLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR3JpZCwgR3JpZENvb3JkLCBHcmlkSW5kZXggfSBmcm9tICcuL2dyaWQuanMnO1xuaW1wb3J0IHsgUmFuZG9tIH0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7IGhleCB9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7IE1ldGFsb2NhdGlvbiwgUG9zIH0gZnJvbSAnLi4vcm9tL21ldGFsb2NhdGlvbi5qcyc7XG5pbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJy4uL3JvbS9sb2NhdGlvbi5qcyc7XG5cbmNvbnN0IFtdID0gW2hleF07XG5cbnR5cGUgRmVhdHVyZSA9XG4gICAgLy8gY2F2ZXNcbiAgICAnYXJlbmEnIHwgJ2JyaWRnZScgfCAnb3ZlcicgfCAncGl0JyB8ICdyYW1wJyB8ICdyaXZlcicgfCAnc3Bpa2UnIHxcbiAgICAnc3RhdHVlJyB8ICd1bmRlcicgfCAnd2FsbCcgfCAnd2lkZScgfFxuICAgIC8vIG92ZXJ3b3JsZFxuICAgICdjYXZlJyB8ICdzaG9ydEdyYXNzJyB8ICdsb25nR3Jhc3MnIHwgJ2ljZUJyaWRnZScgfCAnd29vZEJyaWRnZScgfCAnY2FueW9uJztcblxuZXhwb3J0IGludGVyZmFjZSBTdXJ2ZXkge1xuICByZWFkb25seSBpZDogbnVtYmVyO1xuICByZWFkb25seSBtZXRhOiBNZXRhbG9jYXRpb247XG4gIHJlYWRvbmx5IHNpemU6IG51bWJlcjtcbiAgcmVhZG9ubHkgZWRnZXM/OiBudW1iZXJbXTsgLy8gW3RvcCwgbGVmdCwgYm90dG9tLCByaWdodF1cbiAgcmVhZG9ubHkgc3RhaXJzPzogbnVtYmVyW107IC8vIFt1cCwgZG93bl1cbiAgLy9wb2k/OiBudW1iZXI7XG4gIHJlYWRvbmx5IGZlYXR1cmVzPzoge1tmIGluIEZlYXR1cmVdPzogbnVtYmVyfTsgLy8gYSwgciwgcywgcCwgYiwgd1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF0dGVtcHQge1xuICByZWFkb25seSBncmlkOiBHcmlkPHN0cmluZz47XG4gIHJlYWRvbmx5IGZpeGVkOiBTZXQ8R3JpZENvb3JkPjtcbiAgcmVhZG9ubHkgdzogbnVtYmVyO1xuICByZWFkb25seSBoOiBudW1iZXI7XG4gIHJlYWRvbmx5IHNpemU6IG51bWJlcjtcbiAgY291bnQ6IG51bWJlcjtcbn1cblxuLy90eXBlIFN1cnZleVR5cGU8VCBleHRlbmRzIE1hemVTaHVmZmxlPiA9IFJldHVyblR5cGU8VFsnc3VydmV5J10+O1xuLy90eXBlIEF0dGVtcHRUeXBlPFQgZXh0ZW5kcyBNYXplU2h1ZmZsZT4gPSBSZXR1cm5UeXBlPFRbJ2F0dGVtcHQnXT47XG5cbmV4cG9ydCB0eXBlIFJlc3VsdDxUPiA9IHtvazogdHJ1ZSwgdmFsdWU6IFR9IHwge29rOiBmYWxzZSwgZmFpbDogc3RyaW5nfTtcbmV4cG9ydCBjb25zdCBPSzogUmVzdWx0PHZvaWQ+ID0ge29rOiB0cnVlLCB2YWx1ZTogdW5kZWZpbmVkfTtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE1hemVTaHVmZmxlIHtcblxuICByYW5kb20hOiBSYW5kb207IC8vIHNldCBpbiBzaHVmZmxlKCkgZm9yIGJldHRlciBBUEkuXG4gIG9yaWc6IE1ldGFsb2NhdGlvbjtcbiAgYXR0ZW1wdHMgPSAwO1xuICBtYXhBdHRlbXB0cyA9IDEwMDtcbiAgcGFyYW1zOiBTdXJ2ZXk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgbG9jOiBMb2NhdGlvbiwgcGFyYW1zPzogU3VydmV5KSB7XG4gICAgdGhpcy5vcmlnID0gbG9jLm1ldGE7XG4gICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgPz8gdGhpcy5zdXJ2ZXkodGhpcy5vcmlnKTtcbiAgfVxuXG4gIHNodWZmbGUocmFuZG9tOiBSYW5kb20pIHtcbiAgICBpZiAoIXRoaXMubG9jLnVzZWQpIHJldHVybjtcbiAgICB0aGlzLnJhbmRvbSA9IHJhbmRvbTtcbiAgICB3aGlsZSAoKyt0aGlzLmF0dGVtcHRzIDw9IHRoaXMubWF4QXR0ZW1wdHMpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYnVpbGQoKTtcbiAgICAgIGlmIChyZXN1bHQub2spIHtcbiAgICAgICAgdGhpcy5maW5pc2gocmVzdWx0LnZhbHVlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc29sZS5sb2coYFNodWZmbGUgZmFpbGVkICR7dGhpcy5sb2N9OiAke3Jlc3VsdC5mYWlsfWApO1xuICAgIH1cbiAgICB0aGlzLnJlcG9ydEZhaWx1cmUoKTtcbiAgfVxuXG4gIHJlcG9ydEZhaWx1cmUoKSB7XG4gICAgLy90aHJvdyBuZXcgRXJyb3IoYENvbXBsZXRlbHkgZmFpbGVkIHRvIG1hcCBzaHVmZmxlICR7bG9jfWApO1xuICAgIGNvbnNvbGUuZXJyb3IoYENvbXBsZXRlbHkgZmFpbGVkIHRvIG1hcCBzaHVmZmxlICR7dGhpcy5sb2N9YCk7XG4gIH1cblxuICBhYnN0cmFjdCBzdXJ2ZXkobWV0YTogTWV0YWxvY2F0aW9uKTogU3VydmV5O1xuXG4gIGFic3RyYWN0IGJ1aWxkKCk6IFJlc3VsdDxNZXRhbG9jYXRpb24+O1xuXG4gIGZpbmlzaChuZXdNZXRhOiBNZXRhbG9jYXRpb24pIHtcbiAgICBuZXdNZXRhLnRyYW5zZmVyRmxhZ3ModGhpcy5sb2MubWV0YSwgdGhpcy5yYW5kb20pO1xuICAgIG5ld01ldGEudHJhbnNmZXJFeGl0cyh0aGlzLmxvYy5tZXRhLCB0aGlzLnJhbmRvbSk7XG4gICAgbmV3TWV0YS50cmFuc2ZlclNwYXducyh0aGlzLmxvYy5tZXRhLCB0aGlzLnJhbmRvbSk7XG4gICAgbmV3TWV0YS50cmFuc2ZlclBpdHModGhpcy5sb2MubWV0YSk7XG4gICAgLy9uZXdNZXRhLnJlcGxhY2VNb25zdGVycyh0aGlzLnJhbmRvbSk7XG4gICAgdGhpcy5sb2MubWV0YSA9IG5ld01ldGE7XG4gIH1cblxuICBwaWNrSGVpZ2h0KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIE1hdGgubWF4KDEsIE1hdGgubWluKDE2LCB0aGlzLm9yaWcuaGVpZ2h0ICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcigodGhpcy5yYW5kb20ubmV4dEludCg2KSAtIDEpIC8gMykpKTtcbiAgfVxuXG4gIHBpY2tXaWR0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLm1heCgxLCBNYXRoLm1pbig4LCB0aGlzLm9yaWcud2lkdGggK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKCh0aGlzLnJhbmRvbS5uZXh0SW50KDYpIC0gMSkgLyAzKSkpO1xuICB9XG5cbiAgcGlja1NpemUoKTogbnVtYmVyIHtcbiAgICAvLyA0MCUgY2hhbmNlIG9mICsxIHNpemVcbiAgICByZXR1cm4gdGhpcy5wYXJhbXMuc2l6ZSArICh0aGlzLnJhbmRvbS5uZXh0SW50KDUpIDwgMiA/IDEgOiAwKTtcbiAgfVxuXG4gIGluc2VydFRpbGUoYTogQXR0ZW1wdCwgcG9zOiBQb3MsIHRpbGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHMgPSB0aGlzLnBvc1RvR3JpZChwb3MpO1xuICAgIGZvciAobGV0IHIgPSAwOyByIDwgMzsgcisrKSB7XG4gICAgICBmb3IgKGxldCBjID0gMDsgYyA8IDM7IGMrKykge1xuICAgICAgICBjb25zdCBnID0gcyArIHIgKiAweDgwMCArIGMgKiA4IGFzIEdyaWRDb29yZDtcbiAgICAgICAgaWYgKGEuZml4ZWQuaGFzKGcpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGNvbnN0IHYgPSBhLmdyaWQuZ2V0KGcpO1xuICAgICAgICBpZiAodiAmJiB2ICE9PSB0aWxlW3IgKiAzICsgY10pIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChsZXQgciA9IDA7IHIgPCAzOyByKyspIHtcbiAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgMzsgYysrKSB7XG4gICAgICAgIGNvbnN0IGcgPSBzICsgciAqIDB4ODAwICsgYyAqIDggYXMgR3JpZENvb3JkO1xuICAgICAgICBhLmdyaWQuc2V0KGcsIHRpbGVbciAqIDMgKyBjXSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcG9zVG9HcmlkKHBvczogUG9zLCBvZmZzZXQ6IG51bWJlciA9IDApOiBHcmlkQ29vcmQge1xuICAgIGNvbnN0IHkgPSBwb3MgPj4+IDQ7XG4gICAgY29uc3QgeCA9IHBvcyAmIDB4ZjtcbiAgICByZXR1cm4gKHkgPDwgMTIgfCB4IDw8IDQpICsgb2Zmc2V0IGFzIEdyaWRDb29yZDtcbiAgfVxuXG4gIGluc2VydFBhdHRlcm4oYTogQXR0ZW1wdCwgcGF0dGVybjogcmVhZG9ubHkgc3RyaW5nW10sXG4gICAgICAgICAgICAgICAge3RvcCA9IDAsIGJvdHRvbSA9IDAsIGxlZnQgPSAwLCByaWdodCA9IDB9ID0ge30pOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGNvbnN0IHBoID0gKHBhdHRlcm4ubGVuZ3RoIC0gMSkgPj4+IDE7XG4gICAgY29uc3QgcHcgPSAocGF0dGVyblswXS5sZW5ndGggLSAxKSA+Pj4gMTtcbiAgICBjb25zdCBkaCA9IHRvcCArIGJvdHRvbTtcbiAgICBjb25zdCBkdyA9IGxlZnQgKyByaWdodDtcbiAgICBpZiAoYS5oIDwgcGggKyBkaCkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGB0b28gc2hvcnRgfTtcbiAgICBpZiAoYS53IDwgcHcgKyBkdykgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGB0b28gbmFycm93YH07XG4gICAgY29uc3QgeTAgPSB0aGlzLnJhbmRvbS5uZXh0SW50KGEuaCAtIHBoIC0gMSAtIGRoKSArIHRvcDtcbiAgICBjb25zdCB4MCA9IHRoaXMucmFuZG9tLm5leHRJbnQoYS53IC0gcHcgLSAxIC0gZGgpICsgbGVmdDtcbiAgICBjb25zdCBjMCA9ICh5MCArIDEpIDw8IDEyIHwgKHgwICsgMSkgPDwgNDtcbiAgICBHcmlkLndyaXRlR3JpZDJkKGEuZ3JpZCwgYzAgYXMgR3JpZENvb3JkLCBwYXR0ZXJuKTtcbiAgICBmb3IgKGxldCB5ID0gMHgzMDAwOyB5IDw9IDB4NTAwMDsgeSArPSAweDgwMCkge1xuICAgICAgZm9yIChsZXQgeCA9IDB4MzA7IHggPD0gMHg0MDsgeCArPSAweDgpIHtcbiAgICAgICAgYS5maXhlZC5hZGQoYzAgKyAoeSB8IHgpIGFzIEdyaWRDb29yZCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7b2s6IHRydWUsIHZhbHVlOiB1bmRlZmluZWR9O1xuICB9XG5cbiAgLyoqIEV4dHJhY3QgYSAzeDMgc2VjdGlvbiBpbnRvIGEgKGjDl3cpLWNoYXJhY3RlciBzdHJpbmcuICovXG4gIGV4dHJhY3QoZzogR3JpZDxhbnk+LCBjOiBHcmlkQ29vcmQsXG4gICAgICAgICAge2ggPSAzLCB3ID0gMyxcbiAgICAgICAgICAgcmVwbGFjZSA9IHVuZGVmaW5lZCBhcyBNYXA8R3JpZENvb3JkLCBzdHJpbmc+fHVuZGVmaW5lZCxcbiAgICAgICAgICB9ID0ge30pOiBzdHJpbmcge1xuICAgIGNvbnN0IGluZGV4ID0gZy5pbmRleChjKTtcbiAgICBsZXQgb3V0ID0gJyc7XG4gICAgY29uc3QgZW5kID0gaW5kZXggKyBoICogZy5yb3c7XG4gICAgY29uc3Qge3Jvd30gPSBnO1xuICAgIGZvciAobGV0IHIgPSBpbmRleCBhcyBudW1iZXI7IHIgPCBlbmQ7IHIgKz0gcm93KSB7XG4gICAgICBmb3IgKGxldCBpID0gcjsgaSA8IHIgKyB3OyBpKyspIHtcbiAgICAgICAgaWYgKHJlcGxhY2UpIHtcbiAgICAgICAgICBjb25zdCBzID0gcmVwbGFjZS5nZXQoZy5jb29yZChpIGFzIEdyaWRJbmRleCkpO1xuICAgICAgICAgIGlmIChzICE9IG51bGwpIHtcbiAgICAgICAgICAgIG91dCArPSAocyB8fCAnICcpO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG91dCArPSAoZy5kYXRhW2ldIHx8ICcgJyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBjYW5TZXQoYTogQXR0ZW1wdCwgYzogR3JpZENvb3JkLCB2OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5jYW5TZXRBbGwoYSwgbmV3IE1hcChbW2MsIHZdXSkpO1xuICB9XG5cbiAgY2FuU2V0QWxsKGE6IEF0dGVtcHQsIHJlcGxhY2U6IE1hcDxHcmlkQ29vcmQsIHN0cmluZz4pOiBib29sZWFuIHtcbiAgICBjb25zdCBzY3JlZW5zID0gbmV3IFNldDxHcmlkQ29vcmQ+KCk7XG4gICAgZm9yIChjb25zdCBjIG9mIHJlcGxhY2Uua2V5cygpKSB7XG4gICAgICBpZiAoYS5maXhlZC5oYXMoYykpIHJldHVybiBmYWxzZTtcbiAgICAgIGNvbnN0IHMgPSAoYyAmIH4weDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgY29uc3QgeSA9IHMgPj4+IDEyO1xuICAgICAgY29uc3QgeCA9IChzID4+PiA0KSAmIDB4ZjtcbiAgICAgIGlmICh4IDwgYS53ICYmIHkgPCBhLmgpIHNjcmVlbnMuYWRkKHMpO1xuICAgICAgaWYgKCEoYyAmIDgpICYmIHkgPCBhLmggJiYgeCkgc2NyZWVucy5hZGQocyAtIDB4MTAgYXMgR3JpZENvb3JkKTtcbiAgICAgIGlmICghKGMgJiAweDgwMCkgJiYgeCA8IGEudyAmJiB5KSBzY3JlZW5zLmFkZChzIC0gMHgxMDAwIGFzIEdyaWRDb29yZCk7XG4gICAgICBpZiAoIShjICYgMHg4MDgpICYmIHggJiYgeSkgc2NyZWVucy5hZGQocyAtIDB4MTAxMCBhcyBHcmlkQ29vcmQpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IHMgb2Ygc2NyZWVucykge1xuICAgICAgY29uc3QgdGlsZSA9IHRoaXMuZXh0cmFjdChhLmdyaWQsIHMsIHtyZXBsYWNlfSk7XG4gICAgICBpZiAoIXRoaXMub3JpZy50aWxlc2V0LmdldE1ldGFzY3JlZW5zRnJvbVRpbGVTdHJpbmcodGlsZSkubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbn1cbiJdfQ==