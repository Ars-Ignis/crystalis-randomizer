import { hex } from '../rom/util.js';
const [] = [hex];
export const OK = { ok: true, value: undefined };
export class MazeShuffle {
    constructor(loc, params) {
        this.loc = loc;
        this.attempts = 0;
        this.maxAttempts = 100;
        this.orig = loc.meta;
        this.params = params !== null && params !== void 0 ? params : this.survey(this.orig);
    }
    shuffle(random) {
        if (!this.loc.used)
            return;
        this.random = random;
        while (++this.attempts <= this.maxAttempts) {
            const result = this.build();
            if (result.ok) {
                this.finish(result.value);
                return;
            }
            console.log(`Shuffle failed ${this.loc}: ${result.fail}`);
        }
        this.reportFailure();
    }
    reportFailure() {
        console.error(`Completely failed to map shuffle ${this.loc}`);
    }
    finish(newMeta) {
        newMeta.transferFlags(this.loc.meta, this.random);
        newMeta.transferExits(this.loc.meta, this.random);
        newMeta.transferSpawns(this.loc.meta, this.random);
        newMeta.transferPits(this.loc.meta);
        this.loc.meta = newMeta;
    }
    pickHeight() {
        return Math.max(1, Math.min(16, this.orig.height +
            Math.floor((this.random.nextInt(6) - 1) / 3)));
    }
    pickWidth() {
        return Math.max(1, Math.min(8, this.orig.width +
            Math.floor((this.random.nextInt(6) - 1) / 3)));
    }
    pickSize() {
        return this.params.size + (this.random.nextInt(5) < 2 ? 1 : 0);
    }
    extract(g, c, { h = 3, w = 3, replace = undefined, } = {}) {
        const index = g.index(c);
        let out = '';
        const end = index + h * g.row;
        const { row } = g;
        for (let r = index; r < end; r += row) {
            for (let i = r; i < r + w; i++) {
                if (replace) {
                    const s = replace.get(g.coord(i));
                    if (s != null) {
                        out += (s || ' ');
                        continue;
                    }
                }
                out += (g.data[i] || ' ');
            }
        }
        return out;
    }
    canSet(a, c, v) {
        return this.canSetAll(a, new Map([[c, v]]));
    }
    canSetAll(a, replace) {
        const screens = new Set();
        for (const c of replace.keys()) {
            if (a.fixed.has(c))
                return false;
            const s = (c & ~0x808);
            const y = s >>> 12;
            const x = (s >>> 4) & 0xf;
            if (x < a.w && y < a.h)
                screens.add(s);
            if (!(c & 8) && y < a.h && x)
                screens.add(s - 0x10);
            if (!(c & 0x800) && x < a.w && y)
                screens.add(s - 0x1000);
            if (!(c & 0x808) && x && y)
                screens.add(s - 0x1010);
        }
        for (const s of screens) {
            const tile = this.extract(a.grid, s, { replace });
            if (!this.orig.tileset.getMetascreensFromTileString(tile).length) {
                return false;
            }
        }
        return true;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF6ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9tYXplL21hemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXJDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFnQ2pCLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBaUIsRUFBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsQ0FBQztBQUU3RCxNQUFNLE9BQWdCLFdBQVc7SUFRL0IsWUFBcUIsR0FBYSxFQUFFLE1BQWU7UUFBOUIsUUFBRyxHQUFILEdBQUcsQ0FBVTtRQUpsQyxhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsZ0JBQVcsR0FBRyxHQUFHLENBQUM7UUFJaEIsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxhQUFOLE1BQU0sY0FBTixNQUFNLEdBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELE9BQU8sQ0FBQyxNQUFjO1FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUk7WUFBRSxPQUFPO1FBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDMUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzVCLElBQUksTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDYixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDMUIsT0FBTzthQUNSO1lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFB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QWlCLENBQUMsQ0FBQztZQUNqRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFtQixDQUFDLENBQUM7WUFDdkUsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2dCQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQW1CLENBQUMsQ0FBQztTQUNsRTtRQUNELEtBQUssTUFBTSxDQUFDLElBQUksT0FBTyxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBQyxPQUFPLEVBQUMsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUU7Z0JBQ2hFLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR3JpZCwgR3JpZENvb3JkLCBHcmlkSW5kZXggfSBmcm9tICcuL2dyaWQuanMnO1xuaW1wb3J0IHsgUmFuZG9tIH0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7IGhleCB9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7IE1ldGFsb2NhdGlvbiB9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuXG5jb25zdCBbXSA9IFtoZXhdO1xuXG50eXBlIEZlYXR1cmUgPVxuICAgIC8vIGNhdmVzXG4gICAgJ2FyZW5hJyB8ICdicmlkZ2UnIHwgJ292ZXInIHwgJ3BpdCcgfCAncmFtcCcgfCAncml2ZXInIHwgJ3NwaWtlJyB8XG4gICAgJ3N0YXR1ZScgfCAndW5kZXInIHwgJ3dhbGwnIHwgJ3dpZGUnIHxcbiAgICAvLyBvdmVyd29ybGRcbiAgICAnY2F2ZScgfCAnc2hvcnRHcmFzcycgfCAnbG9uZ0dyYXNzJyB8ICdpY2VCcmlkZ2UnIHwgJ3dvb2RCcmlkZ2UnIHwgJ2Nhbnlvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3VydmV5IHtcbiAgcmVhZG9ubHkgaWQ6IG51bWJlcjtcbiAgcmVhZG9ubHkgbWV0YTogTWV0YWxvY2F0aW9uO1xuICByZWFkb25seSBzaXplOiBudW1iZXI7XG4gIHJlYWRvbmx5IGVkZ2VzPzogbnVtYmVyW107IC8vIFt0b3AsIGxlZnQsIGJvdHRvbSwgcmlnaHRdXG4gIHJlYWRvbmx5IHN0YWlycz86IG51bWJlcltdOyAvLyBbdXAsIGRvd25dXG4gIC8vcG9pPzogbnVtYmVyO1xuICByZWFkb25seSBmZWF0dXJlcz86IHtbZiBpbiBGZWF0dXJlXT86IG51bWJlcn07IC8vIGEsIHIsIHMsIHAsIGIsIHdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdHRlbXB0IHtcbiAgcmVhZG9ubHkgZ3JpZDogR3JpZDxzdHJpbmc+O1xuICByZWFkb25seSBmaXhlZDogU2V0PEdyaWRDb29yZD47XG4gIHJlYWRvbmx5IHc6IG51bWJlcjtcbiAgcmVhZG9ubHkgaDogbnVtYmVyO1xuICByZWFkb25seSBzaXplOiBudW1iZXI7XG4gIGNvdW50OiBudW1iZXI7XG59XG5cbi8vdHlwZSBTdXJ2ZXlUeXBlPFQgZXh0ZW5kcyBNYXplU2h1ZmZsZT4gPSBSZXR1cm5UeXBlPFRbJ3N1cnZleSddPjtcbi8vdHlwZSBBdHRlbXB0VHlwZTxUIGV4dGVuZHMgTWF6ZVNodWZmbGU+ID0gUmV0dXJuVHlwZTxUWydhdHRlbXB0J10+O1xuXG5leHBvcnQgdHlwZSBSZXN1bHQ8VD4gPSB7b2s6IHRydWUsIHZhbHVlOiBUfSB8IHtvazogZmFsc2UsIGZhaWw6IHN0cmluZ307XG5leHBvcnQgY29uc3QgT0s6IFJlc3VsdDx2b2lkPiA9IHtvazogdHJ1ZSwgdmFsdWU6IHVuZGVmaW5lZH07XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBNYXplU2h1ZmZsZSB7XG5cbiAgcmFuZG9tITogUmFuZG9tOyAvLyBzZXQgaW4gc2h1ZmZsZSgpIGZvciBiZXR0ZXIgQVBJLlxuICBvcmlnOiBNZXRhbG9jYXRpb247XG4gIGF0dGVtcHRzID0gMDtcbiAgbWF4QXR0ZW1wdHMgPSAxMDA7XG4gIHBhcmFtczogU3VydmV5O1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGxvYzogTG9jYXRpb24sIHBhcmFtcz86IFN1cnZleSkge1xuICAgIHRoaXMub3JpZyA9IGxvYy5tZXRhO1xuICAgIHRoaXMucGFyYW1zID0gcGFyYW1zID8/IHRoaXMuc3VydmV5KHRoaXMub3JpZyk7XG4gIH1cblxuICBzaHVmZmxlKHJhbmRvbTogUmFuZG9tKSB7XG4gICAgaWYgKCF0aGlzLmxvYy51c2VkKSByZXR1cm47XG4gICAgdGhpcy5yYW5kb20gPSByYW5kb207XG4gICAgd2hpbGUgKCsrdGhpcy5hdHRlbXB0cyA8PSB0aGlzLm1heEF0dGVtcHRzKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmJ1aWxkKCk7XG4gICAgICBpZiAocmVzdWx0Lm9rKSB7XG4gICAgICAgIHRoaXMuZmluaXNoKHJlc3VsdC52YWx1ZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKGBTaHVmZmxlIGZhaWxlZCAke3RoaXMubG9jfTogJHtyZXN1bHQuZmFpbH1gKTtcbiAgICB9XG4gICAgdGhpcy5yZXBvcnRGYWlsdXJlKCk7XG4gIH1cblxuICByZXBvcnRGYWlsdXJlKCkge1xuICAgIC8vdGhyb3cgbmV3IEVycm9yKGBDb21wbGV0ZWx5IGZhaWxlZCB0byBtYXAgc2h1ZmZsZSAke2xvY31gKTtcbiAgICBjb25zb2xlLmVycm9yKGBDb21wbGV0ZWx5IGZhaWxlZCB0byBtYXAgc2h1ZmZsZSAke3RoaXMubG9jfWApO1xuICB9XG5cbiAgYWJzdHJhY3Qgc3VydmV5KG1ldGE6IE1ldGFsb2NhdGlvbik6IFN1cnZleTtcblxuICBhYnN0cmFjdCBidWlsZCgpOiBSZXN1bHQ8TWV0YWxvY2F0aW9uPjtcblxuICBmaW5pc2gobmV3TWV0YTogTWV0YWxvY2F0aW9uKSB7XG4gICAgbmV3TWV0YS50cmFuc2ZlckZsYWdzKHRoaXMubG9jLm1ldGEsIHRoaXMucmFuZG9tKTtcbiAgICBuZXdNZXRhLnRyYW5zZmVyRXhpdHModGhpcy5sb2MubWV0YSwgdGhpcy5yYW5kb20pO1xuICAgIG5ld01ldGEudHJhbnNmZXJTcGF3bnModGhpcy5sb2MubWV0YSwgdGhpcy5yYW5kb20pO1xuICAgIG5ld01ldGEudHJhbnNmZXJQaXRzKHRoaXMubG9jLm1ldGEpO1xuICAgIC8vbmV3TWV0YS5yZXBsYWNlTW9uc3RlcnModGhpcy5yYW5kb20pO1xuICAgIHRoaXMubG9jLm1ldGEgPSBuZXdNZXRhO1xuICB9XG5cbiAgcGlja0hlaWdodCgpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLm1heCgxLCBNYXRoLm1pbigxNiwgdGhpcy5vcmlnLmhlaWdodCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IoKHRoaXMucmFuZG9tLm5leHRJbnQoNikgLSAxKSAvIDMpKSk7XG4gIH1cblxuICBwaWNrV2lkdGgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTWF0aC5tYXgoMSwgTWF0aC5taW4oOCwgdGhpcy5vcmlnLndpZHRoICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcigodGhpcy5yYW5kb20ubmV4dEludCg2KSAtIDEpIC8gMykpKTtcbiAgfVxuXG4gIHBpY2tTaXplKCk6IG51bWJlciB7XG4gICAgLy8gNDAlIGNoYW5jZSBvZiArMSBzaXplXG4gICAgcmV0dXJuIHRoaXMucGFyYW1zLnNpemUgKyAodGhpcy5yYW5kb20ubmV4dEludCg1KSA8IDIgPyAxIDogMCk7XG4gIH1cblxuXG4gIC8qKiBFeHRyYWN0IGEgM3gzIHNlY3Rpb24gaW50byBhIChow5d3KS1jaGFyYWN0ZXIgc3RyaW5nLiAqL1xuICBleHRyYWN0KGc6IEdyaWQ8YW55PiwgYzogR3JpZENvb3JkLFxuICAgICAgICAgIHtoID0gMywgdyA9IDMsXG4gICAgICAgICAgIHJlcGxhY2UgPSB1bmRlZmluZWQgYXMgTWFwPEdyaWRDb29yZCwgc3RyaW5nPnx1bmRlZmluZWQsXG4gICAgICAgICAgfSA9IHt9KTogc3RyaW5nIHtcbiAgICBjb25zdCBpbmRleCA9IGcuaW5kZXgoYyk7XG4gICAgbGV0IG91dCA9ICcnO1xuICAgIGNvbnN0IGVuZCA9IGluZGV4ICsgaCAqIGcucm93O1xuICAgIGNvbnN0IHtyb3d9ID0gZztcbiAgICBmb3IgKGxldCByID0gaW5kZXggYXMgbnVtYmVyOyByIDwgZW5kOyByICs9IHJvdykge1xuICAgICAgZm9yIChsZXQgaSA9IHI7IGkgPCByICsgdzsgaSsrKSB7XG4gICAgICAgIGlmIChyZXBsYWNlKSB7XG4gICAgICAgICAgY29uc3QgcyA9IHJlcGxhY2UuZ2V0KGcuY29vcmQoaSBhcyBHcmlkSW5kZXgpKTtcbiAgICAgICAgICBpZiAocyAhPSBudWxsKSB7XG4gICAgICAgICAgICBvdXQgKz0gKHMgfHwgJyAnKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBvdXQgKz0gKGcuZGF0YVtpXSB8fCAnICcpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgY2FuU2V0KGE6IEF0dGVtcHQsIGM6IEdyaWRDb29yZCwgdjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY2FuU2V0QWxsKGEsIG5ldyBNYXAoW1tjLCB2XV0pKTtcbiAgfVxuXG4gIGNhblNldEFsbChhOiBBdHRlbXB0LCByZXBsYWNlOiBNYXA8R3JpZENvb3JkLCBzdHJpbmc+KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2NyZWVucyA9IG5ldyBTZXQ8R3JpZENvb3JkPigpO1xuICAgIGZvciAoY29uc3QgYyBvZiByZXBsYWNlLmtleXMoKSkge1xuICAgICAgaWYgKGEuZml4ZWQuaGFzKGMpKSByZXR1cm4gZmFsc2U7XG4gICAgICBjb25zdCBzID0gKGMgJiB+MHg4MDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHkgPSBzID4+PiAxMjtcbiAgICAgIGNvbnN0IHggPSAocyA+Pj4gNCkgJiAweGY7XG4gICAgICBpZiAoeCA8IGEudyAmJiB5IDwgYS5oKSBzY3JlZW5zLmFkZChzKTtcbiAgICAgIGlmICghKGMgJiA4KSAmJiB5IDwgYS5oICYmIHgpIHNjcmVlbnMuYWRkKHMgLSAweDEwIGFzIEdyaWRDb29yZCk7XG4gICAgICBpZiAoIShjICYgMHg4MDApICYmIHggPCBhLncgJiYgeSkgc2NyZWVucy5hZGQocyAtIDB4MTAwMCBhcyBHcmlkQ29vcmQpO1xuICAgICAgaWYgKCEoYyAmIDB4ODA4KSAmJiB4ICYmIHkpIHNjcmVlbnMuYWRkKHMgLSAweDEwMTAgYXMgR3JpZENvb3JkKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBzIG9mIHNjcmVlbnMpIHtcbiAgICAgIGNvbnN0IHRpbGUgPSB0aGlzLmV4dHJhY3QoYS5ncmlkLCBzLCB7cmVwbGFjZX0pO1xuICAgICAgaWYgKCF0aGlzLm9yaWcudGlsZXNldC5nZXRNZXRhc2NyZWVuc0Zyb21UaWxlU3RyaW5nKHRpbGUpLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG4iXX0=