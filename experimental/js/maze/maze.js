import { hex } from '../rom/util.js';
const [] = [hex];
export const OK = { ok: true, value: undefined };
export class MazeShuffle {
    constructor(loc, params) {
        this.loc = loc;
        this.attempts = 0;
        this.maxAttempts = 100;
        this.orig = loc.meta;
        this.params = params !== null && params !== void 0 ? params : this.survey(this.orig);
    }
    shuffle(random) {
        if (!this.loc.used)
            return;
        this.random = random;
        while (++this.attempts <= this.maxAttempts) {
            const result = this.build();
            if (result.ok) {
                this.finish(result.value);
                return;
            }
            console.log(`Shuffle failed ${this.loc}: ${result.fail}`);
        }
        this.reportFailure();
    }
    reportFailure() {
        console.error(`Completely failed to map shuffle ${this.loc}`);
    }
    finish(newMeta) {
        newMeta.transferFlags(this.loc.meta, this.random);
        newMeta.transferExits(this.loc.meta, this.random);
        newMeta.transferSpawns(this.loc.meta, this.random);
        newMeta.transferPits(this.loc.meta, this.random);
        this.loc.meta = newMeta;
    }
    pickHeight() {
        return Math.max(1, Math.min(16, this.orig.height +
            Math.floor((this.random.nextInt(6) - 1) / 3)));
    }
    pickWidth() {
        return Math.max(1, Math.min(8, this.orig.width +
            Math.floor((this.random.nextInt(6) - 1) / 3)));
    }
    pickSize() {
        return this.params.size + (this.random.nextInt(5) < 2 ? 1 : 0);
    }
    extract(g, c, { h = 3, w = 3, replace = undefined, } = {}) {
        const index = g.index(c);
        let out = '';
        const end = index + h * g.row;
        const { row } = g;
        for (let r = index; r < end; r += row) {
            for (let i = r; i < r + w; i++) {
                if (replace) {
                    const s = replace.get(g.coord(i));
                    if (s != null) {
                        out += (s || ' ');
                        continue;
                    }
                }
                out += (g.data[i] || ' ');
            }
        }
        return out;
    }
    canSet(a, c, v) {
        return this.canSetAll(a, new Map([[c, v]]));
    }
    canSetAll(a, replace) {
        const screens = new Set();
        for (const c of replace.keys()) {
            if (a.fixed.has(c))
                return false;
            const s = (c & ~0x808);
            const y = s >>> 12;
            const x = (s >>> 4) & 0xf;
            if (x < a.w && y < a.h)
                screens.add(s);
            if (!(c & 8) && y < a.h && x)
                screens.add(s - 0x10);
            if (!(c & 0x800) && x < a.w && y)
                screens.add(s - 0x1000);
            if (!(c & 0x808) && x && y)
                screens.add(s - 0x1010);
        }
        for (const s of screens) {
            const tile = this.extract(a.grid, s, { replace });
            if (!this.orig.tileset.getMetascreensFromTileString(tile).length) {
                return false;
            }
        }
        return true;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF6ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9tYXplL21hemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXJDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFnQ2pCLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBaUIsRUFBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsQ0FBQztBQUU3RCxNQUFNLE9BQWdCLFdBQVc7SUFRL0IsWUFBcUIsR0FBYSxFQUFFLE1BQWU7UUFBOUIsUUFBRyxHQUFILEdBQUcsQ0FBVTtRQUpsQyxhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsZ0JBQVcsR0FBRyxHQUFHLENBQUM7UUFJaEIsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxhQUFOLE1BQU0sY0FBTixNQUFNLEdBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELE9BQU8sQ0FBQyxNQUFjO1FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUk7WUFBRSxPQUFPO1FBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDMUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzVCLElBQUksTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDYixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDMUIsT0FBTzthQUNSO1lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFB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QUcsQ0FBQyxDQUFDLEdBQUcsSUFBaUIsQ0FBQyxDQUFDO1lBQ2pFLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQW1CLENBQUMsQ0FBQztZQUN2RSxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7Z0JBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBbUIsQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsS0FBSyxNQUFNLENBQUMsSUFBSSxPQUFPLEVBQUU7WUFDdkIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFDLE9BQU8sRUFBQyxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRTtnQkFDaEUsT0FBTyxLQUFLLENBQUM7YUFDZDtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHcmlkLCBHcmlkQ29vcmQsIEdyaWRJbmRleCB9IGZyb20gJy4vZ3JpZC5qcyc7XG5pbXBvcnQgeyBSYW5kb20gfSBmcm9tICcuLi9yYW5kb20uanMnO1xuaW1wb3J0IHsgaGV4IH0gZnJvbSAnLi4vcm9tL3V0aWwuanMnO1xuaW1wb3J0IHsgTWV0YWxvY2F0aW9uIH0gZnJvbSAnLi4vcm9tL21ldGFsb2NhdGlvbi5qcyc7XG5pbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJy4uL3JvbS9sb2NhdGlvbi5qcyc7XG5cbmNvbnN0IFtdID0gW2hleF07XG5cbnR5cGUgRmVhdHVyZSA9XG4gICAgLy8gY2F2ZXNcbiAgICAnYXJlbmEnIHwgJ2JyaWRnZScgfCAnb3ZlcicgfCAncGl0JyB8ICdyYW1wJyB8ICdyaXZlcicgfCAnc3Bpa2UnIHxcbiAgICAnc3RhdHVlJyB8ICd1bmRlcicgfCAnd2FsbCcgfCAnd2lkZScgfFxuICAgIC8vIG92ZXJ3b3JsZFxuICAgICdjYXZlJyB8ICdzaG9ydEdyYXNzJyB8ICdsb25nR3Jhc3MnIHwgJ2ljZUJyaWRnZScgfCAnd29vZEJyaWRnZScgfCAnY2FueW9uJztcblxuZXhwb3J0IGludGVyZmFjZSBTdXJ2ZXkge1xuICByZWFkb25seSBpZDogbnVtYmVyO1xuICByZWFkb25seSBtZXRhOiBNZXRhbG9jYXRpb247XG4gIHJlYWRvbmx5IHNpemU6IG51bWJlcjtcbiAgcmVhZG9ubHkgZWRnZXM/OiBudW1iZXJbXTsgLy8gW3RvcCwgbGVmdCwgYm90dG9tLCByaWdodF1cbiAgcmVhZG9ubHkgc3RhaXJzPzogbnVtYmVyW107IC8vIFt1cCwgZG93bl1cbiAgLy9wb2k/OiBudW1iZXI7XG4gIHJlYWRvbmx5IGZlYXR1cmVzPzoge1tmIGluIEZlYXR1cmVdPzogbnVtYmVyfTsgLy8gYSwgciwgcywgcCwgYiwgd1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF0dGVtcHQge1xuICByZWFkb25seSBncmlkOiBHcmlkPHN0cmluZz47XG4gIHJlYWRvbmx5IGZpeGVkOiBTZXQ8R3JpZENvb3JkPjtcbiAgcmVhZG9ubHkgdzogbnVtYmVyO1xuICByZWFkb25seSBoOiBudW1iZXI7XG4gIHJlYWRvbmx5IHNpemU6IG51bWJlcjtcbiAgY291bnQ6IG51bWJlcjtcbn1cblxuLy90eXBlIFN1cnZleVR5cGU8VCBleHRlbmRzIE1hemVTaHVmZmxlPiA9IFJldHVyblR5cGU8VFsnc3VydmV5J10+O1xuLy90eXBlIEF0dGVtcHRUeXBlPFQgZXh0ZW5kcyBNYXplU2h1ZmZsZT4gPSBSZXR1cm5UeXBlPFRbJ2F0dGVtcHQnXT47XG5cbmV4cG9ydCB0eXBlIFJlc3VsdDxUPiA9IHtvazogdHJ1ZSwgdmFsdWU6IFR9IHwge29rOiBmYWxzZSwgZmFpbDogc3RyaW5nfTtcbmV4cG9ydCBjb25zdCBPSzogUmVzdWx0PHZvaWQ+ID0ge29rOiB0cnVlLCB2YWx1ZTogdW5kZWZpbmVkfTtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE1hemVTaHVmZmxlIHtcblxuICByYW5kb20hOiBSYW5kb207IC8vIHNldCBpbiBzaHVmZmxlKCkgZm9yIGJldHRlciBBUEkuXG4gIG9yaWc6IE1ldGFsb2NhdGlvbjtcbiAgYXR0ZW1wdHMgPSAwO1xuICBtYXhBdHRlbXB0cyA9IDEwMDtcbiAgcGFyYW1zOiBTdXJ2ZXk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgbG9jOiBMb2NhdGlvbiwgcGFyYW1zPzogU3VydmV5KSB7XG4gICAgdGhpcy5vcmlnID0gbG9jLm1ldGE7XG4gICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgPz8gdGhpcy5zdXJ2ZXkodGhpcy5vcmlnKTtcbiAgfVxuXG4gIHNodWZmbGUocmFuZG9tOiBSYW5kb20pIHtcbiAgICBpZiAoIXRoaXMubG9jLnVzZWQpIHJldHVybjtcbiAgICB0aGlzLnJhbmRvbSA9IHJhbmRvbTtcbiAgICB3aGlsZSAoKyt0aGlzLmF0dGVtcHRzIDw9IHRoaXMubWF4QXR0ZW1wdHMpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYnVpbGQoKTtcbiAgICAgIGlmIChyZXN1bHQub2spIHtcbiAgICAgICAgdGhpcy5maW5pc2gocmVzdWx0LnZhbHVlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc29sZS5sb2coYFNodWZmbGUgZmFpbGVkICR7dGhpcy5sb2N9OiAke3Jlc3VsdC5mYWlsfWApO1xuICAgIH1cbiAgICB0aGlzLnJlcG9ydEZhaWx1cmUoKTtcbiAgfVxuXG4gIHJlcG9ydEZhaWx1cmUoKSB7XG4gICAgLy90aHJvdyBuZXcgRXJyb3IoYENvbXBsZXRlbHkgZmFpbGVkIHRvIG1hcCBzaHVmZmxlICR7bG9jfWApO1xuICAgIGNvbnNvbGUuZXJyb3IoYENvbXBsZXRlbHkgZmFpbGVkIHRvIG1hcCBzaHVmZmxlICR7dGhpcy5sb2N9YCk7XG4gIH1cblxuICBhYnN0cmFjdCBzdXJ2ZXkobWV0YTogTWV0YWxvY2F0aW9uKTogU3VydmV5O1xuXG4gIGFic3RyYWN0IGJ1aWxkKCk6IFJlc3VsdDxNZXRhbG9jYXRpb24+O1xuXG4gIGZpbmlzaChuZXdNZXRhOiBNZXRhbG9jYXRpb24pIHtcbiAgICBuZXdNZXRhLnRyYW5zZmVyRmxhZ3ModGhpcy5sb2MubWV0YSwgdGhpcy5yYW5kb20pO1xuICAgIG5ld01ldGEudHJhbnNmZXJFeGl0cyh0aGlzLmxvYy5tZXRhLCB0aGlzLnJhbmRvbSk7XG4gICAgbmV3TWV0YS50cmFuc2ZlclNwYXducyh0aGlzLmxvYy5tZXRhLCB0aGlzLnJhbmRvbSk7XG4gICAgbmV3TWV0YS50cmFuc2ZlclBpdHModGhpcy5sb2MubWV0YSwgdGhpcy5yYW5kb20pO1xuICAgIC8vbmV3TWV0YS5yZXBsYWNlTW9uc3RlcnModGhpcy5yYW5kb20pO1xuICAgIHRoaXMubG9jLm1ldGEgPSBuZXdNZXRhO1xuICB9XG5cbiAgcGlja0hlaWdodCgpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLm1heCgxLCBNYXRoLm1pbigxNiwgdGhpcy5vcmlnLmhlaWdodCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IoKHRoaXMucmFuZG9tLm5leHRJbnQoNikgLSAxKSAvIDMpKSk7XG4gIH1cblxuICBwaWNrV2lkdGgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTWF0aC5tYXgoMSwgTWF0aC5taW4oOCwgdGhpcy5vcmlnLndpZHRoICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcigodGhpcy5yYW5kb20ubmV4dEludCg2KSAtIDEpIC8gMykpKTtcbiAgfVxuXG4gIHBpY2tTaXplKCk6IG51bWJlciB7XG4gICAgLy8gNDAlIGNoYW5jZSBvZiArMSBzaXplXG4gICAgcmV0dXJuIHRoaXMucGFyYW1zLnNpemUgKyAodGhpcy5yYW5kb20ubmV4dEludCg1KSA8IDIgPyAxIDogMCk7XG4gIH1cblxuXG4gIC8qKiBFeHRyYWN0IGEgM3gzIHNlY3Rpb24gaW50byBhIChow5d3KS1jaGFyYWN0ZXIgc3RyaW5nLiAqL1xuICBleHRyYWN0KGc6IEdyaWQ8YW55PiwgYzogR3JpZENvb3JkLFxuICAgICAgICAgIHtoID0gMywgdyA9IDMsXG4gICAgICAgICAgIHJlcGxhY2UgPSB1bmRlZmluZWQgYXMgTWFwPEdyaWRDb29yZCwgc3RyaW5nPnx1bmRlZmluZWQsXG4gICAgICAgICAgfSA9IHt9KTogc3RyaW5nIHtcbiAgICBjb25zdCBpbmRleCA9IGcuaW5kZXgoYyk7XG4gICAgbGV0IG91dCA9ICcnO1xuICAgIGNvbnN0IGVuZCA9IGluZGV4ICsgaCAqIGcucm93O1xuICAgIGNvbnN0IHtyb3d9ID0gZztcbiAgICBmb3IgKGxldCByID0gaW5kZXggYXMgbnVtYmVyOyByIDwgZW5kOyByICs9IHJvdykge1xuICAgICAgZm9yIChsZXQgaSA9IHI7IGkgPCByICsgdzsgaSsrKSB7XG4gICAgICAgIGlmIChyZXBsYWNlKSB7XG4gICAgICAgICAgY29uc3QgcyA9IHJlcGxhY2UuZ2V0KGcuY29vcmQoaSBhcyBHcmlkSW5kZXgpKTtcbiAgICAgICAgICBpZiAocyAhPSBudWxsKSB7XG4gICAgICAgICAgICBvdXQgKz0gKHMgfHwgJyAnKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBvdXQgKz0gKGcuZGF0YVtpXSB8fCAnICcpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgY2FuU2V0KGE6IEF0dGVtcHQsIGM6IEdyaWRDb29yZCwgdjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY2FuU2V0QWxsKGEsIG5ldyBNYXAoW1tjLCB2XV0pKTtcbiAgfVxuXG4gIGNhblNldEFsbChhOiBBdHRlbXB0LCByZXBsYWNlOiBNYXA8R3JpZENvb3JkLCBzdHJpbmc+KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2NyZWVucyA9IG5ldyBTZXQ8R3JpZENvb3JkPigpO1xuICAgIGZvciAoY29uc3QgYyBvZiByZXBsYWNlLmtleXMoKSkge1xuICAgICAgaWYgKGEuZml4ZWQuaGFzKGMpKSByZXR1cm4gZmFsc2U7XG4gICAgICBjb25zdCBzID0gKGMgJiB+MHg4MDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHkgPSBzID4+PiAxMjtcbiAgICAgIGNvbnN0IHggPSAocyA+Pj4gNCkgJiAweGY7XG4gICAgICBpZiAoeCA8IGEudyAmJiB5IDwgYS5oKSBzY3JlZW5zLmFkZChzKTtcbiAgICAgIGlmICghKGMgJiA4KSAmJiB5IDwgYS5oICYmIHgpIHNjcmVlbnMuYWRkKHMgLSAweDEwIGFzIEdyaWRDb29yZCk7XG4gICAgICBpZiAoIShjICYgMHg4MDApICYmIHggPCBhLncgJiYgeSkgc2NyZWVucy5hZGQocyAtIDB4MTAwMCBhcyBHcmlkQ29vcmQpO1xuICAgICAgaWYgKCEoYyAmIDB4ODA4KSAmJiB4ICYmIHkpIHNjcmVlbnMuYWRkKHMgLSAweDEwMTAgYXMgR3JpZENvb3JkKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBzIG9mIHNjcmVlbnMpIHtcbiAgICAgIGNvbnN0IHRpbGUgPSB0aGlzLmV4dHJhY3QoYS5ncmlkLCBzLCB7cmVwbGFjZX0pO1xuICAgICAgaWYgKCF0aGlzLm9yaWcudGlsZXNldC5nZXRNZXRhc2NyZWVuc0Zyb21UaWxlU3RyaW5nKHRpbGUpLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG4iXX0=