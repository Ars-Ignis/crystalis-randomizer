import { DefaultMap } from '../util.js';
const MapTypes = {
    Overworld: {
        ' ': 'blocked',
        '*': 'unmatched',
        '1': 'waterfall valley slope',
        '2': 'waterfall valley bridge to portoa ',
        '3': 'desert oasis ',
        '>': 'open right',
        '<': 'open left',
        '^': 'open top',
        'v': 'open bottom',
        'o': 'open',
        'l': 'long grass',
        's': 'short grass',
        'r': 'river',
        'n': 'narrow edge exit, centered',
        'b': 'boat',
    },
    Tower: {
        ' ': 'blocked',
        's': 'stairs',
        't': 'corridor',
    },
    Cave: {
        ' ': 'blocked',
        'w': 'wide',
        'c': 'corridor',
        'n': 'narrow',
        'r': 'river',
        'b': 'wrong side of bridge',
        's': 'spikes',
    },
    Swamp: {
        ' ': 'blocked',
        's': 'passage',
    },
    Mountain: {
        ' ': 'blocked',
        'p': 'path',
        's': 'slope',
        'w': 'waterfall',
        'l': 'ladder',
    },
};
const [] = [MapTypes];
const BORDER = { uid: 0xffff };
const EDGE_EXIT = { uid: 0xfffe };
class NeighborCache {
    constructor({ screens }) {
        this.allowed = [new Set(), new Set()];
        this.neighbors = new DefaultMap(() => new Set());
        for (const s1 of screens) {
            const e1 = s1.data.edges || '****';
            for (const s2 of screens) {
                const e2 = s2.data.edges || '****';
                if (e1[2] !== '*' && e1[2] === e2[0]) {
                    this.add(0, s1, s2);
                }
                if (e1[3] !== '*' && e1[3] === e2[1]) {
                    this.add(1, s1, s2);
                }
                for (const dir of (s1.data.allowed ? s1.data.allowed(s2) : [])) {
                    this.add(dir, s1, s2);
                }
            }
            const edges = [];
            for (const { type } of s1.data.exits || []) {
                const dir = edgeTypeMap[type];
                if (dir != null)
                    edges[dir] = EDGE_EXIT;
            }
            for (let dir = 0; dir < 4; dir++) {
                let edge = edges[dir];
                if (edge == null)
                    edge = borderMap[e1[dir]];
                if (edge != null)
                    this.add(dir, s1, edge);
            }
        }
    }
    add(dir, s1, s2) {
        const u1 = s1.uid;
        const u2 = s2.uid;
        this.allowed[dir & 1].add(dir & 2 ? u2 << 16 | u1 : u1 << 16 | u2);
        this.neighbors.get(u1 << 2 | dir).add(u2);
        this.neighbors.get(u2 << 2 | (dir ^ 2)).add(u1);
    }
}
const borderMap = {
    '*': EDGE_EXIT,
    ' ': EDGE_EXIT,
};
const edgeTypeMap = {
    'edge:top': 0,
    'edge:left': 1,
    'edge:bottom': 2,
    'edge:right': 3,
};
const caches = new DefaultMap(t => new NeighborCache(t));
export class Maze {
    constructor(random, width, height, tileset) {
        this.random = random;
        this.width = width;
        this.height = height;
        this.tileset = tileset;
        this.neighbors = caches.get(this.tileset);
        this.map = new Array((height + 2) << 4).fill(undefined);
        for (let x = 0; x < width; x++) {
            this.map[ind(-1, x)] = this.map[ind(height, x)] = BORDER.uid;
        }
        for (let y = 0; y < width; y++) {
            this.map[ind(y, -1)] = this.map[ind(y, width)] = BORDER.uid;
        }
    }
    inBounds(pos) {
        return (pos & 15) < this.width && pos > 15 && pos >>> 4 <= this.height;
    }
}
function ind(y, x) {
    return ((y + 1) << 4) + x;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF6ZTIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvbWF6ZS9tYXplMi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBRXRDLE1BQU0sUUFBUSxHQUFHO0lBQ2YsU0FBUyxFQUFFO1FBQ1QsR0FBRyxFQUFFLFNBQVM7UUFDZCxHQUFHLEVBQUUsV0FBVztRQUNoQixHQUFHLEVBQUUsd0JBQXdCO1FBQzdCLEdBQUcsRUFBRSxvQ0FBb0M7UUFDekMsR0FBRyxFQUFFLGVBQWU7UUFDcEIsR0FBRyxFQUFFLFlBQVk7UUFDakIsR0FBRyxFQUFFLFdBQVc7UUFDaEIsR0FBRyxFQUFFLFVBQVU7UUFDZixHQUFHLEVBQUUsYUFBYTtRQUNsQixHQUFHLEVBQUUsTUFBTTtRQUNYLEdBQUcsRUFBRSxZQUFZO1FBQ2pCLEdBQUcsRUFBRSxhQUFhO1FBQ2xCLEdBQUcsRUFBRSxPQUFPO1FBQ1osR0FBRyxFQUFFLDRCQUE0QjtRQUNqQyxHQUFHLEVBQUUsTUFBTTtLQUNaO0lBQ0QsS0FBSyxFQUFFO1FBQ0wsR0FBRyxFQUFFLFNBQVM7UUFDZCxHQUFHLEVBQUUsUUFBUTtRQUNiLEdBQUcsRUFBRSxVQUFVO0tBQ2hCO0lBQ0QsSUFBSSxFQUFFO1FBQ0osR0FBRyxFQUFFLFNBQVM7UUFDZCxHQUFHLEVBQUUsTUFBTTtRQUNYLEdBQUcsRUFBRSxVQUFVO1FBQ2YsR0FBRyxFQUFFLFFBQVE7UUFDYixHQUFHLEVBQUUsT0FBTztRQUNaLEdBQUcsRUFBRSxzQkFBc0I7UUFDM0IsR0FBRyxFQUFFLFFBQVE7S0FDZDtJQUNELEtBQUssRUFBRTtRQUNMLEdBQUcsRUFBRSxTQUFTO1FBQ2QsR0FBRyxFQUFFLFNBQVM7S0FDZjtJQUNELFFBQVEsRUFBRTtRQUNSLEdBQUcsRUFBRSxTQUFTO1FBQ2QsR0FBRyxFQUFFLE1BQU07UUFDWCxHQUFHLEVBQUUsT0FBTztRQUNaLEdBQUcs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LElBQUksS0FBSyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUV4RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzlCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztTQUM5RDtRQUNELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDOUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO1NBQzdEO0lBQ0gsQ0FBQztJQUVELFFBQVEsQ0FBQyxHQUFXO1FBQ2xCLE9BQU8sQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxHQUFHLEdBQUcsRUFBRSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN6RSxDQUFDO0NBQ0Y7QUFJRCxTQUFTLEdBQUcsQ0FBQyxDQUFTLEVBQUUsQ0FBUztJQUMvQixPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvL2ltcG9ydCB7TWV0YXNjcmVlbn0gZnJvbSAnLi4vcm9tL21ldGFzY3JlZW4uanMnO1xuaW1wb3J0IHtDb25uZWN0aW9uVHlwZX0gZnJvbSAnLi4vcm9tL21ldGFzY3JlZW5kYXRhLmpzJztcbmltcG9ydCB7TWV0YXRpbGVzZXR9IGZyb20gJy4uL3JvbS9tZXRhdGlsZXNldC5qcyc7XG5pbXBvcnQge1JhbmRvbX0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7RGVmYXVsdE1hcH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5cbmNvbnN0IE1hcFR5cGVzID0ge1xuICBPdmVyd29ybGQ6IHtcbiAgICAnICc6ICdibG9ja2VkJyxcbiAgICAnKic6ICd1bm1hdGNoZWQnLCAvLyBtdXN0IGJlIG9uIGFuIGVkZ2VcbiAgICAnMSc6ICd3YXRlcmZhbGwgdmFsbGV5IHNsb3BlJyxcbiAgICAnMic6ICd3YXRlcmZhbGwgdmFsbGV5IGJyaWRnZSB0byBwb3J0b2EgJyxcbiAgICAnMyc6ICdkZXNlcnQgb2FzaXMgJyxcbiAgICAnPic6ICdvcGVuIHJpZ2h0JyxcbiAgICAnPCc6ICdvcGVuIGxlZnQnLFxuICAgICdeJzogJ29wZW4gdG9wJyxcbiAgICAndic6ICdvcGVuIGJvdHRvbScsXG4gICAgJ28nOiAnb3BlbicsXG4gICAgJ2wnOiAnbG9uZyBncmFzcycsXG4gICAgJ3MnOiAnc2hvcnQgZ3Jhc3MnLFxuICAgICdyJzogJ3JpdmVyJyxcbiAgICAnbic6ICduYXJyb3cgZWRnZSBleGl0LCBjZW50ZXJlZCcsXG4gICAgJ2InOiAnYm9hdCcsXG4gIH0sXG4gIFRvd2VyOiB7XG4gICAgJyAnOiAnYmxvY2tlZCcsXG4gICAgJ3MnOiAnc3RhaXJzJyxcbiAgICAndCc6ICdjb3JyaWRvcicsXG4gIH0sXG4gIENhdmU6IHtcbiAgICAnICc6ICdibG9ja2VkJyxcbiAgICAndyc6ICd3aWRlJyxcbiAgICAnYyc6ICdjb3JyaWRvcicsXG4gICAgJ24nOiAnbmFycm93JyxcbiAgICAncic6ICdyaXZlcicsXG4gICAgJ2InOiAnd3Jvbmcgc2lkZSBvZiBicmlkZ2UnLFxuICAgICdzJzogJ3NwaWtlcycsXG4gIH0sXG4gIFN3YW1wOiB7XG4gICAgJyAnOiAnYmxvY2tlZCcsXG4gICAgJ3MnOiAncGFzc2FnZScsXG4gIH0sXG4gIE1vdW50YWluOiB7XG4gICAgJyAnOiAnYmxvY2tlZCcsXG4gICAgJ3AnOiAncGF0aCcsXG4gICAgJ3MnOiAnc2xvcGUnLFxuICAgICd3JzogJ3dhdGVyZmFsbCcsXG4gICAgJ2wnOiAnbGFkZGVyJyxcbiAgfSxcbiAgLy8gT3RoZXIgdHlwZXMgd2UgZG9uJ3QgaGFuZGxlOiBIb3VzZSwgQ2hhbm5lbFxufTtcbmNvbnN0IFtdID0gW01hcFR5cGVzXTtcblxudHlwZSBEaXIgPSAwfDF8MnwzO1xudHlwZSBVaWQgPSBudW1iZXI7XG50eXBlIFVpZFBhaXIgPSBudW1iZXI7XG5cbi8vIGZha2UgVUlEcyBmb3IgdGhlIHR3byBib3JkZXIgb3B0aW9ucy5cbmNvbnN0IEJPUkRFUiA9IHt1aWQ6IDB4ZmZmZn07XG5jb25zdCBFREdFX0VYSVQgPSB7dWlkOiAweGZmZmV9O1xuXG4vLyBOZWVkIGEgY2FjaGUgb2YgbmVpZ2hib3JzP1xuY2xhc3MgTmVpZ2hib3JDYWNoZSB7XG4gIC8vIFt2ZXJ0aWNhbCwgaG9yaXpvbnRhbF0sIGluZGV4ZWQgYnkgZGlyICYgMVxuICByZWFkb25seSBhbGxvd2VkID0gW25ldyBTZXQ8VWlkUGFpcj4oKSwgbmV3IFNldDxVaWRQYWlyPigpXSBhcyBjb25zdDtcbiAgcmVhZG9ubHkgbmVpZ2hib3JzID0gbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBTZXQ8VWlkPj4oKCkgPT4gbmV3IFNldCgpKTtcblxuICBwcml2YXRlIGFkZChkaXI6IERpciwgczE6IHt1aWQ6IG51bWJlcn0sIHMyOiB7dWlkOiBudW1iZXJ9KSB7XG4gICAgY29uc3QgdTEgPSBzMS51aWQ7XG4gICAgY29uc3QgdTIgPSBzMi51aWQ7XG4gICAgdGhpcy5hbGxvd2VkW2RpciAmIDFdLmFkZChkaXIgJiAyID8gdTIgPDwgMTYgfCB1MSA6IHUxIDw8IDE2IHwgdTIpO1xuICAgIHRoaXMubmVpZ2hib3JzLmdldCh1MSA8PCAyIHwgZGlyKS5hZGQodTIpO1xuICAgIHRoaXMubmVpZ2hib3JzLmdldCh1MiA8PCAyIHwgKGRpciBeIDIpKS5hZGQodTEpO1xuICB9XG5cbiAgY29uc3RydWN0b3Ioe3NjcmVlbnN9OiBNZXRhdGlsZXNldCkge1xuICAgIGZvciAoY29uc3QgczEgb2Ygc2NyZWVucykge1xuICAgICAgY29uc3QgZTEgPSBzMS5kYXRhLmVkZ2VzIHx8ICcqKioqJztcbiAgICAgIC8vIFJlZ2lzdGVyIHRoZSBzY3JlZW4gcGFpcnNcbiAgICAgIGZvciAoY29uc3QgczIgb2Ygc2NyZWVucykge1xuICAgICAgICAvLyBCYXNpYyBpZGVhOiBjb21wYXJlIHRoZSBlZGdlcy4gIEJ1dCB3ZSBuZWVkIGEgd2F5IHRvIG92ZXJyaWRlP1xuICAgICAgICAvLyBTcGVjaWZpY2FsbHksIGlmIHRoZXJlJ3MgYSAqIHRoZW4gY2FsbCBhIG1ldGhvZD8gIFdoYXQgYWJvdXRcbiAgICAgICAgLy8gYWxsb3dpbmcgKHNheSkgbm9ybWFsIGNhdmUgdy8gbmFycm93P1xuICAgICAgICBjb25zdCBlMiA9IHMyLmRhdGEuZWRnZXMgfHwgJyoqKionO1xuICAgICAgICBpZiAoZTFbMl0gIT09ICcqJyAmJiBlMVsyXSA9PT0gZTJbMF0pIHtcbiAgICAgICAgICB0aGlzLmFkZCgwLCBzMSwgczIpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChlMVszXSAhPT0gJyonICYmIGUxWzNdID09PSBlMlsxXSkge1xuICAgICAgICAgIHRoaXMuYWRkKDEsIHMxLCBzMik7XG4gICAgICAgIH1cbiAgICAgICAgLy8gTWF5YmUgY2FsbCBhIG1ldGhvZCBpZiBpdCdzIHRoZXJlP1xuICAgICAgICBmb3IgKGNvbnN0IGRpciBvZiAoczEuZGF0YS5hbGxvd2VkID8gczEuZGF0YS5hbGxvd2VkKHMyKSA6IFtdKSkge1xuICAgICAgICAgIHRoaXMuYWRkKGRpciwgczEsIHMyKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gUmVnaXN0ZXIgYm9yZGVyc1xuICAgICAgY29uc3QgZWRnZXM6IEFycmF5PHt1aWQ6IG51bWJlcn0+ID0gW107XG4gICAgICBmb3IgKGNvbnN0IHt0eXBlfSBvZiBzMS5kYXRhLmV4aXRzIHx8IFtdKSB7XG4gICAgICAgIGNvbnN0IGRpciA9IGVkZ2VUeXBlTWFwW3R5cGVdO1xuICAgICAgICBpZiAoZGlyICE9IG51bGwpIGVkZ2VzW2Rpcl0gPSBFREdFX0VYSVQ7XG4gICAgICB9XG4gICAgICBmb3IgKGxldCBkaXIgPSAwIGFzIERpcjsgZGlyIDwgNDsgZGlyKyspIHtcbiAgICAgICAgLy8gRWRnZXMgbWF5IGJlIGFsbG93ZWQgYXMgZWl0aGVyIGV4aXRzLCBub24tZXhpdHMsIG9yIG5vdCBhdCBhbGwuXG4gICAgICAgIGxldCBlZGdlID0gZWRnZXNbZGlyXTtcbiAgICAgICAgaWYgKGVkZ2UgPT0gbnVsbCkgZWRnZSA9IGJvcmRlck1hcFtlMVtkaXJdXTtcbiAgICAgICAgaWYgKGVkZ2UgIT0gbnVsbCkgdGhpcy5hZGQoZGlyLCBzMSwgZWRnZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIC8vIFRPRE8gLSB3aGF0IHRvIGRvIHdpdGggYm9yZGVycz8hPyBDYW4gd2UgdHJlYXQgdGhlbSBsaWtlIGEgc2NyZWVuP1xuICAvLyBUaGUgbWFpbiB0aGluZyB0aGF0IG1hdHRlcnMgZm9yIGJvcmRlcnMgaXMgd2hldGhlciBpdCdzIGFuIGVkZ2UgZXhpdFxuICAvLyBvciBub3QuICBXZSBjYW4gYWxyZWFkeSB0cmFjayB0aGlzIGEgYml0IC0gd2UgY291bGQgaGF2ZSBhIGxpc3Qgb2ZcbiAgLy8gYWNjZXB0YWJsZSBlZGdlIHR5cGVzIGZvciBlYWNoIHRpbGVzZXQgLSBcIiBuXCIgbW9zdCBsaWtlbHksIGV4Y2VwdCBmb3JcbiAgLy8gc3dhbXAgKFwiIG5zXCI/KSAgV2Ugc2hvdWxkIGdvIHRocnUgYW5kIG1ha2Ugc3VyZSB0aGVyZSdzIG5vIHJldXNlIG9mXG4gIC8vIGVkZ2UgdHlwZXMgaW4gaW5jb25zaXN0ZW50IHdheXMgKGUuZy4gJ3YnIGZvciBib3RoIGdyYXNzIGFuZCBib3VuZGFyeSlcbn1cblxuY29uc3QgYm9yZGVyTWFwOiB7W2M6IHN0cmluZ106IHt1aWQ6IG51bWJlcn19ID0ge1xuICAnKic6IEVER0VfRVhJVCxcbiAgJyAnOiBFREdFX0VYSVQsXG59O1xuY29uc3QgZWRnZVR5cGVNYXA6IHtbQyBpbiBDb25uZWN0aW9uVHlwZV0/OiBudW1iZXJ9ID0ge1xuICAnZWRnZTp0b3AnOiAwLFxuICAnZWRnZTpsZWZ0JzogMSxcbiAgJ2VkZ2U6Ym90dG9tJzogMixcbiAgJ2VkZ2U6cmlnaHQnOiAzLFxufTtcbiAgXG5cbmNvbnN0IGNhY2hlcyA9XG4gICAgbmV3IERlZmF1bHRNYXA8TWV0YXRpbGVzZXQsIE5laWdoYm9yQ2FjaGU+KHQgPT4gbmV3IE5laWdoYm9yQ2FjaGUodCkpO1xuXG5leHBvcnQgY2xhc3MgTWF6ZSB7XG5cbiAgcmVhZG9ubHkgbmVpZ2hib3JzID0gY2FjaGVzLmdldCh0aGlzLnRpbGVzZXQpO1xuICBtYXA6IEFycmF5PG51bWJlcj47XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcmFuZG9tOiBSYW5kb20sXG4gICAgICAgICAgICAgIHB1YmxpYyB3aWR0aDogbnVtYmVyLFxuICAgICAgICAgICAgICBwdWJsaWMgaGVpZ2h0OiBudW1iZXIsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IHRpbGVzZXQ6IE1ldGF0aWxlc2V0KSB7XG4gICAgdGhpcy5tYXAgPSBuZXcgQXJyYXkoKGhlaWdodCArIDIpIDw8IDQpLmZpbGwodW5kZWZpbmVkKTtcbiAgICAvLyBJbml0aWFsaXplIGFuIGVtcHR5IG1hcCB3aXRoIGNsb3NlZCBib3JkZXJzIGFsbCBhcm91bmQuXG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCB3aWR0aDsgeCsrKSB7XG4gICAgICB0aGlzLm1hcFtpbmQoLTEsIHgpXSA9IHRoaXMubWFwW2luZChoZWlnaHQsIHgpXSA9IEJPUkRFUi51aWQ7XG4gICAgfVxuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgd2lkdGg7IHkrKykge1xuICAgICAgdGhpcy5tYXBbaW5kKHksIC0xKV0gPSB0aGlzLm1hcFtpbmQoeSwgd2lkdGgpXSA9IEJPUkRFUi51aWQ7XG4gICAgfVxuICB9XG5cbiAgaW5Cb3VuZHMocG9zOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKHBvcyAmIDE1KSA8IHRoaXMud2lkdGggJiYgcG9zID4gMTUgJiYgcG9zID4+PiA0IDw9IHRoaXMuaGVpZ2h0O1xuICB9XG59XG5cbi8vIE1hcCAoeSwgeCkgc2NyZWVuIHBvc2l0aW9uIHRvIGFuIGluZGV4LiAgTm90ZSB0aGF0IHdlIHVzZSBwYWRkaW5nIGZvclxuLy8gYm9yZGVycy4gIEluLWJvdW5kIGNoZWNraW5nIGlzIHRyaXZpYWwuXG5mdW5jdGlvbiBpbmQoeTogbnVtYmVyLCB4OiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gKCh5ICsgMSkgPDwgNCkgKyB4O1xufVxuXG5cbi8vIFRPRE8gLSBmaW5kIGEgcGxhY2UgZm9yIGEgTWFwPG51bWJlciwgTWV0YXNjcmVlbj4gYnV0IHdoYXQgdG8gZG8gd2l0aCBib3JkZXJzP1xuIl19