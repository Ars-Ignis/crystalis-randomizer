import { CaveShuffle } from './cave.js';
import { OK } from './maze.js';
import { E, N, S, W } from './grid.js';
import { ScreenFix } from '../rom/screenfix.js';
import { DefaultMap } from '../util.js';
export class LabyrinthShuffle extends CaveShuffle {
    initialFill(a) {
        const target = a.size + 3;
        const stair = (this.random.nextInt(a.w) << 4 | (a.h - 1) << 12 | 0x808);
        if (!a.grid.isBorder(W(stair)))
            a.fixed.add(W(stair, 2));
        if (!a.grid.isBorder(E(stair)))
            a.fixed.add(E(stair, 2));
        a.grid.set(stair, '>');
        a.fixed.add(stair);
        a.grid.set(N(stair), 'w');
        a.fixed.add(N(stair));
        a.fixed.add(W(stair));
        a.fixed.add(E(stair));
        const arena = (this.random.nextInt(a.w) << 4 | 0x808);
        const down = S(arena, 2);
        a.grid.set(arena, '<');
        a.fixed.add(arena);
        a.grid.set(S(arena), 'w');
        a.fixed.add(S(arena));
        a.grid.set(down, 'w');
        a.fixed.add(down);
        a.grid.set(S(down), 'w');
        a.fixed.add(S(down));
        a.fixed.add(W(down));
        a.fixed.add(E(down));
        if (!this.tryConnect(a, N(stair, 2), S(down, 2), 'w', 10)) {
            return { ok: false, fail: `initial connect` };
        }
        while (a.count < target) {
            if (!this.tryAddLoop(a, 'w', 10))
                return { ok: false, fail: `add loops` };
        }
        return OK;
    }
    refine() { return OK; }
    refineEdges() { return true; }
    addArenas() { return true; }
    addStairs() { return OK; }
    refineMetascreens(a, meta) {
        console.log(meta.show());
        for (let y = 0; y < meta.height; y++) {
            for (let x = 0; x < meta.width; x++) {
                const pos = y << 4 | x;
                const scr = meta.get(pos);
                const edge = scr.edgeIndex('w');
                if (scr.hasFeature('arena')) {
                    this.arena = pos + 0x10 << 8 | 1;
                }
                else if (edge === 5) {
                    if (pos < 16 || !meta.get(pos - 16).hasFeature('arena')) {
                        meta.set(pos, meta.rom.metascreens.goaWideHallNS_stairs);
                        const c = ((pos << 8 | pos << 4) & 0xf0f0 | 0x808);
                        a.grid.set(c, 'H');
                    }
                }
                else if (edge === 1) {
                    this.stair = pos << 8 | 2;
                }
            }
        }
        this.reachable = undefined;
        if (!this.checkMeta(meta))
            return { ok: false, fail: `initial meta check` };
        console.log(meta.show());
        const deadEnd = this.orig.rom.metascreens.goaWideHallNS_deadEnd;
        for (let x = 0; x < meta.width; x++) {
            for (let y = 0; y < meta.height; y++) {
                const c = (y << 12 | x << 4 | 0x808);
                let len = 0;
                while (y + len < meta.height &&
                    a.grid.get(c + len * 0x1000) === 'H') {
                    len++;
                }
                if (!len)
                    continue;
                const opts = [new Map(), new Map()];
                for (let i = 0; i < len; i++) {
                    opts[i & 1].set((y + i) << 4 | x, deadEnd);
                }
                let found = false;
                for (const opt of this.random.ishuffle(opts)) {
                    if (!opt.size) {
                        found = true;
                        continue;
                    }
                    if (!this.checkMeta(meta, opt))
                        continue;
                    for (const [pos, s] of opt) {
                        meta.set(pos, s);
                        a.grid.set(c + 0x1000 * ((pos >> 4) - y), '=');
                    }
                    found = true;
                    break;
                }
                if (!found)
                    return { ok: false, fail: `could not rectify hallway` };
                y += len;
            }
        }
        return super.refineMetascreens(a, meta);
    }
    checkMeta(meta, repl) {
        const opts = repl ? { with: repl } : {};
        const parts = meta.traverse(opts);
        const part = parts.get(this.stair);
        if (part !== parts.get(this.arena)) {
            console.log(`stair not connected to arena\n${meta.show()}`);
            return false;
        }
        if (this.reachable == null) {
            if (part && part.size < parts.size * 0.95) {
                console.log(`too small`);
                return false;
            }
            this.reachable = part === null || part === void 0 ? void 0 : part.size;
            return true;
        }
        else {
            if ((part === null || part === void 0 ? void 0 : part.size) > this.reachable * 0.95) {
                return true;
            }
            return false;
        }
    }
}
export function fixLabyrinthScreens(rom, random) {
    var _a;
    const { metatilesets: { cave, fortress, iceCave, labyrinth, pyramid } } = rom;
    rom.metascreens.registerFix(ScreenFix.LabyrinthParapets, 1);
    {
        for (const ts of [labyrinth, pyramid]) {
            ts.getTile(0x2b).copyFrom(0x19).replaceIn(...ts);
            ts.getTile(0xba).copyFrom(0x1b).replaceIn(...ts);
        }
        for (const ts of [fortress, labyrinth, pyramid, cave]) {
            ts.getTile(0x19).copyFrom(0x17).replaceIn(...ts);
            ts.getTile(0x1b).copyFrom(0x18).replaceIn(...ts);
        }
        for (const ts of [iceCave, cave, pyramid]) {
            ts.getTile(0x17).copyFrom(0xc5);
            ts.getTile(0x18).copyFrom(0xc5);
        }
        labyrinth.getTile(0x17).copyFrom(0xc6).setAlternative(0xc5);
        labyrinth.getTile(0x18).copyFrom(0xc4).setAlternative(0xc5);
    }
    const bySid = new DefaultMap(() => []);
    for (const s of rom.metatilesets.labyrinth) {
        bySid.get(s.sid).push(s);
    }
    for (const [sid, screens] of bySid) {
        const screen = rom.screens[sid];
        const remove = screens.map(s => { var _a; return (_a = s.data.tilesets.labyrinth) === null || _a === void 0 ? void 0 : _a.removeWall; });
        const [removed, ...rest] = new Set(remove.filter(w => w != null));
        if (removed != null) {
            screen.set2d(removed, [[0xc5, 0xc5], [0xd0, 0xc5]]);
            if (rest.length)
                throw new Error(`bad remove`);
            for (let i = 0; i < remove.length; i++) {
                if (remove[i] == null) {
                    screens[i].data.tilesets.labyrinth.addWall = [removed];
                }
            }
        }
        if (screens.length < 2)
            continue;
        if (screens.length > 2) {
            const deleted = random.pick(screens.filter(s => { var _a; return (_a = s.data.tilesets.labyrinth) === null || _a === void 0 ? void 0 : _a.addWall; }));
            screens.splice(screens.indexOf(deleted), 1);
            deleted.remove();
        }
        for (const s of screens) {
            const add = (_a = s.data.tilesets.labyrinth) === null || _a === void 0 ? void 0 : _a.addWall;
            if (add != null) {
                s.data.mod = 'block';
                for (const w of add)
                    screen.set2d(w, [[0x17, 0x17], [0x18, 0x18]]);
            }
            else {
                s.flag = 'always';
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL21hemUvZ29hLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBc0IsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzVELE9BQU8sRUFBVSxFQUFFLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHdkMsT0FBTyxFQUFhLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNsRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDaEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQVF4QyxNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsV0FBVztJQU8vQyxXQUFXLENBQUMsQ0FBSTtRQUNkLE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQzFCLE1BQU0sS0FBSyxHQUNQLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBYyxDQUFDO1FBQzNFLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7WUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RCxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDdkIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkIsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzFCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRXRCLE1BQU0sS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQWMsQ0FBQztRQUNuRSxNQUFNLElBQUksR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN2QixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDMUIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElB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LEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDcEU7aUJBQU07Z0JBQ0wsQ0FBQyxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7YUFDbkI7U0FDRjtLQUNGO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhdmVTaHVmZmxlQXR0ZW1wdCwgQ2F2ZVNodWZmbGUgfSBmcm9tICcuL2NhdmUuanMnO1xuaW1wb3J0IHsgUmVzdWx0LCBPSyB9IGZyb20gJy4vbWF6ZS5qcyc7XG5pbXBvcnQgeyBSb20gfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHsgUmFuZG9tIH0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7IEdyaWRDb29yZCwgRSwgTiwgUywgVyB9IGZyb20gJy4vZ3JpZC5qcyc7XG5pbXBvcnQgeyBTY3JlZW5GaXggfSBmcm9tICcuLi9yb20vc2NyZWVuZml4LmpzJztcbmltcG9ydCB7IERlZmF1bHRNYXAgfSBmcm9tICcuLi91dGlsLmpzJztcbmltcG9ydCB7IE1ldGFzY3JlZW4gfSBmcm9tICcuLi9yb20vbWV0YXNjcmVlbi5qcyc7XG5pbXBvcnQgeyBNZXRhbG9jYXRpb24sIFBvcyB9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuXG50eXBlIEEgPSBDYXZlU2h1ZmZsZUF0dGVtcHQ7XG5cbi8vIFRPRE8gLSBuZWVkcyBtb3JlIGxvb3BzLi4uXG5cbmV4cG9ydCBjbGFzcyBMYWJ5cmludGhTaHVmZmxlIGV4dGVuZHMgQ2F2ZVNodWZmbGUge1xuXG4gIC8vIG1ldGEudHJhdmVyc2UgcG9zaXRpb25zIGZvciBpbXBvcnRhbnQgZmVhdHVyZXMuXG4gIHN0YWlyITogbnVtYmVyO1xuICBhcmVuYSE6IG51bWJlcjtcbiAgcmVhY2hhYmxlPzogbnVtYmVyO1xuXG4gIGluaXRpYWxGaWxsKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGNvbnN0IHRhcmdldCA9IGEuc2l6ZSArIDM7IC8vICsgdGhpcy5yYW5kb20ubmV4dEludCg0KTtcbiAgICBjb25zdCBzdGFpciA9XG4gICAgICAgICh0aGlzLnJhbmRvbS5uZXh0SW50KGEudykgPDwgNCB8IChhLmggLSAxKSA8PCAxMiB8IDB4ODA4KSBhcyBHcmlkQ29vcmQ7XG4gICAgaWYgKCFhLmdyaWQuaXNCb3JkZXIoVyhzdGFpcikpKSBhLmZpeGVkLmFkZChXKHN0YWlyLCAyKSk7XG4gICAgaWYgKCFhLmdyaWQuaXNCb3JkZXIoRShzdGFpcikpKSBhLmZpeGVkLmFkZChFKHN0YWlyLCAyKSk7XG4gICAgYS5ncmlkLnNldChzdGFpciwgJz4nKTtcbiAgICBhLmZpeGVkLmFkZChzdGFpcik7XG4gICAgYS5ncmlkLnNldChOKHN0YWlyKSwgJ3cnKTtcbiAgICBhLmZpeGVkLmFkZChOKHN0YWlyKSk7XG4gICAgYS5maXhlZC5hZGQoVyhzdGFpcikpO1xuICAgIGEuZml4ZWQuYWRkKEUoc3RhaXIpKTtcblxuICAgIGNvbnN0IGFyZW5hID0gKHRoaXMucmFuZG9tLm5leHRJbnQoYS53KSA8PCA0IHwgMHg4MDgpIGFzIEdyaWRDb29yZDtcbiAgICBjb25zdCBkb3duID0gUyhhcmVuYSwgMik7XG4gICAgYS5ncmlkLnNldChhcmVuYSwgJzwnKTtcbiAgICBhLmZpeGVkLmFkZChhcmVuYSk7XG4gICAgYS5ncmlkLnNldChTKGFyZW5hKSwgJ3cnKTtcbiAgICBhLmZpeGVkLmFkZChTKGFyZW5hKSk7XG4gICAgYS5ncmlkLnNldChkb3duLCAndycpO1xuICAgIGEuZml4ZWQuYWRkKGRvd24pO1xuICAgIGEuZ3JpZC5zZXQoUyhkb3duKSwgJ3cnKTtcbiAgICBhLmZpeGVkLmFkZChTKGRvd24pKTtcbiAgICBhLmZpeGVkLmFkZChXKGRvd24pKTtcbiAgICBhLmZpeGVkLmFkZChFKGRvd24pKTtcblxuICAgIC8vIFRPRE8gLSBjYW4gc3RhaXIgYmUgbm90IG9uIGJvdHRvbT8gIGFyZW5hIG5vdCBvbiB0b3A/XG5cbiAgICBpZiAoIXRoaXMudHJ5Q29ubmVjdChhLCBOKHN0YWlyLCAyKSwgUyhkb3duLCAyKSwgJ3cnLCAxMCkpIHtcbiAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgaW5pdGlhbCBjb25uZWN0YH07XG4gICAgfVxuICAgIHdoaWxlIChhLmNvdW50IDwgdGFyZ2V0KSB7XG4gICAgICBpZiAoIXRoaXMudHJ5QWRkTG9vcChhLCAndycsIDEwKSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBhZGQgbG9vcHNgfTtcbiAgICB9XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgcmVmaW5lKCkgeyByZXR1cm4gT0s7IH1cbiAgcmVmaW5lRWRnZXMoKSB7IHJldHVybiB0cnVlOyB9XG4gIGFkZEFyZW5hcygpIHsgcmV0dXJuIHRydWU7IH1cbiAgYWRkU3RhaXJzKCkgeyByZXR1cm4gT0s7IH1cblxuICByZWZpbmVNZXRhc2NyZWVucyhhOiBBLCBtZXRhOiBNZXRhbG9jYXRpb24pOiBSZXN1bHQ8dm9pZD4ge1xuY29uc29sZS5sb2cobWV0YS5zaG93KCkpO1xuICAgIC8vIDEuIHJlcGxhY2UgYWxsIHRoZSAobm9uLWZpeGVkKSB3aWRlSGFsbE5TIHdpdGggZWl0aGVyIHN0YWlycyBvciBwYWlyc1xuICAgIC8vICAgIG9mIGRlYWQgZW5kcyAtIG5vIHNhbWUgdmVydGljYWwgbmVpZ2hib3JzXG4gICAgLy8gMi4gc3RhcnQgYWRkaW5nIGJsb2Nrc1xuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgbWV0YS5oZWlnaHQ7IHkrKykge1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCBtZXRhLndpZHRoOyB4KyspIHtcbiAgICAgICAgY29uc3QgcG9zID0geSA8PCA0IHwgeDtcbiAgICAgICAgY29uc3Qgc2NyID0gbWV0YS5nZXQocG9zKTtcbiAgICAgICAgY29uc3QgZWRnZSA9IHNjci5lZGdlSW5kZXgoJ3cnKTtcbiAgICAgICAgaWYgKHNjci5oYXNGZWF0dXJlKCdhcmVuYScpKSB7XG4gICAgICAgICAgdGhpcy5hcmVuYSA9IHBvcyArIDB4MTAgPDwgOCB8IDE7XG4gICAgICAgIH0gZWxzZSBpZiAoZWRnZSA9PT0gNSkge1xuICAgICAgICAgIGlmIChwb3MgPCAxNiB8fCAhbWV0YS5nZXQocG9zIC0gMTYpLmhhc0ZlYXR1cmUoJ2FyZW5hJykpIHtcbiAgICAgICAgICAgIG1ldGEuc2V0KHBvcywgbWV0YS5yb20ubWV0YXNjcmVlbnMuZ29hV2lkZUhhbGxOU19zdGFpcnMpO1xuICAgICAgICAgICAgY29uc3QgYyA9ICgocG9zIDw8IDggfCBwb3MgPDwgNCkgJiAweGYwZjAgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgICAgICAgYS5ncmlkLnNldChjLCAnSCcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChlZGdlID09PSAxKSB7XG4gICAgICAgICAgdGhpcy5zdGFpciA9IHBvcyA8PCA4IHwgMjtcbiAgICAgICAgLy8gfSBlbHNlIGlmIChzY3IuaGFzRmVhdHVyZSgnYXJlbmEnKSkge1xuICAgICAgICAvLyAgIG1ldGEuc2V0KHBvcywgbWV0YS5yb20ubWV0YXNjcmVlbnMuZ29hV2lkZUhhbGxOU19zdGFpcnMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIC8vIE1ha2Ugc3VyZSBldmVyeXRoaW5nIGlzIGFjY2Vzc2libGVcbiAgICB0aGlzLnJlYWNoYWJsZSA9IHVuZGVmaW5lZDtcbiAgICBpZiAoIXRoaXMuY2hlY2tNZXRhKG1ldGEpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgbWV0YSBjaGVja2B9O1xuY29uc29sZS5sb2cobWV0YS5zaG93KCkpO1xuICAgIC8vIE5vdyB0aGF0IGEgYmFzZWxpbmUgaGFzIGJlZW4gZXN0YWJsaXNoZWQsIHRyeSBhZGRpbmcgdmFyaW91cyBibG9ja3MsXG4gICAgLy8gaW5jbHVkaW5nIGRlYWQtZW5kcyBvdXQgb2Ygc3RhaXIgaGFsbHdheXMgLSAuLi5cblxuICAgIGNvbnN0IGRlYWRFbmQgPSB0aGlzLm9yaWcucm9tLm1ldGFzY3JlZW5zLmdvYVdpZGVIYWxsTlNfZGVhZEVuZDtcbiAgICBmb3IgKGxldCB4ID0gMDsgeCA8IG1ldGEud2lkdGg7IHgrKykge1xuICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBtZXRhLmhlaWdodDsgeSsrKSB7XG4gICAgICAgIC8vIGNvbnN0IGMgPSAoKHBvcyA8PCA4IHwgcG9zIDw8IDQpICYgMHhmMGYwKSBhcyBHcmlkQ29vcmQ7XG4gICAgICAgIC8vYCBsZXQgdGlsZSA9IHRoaXMuZXh0cmFjdChhLmdyaWQsIGMpO1xuICAgICAgICBjb25zdCBjID0gKHkgPDwgMTIgfCB4IDw8IDQgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgICBsZXQgbGVuID0gMDtcbiAgICAgICAgd2hpbGUgKHkgKyBsZW4gPCBtZXRhLmhlaWdodCAmJlxuICAgICAgICAgICAgICAgYS5ncmlkLmdldChjICsgbGVuICogMHgxMDAwIGFzIEdyaWRDb29yZCkgPT09ICdIJykge1xuICAgICAgICAgIGxlbisrO1xuICAgICAgICB9XG4gICAgICAgIC8vIGFsdGVybmF0ZSBkZWFkIGVuZHMgYW5kIHN0YWlyc1xuICAgICAgICBpZiAoIWxlbikgY29udGludWU7XG4gICAgICAgIGNvbnN0IG9wdHM6IEFycmF5PE1hcDxQb3MsIE1ldGFzY3JlZW4+PiA9IFtuZXcgTWFwKCksIG5ldyBNYXAoKV07XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICBvcHRzW2kgJiAxXS5zZXQoKHkgKyBpKSA8PCA0IHwgeCwgZGVhZEVuZCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgICAgIGZvciAoY29uc3Qgb3B0IG9mIHRoaXMucmFuZG9tLmlzaHVmZmxlKG9wdHMpKSB7XG4gICAgICAgICAgaWYgKCFvcHQuc2l6ZSkge1xuICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghdGhpcy5jaGVja01ldGEobWV0YSwgb3B0KSkgY29udGludWU7XG4gICAgICAgICAgZm9yIChjb25zdCBbcG9zLCBzXSBvZiBvcHQpIHtcbiAgICAgICAgICAgIG1ldGEuc2V0KHBvcywgcyk7XG4gICAgICAgICAgICBhLmdyaWQuc2V0KGMgKyAweDEwMDAgKiAoKHBvcyA+PiA0KSAtIHkpIGFzIEdyaWRDb29yZCwgJz0nKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGlmICghZm91bmQpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgY291bGQgbm90IHJlY3RpZnkgaGFsbHdheWB9O1xuICAgICAgICB5ICs9IGxlbjtcblxuLy8gICAgICAgICBpZiAoYS5ncmlkLmdldChjKSA9PT0gJ0gnKSB7XG4vLyAgICAgICAgICAgLy8gdHJ5IHRvIHNldCB0byBhIGRlYWQgZW5kLlxuLy8gICAgICAgICBpZiAodGhpcy50cnlNZXRhKG1ldGEsIHBvcywgW2RlYWRFbmRdKSkge1xuLy8gICAgICAgICAgIGEuZ3JpZC5zZXQoYywgJz0nKTtcbi8vICAgICAgICAgfSBlbHNlIGlmIChhLmdyaWQuZ2V0KGMgLSAweDEwMDAgYXMgR3JpZENvb3JkKSA9PT0gJ0gnKSB7XG4vLyAvL2RlYnVnZ2VyO1xuLy8gICAgICAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgY291bGQgbm90IGJyZWFrIHVwIHN0YWlyIGhhbGxzYH07XG4vLyAgICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIGNvbnN0IGJsb2NrZWQgPSB0aGlzLm9yaWcudGlsZXNldC53aXRoTW9kKHRpbGUsICdibG9jaycpO1xuICAgICAgLy8gaWYgKGJsb2NrZWQubGVuZ3RoICYmXG4gICAgICAvLyAgICAgdGhpcy50cnlNZXRhKG1ldGEsIHBvcywgdGhpcy5yYW5kb20uc2h1ZmZsZShibG9ja2VkKSkpIHtcbiAgICAgIC8vICAgY29udGludWU7XG4gICAgICAvLyB9XG4gICAgfVxuXG4gICAgLy8gVE9ETyAtIGNvbnZlcnQgYWRqYWNlbnQgc3RhaXJzIHRvIGRlYWQgZW5kc1xuICAgIHJldHVybiBzdXBlci5yZWZpbmVNZXRhc2NyZWVucyhhLCBtZXRhKTtcbiAgfVxuXG4gIGNoZWNrTWV0YShtZXRhOiBNZXRhbG9jYXRpb24sIHJlcGw/OiBNYXA8UG9zLCBNZXRhc2NyZWVuPik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG9wdHMgPSByZXBsID8ge3dpdGg6IHJlcGx9IDoge307XG4gICAgY29uc3QgcGFydHMgPSBtZXRhLnRyYXZlcnNlKG9wdHMpO1xuICAgIGNvbnN0IHBhcnQgPSBwYXJ0cy5nZXQodGhpcy5zdGFpcik7XG4gICAgaWYgKHBhcnQgIT09IHBhcnRzLmdldCh0aGlzLmFyZW5hKSkge1xuICAgICAgY29uc29sZS5sb2coYHN0YWlyIG5vdCBjb25uZWN0ZWQgdG8gYXJlbmFcXG4ke21ldGEuc2hvdygpfWApO1xuICAgICAgLy9kZWJ1Z2dlcjtcbiAgICAgIHJldHVybiBmYWxzZTsgLy97b2s6IGZhbHNlLCBmYWlsOiAnc3RhaXIgbm90IGNvbm5lY3RlZCB0byBhcmVuYSd9O1xuICAgIH1cbiAgICBpZiAodGhpcy5yZWFjaGFibGUgPT0gbnVsbCkge1xuICAgICAgaWYgKHBhcnQgJiYgcGFydC5zaXplIDwgcGFydHMuc2l6ZSAqIDAuOTUpIHtcbiAgICAgICAgY29uc29sZS5sb2coYHRvbyBzbWFsbGApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICB0aGlzLnJlYWNoYWJsZSA9IHBhcnQ/LnNpemU7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHBhcnQ/LnNpemUhID4gdGhpcy5yZWFjaGFibGUgKiAwLjk1KSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlOy8vIHtvazogZmFsc2UsIGZhaWw6IGByZWZpbmVNZXRhOiBjdXQgb2ZmIHRvbyBtdWNoYH07XG4gICAgfSAgICBcbiAgfVxuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaXhMYWJ5cmludGhTY3JlZW5zKHJvbTogUm9tLCByYW5kb206IFJhbmRvbSkge1xuICAvLyBUaGVyZSBhcmUgZm91ciB0aWxlc2V0cyB0aGF0IGFsbCBzaGFyZSBsb3RzIG9mIHNjcmVlbnMsIHNvIGl0J3MgdG91Z2hcbiAgLy8gdG8gZmluZCBhbiBlbGlnaWJsZSBhbHRlcm5hdGFibGUgdGlsZS4gIEl0IHR1cm5zIG91dCB0aGF0IDE5IGFuZCAxYiBhcmVcbiAgLy8gbm90IHVzZWQgaW4gYW55IG9mIHRoZSByZWxldmFudCBzY3JlZW5zIChhbGwgYnV0IG5vcm1hbCBjYXZlKSBmb3JcbiAgLy8gYWx0ZXJuYXRpbmcsIHNvIHdlIGZyZWUgdXAgdGhvc2UgdGlsZXMgYnkgbW92aW5nIHRoZW0gaW50byB2YXJpb3VzXG4gIC8vIGZyZWUgdGlsZXMgKDJiIGFuZCBiYSBpbiBweXJhbWlkIGFuZCBmb3J0cmVzcywgMTcgYW5kIDE4IGluIGljZSBjYXZlXG4gIC8vIHNpbmNlIHRoaXMgb25lIGlzIHVzZWQgZm9yIHN3aXRjaGluZyB3LyA1NCBhbmQgNTgpLlxuXG4gIC8vIFBMQU46XG4gIC8vIHRpbGVzZXQgYTQsOGM6IG1vdmUgMTksMWIgLT4gMmIsYmFcbiAgLy8gdGlsZXNldCBhODogICAgbW92ZSAxOSwxYiAtPiAxNywxOFxuICAvLyB0aWxlc2V0IDg4OiAgICBtb3ZlIGM1IC0+IDE5LDFiXG4gIC8vICAgICAxNywxOCB1c2VkIGluIDg4LCB3aGljaCBzaGFyZXMgYSBsb3Qgd2l0aCBhOCwgYnV0XG4gIC8vICAgICBubyA4OCBtYXBzIGhhdmUgYW55IDE5LDFiIHNvIHRoZXknbGwgbmV2ZXIgc2VlIGNvbmZsaWN0aW5nIDE3LDE4XG4gIC8vIGNoYW5nZSB0aGUgODggdXNlcnMgb2YgZTEsZTIgKGh5ZHJhKSB0byB0aWxlc2V0IGE4IHdpdGggcGF0MT0yYSB0byBhdm9pZFxuICAvLyBjb25mbGljdD8gIHRoZSBjb3N0IGlzIG9uZSB3YWxsIHRoYXQgZG9lc24ndCBmaXQgaW4gcXVpdGUgYXMgd2VsbC5cbiAgLy8gVGhpcyBmcmVlcyB1cCAxOSwxYiB0byBhYnNvcmIgYzYvYzQgd2l0aCBhbHRzIG9mIGM1XG4gIC8vIFBST0JMRU06XG4gIC8vIEljZSBjYXZlIG1vdmVzIGl0cyBmbGFnZ2FibGUgMTkvMWIgdG8gMTcvMTggdG8gZnJlZSB1cCBzcGFjZSBmb3IgdGhlXG4gIC8vIHJlbW92YWJsZSB3YWxsLCBidXQgMTcvMTggaXMgdXNlZCBpbiByaXZlciBjYXZlIGZvciB2ZXJ0aWNhbCBicmlkZ2UuXG4gIC8vIFRoaXMgaXMgdGhlIG9ubHkgc2l0dWF0aW9uIHdoZXJlIDE3LzE4IGFuZCAxOS8xYiBjb25mbGljdC4gIFNvIHdlXG4gIC8vIGluZGlyZWN0IGFuIGV4dHJhIHRpbWUsIGNvcHkgMTcvMTggaW50byAxOS8xYiBvbiB0aWxlc2V0cyA4OCw4YyxhNFxuICAvLyBhbmQgdGhlbiB3ZSBjYW4gcHV0IHRoZSBuZXcgd2FsbCB0aWxlcyBpbiAxNy8xOCBldmVyeXdoZXJlLlxuICBjb25zdCB7bWV0YXRpbGVzZXRzOiB7Y2F2ZSwgZm9ydHJlc3MsIGljZUNhdmUsIGxhYnlyaW50aCwgcHlyYW1pZH19ID0gcm9tO1xuICByb20ubWV0YXNjcmVlbnMucmVnaXN0ZXJGaXgoU2NyZWVuRml4LkxhYnlyaW50aFBhcmFwZXRzLCAxKTtcbiAgLy8gRml4IHRoZSB0aWxlc1xuICB7XG4gICAgLy8gRmlyc3QgcGF0Y2ggYSBmZXcgbm9uZXNlbnNlIGFsdGVybmF0ZXMgdG8gZ2V0IGFyb3VuZCBvdXIgc2FmZXR5IGNoZWNrXG4gICAgLy8gZm9yIChjb25zdCB0cyBvZiBbcHlyYW1pZCwgbGFieXJpbnRoLCBpY2VDYXZlXSkge1xuICAgIC8vICAgdHMudGlsZXNldC5hbHRlcm5hdGVzWzB4MTldID0gMHgxOTtcbiAgICAvLyAgIHRzLnRpbGVzZXQuYWx0ZXJuYXRlc1sweDFiXSA9IDB4MWI7XG4gICAgLy8gfVxuICAgIC8vIEZyZWUgdXAgMTkgYW5kIDFiIGluIHRoZSB0aWxlc2V0cyB0aGF0IG5lZWQgaXQuXG4gICAgZm9yIChjb25zdCB0cyBvZiBbbGFieXJpbnRoLCBweXJhbWlkXSkge1xuICAgICAgdHMuZ2V0VGlsZSgweDJiKS5jb3B5RnJvbSgweDE5KS5yZXBsYWNlSW4oLi4udHMpO1xuICAgICAgdHMuZ2V0VGlsZSgweGJhKS5jb3B5RnJvbSgweDFiKS5yZXBsYWNlSW4oLi4udHMpO1xuICAgIH1cblxuICAgIC8vIEZyZWUgdXAgMTcvMTggYnkgY29weWluZyB0byAxOS8xYiB0aGF0IHdlIGp1c3QgZnJlZWQuXG4gICAgZm9yIChjb25zdCB0cyBvZiBbZm9ydHJlc3MsIGxhYnlyaW50aCwgcHlyYW1pZCwgY2F2ZV0pIHtcbiAgICAgIHRzLmdldFRpbGUoMHgxOSkuY29weUZyb20oMHgxNykucmVwbGFjZUluKC4uLnRzKTtcbiAgICAgIHRzLmdldFRpbGUoMHgxYikuY29weUZyb20oMHgxOCkucmVwbGFjZUluKC4uLnRzKTtcbiAgICB9XG5cbiAgICAvLyBGaWxsIGluIGM1J3MgZ3JhcGhpY3MgZm9yIG9yZGluYXJ5IGNhdmVzIHRvIGNsZWFuIHVwIGdyYXBoaWNhbCBnbGl0Y2hlc1xuICAgIGZvciAoY29uc3QgdHMgb2YgW2ljZUNhdmUsIGNhdmUsIHB5cmFtaWRdKSB7XG4gICAgICB0cy5nZXRUaWxlKDB4MTcpLmNvcHlGcm9tKDB4YzUpO1xuICAgICAgdHMuZ2V0VGlsZSgweDE4KS5jb3B5RnJvbSgweGM1KTtcbiAgICB9XG5cbiAgICAvLyBOb3cgdGhhdCBzcGFjZSBoYXMgYmVlbiBhbGxvY2F0ZWQsIGZpbGwgaXQuXG4gICAgbGFieXJpbnRoLmdldFRpbGUoMHgxNykuY29weUZyb20oMHhjNikuc2V0QWx0ZXJuYXRpdmUoMHhjNSk7XG4gICAgbGFieXJpbnRoLmdldFRpbGUoMHgxOCkuY29weUZyb20oMHhjNCkuc2V0QWx0ZXJuYXRpdmUoMHhjNSk7XG4gIH1cbiAgLy8gRml4IHRoZSBzY3JlZW5zXG4gIGNvbnN0IGJ5U2lkID0gbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBNZXRhc2NyZWVuW10+KCgpID0+IFtdKTtcbiAgZm9yIChjb25zdCBzIG9mIHJvbS5tZXRhdGlsZXNldHMubGFieXJpbnRoKSB7XG4gICAgYnlTaWQuZ2V0KHMuc2lkKS5wdXNoKHMpO1xuICB9XG4gIGZvciAoY29uc3QgW3NpZCwgc2NyZWVuc10gb2YgYnlTaWQpIHtcbiAgICAvLyBGaXJzdCBzZWUgaWYgdGhlIGRlZmF1bHQgc2NyZWVuIGhhcyBhIHdhbGwgdGhhdCBtYXkgYmUgcmVtb3ZlZFxuICAgIGNvbnN0IHNjcmVlbiA9IHJvbS5zY3JlZW5zW3NpZF07XG4gICAgY29uc3QgcmVtb3ZlID0gc2NyZWVucy5tYXAocyA9PiBzLmRhdGEudGlsZXNldHMubGFieXJpbnRoPy5yZW1vdmVXYWxsKTtcbiAgICBjb25zdCBbcmVtb3ZlZCwgLi4ucmVzdF0gPSBuZXcgU2V0KHJlbW92ZS5maWx0ZXIodyA9PiB3ICE9IG51bGwpKTtcbiAgICBpZiAocmVtb3ZlZCAhPSBudWxsKSB7XG4gICAgICBzY3JlZW4uc2V0MmQocmVtb3ZlZCwgW1sweGM1LCAweGM1XSwgWzB4ZDAsIDB4YzVdXSk7XG4gICAgICBpZiAocmVzdC5sZW5ndGgpIHRocm93IG5ldyBFcnJvcihgYmFkIHJlbW92ZWApO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZW1vdmUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKHJlbW92ZVtpXSA9PSBudWxsKSB7XG4gICAgICAgICAgc2NyZWVuc1tpXS5kYXRhLnRpbGVzZXRzLmxhYnlyaW50aCEuYWRkV2FsbCA9IFtyZW1vdmVkXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc2NyZWVucy5sZW5ndGggPCAyKSBjb250aW51ZTtcbiAgICAvLyBOb3cgaWYgdGhlcmUncyB0d28gd2l0aCBhZGRzLCBwaWNrIG9uZSB0byBkZWxldGUuXG4gICAgaWYgKHNjcmVlbnMubGVuZ3RoID4gMikge1xuICAgICAgY29uc3QgZGVsZXRlZCA9XG4gICAgICAgICAgcmFuZG9tLnBpY2soc2NyZWVucy5maWx0ZXIocyA9PiBzLmRhdGEudGlsZXNldHMubGFieXJpbnRoPy5hZGRXYWxsKSk7XG4gICAgICBzY3JlZW5zLnNwbGljZShzY3JlZW5zLmluZGV4T2YoZGVsZXRlZCksIDEpO1xuICAgICAgZGVsZXRlZC5yZW1vdmUoKTtcbiAgICB9XG4gICAgLy8gRmlndXJlIG91dCB3aGljaCBzY3JlZW4gbmVlZHMgdG8gZ2V0IGEgd2FsbCBhZGRlZC5cbiAgICBmb3IgKGNvbnN0IHMgb2Ygc2NyZWVucykge1xuICAgICAgY29uc3QgYWRkID0gcy5kYXRhLnRpbGVzZXRzLmxhYnlyaW50aD8uYWRkV2FsbDtcbiAgICAgIGlmIChhZGQgIT0gbnVsbCkge1xuICAgICAgICBzLmRhdGEubW9kID0gJ2Jsb2NrJztcbiAgICAgICAgZm9yIChjb25zdCB3IG9mIGFkZCkgc2NyZWVuLnNldDJkKHcsIFtbMHgxNywgMHgxN10sIFsweDE4LCAweDE4XV0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcy5mbGFnID0gJ2Fsd2F5cyc7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=