export class PyramidShuffle {
    constructor(location) {
        this.location = location;
    }
    shuffle(random) {
        const meta = this.location.meta;
        moveInternalStair(meta, random);
        if (random.nextInt(2))
            invertPyramidExit(this.location.rom);
        const up = [...meta.exits()].filter(e => e[1] === 'stair:up');
        const dn = [...meta.exits()].filter(e => e[1] === 'stair:down');
        random.shuffle(up);
        random.shuffle(dn);
        for (const e of [...meta.exits()]) {
            if ((e[2][0] >>> 8) !== this.location.id) {
                const next = (e[1] === 'stair:up' ? up : dn).pop();
                meta.setExit(next[0], next[1], e[2]);
            }
        }
        if (up.length !== dn.length)
            throw new Error(`length mismatch`);
        const dn2 = random.shuffle([...dn]);
        const self = this.location.id << 8;
        for (let i = 0; i < up.length; i++) {
            meta.setExitOneWay(up[i][0], up[i][1], [self | dn[i][0], dn[i][1]]);
            meta.setExitOneWay(dn2[i][0], dn2[i][1], [self | up[i][0], up[i][1]]);
        }
    }
}
function moveInternalStair(meta, random) {
    const y = random.nextInt(2) + 6;
    const x = random.nextInt(3) + 2;
    if (y === 7 && x === 3)
        return;
    const { branchNWSE, branchNWE, branchWSE, branchNWE_upStair, deadEndW, deadEndE } = meta.rom.metascreens;
    const pos = y << 4 | x;
    let bottom = branchWSE;
    if (y === 7 && x === 1)
        bottom = deadEndE;
    if (y === 7 && x === 5)
        bottom = deadEndW;
    meta.set2d(0x63, [[branchNWSE], [branchNWSE], [branchNWSE]]);
    meta.set2d(pos - 16, [[branchNWE], [branchNWE_upStair], [bottom]]);
    meta.moveExit(0x73, pos);
}
function invertPyramidExit(rom) {
    const draygon = rom.locations.Pyramid_Draygon.meta;
    const main = rom.locations.Pyramid_Main.meta;
    const { metascreens: { hallSE, deadEndW_downStair, wideHallNE, wideHallNW, fortressArena_through, deadEndS_stairs } } = rom;
    draygon.width = 2;
    draygon.set2d(0x00, [[null, deadEndS_stairs],
        [null, fortressArena_through],
        [wideHallNE, wideHallNW]]);
    draygon.moveExit(0x20, 0x01);
    main.set2d(0x03, [[hallSE, deadEndW_downStair]]);
    main.moveExit(0x03, 0x04);
    main.attach(0x04, draygon, 0x01);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHlyYW1pZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9tYXplL3B5cmFtaWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBU0EsTUFBTSxPQUFPLGNBQWM7SUFDekIsWUFBcUIsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQUFHLENBQUM7SUFHM0MsT0FBTyxDQUFDLE1BQWM7UUFDcEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDaEMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRWhDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFBRSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTVELE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssVUFBVSxDQUFDLENBQUM7UUFDOUQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxZQUFZLENBQUMsQ0FBQztRQUNoRSxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFbkIsS0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUU7WUFDakMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRTtnQkFFeEMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRyxDQUFDO2dCQUNwRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdEM7U0FDRjtRQUNELElBQUksRUFBRSxDQUFDLE1BQU0sS0FBSyxFQUFFLENBQUMsTUFBTTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUNoRSxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNuQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNsQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3ZFO0lBQ0gsQ0FBQztDQUNGO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxJQUFrQixFQUFFLE1BQWM7SUFFM0QsTUFBTSxDQUFDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsTUFBTSxDQUFDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQUUsT0FBTztJQUMvQixNQUFNLEVBQUMsVUFBVSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQ25ELFFBQVEsRUFBRSxRQUFRLEVBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztJQUNsRCxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2QixJQUFJLE1BQU0sR0FBRyxTQUFTLENBQUM7SUFDdkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQUUsTUFBTSxHQUFHLFFBQVEsQ0FBQztJQUMxQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7UUFBRSxNQUFNLEdBQUcsUUFBUSxDQUFDO0lBQzFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25FLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzNCLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLEdBQVE7SUFFakMsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDO0lBQ25ELE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQztJQUc3QyxNQUFNLEVBQUMsV0FBVyxFQUFFLEVBQUMsTUFBTSxFQUFFLGtCQUFrQixFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQ2xELHFCQUFxQixFQUFFLGVBQWUsRUFBQyxFQUFDLEdBQUcsR0FBRyxDQUFDO0lBQ3BFLE9BQU8sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBRWxCLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDO1FBQ3ZCLENBQUMsSUFBSSxFQUFFLHFCQUFxQixDQUFDO1FBQzdCLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRCxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUU3QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBRTFCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNuQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgUmFuZG9tIH0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7IFJvbSB9IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQgeyBNZXRhbG9jYXRpb24gfSBmcm9tICcuLi9yb20vbWV0YWxvY2F0aW9uLmpzJztcblxuLy8gVE9ETyAtIHdlIGNvdWxkIGRvIGEgYml0IG1vcmUgbWFwIGdlbjogcmFuZG9taXplIHdoaWNoIGhhbGwgaGFzIHRoZSBpbm5lclxuLy8gc3RhaXIgKG9yIG1ha2UgbW9yZSBvZiB0aGVtKSwgYWRkIHNvbWUgZGVhZCBlbmRzIGluc3RlYWQgb2Ygc3RhaXJzLCBhZGRcbi8vIGV4dHJhIGJyYW5jaGVzIG9uIHRoZSBlZGdlL2Nvcm5lciwgZXRjLlxuXG5leHBvcnQgY2xhc3MgUHlyYW1pZFNodWZmbGUge1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBsb2NhdGlvbjogTG9jYXRpb24pIHt9XG5cbiAgLy8gVGhpcyBpcyBhIGRpZmZlcmVudCBzdHlsZSBvZiBzaHVmZmxlLiAgXG4gIHNodWZmbGUocmFuZG9tOiBSYW5kb20pIHtcbiAgICBjb25zdCBtZXRhID0gdGhpcy5sb2NhdGlvbi5tZXRhO1xuICAgIG1vdmVJbnRlcm5hbFN0YWlyKG1ldGEsIHJhbmRvbSk7XG4gICAgLy8gNTAlIGNoYW5jZSBvZiBzd2FwcGluZyB0aGUgZXhpdCB0byBhIGRvd25zdGFpci5cbiAgICBpZiAocmFuZG9tLm5leHRJbnQoMikpIGludmVydFB5cmFtaWRFeGl0KHRoaXMubG9jYXRpb24ucm9tKTtcbiAgICAvLyBDb2xsZWN0IGFsbCB0aGUgZXhpdHMsIGdyb3VwZWQgYnkgZGlyZWN0aW9uLlxuICAgIGNvbnN0IHVwID0gWy4uLm1ldGEuZXhpdHMoKV0uZmlsdGVyKGUgPT4gZVsxXSA9PT0gJ3N0YWlyOnVwJyk7XG4gICAgY29uc3QgZG4gPSBbLi4ubWV0YS5leGl0cygpXS5maWx0ZXIoZSA9PiBlWzFdID09PSAnc3RhaXI6ZG93bicpO1xuICAgIHJhbmRvbS5zaHVmZmxlKHVwKTtcbiAgICByYW5kb20uc2h1ZmZsZShkbik7XG4gICAgLy8gRmluZCBleGl0cyB0aGF0IGdvIGFueXdoZXJlIGFuZCBzd2FwIHRoZW0uXG4gICAgZm9yIChjb25zdCBlIG9mIFsuLi5tZXRhLmV4aXRzKCldKSB7XG4gICAgICBpZiAoKGVbMl1bMF0gPj4+IDgpICE9PSB0aGlzLmxvY2F0aW9uLmlkKSB7XG4gICAgICAgIC8vIFRoaXMgaXMgYSByZWFsIGV4aXQsIHNvIHBvcCBpdCBvdXQgb2YgdGhlIHJlbGV2YW50IGxpc3RcbiAgICAgICAgY29uc3QgbmV4dCA9IChlWzFdID09PSAnc3RhaXI6dXAnID8gdXAgOiBkbikucG9wKCkhO1xuICAgICAgICBtZXRhLnNldEV4aXQobmV4dFswXSwgbmV4dFsxXSwgZVsyXSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh1cC5sZW5ndGggIT09IGRuLmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKGBsZW5ndGggbWlzbWF0Y2hgKTtcbiAgICBjb25zdCBkbjIgPSByYW5kb20uc2h1ZmZsZShbLi4uZG5dKTtcbiAgICBjb25zdCBzZWxmID0gdGhpcy5sb2NhdGlvbi5pZCA8PCA4O1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdXAubGVuZ3RoOyBpKyspIHtcbiAgICAgIG1ldGEuc2V0RXhpdE9uZVdheSh1cFtpXVswXSwgdXBbaV1bMV0sIFtzZWxmIHwgZG5baV1bMF0sIGRuW2ldWzFdXSk7XG4gICAgICBtZXRhLnNldEV4aXRPbmVXYXkoZG4yW2ldWzBdLCBkbjJbaV1bMV0sIFtzZWxmIHwgdXBbaV1bMF0sIHVwW2ldWzFdXSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG1vdmVJbnRlcm5hbFN0YWlyKG1ldGE6IE1ldGFsb2NhdGlvbiwgcmFuZG9tOiBSYW5kb20pIHtcbiAgLy8geSB3aWxsIGJlIGVpdGhlciA2IG9yIDcsIHggd2lsbCBiZSBbMS4uNV0gKG9yIDIuLjQpXG4gIGNvbnN0IHkgPSByYW5kb20ubmV4dEludCgyKSArIDY7XG4gIGNvbnN0IHggPSByYW5kb20ubmV4dEludCgzKSArIDI7IC8vICg1KSArIDFcbiAgaWYgKHkgPT09IDcgJiYgeCA9PT0gMykgcmV0dXJuO1xuICBjb25zdCB7YnJhbmNoTldTRSwgYnJhbmNoTldFLCBicmFuY2hXU0UsIGJyYW5jaE5XRV91cFN0YWlyLFxuICAgICAgICAgZGVhZEVuZFcsIGRlYWRFbmRFfSA9IG1ldGEucm9tLm1ldGFzY3JlZW5zO1xuICBjb25zdCBwb3MgPSB5IDw8IDQgfCB4O1xuICBsZXQgYm90dG9tID0gYnJhbmNoV1NFO1xuICBpZiAoeSA9PT0gNyAmJiB4ID09PSAxKSBib3R0b20gPSBkZWFkRW5kRTtcbiAgaWYgKHkgPT09IDcgJiYgeCA9PT0gNSkgYm90dG9tID0gZGVhZEVuZFc7XG4gIG1ldGEuc2V0MmQoMHg2MywgW1ticmFuY2hOV1NFXSwgW2JyYW5jaE5XU0VdLCBbYnJhbmNoTldTRV1dKTtcbiAgbWV0YS5zZXQyZChwb3MgLSAxNiwgW1ticmFuY2hOV0VdLCBbYnJhbmNoTldFX3VwU3RhaXJdLCBbYm90dG9tXV0pO1xuICBtZXRhLm1vdmVFeGl0KDB4NzMsIHBvcyk7XG59XG5cbmZ1bmN0aW9uIGludmVydFB5cmFtaWRFeGl0KHJvbTogUm9tKSB7XG4gIC8vIE5lZWQgdG8gZG8gYSBmZXcgbWlub3IgdHdlYWtzIHRvIHR3byBtYXBzLlxuICBjb25zdCBkcmF5Z29uID0gcm9tLmxvY2F0aW9ucy5QeXJhbWlkX0RyYXlnb24ubWV0YTtcbiAgY29uc3QgbWFpbiA9IHJvbS5sb2NhdGlvbnMuUHlyYW1pZF9NYWluLm1ldGE7XG5cbiAgLy8gQ2hhbmdlIGEgZmV3IHNjcmVlbnMuXG4gIGNvbnN0IHttZXRhc2NyZWVuczoge2hhbGxTRSwgZGVhZEVuZFdfZG93blN0YWlyLCB3aWRlSGFsbE5FLCB3aWRlSGFsbE5XLFxuICAgICAgICAgICAgICAgICAgICAgICBmb3J0cmVzc0FyZW5hX3Rocm91Z2gsIGRlYWRFbmRTX3N0YWlyc319ID0gcm9tO1xuICBkcmF5Z29uLndpZHRoID0gMjtcbiAgLy8gVE9ETyAtIGlmIHdlIGhhdmUgc2NyZWVucyBhdmFpbGFibGUgdG8gbWFrZSB0aGlzIHNtb290aGVyLCB1c2UgdGhlbS5cbiAgZHJheWdvbi5zZXQyZCgweDAwLCBbW251bGwsIGRlYWRFbmRTX3N0YWlyc10sXG4gICAgICAgICAgICAgICAgICAgICAgIFtudWxsLCBmb3J0cmVzc0FyZW5hX3Rocm91Z2hdLFxuICAgICAgICAgICAgICAgICAgICAgICBbd2lkZUhhbGxORSwgd2lkZUhhbGxOV11dKTtcbiAgZHJheWdvbi5tb3ZlRXhpdCgweDIwLCAweDAxKTtcblxuICBtYWluLnNldDJkKDB4MDMsIFtbaGFsbFNFLCBkZWFkRW5kV19kb3duU3RhaXJdXSk7XG4gIG1haW4ubW92ZUV4aXQoMHgwMywgMHgwNCk7XG5cbiAgbWFpbi5hdHRhY2goMHgwNCwgZHJheWdvbiwgMHgwMSk7IC8vIHdpbGwgYXV0b21hdGljYWxseSBzd2FwIG91dCB0aGUgcmVzdFxufVxuIl19