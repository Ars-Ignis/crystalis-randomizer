import { Monogrid } from './monogrid.js';
import { Metalocation } from '../rom/metalocation.js';
import { CaveShuffle } from './cave.js';
import { seq } from '../rom/util.js';
import { ScreenFix } from '../rom/screenfix.js';
export class SwampShuffle extends CaveShuffle {
    build(h = this.pickHeight(), w = this.pickWidth()) {
        var _a, _b, _c;
        const rom = this.orig.rom;
        const g = new Monogrid(h, w);
        g.fill();
        const arenaY = h * w < 28 ? 0 : this.random.nextInt(h - 1);
        const arenaX = this.random.nextInt(w);
        function del(y, x) {
            g.delete2(y, x);
            g.fixed.add(y * g.w + x);
        }
        function isDoor(type) {
            return !type.startsWith('edge');
        }
        g.fixed.add(arenaY * g.w + arenaX);
        if (arenaX)
            del(arenaY, arenaX - 1);
        if (arenaX < g.w - 1)
            del(arenaY, arenaX + 1);
        if (arenaY) {
            del(arenaY - 1, arenaX);
            if (arenaX)
                del(arenaY - 1, arenaX - 1);
            if (arenaX < g.w - 1)
                del(arenaY - 1, arenaX + 1);
        }
        const edgePos = new Set();
        for (let dir = 0; dir < 4; dir++) {
            const max = dir & 1 ? h : w;
            const nums = this.random.shuffle(seq(max));
            const opp = dir & 2 ? max : 0;
            let count = (_b = (_a = this.params.edges) === null || _a === void 0 ? void 0 : _a[dir]) !== null && _b !== void 0 ? _b : 0;
            while (count && nums.length) {
                const y = dir & 1 ? nums.pop() : opp;
                const x = dir & 1 ? opp : nums.pop();
                const i = y * g.w + x;
                if (!g.data[i] || g.fixed.has(i))
                    continue;
                g.addEdge(y, x, dir);
                edgePos.add(y << 4 | x);
                count--;
            }
            if (count)
                return { ok: false, fail: `could not add all edges: ${dir} ${count}\n${g.toGrid('c').show()}\n${g.data}` };
        }
        console.log(g.toGrid('c').show());
        let deleted = 0;
        const target = g.h * g.w * (this.random.next() * 0.15 + 0.4);
        for (const posDir of this.random.ishuffle(seq(g.data.length << 2))) {
            const i = posDir >>> 2;
            const dir = posDir & 3;
            if (g.isBorder(i, dir) && g.deleteEdge(i, dir)) {
                if (++deleted >= target)
                    break;
            }
        }
        const allocd = new Set();
        const unallocd = new Set();
        const plain = [];
        const doors = [];
        let arena;
        for (const s of this.orig.tileset) {
            if (s.hasFeature('arena')) {
                arena = s;
                continue;
            }
            else if (s.hasFeature('empty')) {
                plain[0] = s;
                continue;
            }
            const edgeIndex = s.edgeIndex('s');
            if (edgeIndex == null)
                throw new Error(`bad edges`);
            const hasDoor = (_c = s.data.exits) === null || _c === void 0 ? void 0 : _c.some(e => isDoor(e.type));
            (hasDoor ? doors : plain)[edgeIndex] = s;
            (s.sid < 0 ? unallocd : allocd).add(s.sid);
        }
        if (!arena)
            throw new Error(`never found arena`);
        const used = new Set(g.consolidate(this.random, allocd.size).map(e => plain[e].sid));
        if (!used.size)
            return { ok: false, fail: `consolidate failed` };
        const newlyUsed = [...unallocd].filter(e => used.has(e));
        const newlyUnused = [...allocd].filter(e => !used.has(e));
        if (newlyUsed.length > newlyUnused.length)
            throw new Error(`out of space`);
        if (newlyUsed.length) {
            let unusedId = -1;
            while (rom.metascreens.getById(unusedId).length)
                unusedId--;
            for (let i = 0; i < newlyUsed.length; i++) {
                rom.metascreens.renumber(newlyUnused[i], unusedId);
                rom.metascreens.renumber(newlyUsed[i], newlyUnused[i]);
                unusedId = newlyUsed[i];
            }
            rom.metascreens.renumber(unusedId, newlyUsed.pop());
        }
        const meta = new Metalocation(this.orig.id, this.orig.tileset, h, w);
        for (let y = 0; y < g.h; y++) {
            for (let x = 0; x < g.w; x++) {
                const isArena = y === arenaY && x === arenaX;
                meta.set(y << 4 | x, isArena ? arena : plain[g.data[y * g.w + x]]);
            }
        }
        let doorCount = [...this.orig.exits()].filter(e => isDoor(e[1])).length;
        for (const pos of this.random.ishuffle(meta.allPos())) {
            if (!doorCount)
                break;
            if (edgePos.has(pos))
                continue;
            const x = pos & 0xf;
            const y = pos >>> 4;
            const door = doors[g.data[y * g.w + x]];
            if (!door)
                continue;
            meta.set(pos, door);
            doorCount--;
        }
        if (doorCount)
            return { ok: false, fail: `could not place all doors` };
        return { ok: true, value: meta };
    }
}
export function addSwampDoors(rom) {
    const { swamp } = rom.metatilesets;
    const $ = rom.metascreens;
    const tiles = [
        [0x03, 0xda, 0xac],
        [0x04, 0xe4, 0xaa],
        [0x05, 0xe5, 0xaa],
        [0x06, 0xe6, 0xaa],
        [0x07, 0xe7, 0xaa],
        [0x08, 0xf0, 0xaa],
        [0x09, 0xf1, 0xaa],
        [0x0a, 0xf2, 0xaa],
        [0x0b, 0xf3, 0xaa],
        [0x0c, 0xdc, 0xaa],
        [0x0d, 0xdd, 0xaa],
    ];
    for (const [tile, src, alt] of tiles) {
        swamp.getTile(tile).copyFrom(src).setAlternative(alt);
    }
    $.swampEmpty.screen.set2d(0x00, [
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xa8, 0xcc],
        [0xd2, 0xcc],
        [0xd2, 0xcc],
        [0xd2, 0xcc],
        [0xd2, 0xe2],
        [0xe2, 0xc8],
    ]);
    $.swampE.screen.set2d(0x4c, [
        [0x08, 0x09],
        [0x0c, 0x0b],
        [0x03, 0x03],
    ]);
    $.swampWSE.screen.set2d(0x25, [
        [, , 0x04],
        [0x08, 0x09, 0x05],
        [, 0x0a, 0x06],
        [, 0x0b, 0x07],
        [, 0x03, 0x03],
    ]);
    $.swampW.screen.set2d(0x24, [
        [0x04],
        [],
        [0x06],
        [0x07, 0x0d],
        [0x03, 0x03],
    ]);
    $.swampWS.screen.set2d(0x47, [
        [0x08, 0x09],
        [0x0c, 0x0b],
        [0x03, 0x03],
    ]);
    $.registerFix(ScreenFix.SwampDoors, 0);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3dhbXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvbWF6ZS9zd2FtcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxZQUFZLEVBQU8sTUFBTSx3QkFBd0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXhDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUdyQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFaEQsTUFBTSxPQUFPLFlBQWEsU0FBUSxXQUFXO0lBRTNDLEtBQUssQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFOztRQUMvQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUMxQixNQUFNLENBQUMsR0FBRyxJQUFJLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDN0IsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRVQsTUFBTSxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLFNBQVMsR0FBRyxDQUFDLENBQVMsRUFBRSxDQUFTO1lBQy9CLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxD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QUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDNUIsQ0FBSyxBQUFKLEVBQVUsQUFBTCxFQUFPLElBQUksQ0FBQztRQUNsQixDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDO1FBQ2xCLENBQUssQUFBSixFQUFNLElBQUksRUFBRSxJQUFJLENBQUM7UUFDbEIsQ0FBSyxBQUFKLEVBQU0sSUFBSSxFQUFFLElBQUksQ0FBQztRQUNsQixDQUFLLEFBQUosRUFBTSxJQUFJLEVBQUUsSUFBSSxDQUFDO0tBQ25CLENBQUMsQ0FBQztJQUVILENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDMUIsQ0FBQyxJQUFJLENBQU87UUFDWixFQUFZO1FBQ1osQ0FBQyxJQUFJLENBQU87UUFDWixDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7UUFDWixDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7S0FDYixDQUFDLENBQUM7SUFFSCxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1FBQzNCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztRQUNaLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztRQUNaLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztLQUNiLENBQUMsQ0FBQztJQUVILENBQUMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQW1CLENBQUM7QUFDM0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vbm9ncmlkIH0gZnJvbSAnLi9tb25vZ3JpZC5qcyc7XG5pbXBvcnQgeyBNZXRhbG9jYXRpb24sIFBvcyB9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgQ2F2ZVNodWZmbGUgfSBmcm9tICcuL2NhdmUuanMnO1xuaW1wb3J0IHsgUmVzdWx0IH0gZnJvbSAnLi9tYXplLmpzJztcbmltcG9ydCB7IHNlcSB9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7IE1ldGFzY3JlZW4gfSBmcm9tICcuLi9yb20vbWV0YXNjcmVlbi5qcyc7XG5pbXBvcnQgeyBSb20gfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHsgU2NyZWVuRml4IH0gZnJvbSAnLi4vcm9tL3NjcmVlbmZpeC5qcyc7XG5cbmV4cG9ydCBjbGFzcyBTd2FtcFNodWZmbGUgZXh0ZW5kcyBDYXZlU2h1ZmZsZSB7XG5cbiAgYnVpbGQoaCA9IHRoaXMucGlja0hlaWdodCgpLCB3ID0gdGhpcy5waWNrV2lkdGgoKSk6IFJlc3VsdDxNZXRhbG9jYXRpb24+IHtcbiAgICBjb25zdCByb20gPSB0aGlzLm9yaWcucm9tO1xuICAgIGNvbnN0IGcgPSBuZXcgTW9ub2dyaWQoaCwgdyk7XG4gICAgZy5maWxsKCk7XG4gICAgLy8gQWRkIGFyZW5hIChUT0RPIC0gY29uc2lkZXIgY29uZGl0aW9uICh0aGlzLnJhbmRvbS5uZXh0SW50KDQpKVxuICAgIGNvbnN0IGFyZW5hWSA9IGggKiB3IDwgMjggPyAwIDogdGhpcy5yYW5kb20ubmV4dEludChoIC0gMSk7XG4gICAgY29uc3QgYXJlbmFYID0gdGhpcy5yYW5kb20ubmV4dEludCh3KTtcbiAgICBmdW5jdGlvbiBkZWwoeTogbnVtYmVyLCB4OiBudW1iZXIpIHtcbiAgICAgIGcuZGVsZXRlMih5LCB4KTtcbiAgICAgIGcuZml4ZWQuYWRkKHkgKiBnLncgKyB4KTtcbiAgICB9XG4gICAgZnVuY3Rpb24gaXNEb29yKHR5cGU6IHN0cmluZykge1xuICAgICAgcmV0dXJuICF0eXBlLnN0YXJ0c1dpdGgoJ2VkZ2UnKTtcbiAgICB9XG4gICAgZy5maXhlZC5hZGQoYXJlbmFZICogZy53ICsgYXJlbmFYKTtcbiAgICBpZiAoYXJlbmFYKSBkZWwoYXJlbmFZLCBhcmVuYVggLSAxKTtcbiAgICBpZiAoYXJlbmFYIDwgZy53IC0gMSkgZGVsKGFyZW5hWSwgYXJlbmFYICsgMSk7XG4gICAgaWYgKGFyZW5hWSkge1xuICAgICAgZGVsKGFyZW5hWSAtIDEsIGFyZW5hWCk7XG4gICAgICBpZiAoYXJlbmFYKSBkZWwoYXJlbmFZIC0gMSwgYXJlbmFYIC0gMSk7XG4gICAgICBpZiAoYXJlbmFYIDwgZy53IC0gMSkgZGVsKGFyZW5hWSAtIDEsIGFyZW5hWCArIDEpO1xuICAgIH1cblxuICAgIC8vIEFkZCBlZGdlIGV4aXRzLlxuICAgIGNvbnN0IGVkZ2VQb3MgPSBuZXcgU2V0PFBvcz4oKTtcbiAgICBmb3IgKGxldCBkaXIgPSAwOyBkaXIgPCA0OyBkaXIrKykge1xuICAgICAgY29uc3QgbWF4ID0gZGlyICYgMSA/IGggOiB3O1xuICAgICAgY29uc3QgbnVtcyA9IHRoaXMucmFuZG9tLnNodWZmbGUoc2VxKG1heCkpO1xuICAgICAgY29uc3Qgb3BwID0gZGlyICYgMiA/IG1heCA6IDA7XG4gICAgICBsZXQgY291bnQgPSB0aGlzLnBhcmFtcy5lZGdlcz8uW2Rpcl0gPz8gMDtcbiAgICAgIHdoaWxlIChjb3VudCAmJiBudW1zLmxlbmd0aCkge1xuICAgICAgICBjb25zdCB5ID0gZGlyICYgMSA/IG51bXMucG9wKCkhIDogb3BwO1xuICAgICAgICBjb25zdCB4ID0gZGlyICYgMSA/IG9wcCA6IG51bXMucG9wKCkhO1xuICAgICAgICBjb25zdCBpID0geSAqIGcudyArIHg7XG4gICAgICAgIGlmICghZy5kYXRhW2ldIHx8IGcuZml4ZWQuaGFzKGkpKSBjb250aW51ZTtcbiAgICAgICAgZy5hZGRFZGdlKHksIHgsIGRpcik7XG4gICAgICAgIGVkZ2VQb3MuYWRkKHkgPDwgNCB8IHgpO1xuICAgICAgICBjb3VudC0tO1xuICAgICAgfVxuICAgICAgaWYgKGNvdW50KSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGNvdWxkIG5vdCBhZGQgYWxsIGVkZ2VzOiAke2Rpcn0gJHtjb3VudH1cXG4ke2cudG9HcmlkKCdjJykuc2hvdygpfVxcbiR7Zy5kYXRhfWB9O1xuICAgIH1cbmNvbnNvbGUubG9nKGcudG9HcmlkKCdjJykuc2hvdygpKTsgLy8gVE9ETyAtIHdoeSBpcyBlZGdlIGV4aXQgZGlzYXBwZWFyaW5nPyE/XG5cbiAgICAvLyBEZWxldGUgZWRnZXNcbiAgICAvLyBOT1RFOiBtYXkgd2FudCBtdWx0aXBsZSBwYXNzZXMgYmVjYXVzZSBlYXJsaWVyIGRlbGV0ZXNcbiAgICAvLyBjb3VsZCBlbmFibGUgbGF0ZXIgZGVsZXRlcz9cbiAgICAvLyBTaG9vdCBmb3IgZGVsZXRpbmcgYW55d2hlcmUgZnJvbSAwLjQqaCp3IHRvIDAuNTUqaCp3IG9mIHRoZSBlZGdlcy5cbiAgICBsZXQgZGVsZXRlZCA9IDA7XG4gICAgY29uc3QgdGFyZ2V0ID0gZy5oICogZy53ICogKHRoaXMucmFuZG9tLm5leHQoKSAqIDAuMTUgKyAwLjQpO1xuICAgIGZvciAoY29uc3QgcG9zRGlyIG9mIHRoaXMucmFuZG9tLmlzaHVmZmxlKHNlcShnLmRhdGEubGVuZ3RoIDw8IDIpKSkge1xuICAgICAgY29uc3QgaSA9IHBvc0RpciA+Pj4gMjtcbiAgICAgIGNvbnN0IGRpciA9IHBvc0RpciAmIDM7XG4gICAgICBpZiAoZy5pc0JvcmRlcihpLCBkaXIpICYmIGcuZGVsZXRlRWRnZShpLCBkaXIpKSB7XG4gICAgICAgIGlmICgrK2RlbGV0ZWQgPj0gdGFyZ2V0KSBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDb25zb2xpZGF0ZS4gIFRPRE8gLSByZWNvZ25pemUgY29ycmVjdCBjb3VudCFcbiAgICAvLyBOT1RFOiByb20ubW92ZVNjcmVlbnMoKSBjb3VsZCBoYXZlIGJlZW4gdXNlZCB0byBtb3ZlIHRoZSBzd2FtcCB0b1xuICAgIC8vIGEgbW9yZSBmcmVlIHBsYW5lLiAgSWYgc28sIHdlIGRvbid0IG5lZWQgdG8gY29uc29saWRhdGUgYXQgYWxsXG4gICAgLy8gYW5kIGFsbCB0aGUgc2NyZWVucycgc2lkcyB3aWxsIGJlIHBvc2l0aXZlLiAgRmluZCBvdXQgaG93IG1hbnlcbiAgICAvLyBub24tZW1wdHksIG5vbi1hcmVuYSBzY3JlZW5zIGluIHRoZSB0aWxlc2V0IGhhdmUgZGlmZmVyZW50IHBvc2l0aXZlXG4gICAgLy8gb3IgbmVnYXRpdmUgSURzLCBhbmQgZ3JvdXAgdGhlIG5vbi1kb29yIG9uZXMgYnkgZWRnZSBwcm9maWxlLlxuICAgIGNvbnN0IGFsbG9jZCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGNvbnN0IHVuYWxsb2NkID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgY29uc3QgcGxhaW46IE1ldGFzY3JlZW5bXSA9IFtdO1xuICAgIGNvbnN0IGRvb3JzOiBNZXRhc2NyZWVuW10gPSBbXTtcbiAgICBsZXQgYXJlbmE6IE1ldGFzY3JlZW58dW5kZWZpbmVkO1xuICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLm9yaWcudGlsZXNldCkge1xuICAgICAgaWYgKHMuaGFzRmVhdHVyZSgnYXJlbmEnKSkge1xuICAgICAgICBhcmVuYSA9IHM7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfSBlbHNlIGlmIChzLmhhc0ZlYXR1cmUoJ2VtcHR5JykpIHtcbiAgICAgICAgcGxhaW5bMF0gPSBzO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGVkZ2VJbmRleCA9IHMuZWRnZUluZGV4KCdzJyk7XG4gICAgICBpZiAoZWRnZUluZGV4ID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgYmFkIGVkZ2VzYCk7XG4gICAgICBjb25zdCBoYXNEb29yID0gcy5kYXRhLmV4aXRzPy5zb21lKGUgPT4gaXNEb29yKGUudHlwZSkpO1xuICAgICAgKGhhc0Rvb3IgPyBkb29ycyA6IHBsYWluKVtlZGdlSW5kZXhdID0gcztcbiAgICAgIChzLnNpZCA8IDAgPyB1bmFsbG9jZCA6IGFsbG9jZCkuYWRkKHMuc2lkKTtcbiAgICB9XG4gICAgaWYgKCFhcmVuYSkgdGhyb3cgbmV3IEVycm9yKGBuZXZlciBmb3VuZCBhcmVuYWApO1xuXG4gICAgY29uc3QgdXNlZCA9XG4gICAgICAgIG5ldyBTZXQoZy5jb25zb2xpZGF0ZSh0aGlzLnJhbmRvbSwgYWxsb2NkLnNpemUpLm1hcChlID0+IHBsYWluW2VdLnNpZCkpO1xuICAgIGlmICghdXNlZC5zaXplKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGNvbnNvbGlkYXRlIGZhaWxlZGB9O1xuICAgIGNvbnN0IG5ld2x5VXNlZCA9IFsuLi51bmFsbG9jZF0uZmlsdGVyKGUgPT4gdXNlZC5oYXMoZSkpO1xuICAgIGNvbnN0IG5ld2x5VW51c2VkID0gWy4uLmFsbG9jZF0uZmlsdGVyKGUgPT4gIXVzZWQuaGFzKGUpKTtcbiAgICBpZiAobmV3bHlVc2VkLmxlbmd0aCA+IG5ld2x5VW51c2VkLmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKGBvdXQgb2Ygc3BhY2VgKTtcblxuICAgIGlmIChuZXdseVVzZWQubGVuZ3RoKSB7XG4gICAgICAvLyBGaW5kIGFuIGF2YWlsYWJsZSBzaWQgdG8gc3dhcCBvdXQgd2l0aC4gIEN5Y2xlIGV2ZXJ5dGhpbmcgdGhyb3VnaC5cbiAgICAgIGxldCB1bnVzZWRJZCA9IC0xO1xuICAgICAgd2hpbGUgKHJvbS5tZXRhc2NyZWVucy5nZXRCeUlkKHVudXNlZElkKS5sZW5ndGgpIHVudXNlZElkLS07XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5ld2x5VXNlZC5sZW5ndGg7IGkrKykge1xuICAgICAgICByb20ubWV0YXNjcmVlbnMucmVudW1iZXIobmV3bHlVbnVzZWRbaV0sIHVudXNlZElkKTtcbiAgICAgICAgcm9tLm1ldGFzY3JlZW5zLnJlbnVtYmVyKG5ld2x5VXNlZFtpXSwgbmV3bHlVbnVzZWRbaV0pO1xuICAgICAgICB1bnVzZWRJZCA9IG5ld2x5VXNlZFtpXTtcbiAgICAgIH1cbiAgICAgIHJvbS5tZXRhc2NyZWVucy5yZW51bWJlcih1bnVzZWRJZCwgbmV3bHlVc2VkLnBvcCgpISk7XG4gICAgfVxuXG4gICAgY29uc3QgbWV0YSA9IG5ldyBNZXRhbG9jYXRpb24odGhpcy5vcmlnLmlkLCB0aGlzLm9yaWcudGlsZXNldCwgaCwgdyk7XG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCBnLmg7IHkrKykge1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCBnLnc7IHgrKykge1xuICAgICAgICBjb25zdCBpc0FyZW5hID0geSA9PT0gYXJlbmFZICYmIHggPT09IGFyZW5hWDtcbiAgICAgICAgbWV0YS5zZXQoeSA8PCA0IHwgeCwgaXNBcmVuYSA/IGFyZW5hIDogcGxhaW5bZy5kYXRhW3kgKiBnLncgKyB4XV0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFBpY2sgYSBsb2NhdGlvbiBmb3IgdGhlIGRvb3IocykuXG4gICAgbGV0IGRvb3JDb3VudCA9IFsuLi50aGlzLm9yaWcuZXhpdHMoKV0uZmlsdGVyKGUgPT4gaXNEb29yKGVbMV0pKS5sZW5ndGg7XG4gICAgZm9yIChjb25zdCBwb3Mgb2YgdGhpcy5yYW5kb20uaXNodWZmbGUobWV0YS5hbGxQb3MoKSkpIHtcbiAgICAgIGlmICghZG9vckNvdW50KSBicmVhaztcbiAgICAgIGlmIChlZGdlUG9zLmhhcyhwb3MpKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IHggPSBwb3MgJiAweGY7XG4gICAgICBjb25zdCB5ID0gcG9zID4+PiA0O1xuICAgICAgY29uc3QgZG9vciA9IGRvb3JzW2cuZGF0YVt5ICogZy53ICsgeF1dO1xuICAgICAgaWYgKCFkb29yKSBjb250aW51ZTtcbiAgICAgIG1ldGEuc2V0KHBvcywgZG9vcik7XG4gICAgICBkb29yQ291bnQtLTtcbiAgICB9XG4gICAgaWYgKGRvb3JDb3VudCkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBjb3VsZCBub3QgcGxhY2UgYWxsIGRvb3JzYH07XG4gICAgcmV0dXJuIHtvazogdHJ1ZSwgdmFsdWU6IG1ldGF9O1xuICB9XG59XG5cbi8qKiBBcHBseSB0aGUgU2NyZWVuRml4LlN3YW1wRG9vcnMuICovXG5leHBvcnQgZnVuY3Rpb24gYWRkU3dhbXBEb29ycyhyb206IFJvbSkge1xuICBjb25zdCB7c3dhbXB9ID0gcm9tLm1ldGF0aWxlc2V0cztcbiAgY29uc3QgJCA9IHJvbS5tZXRhc2NyZWVucztcblxuICAvLyBNYWtlIGEgaGFuZGZ1bCBvZiByZW1vdmFibGUgdGlsZXMgLSBkZWZhdWx0cyB0byBDTE9TRUQhXG4gIGNvbnN0IHRpbGVzID0gW1xuICAgIFsweDAzLCAweGRhLCAweGFjXSxcbiAgICBbMHgwNCwgMHhlNCwgMHhhYV0sXG4gICAgWzB4MDUsIDB4ZTUsIDB4YWFdLFxuICAgIFsweDA2LCAweGU2LCAweGFhXSxcbiAgICBbMHgwNywgMHhlNywgMHhhYV0sXG4gICAgWzB4MDgsIDB4ZjAsIDB4YWFdLFxuICAgIFsweDA5LCAweGYxLCAweGFhXSxcbiAgICBbMHgwYSwgMHhmMiwgMHhhYV0sXG4gICAgWzB4MGIsIDB4ZjMsIDB4YWFdLFxuICAgIFsweDBjLCAweGRjLCAweGFhXSxcbiAgICBbMHgwZCwgMHhkZCwgMHhhYV0sXG4gIF07XG4gIC8vY29uc3Qgc2NyZWVucyA9IFsuLi5zd2FtcF0uZmlsdGVyKHMgPT4gcy5zaWQgPj0gMCk7XG4gIGZvciAoY29uc3QgW3RpbGUsIHNyYywgYWx0XSBvZiB0aWxlcykge1xuICAgIHN3YW1wLmdldFRpbGUodGlsZSkuY29weUZyb20oc3JjKS5zZXRBbHRlcm5hdGl2ZShhbHQpO1xuICAgICAgLy8ucmVwbGFjZUluKC4uLnNjcmVlbnMpO1xuICB9XG5cbiAgLy8gRml4IGEgZmV3IHNjcmVlbnMuXG4gICQuc3dhbXBFbXB0eS5zY3JlZW4uc2V0MmQoMHgwMCwgWyAvLyBhZGQgbGVmdCBjb2x1bW5cbiAgICBbMHhhOCwgMHhjY10sIC8vIDBcbiAgICBbMHhhOCwgMHhjY10sXG4gICAgWzB4YTgsIDB4Y2NdLFxuICAgIFsweGE4LCAweGNjXSxcbiAgICBbMHhhOCwgMHhjY10sXG4gICAgWzB4YTgsIDB4Y2NdLFxuICAgIFsweGE4LCAweGNjXSxcbiAgICBbMHhhOCwgMHhjY10sXG4gICAgWzB4YTgsIDB4Y2NdLFxuICAgIFsweGQyLCAweGNjXSwgLy8gOVxuICAgIFsweGQyLCAweGNjXSxcbiAgICBbMHhkMiwgMHhjY10sXG4gICAgWzB4ZDIsIDB4ZTJdLCAvLyBjXG4gICAgWzB4ZTIsIDB4YzhdLCAvLyBkXG4gIF0pO1xuXG4gICQuc3dhbXBFLnNjcmVlbi5zZXQyZCgweDRjLCBbIC8vIGFkZCBvcHRpb25hbCBkb29yXG4gICAgWzB4MDgsIDB4MDldLCAvLyBmMCBmMVxuICAgIFsweDBjLCAweDBiXSwgLy8gZGMgZjNcbiAgICBbMHgwMywgMHgwM10sIC8vIGRhIGRhXG4gIF0pO1xuXG4gICQuc3dhbXBXU0Uuc2NyZWVuLnNldDJkKDB4MjUsIFsgLy8gYWRkIGFuIG9wdGlvbmFsIGRvb3JcbiAgICBbICAgICwgICAgICwgMHgwNF0sIC8vICAgICAgIGU0XG4gICAgWzB4MDgsIDB4MDksIDB4MDVdLCAvLyBmMCBmMSBlNVxuICAgIFsgICAgLCAweDBhLCAweDA2XSwgLy8gICAgZjIgZTZcbiAgICBbICAgICwgMHgwYiwgMHgwN10sIC8vICAgIGYzIGU3XG4gICAgWyAgICAsIDB4MDMsIDB4MDNdLCAvLyAgICBkYSBkYVxuICBdKTtcblxuICAkLnN3YW1wVy5zY3JlZW4uc2V0MmQoMHgyNCwgWyAvLyBhZGQgb3B0aW9uYWwgZG9vclxuICAgIFsweDA0ICAgICAgXSwgLy8gZTRcbiAgICBbICAgICAgICAgIF0sIC8vXG4gICAgWzB4MDYgICAgICBdLCAvLyBlNlxuICAgIFsweDA3LCAweDBkXSwgLy8gZTcgZGRcbiAgICBbMHgwMywgMHgwM10sIC8vIGRhIGRhXG4gIF0pO1xuXG4gICQuc3dhbXBXUy5zY3JlZW4uc2V0MmQoMHg0NywgWyAvLyBleGlzdGluZyBkb29yIG9wdGlvbmFsXG4gICAgWzB4MDgsIDB4MDldLCAvLyBmMCBmMVxuICAgIFsweDBjLCAweDBiXSwgLy8gZGMgZjNcbiAgICBbMHgwMywgMHgwM10sIC8vIGRhIGRhXG4gIF0pO1xuXG4gICQucmVnaXN0ZXJGaXgoU2NyZWVuRml4LlN3YW1wRG9vcnMsIDAgLyogdW51c2VkIHNlZWQgKi8pO1xufVxuIl19