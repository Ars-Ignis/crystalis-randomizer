import { Grid, E, S, N, W } from './grid.js';
import { OK } from '../maze/maze.js';
import { CaveShuffle } from './cave.js';
export class KarmineUpstairsShuffle extends CaveShuffle {
    constructor() {
        super(...arguments);
        this.patterns = [
            ['     ',
                ' >cc ',
                '   c ',
                '   b ',
                '   c '],
            ['     ',
                ' cc> ',
                ' c   ',
                ' b   ',
                ' c   '],
            ['   c ',
                '   b ',
                '   c ',
                ' >cc ',
                '     '],
            [' c   ',
                ' b   ',
                ' c   ',
                ' cc> ',
                '     ']
        ];
    }
    initialFill(a) {
        const pattern = this.random.pick(this.patterns);
        a.count = 3;
        const result = this.insertPattern(a, pattern, { top: 1, bottom: 1 });
        if (!result.ok)
            return result;
        for (let i = 0; i < a.grid.data.length; i++) {
            if (a.grid.data[i])
                a.fixed.add(a.grid.coord(i));
        }
        return OK;
    }
    addEdges(a) {
        let retries = 10;
        while (a.count < a.size && retries) {
            if (!this.tryAdd(a))
                retries--;
        }
        return retries ? OK : { ok: false, fail: `addEdges` };
    }
    addEarlyFeatures(a) {
        let found = false;
        for (const s of this.random.ishuffle(a.grid.screens())) {
            if (this.extract(a.grid, s) !== ' c  c  c ')
                continue;
            a.grid.set(s + 0x808, 'b');
            found = true;
            break;
        }
        if (!found)
            return { ok: false, fail: `could not add bridge` };
        return super.addStairs(a, 0, 2);
    }
    refine() { return OK; }
    addLateFeatures() { return OK; }
    addStairs() { return OK; }
}
const STAIRS = new WeakMap();
export class KarmineMainShuffle extends CaveShuffle {
    constructor() {
        super(...arguments);
        this.maxAttempts = 200;
    }
    initialFill(a) {
        const bridges = [];
        let stairDown = true;
        let stair;
        const upstairs = this.orig.rom.locations.GoaFortress_Karmine3.meta;
        for (const [pos, , [dest]] of upstairs.exits()) {
            if ((dest >>> 8) !== this.orig.id)
                continue;
            STAIRS.set(this.orig.rom.locations.GoaFortress_Karmine3, pos);
            stair = pos;
            if (!upstairs.get(pos).isEmpty()) {
                stair += 16;
                stairDown = false;
            }
            break;
        }
        if (stair == null)
            throw new Error('no stair found');
        for (const pos of upstairs.allPos()) {
            const scr = upstairs.get(pos);
            if (scr.hasFeature('overpass'))
                bridges.push(pos);
        }
        this.random.shuffle(bridges);
        let top = stair >>> 4;
        let left = stair & 0xf;
        let right = left;
        let bottom = top;
        for (const bridge of bridges) {
            const y = bridge >>> 4;
            const x = bridge & 0xf;
            top = Math.min(top, y);
            left = Math.min(left, x);
            right = Math.max(right, x);
            bottom = Math.max(bottom, y);
        }
        const height = bottom - top + 1;
        const width = right - left + 1;
        const origin = top << 4 | left;
        const outX = 1 + this.random.nextInt(a.w - width - 2);
        const outY = this.random.nextInt(a.h - height - (stairDown ? 1 : 0));
        const delta = (outY << 4 | outX) - origin;
        const stairRight = (stair & 0xf) - left < width / 2;
        stair += delta;
        STAIRS.set(this.orig.rom.locations.GoaFortress_Karmine5, stair);
        for (let i = 0; i < bridges.length; i++) {
            bridges[i] += delta;
        }
        const stairTile = stairDown ? '    <  c ' : stairRight ? '    <c   ' : '   c<    ';
        if (!this.insertTile(a, stair, stairTile) ||
            !this.insertTile(a, bridges[0], '   cbc   ') ||
            !this.insertTile(a, bridges[1], '   cbc   ')) {
            throw new Error('Could not insert tile');
        }
        a.fixed.add(this.posToGrid(stair, 0x808));
        a.fixed.add(this.posToGrid(bridges[0], 0x808));
        a.fixed.add(this.posToGrid(bridges[1], 0x808));
        a.count = 3;
        const dx = stairRight ? 1 : -1;
        const ds = stairDown ? 0x10 : dx;
        if (!bridges.includes(stair + dx) &&
            !this.tryConnect(a, this.posToGrid(stair + ds, 0x808), this.posToGrid(bridges[0] - dx, 0x808), 'c', 10)) {
            return { ok: false, fail: `could not connect stair to bridge` };
        }
        if (!this.tryConnect(a, this.posToGrid(bridges[0] + dx, 0x808), this.posToGrid(bridges[1] + dx, 0x808), 'c', 10)) {
            return { ok: false, fail: `could not connect bridges` };
        }
        return OK;
    }
    addEdges(a) {
        let attempts = 100;
        while (a.count < a.size - 4 && attempts) {
            if (!this.tryAdd(a))
                attempts--;
        }
        return attempts ? OK : { ok: false, fail: `could not populate` };
    }
    refine() { return OK; }
    refineEdges() { return true; }
    addUnderpasses() { return true; }
    addArenas(a) {
        for (const s of this.random.ishuffle(a.grid.screens())) {
            if (!(s & 0xf000))
                continue;
            const c = s + 0x808;
            if (a.fixed.has(c) || a.grid.get(c))
                continue;
            if (a.grid.get(W(c, 2)) || a.grid.get(E(c, 2)))
                continue;
            if (a.grid.get(S(c, 2)) !== 'c')
                continue;
            if (!this.canSetAll(a, new Map([[S(c), 'c'], [c, 'a'],
                [N(c), 'c'], [N(c, 2), 'c']]))) {
                continue;
            }
            a.grid.set(S(c), 'c');
            a.grid.set(c, 'a');
            a.grid.set(N(c), 'c');
            a.fixed.add(c);
            a.fixed.add(N(c, 2));
            return true;
        }
        return false;
    }
    addStairs(a, up = 0, down = 0) {
        return super.addStairs(a, up - 1, down);
    }
    finish(newMeta) {
        for (const [pos, type] of this.orig.exits()) {
            if (type.startsWith('seamless'))
                this.orig.deleteExit(pos, type);
        }
        super.finish(newMeta);
        const upperMeta = this.orig.rom.locations.GoaFortress_Karmine3.meta;
        const upperPos = STAIRS.get(this.orig.rom.locations.GoaFortress_Karmine3);
        const mainPos = STAIRS.get(this.orig.rom.locations.GoaFortress_Karmine5);
        if (upperPos != null && mainPos != null) {
            newMeta.attach(mainPos, upperMeta, upperPos, 'stair:up', 'stair:down');
        }
    }
}
export class KarmineKensuShuffle extends CaveShuffle {
    findArena(meta) {
        for (const pos of meta.allPos()) {
            if (meta.get(pos).hasFeature('arena')) {
                return pos;
            }
        }
        throw new Error(`never found arena`);
    }
    initialFill(a) {
        const main = this.orig.rom.locations.GoaFortress_Karmine5.meta;
        const arena = this.findArena(main);
        const c = this.posToGrid(arena, 0x808);
        a.grid.set(c, 'a');
        a.grid.set(N(c), 'c');
        a.grid.set(S(c), 'c');
        a.fixed.add(c);
        a.fixed.add(S(c));
        a.fixed.add(S(c, 2));
        return OK;
    }
    addEdges(a) {
        let retries = 10;
        const size = 2 + this.random.nextInt(2);
        while (a.count < size && retries) {
            if (!this.tryAdd(a))
                retries--;
        }
        return retries ? OK : { ok: false, fail: `addEdges` };
    }
    refine() { return OK; }
    addLateFeatures() { return OK; }
    inferScreens(a) {
        const result = super.inferScreens(a);
        if (!result.ok)
            return result;
        const meta = result.value;
        const arena = this.findArena(meta);
        const main = this.orig.rom.locations.GoaFortress_Karmine5.meta;
        meta.set(arena + 0x10, main.get(arena + 0x10));
        return result;
    }
    finish(newMeta) {
        const main = this.orig.rom.locations.GoaFortress_Karmine5.meta;
        const arena = this.findArena(newMeta);
        super.finish(newMeta);
        main.setExit(arena, 'seamless:up', [newMeta.id << 8 | arena, 'seamless:down']);
        newMeta.freeFlags = new Set(main.freeFlags);
    }
    reportFailure() {
        throw new Error(`Completely failed to shuffle Karmine Kensu map`);
    }
}
export class KarmineBasementShuffle extends CaveShuffle {
    constructor() {
        super(...arguments);
        this.looseRefine = true;
    }
    pickWidth() { return 8; }
    pickHeight() { return 5; }
    initialFill(a) {
        if (a.grid.height !== 5 || a.grid.width !== 8)
            throw new Error('bad size');
        Grid.writeGrid2d(a.grid, 0, KarmineBasementShuffle.PATTERN);
        a.count = 36;
        return OK;
    }
    addSpikes(a) {
        const dropped = this.random.nextInt(4);
        for (let y = 1; y < 10; y++) {
            for (let x = 0; x < 4; x++) {
                const i = 2 * x + 5 + y * 17;
                if (x === dropped) {
                    a.grid.data[i] = 'c';
                }
                else {
                    const c = a.grid.coord(i);
                    a.fixed.add(c);
                    if (y === 5) {
                        a.fixed.add(c + 8);
                        a.fixed.add(c + 16);
                        a.fixed.add(c - 8);
                        a.fixed.add(c - 16);
                    }
                }
            }
        }
        let stairs = 0;
        for (const c of this.random.ishuffle(a.grid.screens())) {
            if (stairs === 3)
                break;
            const mid = (c | 0x808);
            const up = (mid - 0x800);
            const down = (mid + 0x800);
            if (a.grid.get(mid) === 'c' &&
                a.grid.get(up) !== 's' &&
                a.grid.get(down) !== 's') {
                a.grid.set(mid, '<');
                a.fixed.add(mid);
                a.grid.set(up, '');
                a.grid.set(down, '');
                stairs++;
            }
        }
        const partitions = new Set(a.grid.partition().values());
        return partitions.size === 1;
    }
    addStairs() { return OK; }
}
KarmineBasementShuffle.PATTERN = [
    '                 ',
    '   ccccccccccc   ',
    '   c c c c c c   ',
    ' ccc s s s s ccc ',
    ' c c s s s s c c ',
    ' ccccscscscscccc ',
    ' c c s s s s c c ',
    ' ccc s s s s ccc ',
    '   c c c c c c   ',
    '   ccccccccccc   ',
    '                 ',
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2FybWluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9tYXplL2thcm1pbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBd0IsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25FLE9BQU8sRUFBVSxFQUFFLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQXNCLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQWE1RCxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsV0FBVztJQUF2RDs7UUFDVyxhQUFRLEdBQUc7WUFDbEIsQ0FBQyxPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxPQUFPO2dCQUNQLE9BQU8sQ0FBQztZQUNULENBQUMsT0FBTztnQkFDUCxPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxPQUFPLENBQUM7WUFDVCxDQUFDLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsT0FBTyxDQUFDO1lBQ1QsQ0FBQyxPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxPQUFPO2dCQUNQLE9BQU8sQ0FBQztTQUFDLENBQUM7SUFxQ2YsQ0FBQztJQW5DQyxXQUFXLENBQUMsQ0FBSTtRQUNkLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoRCxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNaLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxFQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBQyxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQUUs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QUMzQixNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDOUI7UUFDRCxNQUFNLE1BQU0sR0FBRyxNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUNoQyxNQUFNLEtBQUssR0FBRyxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQztRQUMvQixNQUFNLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztRQUcvQixNQUFNLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyRSxNQUFNLEtBQUssR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBQzFDLE1BQU0sVUFBVSxHQUFHLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ3BELEtBQUssSUFBSSxLQUFLLENBQUM7UUFDZixNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoRSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN2QyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDO1NBQ3JCO1FBQ0QsTUFBTSxTQUFTLEdBQ1gsU0FBUyxDQUFDLENB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LENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQ25CLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDckIsTUFBTSxFQUFFLENBQUM7YUFDVjtTQUNGO1FBR0QsTUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ3hELE9BQU8sVUFBVSxDQUFDLElBQUksS0FBSyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVELFNBQVMsS0FBSyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7O0FBRVYsOEJBQU8sR0FBRztJQUN4QixtQkFBbUI7SUFDbkIsbUJBQW1CO0lBQ25CLG1CQUFtQjtJQUNuQixtQkFBbUI7SUFDbkIsbUJBQW1CO0lBQ25CLG1CQUFtQjtJQUNuQixtQkFBbUI7SUFDbkIsbUJBQW1CO0lBQ25CLG1CQUFtQjtJQUNuQixtQkFBbUI7SUFDbkIsbUJBQW1CO0NBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHcmlkLCBHcmlkQ29vcmQsIEdyaWRJbmRleCwgRSwgUywgTiwgVyB9IGZyb20gJy4vZ3JpZC5qcyc7XG5pbXBvcnQgeyBSZXN1bHQsIE9LIH0gZnJvbSAnLi4vbWF6ZS9tYXplLmpzJztcbmltcG9ydCB7IENhdmVTaHVmZmxlQXR0ZW1wdCwgQ2F2ZVNodWZmbGUgfSBmcm9tICcuL2NhdmUuanMnO1xuaW1wb3J0IHsgUG9zLCBNZXRhbG9jYXRpb24gfSBmcm9tICcuLi9yb20vbWV0YWxvY2F0aW9uLmpzJztcbmltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnLi4vcm9tL2xvY2F0aW9uLmpzJztcblxudHlwZSBBID0gQ2F2ZVNodWZmbGVBdHRlbXB0O1xuXG4vLyBCYXNpYyBwbGFuOiB0aGlzIGlzIHNpbXBsZSBlbm91Z2ggdGhhdCB3ZSBfc2hvdWxkXyBiZSBhYmxlIHRvIHdvcmtcbi8vIHdpdGggd2hhdGV2ZXIgaGFwcGVucy4gIERvIHRoZSBzaHVmZmxlIG9uY2UgYW5kIHRoZW4gbmV2ZXIgbG9vayBiYWNrLlxuLy8gSE9XRVZFUiwgaXQgd291bGQgYmUgbmljZSBpZiB0aGVyZSB3ZXJlIGEgd2F5IHRvIGRvIHRoaXMgbW9yZVxuLy8gZ2VuZXJhbGx5IGFuZCBhdXRvbWF0aWNhbGx5IGZvcmNlIGEgcmV0cnkgYWZ0ZXIgc29tZSBhbW91bnQgb2YgdGltZS5cbi8vIElkZWFsbHksIHdlIGRlY291cGxlIF9hbGxfIHRoZSBmaW5pc2hlcyBmcm9tIF9hbGxfIHRoZSBzaHVmZmxlcyBhbmRcbi8vIHJldGFpbiB0aGUgZ3JpZCBhbmQgbWV0YXNjcmVlbnMgYXMgYWNjZXNzaWJsZSBieSBhbGwgbGF0ZXIgc2h1ZmZsZXMsXG4vLyBhbGxvd2luZyBmb3IgY29ubmVjdGVkIHJldHJpZXMgYXMgbmVlZGVkLiAgQnV0IGZvciBub3cgdGhpcyB3aWxsIGRvLlxuZXhwb3J0IGNsYXNzIEthcm1pbmVVcHN0YWlyc1NodWZmbGUgZXh0ZW5kcyBDYXZlU2h1ZmZsZSB7XG4gIHJlYWRvbmx5IHBhdHRlcm5zID0gW1xuICAgIFsnICAgICAnLFxuICAgICAnID5jYyAnLFxuICAgICAnICAgYyAnLFxuICAgICAnICAgYiAnLFxuICAgICAnICAgYyAnXSxcbiAgICBbJyAgICAgJyxcbiAgICAgJyBjYz4gJyxcbiAgICAgJyBjICAgJyxcbiAgICAgJyBiICAgJyxcbiAgICAgJyBjICAgJ10sXG4gICAgWycgICBjICcsXG4gICAgICcgICBiICcsXG4gICAgICcgICBjICcsXG4gICAgICcgPmNjICcsXG4gICAgICcgICAgICddLFxuICAgIFsnIGMgICAnLFxuICAgICAnIGIgICAnLFxuICAgICAnIGMgICAnLFxuICAgICAnIGNjPiAnLFxuICAgICAnICAgICAnXV07XG5cbiAgaW5pdGlhbEZpbGwoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgY29uc3QgcGF0dGVybiA9IHRoaXMucmFuZG9tLnBpY2sodGhpcy5wYXR0ZXJucyk7XG4gICAgYS5jb3VudCA9IDM7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5pbnNlcnRQYXR0ZXJuKGEsIHBhdHRlcm4sIHt0b3A6IDEsIGJvdHRvbTogMX0pO1xuICAgIGlmICghcmVzdWx0Lm9rKSByZXR1cm4gcmVzdWx0O1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYS5ncmlkLmRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChhLmdyaWQuZGF0YVtpXSkgYS5maXhlZC5hZGQoYS5ncmlkLmNvb3JkKGkgYXMgR3JpZEluZGV4KSk7XG4gICAgfVxuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGFkZEVkZ2VzKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGxldCByZXRyaWVzID0gMTA7XG4gICAgd2hpbGUgKGEuY291bnQgPCBhLnNpemUgJiYgcmV0cmllcykge1xuICAgICAgaWYgKCF0aGlzLnRyeUFkZChhKSkgcmV0cmllcy0tO1xuICAgIH1cbiAgICByZXR1cm4gcmV0cmllcyA/IE9LIDoge29rOiBmYWxzZSwgZmFpbDogYGFkZEVkZ2VzYH07XG4gIH1cblxuICBhZGRFYXJseUZlYXR1cmVzKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIC8vIExvb2sgZm9yIGEgTi1TIGhhbGx3YXkgdG8gYWRkIGEgYnJpZGdlLlxuICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLnJhbmRvbS5pc2h1ZmZsZShhLmdyaWQuc2NyZWVucygpKSkge1xuICAgICAgaWYgKHRoaXMuZXh0cmFjdChhLmdyaWQsIHMpICE9PSAnIGMgIGMgIGMgJykgY29udGludWU7XG4gICAgICBhLmdyaWQuc2V0KHMgKyAweDgwOCBhcyBHcmlkQ29vcmQsICdiJyk7XG4gICAgICBmb3VuZCA9IHRydWU7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgaWYgKCFmb3VuZCkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBjb3VsZCBub3QgYWRkIGJyaWRnZWB9O1xuICAgIHJldHVybiBzdXBlci5hZGRTdGFpcnMoYSwgMCwgMik7XG4gIH1cblxuICByZWZpbmUoKSB7IHJldHVybiBPSzsgfVxuICBhZGRMYXRlRmVhdHVyZXMoKSB7IHJldHVybiBPSzsgfVxuICBhZGRTdGFpcnMoKSB7IHJldHVybiBPSzsgfVxufVxuXG5jb25zdCBTVEFJUlMgPSBuZXcgV2Vha01hcDxMb2NhdGlvbiwgUG9zPigpO1xuXG5leHBvcnQgY2xhc3MgS2FybWluZU1haW5TaHVmZmxlIGV4dGVuZHMgQ2F2ZVNodWZmbGUge1xuXG4gIG1heEF0dGVtcHRzID0gMjAwO1xuXG4gIGluaXRpYWxGaWxsKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIC8vIEZpbmQgdGhlIHN0YWlyIGZyb20gVXBzdGFpcnMsIGNvcHkgdGhlIGJyaWRnZXMgb3Zlci5cbiAgICBjb25zdCBicmlkZ2VzOiBQb3NbXSA9IFtdO1xuICAgIGxldCBzdGFpckRvd24gPSB0cnVlO1xuICAgIGxldCBzdGFpcjogUG9zfHVuZGVmaW5lZDtcbiAgICBjb25zdCB1cHN0YWlycyA9IHRoaXMub3JpZy5yb20ubG9jYXRpb25zLkdvYUZvcnRyZXNzX0thcm1pbmUzLm1ldGE7XG4gICAgZm9yIChjb25zdCBbcG9zLCwgW2Rlc3RdXSBvZiB1cHN0YWlycy5leGl0cygpKSB7XG4gICAgICBpZiAoKGRlc3QgPj4+IDgpICE9PSB0aGlzLm9yaWcuaWQpIGNvbnRpbnVlO1xuICAgICAgU1RBSVJTLnNldCh0aGlzLm9yaWcucm9tLmxvY2F0aW9ucy5Hb2FGb3J0cmVzc19LYXJtaW5lMywgcG9zKTtcbiAgICAgIHN0YWlyID0gcG9zO1xuICAgICAgLy8gT2Zmc2V0IGlmIGl0J3Mgbm90IHRoZSBzaW5nbGUtdGlsZSB1cC1kb3duIHN0YWlycy5cbiAgICAgIGlmICghdXBzdGFpcnMuZ2V0KHBvcykuaXNFbXB0eSgpKSB7XG4gICAgICAgIHN0YWlyICs9IDE2O1xuICAgICAgICBzdGFpckRvd24gPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoc3RhaXIgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdubyBzdGFpciBmb3VuZCcpO1xuICAgIGZvciAoY29uc3QgcG9zIG9mIHVwc3RhaXJzLmFsbFBvcygpKSB7XG4gICAgICBjb25zdCBzY3IgPSB1cHN0YWlycy5nZXQocG9zKTtcbiAgICAgIGlmIChzY3IuaGFzRmVhdHVyZSgnb3ZlcnBhc3MnKSkgYnJpZGdlcy5wdXNoKHBvcyk7XG4gICAgfVxuICAgIHRoaXMucmFuZG9tLnNodWZmbGUoYnJpZGdlcyk7XG5cbiAgICAvLyBSZWxhdGl2aXplXG4gICAgbGV0IHRvcCA9IHN0YWlyID4+PiA0O1xuICAgIGxldCBsZWZ0ID0gc3RhaXIgJiAweGY7XG4gICAgbGV0IHJpZ2h0ID0gbGVmdDtcbiAgICBsZXQgYm90dG9tID0gdG9wO1xuICAgIGZvciAoY29uc3QgYnJpZGdlIG9mIGJyaWRnZXMpIHtcbiAgICAgIGNvbnN0IHkgPSBicmlkZ2UgPj4+IDQ7XG4gICAgICBjb25zdCB4ID0gYnJpZGdlICYgMHhmO1xuICAgICAgdG9wID0gTWF0aC5taW4odG9wLCB5KTtcbiAgICAgIGxlZnQgPSBNYXRoLm1pbihsZWZ0LCB4KTtcbiAgICAgIHJpZ2h0ID0gTWF0aC5tYXgocmlnaHQsIHgpO1xuICAgICAgYm90dG9tID0gTWF0aC5tYXgoYm90dG9tLCB5KTtcbiAgICB9XG4gICAgY29uc3QgaGVpZ2h0ID0gYm90dG9tIC0gdG9wICsgMTtcbiAgICBjb25zdCB3aWR0aCA9IHJpZ2h0IC0gbGVmdCArIDE7XG4gICAgY29uc3Qgb3JpZ2luID0gdG9wIDw8IDQgfCBsZWZ0O1xuXG4gICAgLy8gUGxhY2UgdGhlIGJyaWRnZXMgYW5kIHN0YWlyIGluIGEgcmFuZG9tIGxvY2F0aW9uLlxuICAgIGNvbnN0IG91dFggPSAxICsgdGhpcy5yYW5kb20ubmV4dEludChhLncgLSB3aWR0aCAtIDIpO1xuICAgIGNvbnN0IG91dFkgPSB0aGlzLnJhbmRvbS5uZXh0SW50KGEuaCAtIGhlaWdodCAtIChzdGFpckRvd24gPyAxIDogMCkpO1xuICAgIGNvbnN0IGRlbHRhID0gKG91dFkgPDwgNCB8IG91dFgpIC0gb3JpZ2luO1xuICAgIGNvbnN0IHN0YWlyUmlnaHQgPSAoc3RhaXIgJiAweGYpIC0gbGVmdCA8IHdpZHRoIC8gMjtcbiAgICBzdGFpciArPSBkZWx0YTtcbiAgICBTVEFJUlMuc2V0KHRoaXMub3JpZy5yb20ubG9jYXRpb25zLkdvYUZvcnRyZXNzX0thcm1pbmU1LCBzdGFpcik7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBicmlkZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBicmlkZ2VzW2ldICs9IGRlbHRhO1xuICAgIH1cbiAgICBjb25zdCBzdGFpclRpbGUgPVxuICAgICAgICBzdGFpckRvd24gPyAnICAgIDwgIGMgJyA6IHN0YWlyUmlnaHQgPyAnICAgIDxjICAgJyA6ICcgICBjPCAgICAnO1xuICAgIGlmICghdGhpcy5pbnNlcnRUaWxlKGEsIHN0YWlyLCBzdGFpclRpbGUpIHx8XG4gICAgICAgICF0aGlzLmluc2VydFRpbGUoYSwgYnJpZGdlc1swXSwgJyAgIGNiYyAgICcpIHx8XG4gICAgICAgICF0aGlzLmluc2VydFRpbGUoYSwgYnJpZGdlc1sxXSwgJyAgIGNiYyAgICcpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBpbnNlcnQgdGlsZScpO1xuICAgIH1cbiAgICBhLmZpeGVkLmFkZCh0aGlzLnBvc1RvR3JpZChzdGFpciwgMHg4MDgpKTtcbiAgICBhLmZpeGVkLmFkZCh0aGlzLnBvc1RvR3JpZChicmlkZ2VzWzBdLCAweDgwOCkpO1xuICAgIGEuZml4ZWQuYWRkKHRoaXMucG9zVG9HcmlkKGJyaWRnZXNbMV0sIDB4ODA4KSk7XG4gICAgYS5jb3VudCA9IDM7XG5cbiAgICBjb25zdCBkeCA9IHN0YWlyUmlnaHQgPyAxIDogLTE7XG4gICAgY29uc3QgZHMgPSBzdGFpckRvd24gPyAweDEwIDogZHg7XG4gICAgaWYgKCFicmlkZ2VzLmluY2x1ZGVzKHN0YWlyICsgZHgpICYmXG4gICAgICAgICF0aGlzLnRyeUNvbm5lY3QoYSwgdGhpcy5wb3NUb0dyaWQoc3RhaXIgKyBkcywgMHg4MDgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zVG9HcmlkKGJyaWRnZXNbMF0gLSBkeCwgMHg4MDgpLCAnYycsIDEwKSkge1xuICAgICAgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBjb3VsZCBub3QgY29ubmVjdCBzdGFpciB0byBicmlkZ2VgfTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnRyeUNvbm5lY3QoYSwgdGhpcy5wb3NUb0dyaWQoYnJpZGdlc1swXSArIGR4LCAweDgwOCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NUb0dyaWQoYnJpZGdlc1sxXSArIGR4LCAweDgwOCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgJ2MnLCAxMCkpIHtcbiAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgY291bGQgbm90IGNvbm5lY3QgYnJpZGdlc2B9O1xuICAgIH1cbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICBhZGRFZGdlcyhhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBsZXQgYXR0ZW1wdHMgPSAxMDA7XG4gICAgd2hpbGUgKGEuY291bnQgPCBhLnNpemUgLSA0ICYmIGF0dGVtcHRzKSB7XG4gICAgICBpZiAoIXRoaXMudHJ5QWRkKGEpKSBhdHRlbXB0cy0tO1xuICAgIH1cbiAgICByZXR1cm4gYXR0ZW1wdHMgPyBPSyA6IHtvazogZmFsc2UsIGZhaWw6IGBjb3VsZCBub3QgcG9wdWxhdGVgfTtcbiAgfVxuXG4gIHJlZmluZSgpIHsgcmV0dXJuIE9LOyB9XG4gIHJlZmluZUVkZ2VzKCkgeyByZXR1cm4gdHJ1ZTsgfVxuICBhZGRVbmRlcnBhc3NlcygpIHsgcmV0dXJuIHRydWU7IH1cblxuICBhZGRBcmVuYXMoYTogQSk6IGJvb2xlYW4ge1xuICAgIC8vIFRyeSB0byBhZGQga2Vuc3UncyBhcmVuYS4gIExvb2sgZm9yIGEgcGxhY2Ugd2UgY2FuIGFkZCAnIGMgfCBhIHwgYyAnLlxuICAgIC8vIERvbid0IGJvdGhlciBhZGRpbmcgdGhlIHN0YWlyIG9uIHRoZSBvdGhlciBzaWRlLCBzaW5jZSBpdCBkb2Vzbid0XG4gICAgLy8gYWN0dWFsbHkgbWF0dGVyIGhlcmUuICBCdXQgdG8gbWFrZSB0aGUgc2VhbWxlc3Mgd29yaywgd2UgZG8gbmVlZCB0b1xuICAgIC8vIGhhdmUgX3NwYWNlXyBmb3IgaXQuXG4gICAgZm9yIChjb25zdCBzIG9mIHRoaXMucmFuZG9tLmlzaHVmZmxlKGEuZ3JpZC5zY3JlZW5zKCkpKSB7XG4gICAgICBpZiAoIShzICYgMHhmMDAwKSkgY29udGludWU7IC8vIHRvcCByb3cgbm90IGFsbG93ZWRcbiAgICAgIGNvbnN0IGMgPSBzICsgMHg4MDggYXMgR3JpZENvb3JkO1xuICAgICAgaWYgKGEuZml4ZWQuaGFzKGMpIHx8IGEuZ3JpZC5nZXQoYykpIGNvbnRpbnVlO1xuICAgICAgaWYgKGEuZ3JpZC5nZXQoVyhjLCAyKSkgfHwgYS5ncmlkLmdldChFKGMsIDIpKSkgY29udGludWU7XG4gICAgICBpZiAoYS5ncmlkLmdldChTKGMsIDIpKSAhPT0gJ2MnKSBjb250aW51ZTtcbiAgICAgIGlmICghdGhpcy5jYW5TZXRBbGwoYSwgbmV3IE1hcChbW1MoYyksICdjJ10sIFtjLCAnYSddLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbTihjKSwgJ2MnXSwgW04oYywgMiksICdjJ11dKSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyBBZGQgdGhlIGFyZW5hIHdpdGggYSBkZWFkIGVuZC5cbiAgICAgIGEuZ3JpZC5zZXQoUyhjKSwgJ2MnKTtcbiAgICAgIGEuZ3JpZC5zZXQoYywgJ2EnKTtcbiAgICAgIGEuZ3JpZC5zZXQoTihjKSwgJ2MnKTtcbiAgICAgIC8vYS5ncmlkLnNldChOKGMsIDIpLCAnYycpO1xuICAgICAgYS5maXhlZC5hZGQoYyk7XG4gICAgICBhLmZpeGVkLmFkZChOKGMsIDIpKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBhZGRTdGFpcnMoYTogQSwgdXAgPSAwLCBkb3duID0gMCkge1xuICAgIHJldHVybiBzdXBlci5hZGRTdGFpcnMoYSwgdXAgLSAxLCBkb3duKTtcbiAgfVxuXG4gIGZpbmlzaChuZXdNZXRhOiBNZXRhbG9jYXRpb24pIHtcbiAgICAvLyBUaGUgc2VhbWxlc3MgZXhpdCBpcyBwcm9ibGVtYXRpYyBiZWZvcmUgdGhlIG90aGVyIHNpZGUgbW92ZXMuXG4gICAgLy8gU28gZGVsZXRlIGl0IGZvciBub3csIGFuZCBhZGQgaXQgYmFjayBsYXRlci5cbiAgICBmb3IgKGNvbnN0IFtwb3MsIHR5cGVdIG9mIHRoaXMub3JpZy5leGl0cygpKSB7XG4gICAgICBpZiAodHlwZS5zdGFydHNXaXRoKCdzZWFtbGVzcycpKSB0aGlzLm9yaWcuZGVsZXRlRXhpdChwb3MsIHR5cGUpO1xuICAgIH1cbiAgICBzdXBlci5maW5pc2gobmV3TWV0YSk7XG4gICAgLy8gTWFrZSBzdXJlIHRoZSByaWdodCBzdGFpcnMgY29ubmVjdCB0byB0aGUgdXBwZXIgZmxvb3IuXG4gICAgY29uc3QgdXBwZXJNZXRhID0gdGhpcy5vcmlnLnJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2FybWluZTMubWV0YTtcbiAgICBjb25zdCB1cHBlclBvcyA9IFNUQUlSUy5nZXQodGhpcy5vcmlnLnJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2FybWluZTMpO1xuICAgIGNvbnN0IG1haW5Qb3MgPSBTVEFJUlMuZ2V0KHRoaXMub3JpZy5yb20ubG9jYXRpb25zLkdvYUZvcnRyZXNzX0thcm1pbmU1KTtcbiAgICBpZiAodXBwZXJQb3MgIT0gbnVsbCAmJiBtYWluUG9zICE9IG51bGwpIHtcbiAgICAgIG5ld01ldGEuYXR0YWNoKG1haW5Qb3MsIHVwcGVyTWV0YSwgdXBwZXJQb3MsICdzdGFpcjp1cCcsICdzdGFpcjpkb3duJyk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBLYXJtaW5lS2Vuc3VTaHVmZmxlIGV4dGVuZHMgQ2F2ZVNodWZmbGUge1xuXG4gIGZpbmRBcmVuYShtZXRhOiBNZXRhbG9jYXRpb24pOiBQb3Mge1xuICAgIGZvciAoY29uc3QgcG9zIG9mIG1ldGEuYWxsUG9zKCkpIHtcbiAgICAgIGlmIChtZXRhLmdldChwb3MpLmhhc0ZlYXR1cmUoJ2FyZW5hJykpIHtcbiAgICAgICAgcmV0dXJuIHBvcztcbiAgICAgIH1cbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBuZXZlciBmb3VuZCBhcmVuYWApO1xuICB9XG5cbiAgaW5pdGlhbEZpbGwoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgY29uc3QgbWFpbiA9IHRoaXMub3JpZy5yb20ubG9jYXRpb25zLkdvYUZvcnRyZXNzX0thcm1pbmU1Lm1ldGE7XG4gICAgY29uc3QgYXJlbmEgPSB0aGlzLmZpbmRBcmVuYShtYWluKTtcbiAgICBjb25zdCBjID0gdGhpcy5wb3NUb0dyaWQoYXJlbmEsIDB4ODA4KTtcbiAgICBhLmdyaWQuc2V0KGMsICdhJyk7XG4gICAgYS5ncmlkLnNldChOKGMpLCAnYycpO1xuICAgIGEuZ3JpZC5zZXQoUyhjKSwgJ2MnKTtcbiAgICBhLmZpeGVkLmFkZChjKTtcbiAgICBhLmZpeGVkLmFkZChTKGMpKTtcbiAgICBhLmZpeGVkLmFkZChTKGMsIDIpKTtcbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICBhZGRFZGdlcyhhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBsZXQgcmV0cmllcyA9IDEwO1xuICAgIGNvbnN0IHNpemUgPSAyICsgdGhpcy5yYW5kb20ubmV4dEludCgyKTtcbiAgICB3aGlsZSAoYS5jb3VudCA8IHNpemUgJiYgcmV0cmllcykge1xuICAgICAgaWYgKCF0aGlzLnRyeUFkZChhKSkgcmV0cmllcy0tO1xuICAgIH1cbiAgICByZXR1cm4gcmV0cmllcyA/IE9LIDoge29rOiBmYWxzZSwgZmFpbDogYGFkZEVkZ2VzYH07XG4gIH1cblxuICByZWZpbmUoKSB7IHJldHVybiBPSzsgfVxuICBhZGRMYXRlRmVhdHVyZXMoKSB7IHJldHVybiBPSzsgfVxuXG4gIGluZmVyU2NyZWVucyhhOiBBKTogUmVzdWx0PE1ldGFsb2NhdGlvbj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IHN1cGVyLmluZmVyU2NyZWVucyhhKTtcbiAgICBpZiAoIXJlc3VsdC5vaykgcmV0dXJuIHJlc3VsdDtcbiAgICBjb25zdCBtZXRhID0gcmVzdWx0LnZhbHVlO1xuICAgIGNvbnN0IGFyZW5hID0gdGhpcy5maW5kQXJlbmEobWV0YSk7XG4gICAgLy8gTW92ZSB0aGUgbmVpZ2hib3JcbiAgICBjb25zdCBtYWluID0gdGhpcy5vcmlnLnJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2FybWluZTUubWV0YTtcbiAgICBtZXRhLnNldChhcmVuYSArIDB4MTAsIG1haW4uZ2V0KGFyZW5hICsgMHgxMCkpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBmaW5pc2gobmV3TWV0YTogTWV0YWxvY2F0aW9uKSB7XG4gICAgY29uc3QgbWFpbiA9IHRoaXMub3JpZy5yb20ubG9jYXRpb25zLkdvYUZvcnRyZXNzX0thcm1pbmU1Lm1ldGE7XG4gICAgY29uc3QgYXJlbmEgPSB0aGlzLmZpbmRBcmVuYShuZXdNZXRhKTtcbiAgICBzdXBlci5maW5pc2gobmV3TWV0YSk7XG4gICAgbWFpbi5zZXRFeGl0KGFyZW5hLCAnc2VhbWxlc3M6dXAnLFxuICAgICAgICAgICAgICAgICBbbmV3TWV0YS5pZCA8PCA4IHwgYXJlbmEsICdzZWFtbGVzczpkb3duJ10pO1xuICAgIC8vIE1ha2Ugc3VyZSB0aGVzZSBzaGFyZSBhIGZsYWcsIGluIGNhc2UgdGhlIG5laWdoYm9yIGlzIGEgd2FsbC5cbiAgICBuZXdNZXRhLmZyZWVGbGFncyA9IG5ldyBTZXQobWFpbi5mcmVlRmxhZ3MpO1xuICB9XG5cbiAgcmVwb3J0RmFpbHVyZSgpIHtcbiAgICAvLyBUaGlzIGlzIGZhdGFsIGJlY2F1c2Ugb2YgdGhlIHNlYW1sZXNzIGV4aXQgdGhhdCB3b24ndCB3b3JrLlxuICAgIHRocm93IG5ldyBFcnJvcihgQ29tcGxldGVseSBmYWlsZWQgdG8gc2h1ZmZsZSBLYXJtaW5lIEtlbnN1IG1hcGApO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBLYXJtaW5lQmFzZW1lbnRTaHVmZmxlIGV4dGVuZHMgQ2F2ZVNodWZmbGUge1xuICBsb29zZVJlZmluZSA9IHRydWU7XG5cbiAgcGlja1dpZHRoKCkgeyByZXR1cm4gODsgfVxuICBwaWNrSGVpZ2h0KCkgeyByZXR1cm4gNTsgfVxuXG4gIGluaXRpYWxGaWxsKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIC8vIFNldCB1cCB0aGUgYmFzaWMgZnJhbWV3b3JrOlxuICAgIC8vICAqIGEgc2luZ2xlIHJvdyBvZiBjcm9zcy1jdXR0aW5nIGNvcnJpZG9yLCB3aXRoIHRocmVlIG9mIHRoZVxuICAgIC8vICAgIGZvdXIgY29sdW1ucyBhcyBzcGlrZXMsIGFuZCBmdWxsIGNvbm5lY3Rpb25zIGFyb3VuZCB0aGVcbiAgICAvLyAgICBlZGdlcy5cbiAgICBpZiAoYS5ncmlkLmhlaWdodCAhPT0gNSB8fCBhLmdyaWQud2lkdGggIT09IDgpIHRocm93IG5ldyBFcnJvcignYmFkIHNpemUnKTtcbiAgICBHcmlkLndyaXRlR3JpZDJkKGEuZ3JpZCwgMCBhcyBHcmlkQ29vcmQsIEthcm1pbmVCYXNlbWVudFNodWZmbGUuUEFUVEVSTik7XG4gICAgYS5jb3VudCA9IDM2O1xuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGFkZFNwaWtlcyhhOiBBKTogYm9vbGVhbiB7XG4gICAgLy8gQ2hhbmdlIG9uZSBjb2x1bW4gb2Ygc3Bpa2VzIGludG8gbm9ybWFsIGNhdmUsXG4gICAgLy8gbWFyayB0aGUgcmVzdCBhcyBmaXhlZC5cbiAgICBjb25zdCBkcm9wcGVkID0gdGhpcy5yYW5kb20ubmV4dEludCg0KTtcbiAgICBmb3IgKGxldCB5ID0gMTsgeSA8IDEwOyB5KyspIHtcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgNDsgeCsrKSB7XG4gICAgICAgIGNvbnN0IGkgPSAyICogeCArIDUgKyB5ICogMTc7XG4gICAgICAgIGlmICh4ID09PSBkcm9wcGVkKSB7XG4gICAgICAgICAgYS5ncmlkLmRhdGFbaV0gPSAnYyc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgYyA9IGEuZ3JpZC5jb29yZChpIGFzIEdyaWRJbmRleCk7XG4gICAgICAgICAgYS5maXhlZC5hZGQoYyk7XG4gICAgICAgICAgaWYgKHkgPT09IDUpIHtcbiAgICAgICAgICAgIGEuZml4ZWQuYWRkKGMgKyA4IGFzIEdyaWRDb29yZCk7XG4gICAgICAgICAgICBhLmZpeGVkLmFkZChjICsgMTYgYXMgR3JpZENvb3JkKTtcbiAgICAgICAgICAgIGEuZml4ZWQuYWRkKGMgLSA4IGFzIEdyaWRDb29yZCk7XG4gICAgICAgICAgICBhLmZpeGVkLmFkZChjIC0gMTYgYXMgR3JpZENvb3JkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBOb3cgcGljayByYW5kb20gcGxhY2VzIGZvciB0aGUgc3RhaXJzLlxuICAgIGxldCBzdGFpcnMgPSAwO1xuICAgIGZvciAoY29uc3QgYyBvZiB0aGlzLnJhbmRvbS5pc2h1ZmZsZShhLmdyaWQuc2NyZWVucygpKSkge1xuICAgICAgaWYgKHN0YWlycyA9PT0gMykgYnJlYWs7XG4gICAgICBjb25zdCBtaWQgPSAoYyB8IDB4ODA4KSBhcyBHcmlkQ29vcmQ7XG4gICAgICBjb25zdCB1cCA9IChtaWQgLSAweDgwMCkgYXMgR3JpZENvb3JkO1xuICAgICAgY29uc3QgZG93biA9IChtaWQgKyAweDgwMCkgYXMgR3JpZENvb3JkO1xuICAgICAgaWYgKGEuZ3JpZC5nZXQobWlkKSA9PT0gJ2MnICYmXG4gICAgICAgICAgYS5ncmlkLmdldCh1cCkgIT09ICdzJyAmJlxuICAgICAgICAgIGEuZ3JpZC5nZXQoZG93bikgIT09ICdzJykge1xuICAgICAgICBhLmdyaWQuc2V0KG1pZCwgJzwnKTtcbiAgICAgICAgYS5maXhlZC5hZGQobWlkKTtcbiAgICAgICAgYS5ncmlkLnNldCh1cCwgJycpO1xuICAgICAgICBhLmdyaWQuc2V0KGRvd24sICcnKTtcbiAgICAgICAgc3RhaXJzKys7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTWFrZSBzdXJlIGV2ZXJ5dGhpbmcgaXMgc3RpbGwgYWNjZXNzaWJsZS5cbiAgICBjb25zdCBwYXJ0aXRpb25zID0gbmV3IFNldChhLmdyaWQucGFydGl0aW9uKCkudmFsdWVzKCkpO1xuICAgIHJldHVybiBwYXJ0aXRpb25zLnNpemUgPT09IDE7XG4gIH1cblxuICBhZGRTdGFpcnMoKSB7IHJldHVybiBPSzsgfVxuXG4gIHN0YXRpYyByZWFkb25seSBQQVRURVJOID0gW1xuICAgICcgICAgICAgICAgICAgICAgICcsXG4gICAgJyAgIGNjY2NjY2NjY2NjICAgJyxcbiAgICAnICAgYyBjIGMgYyBjIGMgICAnLFxuICAgICcgY2NjIHMgcyBzIHMgY2NjICcsXG4gICAgJyBjIGMgcyBzIHMgcyBjIGMgJyxcbiAgICAnIGNjY2NzY3Njc2NzY2NjYyAnLFxuICAgICcgYyBjIHMgcyBzIHMgYyBjICcsXG4gICAgJyBjY2MgcyBzIHMgcyBjY2MgJyxcbiAgICAnICAgYyBjIGMgYyBjIGMgICAnLFxuICAgICcgICBjY2NjY2NjY2NjYyAgICcsXG4gICAgJyAgICAgICAgICAgICAgICAgJyxcbiAgXTtcbn1cbiJdfQ==