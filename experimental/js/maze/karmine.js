import { Grid, E, S, N, W } from './grid.js';
import { OK } from '../maze/maze.js';
import { CaveShuffle } from './cave.js';
export class KarmineUpstairsShuffle extends CaveShuffle {
    constructor() {
        super(...arguments);
        this.patterns = [
            ['     ',
                ' >cc ',
                '   c ',
                '   b ',
                '   c '],
            ['     ',
                ' cc> ',
                ' c   ',
                ' b   ',
                ' c   '],
            ['   c ',
                '   b ',
                '   c ',
                ' >cc ',
                '     '],
            [' c   ',
                ' b   ',
                ' c   ',
                ' cc> ',
                '     ']
        ];
    }
    initialFill(a) {
        const pattern = this.random.pick(this.patterns);
        a.count = 3;
        const result = this.insertPattern(a, pattern, { top: 1, bottom: 1 });
        if (!result.ok)
            return result;
        this.addAllFixed(a);
        return OK;
    }
    addEdges(a) {
        let retries = 10;
        while (a.count < a.size && retries) {
            if (!this.tryAdd(a))
                retries--;
        }
        return retries ? OK : { ok: false, fail: `addEdges` };
    }
    addEarlyFeatures(a) {
        let found = false;
        for (const s of this.random.ishuffle(a.grid.screens())) {
            if (this.extract(a.grid, s) !== ' c  c  c ')
                continue;
            a.grid.set(s + 0x808, 'b');
            found = true;
            break;
        }
        if (!found)
            return { ok: false, fail: `could not add bridge` };
        return super.addStairs(a, 0, 2);
    }
    refine() { return OK; }
    addLateFeatures() { return OK; }
    addStairs() { return OK; }
}
const STAIRS = new WeakMap();
export class KarmineMainShuffle extends CaveShuffle {
    constructor() {
        super(...arguments);
        this.maxAttempts = 200;
    }
    initialFill(a) {
        const bridges = [];
        let stairDown = true;
        let stair;
        const upstairs = this.orig.rom.locations.GoaFortress_Karmine3.meta;
        for (const [pos, , [dest]] of upstairs.exits()) {
            if ((dest >>> 8) !== this.orig.id)
                continue;
            STAIRS.set(this.orig.rom.locations.GoaFortress_Karmine3, pos);
            stair = pos;
            if (!upstairs.get(pos).isEmpty()) {
                stair += 16;
                stairDown = false;
            }
            break;
        }
        if (stair == null)
            throw new Error('no stair found');
        for (const pos of upstairs.allPos()) {
            const scr = upstairs.get(pos);
            if (scr.hasFeature('overpass'))
                bridges.push(pos);
        }
        this.random.shuffle(bridges);
        let top = stair >>> 4;
        let left = stair & 0xf;
        let right = left;
        let bottom = top;
        for (const bridge of bridges) {
            const y = bridge >>> 4;
            const x = bridge & 0xf;
            top = Math.min(top, y);
            left = Math.min(left, x);
            right = Math.max(right, x);
            bottom = Math.max(bottom, y);
        }
        const height = bottom - top + 1;
        const width = right - left + 1;
        const origin = top << 4 | left;
        const outX = 1 + this.random.nextInt(a.w - width - 2);
        const outY = this.random.nextInt(a.h - height - (stairDown ? 1 : 0));
        const delta = (outY << 4 | outX) - origin;
        const stairRight = (stair & 0xf) - left < width / 2;
        stair += delta;
        for (let i = 0; i < bridges.length; i++) {
            bridges[i] += delta;
        }
        const stairTile = stairDown ? '    <  c ' : stairRight ? '    <c   ' : '   c<    ';
        if (!this.insertTile(a, bridges[0], '   cbc   ') ||
            !this.insertTile(a, bridges[1], '   cbc   ')) {
            throw new Error(`Could not insert bridge tile`);
        }
        if (!this.insertTile(a, stair, stairTile)) {
            const deltas = [-1, 1, 16, -16, 15, 17, -15, -17];
            let found = false;
            for (const ds of this.random.ishuffle(deltas)) {
                if (this.insertTile(a, stair + ds, stairTile)) {
                    stair += ds;
                    found = true;
                    break;
                }
            }
            if (!found)
                throw new Error(`Could not insert stair`);
        }
        STAIRS.set(this.orig.rom.locations.GoaFortress_Karmine5, stair);
        this.addAllFixed(a);
        a.count = 3;
        const dx = stairRight ? 1 : -1;
        const ds = stairDown ? 0x10 : dx;
        if (!bridges.includes(stair + dx) &&
            !this.tryConnect(a, this.posToGrid(stair + ds, 0x808), this.posToGrid(bridges[0] - dx, 0x808), 'c', 10)) {
            return { ok: false, fail: `could not connect stair to bridge` };
        }
        if (!this.tryConnect(a, this.posToGrid(bridges[0] + dx, 0x808), this.posToGrid(bridges[1] + dx, 0x808), 'c', 10)) {
            return { ok: false, fail: `could not connect bridges` };
        }
        return OK;
    }
    addEdges(a) {
        let attempts = 100;
        while (a.count < a.size - 4 && attempts) {
            if (!this.tryAdd(a))
                attempts--;
        }
        return attempts ? OK : { ok: false, fail: `could not populate` };
    }
    refine() { return OK; }
    refineEdges() { return true; }
    addUnderpasses() { return true; }
    addArenas(a) {
        for (const s of this.random.ishuffle(a.grid.screens())) {
            if (!(s & 0xf000))
                continue;
            const c = s + 0x808;
            if (a.fixed.has(c) || a.grid.get(c))
                continue;
            if (a.grid.get(W(c, 2)) || a.grid.get(E(c, 2)))
                continue;
            if (a.grid.get(S(c, 2)) !== 'c')
                continue;
            if (!this.canSetAll(a, new Map([[S(c), 'c'], [c, 'a'],
                [N(c), 'c'], [N(c, 2), 'c']]))) {
                continue;
            }
            a.grid.set(S(c), 'c');
            a.grid.set(c, 'a');
            a.grid.set(N(c), 'c');
            a.fixed.add(c);
            a.fixed.add(N(c, 2));
            return true;
        }
        return false;
    }
    addStairs(a, up = 0, down = 0) {
        return super.addStairs(a, up - 1, down);
    }
    finish(newMeta) {
        for (const [pos, type] of this.orig.exits()) {
            if (type.startsWith('seamless'))
                this.orig.deleteExit(pos, type);
        }
        super.finish(newMeta);
        const upperMeta = this.orig.rom.locations.GoaFortress_Karmine3.meta;
        const upperPos = STAIRS.get(this.orig.rom.locations.GoaFortress_Karmine3);
        const mainPos = STAIRS.get(this.orig.rom.locations.GoaFortress_Karmine5);
        if (upperPos != null && mainPos != null) {
            newMeta.attach(mainPos, upperMeta, upperPos, 'stair:up', 'stair:down');
        }
    }
}
export class KarmineKensuShuffle extends CaveShuffle {
    findArena(meta) {
        for (const pos of meta.allPos()) {
            if (meta.get(pos).hasFeature('arena')) {
                return pos;
            }
        }
        throw new Error(`never found arena`);
    }
    initialFill(a) {
        const main = this.orig.rom.locations.GoaFortress_Karmine5.meta;
        const arena = this.findArena(main);
        const c = this.posToGrid(arena, 0x808);
        a.grid.set(c, 'a');
        a.grid.set(N(c), 'c');
        a.grid.set(S(c), 'c');
        a.fixed.add(c);
        a.fixed.add(S(c));
        a.fixed.add(S(c, 2));
        return OK;
    }
    addEdges(a) {
        let retries = 10;
        const size = 2 + this.random.nextInt(2);
        while (a.count < size && retries) {
            if (!this.tryAdd(a))
                retries--;
        }
        return retries ? OK : { ok: false, fail: `addEdges` };
    }
    refine() { return OK; }
    addLateFeatures() { return OK; }
    inferScreens(a) {
        const result = super.inferScreens(a);
        if (!result.ok)
            return result;
        const meta = result.value;
        const arena = this.findArena(meta);
        const main = this.orig.rom.locations.GoaFortress_Karmine5.meta;
        meta.set(arena + 0x10, main.get(arena + 0x10));
        return result;
    }
    finish(newMeta) {
        const main = this.orig.rom.locations.GoaFortress_Karmine5.meta;
        const arena = this.findArena(newMeta);
        super.finish(newMeta);
        main.setExit(arena, 'seamless:up', [newMeta.id << 8 | arena, 'seamless:down']);
        newMeta.freeFlags = new Set(main.freeFlags);
    }
    reportFailure() {
        throw new Error(`Completely failed to shuffle Karmine Kensu map`);
    }
}
export class KarmineBasementShuffle extends CaveShuffle {
    constructor() {
        super(...arguments);
        this.looseRefine = true;
    }
    pickWidth() { return 8; }
    pickHeight() { return 5; }
    initialFill(a) {
        if (a.grid.height !== 5 || a.grid.width !== 8)
            throw new Error('bad size');
        Grid.writeGrid2d(a.grid, 0, KarmineBasementShuffle.PATTERN);
        a.count = 36;
        return OK;
    }
    addSpikes(a) {
        const dropped = this.random.nextInt(4);
        for (let y = 1; y < 10; y++) {
            for (let x = 0; x < 4; x++) {
                const i = 2 * x + 5 + y * 17;
                if (x === dropped) {
                    a.grid.data[i] = 'c';
                }
                else {
                    const c = a.grid.coord(i);
                    a.fixed.add(c);
                    if (y === 5) {
                        a.fixed.add(c + 8);
                        a.fixed.add(c + 16);
                        a.fixed.add(c - 8);
                        a.fixed.add(c - 16);
                    }
                }
            }
        }
        let stairs = 0;
        for (const c of this.random.ishuffle(a.grid.screens())) {
            if (stairs === 3)
                break;
            const mid = (c | 0x808);
            const up = (mid - 0x800);
            const down = (mid + 0x800);
            if (a.grid.get(mid) === 'c' &&
                a.grid.get(up) !== 's' &&
                a.grid.get(down) !== 's') {
                a.grid.set(mid, '<');
                a.fixed.add(mid);
                a.grid.set(up, '');
                a.grid.set(down, '');
                stairs++;
            }
        }
        const partitions = new Set(a.grid.partition().values());
        return partitions.size === 1;
    }
    addStairs() { return OK; }
}
KarmineBasementShuffle.PATTERN = [
    '                 ',
    '   ccccccccccc   ',
    '   c c c c c c   ',
    ' ccc s s s s ccc ',
    ' c c s s s s c c ',
    ' ccccscscscscccc ',
    ' c c s s s s c c ',
    ' ccc s s s s ccc ',
    '   c c c c c c   ',
    '   ccccccccccc   ',
    '                 ',
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2FybWluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9tYXplL2thcm1pbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBd0IsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25FLE9BQU8sRUFBVSxFQUFFLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQXNCLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQWE1RCxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsV0FBVztJQUF2RDs7UUFDVyxhQUFRLEdBQUc7WUFDbEIsQ0FBQyxPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxPQUFPO2dCQUNQLE9BQU8sQ0FBQztZQUNULENBQUMsT0FBTztnQkFDUCxPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxPQUFPLENBQUM7WUFDVCxDQUFDLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsT0FBTyxDQUFDO1lBQ1QsQ0FBQyxPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxPQUFPO2dCQUNQLE9BQU8sQ0FBQztTQUFDLENBQUM7SUFtQ2YsQ0FBQztJQWpDQyxXQUFXLENBQUMsQ0FBSTtRQUNkLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoRCxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNaLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxFQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBQyxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQUUs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QUM7Z0JBQ2pCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDbkIsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUNyQixNQUFNLEVBQUUsQ0FBQzthQUNWO1NBQ0Y7UUFHRCxNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDeEQsT0FBTyxVQUFVLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsU0FBUyxLQUFLLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQzs7QUFFViw4QkFBTyxHQUFHO0lBQ3hCLG1CQUFtQjtJQUNuQixtQkFBbUI7SUFDbkIsbUJBQW1CO0lBQ25CLG1CQUFtQjtJQUNuQixtQkFBbUI7SUFDbkIsbUJBQW1CO0lBQ25CLG1CQUFtQjtJQUNuQixtQkFBbUI7SUFDbkIsbUJBQW1CO0lBQ25CLG1CQUFtQjtJQUNuQixtQkFBbUI7Q0FDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdyaWQsIEdyaWRDb29yZCwgR3JpZEluZGV4LCBFLCBTLCBOLCBXIH0gZnJvbSAnLi9ncmlkLmpzJztcbmltcG9ydCB7IFJlc3VsdCwgT0sgfSBmcm9tICcuLi9tYXplL21hemUuanMnO1xuaW1wb3J0IHsgQ2F2ZVNodWZmbGVBdHRlbXB0LCBDYXZlU2h1ZmZsZSB9IGZyb20gJy4vY2F2ZS5qcyc7XG5pbXBvcnQgeyBQb3MsIE1ldGFsb2NhdGlvbiB9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuXG50eXBlIEEgPSBDYXZlU2h1ZmZsZUF0dGVtcHQ7XG5cbi8vIEJhc2ljIHBsYW46IHRoaXMgaXMgc2ltcGxlIGVub3VnaCB0aGF0IHdlIF9zaG91bGRfIGJlIGFibGUgdG8gd29ya1xuLy8gd2l0aCB3aGF0ZXZlciBoYXBwZW5zLiAgRG8gdGhlIHNodWZmbGUgb25jZSBhbmQgdGhlbiBuZXZlciBsb29rIGJhY2suXG4vLyBIT1dFVkVSLCBpdCB3b3VsZCBiZSBuaWNlIGlmIHRoZXJlIHdlcmUgYSB3YXkgdG8gZG8gdGhpcyBtb3JlXG4vLyBnZW5lcmFsbHkgYW5kIGF1dG9tYXRpY2FsbHkgZm9yY2UgYSByZXRyeSBhZnRlciBzb21lIGFtb3VudCBvZiB0aW1lLlxuLy8gSWRlYWxseSwgd2UgZGVjb3VwbGUgX2FsbF8gdGhlIGZpbmlzaGVzIGZyb20gX2FsbF8gdGhlIHNodWZmbGVzIGFuZFxuLy8gcmV0YWluIHRoZSBncmlkIGFuZCBtZXRhc2NyZWVucyBhcyBhY2Nlc3NpYmxlIGJ5IGFsbCBsYXRlciBzaHVmZmxlcyxcbi8vIGFsbG93aW5nIGZvciBjb25uZWN0ZWQgcmV0cmllcyBhcyBuZWVkZWQuICBCdXQgZm9yIG5vdyB0aGlzIHdpbGwgZG8uXG5leHBvcnQgY2xhc3MgS2FybWluZVVwc3RhaXJzU2h1ZmZsZSBleHRlbmRzIENhdmVTaHVmZmxlIHtcbiAgcmVhZG9ubHkgcGF0dGVybnMgPSBbXG4gICAgWycgICAgICcsXG4gICAgICcgPmNjICcsXG4gICAgICcgICBjICcsXG4gICAgICcgICBiICcsXG4gICAgICcgICBjICddLFxuICAgIFsnICAgICAnLFxuICAgICAnIGNjPiAnLFxuICAgICAnIGMgICAnLFxuICAgICAnIGIgICAnLFxuICAgICAnIGMgICAnXSxcbiAgICBbJyAgIGMgJyxcbiAgICAgJyAgIGIgJyxcbiAgICAgJyAgIGMgJyxcbiAgICAgJyA+Y2MgJyxcbiAgICAgJyAgICAgJ10sXG4gICAgWycgYyAgICcsXG4gICAgICcgYiAgICcsXG4gICAgICcgYyAgICcsXG4gICAgICcgY2M+ICcsXG4gICAgICcgICAgICddXTtcblxuICBpbml0aWFsRmlsbChhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBjb25zdCBwYXR0ZXJuID0gdGhpcy5yYW5kb20ucGljayh0aGlzLnBhdHRlcm5zKTtcbiAgICBhLmNvdW50ID0gMztcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmluc2VydFBhdHRlcm4oYSwgcGF0dGVybiwge3RvcDogMSwgYm90dG9tOiAxfSk7XG4gICAgaWYgKCFyZXN1bHQub2spIHJldHVybiByZXN1bHQ7XG4gICAgdGhpcy5hZGRBbGxGaXhlZChhKTtcbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICBhZGRFZGdlcyhhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBsZXQgcmV0cmllcyA9IDEwO1xuICAgIHdoaWxlIChhLmNvdW50IDwgYS5zaXplICYmIHJldHJpZXMpIHtcbiAgICAgIGlmICghdGhpcy50cnlBZGQoYSkpIHJldHJpZXMtLTtcbiAgICB9XG4gICAgcmV0dXJuIHJldHJpZXMgPyBPSyA6IHtvazogZmFsc2UsIGZhaWw6IGBhZGRFZGdlc2B9O1xuICB9XG5cbiAgYWRkRWFybHlGZWF0dXJlcyhhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBMb29rIGZvciBhIE4tUyBoYWxsd2F5IHRvIGFkZCBhIGJyaWRnZS5cbiAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5yYW5kb20uaXNodWZmbGUoYS5ncmlkLnNjcmVlbnMoKSkpIHtcbiAgICAgIGlmICh0aGlzLmV4dHJhY3QoYS5ncmlkLCBzKSAhPT0gJyBjICBjICBjICcpIGNvbnRpbnVlO1xuICAgICAgYS5ncmlkLnNldChzICsgMHg4MDggYXMgR3JpZENvb3JkLCAnYicpO1xuICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGlmICghZm91bmQpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgY291bGQgbm90IGFkZCBicmlkZ2VgfTtcbiAgICByZXR1cm4gc3VwZXIuYWRkU3RhaXJzKGEsIDAsIDIpO1xuICB9XG5cbiAgcmVmaW5lKCkgeyByZXR1cm4gT0s7IH1cbiAgYWRkTGF0ZUZlYXR1cmVzKCkgeyByZXR1cm4gT0s7IH1cbiAgYWRkU3RhaXJzKCkgeyByZXR1cm4gT0s7IH1cbn1cblxuY29uc3QgU1RBSVJTID0gbmV3IFdlYWtNYXA8TG9jYXRpb24sIFBvcz4oKTtcblxuZXhwb3J0IGNsYXNzIEthcm1pbmVNYWluU2h1ZmZsZSBleHRlbmRzIENhdmVTaHVmZmxlIHtcblxuICBtYXhBdHRlbXB0cyA9IDIwMDtcblxuICBpbml0aWFsRmlsbChhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBGaW5kIHRoZSBzdGFpciBmcm9tIFVwc3RhaXJzLCBjb3B5IHRoZSBicmlkZ2VzIG92ZXIuXG4gICAgY29uc3QgYnJpZGdlczogUG9zW10gPSBbXTtcbiAgICBsZXQgc3RhaXJEb3duID0gdHJ1ZTtcbiAgICBsZXQgc3RhaXI6IFBvc3x1bmRlZmluZWQ7XG4gICAgY29uc3QgdXBzdGFpcnMgPSB0aGlzLm9yaWcucm9tLmxvY2F0aW9ucy5Hb2FGb3J0cmVzc19LYXJtaW5lMy5tZXRhO1xuICAgIGZvciAoY29uc3QgW3BvcywsIFtkZXN0XV0gb2YgdXBzdGFpcnMuZXhpdHMoKSkge1xuICAgICAgaWYgKChkZXN0ID4+PiA4KSAhPT0gdGhpcy5vcmlnLmlkKSBjb250aW51ZTtcbiAgICAgIFNUQUlSUy5zZXQodGhpcy5vcmlnLnJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2FybWluZTMsIHBvcyk7XG4gICAgICBzdGFpciA9IHBvcztcbiAgICAgIC8vIE9mZnNldCBpZiBpdCdzIG5vdCB0aGUgc2luZ2xlLXRpbGUgdXAtZG93biBzdGFpcnMuXG4gICAgICBpZiAoIXVwc3RhaXJzLmdldChwb3MpLmlzRW1wdHkoKSkge1xuICAgICAgICBzdGFpciArPSAxNjtcbiAgICAgICAgc3RhaXJEb3duID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgaWYgKHN0YWlyID09IG51bGwpIHRocm93IG5ldyBFcnJvcignbm8gc3RhaXIgZm91bmQnKTtcbiAgICBmb3IgKGNvbnN0IHBvcyBvZiB1cHN0YWlycy5hbGxQb3MoKSkge1xuICAgICAgY29uc3Qgc2NyID0gdXBzdGFpcnMuZ2V0KHBvcyk7XG4gICAgICBpZiAoc2NyLmhhc0ZlYXR1cmUoJ292ZXJwYXNzJykpIGJyaWRnZXMucHVzaChwb3MpO1xuICAgIH1cbiAgICB0aGlzLnJhbmRvbS5zaHVmZmxlKGJyaWRnZXMpO1xuXG4gICAgLy8gUmVsYXRpdml6ZVxuICAgIGxldCB0b3AgPSBzdGFpciA+Pj4gNDtcbiAgICBsZXQgbGVmdCA9IHN0YWlyICYgMHhmO1xuICAgIGxldCByaWdodCA9IGxlZnQ7XG4gICAgbGV0IGJvdHRvbSA9IHRvcDtcbiAgICBmb3IgKGNvbnN0IGJyaWRnZSBvZiBicmlkZ2VzKSB7XG4gICAgICBjb25zdCB5ID0gYnJpZGdlID4+PiA0O1xuICAgICAgY29uc3QgeCA9IGJyaWRnZSAmIDB4ZjtcbiAgICAgIHRvcCA9IE1hdGgubWluKHRvcCwgeSk7XG4gICAgICBsZWZ0ID0gTWF0aC5taW4obGVmdCwgeCk7XG4gICAgICByaWdodCA9IE1hdGgubWF4KHJpZ2h0LCB4KTtcbiAgICAgIGJvdHRvbSA9IE1hdGgubWF4KGJvdHRvbSwgeSk7XG4gICAgfVxuICAgIGNvbnN0IGhlaWdodCA9IGJvdHRvbSAtIHRvcCArIDE7XG4gICAgY29uc3Qgd2lkdGggPSByaWdodCAtIGxlZnQgKyAxO1xuICAgIGNvbnN0IG9yaWdpbiA9IHRvcCA8PCA0IHwgbGVmdDtcblxuICAgIC8vIFBsYWNlIHRoZSBicmlkZ2VzIGFuZCBzdGFpciBpbiBhIHJhbmRvbSBsb2NhdGlvbi5cbiAgICBjb25zdCBvdXRYID0gMSArIHRoaXMucmFuZG9tLm5leHRJbnQoYS53IC0gd2lkdGggLSAyKTtcbiAgICBjb25zdCBvdXRZID0gdGhpcy5yYW5kb20ubmV4dEludChhLmggLSBoZWlnaHQgLSAoc3RhaXJEb3duID8gMSA6IDApKTtcbiAgICBjb25zdCBkZWx0YSA9IChvdXRZIDw8IDQgfCBvdXRYKSAtIG9yaWdpbjtcbiAgICBjb25zdCBzdGFpclJpZ2h0ID0gKHN0YWlyICYgMHhmKSAtIGxlZnQgPCB3aWR0aCAvIDI7XG4gICAgc3RhaXIgKz0gZGVsdGE7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBicmlkZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBicmlkZ2VzW2ldICs9IGRlbHRhO1xuICAgIH1cbiAgICBjb25zdCBzdGFpclRpbGUgPVxuICAgICAgICBzdGFpckRvd24gPyAnICAgIDwgIGMgJyA6IHN0YWlyUmlnaHQgPyAnICAgIDxjICAgJyA6ICcgICBjPCAgICAnO1xuICAgIGlmICghdGhpcy5pbnNlcnRUaWxlKGEsIGJyaWRnZXNbMF0sICcgICBjYmMgICAnKSB8fFxuICAgICAgICAhdGhpcy5pbnNlcnRUaWxlKGEsIGJyaWRnZXNbMV0sICcgICBjYmMgICAnKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgaW5zZXJ0IGJyaWRnZSB0aWxlYCk7XG4gICAgfVxuICAgIC8vIFByb2JsZW06IGl0J3MgcG9zc2libGUgdGhlIHN0YWlyIGRvZXNuJ3QgZml0LiAgSWYgdGhhdCdzIHRoZSBjYXNlLFxuICAgIC8vIGdpdmUgdXAgYW5kIHRyeSBqdXN0IG1vdmluZyBpdCBzb21ld2hlcmUgZWxzZS4gIElkZWFsbHkgd2UnZCBpbnN0ZWFkXG4gICAgLy8ganVzdCBpbml0aWF0ZSBhIHJldHJ5IG9uIHRoZSBkZXBlbmRlbnQgbGV2ZWwsIGJ1dCB0aGF0IHN0cnVjdHVyZVxuICAgIC8vIGlzIG5vdCB5ZXQgaW4gcGxhY2UuLi5cbiAgICBpZiAoIXRoaXMuaW5zZXJ0VGlsZShhLCBzdGFpciwgc3RhaXJUaWxlKSkge1xuICAgICAgY29uc3QgZGVsdGFzID0gWy0xLCAxLCAxNiwgLTE2LCAxNSwgMTcsIC0xNSwgLTE3XTtcbiAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgICAgZm9yIChjb25zdCBkcyBvZiB0aGlzLnJhbmRvbS5pc2h1ZmZsZShkZWx0YXMpKSB7XG4gICAgICAgIGlmICh0aGlzLmluc2VydFRpbGUoYSwgc3RhaXIgKyBkcywgc3RhaXJUaWxlKSkge1xuICAgICAgICAgIHN0YWlyICs9IGRzO1xuICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFmb3VuZCkgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgaW5zZXJ0IHN0YWlyYCk7XG4gICAgfVxuICAgIFNUQUlSUy5zZXQodGhpcy5vcmlnLnJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2FybWluZTUsIHN0YWlyKTtcbiAgICAvLyBhLmZpeGVkLmFkZCh0aGlzLnBvc1RvR3JpZChzdGFpciwgMHg4MDgpKTtcbiAgICAvLyBhLmZpeGVkLmFkZCh0aGlzLnBvc1RvR3JpZChicmlkZ2VzWzBdLCAweDgwOCkpO1xuICAgIC8vIGEuZml4ZWQuYWRkKHRoaXMucG9zVG9HcmlkKGJyaWRnZXNbMV0sIDB4ODA4KSk7XG4gICAgdGhpcy5hZGRBbGxGaXhlZChhKTtcbiAgICBhLmNvdW50ID0gMztcblxuICAgIGNvbnN0IGR4ID0gc3RhaXJSaWdodCA/IDEgOiAtMTtcbiAgICBjb25zdCBkcyA9IHN0YWlyRG93biA/IDB4MTAgOiBkeDtcbiAgICBpZiAoIWJyaWRnZXMuaW5jbHVkZXMoc3RhaXIgKyBkeCkgJiZcbiAgICAgICAgIXRoaXMudHJ5Q29ubmVjdChhLCB0aGlzLnBvc1RvR3JpZChzdGFpciArIGRzLCAweDgwOCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NUb0dyaWQoYnJpZGdlc1swXSAtIGR4LCAweDgwOCksICdjJywgMTApKSB7XG4gICAgICByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGNvdWxkIG5vdCBjb25uZWN0IHN0YWlyIHRvIGJyaWRnZWB9O1xuICAgIH1cbiAgICBpZiAoIXRoaXMudHJ5Q29ubmVjdChhLCB0aGlzLnBvc1RvR3JpZChicmlkZ2VzWzBdICsgZHgsIDB4ODA4KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc1RvR3JpZChicmlkZ2VzWzFdICsgZHgsIDB4ODA4KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAnYycsIDEwKSkge1xuICAgICAgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBjb3VsZCBub3QgY29ubmVjdCBicmlkZ2VzYH07XG4gICAgfVxuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGFkZEVkZ2VzKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGxldCBhdHRlbXB0cyA9IDEwMDtcbiAgICB3aGlsZSAoYS5jb3VudCA8IGEuc2l6ZSAtIDQgJiYgYXR0ZW1wdHMpIHtcbiAgICAgIGlmICghdGhpcy50cnlBZGQoYSkpIGF0dGVtcHRzLS07XG4gICAgfVxuICAgIHJldHVybiBhdHRlbXB0cyA/IE9LIDoge29rOiBmYWxzZSwgZmFpbDogYGNvdWxkIG5vdCBwb3B1bGF0ZWB9O1xuICB9XG5cbiAgcmVmaW5lKCkgeyByZXR1cm4gT0s7IH1cbiAgcmVmaW5lRWRnZXMoKSB7IHJldHVybiB0cnVlOyB9XG4gIGFkZFVuZGVycGFzc2VzKCkgeyByZXR1cm4gdHJ1ZTsgfVxuXG4gIGFkZEFyZW5hcyhhOiBBKTogYm9vbGVhbiB7XG4gICAgLy8gVHJ5IHRvIGFkZCBrZW5zdSdzIGFyZW5hLiAgTG9vayBmb3IgYSBwbGFjZSB3ZSBjYW4gYWRkICcgYyB8IGEgfCBjICcuXG4gICAgLy8gRG9uJ3QgYm90aGVyIGFkZGluZyB0aGUgc3RhaXIgb24gdGhlIG90aGVyIHNpZGUsIHNpbmNlIGl0IGRvZXNuJ3RcbiAgICAvLyBhY3R1YWxseSBtYXR0ZXIgaGVyZS4gIEJ1dCB0byBtYWtlIHRoZSBzZWFtbGVzcyB3b3JrLCB3ZSBkbyBuZWVkIHRvXG4gICAgLy8gaGF2ZSBfc3BhY2VfIGZvciBpdC5cbiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5yYW5kb20uaXNodWZmbGUoYS5ncmlkLnNjcmVlbnMoKSkpIHtcbiAgICAgIGlmICghKHMgJiAweGYwMDApKSBjb250aW51ZTsgLy8gdG9wIHJvdyBub3QgYWxsb3dlZFxuICAgICAgY29uc3QgYyA9IHMgKyAweDgwOCBhcyBHcmlkQ29vcmQ7XG4gICAgICBpZiAoYS5maXhlZC5oYXMoYykgfHwgYS5ncmlkLmdldChjKSkgY29udGludWU7XG4gICAgICBpZiAoYS5ncmlkLmdldChXKGMsIDIpKSB8fCBhLmdyaWQuZ2V0KEUoYywgMikpKSBjb250aW51ZTtcbiAgICAgIGlmIChhLmdyaWQuZ2V0KFMoYywgMikpICE9PSAnYycpIGNvbnRpbnVlO1xuICAgICAgaWYgKCF0aGlzLmNhblNldEFsbChhLCBuZXcgTWFwKFtbUyhjKSwgJ2MnXSwgW2MsICdhJ10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtOKGMpLCAnYyddLCBbTihjLCAyKSwgJ2MnXV0pKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIC8vIEFkZCB0aGUgYXJlbmEgd2l0aCBhIGRlYWQgZW5kLlxuICAgICAgYS5ncmlkLnNldChTKGMpLCAnYycpO1xuICAgICAgYS5ncmlkLnNldChjLCAnYScpO1xuICAgICAgYS5ncmlkLnNldChOKGMpLCAnYycpO1xuICAgICAgLy9hLmdyaWQuc2V0KE4oYywgMiksICdjJyk7XG4gICAgICBhLmZpeGVkLmFkZChjKTtcbiAgICAgIGEuZml4ZWQuYWRkKE4oYywgMikpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFkZFN0YWlycyhhOiBBLCB1cCA9IDAsIGRvd24gPSAwKSB7XG4gICAgcmV0dXJuIHN1cGVyLmFkZFN0YWlycyhhLCB1cCAtIDEsIGRvd24pO1xuICB9XG5cbiAgZmluaXNoKG5ld01ldGE6IE1ldGFsb2NhdGlvbikge1xuICAgIC8vIFRoZSBzZWFtbGVzcyBleGl0IGlzIHByb2JsZW1hdGljIGJlZm9yZSB0aGUgb3RoZXIgc2lkZSBtb3Zlcy5cbiAgICAvLyBTbyBkZWxldGUgaXQgZm9yIG5vdywgYW5kIGFkZCBpdCBiYWNrIGxhdGVyLlxuICAgIGZvciAoY29uc3QgW3BvcywgdHlwZV0gb2YgdGhpcy5vcmlnLmV4aXRzKCkpIHtcbiAgICAgIGlmICh0eXBlLnN0YXJ0c1dpdGgoJ3NlYW1sZXNzJykpIHRoaXMub3JpZy5kZWxldGVFeGl0KHBvcywgdHlwZSk7XG4gICAgfVxuICAgIHN1cGVyLmZpbmlzaChuZXdNZXRhKTtcbiAgICAvLyBNYWtlIHN1cmUgdGhlIHJpZ2h0IHN0YWlycyBjb25uZWN0IHRvIHRoZSB1cHBlciBmbG9vci5cbiAgICBjb25zdCB1cHBlck1ldGEgPSB0aGlzLm9yaWcucm9tLmxvY2F0aW9ucy5Hb2FGb3J0cmVzc19LYXJtaW5lMy5tZXRhO1xuICAgIGNvbnN0IHVwcGVyUG9zID0gU1RBSVJTLmdldCh0aGlzLm9yaWcucm9tLmxvY2F0aW9ucy5Hb2FGb3J0cmVzc19LYXJtaW5lMyk7XG4gICAgY29uc3QgbWFpblBvcyA9IFNUQUlSUy5nZXQodGhpcy5vcmlnLnJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2FybWluZTUpO1xuICAgIGlmICh1cHBlclBvcyAhPSBudWxsICYmIG1haW5Qb3MgIT0gbnVsbCkge1xuICAgICAgbmV3TWV0YS5hdHRhY2gobWFpblBvcywgdXBwZXJNZXRhLCB1cHBlclBvcywgJ3N0YWlyOnVwJywgJ3N0YWlyOmRvd24nKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEthcm1pbmVLZW5zdVNodWZmbGUgZXh0ZW5kcyBDYXZlU2h1ZmZsZSB7XG5cbiAgZmluZEFyZW5hKG1ldGE6IE1ldGFsb2NhdGlvbik6IFBvcyB7XG4gICAgZm9yIChjb25zdCBwb3Mgb2YgbWV0YS5hbGxQb3MoKSkge1xuICAgICAgaWYgKG1ldGEuZ2V0KHBvcykuaGFzRmVhdHVyZSgnYXJlbmEnKSkge1xuICAgICAgICByZXR1cm4gcG9zO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYG5ldmVyIGZvdW5kIGFyZW5hYCk7XG4gIH1cblxuICBpbml0aWFsRmlsbChhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBjb25zdCBtYWluID0gdGhpcy5vcmlnLnJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2FybWluZTUubWV0YTtcbiAgICBjb25zdCBhcmVuYSA9IHRoaXMuZmluZEFyZW5hKG1haW4pO1xuICAgIGNvbnN0IGMgPSB0aGlzLnBvc1RvR3JpZChhcmVuYSwgMHg4MDgpO1xuICAgIGEuZ3JpZC5zZXQoYywgJ2EnKTtcbiAgICBhLmdyaWQuc2V0KE4oYyksICdjJyk7XG4gICAgYS5ncmlkLnNldChTKGMpLCAnYycpO1xuICAgIGEuZml4ZWQuYWRkKGMpO1xuICAgIGEuZml4ZWQuYWRkKFMoYykpO1xuICAgIGEuZml4ZWQuYWRkKFMoYywgMikpO1xuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGFkZEVkZ2VzKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGxldCByZXRyaWVzID0gMTA7XG4gICAgY29uc3Qgc2l6ZSA9IDIgKyB0aGlzLnJhbmRvbS5uZXh0SW50KDIpO1xuICAgIHdoaWxlIChhLmNvdW50IDwgc2l6ZSAmJiByZXRyaWVzKSB7XG4gICAgICBpZiAoIXRoaXMudHJ5QWRkKGEpKSByZXRyaWVzLS07XG4gICAgfVxuICAgIHJldHVybiByZXRyaWVzID8gT0sgOiB7b2s6IGZhbHNlLCBmYWlsOiBgYWRkRWRnZXNgfTtcbiAgfVxuXG4gIHJlZmluZSgpIHsgcmV0dXJuIE9LOyB9XG4gIGFkZExhdGVGZWF0dXJlcygpIHsgcmV0dXJuIE9LOyB9XG5cbiAgaW5mZXJTY3JlZW5zKGE6IEEpOiBSZXN1bHQ8TWV0YWxvY2F0aW9uPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gc3VwZXIuaW5mZXJTY3JlZW5zKGEpO1xuICAgIGlmICghcmVzdWx0Lm9rKSByZXR1cm4gcmVzdWx0O1xuICAgIGNvbnN0IG1ldGEgPSByZXN1bHQudmFsdWU7XG4gICAgY29uc3QgYXJlbmEgPSB0aGlzLmZpbmRBcmVuYShtZXRhKTtcbiAgICAvLyBNb3ZlIHRoZSBuZWlnaGJvclxuICAgIGNvbnN0IG1haW4gPSB0aGlzLm9yaWcucm9tLmxvY2F0aW9ucy5Hb2FGb3J0cmVzc19LYXJtaW5lNS5tZXRhO1xuICAgIG1ldGEuc2V0KGFyZW5hICsgMHgxMCwgbWFpbi5nZXQoYXJlbmEgKyAweDEwKSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGZpbmlzaChuZXdNZXRhOiBNZXRhbG9jYXRpb24pIHtcbiAgICBjb25zdCBtYWluID0gdGhpcy5vcmlnLnJvbS5sb2NhdGlvbnMuR29hRm9ydHJlc3NfS2FybWluZTUubWV0YTtcbiAgICBjb25zdCBhcmVuYSA9IHRoaXMuZmluZEFyZW5hKG5ld01ldGEpO1xuICAgIHN1cGVyLmZpbmlzaChuZXdNZXRhKTtcbiAgICBtYWluLnNldEV4aXQoYXJlbmEsICdzZWFtbGVzczp1cCcsXG4gICAgICAgICAgICAgICAgIFtuZXdNZXRhLmlkIDw8IDggfCBhcmVuYSwgJ3NlYW1sZXNzOmRvd24nXSk7XG4gICAgLy8gTWFrZSBzdXJlIHRoZXNlIHNoYXJlIGEgZmxhZywgaW4gY2FzZSB0aGUgbmVpZ2hib3IgaXMgYSB3YWxsLlxuICAgIG5ld01ldGEuZnJlZUZsYWdzID0gbmV3IFNldChtYWluLmZyZWVGbGFncyk7XG4gIH1cblxuICByZXBvcnRGYWlsdXJlKCkge1xuICAgIC8vIFRoaXMgaXMgZmF0YWwgYmVjYXVzZSBvZiB0aGUgc2VhbWxlc3MgZXhpdCB0aGF0IHdvbid0IHdvcmsuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb21wbGV0ZWx5IGZhaWxlZCB0byBzaHVmZmxlIEthcm1pbmUgS2Vuc3UgbWFwYCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEthcm1pbmVCYXNlbWVudFNodWZmbGUgZXh0ZW5kcyBDYXZlU2h1ZmZsZSB7XG4gIGxvb3NlUmVmaW5lID0gdHJ1ZTtcblxuICBwaWNrV2lkdGgoKSB7IHJldHVybiA4OyB9XG4gIHBpY2tIZWlnaHQoKSB7IHJldHVybiA1OyB9XG5cbiAgaW5pdGlhbEZpbGwoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgLy8gU2V0IHVwIHRoZSBiYXNpYyBmcmFtZXdvcms6XG4gICAgLy8gICogYSBzaW5nbGUgcm93IG9mIGNyb3NzLWN1dHRpbmcgY29ycmlkb3IsIHdpdGggdGhyZWUgb2YgdGhlXG4gICAgLy8gICAgZm91ciBjb2x1bW5zIGFzIHNwaWtlcywgYW5kIGZ1bGwgY29ubmVjdGlvbnMgYXJvdW5kIHRoZVxuICAgIC8vICAgIGVkZ2VzLlxuICAgIGlmIChhLmdyaWQuaGVpZ2h0ICE9PSA1IHx8IGEuZ3JpZC53aWR0aCAhPT0gOCkgdGhyb3cgbmV3IEVycm9yKCdiYWQgc2l6ZScpO1xuICAgIEdyaWQud3JpdGVHcmlkMmQoYS5ncmlkLCAwIGFzIEdyaWRDb29yZCwgS2FybWluZUJhc2VtZW50U2h1ZmZsZS5QQVRURVJOKTtcbiAgICBhLmNvdW50ID0gMzY7XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgYWRkU3Bpa2VzKGE6IEEpOiBib29sZWFuIHtcbiAgICAvLyBDaGFuZ2Ugb25lIGNvbHVtbiBvZiBzcGlrZXMgaW50byBub3JtYWwgY2F2ZSxcbiAgICAvLyBtYXJrIHRoZSByZXN0IGFzIGZpeGVkLlxuICAgIGNvbnN0IGRyb3BwZWQgPSB0aGlzLnJhbmRvbS5uZXh0SW50KDQpO1xuICAgIGZvciAobGV0IHkgPSAxOyB5IDwgMTA7IHkrKykge1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCA0OyB4KyspIHtcbiAgICAgICAgY29uc3QgaSA9IDIgKiB4ICsgNSArIHkgKiAxNztcbiAgICAgICAgaWYgKHggPT09IGRyb3BwZWQpIHtcbiAgICAgICAgICBhLmdyaWQuZGF0YVtpXSA9ICdjJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBjID0gYS5ncmlkLmNvb3JkKGkgYXMgR3JpZEluZGV4KTtcbiAgICAgICAgICBhLmZpeGVkLmFkZChjKTtcbiAgICAgICAgICBpZiAoeSA9PT0gNSkge1xuICAgICAgICAgICAgYS5maXhlZC5hZGQoYyArIDggYXMgR3JpZENvb3JkKTtcbiAgICAgICAgICAgIGEuZml4ZWQuYWRkKGMgKyAxNiBhcyBHcmlkQ29vcmQpO1xuICAgICAgICAgICAgYS5maXhlZC5hZGQoYyAtIDggYXMgR3JpZENvb3JkKTtcbiAgICAgICAgICAgIGEuZml4ZWQuYWRkKGMgLSAxNiBhcyBHcmlkQ29vcmQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdyBwaWNrIHJhbmRvbSBwbGFjZXMgZm9yIHRoZSBzdGFpcnMuXG4gICAgbGV0IHN0YWlycyA9IDA7XG4gICAgZm9yIChjb25zdCBjIG9mIHRoaXMucmFuZG9tLmlzaHVmZmxlKGEuZ3JpZC5zY3JlZW5zKCkpKSB7XG4gICAgICBpZiAoc3RhaXJzID09PSAzKSBicmVhaztcbiAgICAgIGNvbnN0IG1pZCA9IChjIHwgMHg4MDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHVwID0gKG1pZCAtIDB4ODAwKSBhcyBHcmlkQ29vcmQ7XG4gICAgICBjb25zdCBkb3duID0gKG1pZCArIDB4ODAwKSBhcyBHcmlkQ29vcmQ7XG4gICAgICBpZiAoYS5ncmlkLmdldChtaWQpID09PSAnYycgJiZcbiAgICAgICAgICBhLmdyaWQuZ2V0KHVwKSAhPT0gJ3MnICYmXG4gICAgICAgICAgYS5ncmlkLmdldChkb3duKSAhPT0gJ3MnKSB7XG4gICAgICAgIGEuZ3JpZC5zZXQobWlkLCAnPCcpO1xuICAgICAgICBhLmZpeGVkLmFkZChtaWQpO1xuICAgICAgICBhLmdyaWQuc2V0KHVwLCAnJyk7XG4gICAgICAgIGEuZ3JpZC5zZXQoZG93biwgJycpO1xuICAgICAgICBzdGFpcnMrKztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBNYWtlIHN1cmUgZXZlcnl0aGluZyBpcyBzdGlsbCBhY2Nlc3NpYmxlLlxuICAgIGNvbnN0IHBhcnRpdGlvbnMgPSBuZXcgU2V0KGEuZ3JpZC5wYXJ0aXRpb24oKS52YWx1ZXMoKSk7XG4gICAgcmV0dXJuIHBhcnRpdGlvbnMuc2l6ZSA9PT0gMTtcbiAgfVxuXG4gIGFkZFN0YWlycygpIHsgcmV0dXJuIE9LOyB9XG5cbiAgc3RhdGljIHJlYWRvbmx5IFBBVFRFUk4gPSBbXG4gICAgJyAgICAgICAgICAgICAgICAgJyxcbiAgICAnICAgY2NjY2NjY2NjY2MgICAnLFxuICAgICcgICBjIGMgYyBjIGMgYyAgICcsXG4gICAgJyBjY2MgcyBzIHMgcyBjY2MgJyxcbiAgICAnIGMgYyBzIHMgcyBzIGMgYyAnLFxuICAgICcgY2NjY3Njc2NzY3NjY2NjICcsXG4gICAgJyBjIGMgcyBzIHMgcyBjIGMgJyxcbiAgICAnIGNjYyBzIHMgcyBzIGNjYyAnLFxuICAgICcgICBjIGMgYyBjIGMgYyAgICcsXG4gICAgJyAgIGNjY2NjY2NjY2NjICAgJyxcbiAgICAnICAgICAgICAgICAgICAgICAnLFxuICBdO1xufVxuIl19