import { N, S } from './grid.js';
import { Monogrid, Cursor } from './monogrid.js';
import { OK } from './maze.js';
import { TwoStageCaveShuffle } from './twostage.js';
import { seq } from '../rom/util.js';
export class RiverCaveShuffle extends TwoStageCaveShuffle {
    constructor() {
        super(...arguments);
        this.early = 'r';
        this.maxAttempts = 250;
    }
    targetEarly() { var _a, _b; return (_b = (_a = this.params.features) === null || _a === void 0 ? void 0 : _a.river) !== null && _b !== void 0 ? _b : 0; }
    preinfer(a) {
        if ([...this.orig.exits()].length < 2)
            return OK;
        const override = new Map();
        for (let i = 0; i < a.grid.data.length; i++) {
            if (a.grid.data[i] === 'r')
                override.set(a.grid.coord(i), '');
        }
        const parts = a.grid.partition(override);
        const stairParts = [];
        for (let i = 0; i < a.grid.data.length; i++) {
            if (a.grid.data[i] === '<' || a.grid.data[i] === '>' ||
                (a.grid.data[i] && a.grid.isBorder(a.grid.coord(i)))) {
                stairParts.push(parts.get(a.grid.coord(i)));
            }
        }
        if (new Set(stairParts).size < stairParts.length) {
            return { ok: false, fail: `river didn't matter` };
        }
        return super.preinfer(a);
    }
    addLateFeatures(a) {
        return OK;
    }
    addArenas(a, arenas) {
        if (!arenas)
            return true;
        const g = a.grid;
        for (const c of this.random.ishuffle(a.grid.screens())) {
            const middle = (c | 0x808);
            const left = (middle - 8);
            const left2 = (left - 8);
            const right = (middle + 8);
            const right2 = (right + 8);
            const up = middle - 0x800;
            const down = middle + 0x800;
            if (g.get(middle) !== 'c')
                continue;
            if (g.get(up) !== 'c')
                continue;
            if (g.get(down) !== 'c')
                continue;
            const leftTile = g.isBorder(left) ? '' : this.extract(g, left2 - 0x808);
            const rightTile = g.isBorder(right) ? '' : this.extract(g, right2 - 0x808);
            if (/[^ c]/.test(leftTile + rightTile))
                continue;
            if (!g.isBorder(left)) {
                g.set(left, '');
                g.set(left2, '');
                g.set(left2 - 8, '');
                g.set(left2 - 0x800, '');
                g.set(left2 + 0x800, '');
            }
            if (!g.isBorder(right)) {
                g.set(right, '');
                g.set(right2, '');
                g.set(right2 + 8, '');
                g.set(right2 - 0x800, '');
                g.set(right2 + 0x800, '');
            }
            a.fixed.add(middle);
            a.fixed.add(up);
            a.fixed.add(down);
            g.set(middle, 'a');
            arenas--;
            if (!arenas) {
                this.pruneDisconnected(a);
                return true;
            }
        }
        return false;
    }
}
export class WaterfallRiverCaveShuffle extends RiverCaveShuffle {
    constructor() {
        super(...arguments);
        this.addBlocks = false;
    }
    initialFillEarly(a) {
        const g = new Monogrid(a.h, a.w, this.getValidEarlyScreens());
        const x0 = 2 + this.random.nextInt(a.w - 4);
        const x1 = 2 + this.random.nextInt(a.w - 4);
        const c = new Cursor(g, a.h - 1, x1);
        c.go(0);
        c.directedPath(this.random, 1, x0);
        c.go(0);
        a.grid.data = g.toGrid('r').data;
        this.addAllFixed(a);
        return OK;
    }
    addEdges(a) {
        let r = -1;
        const h = (a.h - 1) << 12 | 0x808;
        for (let x = 0; x < a.w; x++) {
            if (a.grid.get((h | (x << 4))) === 'r')
                r = x;
        }
        if (r < 0)
            throw new Error(`no river on bottom edge`);
        const c0 = (h | this.random.nextInt(r) << 4);
        const c1 = (h | (r + 1 + this.random.nextInt(a.w - 1 - r)) << 4);
        a.grid.set(c0, '>');
        a.grid.set(c0 - 8, '');
        a.grid.set(c0 + 8, '');
        a.grid.set(c1, '>');
        a.grid.set(c1 - 8, '');
        a.grid.set(c1 + 8, '');
        a.fixed.add(c0);
        a.fixed.add(c1);
        return OK;
    }
    addStairs() { return OK; }
    checkMeta(meta, repl) {
        const opts = repl ? { flight: true, with: repl } : { flight: true };
        const parts = meta.traverse(opts);
        return new Set(parts.values()).size === this.maxPartitions;
    }
}
export class StyxRiverCaveShuffle extends RiverCaveShuffle {
    constructor() {
        super(...arguments);
        this.addBlocks = false;
    }
    fillGrid(a) {
        var _a;
        const edges = [];
        let size = 0;
        for (const x of this.random.ishuffle(seq(a.w - 2, x => x + 1))) {
            if (edges.length === 1 && (x - edges[0]) ** 2 <= 1)
                continue;
            const c = ((a.h - 1) << 12 | x << 4 | 0x808);
            a.grid.set(c, 'c');
            a.grid.set(N(c), 'c');
            a.grid.set(S(c), 'n');
            a.fixed.add(c);
            a.fixed.add(N(c));
            a.fixed.add(S(c));
            edges.push(x);
            size++;
            if (edges.length === 2)
                break;
        }
        if (edges.length < 2)
            return { ok: false, fail: `initial edges` };
        let rivers = a.w;
        const cut = this.random.nextInt(Math.abs(edges[0] - edges[1]) - 1) +
            Math.min(edges[0], edges[1]) + 1;
        for (let i = 1; i < 2 * a.w; i++) {
            if (i === 2 * cut + 1)
                continue;
            a.grid.set(((a.h - 2) << 12 | i << 3 | 0x800), 'r');
            a.fixed.add(((a.h - 1) << 12 | i << 3 | 0x800));
        }
        const riversTarget = this.params.features.river;
        while (rivers < riversTarget) {
            const added = this.tryAdd(a, { char: 'r' });
            if (!added)
                return { ok: false, fail: `failed to extrude river\n${a.grid.show()}` };
            rivers += added;
            size += added;
        }
        const sizeTarget = this.params.size;
        while (size < sizeTarget) {
            const added = this.tryAdd(a);
            if (!added)
                return { ok: false, fail: `failed to extrude cave` };
            size += added;
        }
        return this.addStairs(a, ...((_a = this.params.stairs) !== null && _a !== void 0 ? _a : []));
    }
    checkMeta() { return true; }
    refineMetascreens(a, meta) {
        const result = super.refineMetascreens(a, meta);
        if (!result.ok)
            return result;
        function accessible(map) {
            let count = 0;
            for (const set of new Set(map.values())) {
                for (const edge of set) {
                    if (meta.exitType(edge) === 'edge:bottom') {
                        count += set.size;
                        break;
                    }
                }
            }
            return count;
        }
        const parts1 = accessible(meta.traverse({ noFlagged: true }));
        const parts2 = accessible(meta.traverse());
        if (parts1 === parts2)
            return { ok: false, fail: `bridge didn't matter` };
        const parts3 = accessible(meta.traverse({ flight: true }));
        if (parts2 === parts3)
            return { ok: false, fail: `flight not required` };
        return OK;
    }
}
export class OasisCaveShuffle extends RiverCaveShuffle {
    constructor() {
        super(...arguments);
        this.pattern = [
            '               ',
            ' rrrrrrrrrrrrr ',
            ' r           r ',
            ' r rrrrrrrrr r ',
            ' r r       r r ',
            ' r r rrrrr r r ',
            ' r r r   r r r ',
            ' r r r   r r r ',
            ' r r r   r r r ',
            ' r r r < r r r ',
            ' r r r c r r r ',
            ' r r rrrrr r r ',
            ' r r       r r ',
            ' r rrrrrrrrr r ',
            ' r           r ',
            ' rrrrrrrrrrrrr ',
            '               ',
        ];
    }
    initialFill(a) {
        return this.insertPattern(a, this.pattern);
    }
    addEdges(a) {
        let corner;
        for (let i = 0; i < a.grid.data.length; i++) {
            if (a.grid.data[i] === 'r') {
                corner = a.grid.coord(i) - 0x808;
                break;
            }
        }
        if (corner == null)
            throw new Error(`no corner`);
        const edges = [];
        for (let y = 0; y < this.pattern.length; y++) {
            for (let x = 1; x < this.pattern[y].length - 1; x++) {
                if (!((x ^ y) & 1))
                    continue;
                if (this.pattern[y][x] !== ' ')
                    continue;
                edges.push(corner + (y << 11 | x << 3));
            }
        }
        let chars = this.random.shuffle([...'ccrrrrrrrr']);
        for (const edge of this.random.ishuffle(edges)) {
            const char = chars[chars.length - 1];
            if (char === 'c' &&
                [...this.extract(a.grid, edge - 0x808)]
                    .filter(v => v === 'r').length < 4) {
                continue;
            }
            if (this.canSet(a, edge, char))
                a.grid.set(edge, chars.pop());
            if (!chars.length)
                break;
        }
        for (let i = 0; i < 6; i++) {
            this.tryAdd(a, { char: 'c' });
        }
        return OK;
    }
    refine(a) {
        var _a;
        const stairs = [...((_a = this.params.stairs) !== null && _a !== void 0 ? _a : [])];
        stairs[0]--;
        if (stairs[0] || stairs[1]) {
            const result = this.addStairs(a, ...stairs);
            if (!result.ok)
                return result;
        }
        let deadEnds = 0;
        for (const s of this.random.ishuffle(a.grid.screens())) {
            if (this.extract(a.grid, s).replace(/ /g, '') === 'c') {
                if (stairs[0] && !a.grid.get(s + 8)) {
                    a.grid.set(s + 0x808, '<');
                    stairs[0]--;
                }
                a.fixed.add(s + 0x808);
                if (++deadEnds >= 2)
                    break;
            }
        }
        const parts = a.grid.partition();
        if (new Set(parts.values()).size > 1)
            return { ok: false, fail: `orphans` };
        return OK;
    }
    fillGrid(a) {
        let result;
        if ((result = this.initialFill(a)), !result.ok)
            return result;
        if ((result = this.addEdges(a)), !result.ok)
            return result;
        if ((result = this.refine(a)), !result.ok)
            return result;
        return OK;
    }
    checkMeta(meta, rep) {
        const parts = meta.traverse(rep ? { with: rep } : {});
        const allStairs = [];
        for (const edges of new Set(parts.values())) {
            let stairs = 0;
            for (const edge of new Set([...edges])) {
                if (meta.exitType(edge))
                    stairs++;
            }
            allStairs.push(stairs);
        }
        return allStairs.filter(s => s > 0).length === 1;
    }
    refineMetascreens(a, meta) {
        if (!this.checkMeta(meta))
            return { ok: false, fail: `initial checkMeta` };
        const result = super.refineMetascreens(a, meta);
        if (!result.ok)
            return result;
        function accessible(map) {
            let count = 0;
            for (const set of new Set(map.values())) {
                for (const edge of set) {
                    if (meta.exitType(edge)) {
                        count += set.size;
                        break;
                    }
                }
            }
            return count;
        }
        const parts1 = accessible(meta.traverse());
        const parts2 = accessible(meta.traverse({ flight: true }));
        if (parts1 === parts2)
            return { ok: false, fail: `flight not required` };
        return OK;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicml2ZXJjYXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL21hemUvcml2ZXJjYXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBd0IsQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN2RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQVUsRUFBRSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR3ZDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJckMsTUFBTSxPQUFPLGdCQUFpQixTQUFRLG1CQUFtQjtJQUF6RDs7UUFZRSxVQUFLLEdBQUcsR0FBRyxDQUFDO1FBQ1osZ0JBQVcsR0FBRyxHQUFHLENBQUM7SUE2SHBCLENBQUM7SUExSEMsV0FBVyxpQkFBSyxtQkFBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsMENBQUUsS0FBSyxtQ0FBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBMkMxRCxRQUFRLENBQUMsQ0FBSTtRQUVYLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ2pELE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxFQUFxQixDQUFDO1FBQzlDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBYyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDeEQsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHO2dCQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElB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Z0I7SUFBMUQ7O1FBQ0UsY0FBUyxHQUFHLEtBQUssQ0FBQztJQTZFcEIsQ0FBQztJQTNFQyxRQUFRLENBQUMsQ0FBSTs7UUFFWCxNQUFNLEtBQUssR0FBYSxFQUFFLENBQUM7UUFDM0IsSUFBSSxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsS0FBSyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUM5RCxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2dCQUFFLFNBQVM7WUFDN0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFjLENBQUM7WUFDMUQsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN0QixDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDdEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDZixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixL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Q0FBQzt3QkFDbEIsTUFBTTtxQkFDUDtpQkFDRjthQUNGO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBQ0QsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsQ0FBQztRQUN6RCxJQUFJLE1BQU0sS0FBSyxNQUFNO1lBQUUsT0FBTyxFQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLHFCQUFxQixFQUFDLENBQUM7UUFFdkUsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYXZlU2h1ZmZsZUF0dGVtcHQgfSBmcm9tICcuL2NhdmUuanMnO1xuaW1wb3J0IHsgR3JpZENvb3JkLCBHcmlkSW5kZXgsIE4sIFMgfSBmcm9tICcuL2dyaWQuanMnO1xuaW1wb3J0IHsgTW9ub2dyaWQsIEN1cnNvciB9IGZyb20gJy4vbW9ub2dyaWQuanMnO1xuaW1wb3J0IHsgUmVzdWx0LCBPSyB9IGZyb20gJy4vbWF6ZS5qcyc7XG5pbXBvcnQgeyBNZXRhbG9jYXRpb24sIFBvcyB9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgTWV0YXNjcmVlbiB9IGZyb20gJy4uL3JvbS9tZXRhc2NyZWVuLmpzJztcbmltcG9ydCB7IFR3b1N0YWdlQ2F2ZVNodWZmbGUgfSBmcm9tICcuL3R3b3N0YWdlLmpzJztcbmltcG9ydCB7IHNlcSB9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcblxudHlwZSBBID0gQ2F2ZVNodWZmbGVBdHRlbXB0O1xuXG5leHBvcnQgY2xhc3MgUml2ZXJDYXZlU2h1ZmZsZSBleHRlbmRzIFR3b1N0YWdlQ2F2ZVNodWZmbGUge1xuICAvLyBiYXNpYyBwcm9ibGVtOiBtaXNzaW5nIHwtIGFuZCAtfCBwaWVjZXMuXG4gIC8vICBvbmUgc29sdXRpb24gd291bGQgYmUgdG8ganVzdCBhZGQgdGhlbVxuICAvLyAgb3V0c2lkZSBvZiB0aGF0LCB3ZSBuZWVkIHRvIHN3aXRjaCB0byBhIHBhdGhnZW4gYWxnbyByYXRoZXJcbiAgLy8gIHRoYW4gcmVmaW5lbWVudFxuXG4gIC8vIHNpbXBsZSBwYXRoZ2VuIHNob3VsZCBiZSBwcmV0dHkgZWFzeSB3LyBncmlkXG5cbiAgLy8gYWx0ZXJuYXRpdmVseSwgdHJpYWwgcmVtb3ZhbHMgYXJlIGZ1cnRoZXItcmVhY2hpbmc/XG4gIC8vICAtIGlmIHdlIHJlbW92ZSBhIGhvcml6b250YWwgZWRnZSB0aGVuIGFsc28gcmVtb3ZlIHRoZVxuICAvLyAgICBvcHBvc2l0ZSBlZGdlcyBvZiBhbnkgbmVpZ2hib3JzLCBjb250aW51aW5nLlxuICAvLyAgLSBvciByZW1vdmUgYSB2ZXJ0aWNhbCBlZGdlIG9mIG9uZS4uLj9cbiAgZWFybHkgPSAncic7XG4gIG1heEF0dGVtcHRzID0gMjUwO1xuICB2YWxpZFJpdmVyU2NyZWVucz86IFNldDxudW1iZXI+O1xuXG4gIHRhcmdldEVhcmx5KCkgeyByZXR1cm4gdGhpcy5wYXJhbXMuZmVhdHVyZXM/LnJpdmVyID8/IDA7IH1cblxuICAvLyBhZGRFYXJseUZlYXR1cmVzKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAvLyAgIC8vIGZpbGwgd2l0aCByaXZlciBhbmQgdGhlbiByZWZpbmUgZG93biB0byB0aGUgY29ycmVjdCBzaXplLlxuICAvLyAgIC8vdGhpcy5maWxsQ2F2ZShcbiAgLy8gICByZXR1cm5cbiAgLy8gfVxuXG4gIC8vIGNhblJlbW92ZShjOiBzdHJpbmcpIHtcbiAgLy8gICByZXR1cm4gYyA9PT0gJ2MnIHx8IGMgPT09ICdyJztcbiAgLy8gfVxuXG4gIC8vIHJlbW92YWxNYXAoYTogQSwgY29vcmQ6IEdyaWRDb29yZCk6IE1hcDxHcmlkQ29vcmQsIHN0cmluZz4ge1xuICAvLyAgIGlmICgoY29vcmQgJiAweDgwOCkgIT09IDB4ODAwKSByZXR1cm4gbmV3IE1hcChbW2Nvb3JkLCAnJ11dKTtcbiAgLy8gICAvLyBuZWVkIHRvIGJlIGEgbGl0dGxlIGNsZXZlcmVyOiBob3Jpem9udGFsIGJyYW5jaGVzIGFyZSBub3RcbiAgLy8gICAvLyBhbGxvd2VkICh0aG91Z2ggd2UgY291bGQgYWRkIHRoZW0sIGluIHdoaWNoIGNhc2UgdGhpcyBnZXRzXG4gIC8vICAgLy8gYSBsb3QgZWFzaWVyKSwgc28gZW5zdXJlIHdlJ3JlIGxlZnQgd2l0aCBhIGJlbmQgaW5zdGVhZC5cbiAgLy8gICBjb25zdCBtYXAgPSBuZXcgTWFwKFtbY29vcmQsICcnXV0pO1xuICAvLyAgIGNvbnN0IGxlZnQgPSBjb29yZCAtIDggYXMgR3JpZENvb3JkO1xuICAvLyAgIGlmIChhLmdyaWQuZ2V0KGxlZnQpID09PSAncicpIHtcbiAgLy8gICAgIGNvbnN0IGxlZnRVcCA9IGxlZnQgLSAweDgwMCBhcyBHcmlkQ29vcmQ7XG4gIC8vICAgICBjb25zdCBsZWZ0RG93biA9IGxlZnQgKyAweDgwMCBhcyBHcmlkQ29vcmQ7XG4gIC8vICAgICBjb25zdCBsZWZ0TGVmdCA9IGxlZnQgLSA4IGFzIEdyaWRDb29yZDtcbiAgLy8gICAgIC8vIG1heSBuZWVkIHRvIHJlbW92ZSBhbm90aGVyIG5laWdoYm9yLlxuICAvLyAgICAgaWYgKGEuZ3JpZC5nZXQobGVmdFVwKSA9PT0gJ3InICYmIGEuZ3JpZC5nZXQobGVmdERvd24pID09PSAncicgJiZcbiAgLy8gICAgICAgICBhLmdyaWQuZ2V0KGxlZnRMZWZ0KSA9PT0gJ3InKSB7XG4gIC8vICAgICAgIG1hcC5zZXQodGhpcy5yYW5kb20ubmV4dEludCgyKSA/IGxlZnRVcCA6IGxlZnREb3duLCAnJyk7XG4gIC8vICAgICB9XG4gIC8vICAgfVxuICAvLyAgIGNvbnN0IHJpZ2h0ID0gY29vcmQgKyA4IGFzIEdyaWRDb29yZDtcbiAgLy8gICBpZiAoYS5ncmlkLmdldChyaWdodCkgPT09ICdyJykge1xuICAvLyAgICAgY29uc3QgcmlnaHRVcCA9IHJpZ2h0IC0gMHg4MDAgYXMgR3JpZENvb3JkO1xuICAvLyAgICAgY29uc3QgcmlnaHREb3duID0gcmlnaHQgKyAweDgwMCBhcyBHcmlkQ29vcmQ7XG4gIC8vICAgICBjb25zdCByaWdodFJpZ2h0ID0gcmlnaHQgKyA4IGFzIEdyaWRDb29yZDtcbiAgLy8gICAgIC8vIG1heSBuZWVkIHRvIHJlbW92ZSBhbm90aGVyIG5laWdoYm9yLlxuICAvLyAgICAgaWYgKGEuZ3JpZC5nZXQocmlnaHRVcCkgPT09ICdyJyAmJiBhLmdyaWQuZ2V0KHJpZ2h0RG93bikgPT09ICdyJyAmJlxuICAvLyAgICAgICAgIGEuZ3JpZC5nZXQocmlnaHRSaWdodCkgPT09ICdyJykge1xuICAvLyAgICAgICBtYXAuc2V0KHRoaXMucmFuZG9tLm5leHRJbnQoMikgPyByaWdodFVwIDogcmlnaHREb3duLCAnJyk7XG4gIC8vICAgICB9XG4gIC8vICAgfVxuICAvLyAgIHJldHVybiBtYXA7XG4gIC8vIH1cblxuICBwcmVpbmZlcihhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBNYWtlIHN1cmUgcml2ZXIgaXMgYWN0dWFsbHkgbmVjZXNzYXJ5IVxuICAgIGlmIChbLi4udGhpcy5vcmlnLmV4aXRzKCldLmxlbmd0aCA8IDIpIHJldHVybiBPSztcbiAgICBjb25zdCBvdmVycmlkZSA9IG5ldyBNYXA8R3JpZENvb3JkLCBzdHJpbmc+KCk7XG4gICAgZm9yIChsZXQgaSA9IDAgYXMgR3JpZEluZGV4OyBpIDwgYS5ncmlkLmRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChhLmdyaWQuZGF0YVtpXSA9PT0gJ3InKSBvdmVycmlkZS5zZXQoYS5ncmlkLmNvb3JkKGkpLCAnJyk7XG4gICAgfVxuICAgIGNvbnN0IHBhcnRzID0gYS5ncmlkLnBhcnRpdGlvbihvdmVycmlkZSk7XG4gICAgY29uc3Qgc3RhaXJQYXJ0czogdW5rbm93bltdID0gW107XG4gICAgZm9yIChsZXQgaSA9IDAgYXMgR3JpZEluZGV4OyBpIDwgYS5ncmlkLmRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChhLmdyaWQuZGF0YVtpXSA9PT0gJzwnIHx8IGEuZ3JpZC5kYXRhW2ldID09PSAnPicgfHxcbiAgICAgICAgICAoYS5ncmlkLmRhdGFbaV0gJiYgYS5ncmlkLmlzQm9yZGVyKGEuZ3JpZC5jb29yZChpKSkpKSB7XG4gICAgICAgIHN0YWlyUGFydHMucHVzaChwYXJ0cy5nZXQoYS5ncmlkLmNvb3JkKGkpKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChuZXcgU2V0KHN0YWlyUGFydHMpLnNpemUgPCBzdGFpclBhcnRzLmxlbmd0aCkge1xuICAgICAgLy9jb25zb2xlLmVycm9yKGEuZ3JpZC5zaG93KCkpO1xuICAgICAgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGByaXZlciBkaWRuJ3QgbWF0dGVyYH07XG4gICAgfVxuICAgIHJldHVybiBzdXBlci5wcmVpbmZlcihhKTtcbiAgfVxuXG4gIGFkZExhdGVGZWF0dXJlcyhhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBjb25zb2xlLmVycm9yKGEuZ3JpZC5zaG93KCkpO1xuICAgIC8vIHJldHVybiBzdXBlci5hZGRMYXRlRmVhdHVyZXMoYSk7XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgYWRkQXJlbmFzKGE6IEEsIGFyZW5hczogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgLy8gVGhpcyB2ZXJzaW9uIHdvcmtzIGEgbGl0dGxlIGRpZmZlcmVudGx5LCBzaW5jZSBpdCBydW5zIGFzIGFuIGVhcmx5XG4gICAgLy8gZmVhdHVyZSAoYmVmb3JlIHJlZmluZW1lbnQpIHJhdGhlciB0aGFuIGxhdGUuICBXZSBsb29rIGZvciBhIDN4MVxuICAgIC8vIGJsb2NrIG9mICdjJyBzY3JlZW5zLCB6ZXJvIG91dCBhbGwgYnV0IHRoZSBtaWRkbGUgKHdoaWNoIGdldHMgdGhlXG4gICAgLy8gYXJlbmEpLCBhbmQgdGhlbiBhZnRlcndhcmRzIHdlIHBydW5lIGF3YXkgYW55IG5ld2x5LWRpc2Nvbm5lY3RlZFxuICAgIC8vIGxhbmQgc2NyZWVucy5cbiAgICBpZiAoIWFyZW5hcykgcmV0dXJuIHRydWU7XG4gICAgY29uc3QgZyA9IGEuZ3JpZDtcbiAgICBmb3IgKGNvbnN0IGMgb2YgdGhpcy5yYW5kb20uaXNodWZmbGUoYS5ncmlkLnNjcmVlbnMoKSkpIHtcbiAgICAgIGNvbnN0IG1pZGRsZSA9IChjIHwgMHg4MDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IGxlZnQgPSAobWlkZGxlIC0gOCkgYXMgR3JpZENvb3JkO1xuICAgICAgY29uc3QgbGVmdDIgPSAobGVmdCAtIDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHJpZ2h0ID0gKG1pZGRsZSArIDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHJpZ2h0MiA9IChyaWdodCArIDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHVwID0gbWlkZGxlIC0gMHg4MDAgYXMgR3JpZENvb3JkO1xuICAgICAgY29uc3QgZG93biA9IG1pZGRsZSArIDB4ODAwIGFzIEdyaWRDb29yZDtcbiAgICAgIGlmIChnLmdldChtaWRkbGUpICE9PSAnYycpIGNvbnRpbnVlO1xuICAgICAgaWYgKGcuZ2V0KHVwKSAhPT0gJ2MnKSBjb250aW51ZTtcbiAgICAgIGlmIChnLmdldChkb3duKSAhPT0gJ2MnKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IGxlZnRUaWxlID1cbiAgICAgICAgICBnLmlzQm9yZGVyKGxlZnQpID8gJycgOiB0aGlzLmV4dHJhY3QoZywgbGVmdDIgLSAweDgwOCBhcyBHcmlkQ29vcmQpO1xuICAgICAgY29uc3QgcmlnaHRUaWxlID1cbiAgICAgICAgICBnLmlzQm9yZGVyKHJpZ2h0KSA/ICcnIDogdGhpcy5leHRyYWN0KGcsIHJpZ2h0MiAtIDB4ODA4IGFzIEdyaWRDb29yZCk7XG4gICAgICBpZiAoL1teIGNdLy50ZXN0KGxlZnRUaWxlICsgcmlnaHRUaWxlKSkgY29udGludWU7XG4gICAgICBpZiAoIWcuaXNCb3JkZXIobGVmdCkpIHtcbiAgICAgICAgZy5zZXQobGVmdCwgJycpO1xuICAgICAgICBnLnNldChsZWZ0MiwgJycpO1xuICAgICAgICBnLnNldChsZWZ0MiAtIDggYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgICAgIGcuc2V0KGxlZnQyIC0gMHg4MDAgYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgICAgIGcuc2V0KGxlZnQyICsgMHg4MDAgYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgICB9XG4gICAgICBpZiAoIWcuaXNCb3JkZXIocmlnaHQpKSB7XG4gICAgICAgIGcuc2V0KHJpZ2h0LCAnJyk7XG4gICAgICAgIGcuc2V0KHJpZ2h0MiwgJycpO1xuICAgICAgICBnLnNldChyaWdodDIgKyA4IGFzIEdyaWRDb29yZCwgJycpO1xuICAgICAgICBnLnNldChyaWdodDIgLSAweDgwMCBhcyBHcmlkQ29vcmQsICcnKTtcbiAgICAgICAgZy5zZXQocmlnaHQyICsgMHg4MDAgYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgICB9XG4gICAgICBhLmZpeGVkLmFkZChtaWRkbGUpO1xuICAgICAgYS5maXhlZC5hZGQodXApO1xuICAgICAgYS5maXhlZC5hZGQoZG93bik7XG4gICAgICBnLnNldChtaWRkbGUsICdhJyk7XG4gICAgICBhcmVuYXMtLTtcbiAgICAgIGlmICghYXJlbmFzKSB7XG4gICAgICAgIHRoaXMucHJ1bmVEaXNjb25uZWN0ZWQoYSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICAvL2NvbnNvbGUuZXJyb3IoJ2NvdWxkIG5vdCBhZGQgYXJlbmEnKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFdhdGVyZmFsbFJpdmVyQ2F2ZVNodWZmbGUgZXh0ZW5kcyBSaXZlckNhdmVTaHVmZmxlIHtcblxuICBhZGRCbG9ja3MgPSBmYWxzZTtcblxuICBpbml0aWFsRmlsbEVhcmx5KGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGNvbnN0IGcgPSBuZXcgTW9ub2dyaWQoYS5oLCBhLncsIHRoaXMuZ2V0VmFsaWRFYXJseVNjcmVlbnMoKSk7XG4gICAgY29uc3QgeDAgPSAyICsgdGhpcy5yYW5kb20ubmV4dEludChhLncgLSA0KTtcbiAgICBjb25zdCB4MSA9IDIgKyB0aGlzLnJhbmRvbS5uZXh0SW50KGEudyAtIDQpO1xuICAgIGNvbnN0IGMgPSBuZXcgQ3Vyc29yKGcsIGEuaCAtIDEsIHgxKTtcbiAgICBjLmdvKDApO1xuICAgIGMuZGlyZWN0ZWRQYXRoKHRoaXMucmFuZG9tLCAxLCB4MCk7XG4gICAgYy5nbygwKTtcblxuICAgIGEuZ3JpZC5kYXRhID0gZy50b0dyaWQoJ3InKS5kYXRhO1xuICAgIHRoaXMuYWRkQWxsRml4ZWQoYSk7XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgYWRkRWRnZXMoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgbGV0IHIgPSAtMTtcbiAgICBjb25zdCBoID0gKGEuaCAtIDEpIDw8IDEyIHwgMHg4MDg7XG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCBhLnc7IHgrKykge1xuICAgICAgaWYgKGEuZ3JpZC5nZXQoKGggfCAoeCA8PCA0KSkgYXMgR3JpZENvb3JkKSA9PT0gJ3InKSByID0geDtcbiAgICB9XG4gICAgaWYgKHIgPCAwKSB0aHJvdyBuZXcgRXJyb3IoYG5vIHJpdmVyIG9uIGJvdHRvbSBlZGdlYCk7XG4gICAgY29uc3QgYzAgPSAoaCB8IHRoaXMucmFuZG9tLm5leHRJbnQocikgPDwgNCkgYXMgR3JpZENvb3JkO1xuICAgIGNvbnN0IGMxID1cbiAgICAgICAgKGggfCAociArIDEgKyB0aGlzLnJhbmRvbS5uZXh0SW50KGEudyAtIDEgLSByKSkgPDwgNCkgYXMgR3JpZENvb3JkO1xuICAgIGEuZ3JpZC5zZXQoYzAsICc+Jyk7XG4gICAgYS5ncmlkLnNldChjMCAtIDggYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgYS5ncmlkLnNldChjMCArIDggYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgYS5ncmlkLnNldChjMSwgJz4nKTtcbiAgICBhLmdyaWQuc2V0KGMxIC0gOCBhcyBHcmlkQ29vcmQsICcnKTtcbiAgICBhLmdyaWQuc2V0KGMxICsgOCBhcyBHcmlkQ29vcmQsICcnKTtcbiAgICBhLmZpeGVkLmFkZChjMCk7XG4gICAgYS5maXhlZC5hZGQoYzEpO1xuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGFkZFN0YWlycygpOiBSZXN1bHQ8dm9pZD4geyByZXR1cm4gT0s7IH1cblxuICBjaGVja01ldGEobWV0YTogTWV0YWxvY2F0aW9uLCByZXBsPzogTWFwPFBvcywgTWV0YXNjcmVlbj4pOiBib29sZWFuIHtcbiAgICBjb25zdCBvcHRzID0gcmVwbCA/IHtmbGlnaHQ6IHRydWUsIHdpdGg6IHJlcGx9IDoge2ZsaWdodDogdHJ1ZX07XG4gICAgY29uc3QgcGFydHMgPSBtZXRhLnRyYXZlcnNlKG9wdHMpO1xuICAgIHJldHVybiBuZXcgU2V0KHBhcnRzLnZhbHVlcygpKS5zaXplID09PSB0aGlzLm1heFBhcnRpdGlvbnM7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN0eXhSaXZlckNhdmVTaHVmZmxlIGV4dGVuZHMgUml2ZXJDYXZlU2h1ZmZsZSB7XG4gIGFkZEJsb2NrcyA9IGZhbHNlO1xuXG4gIGZpbGxHcmlkKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIC8vIG1ha2UgMiBib3R0b20gZWRnZSBleGl0c1xuICAgIGNvbnN0IGVkZ2VzOiBudW1iZXJbXSA9IFtdO1xuICAgIGxldCBzaXplID0gMDtcbiAgICBmb3IgKGNvbnN0IHggb2YgdGhpcy5yYW5kb20uaXNodWZmbGUoc2VxKGEudyAtIDIsIHggPT4geCArIDEpKSkge1xuICAgICAgaWYgKGVkZ2VzLmxlbmd0aCA9PT0gMSAmJiAoeCAtIGVkZ2VzWzBdKSAqKiAyIDw9IDEpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgYyA9ICgoYS5oIC0gMSkgPDwgMTIgfCB4IDw8IDQgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgYS5ncmlkLnNldChjLCAnYycpO1xuICAgICAgYS5ncmlkLnNldChOKGMpLCAnYycpO1xuICAgICAgYS5ncmlkLnNldChTKGMpLCAnbicpO1xuICAgICAgYS5maXhlZC5hZGQoYyk7XG4gICAgICBhLmZpeGVkLmFkZChOKGMpKTtcbiAgICAgIGEuZml4ZWQuYWRkKFMoYykpO1xuICAgICAgZWRnZXMucHVzaCh4KTtcbiAgICAgIHNpemUrKztcbiAgICAgIGlmIChlZGdlcy5sZW5ndGggPT09IDIpIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoZWRnZXMubGVuZ3RoIDwgMikgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBpbml0aWFsIGVkZ2VzYH07XG4gICAgLy8gbWFrZSBhIHJpdmVyIGFjcm9zcyB0aGUgYm90dG9tLlxuICAgIGxldCByaXZlcnMgPSBhLnc7XG4gICAgY29uc3QgY3V0ID1cbiAgICAgICAgdGhpcy5yYW5kb20ubmV4dEludChNYXRoLmFicyhlZGdlc1swXSAtIGVkZ2VzWzFdKSAtIDEpICtcbiAgICAgICAgTWF0aC5taW4oZWRnZXNbMF0sIGVkZ2VzWzFdKSArIDE7XG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCAyICogYS53OyBpKyspIHtcbiAgICAgIGlmIChpID09PSAyICogY3V0ICsgMSkgY29udGludWU7XG4gICAgICBhLmdyaWQuc2V0KCgoYS5oIC0gMikgPDwgMTIgfCBpIDw8IDMgfCAweDgwMCkgYXMgR3JpZENvb3JkLCAncicpO1xuICAgICAgYS5maXhlZC5hZGQoKChhLmggLSAxKSA8PCAxMiB8IGkgPDwgMyB8IDB4ODAwKSBhcyBHcmlkQ29vcmQpO1xuICAgIH1cbiAgICAvLyBleHRlbmQgcml2ZXIuXG4gICAgY29uc3Qgcml2ZXJzVGFyZ2V0ID0gdGhpcy5wYXJhbXMuZmVhdHVyZXMhLnJpdmVyITtcbiAgICB3aGlsZSAocml2ZXJzIDwgcml2ZXJzVGFyZ2V0KSB7XG4gICAgICBjb25zdCBhZGRlZCA9IHRoaXMudHJ5QWRkKGEsIHtjaGFyOiAncid9KTtcbiAgICAgIGlmICghYWRkZWQpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgZmFpbGVkIHRvIGV4dHJ1ZGUgcml2ZXJcXG4ke2EuZ3JpZC5zaG93KCl9YH07XG4gICAgICByaXZlcnMgKz0gYWRkZWQ7XG4gICAgICBzaXplICs9IGFkZGVkO1xuICAgIH1cbiAgICAvLyBleHRydWRlIGNhdmUuXG4gICAgY29uc3Qgc2l6ZVRhcmdldCA9IHRoaXMucGFyYW1zLnNpemU7XG4gICAgd2hpbGUgKHNpemUgPCBzaXplVGFyZ2V0KSB7XG4gICAgICBjb25zdCBhZGRlZCA9IHRoaXMudHJ5QWRkKGEpO1xuICAgICAgaWYgKCFhZGRlZCkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBmYWlsZWQgdG8gZXh0cnVkZSBjYXZlYH07XG4gICAgICBzaXplICs9IGFkZGVkO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmFkZFN0YWlycyhhLCAuLi4odGhpcy5wYXJhbXMuc3RhaXJzID8/IFtdKSk7XG4gIH1cblxuICAvLyBGbGlnaHQgbWF5IGJlIHJlcXVpcmVkIGZvciBhbnl0aGluZy5cbiAgY2hlY2tNZXRhKCkgeyByZXR1cm4gdHJ1ZTsgfVxuXG4gIHJlZmluZU1ldGFzY3JlZW5zKGE6IEEsIG1ldGE6IE1ldGFsb2NhdGlvbik6IFJlc3VsdDx2b2lkPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gc3VwZXIucmVmaW5lTWV0YXNjcmVlbnMoYSwgbWV0YSk7XG4gICAgaWYgKCFyZXN1bHQub2spIHJldHVybiByZXN1bHQ7XG4gICAgLy8gQ2hlY2sgc2ltcGxlIGNvbmRpdGlvbnM6ICgxKSB0aGVyZSdzIGFuIGFjY2Vzc2libGUgYnJpZGdlLFxuICAgIC8vICgyKSBmbGlnaHQgaXMgcmVxdWlyZWQgZm9yIHNvbWUgdGlsZS5cbiAgICBmdW5jdGlvbiBhY2Nlc3NpYmxlKG1hcDogTWFwPG51bWJlciwgU2V0PG51bWJlcj4+KTogbnVtYmVyIHtcbiAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICBmb3IgKGNvbnN0IHNldCBvZiBuZXcgU2V0KG1hcC52YWx1ZXMoKSkpIHtcbiAgICAgICAgZm9yIChjb25zdCBlZGdlIG9mIHNldCkge1xuICAgICAgICAgIC8vIG9ubHkgY2hlY2sgYWNjZXNzaWJpbGl0eSBmcm9tIGJvdHRvbSBlZGdlLlxuICAgICAgICAgIGlmIChtZXRhLmV4aXRUeXBlKGVkZ2UpID09PSAnZWRnZTpib3R0b20nKSB7XG4gICAgICAgICAgICBjb3VudCArPSBzZXQuc2l6ZTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGNvdW50O1xuICAgIH1cbiAgICBjb25zdCBwYXJ0czEgPSBhY2Nlc3NpYmxlKG1ldGEudHJhdmVyc2Uoe25vRmxhZ2dlZDogdHJ1ZX0pKTtcbiAgICBjb25zdCBwYXJ0czIgPSBhY2Nlc3NpYmxlKG1ldGEudHJhdmVyc2UoKSk7XG4gICAgaWYgKHBhcnRzMSA9PT0gcGFydHMyKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGJyaWRnZSBkaWRuJ3QgbWF0dGVyYH07XG4gICAgY29uc3QgcGFydHMzID0gYWNjZXNzaWJsZShtZXRhLnRyYXZlcnNlKHtmbGlnaHQ6IHRydWV9KSk7XG4gICAgaWYgKHBhcnRzMiA9PT0gcGFydHMzKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGZsaWdodCBub3QgcmVxdWlyZWRgfTtcbiAgICByZXR1cm4gT0s7XG4gIH1cbn1cblxuXG5leHBvcnQgY2xhc3MgT2FzaXNDYXZlU2h1ZmZsZSBleHRlbmRzIFJpdmVyQ2F2ZVNodWZmbGUge1xuXG4gIHJlYWRvbmx5IHBhdHRlcm4gPSBbXG4gICAgJyAgICAgICAgICAgICAgICcsXG4gICAgJyBycnJycnJycnJycnJyICcsXG4gICAgJyByICAgICAgICAgICByICcsXG4gICAgJyByIHJycnJycnJyciByICcsXG4gICAgJyByIHIgICAgICAgciByICcsXG4gICAgJyByIHIgcnJycnIgciByICcsXG4gICAgJyByIHIgciAgIHIgciByICcsXG4gICAgJyByIHIgciAgIHIgciByICcsXG4gICAgJyByIHIgciAgIHIgciByICcsXG4gICAgJyByIHIgciA8IHIgciByICcsXG4gICAgJyByIHIgciBjIHIgciByICcsXG4gICAgJyByIHIgcnJycnIgciByICcsXG4gICAgJyByIHIgICAgICAgciByICcsXG4gICAgJyByIHJycnJycnJyciByICcsXG4gICAgJyByICAgICAgICAgICByICcsXG4gICAgJyBycnJycnJycnJycnJyICcsXG4gICAgJyAgICAgICAgICAgICAgICcsXG4gIF07XG5cbiAgaW5pdGlhbEZpbGwoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgLy8gSW5pdGlhbCBmaWxsOiBtYWtlIHN1cmUgdGhlcmUncyBlbm91Z2ggcm9vbSBhbmQgdGhlbiBjb3B5IHRoZSBwYXR0ZXJuLlxuICAgIHJldHVybiB0aGlzLmluc2VydFBhdHRlcm4oYSwgdGhpcy5wYXR0ZXJuKTtcbiAgfVxuXG4gIGFkZEVkZ2VzKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIC8vIEZpbmQgdGhlIHRvcC1sZWZ0IGNvcm5lciAoVE9ETyAtIHNhdmUgdGhpcyBzb21ld2hlcmU/KVxuICAgIGxldCBjb3JuZXIhOiBHcmlkQ29vcmQ7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmdyaWQuZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGEuZ3JpZC5kYXRhW2ldID09PSAncicpIHtcbiAgICAgICAgY29ybmVyID0gYS5ncmlkLmNvb3JkKGkgYXMgR3JpZEluZGV4KSAtIDB4ODA4IGFzIEdyaWRDb29yZDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjb3JuZXIgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBubyBjb3JuZXJgKTtcblxuICAgIGNvbnN0IGVkZ2VzOiBHcmlkQ29vcmRbXSA9IFtdO1xuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgdGhpcy5wYXR0ZXJuLmxlbmd0aDsgeSsrKSB7XG4gICAgICBmb3IgKGxldCB4ID0gMTsgeCA8IHRoaXMucGF0dGVyblt5XS5sZW5ndGggLSAxOyB4KyspIHtcbiAgICAgICAgaWYgKCEoKHggXiB5KSAmIDEpKSBjb250aW51ZTtcbiAgICAgICAgaWYgKHRoaXMucGF0dGVyblt5XVt4XSAhPT0gJyAnKSBjb250aW51ZTtcbiAgICAgICAgZWRnZXMucHVzaChjb3JuZXIgKyAoeSA8PCAxMSB8IHggPDwgMykgYXMgR3JpZENvb3JkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgY2hhcnMgPSB0aGlzLnJhbmRvbS5zaHVmZmxlKFsuLi4nY2NycnJycnJyciddKTtcbiAgICBmb3IgKGNvbnN0IGVkZ2Ugb2YgdGhpcy5yYW5kb20uaXNodWZmbGUoZWRnZXMpKSB7XG4gICAgICBjb25zdCBjaGFyID0gY2hhcnNbY2hhcnMubGVuZ3RoIC0gMV07XG4gICAgICAvLyBkb24ndCBwbGFjZSBjYXZlcyBvbiB0aGUgb3V0ZXIgYm91bmRhcnkuXG4gICAgICBpZiAoY2hhciA9PT0gJ2MnICYmXG4gICAgICAgICAgWy4uLnRoaXMuZXh0cmFjdChhLmdyaWQsIGVkZ2UgLSAweDgwOCBhcyBHcmlkQ29vcmQpXVxuICAgICAgICAgICAgICAuZmlsdGVyKHYgPT4gdiA9PT0gJ3InKS5sZW5ndGggPCA0KSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY2FuU2V0KGEsIGVkZ2UsIGNoYXIpKSBhLmdyaWQuc2V0KGVkZ2UsIGNoYXJzLnBvcCgpISk7XG4gICAgICBpZiAoIWNoYXJzLmxlbmd0aCkgYnJlYWs7XG4gICAgfVxuXG4gICAgLy8gQWRkIGEgZmV3IGV4dHJhICdjJyB0aWxlcy5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDY7IGkrKykge1xuICAgICAgdGhpcy50cnlBZGQoYSwge2NoYXI6ICdjJ30pO1xuICAgIH1cbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICByZWZpbmUoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgLy8gQWRkIHN0YWlycy5cbiAgICBjb25zdCBzdGFpcnMgPSBbLi4uKHRoaXMucGFyYW1zLnN0YWlycyA/PyBbXSldO1xuICAgIHN0YWlyc1swXS0tO1xuICAgIGlmIChzdGFpcnNbMF0gfHwgc3RhaXJzWzFdKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmFkZFN0YWlycyhhLCAuLi5zdGFpcnMpO1xuICAgICAgaWYgKCFyZXN1bHQub2spIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIC8vIEZpbmQgdHdvIGNhdmUgZGVhZCBlbmRzIGFuZCB0cnkgdG8gcGluIHRoZW0gKD8pXG4gICAgbGV0IGRlYWRFbmRzID0gMDtcbiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5yYW5kb20uaXNodWZmbGUoYS5ncmlkLnNjcmVlbnMoKSkpIHtcbiAgICAgIGlmICh0aGlzLmV4dHJhY3QoYS5ncmlkLCBzKS5yZXBsYWNlKC8gL2csICcnKSA9PT0gJ2MnKSB7XG4gICAgICAgIGlmIChzdGFpcnNbMF0gJiYgIWEuZ3JpZC5nZXQocyArIDggYXMgR3JpZENvb3JkKSkge1xuICAgICAgICAgIGEuZ3JpZC5zZXQocyArIDB4ODA4IGFzIEdyaWRDb29yZCwgJzwnKTtcbiAgICAgICAgICBzdGFpcnNbMF0tLTtcbiAgICAgICAgfVxuICAgICAgICBhLmZpeGVkLmFkZChzICsgMHg4MDggYXMgR3JpZENvb3JkKTtcbiAgICAgICAgaWYgKCsrZGVhZEVuZHMgPj0gMikgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIE1ha2Ugc3VyZSBpdCdzIHRyYXZlcnNpYmxlLlxuICAgIGNvbnN0IHBhcnRzID0gYS5ncmlkLnBhcnRpdGlvbigpO1xuICAgIGlmIChuZXcgU2V0KHBhcnRzLnZhbHVlcygpKS5zaXplID4gMSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBvcnBoYW5zYH07XG4gICAgLy8gLy8gTG9vayBmb3IgZWRnZXMgd2UgY2FuIGRlbGV0ZSBhbmQgbm90IGFjdHVhbGx5IGN1dCBhbnl0aGluZyBvZmYuXG4gICAgLy8gZm9yIChjb25zdCBpIG9mIHRoaXMucmFuZG9tLmlzaHVmZmxlKHNlcShhLmdyaWQuZGF0YS5sZW5ndGgpKSkge1xuICAgIC8vICAgY29uc3QgYyA9IGEuZ3JpZC5jb29yZChpIGFzIEdyaWRJbmRleCk7XG4gICAgLy8gICBpZiAoISgoYyBeIChjID4+IDgpKSAmIDgpKSBjb250aW51ZTsgLy8gb25seSBsb29rIGF0IGVkZ2VzXG4gICAgLy8gICBpZiAoIWEuZ3JpZC5kYXRhW2ldKSBjb250aW51ZTtcbiAgICAvLyB9XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgZmlsbEdyaWQoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgbGV0IHJlc3VsdDogUmVzdWx0PHZvaWQ+O1xuICAgIGlmICgocmVzdWx0ID0gdGhpcy5pbml0aWFsRmlsbChhKSksICFyZXN1bHQub2spIHJldHVybiByZXN1bHQ7XG4gICAgaWYgKChyZXN1bHQgPSB0aGlzLmFkZEVkZ2VzKGEpKSwgIXJlc3VsdC5vaykgcmV0dXJuIHJlc3VsdDtcbiAgICBpZiAoKHJlc3VsdCA9IHRoaXMucmVmaW5lKGEpKSwgIXJlc3VsdC5vaykgcmV0dXJuIHJlc3VsdDtcbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICAvLyBGbGlnaHQgbWF5IGJlIHJlcXVpcmVkIGZvciBhbnl0aGluZy5cbiAgY2hlY2tNZXRhKG1ldGE6IE1ldGFsb2NhdGlvbiwgcmVwPzogTWFwPFBvcywgTWV0YXNjcmVlbj4pIHtcbiAgICBjb25zdCBwYXJ0cyA9IG1ldGEudHJhdmVyc2UocmVwID8ge3dpdGg6IHJlcH0gOiB7fSk7XG4gICAgY29uc3QgYWxsU3RhaXJzOiBudW1iZXJbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgZWRnZXMgb2YgbmV3IFNldChwYXJ0cy52YWx1ZXMoKSkpIHtcbiAgICAgIGxldCBzdGFpcnMgPSAwO1xuICAgICAgZm9yIChjb25zdCBlZGdlIG9mIG5ldyBTZXQoWy4uLmVkZ2VzXSkpIHtcbiAgICAgICAgLy8gTk9URTogcG9zIGNhbiBiZSBvZmYgdGhlIHJpZ2h0IG9yIGJvdHRvbSBlZGdlXG4gICAgICAgIGlmIChtZXRhLmV4aXRUeXBlKGVkZ2UpKSBzdGFpcnMrKztcbiAgICAgIH1cbiAgICAgIGFsbFN0YWlycy5wdXNoKHN0YWlycyk7XG4gICAgfVxuICAgIHJldHVybiBhbGxTdGFpcnMuZmlsdGVyKHMgPT4gcyA+IDApLmxlbmd0aCA9PT0gMTtcbiAgfVxuXG4gIHJlZmluZU1ldGFzY3JlZW5zKGE6IEEsIG1ldGE6IE1ldGFsb2NhdGlvbik6IFJlc3VsdDx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmNoZWNrTWV0YShtZXRhKSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBpbml0aWFsIGNoZWNrTWV0YWB9O1xuICAgIGNvbnN0IHJlc3VsdCA9IHN1cGVyLnJlZmluZU1ldGFzY3JlZW5zKGEsIG1ldGEpO1xuICAgIGlmICghcmVzdWx0Lm9rKSByZXR1cm4gcmVzdWx0O1xuXG4gICAgLy8gQ2hlY2sgdGhhdCBmbGlnaHQgaXMgcmVxdWlyZWQgZm9yIHNvbWUgdGlsZS5cbiAgICAvLyBUT0RPIC0gYmlhcyBhIFBPSSB0byBiZSBvbiB0aGF0IHRpbGUhXG4gICAgZnVuY3Rpb24gYWNjZXNzaWJsZShtYXA6IE1hcDxudW1iZXIsIFNldDxudW1iZXI+Pik6IG51bWJlciB7XG4gICAgICBsZXQgY291bnQgPSAwO1xuICAgICAgZm9yIChjb25zdCBzZXQgb2YgbmV3IFNldChtYXAudmFsdWVzKCkpKSB7XG4gICAgICAgIGZvciAoY29uc3QgZWRnZSBvZiBzZXQpIHtcbiAgICAgICAgICBpZiAobWV0YS5leGl0VHlwZShlZGdlKSkge1xuICAgICAgICAgICAgY291bnQgKz0gc2V0LnNpemU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBjb3VudDtcbiAgICB9XG4gICAgY29uc3QgcGFydHMxID0gYWNjZXNzaWJsZShtZXRhLnRyYXZlcnNlKCkpO1xuICAgIGNvbnN0IHBhcnRzMiA9IGFjY2Vzc2libGUobWV0YS50cmF2ZXJzZSh7ZmxpZ2h0OiB0cnVlfSkpO1xuICAgIGlmIChwYXJ0czEgPT09IHBhcnRzMikgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBmbGlnaHQgbm90IHJlcXVpcmVkYH07XG5cbiAgICByZXR1cm4gT0s7XG4gIH1cbn1cbiJdfQ==