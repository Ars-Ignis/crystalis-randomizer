import { Monogrid, Cursor } from './monogrid.js';
import { OK } from './maze.js';
import { TwoStageCaveShuffle } from './twostage.js';
export class RiverCaveShuffle extends TwoStageCaveShuffle {
    constructor() {
        super(...arguments);
        this.early = 'r';
        this.maxAttempts = 250;
    }
    targetEarly() { var _a, _b; return (_b = (_a = this.params.features) === null || _a === void 0 ? void 0 : _a.river) !== null && _b !== void 0 ? _b : 0; }
    preinfer(a) {
        if ([...this.orig.exits()].length < 2)
            return OK;
        const override = new Map();
        for (let i = 0; i < a.grid.data.length; i++) {
            if (a.grid.data[i] === 'r')
                override.set(a.grid.coord(i), '');
        }
        const parts = a.grid.partition(override);
        const stairParts = [];
        for (let i = 0; i < a.grid.data.length; i++) {
            if (a.grid.data[i] === '<' || a.grid.data[i] === '>' ||
                (a.grid.data[i] && a.grid.isBorder(a.grid.coord(i)))) {
                stairParts.push(parts.get(a.grid.coord(i)));
            }
        }
        if (new Set(stairParts).size < stairParts.length) {
            return { ok: false, fail: `river didn't matter` };
        }
        return super.preinfer(a);
    }
    addLateFeatures(a) {
        return OK;
    }
    addArenas(a, arenas) {
        if (!arenas)
            return true;
        const g = a.grid;
        for (const c of this.random.ishuffle(a.grid.screens())) {
            const middle = (c | 0x808);
            const left = (middle - 8);
            const left2 = (left - 8);
            const right = (middle + 8);
            const right2 = (right + 8);
            const up = middle - 0x800;
            const down = middle + 0x800;
            if (g.get(middle) !== 'c')
                continue;
            if (g.get(up) !== 'c')
                continue;
            if (g.get(down) !== 'c')
                continue;
            const leftTile = g.isBorder(left) ? '' : this.extract(g, left2 - 0x808);
            const rightTile = g.isBorder(right) ? '' : this.extract(g, right2 - 0x808);
            if (/[^ c]/.test(leftTile + rightTile))
                continue;
            if (!g.isBorder(left)) {
                g.set(left, '');
                g.set(left2, '');
                g.set(left2 - 8, '');
                g.set(left2 - 0x800, '');
                g.set(left2 + 0x800, '');
            }
            if (!g.isBorder(right)) {
                g.set(right, '');
                g.set(right2, '');
                g.set(right2 + 8, '');
                g.set(right2 - 0x800, '');
                g.set(right2 + 0x800, '');
            }
            a.fixed.add(middle);
            a.fixed.add(up);
            a.fixed.add(down);
            g.set(middle, 'a');
            arenas--;
            if (!arenas) {
                this.pruneDisconnected(a);
                return true;
            }
        }
        return false;
    }
}
export class WaterfallRiverCaveShuffle extends RiverCaveShuffle {
    constructor() {
        super(...arguments);
        this.addBlocks = false;
    }
    initialFillEarly(a) {
        const g = new Monogrid(a.h, a.w, this.getValidEarlyScreens());
        const x0 = 2 + this.random.nextInt(a.w - 4);
        const x1 = 2 + this.random.nextInt(a.w - 4);
        const c = new Cursor(g, a.h - 1, x1);
        c.go(0);
        c.directedPath(this.random, 1, x0);
        c.go(0);
        a.grid.data = g.toGrid('r').data;
        this.addAllFixed(a);
        return OK;
    }
    addEdges(a) {
        let r = -1;
        const h = (a.h - 1) << 12 | 0x808;
        for (let x = 0; x < a.w; x++) {
            if (a.grid.get((h | (x << 4))) === 'r')
                r = x;
        }
        if (r < 0)
            throw new Error(`no river on bottom edge`);
        const c0 = (h | this.random.nextInt(r) << 4);
        const c1 = (h | (r + 1 + this.random.nextInt(a.w - 1 - r)) << 4);
        a.grid.set(c0, '>');
        a.grid.set(c0 - 8, '');
        a.grid.set(c0 + 8, '');
        a.grid.set(c1, '>');
        a.grid.set(c1 - 8, '');
        a.grid.set(c1 + 8, '');
        a.fixed.add(c0);
        a.fixed.add(c1);
        return OK;
    }
    addStairs() { return OK; }
    checkMeta(meta, repl) {
        const opts = repl ? { flight: true, with: repl } : { flight: true };
        const parts = meta.traverse(opts);
        return new Set(parts.values()).size === this.maxPartitions;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicml2ZXJjYXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL21hemUvcml2ZXJjYXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBVSxFQUFFLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHdkMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSXBELE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxtQkFBbUI7SUFBekQ7O1FBWUUsVUFBSyxHQUFHLEdBQUcsQ0FBQztRQUNaLGdCQUFXLEdBQUcsR0FBRyxDQUFDO0lBNkhwQixDQUFDO0lBMUhDLFdBQVcsaUJBQUssbUJBQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLDBDQUFFLEtBQUssbUNBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQTJDMUQsUUFBUSxDQUFDLENBQUk7UUFFWCxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUM7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUNqRCxNQUFNLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBcUIsQ0FBQztRQUM5QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQWMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3hELElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRztnQkFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQy9EO1FBQ0QsTUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxT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QUFDO1FBQ3BDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFjLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3BCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFjLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQWMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNoQixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNoQixPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFRCxTQUFTLEtBQW1CLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUV4QyxTQUFTLENBQUMsSUFBa0IsRUFBRSxJQUEyQjtRQUN2RCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDO1FBQ2hFLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM3RCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYXZlU2h1ZmZsZUF0dGVtcHQgfSBmcm9tICcuL2NhdmUuanMnO1xuaW1wb3J0IHsgR3JpZENvb3JkLCBHcmlkSW5kZXggfSBmcm9tICcuL2dyaWQuanMnO1xuaW1wb3J0IHsgTW9ub2dyaWQsIEN1cnNvciB9IGZyb20gJy4vbW9ub2dyaWQuanMnO1xuaW1wb3J0IHsgUmVzdWx0LCBPSyB9IGZyb20gJy4vbWF6ZS5qcyc7XG5pbXBvcnQgeyBNZXRhbG9jYXRpb24sIFBvcyB9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgTWV0YXNjcmVlbiB9IGZyb20gJy4uL3JvbS9tZXRhc2NyZWVuLmpzJztcbmltcG9ydCB7IFR3b1N0YWdlQ2F2ZVNodWZmbGUgfSBmcm9tICcuL3R3b3N0YWdlLmpzJztcblxudHlwZSBBID0gQ2F2ZVNodWZmbGVBdHRlbXB0O1xuXG5leHBvcnQgY2xhc3MgUml2ZXJDYXZlU2h1ZmZsZSBleHRlbmRzIFR3b1N0YWdlQ2F2ZVNodWZmbGUge1xuICAvLyBiYXNpYyBwcm9ibGVtOiBtaXNzaW5nIHwtIGFuZCAtfCBwaWVjZXMuXG4gIC8vICBvbmUgc29sdXRpb24gd291bGQgYmUgdG8ganVzdCBhZGQgdGhlbVxuICAvLyAgb3V0c2lkZSBvZiB0aGF0LCB3ZSBuZWVkIHRvIHN3aXRjaCB0byBhIHBhdGhnZW4gYWxnbyByYXRoZXJcbiAgLy8gIHRoYW4gcmVmaW5lbWVudFxuXG4gIC8vIHNpbXBsZSBwYXRoZ2VuIHNob3VsZCBiZSBwcmV0dHkgZWFzeSB3LyBncmlkXG5cbiAgLy8gYWx0ZXJuYXRpdmVseSwgdHJpYWwgcmVtb3ZhbHMgYXJlIGZ1cnRoZXItcmVhY2hpbmc/XG4gIC8vICAtIGlmIHdlIHJlbW92ZSBhIGhvcml6b250YWwgZWRnZSB0aGVuIGFsc28gcmVtb3ZlIHRoZVxuICAvLyAgICBvcHBvc2l0ZSBlZGdlcyBvZiBhbnkgbmVpZ2hib3JzLCBjb250aW51aW5nLlxuICAvLyAgLSBvciByZW1vdmUgYSB2ZXJ0aWNhbCBlZGdlIG9mIG9uZS4uLj9cbiAgZWFybHkgPSAncic7XG4gIG1heEF0dGVtcHRzID0gMjUwO1xuICB2YWxpZFJpdmVyU2NyZWVucz86IFNldDxudW1iZXI+O1xuXG4gIHRhcmdldEVhcmx5KCkgeyByZXR1cm4gdGhpcy5wYXJhbXMuZmVhdHVyZXM/LnJpdmVyID8/IDA7IH1cblxuICAvLyBhZGRFYXJseUZlYXR1cmVzKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAvLyAgIC8vIGZpbGwgd2l0aCByaXZlciBhbmQgdGhlbiByZWZpbmUgZG93biB0byB0aGUgY29ycmVjdCBzaXplLlxuICAvLyAgIC8vdGhpcy5maWxsQ2F2ZShcbiAgLy8gICByZXR1cm5cbiAgLy8gfVxuXG4gIC8vIGNhblJlbW92ZShjOiBzdHJpbmcpIHtcbiAgLy8gICByZXR1cm4gYyA9PT0gJ2MnIHx8IGMgPT09ICdyJztcbiAgLy8gfVxuXG4gIC8vIHJlbW92YWxNYXAoYTogQSwgY29vcmQ6IEdyaWRDb29yZCk6IE1hcDxHcmlkQ29vcmQsIHN0cmluZz4ge1xuICAvLyAgIGlmICgoY29vcmQgJiAweDgwOCkgIT09IDB4ODAwKSByZXR1cm4gbmV3IE1hcChbW2Nvb3JkLCAnJ11dKTtcbiAgLy8gICAvLyBuZWVkIHRvIGJlIGEgbGl0dGxlIGNsZXZlcmVyOiBob3Jpem9udGFsIGJyYW5jaGVzIGFyZSBub3RcbiAgLy8gICAvLyBhbGxvd2VkICh0aG91Z2ggd2UgY291bGQgYWRkIHRoZW0sIGluIHdoaWNoIGNhc2UgdGhpcyBnZXRzXG4gIC8vICAgLy8gYSBsb3QgZWFzaWVyKSwgc28gZW5zdXJlIHdlJ3JlIGxlZnQgd2l0aCBhIGJlbmQgaW5zdGVhZC5cbiAgLy8gICBjb25zdCBtYXAgPSBuZXcgTWFwKFtbY29vcmQsICcnXV0pO1xuICAvLyAgIGNvbnN0IGxlZnQgPSBjb29yZCAtIDggYXMgR3JpZENvb3JkO1xuICAvLyAgIGlmIChhLmdyaWQuZ2V0KGxlZnQpID09PSAncicpIHtcbiAgLy8gICAgIGNvbnN0IGxlZnRVcCA9IGxlZnQgLSAweDgwMCBhcyBHcmlkQ29vcmQ7XG4gIC8vICAgICBjb25zdCBsZWZ0RG93biA9IGxlZnQgKyAweDgwMCBhcyBHcmlkQ29vcmQ7XG4gIC8vICAgICBjb25zdCBsZWZ0TGVmdCA9IGxlZnQgLSA4IGFzIEdyaWRDb29yZDtcbiAgLy8gICAgIC8vIG1heSBuZWVkIHRvIHJlbW92ZSBhbm90aGVyIG5laWdoYm9yLlxuICAvLyAgICAgaWYgKGEuZ3JpZC5nZXQobGVmdFVwKSA9PT0gJ3InICYmIGEuZ3JpZC5nZXQobGVmdERvd24pID09PSAncicgJiZcbiAgLy8gICAgICAgICBhLmdyaWQuZ2V0KGxlZnRMZWZ0KSA9PT0gJ3InKSB7XG4gIC8vICAgICAgIG1hcC5zZXQodGhpcy5yYW5kb20ubmV4dEludCgyKSA/IGxlZnRVcCA6IGxlZnREb3duLCAnJyk7XG4gIC8vICAgICB9XG4gIC8vICAgfVxuICAvLyAgIGNvbnN0IHJpZ2h0ID0gY29vcmQgKyA4IGFzIEdyaWRDb29yZDtcbiAgLy8gICBpZiAoYS5ncmlkLmdldChyaWdodCkgPT09ICdyJykge1xuICAvLyAgICAgY29uc3QgcmlnaHRVcCA9IHJpZ2h0IC0gMHg4MDAgYXMgR3JpZENvb3JkO1xuICAvLyAgICAgY29uc3QgcmlnaHREb3duID0gcmlnaHQgKyAweDgwMCBhcyBHcmlkQ29vcmQ7XG4gIC8vICAgICBjb25zdCByaWdodFJpZ2h0ID0gcmlnaHQgKyA4IGFzIEdyaWRDb29yZDtcbiAgLy8gICAgIC8vIG1heSBuZWVkIHRvIHJlbW92ZSBhbm90aGVyIG5laWdoYm9yLlxuICAvLyAgICAgaWYgKGEuZ3JpZC5nZXQocmlnaHRVcCkgPT09ICdyJyAmJiBhLmdyaWQuZ2V0KHJpZ2h0RG93bikgPT09ICdyJyAmJlxuICAvLyAgICAgICAgIGEuZ3JpZC5nZXQocmlnaHRSaWdodCkgPT09ICdyJykge1xuICAvLyAgICAgICBtYXAuc2V0KHRoaXMucmFuZG9tLm5leHRJbnQoMikgPyByaWdodFVwIDogcmlnaHREb3duLCAnJyk7XG4gIC8vICAgICB9XG4gIC8vICAgfVxuICAvLyAgIHJldHVybiBtYXA7XG4gIC8vIH1cblxuICBwcmVpbmZlcihhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBNYWtlIHN1cmUgcml2ZXIgaXMgYWN0dWFsbHkgbmVjZXNzYXJ5IVxuICAgIGlmIChbLi4udGhpcy5vcmlnLmV4aXRzKCldLmxlbmd0aCA8IDIpIHJldHVybiBPSztcbiAgICBjb25zdCBvdmVycmlkZSA9IG5ldyBNYXA8R3JpZENvb3JkLCBzdHJpbmc+KCk7XG4gICAgZm9yIChsZXQgaSA9IDAgYXMgR3JpZEluZGV4OyBpIDwgYS5ncmlkLmRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChhLmdyaWQuZGF0YVtpXSA9PT0gJ3InKSBvdmVycmlkZS5zZXQoYS5ncmlkLmNvb3JkKGkpLCAnJyk7XG4gICAgfVxuICAgIGNvbnN0IHBhcnRzID0gYS5ncmlkLnBhcnRpdGlvbihvdmVycmlkZSk7XG4gICAgY29uc3Qgc3RhaXJQYXJ0czogdW5rbm93bltdID0gW107XG4gICAgZm9yIChsZXQgaSA9IDAgYXMgR3JpZEluZGV4OyBpIDwgYS5ncmlkLmRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChhLmdyaWQuZGF0YVtpXSA9PT0gJzwnIHx8IGEuZ3JpZC5kYXRhW2ldID09PSAnPicgfHxcbiAgICAgICAgICAoYS5ncmlkLmRhdGFbaV0gJiYgYS5ncmlkLmlzQm9yZGVyKGEuZ3JpZC5jb29yZChpKSkpKSB7XG4gICAgICAgIHN0YWlyUGFydHMucHVzaChwYXJ0cy5nZXQoYS5ncmlkLmNvb3JkKGkpKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChuZXcgU2V0KHN0YWlyUGFydHMpLnNpemUgPCBzdGFpclBhcnRzLmxlbmd0aCkge1xuICAgICAgLy9jb25zb2xlLmVycm9yKGEuZ3JpZC5zaG93KCkpO1xuICAgICAgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGByaXZlciBkaWRuJ3QgbWF0dGVyYH07XG4gICAgfVxuICAgIHJldHVybiBzdXBlci5wcmVpbmZlcihhKTtcbiAgfVxuXG4gIGFkZExhdGVGZWF0dXJlcyhhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBjb25zb2xlLmVycm9yKGEuZ3JpZC5zaG93KCkpO1xuICAgIC8vIHJldHVybiBzdXBlci5hZGRMYXRlRmVhdHVyZXMoYSk7XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgYWRkQXJlbmFzKGE6IEEsIGFyZW5hczogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgLy8gVGhpcyB2ZXJzaW9uIHdvcmtzIGEgbGl0dGxlIGRpZmZlcmVudGx5LCBzaW5jZSBpdCBydW5zIGFzIGFuIGVhcmx5XG4gICAgLy8gZmVhdHVyZSAoYmVmb3JlIHJlZmluZW1lbnQpIHJhdGhlciB0aGFuIGxhdGUuICBXZSBsb29rIGZvciBhIDN4MVxuICAgIC8vIGJsb2NrIG9mICdjJyBzY3JlZW5zLCB6ZXJvIG91dCBhbGwgYnV0IHRoZSBtaWRkbGUgKHdoaWNoIGdldHMgdGhlXG4gICAgLy8gYXJlbmEpLCBhbmQgdGhlbiBhZnRlcndhcmRzIHdlIHBydW5lIGF3YXkgYW55IG5ld2x5LWRpc2Nvbm5lY3RlZFxuICAgIC8vIGxhbmQgc2NyZWVucy5cbiAgICBpZiAoIWFyZW5hcykgcmV0dXJuIHRydWU7XG4gICAgY29uc3QgZyA9IGEuZ3JpZDtcbiAgICBmb3IgKGNvbnN0IGMgb2YgdGhpcy5yYW5kb20uaXNodWZmbGUoYS5ncmlkLnNjcmVlbnMoKSkpIHtcbiAgICAgIGNvbnN0IG1pZGRsZSA9IChjIHwgMHg4MDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IGxlZnQgPSAobWlkZGxlIC0gOCkgYXMgR3JpZENvb3JkO1xuICAgICAgY29uc3QgbGVmdDIgPSAobGVmdCAtIDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHJpZ2h0ID0gKG1pZGRsZSArIDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHJpZ2h0MiA9IChyaWdodCArIDgpIGFzIEdyaWRDb29yZDtcbiAgICAgIGNvbnN0IHVwID0gbWlkZGxlIC0gMHg4MDAgYXMgR3JpZENvb3JkO1xuICAgICAgY29uc3QgZG93biA9IG1pZGRsZSArIDB4ODAwIGFzIEdyaWRDb29yZDtcbiAgICAgIGlmIChnLmdldChtaWRkbGUpICE9PSAnYycpIGNvbnRpbnVlO1xuICAgICAgaWYgKGcuZ2V0KHVwKSAhPT0gJ2MnKSBjb250aW51ZTtcbiAgICAgIGlmIChnLmdldChkb3duKSAhPT0gJ2MnKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IGxlZnRUaWxlID1cbiAgICAgICAgICBnLmlzQm9yZGVyKGxlZnQpID8gJycgOiB0aGlzLmV4dHJhY3QoZywgbGVmdDIgLSAweDgwOCBhcyBHcmlkQ29vcmQpO1xuICAgICAgY29uc3QgcmlnaHRUaWxlID1cbiAgICAgICAgICBnLmlzQm9yZGVyKHJpZ2h0KSA/ICcnIDogdGhpcy5leHRyYWN0KGcsIHJpZ2h0MiAtIDB4ODA4IGFzIEdyaWRDb29yZCk7XG4gICAgICBpZiAoL1teIGNdLy50ZXN0KGxlZnRUaWxlICsgcmlnaHRUaWxlKSkgY29udGludWU7XG4gICAgICBpZiAoIWcuaXNCb3JkZXIobGVmdCkpIHtcbiAgICAgICAgZy5zZXQobGVmdCwgJycpO1xuICAgICAgICBnLnNldChsZWZ0MiwgJycpO1xuICAgICAgICBnLnNldChsZWZ0MiAtIDggYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgICAgIGcuc2V0KGxlZnQyIC0gMHg4MDAgYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgICAgIGcuc2V0KGxlZnQyICsgMHg4MDAgYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgICB9XG4gICAgICBpZiAoIWcuaXNCb3JkZXIocmlnaHQpKSB7XG4gICAgICAgIGcuc2V0KHJpZ2h0LCAnJyk7XG4gICAgICAgIGcuc2V0KHJpZ2h0MiwgJycpO1xuICAgICAgICBnLnNldChyaWdodDIgKyA4IGFzIEdyaWRDb29yZCwgJycpO1xuICAgICAgICBnLnNldChyaWdodDIgLSAweDgwMCBhcyBHcmlkQ29vcmQsICcnKTtcbiAgICAgICAgZy5zZXQocmlnaHQyICsgMHg4MDAgYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgICB9XG4gICAgICBhLmZpeGVkLmFkZChtaWRkbGUpO1xuICAgICAgYS5maXhlZC5hZGQodXApO1xuICAgICAgYS5maXhlZC5hZGQoZG93bik7XG4gICAgICBnLnNldChtaWRkbGUsICdhJyk7XG4gICAgICBhcmVuYXMtLTtcbiAgICAgIGlmICghYXJlbmFzKSB7XG4gICAgICAgIHRoaXMucHJ1bmVEaXNjb25uZWN0ZWQoYSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICAvL2NvbnNvbGUuZXJyb3IoJ2NvdWxkIG5vdCBhZGQgYXJlbmEnKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFdhdGVyZmFsbFJpdmVyQ2F2ZVNodWZmbGUgZXh0ZW5kcyBSaXZlckNhdmVTaHVmZmxlIHtcblxuICBhZGRCbG9ja3MgPSBmYWxzZTtcblxuICBpbml0aWFsRmlsbEVhcmx5KGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGNvbnN0IGcgPSBuZXcgTW9ub2dyaWQoYS5oLCBhLncsIHRoaXMuZ2V0VmFsaWRFYXJseVNjcmVlbnMoKSk7XG4gICAgY29uc3QgeDAgPSAyICsgdGhpcy5yYW5kb20ubmV4dEludChhLncgLSA0KTtcbiAgICBjb25zdCB4MSA9IDIgKyB0aGlzLnJhbmRvbS5uZXh0SW50KGEudyAtIDQpO1xuICAgIGNvbnN0IGMgPSBuZXcgQ3Vyc29yKGcsIGEuaCAtIDEsIHgxKTtcbiAgICBjLmdvKDApO1xuICAgIGMuZGlyZWN0ZWRQYXRoKHRoaXMucmFuZG9tLCAxLCB4MCk7XG4gICAgYy5nbygwKTtcblxuICAgIGEuZ3JpZC5kYXRhID0gZy50b0dyaWQoJ3InKS5kYXRhO1xuICAgIHRoaXMuYWRkQWxsRml4ZWQoYSk7XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgYWRkRWRnZXMoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgbGV0IHIgPSAtMTtcbiAgICBjb25zdCBoID0gKGEuaCAtIDEpIDw8IDEyIHwgMHg4MDg7XG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCBhLnc7IHgrKykge1xuICAgICAgaWYgKGEuZ3JpZC5nZXQoKGggfCAoeCA8PCA0KSkgYXMgR3JpZENvb3JkKSA9PT0gJ3InKSByID0geDtcbiAgICB9XG4gICAgaWYgKHIgPCAwKSB0aHJvdyBuZXcgRXJyb3IoYG5vIHJpdmVyIG9uIGJvdHRvbSBlZGdlYCk7XG4gICAgY29uc3QgYzAgPSAoaCB8IHRoaXMucmFuZG9tLm5leHRJbnQocikgPDwgNCkgYXMgR3JpZENvb3JkO1xuICAgIGNvbnN0IGMxID1cbiAgICAgICAgKGggfCAociArIDEgKyB0aGlzLnJhbmRvbS5uZXh0SW50KGEudyAtIDEgLSByKSkgPDwgNCkgYXMgR3JpZENvb3JkO1xuICAgIGEuZ3JpZC5zZXQoYzAsICc+Jyk7XG4gICAgYS5ncmlkLnNldChjMCAtIDggYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgYS5ncmlkLnNldChjMCArIDggYXMgR3JpZENvb3JkLCAnJyk7XG4gICAgYS5ncmlkLnNldChjMSwgJz4nKTtcbiAgICBhLmdyaWQuc2V0KGMxIC0gOCBhcyBHcmlkQ29vcmQsICcnKTtcbiAgICBhLmdyaWQuc2V0KGMxICsgOCBhcyBHcmlkQ29vcmQsICcnKTtcbiAgICBhLmZpeGVkLmFkZChjMCk7XG4gICAgYS5maXhlZC5hZGQoYzEpO1xuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGFkZFN0YWlycygpOiBSZXN1bHQ8dm9pZD4geyByZXR1cm4gT0s7IH1cblxuICBjaGVja01ldGEobWV0YTogTWV0YWxvY2F0aW9uLCByZXBsPzogTWFwPFBvcywgTWV0YXNjcmVlbj4pOiBib29sZWFuIHtcbiAgICBjb25zdCBvcHRzID0gcmVwbCA/IHtmbGlnaHQ6IHRydWUsIHdpdGg6IHJlcGx9IDoge2ZsaWdodDogdHJ1ZX07XG4gICAgY29uc3QgcGFydHMgPSBtZXRhLnRyYXZlcnNlKG9wdHMpO1xuICAgIHJldHVybiBuZXcgU2V0KHBhcnRzLnZhbHVlcygpKS5zaXplID09PSB0aGlzLm1heFBhcnRpdGlvbnM7XG4gIH1cbn1cbiJdfQ==