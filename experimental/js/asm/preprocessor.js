import { Define } from './define.js';
import { Expr } from './expr.js';
import { Macro } from './macro.js';
import { Token, TokenSource } from './token.js';
const MAX_STACK_DEPTH = 100;
const ID_MAP = new WeakMap();
function idGen(env) {
    let id = ID_MAP.get(env);
    if (!id)
        ID_MAP.set(env, id = (num => ({ next: () => num++ }))(0));
    return id;
}
export class Preprocessor extends TokenSource.Abstract {
    constructor(stream, env, parent) {
        super();
        this.stream = stream;
        this.env = env;
        this.repeats = [];
        this.runDirectives = {
            '.define': (line) => this.parseDefine(line),
            '.undefine': (line) => this.parseUndefine(line),
            '.else': ([cs]) => badClose('.if', cs),
            '.elseif': ([cs]) => badClose('.if', cs),
            '.endif': ([cs]) => badClose('.if', cs),
            '.endmac': ([cs]) => badClose('.macro', cs),
            '.endmacro': ([cs]) => badClose('.macro', cs),
            '.endrep': (line) => this.parseEndRepeat(line),
            '.endrepeat': (line) => this.parseEndRepeat(line),
            '.exitmacro': ([, a]) => { noGarbage(a); this.stream.exit(); },
            '.if': ([cs, ...args]) => this.parseIf(!!this.evaluateConst(parseOneExpr(args, cs))),
            '.ifdef': ([cs, ...args]) => this.parseIf(this.macros.has(parseOneIdent(args, cs))),
            '.ifndef': ([cs, ...args]) => this.parseIf(!this.macros.has(parseOneIdent(args, cs))),
            '.ifblank': ([, ...args]) => this.parseIf(!args.length),
            '.ifnblank': ([, ...args]) => this.parseIf(!!args.length),
            '.ifref': ([cs, ...args]) => this.parseIf(this.env.referencedSymbol(parseOneIdent(args, cs))),
            '.ifnref': ([cs, ...args]) => this.parseIf(!this.env.referencedSymbol(parseOneIdent(args, cs))),
            '.ifsym': ([cs, ...args]) => this.parseIf(this.env.definedSymbol(parseOneIdent(args, cs))),
            '.ifnsym': ([cs, ...args]) => this.parseIf(!this.env.definedSymbol(parseOneIdent(args, cs))),
            '.ifconst': ([cs, ...args]) => this.parseIf(this.env.constantSymbol(parseOneIdent(args, cs))),
            '.ifnconst': ([cs, ...args]) => this.parseIf(!this.env.constantSymbol(parseOneIdent(args, cs))),
            '.macro': (line) => this.parseMacro(line),
            '.repeat': (line) => this.parseRepeat(line),
        };
        this.macros = parent ? parent.macros : new Map();
    }
    *pump() {
        const line = this.readLine();
        if (line == null)
            return void (yield line);
        while (line.length) {
            const front = line[0];
            switch (front.token) {
                case 'ident':
                    if (Token.eq(line[1], Token.COLON)) {
                        yield line.splice(0, 2);
                        break;
                    }
                    if (!this.tryExpandMacro(line))
                        yield line;
                    return;
                case 'cs':
                    if (!this.tryRunDirective(line))
                        yield line;
                    return;
                case 'op':
                    if (/^[-+]+$/.test(front.str)) {
                        const label = [front];
                        const second = line[1];
                        if (second && Token.eq(second, Token.COLON)) {
                            label.push(second);
                            line.splice(0, 2);
                        }
                        else {
                            label.push({ token: 'op', str: ':' });
                            line.splice(0, 1);
                        }
                        yield label;
                        break;
                    }
                    else if (front.str === ':') {
                        yield line.splice(0, 1);
                        break;
                    }
                default:
                    throw new Error(`Unexpected: ${Token.nameAt(line[0])}`);
            }
        }
    }
    readLine() {
        const line = this.stream.next();
        if (line == null)
            return line;
        return this.expandLine(line);
    }
    expandLine(line, pos = 0) {
        const front = line[0];
        let depth = 0;
        let maxPos = 0;
        while (pos < line.length) {
            if (pos > maxPos) {
                maxPos = pos;
                depth = 0;
            }
            else if (depth++ > MAX_STACK_DEPTH) {
                throw new Error(`Maximum expansion depth reached: ${line.map(Token.name).join(' ')}${Token.at(front)}`);
            }
            pos = this.expandToken(line, pos);
        }
        return line;
    }
    expandToken(line, pos) {
        const front = line[pos];
        if (front.token === 'ident') {
            const define = this.macros.get(front.str);
            if (define instanceof Define) {
                const overflow = define.expand(line, pos);
                if (overflow) {
                    if (overflow.length)
                        this.stream.unshift(...overflow);
                    return pos;
                }
            }
        }
        else if (front.token === 'cs') {
            return this.expandDirective(front.str, line, pos);
        }
        return pos + 1;
    }
    tryExpandMacro(line) {
        const [first] = line;
        if (first.token !== 'ident')
            throw new Error(`impossible`);
        const macro = this.macros.get(first.str);
        if (!(macro instanceof Macro))
            return false;
        const expansion = macro.expand(line, idGen(this.env));
        this.stream.enter();
        this.stream.unshift(...expansion);
        return true;
    }
    expandDirective(directive, line, i) {
        switch (directive) {
            case '.define':
            case '.ifdef':
            case '.ifndef':
            case '.undefine':
                return this.skipIdentifier(line, i);
            case '.skip': return this.skip(line, i);
            case '.noexpand': return this.noexpand(line, i);
            case '.tcount': return this.parseArgs(line, i, 1, this.tcount);
            case '.ident': return this.parseArgs(line, i, 1, this.ident);
            case '.string': return this.parseArgs(line, i, 1, this.string);
            case '.concat': return this.parseArgs(line, i, 0, this.concat);
            case '.sprintf': return this.parseArgs(line, i, 0, this.sprintf);
            case '.cond': return this.parseArgs(line, i, 0, this.cond);
            case '.def':
            case '.defined':
                return this.parseArgs(line, i, 1, this.defined);
            case '.definedsymbol':
                return this.parseArgs(line, i, 1, this.definedSymbol);
            case '.constantsymbol':
                return this.parseArgs(line, i, 1, this.constantSymbol);
            case '.referencedsymbol':
                return this.parseArgs(line, i, 1, this.referencedSymbol);
        }
        return i + 1;
    }
    skip(line, i) {
        var _a;
        line.splice(i, 1);
        const skipped = line[i];
        if (((_a = skipped) === null || _a === void 0 ? void 0 : _a.token) === 'grp') {
            this.expandToken(skipped.inner, 0);
        }
        else {
            this.expandToken(line, i + 1);
        }
        return i;
    }
    noexpand(line, i) {
        const skip = line[i + 1];
        if (skip.token === 'grp') {
            line.splice(i, 2, ...skip.inner);
            i += skip.inner.length - 1;
        }
        else {
            line.splice(i, 1);
        }
        return i + 1;
    }
    parseArgs(line, i, argCount, fn) {
        const cs = line[i];
        Token.expect(Token.LP, line[i + 1], cs);
        const end = Token.findBalanced(line, i + 1);
        const args = Token.parseArgList(line, i + 2, end).map(ts => {
            if (ts.length === 1 && ts[0].token === 'grp')
                ts = ts[0].inner;
            return this.expandLine(ts);
        });
        if (argCount && args.length !== argCount) {
            throw new Error(`Expected ${argCount} parameters: ${Token.nameAt(cs)}`);
        }
        const expansion = fn.call(this, cs, ...args);
        line.splice(i, end + 1 - i, ...expansion);
        return i;
    }
    tcount(cs, arg) {
        return [{ token: 'num', num: Token.count(arg), source: cs.source }];
    }
    ident(cs, arg) {
        const str = Token.expectString(arg[0], cs);
        Token.expectEol(arg[1], 'a single token');
        return [{ token: 'ident', str, source: arg[0].source }];
    }
    string(cs, arg) {
        const str = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single token');
        return [{ token: 'str', str, source: arg[0].source }];
    }
    concat(cs, ...args) {
        const strs = args.map(ts => {
            const str = Token.expectString(ts[0]);
            Token.expectEol(ts[1], 'a single string');
            return str;
        });
        return [{ token: 'str', str: strs.join(''), source: cs.source }];
    }
    sprintf(cs, fmtToks, ...args) {
        const fmt = Token.expectString(fmtToks[0], cs);
        Token.expectEol(fmtToks[1], 'a single format string');
        const [] = [fmt];
        throw new Error('unimplemented');
    }
    cond(cs, ...args) {
        throw new Error('unimplemented');
    }
    defined(cs, arg) {
        const ident = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single identifier');
        return [{ token: 'num', num: this.macros.has(ident) ? 1 : 0 }];
    }
    definedSymbol(cs, arg) {
        const ident = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single identifier');
        return [{ token: 'num', num: this.env.definedSymbol(ident) ? 1 : 0 }];
    }
    constantSymbol(cs, arg) {
        const ident = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single identifier');
        return [{ token: 'num', num: this.env.constantSymbol(ident) ? 1 : 0 }];
    }
    referencedSymbol(cs, arg) {
        const ident = Token.expectIdentifier(arg[0], cs);
        Token.expectEol(arg[1], 'a single identifier');
        return [{ token: 'num', num: this.env.referencedSymbol(ident) ? 1 : 0 }];
    }
    skipIdentifier(line, i) {
        var _a;
        return ((_a = line[i + 1]) === null || _a === void 0 ? void 0 : _a.token) === 'ident' ? i + 2 : i + 1;
    }
    tryRunDirective(line) {
        const first = line[0];
        if (first.token !== 'cs')
            throw new Error(`impossible`);
        const handler = this.runDirectives[first.str];
        if (!handler)
            return false;
        handler(line);
        return true;
    }
    evaluateConst(expr) {
        var _a;
        expr = Expr.traversePost(expr, Expr.evaluate);
        if (expr.op === 'num' && !((_a = expr.meta) === null || _a === void 0 ? void 0 : _a.rel))
            return expr.num;
        const at = Token.at(expr);
        throw new Error(`Expected a constant${at}`);
    }
    parseDefine(line) {
        const name = Token.expectIdentifier(line[1], line[0]);
        const define = Define.from(line);
        const prev = this.macros.get(name);
        if (prev instanceof Define) {
            prev.append(define);
        }
        else if (prev) {
            throw new Error(`Already defined: ${name}`);
        }
        else {
            this.macros.set(name, define);
        }
    }
    parseUndefine(line) {
        const [cs, ident, eol] = line;
        const name = Token.expectIdentifier(ident, cs);
        Token.expectEol(eol);
        if (!this.macros.has(name)) {
            throw new Error(`Not defined: ${Token.nameAt(ident)}`);
        }
        this.macros.delete(name);
    }
    parseMacro(line) {
        const name = Token.expectIdentifier(line[1], line[0]);
        const macro = Macro.from(line, this.stream);
        const prev = this.macros.get(name);
        if (prev)
            throw new Error(`Already defined: ${name}`);
        this.macros.set(name, macro);
    }
    parseRepeat(line) {
        var _a;
        const [expr, end] = Expr.parse(line, 1);
        const at = line[1] || line[0];
        if (!expr)
            throw new Error(`Expected expression: ${Token.nameAt(at)}`);
        const times = this.evaluateConst(expr);
        if (times == null)
            throw new Error(`Expected a constant${Token.at(expr)}`);
        let ident;
        if (end < line.length) {
            if (!Token.eq(line[end], Token.COMMA)) {
                throw new Error(`Expected comma: ${Token.nameAt(line[end])}`);
            }
            ident = Token.expectIdentifier(line[end + 1]);
            Token.expectEol(line[end + 2]);
        }
        const lines = [];
        let depth = 1;
        while (depth > 0) {
            line = (_a = this.stream.next(), (_a !== null && _a !== void 0 ? _a : fail(`.repeat with no .endrep`)));
            if (Token.eq(line[0], Token.REPEAT))
                depth++;
            if (Token.eq(line[0], Token.ENDREPEAT))
                depth--;
            if (Token.eq(line[0], Token.ENDREP))
                depth--;
            lines.push(line);
        }
        this.repeats.push([lines, times, -1, ident]);
        this.parseEndRepeat(line);
    }
    parseEndRepeat(line) {
        Token.expectEol(line[1]);
        const top = this.repeats.pop();
        if (!top)
            throw new Error(`.endrep with no .repeat${Token.at(line[0])}`);
        if (++top[2] >= top[1])
            return;
        this.repeats.push(top);
        this.stream.unshift(...top[0].map(line => line.map(token => {
            if (token.token !== 'ident' || token.str !== top[3])
                return token;
            const t = { token: 'num', num: top[2] };
            if (token.source)
                t.source = token.source;
            return t;
        })));
    }
    parseIf(cond) {
        let depth = 1;
        let done = false;
        const result = [];
        while (depth > 0) {
            const line = this.stream.next();
            if (!line)
                throw new Error(`EOF looking for .endif`);
            const front = line[0];
            if (Token.eq(front, Token.ENDIF)) {
                depth--;
                continue;
            }
            else if (depth === 1 && !done) {
                if (cond && (Token.eq(front, Token.ELSE) ||
                    Token.eq(front, Token.ELSEIF))) {
                    cond = false;
                    done = true;
                    continue;
                }
                else if (Token.eq(front, Token.ELSEIF)) {
                    cond = !!this.evaluateConst(parseOneExpr(line.slice(1), front));
                    continue;
                }
                else if (Token.eq(front, Token.ELSE)) {
                    cond = true;
                    continue;
                }
            }
            if (cond)
                result.push(line);
        }
        this.stream.unshift(...result);
    }
}
function parseOneIdent(ts, prev) {
    const e = parseOneExpr(ts, prev);
    return Expr.identifier(e);
}
function parseOneExpr(ts, prev) {
    if (!ts.length) {
        if (!prev)
            throw new Error(`Expected expression`);
        throw new Error(`Expected expression: ${Token.nameAt(prev)}`);
    }
    return Expr.parseOnly(ts);
}
function noGarbage(token) {
    if (token)
        throw new Error(`garbage at end of line: ${Token.nameAt(token)}`);
}
function badClose(open, tok) {
    throw new Error(`${Token.name(tok)} with no ${open}${Token.at(tok)}`);
}
function fail(msg) {
    throw new Error(msg);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL2FzbS9wcmVwcm9jZXNzb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNuQyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQy9CLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDakMsT0FBTyxFQUFDLEtBQUssRUFBRSxXQUFXLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFNOUMsTUFBTSxlQUFlLEdBQUcsR0FBRyxDQUFDO0FBYzVCLE1BQU0sTUFBTSxHQUFHLElBQUksT0FBTyxFQUF5QixDQUFDO0FBQ3BELFNBQVMsS0FBSyxDQUFDLEdBQVE7SUFDckIsSUFBSSxFQUFFLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN6QixJQUFJLENBQUMsRUFBRTtRQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQztBQVdELE1BQU0sT0FBTyxZQUFhLFNBQVEsV0FBVyxDQUFDLFFBQVE7SUFTcEQsWUFBcUIsTUFBbUIsRUFBVyxHQUFRLEVBQy9DLE1BQXFCO1FBQy9CLEtBQUssRUFBRSxDQUFDO1FBRlcsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQUFXLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFMbkQsWUFBTyxHQUFnRCxFQUFFLENBQUM7UUEwUmpELGtCQUFhLEdBQTBDO1lBQ3RFLFNBQVMsRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMs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LFlBQVksSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3hFLENBQUM7QUFFRCxTQUFTLElBQUksQ0FBQyxHQUFXO0lBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGVmaW5lfSBmcm9tICcuL2RlZmluZS5qcyc7XG5pbXBvcnQge0V4cHJ9IGZyb20gJy4vZXhwci5qcyc7XG5pbXBvcnQge01hY3JvfSBmcm9tICcuL21hY3JvLmpzJztcbmltcG9ydCB7VG9rZW4sIFRva2VuU291cmNlfSBmcm9tICcuL3Rva2VuLmpzJztcbmltcG9ydCB7VG9rZW5TdHJlYW19IGZyb20gJy4vdG9rZW5zdHJlYW0uanMnO1xuXG4vLyBUT0RPIC0gZmlndXJlIG91dCBob3cgdG8gYWN0dWFsbHkga2VlcCB0cmFjayBvZiBzdGFjayBkZXB0aD9cbi8vICAtIG1pZ2h0IG5lZWQgdG8gaW5zZXJ0IGEgc3BlY2lhbCB0b2tlbiBhdCB0aGUgZW5kIG9mIGFuIGV4cGFuc2lvblxuLy8gICAgdG8ga25vdyB3aGVuIHRvIHJlbGVhc2UgdGhlIGZyYW1lP1xuY29uc3QgTUFYX1NUQUNLX0RFUFRIID0gMTAwO1xuXG4vLyBpbnRlcmZhY2UgVG9rZW5Tb3VyY2Uge1xuLy8gICBuZXh0KCk6IFRva2VuW107XG4vLyAgIGluY2x1ZGUoZmlsZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPjtcbi8vICAgdW5zaGlmdCguLi5saW5lczogVG9rZW5bXVtdKTogdm9pZDtcbi8vICAgZW50ZXIoKTogdm9pZDtcbi8vICAgZXhpdCgpOiB2b2lkO1xuLy8gICAvL29wdGlvbnMoKTogVG9rZW5pemVyLk9wdGlvbnM7XG4vLyB9XG5cbi8vIFNpbmNlIHRoZSBFbnYgaXMgbW9zdCBjbG9zZWx5IHRpZWQgdG8gdGhlIEFzc2VtYmxlciwgd2UgdGllIHRoZVxuLy8gdW5pcXVlIElEIGdlbmVyYXRpb24gdG8gaXQgYXMgd2VsbCwgd2l0aG91dCBhZGRpbmcgYWRkaXRpb25hbFxuLy8gY29uc3RyYWludHMgb24gdGhlIEFzc2VtYmxlciBBUEkuXG5jb25zdCBJRF9NQVAgPSBuZXcgV2Vha01hcDxFbnYsIHtuZXh0KCk6IG51bWJlcn0+KCk7XG5mdW5jdGlvbiBpZEdlbihlbnY6IEVudik6IHtuZXh0KCk6IG51bWJlcn0ge1xuICBsZXQgaWQgPSBJRF9NQVAuZ2V0KGVudik7XG4gIGlmICghaWQpIElEX01BUC5zZXQoZW52LCBpZCA9IChudW0gPT4gKHtuZXh0OiAoKSA9PiBudW0rK30pKSgwKSk7XG4gIHJldHVybiBpZDtcbn1cblxuaW50ZXJmYWNlIEVudiB7XG4gIC8vIFRoZXNlIG5lZWQgdG8gY29tZSBmcm9tIFByb2Nlc3NvciBhbmQgd2lsbCBkZXBlbmQgb24gc2NvcGUuLi5cbiAgZGVmaW5lZFN5bWJvbChzeW06IHN0cmluZyk6IGJvb2xlYW47XG4gIGNvbnN0YW50U3ltYm9sKHN5bTogc3RyaW5nKTogYm9vbGVhbjtcbiAgcmVmZXJlbmNlZFN5bWJvbChzeW06IHN0cmluZyk6IGJvb2xlYW47XG4gIC8vIGFsc28gd2FudCBtZXRob2RzIHRvIGFwcGx5IHNodW50aW5nIHlhcmQgdG8gdG9rZW4gbGlzdD9cbiAgLy8gIC0gdHVybiBpdCBpbnRvIGEganNvbiB0cmVlLi4uP1xufVxuXG5leHBvcnQgY2xhc3MgUHJlcHJvY2Vzc29yIGV4dGVuZHMgVG9rZW5Tb3VyY2UuQWJzdHJhY3Qge1xuICBwcml2YXRlIHJlYWRvbmx5IG1hY3JvczogTWFwPHN0cmluZywgRGVmaW5lfE1hY3JvPjtcblxuICAvLyBidWlsZHMgdXAgcmVwZWF0aW5nIHRva2Vucy4uLlxuICBwcml2YXRlIHJlcGVhdHM6IEFycmF5PFtUb2tlbltdW10sIG51bWJlciwgbnVtYmVyLCBzdHJpbmc/XT4gPSBbXTtcbiAgLy8gTk9URTogdGhlcmUgaXMgbm8gc2NvcGUgaGVyZS4uLiAtIG5vdCBmb3IgbWFjcm9zXG4gIC8vICAtIG9ubHkgc3ltYm9scyBoYXZlIHNjb3BlXG4gIC8vIFRPRE8gLSBldmFsdWF0ZSBjb25zdGFudHMuLi5cblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBzdHJlYW06IFRva2VuU3RyZWFtLCByZWFkb25seSBlbnY6IEVudixcbiAgICAgICAgICAgICAgcGFyZW50PzogUHJlcHJvY2Vzc29yKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLm1hY3JvcyA9IHBhcmVudCA/IHBhcmVudC5tYWNyb3MgOiBuZXcgTWFwKCk7XG4gIH1cblxuICAvLyBGb3IgdXNlIGFzIGEgdG9rZW4gc291cmNlIGluIHRoZSBuZXh0IHN0YWdlLlxuICAqIHB1bXAoKTogR2VuZXJhdG9yPFRva2VuW118dW5kZWZpbmVkPiB7XG4gICAgY29uc3QgbGluZSA9IHRoaXMucmVhZExpbmUoKTtcbiAgICBpZiAobGluZSA9PSBudWxsKSByZXR1cm4gdm9pZCAoeWllbGQgbGluZSk7IC8vIEVPRlxuICAgIHdoaWxlIChsaW5lLmxlbmd0aCkge1xuICAgICAgY29uc3QgZnJvbnQgPSBsaW5lWzBdO1xuICAgICAgc3dpdGNoIChmcm9udC50b2tlbikge1xuICAgICAgICBjYXNlICdpZGVudCc6XG4gICAgICAgICAgLy8gUG9zc2liaWxpdGllczogKDEpIGxhYmVsLCAoMikgaW5zdHJ1Y3Rpb24vYXNzaWduLCAoMykgbWFjcm9cbiAgICAgICAgICAvLyBMYWJlbHMgZ2V0IHNwbGl0IG91dC4gIFdlIGRvbid0IGRpc3Rpbmd1aXNoIGFzc2lnbnMgeWV0LlxuICAgICAgICAgIGlmIChUb2tlbi5lcShsaW5lWzFdLCBUb2tlbi5DT0xPTikpIHtcbiAgICAgICAgICAgIHlpZWxkIGxpbmUuc3BsaWNlKDAsIDIpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghdGhpcy50cnlFeHBhbmRNYWNybyhsaW5lKSkgeWllbGQgbGluZTtcbiAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY2FzZSAnY3MnOlxuICAgICAgICAgIGlmICghdGhpcy50cnlSdW5EaXJlY3RpdmUobGluZSkpIHlpZWxkIGxpbmU7XG4gICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNhc2UgJ29wJzpcbiAgICAgICAgICAvLyBQcm9iYWJseSBhbiBhbm9ueW1vdXMgbGFiZWwuLi5cbiAgICAgICAgICBpZiAoL15bLStdKyQvLnRlc3QoZnJvbnQuc3RyKSkge1xuICAgICAgICAgICAgY29uc3QgbGFiZWw6IFRva2VuW10gPSBbZnJvbnRdO1xuICAgICAgICAgICAgY29uc3Qgc2Vjb25kID0gbGluZVsxXTtcbiAgICAgICAgICAgIGlmIChzZWNvbmQgJiYgVG9rZW4uZXEoc2Vjb25kLCBUb2tlbi5DT0xPTikpIHtcbiAgICAgICAgICAgICAgbGFiZWwucHVzaChzZWNvbmQpO1xuICAgICAgICAgICAgICBsaW5lLnNwbGljZSgwLCAyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGxhYmVsLnB1c2goe3Rva2VuOiAnb3AnLCBzdHI6ICc6J30pO1xuICAgICAgICAgICAgICBsaW5lLnNwbGljZSgwLCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHlpZWxkIGxhYmVsO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfSBlbHNlIGlmIChmcm9udC5zdHIgPT09ICc6Jykge1xuICAgICAgICAgICAgeWllbGQgbGluZS5zcGxpY2UoMCwgMSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG5cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQ6ICR7VG9rZW4ubmFtZUF0KGxpbmVbMF0pfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIEV4cGFuZCBhIHNpbmdsZSBsaW5lIG9mIHRva2VucyBmcm9tIHRoZSBmcm9udCBvZiB0b2tzLlxuICBwcml2YXRlIHJlYWRMaW5lKCk6IFRva2VuW118dW5kZWZpbmVkIHtcbiAgICAvLyBBcHBseSAuZGVmaW5lIGV4cGFuc2lvbnMgYXMgbmVjZXNzYXJ5LlxuICAgIGNvbnN0IGxpbmUgPSB0aGlzLnN0cmVhbS5uZXh0KCk7XG4gICAgaWYgKGxpbmUgPT0gbnVsbCkgcmV0dXJuIGxpbmU7XG4gICAgcmV0dXJuIHRoaXMuZXhwYW5kTGluZShsaW5lKTtcbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gRVhQQU5TSU9OXG5cbiAgcHJpdmF0ZSBleHBhbmRMaW5lKGxpbmU6IFRva2VuW10sIHBvcyA9IDApOiBUb2tlbltdIHtcbiAgICBjb25zdCBmcm9udCA9IGxpbmVbMF07XG4gICAgbGV0IGRlcHRoID0gMDtcbiAgICBsZXQgbWF4UG9zID0gMDtcbiAgICB3aGlsZSAocG9zIDwgbGluZS5sZW5ndGgpIHtcbiAgICAgIGlmIChwb3MgPiBtYXhQb3MpIHtcbiAgICAgICAgbWF4UG9zID0gcG9zO1xuICAgICAgICBkZXB0aCA9IDA7XG4gICAgICB9IGVsc2UgaWYgKGRlcHRoKysgPiBNQVhfU1RBQ0tfREVQVEgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNYXhpbXVtIGV4cGFuc2lvbiBkZXB0aCByZWFjaGVkOiAke1xuICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmUubWFwKFRva2VuLm5hbWUpLmpvaW4oJyAnKX0ke1Rva2VuLmF0KGZyb250KX1gKTtcbiAgICAgIH1cbiAgICAgIHBvcyA9IHRoaXMuZXhwYW5kVG9rZW4obGluZSwgcG9zKTtcbiAgICB9XG4gICAgcmV0dXJuIGxpbmU7XG4gIH1cblxuICAvKiogUmV0dXJucyB0aGUgbmV4dCBwb3NpdGlvbiB0byBleHBhbmQuICovXG4gIHByaXZhdGUgZXhwYW5kVG9rZW4obGluZTogVG9rZW5bXSwgcG9zOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IGZyb250ID0gbGluZVtwb3NdITtcbiAgICBpZiAoZnJvbnQudG9rZW4gPT09ICdpZGVudCcpIHtcbiAgICAgIGNvbnN0IGRlZmluZSA9IHRoaXMubWFjcm9zLmdldChmcm9udC5zdHIpO1xuICAgICAgaWYgKGRlZmluZSBpbnN0YW5jZW9mIERlZmluZSkge1xuICAgICAgICBjb25zdCBvdmVyZmxvdyA9IGRlZmluZS5leHBhbmQobGluZSwgcG9zKTtcbi8vY29uc29sZS5sb2coJ3Bvc3QtZXhwYW5kJywgbGluZSk7XG4gICAgICAgIGlmIChvdmVyZmxvdykge1xuICAgICAgICAgIGlmIChvdmVyZmxvdy5sZW5ndGgpIHRoaXMuc3RyZWFtLnVuc2hpZnQoLi4ub3ZlcmZsb3cpXG4gICAgICAgICAgcmV0dXJuIHBvcztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZnJvbnQudG9rZW4gPT09ICdjcycpIHtcbiAgICAgIHJldHVybiB0aGlzLmV4cGFuZERpcmVjdGl2ZShmcm9udC5zdHIsIGxpbmUsIHBvcyk7XG4gICAgfVxuICAgIHJldHVybiBwb3MgKyAxO1xuICB9XG5cbiAgdHJ5RXhwYW5kTWFjcm8obGluZTogVG9rZW5bXSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IFtmaXJzdF0gPSBsaW5lO1xuICAgIGlmIChmaXJzdC50b2tlbiAhPT0gJ2lkZW50JykgdGhyb3cgbmV3IEVycm9yKGBpbXBvc3NpYmxlYCk7XG4gICAgY29uc3QgbWFjcm8gPSB0aGlzLm1hY3Jvcy5nZXQoZmlyc3Quc3RyKTtcbiAgICBpZiAoIShtYWNybyBpbnN0YW5jZW9mIE1hY3JvKSkgcmV0dXJuIGZhbHNlO1xuICAgIGNvbnN0IGV4cGFuc2lvbiA9IG1hY3JvLmV4cGFuZChsaW5lLCBpZEdlbih0aGlzLmVudikpO1xuICAgIHRoaXMuc3RyZWFtLmVudGVyKCk7XG4gICAgdGhpcy5zdHJlYW0udW5zaGlmdCguLi5leHBhbnNpb24pOyAvLyBwcm9jZXNzIHRoZW0gYWxsIG92ZXIgYWdhaW4uLi5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgZXhwYW5kRGlyZWN0aXZlKGRpcmVjdGl2ZTogc3RyaW5nLCBsaW5lOiBUb2tlbltdLCBpOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHN3aXRjaCAoZGlyZWN0aXZlKSB7XG4gICAgICBjYXNlICcuZGVmaW5lJzogXG4gICAgICBjYXNlICcuaWZkZWYnOiAgXG4gICAgICBjYXNlICcuaWZuZGVmJzogXG4gICAgICBjYXNlICcudW5kZWZpbmUnOlxuICAgICAgICByZXR1cm4gdGhpcy5za2lwSWRlbnRpZmllcihsaW5lLCBpKTtcbiAgICAgIGNhc2UgJy5za2lwJzogcmV0dXJuIHRoaXMuc2tpcChsaW5lLCBpKTtcbiAgICAgIGNhc2UgJy5ub2V4cGFuZCc6IHJldHVybiB0aGlzLm5vZXhwYW5kKGxpbmUsIGkpO1xuICAgICAgY2FzZSAnLnRjb3VudCc6IHJldHVybiB0aGlzLnBhcnNlQXJncyhsaW5lLCBpLCAxLCB0aGlzLnRjb3VudCk7XG4gICAgICBjYXNlICcuaWRlbnQnOiByZXR1cm4gdGhpcy5wYXJzZUFyZ3MobGluZSwgaSwgMSwgdGhpcy5pZGVudCk7XG4gICAgICBjYXNlICcuc3RyaW5nJzogcmV0dXJuIHRoaXMucGFyc2VBcmdzKGxpbmUsIGksIDEsIHRoaXMuc3RyaW5nKTtcbiAgICAgIGNhc2UgJy5jb25jYXQnOiByZXR1cm4gdGhpcy5wYXJzZUFyZ3MobGluZSwgaSwgMCwgdGhpcy5jb25jYXQpO1xuICAgICAgY2FzZSAnLnNwcmludGYnOiByZXR1cm4gdGhpcy5wYXJzZUFyZ3MobGluZSwgaSwgMCwgdGhpcy5zcHJpbnRmKTtcbiAgICAgIGNhc2UgJy5jb25kJzogcmV0dXJuIHRoaXMucGFyc2VBcmdzKGxpbmUsIGksIDAsIHRoaXMuY29uZCk7XG4gICAgICBjYXNlICcuZGVmJzpcbiAgICAgIGNhc2UgJy5kZWZpbmVkJzpcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VBcmdzKGxpbmUsIGksIDEsIHRoaXMuZGVmaW5lZCk7XG4gICAgICBjYXNlICcuZGVmaW5lZHN5bWJvbCc6XG4gICAgICAgIHJldHVybiB0aGlzLnBhcnNlQXJncyhsaW5lLCBpLCAxLCB0aGlzLmRlZmluZWRTeW1ib2wpO1xuICAgICAgY2FzZSAnLmNvbnN0YW50c3ltYm9sJzpcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VBcmdzKGxpbmUsIGksIDEsIHRoaXMuY29uc3RhbnRTeW1ib2wpO1xuICAgICAgY2FzZSAnLnJlZmVyZW5jZWRzeW1ib2wnOlxuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUFyZ3MobGluZSwgaSwgMSwgdGhpcy5yZWZlcmVuY2VkU3ltYm9sKTtcbiAgICB9XG4gICAgcmV0dXJuIGkgKyAxO1xuICB9XG5cbiAgLy8gUVVFU1RJT04gLSBkb2VzIHNraXAgZGVzY2VuZCBpbnRvIGdyb3Vwcz9cbiAgLy8gICAgICAgICAgLSBzZWVtcyBsaWtlIGl0IHNob3VsZC4uLlxuICBwcml2YXRlIHNraXAobGluZTogVG9rZW5bXSwgaTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAvLyBleHBhbmQgaSArIDEsIHRoZW4gc3BsaWNlIHNlbGYgb3V0XG4gICAgbGluZS5zcGxpY2UoaSwgMSk7XG4gICAgY29uc3Qgc2tpcHBlZCA9IGxpbmVbaV07XG4gICAgaWYgKHNraXBwZWQ/LnRva2VuID09PSAnZ3JwJykge1xuICAgICAgdGhpcy5leHBhbmRUb2tlbihza2lwcGVkLmlubmVyLCAwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5leHBhbmRUb2tlbihsaW5lLCBpICsgMSk7XG4gICAgfVxuICAgIHJldHVybiBpO1xuICB9XG5cbiAgcHJpdmF0ZSBub2V4cGFuZChsaW5lOiBUb2tlbltdLCBpOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IHNraXAgPSBsaW5lW2kgKyAxXTtcbiAgICBpZiAoc2tpcC50b2tlbiA9PT0gJ2dycCcpIHtcbiAgICAgIGxpbmUuc3BsaWNlKGksIDIsIC4uLnNraXAuaW5uZXIpO1xuICAgICAgaSArPSBza2lwLmlubmVyLmxlbmd0aCAtIDE7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxpbmUuc3BsaWNlKGksIDEpO1xuICAgIH1cbiAgICByZXR1cm4gaSArIDE7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlQXJncyhsaW5lOiBUb2tlbltdLCBpOiBudW1iZXIsIGFyZ0NvdW50OiBudW1iZXIsXG4gICAgICAgICAgICAgICAgICAgIGZuOiAodGhpczogdGhpcywgY3M6IFRva2VuLFxuICAgICAgICAgICAgICAgICAgICAgICAgIC4uLmFyZ3M6IFRva2VuW11bXSkgPT4gdm9pZCk6IG51bWJlciB7XG4gICAgY29uc3QgY3MgPSBsaW5lW2ldO1xuICAgIFRva2VuLmV4cGVjdChUb2tlbi5MUCwgbGluZVtpICsgMV0sIGNzKTtcbiAgICBjb25zdCBlbmQgPSBUb2tlbi5maW5kQmFsYW5jZWQobGluZSwgaSArIDEpO1xuICAgIGNvbnN0IGFyZ3MgPVxuICAgICAgICBUb2tlbi5wYXJzZUFyZ0xpc3QobGluZSwgaSArIDIsIGVuZCkubWFwKHRzID0+IHtcbiAgICAgICAgICBpZiAodHMubGVuZ3RoID09PSAxICYmIHRzWzBdLnRva2VuID09PSAnZ3JwJykgdHMgPSB0c1swXS5pbm5lcjtcbiAgICAgICAgICByZXR1cm4gdGhpcy5leHBhbmRMaW5lKHRzKTtcbiAgICAgICAgfSk7XG4gICAgaWYgKGFyZ0NvdW50ICYmIGFyZ3MubGVuZ3RoICE9PSBhcmdDb3VudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCAke2FyZ0NvdW50fSBwYXJhbWV0ZXJzOiAke1Rva2VuLm5hbWVBdChjcyl9YCk7XG4gICAgfVxuICAgIGNvbnN0IGV4cGFuc2lvbiA9IGZuLmNhbGwodGhpcywgY3MsIC4uLmFyZ3MpO1xuICAgIGxpbmUuc3BsaWNlKGksIGVuZCArIDEgLSBpLCAuLi5leHBhbnNpb24pO1xuICAgIHJldHVybiBpOyAvLyBjb250aW51ZSBleHBhbnNpb24gZnJvbSBzYW1lIHNwb3RcbiAgfVxuXG4gIHByaXZhdGUgdGNvdW50KGNzOiBUb2tlbiwgYXJnOiBUb2tlbltdKSB7XG4gICAgcmV0dXJuIFt7dG9rZW46ICdudW0nLCBudW06IFRva2VuLmNvdW50KGFyZyksIHNvdXJjZTogY3Muc291cmNlfV07XG4gIH1cblxuICBwcml2YXRlIGlkZW50KGNzOiBUb2tlbiwgYXJnOiBUb2tlbltdKSB7XG4gICAgY29uc3Qgc3RyID0gVG9rZW4uZXhwZWN0U3RyaW5nKGFyZ1swXSwgY3MpO1xuICAgIFRva2VuLmV4cGVjdEVvbChhcmdbMV0sICdhIHNpbmdsZSB0b2tlbicpO1xuICAgIHJldHVybiBbe3Rva2VuOiAnaWRlbnQnLCBzdHIsIHNvdXJjZTogYXJnWzBdLnNvdXJjZX1dO1xuICB9XG5cbiAgcHJpdmF0ZSBzdHJpbmcoY3M6IFRva2VuLCBhcmc6IFRva2VuW10pIHtcbiAgICBjb25zdCBzdHIgPSBUb2tlbi5leHBlY3RJZGVudGlmaWVyKGFyZ1swXSwgY3MpO1xuICAgIFRva2VuLmV4cGVjdEVvbChhcmdbMV0sICdhIHNpbmdsZSB0b2tlbicpO1xuICAgIHJldHVybiBbe3Rva2VuOiAnc3RyJywgc3RyLCBzb3VyY2U6IGFyZ1swXS5zb3VyY2V9XTtcbiAgfVxuICAgIFxuICBwcml2YXRlIGNvbmNhdChjczogVG9rZW4sIC4uLmFyZ3M6IFRva2VuW11bXSkge1xuICAgIGNvbnN0IHN0cnMgPSBhcmdzLm1hcCh0cyA9PiB7XG4gICAgICBjb25zdCBzdHIgPSBUb2tlbi5leHBlY3RTdHJpbmcodHNbMF0pO1xuICAgICAgVG9rZW4uZXhwZWN0RW9sKHRzWzFdLCAnYSBzaW5nbGUgc3RyaW5nJyk7XG4gICAgICByZXR1cm4gc3RyO1xuICAgIH0pO1xuICAgIHJldHVybiBbe3Rva2VuOiAnc3RyJywgc3RyOiBzdHJzLmpvaW4oJycpLCBzb3VyY2U6IGNzLnNvdXJjZX1dO1xuICB9XG5cbiAgcHJpdmF0ZSBzcHJpbnRmKGNzOiBUb2tlbiwgZm10VG9rczogVG9rZW5bXSwgLi4uYXJnczogVG9rZW5bXVtdKSB7XG4gICAgY29uc3QgZm10ID0gVG9rZW4uZXhwZWN0U3RyaW5nKGZtdFRva3NbMF0sIGNzKTtcbiAgICBUb2tlbi5leHBlY3RFb2woZm10VG9rc1sxXSwgJ2Egc2luZ2xlIGZvcm1hdCBzdHJpbmcnKTtcbiAgICAvLyBmaWd1cmUgb3V0IHdoYXQgcGxhY2Vob2xkZXJzLi4uXG4gICAgLy8gVE9ETyAtIGV2YWx1YXRlIG51bWVyaWMgYXJncyBhcyBleHBycywgc3RyaW5ncyBsZWZ0IGFzIGlzXG4gICAgY29uc3QgW10gPSBbZm10XTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3VuaW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIHByaXZhdGUgY29uZChjczogVG9rZW4sIC4uLmFyZ3M6IFRva2VuW11bXSkge1xuICAgIHRocm93IG5ldyBFcnJvcigndW5pbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBkZWZpbmVkKGNzOiBUb2tlbiwgYXJnOiBUb2tlbltdKSB7XG4gICAgY29uc3QgaWRlbnQgPSBUb2tlbi5leHBlY3RJZGVudGlmaWVyKGFyZ1swXSwgY3MpO1xuICAgIFRva2VuLmV4cGVjdEVvbChhcmdbMV0sICdhIHNpbmdsZSBpZGVudGlmaWVyJyk7XG4gICAgcmV0dXJuIFt7dG9rZW46ICdudW0nLCBudW06IHRoaXMubWFjcm9zLmhhcyhpZGVudCkgPyAxIDogMH1dO1xuICB9XG5cbiAgcHJpdmF0ZSBkZWZpbmVkU3ltYm9sKGNzOiBUb2tlbiwgYXJnOiBUb2tlbltdKSB7XG4gICAgY29uc3QgaWRlbnQgPSBUb2tlbi5leHBlY3RJZGVudGlmaWVyKGFyZ1swXSwgY3MpO1xuICAgIFRva2VuLmV4cGVjdEVvbChhcmdbMV0sICdhIHNpbmdsZSBpZGVudGlmaWVyJyk7XG4gICAgcmV0dXJuIFt7dG9rZW46ICdudW0nLCBudW06IHRoaXMuZW52LmRlZmluZWRTeW1ib2woaWRlbnQpID8gMSA6IDB9XTtcbiAgfVxuXG4gIHByaXZhdGUgY29uc3RhbnRTeW1ib2woY3M6IFRva2VuLCBhcmc6IFRva2VuW10pIHtcbiAgICBjb25zdCBpZGVudCA9IFRva2VuLmV4cGVjdElkZW50aWZpZXIoYXJnWzBdLCBjcyk7XG4gICAgVG9rZW4uZXhwZWN0RW9sKGFyZ1sxXSwgJ2Egc2luZ2xlIGlkZW50aWZpZXInKTtcbiAgICByZXR1cm4gW3t0b2tlbjogJ251bScsIG51bTogdGhpcy5lbnYuY29uc3RhbnRTeW1ib2woaWRlbnQpID8gMSA6IDB9XTtcbiAgfVxuXG4gIHByaXZhdGUgcmVmZXJlbmNlZFN5bWJvbChjczogVG9rZW4sIGFyZzogVG9rZW5bXSkge1xuICAgIGNvbnN0IGlkZW50ID0gVG9rZW4uZXhwZWN0SWRlbnRpZmllcihhcmdbMF0sIGNzKTtcbiAgICBUb2tlbi5leHBlY3RFb2woYXJnWzFdLCAnYSBzaW5nbGUgaWRlbnRpZmllcicpO1xuICAgIHJldHVybiBbe3Rva2VuOiAnbnVtJywgbnVtOiB0aGlzLmVudi5yZWZlcmVuY2VkU3ltYm9sKGlkZW50KSA/IDEgOiAwfV07XG4gIH1cblxuICAvLyBUT0RPIC0gZG9lcyAuYnl0ZSBleHBhbmQgaXRzIHN0cmluZ3MgaW50byBieXRlcyBoZXJlP1xuICAvLyAgIC0tIG1heWJlIG5vdC4uLlxuICAvLyAgIC0tIGRvIHdlIG5lZWQgdG8gaGFuZGxlIHN0cmluZyBleHBycyBhdCBhbGw/XG4gIC8vICAgLS0gbWF5YmUgbm90IC0gbWF5YmUganVzdCB0b2tlbnM/XG5cbiAgLyoqXG4gICAqIElmIHRoZSBmb2xsb3dpbmcgaXMgYW4gaWRlbnRpZmllciwgc2tpcCBpdC4gIFRoaXMgaXMgdXNlZCB3aGVuXG4gICAqIGV4cGFuZGluZyAuZGVmaW5lLCAudW5kZWZpbmUsIC5kZWZpbmVkLCAuaWZkZWYsIGFuZCAuaWZuZGVmLlxuICAgKiBEb2VzIG5vdCBza2lwIHNjb3BlZCBpZGVudGlmaWVycywgc2luY2UgbWFjcm9zIGNhbid0IGJlIHNjb3BlZC5cbiAgICovXG4gIHByaXZhdGUgc2tpcElkZW50aWZpZXIobGluZTogVG9rZW5bXSwgaTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gbGluZVtpICsgMV0/LnRva2VuID09PSAnaWRlbnQnID8gaSArIDIgOiBpICsgMTtcbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gUlVOIERJUkVDVElWRVNcblxuICB0cnlSdW5EaXJlY3RpdmUobGluZTogVG9rZW5bXSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGZpcnN0ID0gbGluZVswXTtcbiAgICBpZiAoZmlyc3QudG9rZW4gIT09ICdjcycpIHRocm93IG5ldyBFcnJvcihgaW1wb3NzaWJsZWApO1xuICAgIGNvbnN0IGhhbmRsZXIgPSB0aGlzLnJ1bkRpcmVjdGl2ZXNbZmlyc3Quc3RyXTtcbiAgICBpZiAoIWhhbmRsZXIpIHJldHVybiBmYWxzZTtcbiAgICBoYW5kbGVyKGxpbmUpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgZXZhbHVhdGVDb25zdChleHByOiBFeHByKTogbnVtYmVyIHtcbiAgICBleHByID0gRXhwci50cmF2ZXJzZVBvc3QoZXhwciwgRXhwci5ldmFsdWF0ZSk7XG4gICAgaWYgKGV4cHIub3AgPT09ICdudW0nICYmICFleHByLm1ldGE/LnJlbCkgcmV0dXJuIGV4cHIubnVtITtcbiAgICBjb25zdCBhdCA9IFRva2VuLmF0KGV4cHIpO1xuICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgYSBjb25zdGFudCR7YXR9YCk7XG4gIH1cblxuICBwcml2YXRlIHJlYWRvbmx5IHJ1bkRpcmVjdGl2ZXM6IFJlY29yZDxzdHJpbmcsICh0czogVG9rZW5bXSkgPT4gdm9pZD4gPSB7XG4gICAgJy5kZWZpbmUnOiAobGluZSkgPT4gdGhpcy5wYXJzZURlZmluZShsaW5lKSxcbiAgICAnLnVuZGVmaW5lJzogKGxpbmUpID0+IHRoaXMucGFyc2VVbmRlZmluZShsaW5lKSxcbiAgICAnLmVsc2UnOiAoW2NzXSkgPT4gYmFkQ2xvc2UoJy5pZicsIGNzKSxcbiAgICAnLmVsc2VpZic6IChbY3NdKSA9PiBiYWRDbG9zZSgnLmlmJywgY3MpLFxuICAgICcuZW5kaWYnOiAoW2NzXSkgPT4gYmFkQ2xvc2UoJy5pZicsIGNzKSxcbiAgICAnLmVuZG1hYyc6IChbY3NdKSA9PiBiYWRDbG9zZSgnLm1hY3JvJywgY3MpLFxuICAgICcuZW5kbWFjcm8nOiAoW2NzXSkgPT4gYmFkQ2xvc2UoJy5tYWNybycsIGNzKSxcbiAgICAnLmVuZHJlcCc6IChsaW5lKSA9PiB0aGlzLnBhcnNlRW5kUmVwZWF0KGxpbmUpLFxuICAgICcuZW5kcmVwZWF0JzogKGxpbmUpID0+IHRoaXMucGFyc2VFbmRSZXBlYXQobGluZSksXG4gICAgJy5leGl0bWFjcm8nOiAoWywgYV0pID0+IHsgbm9HYXJiYWdlKGEpOyB0aGlzLnN0cmVhbS5leGl0KCk7IH0sXG4gICAgJy5pZic6IChbY3MsIC4uLmFyZ3NdKSA9PlxuICAgICAgICB0aGlzLnBhcnNlSWYoISF0aGlzLmV2YWx1YXRlQ29uc3QocGFyc2VPbmVFeHByKGFyZ3MsIGNzKSkpLFxuICAgICcuaWZkZWYnOiAoW2NzLCAuLi5hcmdzXSkgPT5cbiAgICAgICAgdGhpcy5wYXJzZUlmKHRoaXMubWFjcm9zLmhhcyhwYXJzZU9uZUlkZW50KGFyZ3MsIGNzKSkpLFxuICAgICcuaWZuZGVmJzogKFtjcywgLi4uYXJnc10pID0+XG4gICAgICAgIHRoaXMucGFyc2VJZighdGhpcy5tYWNyb3MuaGFzKHBhcnNlT25lSWRlbnQoYXJncywgY3MpKSksXG4gICAgJy5pZmJsYW5rJzogKFssIC4uLmFyZ3NdKSA9PiB0aGlzLnBhcnNlSWYoIWFyZ3MubGVuZ3RoKSxcbiAgICAnLmlmbmJsYW5rJzogKFssIC4uLmFyZ3NdKSA9PiB0aGlzLnBhcnNlSWYoISFhcmdzLmxlbmd0aCksXG4gICAgJy5pZnJlZic6IChbY3MsIC4uLmFyZ3NdKSA9PlxuICAgICAgICB0aGlzLnBhcnNlSWYodGhpcy5lbnYucmVmZXJlbmNlZFN5bWJvbChwYXJzZU9uZUlkZW50KGFyZ3MsIGNzKSkpLFxuICAgICcuaWZucmVmJzogKFtjcywgLi4uYXJnc10pID0+XG4gICAgICAgIHRoaXMucGFyc2VJZighdGhpcy5lbnYucmVmZXJlbmNlZFN5bWJvbChwYXJzZU9uZUlkZW50KGFyZ3MsIGNzKSkpLFxuICAgICcuaWZzeW0nOiAoW2NzLCAuLi5hcmdzXSkgPT5cbiAgICAgICAgdGhpcy5wYXJzZUlmKHRoaXMuZW52LmRlZmluZWRTeW1ib2wocGFyc2VPbmVJZGVudChhcmdzLCBjcykpKSxcbiAgICAnLmlmbnN5bSc6IChbY3MsIC4uLmFyZ3NdKSA9PlxuICAgICAgICB0aGlzLnBhcnNlSWYoIXRoaXMuZW52LmRlZmluZWRTeW1ib2wocGFyc2VPbmVJZGVudChhcmdzLCBjcykpKSxcbiAgICAnLmlmY29uc3QnOiAoW2NzLCAuLi5hcmdzXSkgPT5cbiAgICAgICAgdGhpcy5wYXJzZUlmKHRoaXMuZW52LmNvbnN0YW50U3ltYm9sKHBhcnNlT25lSWRlbnQoYXJncywgY3MpKSksXG4gICAgJy5pZm5jb25zdCc6IChbY3MsIC4uLmFyZ3NdKSA9PlxuICAgICAgICB0aGlzLnBhcnNlSWYoIXRoaXMuZW52LmNvbnN0YW50U3ltYm9sKHBhcnNlT25lSWRlbnQoYXJncywgY3MpKSksXG4gICAgJy5tYWNybyc6IChsaW5lKSA9PiB0aGlzLnBhcnNlTWFjcm8obGluZSksXG4gICAgJy5yZXBlYXQnOiAobGluZSkgPT4gdGhpcy5wYXJzZVJlcGVhdChsaW5lKSxcbiAgfTtcblxuICBwcml2YXRlIHBhcnNlRGVmaW5lKGxpbmU6IFRva2VuW10pIHtcbiAgICBjb25zdCBuYW1lID0gVG9rZW4uZXhwZWN0SWRlbnRpZmllcihsaW5lWzFdLCBsaW5lWzBdKTtcbiAgICBjb25zdCBkZWZpbmUgPSBEZWZpbmUuZnJvbShsaW5lKTtcbiAgICBjb25zdCBwcmV2ID0gdGhpcy5tYWNyb3MuZ2V0KG5hbWUpO1xuICAgIGlmIChwcmV2IGluc3RhbmNlb2YgRGVmaW5lKSB7XG4gICAgICBwcmV2LmFwcGVuZChkZWZpbmUpO1xuICAgIH0gZWxzZSBpZiAocHJldikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBbHJlYWR5IGRlZmluZWQ6ICR7bmFtZX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tYWNyb3Muc2V0KG5hbWUsIGRlZmluZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZVVuZGVmaW5lKGxpbmU6IFRva2VuW10pIHtcbiAgICBjb25zdCBbY3MsIGlkZW50LCBlb2xdID0gbGluZTtcbiAgICBjb25zdCBuYW1lID0gVG9rZW4uZXhwZWN0SWRlbnRpZmllcihpZGVudCwgY3MpO1xuICAgIFRva2VuLmV4cGVjdEVvbChlb2wpO1xuICAgIGlmICghdGhpcy5tYWNyb3MuaGFzKG5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBkZWZpbmVkOiAke1Rva2VuLm5hbWVBdChpZGVudCl9YCk7XG4gICAgfVxuICAgIHRoaXMubWFjcm9zLmRlbGV0ZShuYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VNYWNybyhsaW5lOiBUb2tlbltdKSB7XG4gICAgY29uc3QgbmFtZSA9IFRva2VuLmV4cGVjdElkZW50aWZpZXIobGluZVsxXSwgbGluZVswXSk7XG4gICAgY29uc3QgbWFjcm8gPSBNYWNyby5mcm9tKGxpbmUsIHRoaXMuc3RyZWFtKTtcbiAgICBjb25zdCBwcmV2ID0gdGhpcy5tYWNyb3MuZ2V0KG5hbWUpO1xuICAgIGlmIChwcmV2KSB0aHJvdyBuZXcgRXJyb3IoYEFscmVhZHkgZGVmaW5lZDogJHtuYW1lfWApO1xuICAgIHRoaXMubWFjcm9zLnNldChuYW1lLCBtYWNybyk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlUmVwZWF0KGxpbmU6IFRva2VuW10pIHtcbiAgICBjb25zdCBbZXhwciwgZW5kXSA9IEV4cHIucGFyc2UobGluZSwgMSk7XG4gICAgY29uc3QgYXQgPSBsaW5lWzFdIHx8IGxpbmVbMF07XG4gICAgaWYgKCFleHByKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGV4cHJlc3Npb246ICR7VG9rZW4ubmFtZUF0KGF0KX1gKTtcbiAgICBjb25zdCB0aW1lcyA9IHRoaXMuZXZhbHVhdGVDb25zdChleHByKTtcbiAgICBpZiAodGltZXMgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBhIGNvbnN0YW50JHtUb2tlbi5hdChleHByKX1gKTtcbiAgICBsZXQgaWRlbnQ6IHN0cmluZ3x1bmRlZmluZWQ7XG4gICAgaWYgKGVuZCA8IGxpbmUubGVuZ3RoKSB7XG4gICAgICBpZiAoIVRva2VuLmVxKGxpbmVbZW5kXSwgVG9rZW4uQ09NTUEpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgY29tbWE6ICR7VG9rZW4ubmFtZUF0KGxpbmVbZW5kXSl9YCk7XG4gICAgICB9XG4gICAgICBpZGVudCA9IFRva2VuLmV4cGVjdElkZW50aWZpZXIobGluZVtlbmQgKyAxXSk7XG4gICAgICBUb2tlbi5leHBlY3RFb2wobGluZVtlbmQgKyAyXSk7XG4gICAgfVxuICAgIGNvbnN0IGxpbmVzOiBUb2tlbltdW10gPSBbXTtcbiAgICBsZXQgZGVwdGggPSAxO1xuICAgIHdoaWxlIChkZXB0aCA+IDApIHtcbiAgICAgIGxpbmUgPSB0aGlzLnN0cmVhbS5uZXh0KCkgPz8gZmFpbChgLnJlcGVhdCB3aXRoIG5vIC5lbmRyZXBgKTtcbiAgICAgIGlmIChUb2tlbi5lcShsaW5lWzBdLCBUb2tlbi5SRVBFQVQpKSBkZXB0aCsrO1xuICAgICAgaWYgKFRva2VuLmVxKGxpbmVbMF0sIFRva2VuLkVORFJFUEVBVCkpIGRlcHRoLS07XG4gICAgICBpZiAoVG9rZW4uZXEobGluZVswXSwgVG9rZW4uRU5EUkVQKSkgZGVwdGgtLTtcbiAgICAgIGxpbmVzLnB1c2gobGluZSk7XG4gICAgfVxuICAgIHRoaXMucmVwZWF0cy5wdXNoKFtsaW5lcywgdGltZXMsIC0xLCBpZGVudF0pO1xuICAgIHRoaXMucGFyc2VFbmRSZXBlYXQobGluZSk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlRW5kUmVwZWF0KGxpbmU6IFRva2VuW10pIHtcbiAgICBUb2tlbi5leHBlY3RFb2wobGluZVsxXSk7XG4gICAgY29uc3QgdG9wID0gdGhpcy5yZXBlYXRzLnBvcCgpO1xuICAgIGlmICghdG9wKSB0aHJvdyBuZXcgRXJyb3IoYC5lbmRyZXAgd2l0aCBubyAucmVwZWF0JHtUb2tlbi5hdChsaW5lWzBdKX1gKTtcbiAgICBpZiAoKyt0b3BbMl0gPj0gdG9wWzFdKSByZXR1cm47XG4gICAgdGhpcy5yZXBlYXRzLnB1c2godG9wKTtcbiAgICB0aGlzLnN0cmVhbS51bnNoaWZ0KC4uLnRvcFswXS5tYXAobGluZSA9PiBsaW5lLm1hcCh0b2tlbiA9PiB7XG4gICAgICBpZiAodG9rZW4udG9rZW4gIT09ICdpZGVudCcgfHwgdG9rZW4uc3RyICE9PSB0b3BbM10pIHJldHVybiB0b2tlbjtcbiAgICAgIGNvbnN0IHQ6IFRva2VuID0ge3Rva2VuOiAnbnVtJywgbnVtOiB0b3BbMl19O1xuICAgICAgaWYgKHRva2VuLnNvdXJjZSkgdC5zb3VyY2UgPSB0b2tlbi5zb3VyY2U7XG4gICAgICByZXR1cm4gdDtcbiAgICB9KSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUlmKGNvbmQ6IGJvb2xlYW4pIHtcbiAgICBsZXQgZGVwdGggPSAxO1xuICAgIGxldCBkb25lID0gZmFsc2U7XG4gICAgY29uc3QgcmVzdWx0OiBUb2tlbltdW10gPSBbXTtcbiAgICB3aGlsZSAoZGVwdGggPiAwKSB7XG4gICAgICBjb25zdCBsaW5lID0gdGhpcy5zdHJlYW0ubmV4dCgpO1xuICAgICAgaWYgKCFsaW5lKSB0aHJvdyBuZXcgRXJyb3IoYEVPRiBsb29raW5nIGZvciAuZW5kaWZgKTsgLy8gVE9ETzogc3RhcnQ/XG4gICAgICBjb25zdCBmcm9udCA9IGxpbmVbMF07XG4gICAgICBpZiAoVG9rZW4uZXEoZnJvbnQsIFRva2VuLkVORElGKSkge1xuICAgICAgICBkZXB0aC0tO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH0gZWxzZSBpZiAoZGVwdGggPT09IDEgJiYgIWRvbmUpIHtcbiAgICAgICAgaWYgKGNvbmQgJiYgKFRva2VuLmVxKGZyb250LCBUb2tlbi5FTFNFKSB8fFxuICAgICAgICAgICAgICAgICAgICAgVG9rZW4uZXEoZnJvbnQsIFRva2VuLkVMU0VJRikpKSB7XG4gICAgICAgICAgLy8gaWYgdHJ1ZSAuLi4gZWxzZSAuLi4uLlxuICAgICAgICAgIGNvbmQgPSBmYWxzZTtcbiAgICAgICAgICBkb25lID0gdHJ1ZTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfSBlbHNlIGlmIChUb2tlbi5lcShmcm9udCwgVG9rZW4uRUxTRUlGKSkge1xuICAgICAgICAgIC8vIGlmIGZhbHNlIC4uLiBlbHNlIGlmIC4uLi4uXG4gICAgICAgICAgY29uZCA9ICEhdGhpcy5ldmFsdWF0ZUNvbnN0KHBhcnNlT25lRXhwcihsaW5lLnNsaWNlKDEpLCBmcm9udCkpO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9IGVsc2UgaWYgKFRva2VuLmVxKGZyb250LCBUb2tlbi5FTFNFKSkge1xuICAgICAgICAgIC8vIGlmIGZhbHNlIC4uLiBlbHNlIC4uLi4uXG4gICAgICAgICAgY29uZCA9IHRydWU7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIGFueXRoaW5nIGVsc2Ugb24gdGhlIGxpbmVcbiAgICAgIGlmIChjb25kKSByZXN1bHQucHVzaChsaW5lKTtcbiAgICB9XG4gICAgLy8gcmVzdWx0IGhhcyB0aGUgZXhwYW5zaW9uOiB1bnNoaWZ0IGl0XG4gICAgdGhpcy5zdHJlYW0udW5zaGlmdCguLi5yZXN1bHQpO1xuICB9XG5cbiAgICAgIC8vIGlmIChmcm9udC5zdHIgPT09ICcuZGVmaW5lJyB8fCBmcm9udC5zdHIgPT09ICcudW5kZWZpbmUnKSB7XG4gICAgICAvLyAgIGNvbnN0IG5leHQgPSBsaW5lW3BvcyArIDFdO1xuICAgICAgLy8gICBpZiAobmV4dD8udG9rZW4gPT09ICdjcycpIHtcbiAgICAgIC8vICAgICB0aGlzLmV4cGFuZFRva2VuKGxpbmUsIHBvcyArIDEpO1xuICAgICAgLy8gICAgIHJldHVybiBwb3M7XG4gICAgICAvLyAgIH0gZWxzZSBpZiAobmV4dD8udG9rZW4gPT09ICdpZGVudCcpIHtcbiAgICAgIC8vICAgICByZXR1cm4gcG9zICsgMjsgLy8gc2tpcCB0aGUgaWRlbnRpZmllclxuICAgICAgLy8gICB9XG4gICAgICAvLyB9IGVsc2UgaWYgKGZyb250LnN0ciA9PT0gJy5za2lwJykge1xuICAgICAgLy8gICBjb25zdCByZXN0ID0gbGluZS5zcGxpY2UocG9zICsgMiwgbGluZS5sZW5ndGggLSBwb3MgLSAyKTtcbiAgICAgIC8vICAgbGluZS5wb3AoKTtcbiAgICAgIC8vICAgdGhpcy5leHBhbmRUb2tlbihyZXN0LCAwKTtcbiAgICAgIC8vICAgbGluZS5wdXNoKC4uLnJlc3QpO1xuICAgICAgLy8gICByZXR1cm4gcG9zO1xuICAgICAgLy8gfSBlbHNlIHtcblxuXG4gIC8vIGRlZmluZWQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gIC8vICAgcmV0dXJuIHRoaXMubWFjcm9zLmhhcyhuYW1lKSB8fFxuICAvLyAgICAgICB0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5kZWZpbmVkKG5hbWUpIHx8XG4gIC8vICAgICAgIGZhbHNlO1xuICAvLyB9XG5cbiAgLy8gdW5kZWZpbmUobmFtZTogc3RyaW5nKSB7XG4gIC8vICAgdGhpcy5tYWNyb3MuZGVsZXRlKG5hbWUpO1xuICAvLyB9XG5cbiAgLy8gLy8gRXhwYW5kcyBhIHNpbmdsZSBsaW5lIG9mIHRva2VucyBmcm9tIHRoZSBmcm9udCBvZiB0b2tzLlxuICAvLyAvLyAuZGVmaW5lIG1hY3JvcyBhcmUgZXhwYW5kZWQgaW5saW5lLCBidXQgLm1hY3JvIHN0eWxlIG1hY3Jvc1xuICAvLyAvLyBhcmUgbGVmdCBhcy1pcy4gIERvbid0IGV4cGFuZCBkZWZpbmVzIGluIGNlcnRhaW4gY2lyY3Vtc3RhbmNlcyxcbiAgLy8gLy8gc3VjaCBhcyB3aGVuIHRyeWluZyB0byBvdmVycmlkZS5cbiAgLy8gcHJpdmF0ZSBsaW5lKHRva3M6IERlcXVlPFRva2VuPik6IERlcXVlPFRva2VuPiB7XG4gIC8vICAgLy8gZmluZCB0aGUgbmV4dCBlbmQgb2YgbGluZVxuICAvLyAgIGNvbnN0IGxpbmUgPSBuZXcgRGVxdWU8VG9rZW4+KCk7XG4gIC8vICAgbGV0IGN1cmxpZXMgPSAwO1xuICAvLyAgIHdoaWxlICh0b2tzLmxlbmd0aCkge1xuICAvLyAgICAgY29uc3QgdG9rID0gdG9rcy5zaGlmdCgpO1xuICAvLyAgICAgaWYgKFRva2VuLmVxKFRva2VuLkVPTCwgdG9rKSkgYnJlYWs7XG4gIC8vICAgICBpZiAoVG9rZW4uZXEoVG9rZW4uTEMsIHRvaykpIHtcbiAgLy8gICAgICAgY3VybGllcysrO1xuICAvLyAgICAgfSBlbHNlIGlmIChUb2tlbi5lcShUb2tlbi5SQywgdG9rKSkge1xuICAvLyAgICAgICBpZiAoLS1jdXJsaWVzIDwgMCkgdGhyb3cgbmV3IEVyb3IoYHVuYmFsYW5jZWQgY3VybHlgKTtcbiAgLy8gICAgIH1cbiAgLy8gICAgIGxpbmUucHVzaCh0b2spO1xuICAvLyAgIH1cbiAgLy8gICBpZiAoY3VybGllcykgdGhyb3cgbmV3IEVycm9yKGB1bmJhbGFuY2VkIGN1cmx5YCk7XG4gIC8vICAgLy8gbm93IGRvIHRoZSBlYXJseSBleHBhbnNpb25zXG4gIC8vICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5lLmxlbmd0aDsgaSsrKSB7XG4gIC8vICAgICBjb25zdCB0b2sgPSBsaW5lLmdldChpKSE7XG4gIC8vICAgICBpZiAoVG9rZW4uZXEoVG9rZW4uU0tJUCwgdG9rKSkge1xuICAvLyAgICAgICBjb25zdCBuZXh0ID0gbGluZS5nZXQoaSArIDEpO1xuICAvLyAgICAgICBjb25zdCBjb3VudCA9IG5leHQ/LnRva2VuID09PSAnbnVtJyA/IG5leHQubnVtIDogMTtcbiAgLy8gICAgICAgaSArPSBjb3VudDtcbiAgLy8gICAgICAgY29udGludWU7XG4gIC8vICAgICB9XG4gIC8vICAgICBpZiAodG9rLnRva2VuID09PSAnaWRlbnQnKSB7XG4gIC8vICAgICAgIGNvbnN0IG1hY3JvID0gdGhpcy5tYWNyb3MuZ2V0KHRvay5zdHIpO1xuICAvLyAgICAgICBpZiAobWFjcm8/LmV4cGFuZHNFYXJseSkge1xuICAvLyAgICAgICAgIGlmICghbWFjcm8uZXhwYW5kKGxpbmUsIGkpKSBmYWlsKHRvaywgYENvdWxkIG5vdCBleHBhbmQgJHt0b2suc3RyfWApO1xuICAvLyAgICAgICAgIGkgPSAtMTsgLy8gc3RhcnQgYmFjayBhdCB0aGUgYmVnaW5uaW5nXG4gIC8vICAgICAgICAgY29udGludWU7XG4gIC8vICAgICAgIH1cbiAgLy8gICAgIH1cbiAgLy8gICB9XG4gIC8vICAgcmV0dXJuIGxpbmU7XG4gIC8vIH1cblxuICAvLyAqIGxpbmVzKHJlc3Q6IERlcXVlPFRva2VuPiwgZGVwdGggPSAwKTogR2VuZXJhdG9yPExpbmU+IHtcbiAgLy8gICBpZiAoZGVwdGggPiBNQVhfU1RBQ0tfREVQVEgpIHRocm93IG5ldyBFcnJvcihgbWF4IHJlY3Vyc2lvbiBkZXB0aGApO1xuICAvLyAgIHdoaWxlIChyZXN0Lmxlbmd0aCkge1xuICAvLyAgICAgLy8gbGluZXMgc2hvdWxkIGhhdmUgbm8gZGVmaW5lLW1hY3JvcyBpbiBpdCBhdCB0aGlzIHBvaW50XG4gIC8vICAgICBsZXQgbGFiZWxzID0gW107XG4gIC8vICAgICBsZXQgbGluZSA9IHRoaXMubGluZShyZXN0KTtcbiAgLy8gICAgIHdoaWxlIChsaW5lLmxlbmd0aCkge1xuICAvLyAgICAgICAvLyBsb29rIGZvciBsYWJlbHMsIGJ1dCBjb3VsZCBiZSBhIG1uZW1vbmljIG9yIG1hY3JvXG4gIC8vICAgICAgIGNvbnN0IGZyb250ID0gbGluZS5mcm9udCgpITtcbiAgLy8gICAgICAgaWYgKGZyb250LnRva2VuID09PSAnaWRlbnQnKSB7XG4gIC8vICAgICAgICAgaWYgKFRva2VuLmVxKFRva2VuLkNPTE9OLCBsaW5lLmdldCgxKSkpIHtcbiAgLy8gICAgICAgICAgIC8vIGl0J3MgYSBsYWJlbFxuICAvLyAgICAgICAgICAgbGFiZWxzLnB1c2goZnJvbnQuc3RyKTtcbiAgLy8gICAgICAgICAgIGxpbmUuc3BsaWNlKDAsIDIpO1xuICAvLyAgICAgICAgICAgY29udGludWU7XG4gIC8vICAgICAgICAgfVxuICAvLyAgICAgICAgIC8vIGNoZWNrIGZvciBhIG1hY3JvXG4gIC8vICAgICAgICAgY29uc3QgbWFjcm8gPSB0aGlzLm1hY3Jvcy5nZXQoZnJvbnQuc3RyKTtcbiAgLy8gICAgICAgICBpZiAobWFjcm8pIHtcbiAgLy8gICAgICAgICAgIGlmIChtYWNyby5leHBhbmRzRWFybHkpIHRocm93IG5ldyBFcnJvcihgZWFybHkgbWFjcm8gbGF0ZWApO1xuICAvLyAgICAgICAgICAgaWYgKCFtYWNyby5leHBhbmQobGluZSkpIHRocm93IG5ldyBFcnJvcihgYmFkIGV4cGFuc2lvbmApO1xuICAvLyAgICAgICAgICAgLy8gYnkgcmVjdXJzaW5nIHJhdGhlciB0aGFuIHVuc2hpZnRpbmcgd2UgY2FuIHN1cHBvcnQgLmV4aXRtYWNybz9cbiAgLy8gICAgICAgICAgIHlpZWxkICogdGhpcy5saW5lcyhsaW5lLCBkZXB0aCArIDEpO1xuICAvLyAgICAgICAgICAgYnJlYWs7XG4gIC8vICAgICAgICAgfVxuICAvLyAgICAgICAgIC8vIGl0J3MgYSByZWd1bGFyIG1uZW1vbmljXG4gIC8vICAgICAgICAgeWllbGQge2xhYmVscywgdG9rZW5zOiBbLi4ubGluZV19O1xuICAvLyAgICAgICAgIGJyZWFrO1xuICAvLyAgICAgICB9IGVsc2UgaWYgKFRva2VuLmVxKFRva2VuLkNPTE9OLCBmcm9udCkpIHsgLy8gc3BlY2lhbCBsYWJlbFxuICAvLyAgICAgICAgIGxhYmVscy5wdXNoKCc6Jyk7XG4gIC8vICAgICAgICAgbGluZS5zaGlmdCgpO1xuICAvLyAgICAgICAgIGNvbnRpbnVlO1xuICAvLyAgICAgICB9IGVsc2UgaWYgKGZyb250LnRva2VuID09PSAnb3AnKSB7XG4gIC8vICAgICAgICAgLy8gb3RoZXIgc3BlY2lhbCBsYWJlbHNcbiAgLy8gICAgICAgICBpZiAoL14oXFwrK3wtKykkLy50ZXN0KGZyb250LnN0cikpIHtcbiAgLy8gICAgICAgICAgIGxhYmVscy5wdXNoKGZyb250LnN0cik7XG4gIC8vICAgICAgICAgICBsaW5lLnNoaWZ0KCk7XG4gIC8vICAgICAgICAgICBpZiAoVG9rZW4uZXEoVG9rZW4uQ09MT04sIGxpbmUuZnJvbnQoKSkpIGxpbmUuc2hpZnQoKTtcbiAgLy8gICAgICAgICAgIGNvbnRpbnVlO1xuICAvLyAgICAgICAgIH1cbiAgLy8gICAgICAgICAvLyBvdGhlcndpc2UuLi4gc3ludGF4IGVycm9yPyBhbnkgb3RoZXIgb3BlcmF0b3IgYWxsb3dlZD9cbiAgLy8gICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFN5bnRheCBlcnJvcjogdW5leHBlY3RlZCAke1Rva2VuLm5hbWVBdChmcm9udCl9YCk7XG4gIC8vICAgICAgIH0gZWxzZSBpZiAoZnJvbnQudG9rZW4gPT09ICdjcycpIHtcbiAgLy8gICAgICAgICBzd2l0Y2ggKGZyb250LnN0cikge1xuICAvLyAgICAgICAgICAgY2FzZSAnLmV4aXRtYWNybyc6XG4gIC8vICAgICAgICAgICAgIGxpbmUgPSBuZXcgRGVxdWUoKTsgLy8gbm8gbW9yZSBleHBhbnNpb25cbiAgLy8gICAgICAgICAgICAgYnJlYWs7XG4gIC8vICAgICAgICAgICBjYXNlICcuaWZkZWYnOlxuICAvLyAgICAgICAgICAgICAvLyBUT0RPIC0gY2FsbCBoZWxwZXIgbWV0aG9kPyBidXQgaG93PyBjbG9zdXJlP1xuICAgICAgICAgICAgICBcbiAgLy8gICAgICAgICAgICAgYnJlYWs7XG4gIC8vICAgICAgICAgICBjYXNlICcuZGVmaW5lJzpcbiAgLy8gICAgICAgICAgICAgYnJlYWs7XG4gIC8vICAgICAgICAgICBjYXNlICcubWFjcm8nOlxuICAvLyAgICAgICAgICAgICBicmVhaztcbiAgLy8gICAgICAgICB9XG4gIC8vICAgICAgIH1cbiAgLy8gICAgIH1cbiAgLy8gICB9XG4gIC8vIH1cbn1cblxuLy8gSGFuZGxlcyBzY29wZWQgbmFtZXMsIHRvby5cbmZ1bmN0aW9uIHBhcnNlT25lSWRlbnQodHM6IFRva2VuW10sIHByZXY/OiBUb2tlbik6IHN0cmluZyB7XG4gIGNvbnN0IGUgPSBwYXJzZU9uZUV4cHIodHMsIHByZXYpO1xuICByZXR1cm4gRXhwci5pZGVudGlmaWVyKGUpO1xufVxuXG5mdW5jdGlvbiBwYXJzZU9uZUV4cHIodHM6IFRva2VuW10sIHByZXY/OiBUb2tlbik6IEV4cHIge1xuICBpZiAoIXRzLmxlbmd0aCkge1xuICAgIGlmICghcHJldikgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBleHByZXNzaW9uYCk7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBleHByZXNzaW9uOiAke1Rva2VuLm5hbWVBdChwcmV2KX1gKTtcbiAgfVxuICByZXR1cm4gRXhwci5wYXJzZU9ubHkodHMpO1xufVxuXG5mdW5jdGlvbiBub0dhcmJhZ2UodG9rZW46IFRva2VufHVuZGVmaW5lZCk6IHZvaWQge1xuICBpZiAodG9rZW4pIHRocm93IG5ldyBFcnJvcihgZ2FyYmFnZSBhdCBlbmQgb2YgbGluZTogJHtUb2tlbi5uYW1lQXQodG9rZW4pfWApO1xufVxuXG4vLyBmdW5jdGlvbiBmYWlsKHQ6IFRva2VuLCBtc2c6IHN0cmluZyk6IG5ldmVyIHtcbi8vICAgY29uc3QgcyA9IHQuc3RyZWFtO1xuLy8gICBpZiAocykge1xuLy8gICAgIG1zZyArPSBgXFxuICBhdCAke3MuZmlsZX06JHtzLmxpbmV9OiR7cy5jb2x1bW59OiBUb2tlbi5uYW1lKHQpYDtcbi8vICAgICAvLyBUT0RPIC0gZXhwYW5kZWQgZnJvbT9cbi8vICAgfVxuLy8gICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcbi8vIH1cblxuZnVuY3Rpb24gYmFkQ2xvc2Uob3Blbjogc3RyaW5nLCB0b2s6IFRva2VuKTogbmV2ZXIge1xuICB0aHJvdyBuZXcgRXJyb3IoYCR7VG9rZW4ubmFtZSh0b2spfSB3aXRoIG5vICR7b3Blbn0ke1Rva2VuLmF0KHRvayl9YCk7XG59XG5cbmZ1bmN0aW9uIGZhaWwobXNnOiBzdHJpbmcpOiBuZXZlciB7XG4gIHRocm93IG5ldyBFcnJvcihtc2cpO1xufVxuIl19