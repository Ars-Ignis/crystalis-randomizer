export class Evaluator {
    constructor(env) {
        this.env = env;
        this.functions = new Map([
            ['.min', Math.min],
            ['.max', Math.max],
            ['.byteat', (addr) => this.byteAt(addr)],
            ['.wordat', (addr) => this.byteAt(addr) | this.byteAt(addr + 1) << 8],
        ]);
        this.prefix = new Map([
            ['+', x => x],
            ['-', x => -x],
            ['~', x => ~x],
            ['!', x => Number(!x)],
            ['<', x => x & 0xff],
            ['>', x => x >> 8 & 0xff],
        ]);
        this.infix = new Map([
            ['+', (a, b) => a + b],
            ['-', (a, b) => a - b],
            ['*', (a, b) => a * b],
            ['/', (a, b) => Math.floor(a / b)],
            ['.mod', (a, b) => a % b],
            ['<<', (a, b) => a << b],
            ['>>', (a, b) => a >>> b],
            ['&', (a, b) => a & b],
            ['|', (a, b) => a | b],
            ['^', (a, b) => a ^ b],
            ['&&', (a, b) => a && b],
            ['||', (a, b) => a || b],
            ['.xor', (a, b) => Number(!a && b || !b && a)],
            ['<', (a, b) => Number(a < b)],
            ['<=', (a, b) => Number(a <= b)],
            ['>', (a, b) => Number(a > b)],
            ['>=', (a, b) => Number(a >= b)],
            ['=', (a, b) => Number(a === b)],
            ['<>', (a, b) => Number(a !== b)],
        ]);
    }
    definedSymbol(name) {
        throw new Error(`unimplemented`);
    }
    referencedSymbol(name) {
        throw new Error(`unimplemented`);
    }
    evaluate(expr) {
        throw new Error(`unimplemented`);
    }
    simplify(expr) {
        var _a;
        const args = expr.args;
        if (!args)
            return expr;
        let nums = [];
        for (let i = 0; i < args.length; i++) {
            args[i] = this.simplify(args[i]);
            if (args[i].op === 'num' && nums) {
                nums[i] = args[i].num;
            }
            else {
                nums = undefined;
            }
        }
        const f = (_a = this.functions.get(expr.op), (_a !== null && _a !== void 0 ? _a : (args.length === 1 ?
            this.prefix.get(expr.op) :
            this.infix.get(expr.op))));
        if (!f || !nums)
            return { op: expr.op, args };
        const result = f(...nums);
        return { op: 'num', num: result };
    }
    byteAt(addr) {
        throw new Error(`not implemented`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZhbHVhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL2FzbS9ldmFsdWF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsTUFBTSxPQUFPLFNBQVM7SUFFcEIsWUFBcUIsR0FBZ0I7UUFBaEIsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQXdDcEIsY0FBUyxHQUEwQixJQUFJLEdBQUcsQ0FBQztZQUMxRCxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQ2xCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDbEIsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3RFLENBQUMsQ0FBQztRQUVjLFdBQU0sR0FBdUMsSUFBSSxHQUFHLENBQUM7WUFDcEUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDYixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2QsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNkLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ3BCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7U0FFMUIsQ0FBQyxDQUFDO1FBRWMsVUFBSyxHQUF1QixJQUFJLEdBQUcsQ0FBQztZQUNuRCxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3RCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2xDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN6QixDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEIsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3pCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3RCLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMs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QUFPLEVBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFDLENBQUM7UUFDNUMsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDMUIsT0FBTyxFQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBQyxDQUFDO0lBQ2xDLENBQUM7SUFFTyxNQUFNLENBQUMsSUFBWTtRQUN6QixNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDckMsQ0FBQztDQXdDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RXhwcn0gZnJvbSAnLi9leHByLmpzJztcblxuaW50ZXJmYWNlIEVudmlyb25tZW50IHtcbiAgcGMoKTogbnVtYmVyfHVuZGVmaW5lZDsgLy8gPz8/IC0gdW5kZWYgaW4gYSByZWxvYyBjb250ZXh0IG91dHNpZGUgbGlua2VyXG59XG5cbmV4cG9ydCBjbGFzcyBFdmFsdWF0b3Ige1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGVudjogRW52aXJvbm1lbnQpIHt9XG5cbiAgZGVmaW5lZFN5bWJvbChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYHVuaW1wbGVtZW50ZWRgKTtcbiAgfVxuXG4gIHJlZmVyZW5jZWRTeW1ib2wobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGB1bmltcGxlbWVudGVkYCk7XG4gIH1cblxuICBldmFsdWF0ZShleHByOiBFeHByKTogbnVtYmVyIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYHVuaW1wbGVtZW50ZWRgKTtcbiAgfVxuXG4gIHNpbXBsaWZ5KGV4cHI6IEV4cHIpOiBFeHByIHtcbiAgICBjb25zdCBhcmdzID0gZXhwci5hcmdzO1xuICAgIGlmICghYXJncykgcmV0dXJuIGV4cHI7XG4gICAgbGV0IG51bXM6IG51bWJlcltdfHVuZGVmaW5lZCA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykge1xuICAgICAgYXJnc1tpXSA9IHRoaXMuc2ltcGxpZnkoYXJnc1tpXSk7XG4gICAgICBpZiAoYXJnc1tpXS5vcCA9PT0gJ251bScgJiYgbnVtcykge1xuICAgICAgICBudW1zW2ldID0gYXJnc1tpXS5udW0hO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbnVtcyA9IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZiA9XG4gICAgICAgIHRoaXMuZnVuY3Rpb25zLmdldChleHByLm9wKSA/P1xuICAgICAgICAoYXJncy5sZW5ndGggPT09IDEgP1xuICAgICAgICAgICAgdGhpcy5wcmVmaXguZ2V0KGV4cHIub3ApIDpcbiAgICAgICAgICAgIHRoaXMuaW5maXguZ2V0KGV4cHIub3ApKTtcbiAgICBpZiAoIWYgfHwgIW51bXMpIHJldHVybiB7b3A6IGV4cHIub3AsIGFyZ3N9O1xuICAgIGNvbnN0IHJlc3VsdCA9IGYoLi4ubnVtcyk7XG4gICAgcmV0dXJuIHtvcDogJ251bScsIG51bTogcmVzdWx0fTtcbiAgfVxuXG4gIHByaXZhdGUgYnl0ZUF0KGFkZHI6IG51bWJlcik6IG51bWJlciB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBub3QgaW1wbGVtZW50ZWRgKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25zOiBNYXA8c3RyaW5nLCBGdW5jVHlwZT4gPSBuZXcgTWFwKFtcbiAgICBbJy5taW4nLCBNYXRoLm1pbl0sXG4gICAgWycubWF4JywgTWF0aC5tYXhdLFxuICAgIFsnLmJ5dGVhdCcsIChhZGRyKSA9PiB0aGlzLmJ5dGVBdChhZGRyKV0sXG4gICAgWycud29yZGF0JywgKGFkZHIpID0+IHRoaXMuYnl0ZUF0KGFkZHIpIHwgdGhpcy5ieXRlQXQoYWRkciArIDEpIDw8IDhdLFxuICBdKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IHByZWZpeDogTWFwPHN0cmluZywgKHg6IG51bWJlcikgPT4gbnVtYmVyPiA9IG5ldyBNYXAoW1xuICAgIFsnKycsIHggPT4geF0sXG4gICAgWyctJywgeCA9PiAteF0sXG4gICAgWyd+JywgeCA9PiB+eF0sXG4gICAgWychJywgeCA9PiBOdW1iZXIoIXgpXSxcbiAgICBbJzwnLCB4ID0+IHggJiAweGZmXSxcbiAgICBbJz4nLCB4ID0+IHggPj4gOCAmIDB4ZmZdLFxuICAgIC8vIE5PVEU6IC5iYW5rYnl0ZXMgbm90IHN1cHBvcnRlZCB5ZXQuLi5cbiAgXSk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBpbmZpeDogTWFwPHN0cmluZywgQmluT3A+ID0gbmV3IE1hcChbXG4gICAgWycrJywgKGEsIGIpID0+IGEgKyBiXSxcbiAgICBbJy0nLCAoYSwgYikgPT4gYSAtIGJdLFxuICAgIFsnKicsIChhLCBiKSA9PiBhICogYl0sXG4gICAgWycvJywgKGEsIGIpID0+IE1hdGguZmxvb3IoYSAvIGIpXSxcbiAgICBbJy5tb2QnLCAoYSwgYikgPT4gYSAlIGJdLFxuICAgIFsnPDwnLCAoYSwgYikgPT4gYSA8PCBiXSxcbiAgICBbJz4+JywgKGEsIGIpID0+IGEgPj4+IGJdLFxuICAgIFsnJicsIChhLCBiKSA9PiBhICYgYl0sXG4gICAgWyd8JywgKGEsIGIpID0+IGEgfCBiXSxcbiAgICBbJ14nLCAoYSwgYikgPT4gYSBeIGJdLFxuICAgIFsnJiYnLCAoYSwgYikgPT4gYSAmJiBiXSxcbiAgICBbJ3x8JywgKGEsIGIpID0+IGEgfHwgYl0sXG4gICAgWycueG9yJywgKGEsIGIpID0+IE51bWJlcighYSAmJiBiIHx8ICFiICYmIGEpXSwgLy8gbG9naWNhbCB4b3JcbiAgICBbJzwnLCAoYSwgYikgPT4gTnVtYmVyKGEgPCBiKV0sIC8vXG4gICAgWyc8PScsIChhLCBiKSA9PiBOdW1iZXIoYSA8PSBiKV0sXG4gICAgWyc+JywgKGEsIGIpID0+IE51bWJlcihhID4gYildLFxuICAgIFsnPj0nLCAoYSwgYikgPT4gTnVtYmVyKGEgPj0gYildLFxuICAgIFsnPScsIChhLCBiKSA9PiBOdW1iZXIoYSA9PT0gYildLFxuICAgIFsnPD4nLCAoYSwgYikgPT4gTnVtYmVyKGEgIT09IGIpXSwgLy8gVE9ETzogIT0gP1xuICBdKTtcbn1cblxuXG50eXBlIEJpbk9wID0gKGE6IG51bWJlciwgYjogbnVtYmVyKSA9PiBudW1iZXI7XG50eXBlIEZ1bmNUeXBlID0gKC4uLmFyZ3M6IG51bWJlcltdKSA9PiBudW1iZXJcbiJdfQ==