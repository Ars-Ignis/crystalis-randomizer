import { Token } from './token.js';
export class Macro {
    constructor(params, production) {
        this.params = params;
        this.production = production;
    }
    static from(line, source) {
        var _a;
        if (!Token.eq(line[0], Token.MACRO))
            throw new Error(`invalid`);
        if (((_a = line[1]) === null || _a === void 0 ? void 0 : _a.token) !== 'ident')
            throw new Error(`invalid`);
        const params = Token.identsFromCList(line.slice(2));
        const lines = [];
        let next;
        while ((next = source.next())) {
            if (Token.eq(next[0], Token.ENDMACRO))
                return new Macro(params, lines);
            if (Token.eq(next[0], Token.ENDMAC))
                return new Macro(params, lines);
            lines.push(next);
        }
        throw new Error(`EOF looking for .endmacro: ${Token.nameAt(line[1])}`);
    }
    expand(tokens, idGen) {
        let i = 1;
        const replacements = new Map();
        const lines = [];
        for (const param of this.params) {
            const comma = Token.findComma(tokens, i);
            let slice = tokens.slice(i, comma);
            i = comma + 1;
            if (slice.length === 1 && slice[0].token === 'grp') {
                slice = slice[0].inner;
            }
            replacements.set(param, slice);
        }
        if (i < tokens.length) {
            throw new Error(`Too many macro parameters: ${Token.nameAt(tokens[i])}`);
        }
        const locals = new Map();
        for (const line of this.production) {
            if (Token.eq(line[0], Token.LOCAL)) {
                for (const local of Token.identsFromCList(line.slice(1))) {
                    locals.set(local, `${local}@${idGen.next()}`);
                }
            }
            function map(toks) {
                const mapped = [];
                for (const tok of toks) {
                    if (tok.token === 'ident') {
                        const param = replacements.get(tok.str);
                        if (param) {
                            mapped.push(...param);
                            continue;
                        }
                        const local = locals.get(tok.str);
                        if (local) {
                            mapped.push({ token: 'ident', str: local });
                            continue;
                        }
                    }
                    else if (tok.token === 'grp') {
                        mapped.push({ token: 'grp', inner: map(tok.inner) });
                        continue;
                    }
                    mapped.push(tok);
                }
                return mapped;
            }
            lines.push(map(line));
        }
        return lines;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFjcm8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvYXNtL21hY3JvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxLQUFLLEVBQWMsTUFBTSxZQUFZLENBQUM7QUFTOUMsTUFBTSxPQUFPLEtBQUs7SUFDaEIsWUFBNkIsTUFBZ0IsRUFDaEIsVUFBcUI7UUFEckIsV0FBTSxHQUFOLE1BQU0sQ0FBVTtRQUNoQixlQUFVLEdBQVYsVUFBVSxDQUFXO0lBQUcsQ0FBQztJQUV0RCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQWEsRUFBRSxNQUFtQjs7UUFJNUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUM7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2hFLElBQUksT0FBQSxJQUFJLENBQUMsQ0FBQyxDQUFDLDBDQUFFLEtBQUssTUFBSyxPQUFPO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMzRCxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwRCxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDakIsSUFBSSxJQUF1QixDQUFDO1FBQzVCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUU7WUFDN0IsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDO2dCQUFFLE9BQU8sSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3ZFLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUs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LElBQUksQ0FBQyxFQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUMsQ0FBQyxDQUFDO3dCQUNuRCxTQUFTO3FCQUNWO29CQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2xCO2dCQUNELE9BQU8sTUFBTSxDQUFDO1lBQ2hCLENBQUM7WUFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ3ZCO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1Rva2VuLCBUb2tlblNvdXJjZX0gZnJvbSAnLi90b2tlbi5qcyc7XG5cbi8vIGNvbnN0IERFQlVHID0gdHJ1ZTtcbi8vIGNvbnN0IFtdID0gW0RFQlVHXTtcblxuaW50ZXJmYWNlIFNvdXJjZTxUPiB7XG4gIG5leHQoKTogVDtcbn1cblxuZXhwb3J0IGNsYXNzIE1hY3JvIHtcbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihyZWFkb25seSBwYXJhbXM6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgIHJlYWRvbmx5IHByb2R1Y3Rpb246IFRva2VuW11bXSkge31cblxuICBzdGF0aWMgZnJvbShsaW5lOiBUb2tlbltdLCBzb3VyY2U6IFRva2VuU291cmNlKSB7XG4gICAgLy8gRmlyc3QgbGluZSBtdXN0IHN0YXJ0IHdpdGggLm1hY3JvIDxuYW1lPiBbYXJnc11cbiAgICAvLyBMYXN0IGxpbmUgaXMgdGhlIGxpbmUgQkVGT1JFIHRoZSAuZW5kbWFjcm9cbiAgICAvLyBOZXN0ZWQgbWFjcm8gZGVmaW5pdGlvbnMgYXJlIG5vdCBhbGxvd2VkIVxuICAgIGlmICghVG9rZW4uZXEobGluZVswXSwgVG9rZW4uTUFDUk8pKSB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWRgKTtcbiAgICBpZiAobGluZVsxXT8udG9rZW4gIT09ICdpZGVudCcpIHRocm93IG5ldyBFcnJvcihgaW52YWxpZGApO1xuICAgIGNvbnN0IHBhcmFtcyA9IFRva2VuLmlkZW50c0Zyb21DTGlzdChsaW5lLnNsaWNlKDIpKTtcbiAgICBjb25zdCBsaW5lcyA9IFtdO1xuICAgIGxldCBuZXh0OiBUb2tlbltdfHVuZGVmaW5lZDtcbiAgICB3aGlsZSAoKG5leHQgPSBzb3VyY2UubmV4dCgpKSkge1xuICAgICAgaWYgKFRva2VuLmVxKG5leHRbMF0sIFRva2VuLkVORE1BQ1JPKSkgcmV0dXJuIG5ldyBNYWNybyhwYXJhbXMsIGxpbmVzKTtcbiAgICAgIGlmIChUb2tlbi5lcShuZXh0WzBdLCBUb2tlbi5FTkRNQUMpKSByZXR1cm4gbmV3IE1hY3JvKHBhcmFtcywgbGluZXMpO1xuICAgICAgbGluZXMucHVzaChuZXh0KTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBFT0YgbG9va2luZyBmb3IgLmVuZG1hY3JvOiAke1Rva2VuLm5hbWVBdChsaW5lWzFdKX1gKTtcbiAgfVxuXG4gIGV4cGFuZCh0b2tlbnM6IFRva2VuW10sIGlkR2VuOiBTb3VyY2U8bnVtYmVyPik6IFRva2VuW11bXSB7XG4gICAgLy8gRmluZCB0aGUgcGFyYW1ldGVycy5cbiAgICAvLyBUaGlzIGlzIGEgbGl0dGxlIG1vcmUgcHJpbmNpcGxlZCB0aGFuIERlZmluZSwgYnV0IHdlIGRvIG5lZWQgdG8gYmVcbiAgICAvLyBhIGxpdHRsZSBjYXJlZnVsLlxuICAgIGxldCBpID0gMTsgLy8gc3RhcnQgbG9va2luZyBfYWZ0ZXJfIG1hY3JvIGlkZW50XG4gICAgY29uc3QgcmVwbGFjZW1lbnRzID0gbmV3IE1hcDxzdHJpbmcsIFRva2VuW10+KCk7XG4gICAgY29uc3QgbGluZXM6IFRva2VuW11bXSA9IFtdO1xuICAgIFxuICAgIC8vIEZpbmQgYSBjb21tYSwgc2tpcHBpbmcgYmFsYW5jZWQgY3VybGllcy4gIFBhcmVucyBhcmUgbm90IHNwZWNpYWwuXG4gICAgZm9yIChjb25zdCBwYXJhbSBvZiB0aGlzLnBhcmFtcykge1xuICAgICAgY29uc3QgY29tbWEgPSBUb2tlbi5maW5kQ29tbWEodG9rZW5zLCBpKTtcbiAgICAgIGxldCBzbGljZSA9IHRva2Vucy5zbGljZShpLCBjb21tYSk7XG4gICAgICBpID0gY29tbWEgKyAxO1xuICAgICAgaWYgKHNsaWNlLmxlbmd0aCA9PT0gMSAmJiBzbGljZVswXS50b2tlbiA9PT0gJ2dycCcpIHtcbiAgICAgICAgLy8gdW53cmFwIG9uZSBsYXllclxuICAgICAgICBzbGljZSA9IHNsaWNlWzBdLmlubmVyO1xuICAgICAgfVxuICAgICAgcmVwbGFjZW1lbnRzLnNldChwYXJhbSwgc2xpY2UpO1xuICAgIH1cbiAgICBpZiAoaSA8IHRva2Vucy5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVG9vIG1hbnkgbWFjcm8gcGFyYW1ldGVyczogJHtUb2tlbi5uYW1lQXQodG9rZW5zW2ldKX1gKTtcbiAgICB9XG4gICAgLy8gQWxsIHBhcmFtcyBmaWxsZWQgaW4sIG1ha2UgcmVwbGFjZW1lbnRcbiAgICBjb25zdCBsb2NhbHMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgIGZvciAoY29uc3QgbGluZSBvZiB0aGlzLnByb2R1Y3Rpb24pIHtcbiAgICAgIGlmIChUb2tlbi5lcShsaW5lWzBdLCBUb2tlbi5MT0NBTCkpIHtcbiAgICAgICAgZm9yIChjb25zdCBsb2NhbCBvZiBUb2tlbi5pZGVudHNGcm9tQ0xpc3QobGluZS5zbGljZSgxKSkpIHtcbiAgICAgICAgICAvLyBwaWNrIGEgbmFtZSB0aGF0IGlzIGltcG9zc2libGUgdG8gdHlwZSBkdWUgdG8gdGhlICdAJyBpbiB0aGUgbWlkZGxlXG4gICAgICAgICAgbG9jYWxzLnNldChsb2NhbCwgYCR7bG9jYWx9QCR7aWRHZW4ubmV4dCgpfWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyBUT0RPIC0gY2hlY2sgZm9yIC5sb2NhbCBoZXJlIGFuZCByZW5hbWU/ICBtb3ZlIGludG8gYXNzZW1sYmVyXG4gICAgICAvLyBvciBwcmVwcm9jZXNzaW5nLi4uPyAgcHJvYmFibHkgd2FudCB0byBrZWVwIHRyYWNrIGVsc2V3aGVyZS5cbiAgICAgIGZ1bmN0aW9uIG1hcCh0b2tzOiBUb2tlbltdKTogVG9rZW5bXSB7XG4gICAgICAgIGNvbnN0IG1hcHBlZDogVG9rZW5bXSA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHRvayBvZiB0b2tzKSB7XG4gICAgICAgICAgaWYgKHRvay50b2tlbiA9PT0gJ2lkZW50Jykge1xuICAgICAgICAgICAgY29uc3QgcGFyYW0gPSByZXBsYWNlbWVudHMuZ2V0KHRvay5zdHIpO1xuICAgICAgICAgICAgaWYgKHBhcmFtKSB7XG4gICAgICAgICAgICAgIC8vIHRoaXMgaXMgYWN0dWFsbHkgYSBwYXJhbWV0ZXJcbiAgICAgICAgICAgICAgbWFwcGVkLnB1c2goLi4ucGFyYW0pOyAvLyBUT0RPIC0gY29weSB3LyBjaGlsZCBzb3VyY2VpbmZvP1xuICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGxvY2FsID0gbG9jYWxzLmdldCh0b2suc3RyKTtcbiAgICAgICAgICAgIGlmIChsb2NhbCkge1xuICAgICAgICAgICAgICBtYXBwZWQucHVzaCh7dG9rZW46ICdpZGVudCcsIHN0cjogbG9jYWx9KTtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIGlmICh0b2sudG9rZW4gPT09ICdncnAnKSB7XG4gICAgICAgICAgICBtYXBwZWQucHVzaCh7dG9rZW46ICdncnAnLCBpbm5lcjogbWFwKHRvay5pbm5lcil9KTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBtYXBwZWQucHVzaCh0b2spO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtYXBwZWQ7XG4gICAgICB9XG4gICAgICBsaW5lcy5wdXNoKG1hcChsaW5lKSk7XG4gICAgfVxuICAgIHJldHVybiBsaW5lcztcbiAgfVxufVxuIl19