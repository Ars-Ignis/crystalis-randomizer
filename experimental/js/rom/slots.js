import { seq } from './util.js';
class ChestSlot {
    constructor(slot, location, spawn) {
        this.slot = slot;
        this.location = location;
        this.spawn = spawn;
    }
    set(rom, item) {
        const spawn = rom.locations[this.location].spawns[this.spawn];
        spawn.id = item;
        if (item >= 0x70)
            spawn.patternBank = 1;
        if (rom.spoiler) {
            rom.spoiler.addSlot(this.slot, `Chest in ${rom.locations[this.location].name}`, item);
        }
    }
}
class HardcodedSlot {
    constructor(slot, address, name) {
        this.slot = slot;
        this.address = address;
        this.name = name;
    }
    set(rom, item) {
        rom.prg[this.address] = item;
        if (this.name && rom.spoiler)
            rom.spoiler.addSlot(this.slot, this.name || '', item);
    }
}
class BossDropSlot {
    constructor(slot, boss) {
        this.slot = slot;
        this.boss = boss;
    }
    set(rom, item) {
        if (item >= 0x70)
            throw new Error('no mimics on bosses');
        rom.bossKills[this.boss].itemDrop = item;
        if (rom.spoiler) {
            rom.spoiler.addSlot(this.slot, rom.bosses.fromBossKill(this.boss).name, item);
        }
    }
}
class PersonDataSlot {
    constructor(slot, person, index) {
        this.slot = slot;
        this.person = person;
        this.index = index;
    }
    set(rom, item) {
        if (item >= 0x70)
            throw new Error(`no mimics on people`);
        rom.npcs[this.person].data[this.index] = item;
        if (rom.spoiler) {
            const npc = rom.npcs[this.person];
            let name = npc && npc.name;
            if (npc && npc.itemNames) {
                const itemName = npc.itemNames[this.index];
                name = itemName ? name + ' ' + itemName : undefined;
            }
            rom.spoiler.addSlot(this.slot, name || '', item);
        }
    }
}
class Slots {
    constructor(rom) {
        this.rom = rom;
        const slots = seq(0x80, () => []);
        function addSlot(slot) {
            slots[slot.slot].push(slot);
        }
        for (const loc of rom.locations) {
            if (!loc.used)
                continue;
            for (let i = 0; i < loc.spawns.length; i++) {
                const spawn = loc.spawns[i];
                if (spawn.isChest())
                    addSlot(new ChestSlot(spawn.id, loc.id, i));
            }
        }
        for (const npc of rom.npcs) {
            if (!npc.used || !npc.hasDialog)
                continue;
            for (const ds of npc.localDialogs.values()) {
                for (const d of ds) {
                    switch (d.message.action) {
                        case 0x03:
                            addSlot(new PersonDataSlot(npc.data[0], npc.id, 0));
                            break;
                        case 0x09:
                        case 0x11:
                            addSlot(new PersonDataSlot(npc.data[1], npc.id, 1));
                            break;
                    }
                }
            }
        }
        for (const boss of rom.bosses) {
            if (boss.kill === 3 || boss.kill === 13)
                continue;
            if (boss.kill != null && boss.drop != null) {
                addSlot(new BossDropSlot(boss.drop, boss.kill));
            }
        }
        for (const [addr, name] of hardcodedItems) {
            addSlot(new HardcodedSlot(this.rom.prg[addr], addr, name));
        }
        extraSlots.forEach(addSlot);
        this.slots = slots;
    }
    update(fill) {
        for (let i = 0; i < fill.length; i++) {
            if (fill[i] == null)
                continue;
            for (const slot of this.slots[i]) {
                slot.set(this.rom, fill[i]);
            }
        }
        const flags = this.rom.itemGets.map(() => []);
        for (const itemget of this.rom.itemGets) {
            const { id } = itemget;
            for (const flag of itemget.flags) {
                if (flag === -1)
                    continue;
                const target = preservedItemGetFlags.has(flag) ? id : fill[id];
                (flags[target] || []).push(flag);
            }
        }
        for (const itemget of this.rom.itemGets) {
            itemget.flags = flags[itemget.id];
        }
    }
}
const hardcodedItems = [
    [0x367f4, 'Stom fight'],
    [0x3d18f, 'Slimed Kensu'],
    [0x3d1f9, 'Asina'],
    [0x3d2af, 'Stoned Akahana'],
    [0x3d30e, 'Lighthouse Kensu'],
    [0x3d337, 'Rage'],
    [0x3d655, 'Mt Sabre summit trigger'],
    [0x3d6d9, 'Whirlpool trigger'],
    [0x3d6de, 'Swan Kensu'],
    [0x3d6e8, 'Aryllis'],
    [0x3d711],
    [0x3d7fe, 'Akahana statue trade-in'],
];
const extraSlots = [
    new PersonDataSlot(0x36, 0x63, 1),
];
export function update(rom, fill) {
    new Slots(rom).update(fill);
}
const preservedItemGetFlags = new Set([
    0x024,
    0x08b,
    0x2f4,
    0x2f5,
    0x2f6,
    0x2f7,
    0x2f8,
    0x2f9,
    0x2fa,
    0x2fb,
    0x2fc,
    0x2fd,
    0x2fe,
    0x2ff,
]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2xvdHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL3Nsb3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFXOUIsTUFBTSxTQUFTO0lBQ2IsWUFBcUIsSUFBWSxFQUFXLFFBQWdCLEVBQVcsS0FBYTtRQUEvRCxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVcsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUFXLFVBQUssR0FBTCxLQUFLLENBQVE7SUFBRyxDQUFDO0lBRXhGLEdBQUcsQ0FBQyxHQUFRLEVBQUUsSUFBWTtRQUN4QixNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlELEtBQUssQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksSUFBSSxJQUFJLElBQUk7WUFBRSxLQUFLLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztRQUV4QyxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUU7WUFDZixHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFlBQVksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDdkY7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLGFBQWE7SUFDakIsWUFBcUIsSUFBWSxFQUFXLE9BQWUsRUFBVyxJQUFhO1FBQTlELFNBQUksR0FBSixJQUFJLENBQVE7UUFBVyxZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQVcsU0FBSSxHQUFKLElBQUksQ0FBUztJQUFHLENBQUM7SUFFdkYsR0FBRyxDQUFDLEdBQVEsRUFBRSxJQUFZO1FBQ3hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQztRQUU3QixJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLE9BQU87WUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RGLENBQUM7Q0FDRjtBQUVELE1BQU0sWUFBWTtJQUNoQixZQUFxQixJQUFZLEVBQVcsSUFBWTtRQUFuQyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVcsU0FBSSxHQUFKLElBQUksQ0FBUTtJQUFHLENBQUM7SUFFNUQsR0FBRyxDQUFDLEdBQVEsRUFBRSxJQUFZO1FBR3hCLElBQUksSUFBSSxJQUFJLElBQUk7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDekQsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUd6QyxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUU7WUFDZixHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDaEY7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLGNBQWM7SUFDbEIsWUFBcUIsSUFBWSxFQUFXLE1BQWMsRUFBVyxLQUFhO1FBQTdELFNBQUksR0FBSixJQUFJLENBQVE7UUFBVyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVcsVUFBSyxHQUFMLEtBQUssQ0FBUTtJQUFHLENBQUM7SUFFdEYsR0FBRyxDQUFDLEdBQVEsRUFBRSxJQUFZO1FBQ3hCLElBQUksSUFBSSxJQUFJLElBQUk7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDekQsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUM7UUFFOUMsSUFBSSxHQUFHLENBQUMsT0FBTyxFQUFFO1lBQ2YsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbEMsSUFBSSxJQUFJLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDM0IsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLFNBQVMsRUFBRTtnQkFDeEIsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzNDLElBQUksR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7YUFDckQ7WUFDRCxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksSUFBSSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDbEQ7SUFDSCxDQUFDO0NBQ0Y7QUFxQkQsTUFBTSxLQUFLO0lBSVQsWUFBcUIsR0FBUTtRQUFSLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFLM0IsTUFBTSxLQUFLLEdBQWEsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1QyxTQUFTLE9BQU8sQ0FBQyxJQUFVO1lBQ3pCLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlCLENBQUM7UUFHRCxLQUFLLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDL0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJO2dCQUFFLFNBQVM7WUFDeEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMxQyxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUU7b0JBQUUsT0FBTyxDQUFDLElBQUksU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2xFO1NBQ0Y7UUFHRCxLQUFLLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEVBQUU7WUFDMUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUztnQkFBRSxTQUFTO1lBQzFDLEtBQUssTUFBTSxFQUFFLElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsRUFBRTtnQkFDMUMsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUU7b0JBQ2xCLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7d0JBQzFCLEtBQUssSUFBSTs0QkFDUCxPQUFPLENBQUMsSUFBSSxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQ3BELE1BQU07d0JBQ1IsS0FBSyxJQUFJLENBQUM7d0JBQ1YsS0FBSyxJQUFJOzRCQUNQLE9BQU8sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDcEQsTUFBTTtxQkFDUDtpQkFDRjthQUNGO1NBQ0Y7UUFHRCxLQUFLLE1BQU0sSUFBSSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUU7WUFDN0IsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLEVBQUU7Z0JBQUUsU0FBUztZQUNsRCxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxFQUFFO2dCQUMxQyxPQUFPLENBQUMsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzthQUNqRDtTQUNGO1FBR0QsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLGNBQWMsRUFBRTtZQUN6QyxPQUFPLENBQUMsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDNUQ7UUFDRCxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBSTVCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFJRCxNQUFNLENBQUMsSUFBYztRQUNuQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNwQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJO2dCQUFFLFNBQVM7WUFDOUIsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDN0I7U0FDRjtRQUdELE1BQU0sS0FBSyxHQUFlLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMxRCxLQUFLLE1BQU0sT0FBTyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFO1lBQ3ZDLE1BQU0sRUFBQyxFQUFFLEVBQUMsR0FBRyxPQUFPLENBQUM7WUFDckIsS0FBSyxNQUFNLElBQUksSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFFO2dCQUNoQyxJQUFJLElBQUksS0FBSyxDQUFDLENBQUM7b0JBQUUsU0FBUztnQkFDMUIsTUFBTSxNQUFNLEdBQUcscUJBQXFCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFJL0QsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2xDO1NBQ0Y7UUFFRCxLQUFLLE1BQU0sT0FBTyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFO1lBQ3ZDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNuQztJQUNILENBQUM7Q0FDRjtBQUdELE1BQU0sY0FBYyxHQUE4QztJQUNoRSxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUM7SUFDdkIsQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDO0lBQ3pCLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQztJQUNsQixDQUFDLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQztJQUMzQixDQUFDLE9BQU8sRUFBRSxrQkFBa0IsQ0FBQztJQUM3QixDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUM7SUFDakIsQ0FBQyxPQUFPLEVBQUUseUJBQXlCLENBQUM7SUFDcEMsQ0FBQyxPQUFPLEVBQUUsbUJBQW1CLENBQUM7SUFDOUIsQ0FBQyxPQUFPLEVBQUUsWUFBWSxDQUFDO0lBQ3ZCLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQztJQUNwQixDQUFDLE9BQU8sQ0FBQztJQUNULENBQUMsT0FBTyxFQUFFLHlCQUF5QixDQUFDO0NBSXJDLENBQUM7QUFFRixNQUFNLFVBQVUsR0FBRztJQUNqQixJQUFJLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztDQUNsQyxDQUFDO0FBRUYsTUFBTSxVQUFVLE1BQU0sQ0FBQyxHQUFRLEVBQUUsSUFBYztJQUM3QyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDOUIsQ0FBQztBQVNELE1BQU0scUJBQXFCLEdBQUcsSUFBSSxHQUFHLENBQUM7SUFFcEMsS0FBSztJQUdMLEtBQUs7SUFHTCxLQUFLO0lBQ0wsS0FBSztJQUNMLEtBQUs7SUFDTCxLQUFLO0lBQ0wsS0FBSztJQUNMLEtBQUs7SUFDTCxLQUFLO0lBQ0wsS0FBSztJQUNMLEtBQUs7SUFDTCxLQUFLO0lBQ0wsS0FBSztJQUNMLEtBQUs7Q0FDTixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3NlcX0gZnJvbSAnLi91dGlsLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuXG5pbnRlcmZhY2UgU2xvdCB7XG4gIHJlYWRvbmx5IHNsb3Q6IG51bWJlcjtcbiAgc2V0KHJvbTogUm9tLCBpdGVtOiBudW1iZXIpOiB2b2lkO1xufVxuXG4vLyBUT0RPIC0gY29uc2lkZXIgYSBmdW5jdGlvbiBpbnRlcmZhY2UgaW5zdGVhZCBvZiBhIGNsYXNzP1xuLy8gICAgICAtIGFyZSB3ZSBnZXR0aW5nIGJlbmVmaXQgZnJvbSBpbnNwZWN0aW9uIGF0IGFsbD9cblxuY2xhc3MgQ2hlc3RTbG90IGltcGxlbWVudHMgU2xvdCB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHNsb3Q6IG51bWJlciwgcmVhZG9ubHkgbG9jYXRpb246IG51bWJlciwgcmVhZG9ubHkgc3Bhd246IG51bWJlcikge31cblxuICBzZXQocm9tOiBSb20sIGl0ZW06IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHNwYXduID0gcm9tLmxvY2F0aW9uc1t0aGlzLmxvY2F0aW9uXS5zcGF3bnNbdGhpcy5zcGF3bl07XG4gICAgc3Bhd24uaWQgPSBpdGVtO1xuICAgIGlmIChpdGVtID49IDB4NzApIHNwYXduLnBhdHRlcm5CYW5rID0gMTsgLy8gbWltaWNzIGFsd2F5cyB1c2UgcGF0dGVybiBiYW5rIDFcblxuICAgIGlmIChyb20uc3BvaWxlcikge1xuICAgICAgcm9tLnNwb2lsZXIuYWRkU2xvdCh0aGlzLnNsb3QsIGBDaGVzdCBpbiAke3JvbS5sb2NhdGlvbnNbdGhpcy5sb2NhdGlvbl0ubmFtZX1gLCBpdGVtKTtcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgSGFyZGNvZGVkU2xvdCBpbXBsZW1lbnRzIFNsb3Qge1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBzbG90OiBudW1iZXIsIHJlYWRvbmx5IGFkZHJlc3M6IG51bWJlciwgcmVhZG9ubHkgbmFtZT86IHN0cmluZykge31cblxuICBzZXQocm9tOiBSb20sIGl0ZW06IG51bWJlcik6IHZvaWQge1xuICAgIHJvbS5wcmdbdGhpcy5hZGRyZXNzXSA9IGl0ZW07XG5cbiAgICBpZiAodGhpcy5uYW1lICYmIHJvbS5zcG9pbGVyKSByb20uc3BvaWxlci5hZGRTbG90KHRoaXMuc2xvdCwgdGhpcy5uYW1lIHx8ICcnLCBpdGVtKTtcbiAgfVxufVxuXG5jbGFzcyBCb3NzRHJvcFNsb3QgaW1wbGVtZW50cyBTbG90IHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgc2xvdDogbnVtYmVyLCByZWFkb25seSBib3NzOiBudW1iZXIpIHt9XG5cbiAgc2V0KHJvbTogUm9tLCBpdGVtOiBudW1iZXIpOiB2b2lkIHtcbiAgICAvL3JvbS5ib3NzZXMuZnJvbUJvc3NLaWxsKHRoaXMuYm9zcykuZHJvcCA9IGl0ZW07XG4gICAgLy9jb25zdCBhZGRyID0gcmVhZExpdHRsZUVuZGlhbihyb20ucHJnLCAweDFmOTZiICsgMiAqIHRoaXMuYm9zcykgKyAweDE0MDAwO1xuICAgIGlmIChpdGVtID49IDB4NzApIHRocm93IG5ldyBFcnJvcignbm8gbWltaWNzIG9uIGJvc3NlcycpO1xuICAgIHJvbS5ib3NzS2lsbHNbdGhpcy5ib3NzXS5pdGVtRHJvcCA9IGl0ZW07XG4gICAgLy9yb20ucHJnW2FkZHIgKyA0XSA9IGl0ZW07XG5cbiAgICBpZiAocm9tLnNwb2lsZXIpIHtcbiAgICAgIHJvbS5zcG9pbGVyLmFkZFNsb3QodGhpcy5zbG90LCByb20uYm9zc2VzLmZyb21Cb3NzS2lsbCh0aGlzLmJvc3MpIS5uYW1lLCBpdGVtKTtcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgUGVyc29uRGF0YVNsb3QgaW1wbGVtZW50cyBTbG90IHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgc2xvdDogbnVtYmVyLCByZWFkb25seSBwZXJzb246IG51bWJlciwgcmVhZG9ubHkgaW5kZXg6IG51bWJlcikge31cblxuICBzZXQocm9tOiBSb20sIGl0ZW06IG51bWJlcik6IHZvaWQge1xuICAgIGlmIChpdGVtID49IDB4NzApIHRocm93IG5ldyBFcnJvcihgbm8gbWltaWNzIG9uIHBlb3BsZWApO1xuICAgIHJvbS5ucGNzW3RoaXMucGVyc29uXS5kYXRhW3RoaXMuaW5kZXhdID0gaXRlbTtcblxuICAgIGlmIChyb20uc3BvaWxlcikge1xuICAgICAgY29uc3QgbnBjID0gcm9tLm5wY3NbdGhpcy5wZXJzb25dO1xuICAgICAgbGV0IG5hbWUgPSBucGMgJiYgbnBjLm5hbWU7XG4gICAgICBpZiAobnBjICYmIG5wYy5pdGVtTmFtZXMpIHtcbiAgICAgICAgY29uc3QgaXRlbU5hbWUgPSBucGMuaXRlbU5hbWVzW3RoaXMuaW5kZXhdO1xuICAgICAgICBuYW1lID0gaXRlbU5hbWUgPyBuYW1lICsgJyAnICsgaXRlbU5hbWUgOiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICByb20uc3BvaWxlci5hZGRTbG90KHRoaXMuc2xvdCwgbmFtZSB8fCAnJywgaXRlbSk7XG4gICAgfVxuICB9XG59XG5cbi8vIC8vIE5PVEU6IHRoaXMgaXMgcHJldHR5IGluZWZmaWNpZW50LCBPKG5eMikgaW4gaXRlbWdldCBzbG90cy4gIEJ1dCB3ZSBydW4gaXRcbi8vIC8vIG9uY2UgYW5kIGl0J3MgYSBsb3QgZmFzdGVyIHRoYW4gb3RoZXIgdGhpbmdzLCBzbyBpdCdzIG5vdCBhIGJpZyBkZWFsLlxuLy8gY2xhc3MgUmV2ZXJzZUZsYWdTbG90IGltcGxlbWVudHMgU2xvdCB7XG4vLyAgIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGZsYWc6IG51bWJlcikge31cblxuLy8gICAvLyBUT0RPIC0gMDEzIGRlZmVhdGVkIHNhYmVyYSBzaG91bGQgYmUgYSByZXZlcnNlIGZsYWcgc2xvdCBmb3Igc2FiZXJhJ3MgZHJvcFxuLy8gICAvLyAgICAgIC0gdGhlbiB3ZSBjYW4gcmVtb3ZlIGFsbCB0aGUgZXh0cmEgc2V0c1xuLy8gICBzZXQocm9tOiBSb20sIGl0ZW06IG51bWJlcik6IHZvaWQge1xuLy8gICAgIGZvciAoY29uc3QgaXRlbWdldCBvZiByb20uaXRlbUdldHMpIHtcbi8vICAgICAgIGNvbnN0IGluZGV4ID0gaXRlbWdldC5mbGFncy5pbmRleE9mKHRoaXMuZmxhZyk7XG4vLyAgICAgICBpZiAoaXRlbXMuaGFzKGl0ZW1nZXQuaWQpICYmIGluZGV4IDwgMCkgaXRlbWdldC5mbGFncy5wdXNoKHRoaXMuZmxhZyk7XG4vLyAgICAgICBpZiAoIWl0ZW1zLmhhcyhpdGVtZ2V0LmlkKSAmJiBpbmRleCA+PSAwKSBpdGVtZ2V0LmZsYWdzLnNwbGljZShpbmRleCwgMSk7XG4vLyAgICAgfVxuLy8gICB9XG4vLyB9XG5cblxuLy8gTWFwcyBmcm9tIHNsb3QgdG8gaXRlbSBhY3R1YWxseSBpbiB0aGUgc2xvdC5cbi8vIE1hbmFnZXMgYWxsIHRoZSBuZWNlc3NhcnkgdXBkYXRlcyBmb3IgcmVhcnJhbmdpbmcgaXRlbXMuXG5jbGFzcyBTbG90cyB7XG5cbiAgcHJpdmF0ZSBzbG90czogUmVhZG9ubHlBcnJheTxSZWFkb25seUFycmF5PFNsb3Q+PjtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSkge1xuXG4gICAgLy8gVE9ETyAtIHRoaXMgbmVlZHMgdG8gbW92ZSB0byBBRlRFUiB3ZSd2ZSBkb25lIHNvbWUgaW5pdGlhbCBmaXh1cC4uLiFcbiAgICAvLyBNYXliZSB3ZSByZWFsbHkgZG8gbmVlZCB0byBtYWtlIGl0IHNlcGFyYXRlIGZyb20gdGhlIHJvbT9cblxuICAgIGNvbnN0IHNsb3RzOiBTbG90W11bXSA9IHNlcSgweDgwLCAoKSA9PiBbXSk7XG4gICAgZnVuY3Rpb24gYWRkU2xvdChzbG90OiBTbG90KTogdm9pZCB7XG4gICAgICBzbG90c1tzbG90LnNsb3RdLnB1c2goc2xvdCk7XG4gICAgfVxuXG4gICAgLy8gRmluZCBjaGVzdHNcbiAgICBmb3IgKGNvbnN0IGxvYyBvZiByb20ubG9jYXRpb25zKSB7XG4gICAgICBpZiAoIWxvYy51c2VkKSBjb250aW51ZTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbG9jLnNwYXducy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzcGF3biA9IGxvYy5zcGF3bnNbaV07XG4gICAgICAgIGlmIChzcGF3bi5pc0NoZXN0KCkpIGFkZFNsb3QobmV3IENoZXN0U2xvdChzcGF3bi5pZCwgbG9jLmlkLCBpKSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRmluZCBpdGVtIGdpdmVyc1xuICAgIGZvciAoY29uc3QgbnBjIG9mIHJvbS5ucGNzKSB7XG4gICAgICBpZiAoIW5wYy51c2VkIHx8ICFucGMuaGFzRGlhbG9nKSBjb250aW51ZTtcbiAgICAgIGZvciAoY29uc3QgZHMgb2YgbnBjLmxvY2FsRGlhbG9ncy52YWx1ZXMoKSkge1xuICAgICAgICBmb3IgKGNvbnN0IGQgb2YgZHMpIHtcbiAgICAgICAgICBzd2l0Y2ggKGQubWVzc2FnZS5hY3Rpb24pIHtcbiAgICAgICAgICBjYXNlIDB4MDM6XG4gICAgICAgICAgICBhZGRTbG90KG5ldyBQZXJzb25EYXRhU2xvdChucGMuZGF0YVswXSwgbnBjLmlkLCAwKSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIDB4MDk6XG4gICAgICAgICAgY2FzZSAweDExOlxuICAgICAgICAgICAgYWRkU2xvdChuZXcgUGVyc29uRGF0YVNsb3QobnBjLmRhdGFbMV0sIG5wYy5pZCwgMSkpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRmluZCBib3NzIGRyb3BzXG4gICAgZm9yIChjb25zdCBib3NzIG9mIHJvbS5ib3NzZXMpIHtcbiAgICAgIGlmIChib3NzLmtpbGwgPT09IDMgfHwgYm9zcy5raWxsID09PSAxMykgY29udGludWU7IC8vIGZhbHNlIGFsYXJtc1xuICAgICAgaWYgKGJvc3Mua2lsbCAhPSBudWxsICYmIGJvc3MuZHJvcCAhPSBudWxsKSB7XG4gICAgICAgIGFkZFNsb3QobmV3IEJvc3NEcm9wU2xvdChib3NzLmRyb3AsIGJvc3Mua2lsbCkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFJlY29yZCBoYXJkY29kZWQgc2xvdHNcbiAgICBmb3IgKGNvbnN0IFthZGRyLCBuYW1lXSBvZiBoYXJkY29kZWRJdGVtcykge1xuICAgICAgYWRkU2xvdChuZXcgSGFyZGNvZGVkU2xvdCh0aGlzLnJvbS5wcmdbYWRkcl0sIGFkZHIsIG5hbWUpKTtcbiAgICB9XG4gICAgZXh0cmFTbG90cy5mb3JFYWNoKGFkZFNsb3QpO1xuXG4gICAgLy8gY29uc29sZS5sb2coJ3Nsb3RzJywgc2xvdHMpO1xuXG4gICAgdGhpcy5zbG90cyA9IHNsb3RzO1xuICB9XG5cbiAgLy8gTk9URTogdGhpcy5zbG90cyBpcyBub3QgcmlnaHQgLSB0aGVyZSBhcmUgbXVsdGlwbGUgQ2hlc3RTbG90cyBpbiB0aGUgc2FtZVxuICAvLyBsaXN0LCBvciBhIENoZXN0U2xvdCBmb3IgMzQga2V5IHRvIHN0eHksIHdoaWNoIHNob3VsZCBub3QgYmUuLi4/XG4gIHVwZGF0ZShmaWxsOiBudW1iZXJbXSk6IHZvaWQge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsbC5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGZpbGxbaV0gPT0gbnVsbCkgY29udGludWU7XG4gICAgICBmb3IgKGNvbnN0IHNsb3Qgb2YgdGhpcy5zbG90c1tpXSkge1xuICAgICAgICBzbG90LnNldCh0aGlzLnJvbSwgZmlsbFtpXSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTW92ZSBhbGwgdGhlIGZsYWdzLiAgRmlyc3QgcmVhZCB0aGVtLlxuICAgIGNvbnN0IGZsYWdzOiBudW1iZXJbXVtdID0gdGhpcy5yb20uaXRlbUdldHMubWFwKCgpID0+IFtdKTtcbiAgICBmb3IgKGNvbnN0IGl0ZW1nZXQgb2YgdGhpcy5yb20uaXRlbUdldHMpIHtcbiAgICAgIGNvbnN0IHtpZH0gPSBpdGVtZ2V0O1xuICAgICAgZm9yIChjb25zdCBmbGFnIG9mIGl0ZW1nZXQuZmxhZ3MpIHtcbiAgICAgICAgaWYgKGZsYWcgPT09IC0xKSBjb250aW51ZTtcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gcHJlc2VydmVkSXRlbUdldEZsYWdzLmhhcyhmbGFnKSA/IGlkIDogZmlsbFtpZF07XG4gICAgICAgIC8vIE5PVEU6IGl0J3MgcG9zc2libGUgdGhlIHRhcmdldCBzbG90IGlzIGEgbWltaWMgLSBpbiB0aGF0IGNhc2VcbiAgICAgICAgLy8gd2UndmUgYWxyZWFkeSBndWFyYW50ZWVkIHRoYXQgdGhlIGZsYWcganVzdCBhIGNvbnN1bWFibGUgY2hlc3RcbiAgICAgICAgLy8gZmxhZywgc28gaXQncyBzYWZlIHRvIGp1c3QgZHJvcCBpdCBvbiB0aGUgZmxvb3IuXG4gICAgICAgIChmbGFnc1t0YXJnZXRdIHx8IFtdKS5wdXNoKGZsYWcpO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBOb3cgd3JpdGUgdGhlbVxuICAgIGZvciAoY29uc3QgaXRlbWdldCBvZiB0aGlzLnJvbS5pdGVtR2V0cykge1xuICAgICAgaXRlbWdldC5mbGFncyA9IGZsYWdzW2l0ZW1nZXQuaWRdO1xuICAgIH1cbiAgfVxufVxuXG5cbmNvbnN0IGhhcmRjb2RlZEl0ZW1zOiBSZWFkb25seUFycmF5PHJlYWRvbmx5IFtudW1iZXIsIHN0cmluZz9dPiA9IFtcbiAgWzB4MzY3ZjQsICdTdG9tIGZpZ2h0J10sXG4gIFsweDNkMThmLCAnU2xpbWVkIEtlbnN1J10sXG4gIFsweDNkMWY5LCAnQXNpbmEnXSxcbiAgWzB4M2QyYWYsICdTdG9uZWQgQWthaGFuYSddLFxuICBbMHgzZDMwZSwgJ0xpZ2h0aG91c2UgS2Vuc3UnXSxcbiAgWzB4M2QzMzcsICdSYWdlJ10sXG4gIFsweDNkNjU1LCAnTXQgU2FicmUgc3VtbWl0IHRyaWdnZXInXSwgLy8gcGFyYWx5c2lzXG4gIFsweDNkNmQ5LCAnV2hpcmxwb29sIHRyaWdnZXInXSxcbiAgWzB4M2Q2ZGUsICdTd2FuIEtlbnN1J10sXG4gIFsweDNkNmU4LCAnQXJ5bGxpcyddLFxuICBbMHgzZDcxMV0sIC8vIHJlZnJlc2ggZnJvbSB0cmlnZ2VyXG4gIFsweDNkN2ZlLCAnQWthaGFuYSBzdGF0dWUgdHJhZGUtaW4nXSxcbiAgLy9bMHgzZTNhMl0sIC8vIGludmlzaWJsZSBmbGFnIGZvciBzdGF0dWUgb2Ygb255eFxuICAvL1sweDNlM2E2XSwgLy8gaW52aXNpYmxlIGZsYWcgZm9yIGtpcmlzYSBwbGFudFxuICAvL1sweDNlM2FhXSwgLy8gaW52aXNpYmxlIGZsYWcgZm9yIGxvdmUgcGVuZGFudFxuXTtcblxuY29uc3QgZXh0cmFTbG90cyA9IFtcbiAgbmV3IFBlcnNvbkRhdGFTbG90KDB4MzYsIDB4NjMsIDEpLCAvLyBzaGVsbCBmbHV0ZSAoZG9scGhpbilcbl07XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGUocm9tOiBSb20sIGZpbGw6IG51bWJlcltdKTogdm9pZCB7XG4gIG5ldyBTbG90cyhyb20pLnVwZGF0ZShmaWxsKTtcbn1cblxuXG4vKipcbiAqIEJ5IGRlZmF1bHQgd2hlbiB3ZSBmaWxsIGEgc2xvdCwgd2UgYnJpbmcgdGhlIGl0ZW1nZXQgZmxhZ3MgYWxvbmcgd2l0aC5cbiAqIFRoaXMgZW5zdXJlcyB0aGF0IGRpYWxvZ3MgdGhhdCB0cmlnZ2VyIG9mZiBvZiBpdCBhcmVuJ3QgYnJva2VuLlxuICogVGhlIGZvbGxvd2luZyBhcmUgbm90IG1vdmVkLCB0aG91Z2ggd2Ugc2hvdWxkIGZpeCB0aGF0IGJ5IGNoYW5naW5nIHRoZW1cbiAqIGludG8gdGhlIG5vcm1hbCAyeHggaXRlbSBmbGFncy5cbiAqL1xuY29uc3QgcHJlc2VydmVkSXRlbUdldEZsYWdzID0gbmV3IFNldChbXG4gIC8vIDB4MDBlLCAvLyB0ZWxlcGF0aHkgLSB1c2VkIGZvciB0YWxraW5nIHRvIGFuaW1hbHMvZHdhcmZzXG4gIDB4MDI0LCAvLyBnZW5lcmFscyBkZWZlYXRlZCAtIHdpbGwgZGVhbCB3aXRoIHRoaXMgbGF0ZXJcbiAgLy8gMHgwM2YsIC8vIHRlbGVwb3J0IC0gdXNlZCBmb3IgdHJpZ2dlclxuICAvLyAweDA1ZiwgLy8gc3dvcmQgb2YgdGh1bmRlciAtIHVzZWQgdG8gdHJpZ2dlciBtYXNzYWNyZVxuICAweDA4YiwgLy8gc2hlbGwgZmx1dGUgLSBjaGVja2VkIGJ5IGZpc2hlcm1hbiAtLSBUT0RPIGNoYW5nZSB0byAyMzY/XG4gIC8vIDB4MDY3LCAvLyBkZWZlYXRlZCBtYWRvIDEgKGJhbGwgb2YgdGh1bmRlcikgLSB3YW50IHNsb3QsIG5vdCBpdGVtXG4gIC8vIEFueSB3YXJwIHBvaW50IGZsYWdzIG5lZWQgdG8gZ2V0IHByZXNlcnZlZCAoc3dvcmQgb2YgdGh1bmRlciB3YXJwKVxuICAweDJmNCxcbiAgMHgyZjUsXG4gIDB4MmY2LFxuICAweDJmNyxcbiAgMHgyZjgsXG4gIDB4MmY5LFxuICAweDJmYSxcbiAgMHgyZmIsXG4gIDB4MmZjLFxuICAweDJmZCwgLy8gc2h5cm9uIHdhcnAgcG9pbnQgZnJvbSBzd29yZCBvZiB0aHVuZGVyXG4gIDB4MmZlLFxuICAweDJmZixcbl0pO1xuIl19