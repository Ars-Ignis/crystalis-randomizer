import { seq } from './util.js';
class ChestSlot {
    constructor(slot, location, spawn) {
        this.slot = slot;
        this.location = location;
        this.spawn = spawn;
    }
    set(rom, item) {
        const spawn = rom.locations[this.location].spawns[this.spawn];
        spawn.id = item;
        if (item >= 0x70)
            spawn.patternBank = 1;
        if (rom.spoiler) {
            rom.spoiler.addSlot(this.slot, `Chest in ${rom.locations[this.location].name}`, item);
        }
    }
}
class HardcodedSlot {
    constructor(slot, address, name) {
        this.slot = slot;
        this.address = address;
        this.name = name;
    }
    set(rom, item) {
        rom.prg[this.address] = item;
        if (this.name && rom.spoiler)
            rom.spoiler.addSlot(this.slot, this.name || '', item);
    }
}
class BossDropSlot {
    constructor(slot, boss) {
        this.slot = slot;
        this.boss = boss;
    }
    set(rom, item) {
        if (item >= 0x70)
            throw new Error('no mimics on bosses');
        rom.bossKills[this.boss].itemDrop = item;
        if (rom.spoiler) {
            rom.spoiler.addSlot(this.slot, rom.bosses.fromBossKill(this.boss).name, item);
        }
    }
}
class PersonDataSlot {
    constructor(slot, person, index) {
        this.slot = slot;
        this.person = person;
        this.index = index;
    }
    set(rom, item) {
        if (item >= 0x70)
            throw new Error(`no mimics on people`);
        rom.npcs[this.person].data[this.index] = item;
        if (rom.spoiler) {
            const npc = rom.npcs[this.person];
            let name = npc && npc.name;
            if (npc && npc.itemNames) {
                const itemName = npc.itemNames[this.index];
                name = itemName ? name + ' ' + itemName : undefined;
            }
            rom.spoiler.addSlot(this.slot, name || '', item);
        }
    }
}
class Slots {
    constructor(rom) {
        this.rom = rom;
        const slots = seq(0x80, () => []);
        function addSlot(slot) {
            slots[slot.slot].push(slot);
        }
        for (const loc of rom.locations) {
            if (!loc.used)
                continue;
            for (let i = 0; i < loc.spawns.length; i++) {
                const spawn = loc.spawns[i];
                if (spawn.isChest())
                    addSlot(new ChestSlot(spawn.id, loc.id, i));
            }
        }
        for (const npc of rom.npcs) {
            if (!npc.used || !npc.hasDialog)
                continue;
            for (const ds of npc.localDialogs.values()) {
                for (const d of ds) {
                    switch (d.message.action) {
                        case 0x03:
                        case 0x0a:
                            addSlot(new PersonDataSlot(npc.data[0], npc.id, 0));
                            break;
                        case 0x11:
                            addSlot(new PersonDataSlot(npc.data[1], npc.id, 1));
                            break;
                        case 0x09:
                            if (npc.data[1] < 0x80) {
                                addSlot(new PersonDataSlot(npc.data[1], npc.id, 1));
                            }
                            break;
                    }
                }
            }
        }
        for (const boss of rom.bosses) {
            if (boss.kill === 3 || boss.kill === 13)
                continue;
            if (boss.kill != null && boss.drop != null) {
                addSlot(new BossDropSlot(boss.drop, boss.kill));
            }
        }
        for (const [addr, name] of hardcodedItems) {
            addSlot(new HardcodedSlot(this.rom.prg[addr], addr, name));
        }
        extraSlots.forEach(addSlot);
        this.slots = slots;
    }
    update(fill) {
        for (let i = 0; i < fill.length; i++) {
            if (fill[i] == null)
                continue;
            for (const slot of this.slots[i]) {
                slot.set(this.rom, fill[i]);
            }
        }
        const flags = this.rom.itemGets.map(() => []);
        for (const itemget of this.rom.itemGets) {
            const { id } = itemget;
            for (const flag of itemget.flags) {
                if (flag === -1)
                    continue;
                const target = preservedItemGetFlags.has(flag) ? id : fill[id];
                (flags[target] || []).push(flag);
            }
        }
        for (const itemget of this.rom.itemGets) {
            itemget.flags = flags[itemget.id];
        }
    }
}
const hardcodedItems = [
    [0x367f4, 'Stom fight'],
    [0x3d18f, 'Slimed Kensu'],
    [0x3d1f9, 'Asina'],
    [0x3d2af, 'Stoned Akahana'],
    [0x3d337, 'Rage'],
    [0x3d655, 'Mt Sabre summit trigger'],
    [0x3d6d9, 'Whirlpool trigger'],
    [0x3d6de, 'Swan Kensu'],
    [0x3d6e8, 'Aryllis'],
    [0x3d711],
    [0x3d7fe, 'Akahana statue trade-in'],
];
const extraSlots = [
    new PersonDataSlot(0x36, 0x63, 1),
];
export function update(rom, fill) {
    new Slots(rom).update(fill);
}
const preservedItemGetFlags = new Set([
    0x024,
    0x08b,
    0x2f4,
    0x2f5,
    0x2f6,
    0x2f7,
    0x2f8,
    0x2f9,
    0x2fa,
    0x2fb,
    0x2fc,
    0x2fd,
    0x2fe,
    0x2ff,
]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2xvdHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL3Nsb3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFXOUIsTUFBTSxTQUFTO0lBQ2IsWUFBcUIsSUFBWSxFQUFXLFFBQWdCLEVBQVcsS0FBYTtRQUEvRCxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVcsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUFXLFVBQUssR0FBTCxLQUFLLENBQVE7SUFBRyxDQUFDO0lBRXhGLEdBQUcsQ0FBQyxHQUFRLEVBQUUsSUFBWTtRQUN4QixNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlELEtBQUssQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksSUFBSSxJQUFJLElBQUk7WUFBRSxLQUFLLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztRQUV4QyxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUU7WUFDZixHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFlBQVksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDdkY7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLGFBQWE7SUFDakIsWUFBcUIsSUFBWSxFQUFXLE9BQWUsRUFBVyxJQUFhO1FBQTlELFNBQUksR0FBSixJQUFJLENBQVE7UUFBVyxZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQVcsU0FBSSxHQUFKLElBQUksQ0FBUztJQUFHLENBQUM7SUFFdkYsR0FBRyxDQUFDLEdBQVEsRUFBRSxJQUFZO1FBQ3hCLEdBQUcsQ0FBQyxHQUFHLENB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RSxtQkFBbUIsQ0FBQztJQUM5QixDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUM7SUFDdkIsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDO0lBQ3BCLENBQUMsT0FBTyxDQUFDO0lBQ1QsQ0FBQyxPQUFPLEVBQUUseUJBQXlCLENBQUM7Q0FJckMsQ0FBQztBQUVGLE1BQU0sVUFBVSxHQUFHO0lBQ2pCLElBQUksY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0NBQ2xDLENBQUM7QUFFRixNQUFNLFVBQVUsTUFBTSxDQUFDLEdBQVEsRUFBRSxJQUFjO0lBQzdDLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM5QixDQUFDO0FBU0QsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUVwQyxLQUFLO0lBR0wsS0FBSztJQUdMLEtBQUs7SUFDTCxLQUFLO0lBQ0wsS0FBSztJQUNMLEtBQUs7SUFDTCxLQUFLO0lBQ0wsS0FBSztJQUNMLEtBQUs7SUFDTCxLQUFLO0lBQ0wsS0FBSztJQUNMLEtBQUs7SUFDTCxLQUFLO0lBQ0wsS0FBSztDQUNOLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7c2VxfSBmcm9tICcuL3V0aWwuanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5cbmludGVyZmFjZSBTbG90IHtcbiAgcmVhZG9ubHkgc2xvdDogbnVtYmVyO1xuICBzZXQocm9tOiBSb20sIGl0ZW06IG51bWJlcik6IHZvaWQ7XG59XG5cbi8vIFRPRE8gLSBjb25zaWRlciBhIGZ1bmN0aW9uIGludGVyZmFjZSBpbnN0ZWFkIG9mIGEgY2xhc3M/XG4vLyAgICAgIC0gYXJlIHdlIGdldHRpbmcgYmVuZWZpdCBmcm9tIGluc3BlY3Rpb24gYXQgYWxsP1xuXG5jbGFzcyBDaGVzdFNsb3QgaW1wbGVtZW50cyBTbG90IHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgc2xvdDogbnVtYmVyLCByZWFkb25seSBsb2NhdGlvbjogbnVtYmVyLCByZWFkb25seSBzcGF3bjogbnVtYmVyKSB7fVxuXG4gIHNldChyb206IFJvbSwgaXRlbTogbnVtYmVyKTogdm9pZCB7XG4gICAgY29uc3Qgc3Bhd24gPSByb20ubG9jYXRpb25zW3RoaXMubG9jYXRpb25dLnNwYXduc1t0aGlzLnNwYXduXTtcbiAgICBzcGF3bi5pZCA9IGl0ZW07XG4gICAgaWYgKGl0ZW0gPj0gMHg3MCkgc3Bhd24ucGF0dGVybkJhbmsgPSAxOyAvLyBtaW1pY3MgYWx3YXlzIHVzZSBwYXR0ZXJuIGJhbmsgMVxuXG4gICAgaWYgKHJvbS5zcG9pbGVyKSB7XG4gICAgICByb20uc3BvaWxlci5hZGRTbG90KHRoaXMuc2xvdCwgYENoZXN0IGluICR7cm9tLmxvY2F0aW9uc1t0aGlzLmxvY2F0aW9uXS5uYW1lfWAsIGl0ZW0pO1xuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBIYXJkY29kZWRTbG90IGltcGxlbWVudHMgU2xvdCB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHNsb3Q6IG51bWJlciwgcmVhZG9ubHkgYWRkcmVzczogbnVtYmVyLCByZWFkb25seSBuYW1lPzogc3RyaW5nKSB7fVxuXG4gIHNldChyb206IFJvbSwgaXRlbTogbnVtYmVyKTogdm9pZCB7XG4gICAgcm9tLnByZ1t0aGlzLmFkZHJlc3NdID0gaXRlbTtcblxuICAgIGlmICh0aGlzLm5hbWUgJiYgcm9tLnNwb2lsZXIpIHJvbS5zcG9pbGVyLmFkZFNsb3QodGhpcy5zbG90LCB0aGlzLm5hbWUgfHwgJycsIGl0ZW0pO1xuICB9XG59XG5cbmNsYXNzIEJvc3NEcm9wU2xvdCBpbXBsZW1lbnRzIFNsb3Qge1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBzbG90OiBudW1iZXIsIHJlYWRvbmx5IGJvc3M6IG51bWJlcikge31cblxuICBzZXQocm9tOiBSb20sIGl0ZW06IG51bWJlcik6IHZvaWQge1xuICAgIC8vcm9tLmJvc3Nlcy5mcm9tQm9zc0tpbGwodGhpcy5ib3NzKS5kcm9wID0gaXRlbTtcbiAgICAvL2NvbnN0IGFkZHIgPSByZWFkTGl0dGxlRW5kaWFuKHJvbS5wcmcsIDB4MWY5NmIgKyAyICogdGhpcy5ib3NzKSArIDB4MTQwMDA7XG4gICAgaWYgKGl0ZW0gPj0gMHg3MCkgdGhyb3cgbmV3IEVycm9yKCdubyBtaW1pY3Mgb24gYm9zc2VzJyk7XG4gICAgcm9tLmJvc3NLaWxsc1t0aGlzLmJvc3NdLml0ZW1Ecm9wID0gaXRlbTtcbiAgICAvL3JvbS5wcmdbYWRkciArIDRdID0gaXRlbTtcblxuICAgIGlmIChyb20uc3BvaWxlcikge1xuICAgICAgcm9tLnNwb2lsZXIuYWRkU2xvdCh0aGlzLnNsb3QsIHJvbS5ib3NzZXMuZnJvbUJvc3NLaWxsKHRoaXMuYm9zcykhLm5hbWUsIGl0ZW0pO1xuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBQZXJzb25EYXRhU2xvdCBpbXBsZW1lbnRzIFNsb3Qge1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBzbG90OiBudW1iZXIsIHJlYWRvbmx5IHBlcnNvbjogbnVtYmVyLCByZWFkb25seSBpbmRleDogbnVtYmVyKSB7fVxuXG4gIHNldChyb206IFJvbSwgaXRlbTogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKGl0ZW0gPj0gMHg3MCkgdGhyb3cgbmV3IEVycm9yKGBubyBtaW1pY3Mgb24gcGVvcGxlYCk7XG4gICAgcm9tLm5wY3NbdGhpcy5wZXJzb25dLmRhdGFbdGhpcy5pbmRleF0gPSBpdGVtO1xuXG4gICAgaWYgKHJvbS5zcG9pbGVyKSB7XG4gICAgICBjb25zdCBucGMgPSByb20ubnBjc1t0aGlzLnBlcnNvbl07XG4gICAgICBsZXQgbmFtZSA9IG5wYyAmJiBucGMubmFtZTtcbiAgICAgIGlmIChucGMgJiYgbnBjLml0ZW1OYW1lcykge1xuICAgICAgICBjb25zdCBpdGVtTmFtZSA9IG5wYy5pdGVtTmFtZXNbdGhpcy5pbmRleF07XG4gICAgICAgIG5hbWUgPSBpdGVtTmFtZSA/IG5hbWUgKyAnICcgKyBpdGVtTmFtZSA6IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICAgIHJvbS5zcG9pbGVyLmFkZFNsb3QodGhpcy5zbG90LCBuYW1lIHx8ICcnLCBpdGVtKTtcbiAgICB9XG4gIH1cbn1cblxuLy8gLy8gTk9URTogdGhpcyBpcyBwcmV0dHkgaW5lZmZpY2llbnQsIE8obl4yKSBpbiBpdGVtZ2V0IHNsb3RzLiAgQnV0IHdlIHJ1biBpdFxuLy8gLy8gb25jZSBhbmQgaXQncyBhIGxvdCBmYXN0ZXIgdGhhbiBvdGhlciB0aGluZ3MsIHNvIGl0J3Mgbm90IGEgYmlnIGRlYWwuXG4vLyBjbGFzcyBSZXZlcnNlRmxhZ1Nsb3QgaW1wbGVtZW50cyBTbG90IHtcbi8vICAgY29uc3RydWN0b3IocmVhZG9ubHkgZmxhZzogbnVtYmVyKSB7fVxuXG4vLyAgIC8vIFRPRE8gLSAwMTMgZGVmZWF0ZWQgc2FiZXJhIHNob3VsZCBiZSBhIHJldmVyc2UgZmxhZyBzbG90IGZvciBzYWJlcmEncyBkcm9wXG4vLyAgIC8vICAgICAgLSB0aGVuIHdlIGNhbiByZW1vdmUgYWxsIHRoZSBleHRyYSBzZXRzXG4vLyAgIHNldChyb206IFJvbSwgaXRlbTogbnVtYmVyKTogdm9pZCB7XG4vLyAgICAgZm9yIChjb25zdCBpdGVtZ2V0IG9mIHJvbS5pdGVtR2V0cykge1xuLy8gICAgICAgY29uc3QgaW5kZXggPSBpdGVtZ2V0LmZsYWdzLmluZGV4T2YodGhpcy5mbGFnKTtcbi8vICAgICAgIGlmIChpdGVtcy5oYXMoaXRlbWdldC5pZCkgJiYgaW5kZXggPCAwKSBpdGVtZ2V0LmZsYWdzLnB1c2godGhpcy5mbGFnKTtcbi8vICAgICAgIGlmICghaXRlbXMuaGFzKGl0ZW1nZXQuaWQpICYmIGluZGV4ID49IDApIGl0ZW1nZXQuZmxhZ3Muc3BsaWNlKGluZGV4LCAxKTtcbi8vICAgICB9XG4vLyAgIH1cbi8vIH1cblxuXG4vLyBNYXBzIGZyb20gc2xvdCB0byBpdGVtIGFjdHVhbGx5IGluIHRoZSBzbG90LlxuLy8gTWFuYWdlcyBhbGwgdGhlIG5lY2Vzc2FyeSB1cGRhdGVzIGZvciByZWFycmFuZ2luZyBpdGVtcy5cbmNsYXNzIFNsb3RzIHtcblxuICBwcml2YXRlIHNsb3RzOiBSZWFkb25seUFycmF5PFJlYWRvbmx5QXJyYXk8U2xvdD4+O1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tKSB7XG5cbiAgICAvLyBUT0RPIC0gdGhpcyBuZWVkcyB0byBtb3ZlIHRvIEFGVEVSIHdlJ3ZlIGRvbmUgc29tZSBpbml0aWFsIGZpeHVwLi4uIVxuICAgIC8vIE1heWJlIHdlIHJlYWxseSBkbyBuZWVkIHRvIG1ha2UgaXQgc2VwYXJhdGUgZnJvbSB0aGUgcm9tP1xuXG4gICAgY29uc3Qgc2xvdHM6IFNsb3RbXVtdID0gc2VxKDB4ODAsICgpID0+IFtdKTtcbiAgICBmdW5jdGlvbiBhZGRTbG90KHNsb3Q6IFNsb3QpOiB2b2lkIHtcbiAgICAgIHNsb3RzW3Nsb3Quc2xvdF0ucHVzaChzbG90KTtcbiAgICB9XG5cbiAgICAvLyBGaW5kIGNoZXN0c1xuICAgIGZvciAoY29uc3QgbG9jIG9mIHJvbS5sb2NhdGlvbnMpIHtcbiAgICAgIGlmICghbG9jLnVzZWQpIGNvbnRpbnVlO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsb2Muc3Bhd25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHNwYXduID0gbG9jLnNwYXduc1tpXTtcbiAgICAgICAgaWYgKHNwYXduLmlzQ2hlc3QoKSkgYWRkU2xvdChuZXcgQ2hlc3RTbG90KHNwYXduLmlkLCBsb2MuaWQsIGkpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBGaW5kIGl0ZW0gZ2l2ZXJzXG4gICAgZm9yIChjb25zdCBucGMgb2Ygcm9tLm5wY3MpIHtcbiAgICAgIGlmICghbnBjLnVzZWQgfHwgIW5wYy5oYXNEaWFsb2cpIGNvbnRpbnVlO1xuICAgICAgZm9yIChjb25zdCBkcyBvZiBucGMubG9jYWxEaWFsb2dzLnZhbHVlcygpKSB7XG4gICAgICAgIGZvciAoY29uc3QgZCBvZiBkcykge1xuICAgICAgICAgIHN3aXRjaCAoZC5tZXNzYWdlLmFjdGlvbikge1xuICAgICAgICAgIGNhc2UgMHgwMzpcbiAgICAgICAgICBjYXNlIDB4MGE6IC8vIG1vdmVkIHZlcnNpb24gb2Yga2Vuc3UgY2hlc3QgZHJvcFxuICAgICAgICAgICAgYWRkU2xvdChuZXcgUGVyc29uRGF0YVNsb3QobnBjLmRhdGFbMF0sIG5wYy5pZCwgMCkpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAweDExOlxuICAgICAgICAgICAgYWRkU2xvdChuZXcgUGVyc29uRGF0YVNsb3QobnBjLmRhdGFbMV0sIG5wYy5pZCwgMSkpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAweDA5OiAvLyBvbmx5IGFkZCBzbG90IGlmIGl0J3Mgbm90IGV4cGxpY2l0bHkgZGlzYWJsZWRcbiAgICAgICAgICAgIGlmIChucGMuZGF0YVsxXSA8IDB4ODApIHtcbiAgICAgICAgICAgICAgYWRkU2xvdChuZXcgUGVyc29uRGF0YVNsb3QobnBjLmRhdGFbMV0sIG5wYy5pZCwgMSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRmluZCBib3NzIGRyb3BzXG4gICAgZm9yIChjb25zdCBib3NzIG9mIHJvbS5ib3NzZXMpIHtcbiAgICAgIGlmIChib3NzLmtpbGwgPT09IDMgfHwgYm9zcy5raWxsID09PSAxMykgY29udGludWU7IC8vIGZhbHNlIGFsYXJtc1xuICAgICAgaWYgKGJvc3Mua2lsbCAhPSBudWxsICYmIGJvc3MuZHJvcCAhPSBudWxsKSB7XG4gICAgICAgIGFkZFNsb3QobmV3IEJvc3NEcm9wU2xvdChib3NzLmRyb3AsIGJvc3Mua2lsbCkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFJlY29yZCBoYXJkY29kZWQgc2xvdHNcbiAgICBmb3IgKGNvbnN0IFthZGRyLCBuYW1lXSBvZiBoYXJkY29kZWRJdGVtcykge1xuICAgICAgYWRkU2xvdChuZXcgSGFyZGNvZGVkU2xvdCh0aGlzLnJvbS5wcmdbYWRkcl0sIGFkZHIsIG5hbWUpKTtcbiAgICB9XG4gICAgZXh0cmFTbG90cy5mb3JFYWNoKGFkZFNsb3QpO1xuXG4gICAgLy8gY29uc29sZS5sb2coJ3Nsb3RzJywgc2xvdHMpO1xuXG4gICAgdGhpcy5zbG90cyA9IHNsb3RzO1xuICB9XG5cbiAgLy8gTk9URTogdGhpcy5zbG90cyBpcyBub3QgcmlnaHQgLSB0aGVyZSBhcmUgbXVsdGlwbGUgQ2hlc3RTbG90cyBpbiB0aGUgc2FtZVxuICAvLyBsaXN0LCBvciBhIENoZXN0U2xvdCBmb3IgMzQga2V5IHRvIHN0eHksIHdoaWNoIHNob3VsZCBub3QgYmUuLi4/XG4gIHVwZGF0ZShmaWxsOiBudW1iZXJbXSk6IHZvaWQge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsbC5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGZpbGxbaV0gPT0gbnVsbCkgY29udGludWU7XG4gICAgICBmb3IgKGNvbnN0IHNsb3Qgb2YgdGhpcy5zbG90c1tpXSkge1xuICAgICAgICBzbG90LnNldCh0aGlzLnJvbSwgZmlsbFtpXSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTW92ZSBhbGwgdGhlIGZsYWdzLiAgRmlyc3QgcmVhZCB0aGVtLlxuICAgIGNvbnN0IGZsYWdzOiBudW1iZXJbXVtdID0gdGhpcy5yb20uaXRlbUdldHMubWFwKCgpID0+IFtdKTtcbiAgICBmb3IgKGNvbnN0IGl0ZW1nZXQgb2YgdGhpcy5yb20uaXRlbUdldHMpIHtcbiAgICAgIGNvbnN0IHtpZH0gPSBpdGVtZ2V0O1xuICAgICAgZm9yIChjb25zdCBmbGFnIG9mIGl0ZW1nZXQuZmxhZ3MpIHtcbiAgICAgICAgaWYgKGZsYWcgPT09IC0xKSBjb250aW51ZTtcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gcHJlc2VydmVkSXRlbUdldEZsYWdzLmhhcyhmbGFnKSA/IGlkIDogZmlsbFtpZF07XG4gICAgICAgIC8vIE5PVEU6IGl0J3MgcG9zc2libGUgdGhlIHRhcmdldCBzbG90IGlzIGEgbWltaWMgLSBpbiB0aGF0IGNhc2VcbiAgICAgICAgLy8gd2UndmUgYWxyZWFkeSBndWFyYW50ZWVkIHRoYXQgdGhlIGZsYWcganVzdCBhIGNvbnN1bWFibGUgY2hlc3RcbiAgICAgICAgLy8gZmxhZywgc28gaXQncyBzYWZlIHRvIGp1c3QgZHJvcCBpdCBvbiB0aGUgZmxvb3IuXG4gICAgICAgIChmbGFnc1t0YXJnZXRdIHx8IFtdKS5wdXNoKGZsYWcpO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBOb3cgd3JpdGUgdGhlbVxuICAgIGZvciAoY29uc3QgaXRlbWdldCBvZiB0aGlzLnJvbS5pdGVtR2V0cykge1xuICAgICAgaXRlbWdldC5mbGFncyA9IGZsYWdzW2l0ZW1nZXQuaWRdO1xuICAgIH1cbiAgfVxufVxuXG5cbmNvbnN0IGhhcmRjb2RlZEl0ZW1zOiBSZWFkb25seUFycmF5PHJlYWRvbmx5IFtudW1iZXIsIHN0cmluZz9dPiA9IFtcbiAgWzB4MzY3ZjQsICdTdG9tIGZpZ2h0J10sXG4gIFsweDNkMThmLCAnU2xpbWVkIEtlbnN1J10sXG4gIFsweDNkMWY5LCAnQXNpbmEnXSxcbiAgWzB4M2QyYWYsICdTdG9uZWQgQWthaGFuYSddLFxuICAvL1sweDNkMzBlLCAnTGlnaHRob3VzZSBLZW5zdSddLFxuICBbMHgzZDMzNywgJ1JhZ2UnXSxcbiAgWzB4M2Q2NTUsICdNdCBTYWJyZSBzdW1taXQgdHJpZ2dlciddLCAvLyBwYXJhbHlzaXNcbiAgWzB4M2Q2ZDksICdXaGlybHBvb2wgdHJpZ2dlciddLFxuICBbMHgzZDZkZSwgJ1N3YW4gS2Vuc3UnXSxcbiAgWzB4M2Q2ZTgsICdBcnlsbGlzJ10sXG4gIFsweDNkNzExXSwgLy8gcmVmcmVzaCBmcm9tIHRyaWdnZXJcbiAgWzB4M2Q3ZmUsICdBa2FoYW5hIHN0YXR1ZSB0cmFkZS1pbiddLFxuICAvL1sweDNlM2EyXSwgLy8gaW52aXNpYmxlIGZsYWcgZm9yIHN0YXR1ZSBvZiBvbnl4XG4gIC8vWzB4M2UzYTZdLCAvLyBpbnZpc2libGUgZmxhZyBmb3Iga2lyaXNhIHBsYW50XG4gIC8vWzB4M2UzYWFdLCAvLyBpbnZpc2libGUgZmxhZyBmb3IgbG92ZSBwZW5kYW50XG5dO1xuXG5jb25zdCBleHRyYVNsb3RzID0gW1xuICBuZXcgUGVyc29uRGF0YVNsb3QoMHgzNiwgMHg2MywgMSksIC8vIHNoZWxsIGZsdXRlIChkb2xwaGluKVxuXTtcblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZShyb206IFJvbSwgZmlsbDogbnVtYmVyW10pOiB2b2lkIHtcbiAgbmV3IFNsb3RzKHJvbSkudXBkYXRlKGZpbGwpO1xufVxuXG5cbi8qKlxuICogQnkgZGVmYXVsdCB3aGVuIHdlIGZpbGwgYSBzbG90LCB3ZSBicmluZyB0aGUgaXRlbWdldCBmbGFncyBhbG9uZyB3aXRoLlxuICogVGhpcyBlbnN1cmVzIHRoYXQgZGlhbG9ncyB0aGF0IHRyaWdnZXIgb2ZmIG9mIGl0IGFyZW4ndCBicm9rZW4uXG4gKiBUaGUgZm9sbG93aW5nIGFyZSBub3QgbW92ZWQsIHRob3VnaCB3ZSBzaG91bGQgZml4IHRoYXQgYnkgY2hhbmdpbmcgdGhlbVxuICogaW50byB0aGUgbm9ybWFsIDJ4eCBpdGVtIGZsYWdzLlxuICovXG5jb25zdCBwcmVzZXJ2ZWRJdGVtR2V0RmxhZ3MgPSBuZXcgU2V0KFtcbiAgLy8gMHgwMGUsIC8vIHRlbGVwYXRoeSAtIHVzZWQgZm9yIHRhbGtpbmcgdG8gYW5pbWFscy9kd2FyZnNcbiAgMHgwMjQsIC8vIGdlbmVyYWxzIGRlZmVhdGVkIC0gd2lsbCBkZWFsIHdpdGggdGhpcyBsYXRlclxuICAvLyAweDAzZiwgLy8gdGVsZXBvcnQgLSB1c2VkIGZvciB0cmlnZ2VyXG4gIC8vIDB4MDVmLCAvLyBzd29yZCBvZiB0aHVuZGVyIC0gdXNlZCB0byB0cmlnZ2VyIG1hc3NhY3JlXG4gIDB4MDhiLCAvLyBzaGVsbCBmbHV0ZSAtIGNoZWNrZWQgYnkgZmlzaGVybWFuIC0tIFRPRE8gY2hhbmdlIHRvIDIzNj9cbiAgLy8gMHgwNjcsIC8vIGRlZmVhdGVkIG1hZG8gMSAoYmFsbCBvZiB0aHVuZGVyKSAtIHdhbnQgc2xvdCwgbm90IGl0ZW1cbiAgLy8gQW55IHdhcnAgcG9pbnQgZmxhZ3MgbmVlZCB0byBnZXQgcHJlc2VydmVkIChzd29yZCBvZiB0aHVuZGVyIHdhcnApXG4gIDB4MmY0LFxuICAweDJmNSxcbiAgMHgyZjYsXG4gIDB4MmY3LFxuICAweDJmOCxcbiAgMHgyZjksXG4gIDB4MmZhLFxuICAweDJmYixcbiAgMHgyZmMsXG4gIDB4MmZkLCAvLyBzaHlyb24gd2FycCBwb2ludCBmcm9tIHN3b3JkIG9mIHRodW5kZXJcbiAgMHgyZmUsXG4gIDB4MmZmLFxuXSk7XG4iXX0=