import { Entity } from './entity.js';
import { MessageId } from './messageid.js';
import { addr, hex, readBigEndian } from './util.js';
const UNUSED_TRIGGERS = new Set([
    0x87, 0x88, 0x89, 0x8f, 0x93, 0x96, 0x98, 0x9b, 0x9c, 0x9d, 0x9e, 0x9f,
    0xa0, 0xb3, 0xb5, 0xb9, 0xbe, 0xc0,
]);
export class Trigger extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.used = !UNUSED_TRIGGERS.has(id);
        this.pointer = 0x1e17a + ((id & 0x7f) << 1);
        this.base = addr(rom.prg, this.pointer, 0x14000);
        this.conditions = [];
        this.message = new MessageId();
        this.flags = [];
        let word;
        let i = this.base;
        do {
            word = readBigEndian(rom.prg, i);
            const flag = word & 0x0fff;
            this.conditions.push(word & 0x2000 ? ~flag : flag);
            i += 2;
        } while (!(word & 0x8000));
        this.message = MessageId.from(rom.prg, i);
        do {
            i += 2;
            word = readBigEndian(rom.prg, i);
            const flag = word & 0x0fff;
            this.flags.push(word & 0x8000 ? ~flag : flag);
        } while (!(word & 0x4000));
    }
    bytes() {
        const bytes = [];
        if (!this.conditions.length)
            this.conditions.push(~0);
        for (let i = 0; i < this.conditions.length; i++) {
            let word = this.conditions[i];
            if (word < 0)
                word = ~word | 0x2000;
            if (i === this.conditions.length - 1)
                word = word | 0x8000;
            bytes.push(word >>> 8, word & 0xff);
        }
        bytes.push(...this.message.data);
        if (!this.flags.length)
            this.flags.push(~0);
        for (let i = 0; i < this.flags.length; i++) {
            let word = this.flags[i];
            if (word < 0)
                word = ~word | 0x8000;
            if (i === this.flags.length - 1)
                word = word | 0x4000;
            bytes.push(word >>> 8, word & 0xff);
        }
        return bytes;
    }
    async write(writer, base = 0x1e17a) {
        if (!this.used)
            return;
        const address = await writer.write(this.bytes(), 0x1e000, 0x1ffff, `Trigger ${hex(this.id)}`);
        writer.rom[base + 2 * (this.id & 0x7f)] = address & 0xff;
        writer.rom[base + 2 * (this.id & 0x7f) + 1] = (address >>> 8) - 0x40;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJpZ2dlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vdHJpZ2dlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6QyxPQUFPLEVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxhQUFhLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFJbkQsTUFBTSxlQUFlLEdBQUcsSUFBSSxHQUFHLENBQUM7SUFDOUIsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJO0lBQ3RFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSTtDQUVuQyxDQUFDLENBQUM7QUFFSCxNQUFNLE9BQU8sT0FBUSxTQUFRLE1BQU07SUFhakMsWUFBWSxHQUFRLEVBQUUsRUFBVTtRQUc5QixLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2YsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJ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S0FBSyxDQUFDLEVBQUUsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO1NBQ3RDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFjLEVBQUUsT0FBZSxPQUFPO1FBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSTtZQUFFLE9BQU87UUFDdkIsTUFBTSxPQUFPLEdBQUcsTUFBTSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUM5QixXQUFXLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlELE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3pELE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ3ZFLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RW50aXR5fSBmcm9tICcuL2VudGl0eS5qcyc7XG5pbXBvcnQge01lc3NhZ2VJZH0gZnJvbSAnLi9tZXNzYWdlaWQuanMnO1xuaW1wb3J0IHthZGRyLCBoZXgsIHJlYWRCaWdFbmRpYW59IGZyb20gJy4vdXRpbC5qcyc7XG5pbXBvcnQge1dyaXRlcn0gZnJvbSAnLi93cml0ZXIuanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5cbmNvbnN0IFVOVVNFRF9UUklHR0VSUyA9IG5ldyBTZXQoW1xuICAweDg3LCAweDg4LCAweDg5LCAweDhmLCAweDkzLCAweDk2LCAweDk4LCAweDliLCAweDljLCAweDlkLCAweDllLCAweDlmLFxuICAweGEwLCAweGIzLCAweGI1LCAweGI5LCAweGJlLCAweGMwLCAvLyBjMiBpcyBsYXN0IG9uZVxuICAvLyBOT1RFOiBiMyBpcyBvbmx5IHVudXNlZCBhZnRlciBkZXRlcm1pbmlzdGljIHByZS1wYXJzZSBkZWxldGVzIGl0LlxuXSk7XG5cbmV4cG9ydCBjbGFzcyBUcmlnZ2VyIGV4dGVuZHMgRW50aXR5IHtcblxuICB1c2VkOiBib29sZWFuO1xuICBwb2ludGVyOiBudW1iZXI7XG4gIGJhc2U6IG51bWJlcjtcblxuICAvLyBMaXN0IG9mIGZsYWdzIHRvIGNoZWNrOiBwb3NpdGl2ZSBtZWFucyBcIm11c3QgYmUgc2V0XCJcbiAgY29uZGl0aW9uczogbnVtYmVyW107XG4gIC8vIE1lc3NhZ2Ugc2hvd24sIGFjdGlvbiBydW5cbiAgbWVzc2FnZTogTWVzc2FnZUlkO1xuICAvLyBMaXN0IG9mIGZsYWdzIHRvIHNldC9jbGVhcjogcG9zaXRpdmUgbWVhbnMgdG8gc2V0IGl0LlxuICBmbGFnczogbnVtYmVyW107XG5cbiAgY29uc3RydWN0b3Iocm9tOiBSb20sIGlkOiBudW1iZXIpIHtcbiAgICAvLyBUT0RPIC0gY29uc2lkZXIgcHVsbGluZyB0aGlzIG91dCBpbnRvIHN0YXRpYyBmcm9tQnl0ZXMoKSBtZXRob2Q/XG4gICAgLy8gICAgICAgIC0gc3RpbGwgbmVlZC93YW50IHRoZSBSb20gcmVmZXJlbmNlIGluIHRoYXQgY2FzZT8gIG5vIGlkP1xuICAgIHN1cGVyKHJvbSwgaWQpO1xuICAgIHRoaXMudXNlZCA9ICFVTlVTRURfVFJJR0dFUlMuaGFzKGlkKTsgLy8gbmVlZCB0byBzZXQgbWFudWFsbHlcbiAgICB0aGlzLnBvaW50ZXIgPSAweDFlMTdhICsgKChpZCAmIDB4N2YpIDw8IDEpO1xuICAgIHRoaXMuYmFzZSA9IGFkZHIocm9tLnByZywgdGhpcy5wb2ludGVyLCAweDE0MDAwKTtcbiAgICB0aGlzLmNvbmRpdGlvbnMgPSBbXTtcbiAgICB0aGlzLm1lc3NhZ2UgPSBuZXcgTWVzc2FnZUlkKCk7XG4gICAgdGhpcy5mbGFncyA9IFtdO1xuICAgIGxldCB3b3JkO1xuICAgIGxldCBpID0gdGhpcy5iYXNlO1xuICAgIGRvIHtcbiAgICAgIC8vIE5PVEU6IHRoaXMgYnl0ZSBvcmRlciBpcyBpbnZlcnNlIGZyb20gbm9ybWFsLlxuICAgICAgd29yZCA9IHJlYWRCaWdFbmRpYW4ocm9tLnByZywgaSk7XG4gICAgICBjb25zdCBmbGFnID0gd29yZCAmIDB4MGZmZjtcbiAgICAgIHRoaXMuY29uZGl0aW9ucy5wdXNoKHdvcmQgJiAweDIwMDAgPyB+ZmxhZyA6IGZsYWcpO1xuICAgICAgaSArPSAyO1xuICAgIH0gd2hpbGUgKCEod29yZCAmIDB4ODAwMCkpO1xuICAgIHRoaXMubWVzc2FnZSA9IE1lc3NhZ2VJZC5mcm9tKHJvbS5wcmcsIGkpO1xuICAgIGRvIHtcbiAgICAgIGkgKz0gMjtcbiAgICAgIHdvcmQgPSByZWFkQmlnRW5kaWFuKHJvbS5wcmcsIGkpO1xuICAgICAgY29uc3QgZmxhZyA9IHdvcmQgJiAweDBmZmY7XG4gICAgICB0aGlzLmZsYWdzLnB1c2god29yZCAmIDB4ODAwMCA/IH5mbGFnIDogZmxhZyk7XG4gICAgfSB3aGlsZSAoISh3b3JkICYgMHg0MDAwKSk7XG4gICAgLy8gY29uc29sZS5sb2coYFRyaWdnZXIgJCR7dGhpcy5pZC50b1N0cmluZygxNil9OiBieXRlczogJCR7XG4gICAgLy8gICAgICAgICAgICAgIHRoaXMuYnl0ZXMoKS5tYXAoeD0+eC50b1N0cmluZygxNikucGFkU3RhcnQoMiwwKSkuam9pbignICcpfWApO1xuICB9XG5cbiAgYnl0ZXMoKTogbnVtYmVyW10ge1xuICAgIGNvbnN0IGJ5dGVzID0gW107XG4gICAgaWYgKCF0aGlzLmNvbmRpdGlvbnMubGVuZ3RoKSB0aGlzLmNvbmRpdGlvbnMucHVzaCh+MCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvbmRpdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCB3b3JkID0gdGhpcy5jb25kaXRpb25zW2ldO1xuICAgICAgaWYgKHdvcmQgPCAwKSB3b3JkID0gfndvcmQgfCAweDIwMDA7XG4gICAgICBpZiAoaSA9PT0gdGhpcy5jb25kaXRpb25zLmxlbmd0aCAtIDEpIHdvcmQgPSB3b3JkIHwgMHg4MDAwO1xuICAgICAgYnl0ZXMucHVzaCh3b3JkID4+PiA4LCB3b3JkICYgMHhmZik7XG4gICAgfVxuICAgIGJ5dGVzLnB1c2goLi4udGhpcy5tZXNzYWdlLmRhdGEpO1xuICAgIGlmICghdGhpcy5mbGFncy5sZW5ndGgpIHRoaXMuZmxhZ3MucHVzaCh+MCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmZsYWdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgd29yZCA9IHRoaXMuZmxhZ3NbaV07XG4gICAgICBpZiAod29yZCA8IDApIHdvcmQgPSB+d29yZCB8IDB4ODAwMDtcbiAgICAgIGlmIChpID09PSB0aGlzLmZsYWdzLmxlbmd0aCAtIDEpIHdvcmQgPSB3b3JkIHwgMHg0MDAwO1xuICAgICAgYnl0ZXMucHVzaCggd29yZCA+Pj4gOCwgd29yZCAmIDB4ZmYpO1xuICAgIH1cbiAgICByZXR1cm4gYnl0ZXM7XG4gIH1cblxuICBhc3luYyB3cml0ZSh3cml0ZXI6IFdyaXRlciwgYmFzZTogbnVtYmVyID0gMHgxZTE3YSkge1xuICAgIGlmICghdGhpcy51c2VkKSByZXR1cm47XG4gICAgY29uc3QgYWRkcmVzcyA9IGF3YWl0IHdyaXRlci53cml0ZSh0aGlzLmJ5dGVzKCksIDB4MWUwMDAsIDB4MWZmZmYsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgVHJpZ2dlciAke2hleCh0aGlzLmlkKX1gKTtcbiAgICB3cml0ZXIucm9tW2Jhc2UgKyAyICogKHRoaXMuaWQgJiAweDdmKV0gPSBhZGRyZXNzICYgMHhmZjtcbiAgICB3cml0ZXIucm9tW2Jhc2UgKyAyICogKHRoaXMuaWQgJiAweDdmKSArIDFdID0gKGFkZHJlc3MgPj4+IDgpIC0gMHg0MDtcbiAgfVxufVxuIl19