import { Entity, EntityArray } from './entity.js';
import { MessageId } from './messageid.js';
import { ITEM_GET_FLAGS, Address, Segment, hex, readLittleEndian } from './util.js';
const { $0e, $0f, $fe } = Segment;
const ITEMGET_TABLE = Address.of($0e, 0x9b00);
const GRANT_ITEM_TABLE = Address.of($fe, 0xd6d5);
const GET_TO_ITEM_BASE = Address.of($0e, 0x9d66);
const GET_TO_ITEM_THRESHOLD = 0x49;
export class ItemGets extends EntityArray {
    constructor(rom) {
        super(0x71);
        this.rom = rom;
        this.actionGrants = new Map();
        for (let i = 0; i < 0x71; i++) {
            this[i] = new ItemGet(rom, i);
        }
        let addr = GRANT_ITEM_TABLE.offset;
        while (rom.prg[addr] !== 0xff) {
            const key = rom.prg[addr++];
            const value = rom.prg[addr++];
            this.actionGrants.set(key, value);
        }
    }
    write() {
        const a = this.rom.assembler();
        for (const itemget of this) {
            itemget.assemble(a);
        }
        GRANT_ITEM_TABLE.loc(a);
        for (const [key, value] of this.actionGrants) {
            a.byte(key, value);
        }
        return [a.module()];
    }
}
export class ItemGet extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this._itemId = this.itemPointer.read(rom.prg);
        const tableBase = this.tablePointer.readAddress(rom.prg, $0e, $0f);
        let a = tableBase.offset;
        this.inventoryRowStart = rom.prg[a++];
        this.inventoryRowLength = rom.prg[a++];
        this.acquisitionAction = MessageId.from(rom.prg, a);
        this.flags = ITEM_GET_FLAGS.read(rom.prg, a + 2);
        this.key = rom.prg[a + 2 + 2 * this.flags.length + 1] === 0xfe;
        if (id !== 0 && tableBase.org === readLittleEndian(rom.prg, 0x1dd66)) {
            this.key = false;
            this.flags = [];
        }
    }
    get itemPointer() {
        return GET_TO_ITEM_BASE.plus(this.id);
    }
    get tablePointer() {
        return ITEMGET_TABLE.plus(this.id << 1);
    }
    get itemId() { return this._itemId; }
    set itemId(itemId) {
        if (this.id < GET_TO_ITEM_THRESHOLD)
            throw new Error(`${this.id}`);
        this._itemId = itemId;
    }
    isLosable() {
        return LOSABLE_ROWS.has(this.inventoryRowStart);
    }
    copyFrom(that) {
        this.inventoryRowStart = that.inventoryRowStart;
        this.inventoryRowLength = that.inventoryRowLength;
        this.acquisitionAction = that.acquisitionAction;
        this.flags = [...that.flags];
        this.key = that.key;
    }
    assemble(a) {
        this.itemPointer.loc(a);
        a.byte(this.itemId);
        const table = [
            this.inventoryRowStart, this.inventoryRowLength,
            ...this.acquisitionAction.data,
            ...ITEM_GET_FLAGS.bytes(this.flags),
            this.key ? 0xfe : 0xff,
        ];
        a.segment($0e.name, $0f.name);
        a.reloc(`ItemGetData ${hex(this.id)}`);
        const tableAddr = a.pc();
        a.byte(...table);
        this.tablePointer.loc(a);
        a.word(tableAddr);
    }
}
const LOSABLE_ROWS = new Set([4, 8, 16]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbWdldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vaXRlbWdldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFdBQVcsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDekMsT0FBTyxFQUFDLGNBQWMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUNoQyxHQUFHLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFFaEQsTUFBTSxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLEdBQUcsT0FBTyxDQUFDO0FBR2hDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQzlDLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDakQsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNqRCxNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQztBQU9uQyxNQUFNLE9BQU8sUUFBUyxTQUFRLFdBQW9CO0lBSWhELFlBQXFCLEdBQVE7UUFDM0IsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRE8sUUFBRyxHQUFILEdBQUcsQ0FBSztRQUY3QixpQkFBWSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBSXZDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDN0IsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUMvQjtRQUVELElBQUksSUFBSSxHQUFH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dkIsQ0FBQztRQUNGLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxlQUFlLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUN6QixDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNwQixDQUFDO0NBQ0Y7QUFFRCxNQUFNLFlBQVksR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QXNzZW1ibGVyfSBmcm9tICcuLi9hc20vYXNzZW1ibGVyLmpzJztcbmltcG9ydCB7TW9kdWxlfSBmcm9tICcuLi9hc20vbW9kdWxlLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtFbnRpdHksIEVudGl0eUFycmF5fSBmcm9tICcuL2VudGl0eS5qcyc7XG5pbXBvcnQge01lc3NhZ2VJZH0gZnJvbSAnLi9tZXNzYWdlaWQuanMnO1xuaW1wb3J0IHtJVEVNX0dFVF9GTEFHUywgQWRkcmVzcywgU2VnbWVudCxcbiAgICAgICAgaGV4LCByZWFkTGl0dGxlRW5kaWFufSBmcm9tICcuL3V0aWwuanMnO1xuXG5jb25zdCB7JDBlLCAkMGYsICRmZX0gPSBTZWdtZW50O1xuXG4vLyBUT0RPIC0gdGhpcyBkZXBlbmRzIG9uIGEgcHJlcGFyc2UgY2hhbmdlLCB3ZSBzaG91bGQgcmVjb25zaWRlciB0aGF0LlxuY29uc3QgSVRFTUdFVF9UQUJMRSA9IEFkZHJlc3Mub2YoJDBlLCAweDliMDApO1xuY29uc3QgR1JBTlRfSVRFTV9UQUJMRSA9IEFkZHJlc3Mub2YoJGZlLCAweGQ2ZDUpO1xuY29uc3QgR0VUX1RPX0lURU1fQkFTRSA9IEFkZHJlc3Mub2YoJDBlLCAweDlkNjYpO1xuY29uc3QgR0VUX1RPX0lURU1fVEhSRVNIT0xEID0gMHg0OTtcblxuLyoqXG4gKiBBcnJheSBvZiBJdGVtR2V0RGF0YSB0YWJsZSBlbnRyaWVzLCB0b2dldGhlciB3aXRoIHRoZSBtYXAgb2ZcbiAqIHRyaWdnZXIvaXRlbXVzZSBncmFudHMgKGFkZGVkIGZvciBzdGF0dWUgb2YgZ29sZCBzaHVmZmxlKSxcbiAqIGZvciBwcm9ncmFtbWF0aWMgYWNjZXNzLlxuICovXG5leHBvcnQgY2xhc3MgSXRlbUdldHMgZXh0ZW5kcyBFbnRpdHlBcnJheTxJdGVtR2V0PiB7XG5cbiAgYWN0aW9uR3JhbnRzID0gbmV3IE1hcDxudW1iZXIsIG51bWJlcj4oKTtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSkge1xuICAgIHN1cGVyKDB4NzEpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMHg3MTsgaSsrKSB7XG4gICAgICB0aGlzW2ldID0gbmV3IEl0ZW1HZXQocm9tLCBpKTtcbiAgICB9XG5cbiAgICBsZXQgYWRkciA9IEdSQU5UX0lURU1fVEFCTEUub2Zmc2V0O1xuICAgIHdoaWxlIChyb20ucHJnW2FkZHJdICE9PSAweGZmKSB7XG4gICAgICBjb25zdCBrZXkgPSByb20ucHJnW2FkZHIrK107XG4gICAgICBjb25zdCB2YWx1ZSA9IHJvbS5wcmdbYWRkcisrXTtcbiAgICAgIHRoaXMuYWN0aW9uR3JhbnRzLnNldChrZXksIHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICB3cml0ZSgpOiBNb2R1bGVbXSB7XG4gICAgY29uc3QgYSA9IHRoaXMucm9tLmFzc2VtYmxlcigpO1xuICAgIGZvciAoY29uc3QgaXRlbWdldCBvZiB0aGlzKSB7XG4gICAgICBpdGVtZ2V0LmFzc2VtYmxlKGEpO1xuICAgIH1cbiAgICBHUkFOVF9JVEVNX1RBQkxFLmxvYyhhKTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB0aGlzLmFjdGlvbkdyYW50cykge1xuICAgICAgYS5ieXRlKGtleSwgdmFsdWUpO1xuICAgIH1cbiAgICByZXR1cm4gW2EubW9kdWxlKCldO1xuICB9XG5cbn1cblxuLy8gQSBnZXR0YWJsZSBpdGVtIHNsb3QvY2hlY2suICBFYWNoIEl0ZW1HZXQgbWFwcyB0byBhIHNpbmdsZSBpdGVtLFxuLy8gYnV0IG5vbi11bmlxdWUgaXRlbXMgbWF5IG1hcCB0byBtdWx0aXBsZSBJdGVtR2V0cy5cbmV4cG9ydCBjbGFzcyBJdGVtR2V0IGV4dGVuZHMgRW50aXR5IHtcblxuICBwcml2YXRlIF9pdGVtSWQ6IG51bWJlcjtcblxuICAvLyBXaGF0IHBhcnQgb2YgaW52ZW50b3J5IHRvIHNlYXJjaCB3aGVuIGFjcXVpcmluZy5cbiAgaW52ZW50b3J5Um93U3RhcnQ6IG51bWJlcjtcbiAgaW52ZW50b3J5Um93TGVuZ3RoOiBudW1iZXI7XG4gIC8vIE9ubHkgdXNlZCBmb3IgdGhlICdhY3Rpb24nLlxuICBhY3F1aXNpdGlvbkFjdGlvbjogTWVzc2FnZUlkO1xuICAvLyBGbGFncyB0byBzZXQvY2xlYXIgb24gZ2V0dGluZyB0aGUgaXRlbS4gIH5mbGFnIGluZGljYXRlcyB0byBjbGVhci5cbiAgLy8gTm90ZTogd2UgY2FuIGVsaW1pbmF0ZSBtb3N0IG9mIHRoZXNlIHNpbmNlIHdlIGhhbmRsZSB0aGUgMnh4IGZsYWdcbiAgLy8gYXV0b21hdGljYWxseSBhbmQgdXNlIGl0IGZvciBjaGVzdCBzcGF3bmluZy5cbiAgZmxhZ3M6IG51bWJlcltdO1xuXG4gIC8vIFdoZXRoZXIgdGhlIGl0ZW0gaXMgXCJrZXlcIiBvciBub3QgZm9yIHNjYWxpbmcgcHVycG9zZXMuXG4gIC8vIFRPRE8gLSBmaW5kIGEgYmV0dGVyIHNvdXJjZSBmb3IgdGhpcyBzbyB3ZSBjYW4gcmVtb3ZlIGl0IGZyb20gdGhpcyB0YWJsZS5cbiAgLy8gICAgICAgIFdlIGNvdWxkIHBvc3NpYmx5IHN0b3JlIGl0IGluIGEgMTQtYnl0ZSBiaXRmaWVsZC4uLlxuICBrZXk6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3Iocm9tOiBSb20sIGlkOiBudW1iZXIpIHtcbiAgICBzdXBlcihyb20sIGlkKTtcblxuICAgIHRoaXMuX2l0ZW1JZCA9IHRoaXMuaXRlbVBvaW50ZXIucmVhZChyb20ucHJnKTtcbiAgICAvLyBJIGRvbid0IGZ1bGx5IHVuZGVyc3RhbmQgdGhpcyB0YWJsZS4uLlxuICAgIGNvbnN0IHRhYmxlQmFzZSA9IHRoaXMudGFibGVQb2ludGVyLnJlYWRBZGRyZXNzKHJvbS5wcmcsICQwZSwgJDBmKTtcbiAgICBsZXQgYSA9IHRhYmxlQmFzZS5vZmZzZXQ7XG5cbiAgICB0aGlzLmludmVudG9yeVJvd1N0YXJ0ID0gcm9tLnByZ1thKytdO1xuICAgIHRoaXMuaW52ZW50b3J5Um93TGVuZ3RoID0gcm9tLnByZ1thKytdO1xuICAgIHRoaXMuYWNxdWlzaXRpb25BY3Rpb24gPSBNZXNzYWdlSWQuZnJvbShyb20ucHJnLCBhKTtcbiAgICB0aGlzLmZsYWdzID0gSVRFTV9HRVRfRkxBR1MucmVhZChyb20ucHJnLCBhICsgMik7XG5cbiAgICAvLyBUT0RPOiByZW1vdmUgdGhpcyBjaGVja1xuICAgIHRoaXMua2V5ID0gcm9tLnByZ1thICsgMiArIDIgKiB0aGlzLmZsYWdzLmxlbmd0aCArIDFdID09PSAweGZlO1xuXG4gICAgaWYgKGlkICE9PSAwICYmIHRhYmxlQmFzZS5vcmcgPT09IHJlYWRMaXR0bGVFbmRpYW4ocm9tLnByZywgMHgxZGQ2NikpIHtcbiAgICAgIC8vIFRoaXMgaXMgb25lIG9mIHRoZSB1bnVzZWQgaXRlbXMgdGhhdCBwb2ludCB0byBzd29yZCBvZiB3aW5kLlxuICAgICAgdGhpcy5rZXkgPSBmYWxzZTtcbiAgICAgIHRoaXMuZmxhZ3MgPSBbXTtcbiAgICB9XG4gIH1cblxuICBnZXQgaXRlbVBvaW50ZXIoKTogQWRkcmVzcyB7XG4gICAgcmV0dXJuIEdFVF9UT19JVEVNX0JBU0UucGx1cyh0aGlzLmlkKTtcbiAgfVxuXG4gIGdldCB0YWJsZVBvaW50ZXIoKTogQWRkcmVzcyB7XG4gICAgcmV0dXJuIElURU1HRVRfVEFCTEUucGx1cyh0aGlzLmlkIDw8IDEpXG4gIH1cblxuICBnZXQgaXRlbUlkKCkgeyByZXR1cm4gdGhpcy5faXRlbUlkOyB9XG4gIHNldCBpdGVtSWQoaXRlbUlkOiBudW1iZXIpIHtcbiAgICBpZiAodGhpcy5pZCA8IEdFVF9UT19JVEVNX1RIUkVTSE9MRCkgdGhyb3cgbmV3IEVycm9yKGAke3RoaXMuaWR9YCk7XG4gICAgdGhpcy5faXRlbUlkID0gaXRlbUlkO1xuICB9XG5cbiAgaXNMb3NhYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBMT1NBQkxFX1JPV1MuaGFzKHRoaXMuaW52ZW50b3J5Um93U3RhcnQpO1xuICB9XG5cbiAgY29weUZyb20odGhhdDogSXRlbUdldCkge1xuICAgIHRoaXMuaW52ZW50b3J5Um93U3RhcnQgPSB0aGF0LmludmVudG9yeVJvd1N0YXJ0O1xuICAgIHRoaXMuaW52ZW50b3J5Um93TGVuZ3RoID0gdGhhdC5pbnZlbnRvcnlSb3dMZW5ndGg7XG4gICAgdGhpcy5hY3F1aXNpdGlvbkFjdGlvbiA9IHRoYXQuYWNxdWlzaXRpb25BY3Rpb247XG4gICAgdGhpcy5mbGFncyA9IFsuLi50aGF0LmZsYWdzXTtcbiAgICB0aGlzLmtleSA9IHRoYXQua2V5O1xuICB9XG5cbiAgYXNzZW1ibGUoYTogQXNzZW1ibGVyKSB7XG4gICAgLy8gRmlyc3Qgd3JpdGUgKGl0ZW1nZXQgLT4gaXRlbSkgbWFwcGluZ1xuICAgIHRoaXMuaXRlbVBvaW50ZXIubG9jKGEpO1xuICAgIGEuYnl0ZSh0aGlzLml0ZW1JZCk7XG5cbiAgICBjb25zdCB0YWJsZSA9IFtcbiAgICAgIHRoaXMuaW52ZW50b3J5Um93U3RhcnQsIHRoaXMuaW52ZW50b3J5Um93TGVuZ3RoLFxuICAgICAgLi4udGhpcy5hY3F1aXNpdGlvbkFjdGlvbi5kYXRhLFxuICAgICAgLi4uSVRFTV9HRVRfRkxBR1MuYnl0ZXModGhpcy5mbGFncyksXG4gICAgICB0aGlzLmtleSA/IDB4ZmUgOiAweGZmLCAgLy8gVE9ETzogcmVtb3ZlIHRoaXMgYnl0ZSB3aGVuIG5vIGxvbmdlciBuZWVkZWRcbiAgICBdO1xuICAgIGEuc2VnbWVudCgkMGUubmFtZSwgJDBmLm5hbWUpO1xuICAgIGEucmVsb2MoYEl0ZW1HZXREYXRhICR7aGV4KHRoaXMuaWQpfWApO1xuICAgIGNvbnN0IHRhYmxlQWRkciA9IGEucGMoKTtcbiAgICBhLmJ5dGUoLi4udGFibGUpO1xuICAgIHRoaXMudGFibGVQb2ludGVyLmxvYyhhKTtcbiAgICBhLndvcmQodGFibGVBZGRyKTtcbiAgfVxufVxuXG5jb25zdCBMT1NBQkxFX1JPV1MgPSBuZXcgU2V0KFs0LCA4LCAxNl0pO1xuIl19