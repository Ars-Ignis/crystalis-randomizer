import { DefaultMap } from '../util.js';
import { ACTION_SCRIPTS, Monster } from './monster.js';
import { Constraint } from './constraint.js';
export class Graphics {
    constructor(rom) {
        this.rom = rom;
        this.monsterConstraints = new Map();
        this.npcConstraints = new Map();
        this.allSpritePalettes = new Set();
        const allSpawns = new DefaultMap(() => []);
        for (const l of rom.locations) {
            if (!l.used)
                continue;
            for (let i = 0; i < l.spawns.length; i++) {
                const s = l.spawns[i];
                if (!s.used)
                    continue;
                if (s.isMonster()) {
                    allSpawns.get(s.monsterId).push([l, i, s]);
                }
                else if (s.isNpc()) {
                    allSpawns.get(~s.id).push([l, i, s]);
                }
            }
        }
        for (const [m, spawns] of allSpawns) {
            if (m < 0) {
                const metasprite = rom.metasprites[rom.npcs[~m].data[3]];
                if (!metasprite)
                    throw new Error(`bad NPC: ${~m}`);
                let constraint = this.computeConstraint([rom.npcs[~m].data[3]], spawns, true);
                if (~m === 0x5f)
                    constraint = constraint.ignorePalette();
                this.npcConstraints.set(~m, constraint);
            }
            else {
                let constraint = Constraint.ALL;
                const parent = this.rom.objects[m];
                if (!(parent instanceof Monster)) {
                    throw new Error(`expected monster: ${parent} from ${spawns}`);
                }
                for (const obj of allObjects(rom, parent)) {
                    const action = ACTION_SCRIPTS.get(obj.action);
                    const metaspriteFn = action && action.metasprites || (() => [obj.metasprite]);
                    const child = this.computeConstraint(metaspriteFn(obj), spawns, obj.id === m);
                    const meet = constraint.meet(child);
                    if (!meet)
                        throw new Error(`Bad meet for ${m} with ${obj.id}`);
                    if (meet)
                        constraint = meet;
                }
                this.monsterConstraints.set(parent.id, constraint);
                parent.constraint = constraint;
            }
        }
    }
    getMonsterConstraint(locationId, monsterId) {
        const c = this.monsterConstraints.get(monsterId) || Constraint.NONE;
        if ((locationId & 0x58) === 0x58)
            return c;
        const m = this.rom.objects[monsterId].goldDrop;
        if (!m)
            return c;
        return c.meet(Constraint.COIN) || Constraint.NONE;
    }
    shufflePalettes(random) {
        const pal = [...this.allSpritePalettes];
        for (const [k, c] of this.monsterConstraints) {
            this.monsterConstraints.set(k, c.shufflePalette(random, pal));
        }
        for (const [k, c] of this.npcConstraints) {
            this.npcConstraints.set(k, c.shufflePalette(random, pal));
        }
    }
    configure(location, spawn) {
        if (!spawn.used)
            return;
        const c = spawn.isMonster() ? this.monsterConstraints.get(spawn.monsterId) :
            spawn.isNpc() ? this.npcConstraints.get(spawn.id) :
                spawn.isChest() ? (spawn.id < 0x70 ? Constraint.TREASURE_CHEST :
                    Constraint.MIMIC) :
                    undefined;
        if (!c)
            return;
        if (c.shift === 3 || c.float.length >= 2) {
            throw new Error(`don't know what to do with two floats`);
        }
        else if (!c.float.length) {
            spawn.patternBank = Number(c.shift === 2);
        }
        else if (c.float[0].has(location.spritePatterns[0])) {
            spawn.patternBank = 0;
        }
        else if (c.float[0].has(location.spritePatterns[1])) {
            spawn.patternBank = 1;
        }
        else if (spawn.isMonster()) {
            throw new Error(`no matching pattern bank`);
        }
    }
    computeConstraint(metaspriteIds, spawns, shiftable) {
        const patterns = new Set();
        const palettes = new Set();
        for (const metasprite of metaspriteIds.map(s => this.rom.metasprites[s])) {
            for (const p of metasprite.palettes()) {
                palettes.add(p);
            }
            for (const p of metasprite.patternBanks()) {
                patterns.add(p);
            }
        }
        shiftable = shiftable && patterns.size == 1 && [...patterns][0] === 2;
        const locs = new Map();
        for (const [l, , spawn] of spawns) {
            locs.set(spawn.patternBank && shiftable ? ~l.id : l.id, spawn);
        }
        let child = undefined;
        for (let [l, spawn] of locs) {
            const loc = this.rom.locations[l < 0 ? ~l : l];
            for (const pal of palettes) {
                if (pal > 1)
                    this.allSpritePalettes.add(loc.spritePalettes[pal - 2]);
            }
            const c = Constraint.fromSpawn(palettes, patterns, loc, spawn, shiftable);
            child = child ? child.join(c) : c;
            if (!shiftable && spawn.patternBank)
                child = child.shifted();
        }
        if (!child)
            throw new Error(`Expected child to appear`);
        return child;
    }
}
function* allObjects(rom, parent) {
    yield parent;
    const repl = parent.spawnedReplacement();
    if (repl)
        yield* allObjects(rom, repl);
    const child = parent.spawnedChild();
    if (child)
        yield* allObjects(rom, child);
    if (parent.id === 0x50)
        yield rom.objects[0x5f];
    if (parent.id === 0x53)
        yield rom.objects[0x69];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL2dyYXBoaWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFFdEMsT0FBTyxFQUFDLGNBQWMsRUFBRSxPQUFPLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDckQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBUTNDLE1BQU0sT0FBTyxRQUFRO0lBT25CLFlBQXFCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBTDdCLHVCQUFrQixHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQ25ELG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFFL0Msc0JBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUtwQyxNQUFNLFNBQVMsR0FDWCxJQUFJLFVBQVUsQ0FBb0QsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFaEYsS0FBSyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQzdCLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSTtnQkFBRSxTQUFTO1lBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJO29CQUFFLFNBQVM7Z0JBQ3RCLElBQUksQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO29CQUNqQixTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFF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QUFVLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBTXpDLElBQUksTUFBTSxDQUFDLEVBQUUsS0FBSyxJQUFJO1FBQUUsTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBWSxDQUFDO0lBQzNELElBQUksTUFBTSxDQUFDLEVBQUUsS0FBSyxJQUFJO1FBQUUsTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBWSxDQUFDO0FBQzdELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RGVmYXVsdE1hcH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5pbXBvcnQge0xvY2F0aW9uLCBTcGF3bn0gZnJvbSAnLi9sb2NhdGlvbi5qcyc7XG5pbXBvcnQge0FDVElPTl9TQ1JJUFRTLCBNb25zdGVyfSBmcm9tICcuL21vbnN0ZXIuanMnO1xuaW1wb3J0IHtDb25zdHJhaW50fSBmcm9tICcuL2NvbnN0cmFpbnQuanMnO1xuaW1wb3J0IHtSYW5kb219IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLy8gVGhpcyBhY3R1YWxseSBhcHBlYXJzIHRvIGJlIG1vcmUgb2YgYSBHcmFwaGljc0NvbnN0cmFpbnRzIGNsYXNzP1xuLy8gICAtIG1heWJlIGRvbid0IHN0b3JlIHRoZSBjb25zdHJhaW50cyBvbiBNb25zdGVyP1xuXG5leHBvcnQgY2xhc3MgR3JhcGhpY3Mge1xuXG4gIG1vbnN0ZXJDb25zdHJhaW50cyA9IG5ldyBNYXA8bnVtYmVyLCBDb25zdHJhaW50PigpO1xuICBucGNDb25zdHJhaW50cyA9IG5ldyBNYXA8bnVtYmVyLCBDb25zdHJhaW50PigpO1xuXG4gIGFsbFNwcml0ZVBhbGV0dGVzID0gbmV3IFNldDxudW1iZXI+KCk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICAvLyBJdGVyYXRlIG92ZXIgbG9jYXRpb25zL3NwYXducyB0byBidWlsZCBtdWx0aW1hcCBvZiB3aGVyZSBtb25zdGVycyBhcHBlYXIuXG4gICAgLy8gUG9zdGl2ZSBrZXlzIGFyZSBtb25zdGVycywgbmVnYXRpdmUga2V5cyBhcmUgTlBDcy5cbiAgICBjb25zdCBhbGxTcGF3bnMgPVxuICAgICAgICBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIEFycmF5PHJlYWRvbmx5IFtMb2NhdGlvbiwgbnVtYmVyLCBTcGF3bl0+PigoKSA9PiBbXSk7XG5cbiAgICBmb3IgKGNvbnN0IGwgb2Ygcm9tLmxvY2F0aW9ucykge1xuICAgICAgaWYgKCFsLnVzZWQpIGNvbnRpbnVlO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsLnNwYXducy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzID0gbC5zcGF3bnNbaV07XG4gICAgICAgIGlmICghcy51c2VkKSBjb250aW51ZTtcbiAgICAgICAgaWYgKHMuaXNNb25zdGVyKCkpIHtcbiAgICAgICAgICBhbGxTcGF3bnMuZ2V0KHMubW9uc3RlcklkKS5wdXNoKFtsLCBpLCBzXSk7XG4gICAgICAgIH0gZWxzZSBpZiAocy5pc05wYygpKSB7XG4gICAgICAgICAgYWxsU3Bhd25zLmdldCh+cy5pZCkucHVzaChbbCwgaSwgc10pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIC8vIEZvciBlYWNoIG1vbnN0ZXIsIGRldGVybWluZSB3aGljaCBwYXR0ZXJucyBhbmQgcGFsZXR0ZXMgYXJlIHVzZWQuXG4gICAgZm9yIChjb25zdCBbbSwgc3Bhd25zXSBvZiBhbGxTcGF3bnMpIHtcbiAgICAgIC8vIFRPRE8gLSBmb2xkIGludG8gcGF0Y2guc2h1ZmZsZU1vbnN0ZXJzXG4gICAgICAvL2lmIChtID09PSAwKSBjb250aW51ZTsgLy8gdXNlZCB0byBzdXBwcmVzcyBidWdneSBzdHJheSBzcGF3bnNcbiAgICAgIGlmIChtIDwgMCkgeyAvLyBOUENcbiAgICAgICAgY29uc3QgbWV0YXNwcml0ZSA9IHJvbS5tZXRhc3ByaXRlc1tyb20ubnBjc1t+bV0uZGF0YVszXV07XG4gICAgICAgIGlmICghbWV0YXNwcml0ZSkgdGhyb3cgbmV3IEVycm9yKGBiYWQgTlBDOiAke35tfWApO1xuICAgICAgICBsZXQgY29uc3RyYWludCA9IHRoaXMuY29tcHV0ZUNvbnN0cmFpbnQoW3JvbS5ucGNzW35tXS5kYXRhWzNdXSwgc3Bhd25zLCB0cnVlKTtcbiAgICAgICAgLy8gVE9ETyAtIGJldHRlciB3YXkgc3JlYW1saW5lIHRoaXMuLi4/XG4gICAgICAgIGlmICh+bSA9PT0gMHg1ZikgY29uc3RyYWludCA9IGNvbnN0cmFpbnQuaWdub3JlUGFsZXR0ZSgpO1xuICAgICAgICB0aGlzLm5wY0NvbnN0cmFpbnRzLnNldCh+bSwgY29uc3RyYWludCk7XG4gICAgICB9IGVsc2UgeyAvLyBtb25zdGVyXG4gICAgICAgIGxldCBjb25zdHJhaW50ID0gQ29uc3RyYWludC5BTEw7XG4gICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMucm9tLm9iamVjdHNbbV07XG4gICAgICAgIGlmICghKHBhcmVudCBpbnN0YW5jZW9mIE1vbnN0ZXIpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBleHBlY3RlZCBtb25zdGVyOiAke3BhcmVudH0gZnJvbSAke3NwYXduc31gKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IG9iaiBvZiBhbGxPYmplY3RzKHJvbSwgcGFyZW50KSkge1xuICAgICAgICAgIGNvbnN0IGFjdGlvbiA9IEFDVElPTl9TQ1JJUFRTLmdldChvYmouYWN0aW9uKTtcbiAgICAgICAgICBjb25zdCBtZXRhc3ByaXRlRm46IChtOiBNb25zdGVyKSA9PiByZWFkb25seSBudW1iZXJbXSA9XG4gICAgICAgICAgICAgIGFjdGlvbiAmJiBhY3Rpb24ubWV0YXNwcml0ZXMgfHwgKCgpID0+IFtvYmoubWV0YXNwcml0ZV0pO1xuICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5jb21wdXRlQ29uc3RyYWludChtZXRhc3ByaXRlRm4ob2JqKSwgc3Bhd25zLCBvYmouaWQgPT09IG0pO1xuICAgICAgICAgIGNvbnN0IG1lZXQgPSBjb25zdHJhaW50Lm1lZXQoY2hpbGQpO1xuICAgICAgICAgIGlmICghbWVldCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWVldCBmb3IgJHttfSB3aXRoICR7b2JqLmlkfWApO1xuICAgICAgICAgIGlmIChtZWV0KSBjb25zdHJhaW50ID0gbWVldDtcbiAgICAgICAgICAvLyBUT0RPIC0gZWxzZSBlcnJvcj8gd2Fybj9cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cy5zZXQocGFyZW50LmlkLCBjb25zdHJhaW50KTtcbiAgICAgICAgcGFyZW50LmNvbnN0cmFpbnQgPSBjb25zdHJhaW50OyAgLy8gZm9yIGRlYnVnZ2luZ1xuICAgICAgfVxuICAgIH0gICAgXG4gIH1cblxuICBnZXRNb25zdGVyQ29uc3RyYWludChsb2NhdGlvbklkOiBudW1iZXIsIG1vbnN0ZXJJZDogbnVtYmVyKTogQ29uc3RyYWludCB7XG4gICAgY29uc3QgYyA9IHRoaXMubW9uc3RlckNvbnN0cmFpbnRzLmdldChtb25zdGVySWQpIHx8IENvbnN0cmFpbnQuTk9ORTtcbiAgICBpZiAoKGxvY2F0aW9uSWQgJiAweDU4KSA9PT0gMHg1OCkgcmV0dXJuIGM7XG4gICAgY29uc3QgbSA9IHRoaXMucm9tLm9iamVjdHNbbW9uc3RlcklkXS5nb2xkRHJvcDtcbiAgICBpZiAoIW0pIHJldHVybiBjO1xuICAgIHJldHVybiBjLm1lZXQoQ29uc3RyYWludC5DT0lOKSB8fCBDb25zdHJhaW50Lk5PTkU7XG4gIH1cblxuICBzaHVmZmxlUGFsZXR0ZXMocmFuZG9tOiBSYW5kb20pOiB2b2lkIHtcbiAgICBjb25zdCBwYWwgPSBbLi4udGhpcy5hbGxTcHJpdGVQYWxldHRlc107XG4gICAgZm9yIChjb25zdCBbaywgY10gb2YgdGhpcy5tb25zdGVyQ29uc3RyYWludHMpIHtcbiAgICAgIHRoaXMubW9uc3RlckNvbnN0cmFpbnRzLnNldChrLCBjLnNodWZmbGVQYWxldHRlKHJhbmRvbSwgcGFsKSk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgW2ssIGNdIG9mIHRoaXMubnBjQ29uc3RyYWludHMpIHtcbiAgICAgIHRoaXMubnBjQ29uc3RyYWludHMuc2V0KGssIGMuc2h1ZmZsZVBhbGV0dGUocmFuZG9tLCBwYWwpKTtcbiAgICB9XG4gIH1cblxuICBjb25maWd1cmUobG9jYXRpb246IExvY2F0aW9uLCBzcGF3bjogU3Bhd24pIHtcbiAgICBpZiAoIXNwYXduLnVzZWQpIHJldHVybjtcbiAgICBjb25zdCBjID0gc3Bhd24uaXNNb25zdGVyKCkgPyB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cy5nZXQoc3Bhd24ubW9uc3RlcklkKSA6XG4gICAgICAgIHNwYXduLmlzTnBjKCkgPyB0aGlzLm5wY0NvbnN0cmFpbnRzLmdldChzcGF3bi5pZCkgOlxuICAgICAgICBzcGF3bi5pc0NoZXN0KCkgPyAoc3Bhd24uaWQgPCAweDcwID8gQ29uc3RyYWludC5UUkVBU1VSRV9DSEVTVCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBDb25zdHJhaW50Lk1JTUlDKSA6XG4gICAgICAgIHVuZGVmaW5lZDtcbiAgICBpZiAoIWMpIHJldHVybjtcbiAgICBpZiAoYy5zaGlmdCA9PT0gMyB8fCBjLmZsb2F0Lmxlbmd0aCA+PSAyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGRvbid0IGtub3cgd2hhdCB0byBkbyB3aXRoIHR3byBmbG9hdHNgKTtcbiAgICB9IGVsc2UgaWYgKCFjLmZsb2F0Lmxlbmd0aCkge1xuICAgICAgc3Bhd24ucGF0dGVybkJhbmsgPSBOdW1iZXIoYy5zaGlmdCA9PT0gMik7XG4gICAgfSBlbHNlIGlmIChjLmZsb2F0WzBdLmhhcyhsb2NhdGlvbi5zcHJpdGVQYXR0ZXJuc1swXSkpIHtcbiAgICAgIHNwYXduLnBhdHRlcm5CYW5rID0gMDtcbiAgICB9IGVsc2UgaWYgKGMuZmxvYXRbMF0uaGFzKGxvY2F0aW9uLnNwcml0ZVBhdHRlcm5zWzFdKSkge1xuICAgICAgc3Bhd24ucGF0dGVybkJhbmsgPSAxO1xuICAgIH0gZWxzZSBpZiAoc3Bhd24uaXNNb25zdGVyKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgbm8gbWF0Y2hpbmcgcGF0dGVybiBiYW5rYCk7XG4gICAgfVxuICB9XG5cbiAgY29tcHV0ZUNvbnN0cmFpbnQobWV0YXNwcml0ZUlkczogcmVhZG9ubHkgbnVtYmVyW10sXG4gICAgICAgICAgICAgICAgICAgIHNwYXduczogU3Bhd25zLFxuICAgICAgICAgICAgICAgICAgICBzaGlmdGFibGU6IGJvb2xlYW4pOiBDb25zdHJhaW50IHtcblxuICAgIGNvbnN0IHBhdHRlcm5zID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgY29uc3QgcGFsZXR0ZXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBmb3IgKGNvbnN0IG1ldGFzcHJpdGUgb2YgbWV0YXNwcml0ZUlkcy5tYXAocyA9PiB0aGlzLnJvbS5tZXRhc3ByaXRlc1tzXSkpIHtcbiAgICAgIC8vIFdoaWNoIHBhbGV0dGUgYW5kIHBhdHRlcm4gYmFua3MgYXJlIHJlZmVyZW5jZWQ/XG4gICAgICBmb3IgKGNvbnN0IHAgb2YgbWV0YXNwcml0ZS5wYWxldHRlcygpKSB7XG4gICAgICAgIHBhbGV0dGVzLmFkZChwKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgcCBvZiBtZXRhc3ByaXRlLnBhdHRlcm5CYW5rcygpKSB7XG4gICAgICAgIHBhdHRlcm5zLmFkZChwKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBvYmoudXNlZFBhbGV0dGVzID0gWy4uLnBhbGV0dGVzXTtcbiAgICAvLyBvYmoudXNlZFBhdHRlcm5zID0gWy4uLnBhdHRlcm5zXTtcblxuICAgIC8vIElmIG9ubHkgdGhpcmQtYmFuayBwYXR0ZXJucyBhcmUgdXNlZCwgdGhlbiB0aGUgbWV0YXNwcml0ZSBjYW4gYmVcbiAgICAvLyBzaGlmdGVkIHRvIGZvdXJ0aCBiYW5rIHdoZW4gbmVjZXNzYXJ5LiAgVGhpcyBpcyBvbmx5IHRydWUgZm9yIE5QQ1xuICAgIC8vIHNwYXducy4gIEFkIGhvYyBzcGF3bnMgY2Fubm90IGJlIHNoaWZ0ZWQgKHlldD8pLlxuICAgIHNoaWZ0YWJsZSA9IHNoaWZ0YWJsZSAmJiBwYXR0ZXJucy5zaXplID09IDEgJiYgWy4uLnBhdHRlcm5zXVswXSA9PT0gMjtcblxuICAgIC8vIElmIHRoZSBzcGF3biBzZXRzIHBhdHRlcm5CYW5rIHRoZW4gd2UgbmVlZCB0byBpbmNyZW1lbnQgZWFjaCBwYXR0ZXJuLlxuICAgIC8vIFdlIGhhdmUgdGhlIGZyZWVkb20gdG8gc2V0IHRoaXMgdG8gZWl0aGVyLCBkZXBlbmRpbmcuXG4gICAgY29uc3QgbG9jcyA9IG5ldyBNYXA8bnVtYmVyLCBTcGF3bj4oKTtcbiAgICBmb3IgKGNvbnN0IFtsLCAsIHNwYXduXSBvZiBzcGF3bnMpIHtcbiAgICAgIGxvY3Muc2V0KHNwYXduLnBhdHRlcm5CYW5rICYmIHNoaWZ0YWJsZSA/IH5sLmlkIDogbC5pZCwgc3Bhd24pO1xuICAgIH1cblxuICAgIC8vIFRPRE8gLSBDb25zdHJhaW50QnVpbGRlclxuICAgIC8vICAgLS0ga2VlcHMgdHJhY2sgb25seSBvZiByZWxldmFudCBmYWN0b3JzLCBpbiBhIGpvaW4uXG4gICAgLy8gICAgICAtLT4gbm8gbWVldGluZyBpbnZvbHZlZCFcbiAgICBsZXQgY2hpbGQgPSB1bmRlZmluZWQ7XG5cbiAgICBmb3IgKGxldCBbbCwgc3Bhd25dIG9mIGxvY3MpIHtcbiAgICAgIGNvbnN0IGxvYyA9IHRoaXMucm9tLmxvY2F0aW9uc1tsIDwgMCA/IH5sIDogbF07XG4gICAgICBmb3IgKGNvbnN0IHBhbCBvZiBwYWxldHRlcykge1xuICAgICAgICBpZiAocGFsID4gMSkgdGhpcy5hbGxTcHJpdGVQYWxldHRlcy5hZGQobG9jLnNwcml0ZVBhbGV0dGVzW3BhbCAtIDJdKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGMgPSBDb25zdHJhaW50LmZyb21TcGF3bihwYWxldHRlcywgcGF0dGVybnMsIGxvYywgc3Bhd24sIHNoaWZ0YWJsZSk7XG4gICAgICBjaGlsZCA9IGNoaWxkID8gY2hpbGQuam9pbihjKSA6IGM7XG4gICAgICBpZiAoIXNoaWZ0YWJsZSAmJiBzcGF3bi5wYXR0ZXJuQmFuaykgY2hpbGQgPSBjaGlsZC5zaGlmdGVkKCk7XG5cbiAgICAgIC8vIC0tLSBoYW5kbGUgc2hpZnRzIGJldHRlci4uLj8gc3VwcG9zZSBlLmcuIG11bHRpcGxlIHBhbDInc1xuICAgICAgLy8gICAgLT4gd2Ugd2FudCB0byBqb2luIHRoZW0gLSB3aWxsIGhhdmUgbXVsdGlwbGUgc2hpZnRhYmxlcy4uLlxuICAgICAgLy9jb25zdHJhaW50ID0gY29uc3RyYWludC5cbiAgICB9XG5cbiAgICAvLyBJZiB3ZSdyZSBzaGlmdGFibGUsIHNhdmUgdGhlIHNldCBvZiBwb3NzaWJsZSBzaGlmdCBiYW5rc1xuICAgIGlmICghY2hpbGQpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgY2hpbGQgdG8gYXBwZWFyYCk7XG4gICAgLy8gaWYgKGNoaWxkLmZsb2F0Lmxlbmd0aCA9PT0gMSkge1xuICAgIC8vICAgcGFyZW50LnNoaWZ0UGF0dGVybnMgPSBuZXcgU2V0KGNoaWxkLmZsb2F0WzBdKTtcbiAgICAvLyB9XG4gICAgcmV0dXJuIGNoaWxkO1xuICB9XG59XG5cbmZ1bmN0aW9uKiBhbGxPYmplY3RzKHJvbTogUm9tLCBwYXJlbnQ6IE1vbnN0ZXIpOiBJdGVyYWJsZTxNb25zdGVyPiB7XG4gIHlpZWxkIHBhcmVudDtcbiAgY29uc3QgcmVwbCA9IHBhcmVudC5zcGF3bmVkUmVwbGFjZW1lbnQoKTtcbiAgaWYgKHJlcGwpIHlpZWxkKiBhbGxPYmplY3RzKHJvbSwgcmVwbCk7XG4gIGNvbnN0IGNoaWxkID0gcGFyZW50LnNwYXduZWRDaGlsZCgpO1xuICBpZiAoY2hpbGQpIHlpZWxkKiBhbGxPYmplY3RzKHJvbSwgY2hpbGQpO1xuICAvLyBUT0RPIC0gdGhlc2UgZG9uJ3QgbWFrZSBzZW5zZSB0byBwdXQgaW4gc3Bhd25lZFJlcGxhY2VtZW50IGJlY2F1c2VcbiAgLy8gd2UgZG9uJ3Qgd2FudCB0byBvdmVyLWluZmxhdGUgcmVkIHNsaW1lcyBkdWUgdG8gZ2lhbnQgcmVkIHNsaW1lcydcbiAgLy8gZGlmZmljdWx0eSwgc2luY2UgbW9zdCBmb2xrcyB3aWxsIG5ldmVyIGhhdmUgdG8gZGVhbCB3aXRoIHRoYXQuXG4gIC8vIEJ1dCB3ZSBkbyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZXkgZ2V0IFwidW4tZmxvYXRlZFwiIHNpbmNlIHRoZVxuICAvLyByZXBsYWNlbWVudCBzcGF3biB3aWxsIG5vdCBzaGFyZSB0aGUgc2FtZSAzODA6MjAgKGZvciBub3cpLlxuICBpZiAocGFyZW50LmlkID09PSAweDUwKSB5aWVsZCByb20ub2JqZWN0c1sweDVmXSBhcyBNb25zdGVyOyAvLyBibHVlIHNsaW1lXG4gIGlmIChwYXJlbnQuaWQgPT09IDB4NTMpIHlpZWxkIHJvbS5vYmplY3RzWzB4NjldIGFzIE1vbnN0ZXI7IC8vIHJlZCBzbGltZVxufVxuXG50eXBlIFNwYXducyA9IFJlYWRvbmx5QXJyYXk8cmVhZG9ubHkgW0xvY2F0aW9uLCBudW1iZXIsIFNwYXduXT47XG4iXX0=