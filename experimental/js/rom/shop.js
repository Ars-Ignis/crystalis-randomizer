import { Entity, EntityArray } from './entity.js';
import { readLittleEndian, seq, tuple } from './util.js';
export class Shops extends EntityArray {
    constructor(rom) {
        super(44);
        this.rom = rom;
        this.innBasePrice = 20;
        this.toolShopScaling = new Array(48).fill(0);
        this.armorShopScaling = new Array(48).fill(0);
        for (let i = 0; i < 44; i++) {
            this[i] = new Shop(rom, i);
        }
        if (rom.shopDataTablesAddress != null) {
            const address = rom.shopDataTablesAddress +
                21 * rom.shopCount +
                2 * rom.scalingLevels;
            this.basePrices = seq(0x49, id => id >= 0xd && id < 0x27 ?
                readLittleEndian(rom.prg, address + 2 * (id - 0xd)) :
                0);
        }
        else {
            this.basePrices =
                seq(0x49, id => readLittleEndian(rom.prg, VANILLA_PAWN_PRICE_TABLE + 2 * id) * 2);
        }
    }
    armorShops() {
        return seq(11, i => this[4 * i]);
    }
    toolShops() {
        return seq(11, i => this[4 * i + 1]);
    }
    inns() {
        return seq(11, i => this[4 * i + 2]);
    }
    pawnShops() {
        return seq(11, i => this[4 * i + 3]);
    }
    write() {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j;
        const a = this.rom.assembler();
        if (this.rescale) {
            function exportLabel(label) {
                a.export(label);
                a.label(label);
            }
            a.segment("10", "fe", "ff");
            a.org(0x9da4);
            exportLabel('ShopData');
            exportLabel('ArmorShopIdTable');
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_a = shop.contents[i], (_a !== null && _a !== void 0 ? _a : 0xff)));
                }
            }
            exportLabel('ToolShopIdTable');
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_b = shop.contents[i], (_b !== null && _b !== void 0 ? _b : 0xff)));
                }
            }
            exportLabel('ArmorShopPriceTable');
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte(Math.round((_c = shop.prices[i], (_c !== null && _c !== void 0 ? _c : 0)) * 32));
                }
            }
            exportLabel('ToolShopPriceTable');
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte(Math.round((_d = shop.prices[i], (_d !== null && _d !== void 0 ? _d : 0)) * 32));
                }
            }
            exportLabel('InnPrices');
            for (const shop of this.inns()) {
                a.byte(Math.round((_e = shop.prices[0], (_e !== null && _e !== void 0 ? _e : 0)) * 32));
            }
            exportLabel('ShopLocations');
            for (const shop of this) {
                a.byte(shop.location);
            }
            exportLabel('ToolShopScaling');
            a.byte(...this.toolShopScaling);
            exportLabel('ArmorShopScaling');
            a.byte(...this.armorShopScaling);
            exportLabel('BasePrices');
            a.word(...this.basePrices.slice(0x0d, 0x27).map(x => (x !== null && x !== void 0 ? x : 0)));
            exportLabel('InnBasePrice');
            a.word(this.innBasePrice);
        }
        else {
            a.segment('10');
            a.org(0x9da4);
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_f = shop.contents[i], (_f !== null && _f !== void 0 ? _f : 0xff)));
                }
            }
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.word((_g = shop.prices[i], (_g !== null && _g !== void 0 ? _g : 0)));
                }
            }
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_h = shop.contents[i], (_h !== null && _h !== void 0 ? _h : 0xff)));
                }
            }
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.word((_j = shop.prices[i], (_j !== null && _j !== void 0 ? _j : 0)));
                }
            }
        }
        return [a.module()];
    }
}
export var ShopType;
(function (ShopType) {
    ShopType[ShopType["ARMOR"] = 0] = "ARMOR";
    ShopType[ShopType["TOOL"] = 1] = "TOOL";
    ShopType[ShopType["INN"] = 2] = "INN";
    ShopType[ShopType["PAWN"] = 3] = "PAWN";
})(ShopType || (ShopType = {}));
const SHOP_TYPES = [ShopType.ARMOR, ShopType.TOOL, ShopType.INN, ShopType.PAWN];
const CONTENTS_ADDRESSES = [
    (base, count) => base ? base : VANILLA_ARMOR_SHOP_ITEMS,
    (base, count) => base ? base + 4 * count : VANILLA_TOOL_SHOP_ITEMS,
    (base, count) => 0,
    (base, count) => 0,
];
const CONTENTS_COUNTS = [4, 4, 0, 0];
const PRICES_ADDRESSES = [
    (base, count) => base ? base + 8 * count : VANILLA_ARMOR_SHOP_PRICES,
    (base, count) => base ? base + 12 * count : VANILLA_TOOL_SHOP_PRICES,
    (base, count) => base ? base + 16 * count : VANILLA_INN_PRICES,
    (base, count) => 0,
];
const PRICES_COUNTS = [4, 4, 1, 0];
export class Shop extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.type = SHOP_TYPES[id & 3];
        this.index = id >>> 2;
        if (rom.shopDataTablesAddress) {
            const base = rom.shopDataTablesAddress;
            const count = rom.shopCount;
            const locationTable = base + 17 * count;
            this.location = rom.prg[locationTable + id];
        }
        else {
            let shopLocation = 0xff;
            for (let i = 0; i < 33 && shopLocation === 0xff; i++) {
                if (rom.prg[VANILLA_SHOP_INDICES + i] !== this.index)
                    continue;
                const location = rom.prg[VANILLA_SHOP_LOCATIONS + i];
                for (const spawn of rom.locations[location].spawns) {
                    if (spawn.type !== 4)
                        continue;
                    const obj = rom.objects[spawn.id];
                    if (obj.data[25] === 0x20 + this.type) {
                        shopLocation = location;
                        break;
                    }
                }
            }
            this.location = shopLocation;
        }
        const readPrice = rom.shopDataTablesAddress ?
            i => rom.prg[this.pricesAddress + i] / 32 :
            i => readLittleEndian(rom.prg, this.pricesAddress + 2 * i);
        this.contents = tuple(rom.prg, this.contentsAddress, CONTENTS_COUNTS[this.type]);
        this.prices = seq(PRICES_COUNTS[this.type], readPrice);
        this.used = this.location !== 0xff;
    }
    get contentsAddress() {
        const base = CONTENTS_ADDRESSES[this.type](this.rom.shopDataTablesAddress, this.rom.shopCount);
        return base + 4 * this.index;
    }
    get pricesAddress() {
        const shopTable = this.rom.shopDataTablesAddress;
        const base = PRICES_ADDRESSES[this.type](shopTable, this.rom.shopCount);
        return base + (shopTable ? 1 : 2) * PRICES_COUNTS[this.type] * this.index;
    }
    updateShopkeeper() {
        throw new Error('not implemented');
    }
}
const VANILLA_SHOP_LOCATIONS = 0x21f54;
const VANILLA_SHOP_INDICES = 0x21f75;
const VANILLA_ARMOR_SHOP_ITEMS = 0x21da4;
const VANILLA_ARMOR_SHOP_PRICES = 0x21dd0;
const VANILLA_TOOL_SHOP_ITEMS = 0x21e28;
const VANILLA_TOOL_SHOP_PRICES = 0x21e54;
const VANILLA_INN_PRICES = 0x21eac;
const VANILLA_PAWN_PRICE_TABLE = 0x21ec2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vc2hvcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFdBQVcsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUd2RCxNQUFNLE9BQU8sS0FBTSxTQUFRLFdBQWlCO0lBUTFDLFlBQXFCLEdBQVE7UUFDM0IsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRFMsUUFBRyxHQUFILEdBQUcsQ0FBSztRQUw3QixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUNsQixvQkFBZSxHQUFhLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxxQkFBZ0IsR0FBYSxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFLakQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMzQixJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQzVCO1FBRUQsSUFBSSxHQUFHLENBQUMscUJBQXFCLElBQUksSUFBSSxFQUFFO1lBQ3JDLE1BQU0sT0FBTyxHQUNULEdBQUcsQ0FBQyxxQkFBcUI7Z0JBQ3pCLEVBQUUsR0FBRyxHQUFHLENBQUMsU0FBUztnQkFDbEIsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUM7WUFDMUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLEdBQUcsSUFBSSxFQUFFLEdBQUcsSUFBSSxD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QyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQzVFLENBQUM7SUFNRCxnQkFBZ0I7UUFPZCxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDckMsQ0FBQztDQUNGO0FBRUQsTUFBTSxzQkFBc0IsR0FBRyxPQUFPLENBQUM7QUFDdkMsTUFBTSxvQkFBb0IsR0FBRyxPQUFPLENBQUM7QUFDckMsTUFBTSx3QkFBd0IsR0FBRyxPQUFPLENBQUM7QUFDekMsTUFBTSx5QkFBeUIsR0FBRyxPQUFPLENBQUM7QUFDMUMsTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUM7QUFDeEMsTUFBTSx3QkFBd0IsR0FBRyxPQUFPLENBQUM7QUFDekMsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUM7QUFDbkMsTUFBTSx3QkFBd0IsR0FBRyxPQUFPLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZHVsZX0gZnJvbSAnLi4vYXNtL21vZHVsZS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RW50aXR5LCBFbnRpdHlBcnJheX0gZnJvbSAnLi9lbnRpdHkuanMnO1xuaW1wb3J0IHtyZWFkTGl0dGxlRW5kaWFuLCBzZXEsIHR1cGxlfSBmcm9tICcuL3V0aWwuanMnO1xuXG5cbmV4cG9ydCBjbGFzcyBTaG9wcyBleHRlbmRzIEVudGl0eUFycmF5PFNob3A+IHtcblxuICByZXNjYWxlPzogYm9vbGVhbjtcbiAgaW5uQmFzZVByaWNlID0gMjA7XG4gIHRvb2xTaG9wU2NhbGluZzogbnVtYmVyW10gPSBuZXcgQXJyYXkoNDgpLmZpbGwoMCk7XG4gIGFybW9yU2hvcFNjYWxpbmc6IG51bWJlcltdID0gbmV3IEFycmF5KDQ4KS5maWxsKDApO1xuICBiYXNlUHJpY2VzOiBudW1iZXJbXTtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSkge1xuICAgIHN1cGVyKDQ0KTsgLy8gNCAqIHJvbS5zaG9wQ291bnQpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDQ7IGkrKykge1xuICAgICAgdGhpc1tpXSA9IG5ldyBTaG9wKHJvbSwgaSk7XG4gICAgfVxuXG4gICAgaWYgKHJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3MgIT0gbnVsbCkge1xuICAgICAgY29uc3QgYWRkcmVzcyA9XG4gICAgICAgICAgcm9tLnNob3BEYXRhVGFibGVzQWRkcmVzcyArXG4gICAgICAgICAgMjEgKiByb20uc2hvcENvdW50ICtcbiAgICAgICAgICAyICogcm9tLnNjYWxpbmdMZXZlbHM7XG4gICAgICB0aGlzLmJhc2VQcmljZXMgPSBzZXEoMHg0OSwgaWQgPT4gaWQgPj0gMHhkICYmIGlkIDwgMHgyNyA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZExpdHRsZUVuZGlhbihyb20ucHJnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyArIDIgKiAoaWQgLSAweGQpKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgMCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYmFzZVByaWNlcyA9XG4gICAgICAgICAgc2VxKDB4NDksXG4gICAgICAgICAgICAgIGlkID0+IHJlYWRMaXR0bGVFbmRpYW4ocm9tLnByZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBWQU5JTExBX1BBV05fUFJJQ0VfVEFCTEUgKyAyICogaWQpICogMik7XG4gICAgfVxuICAgIFxuICB9XG5cbiAgYXJtb3JTaG9wcygpOiBTaG9wW10ge1xuICAgIHJldHVybiBzZXEoMTEsIGkgPT4gdGhpc1s0ICogaV0pO1xuICB9XG5cbiAgdG9vbFNob3BzKCk6IFNob3BbXSB7XG4gICAgcmV0dXJuIHNlcSgxMSwgaSA9PiB0aGlzWzQgKiBpICsgMV0pO1xuICB9XG5cbiAgaW5ucygpOiBTaG9wW10ge1xuICAgIHJldHVybiBzZXEoMTEsIGkgPT4gdGhpc1s0ICogaSArIDJdKTtcbiAgfVxuXG4gIHBhd25TaG9wcygpOiBTaG9wW10ge1xuICAgIHJldHVybiBzZXEoMTEsIGkgPT4gdGhpc1s0ICogaSArIDNdKTtcbiAgfVxuXG4gIHdyaXRlKCk6IE1vZHVsZVtdIHtcbiAgICBjb25zdCBhID0gdGhpcy5yb20uYXNzZW1ibGVyKCk7XG4gICAgaWYgKHRoaXMucmVzY2FsZSkge1xuICAgICAgZnVuY3Rpb24gZXhwb3J0TGFiZWwobGFiZWw6IHN0cmluZykge1xuICAgICAgICBhLmV4cG9ydChsYWJlbCk7XG4gICAgICAgIGEubGFiZWwobGFiZWwpO1xuICAgICAgfVxuICAgICAgYS5zZWdtZW50KFwiMTBcIiwgXCJmZVwiLCBcImZmXCIpO1xuICAgICAgYS5vcmcoMHg5ZGE0KTsgLy8gVE9ETyAtIHJlbG9jLCBicmVhayBpdCB1cCBhIGJpdD9cbiAgICAgIC8vIE5PVEU6IFRoaXMgc3RydWN0dXJlIGlzIGhhcmQtY29kZWQgaW4gUm9tT3B0aW9uLCB3aXRoIHR3byBwYXJhbWV0ZXJzOlxuICAgICAgLy8gIDEuIFNIT1BfQ09VTlQgKDExKVxuICAgICAgLy8gIDIuIFNDQUxJTkdfTEVWRUxTICg0OClcbiAgICAgIC8vICAzLiBQYXduIHByaWNlczogNTIgYnl0ZXMgICA7IDAgPSAkMGQsIDUwID0gJDI2LCA1MSA9IFwiJDI3XCIgKGlubilcbiAgICAgIGV4cG9ydExhYmVsKCdTaG9wRGF0YScpO1xuICAgICAgZXhwb3J0TGFiZWwoJ0FybW9yU2hvcElkVGFibGUnKTtcbiAgICAgIGZvciAoY29uc3Qgc2hvcCBvZiB0aGlzLmFybW9yU2hvcHMoKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICAgIGEuYnl0ZShzaG9wLmNvbnRlbnRzW2ldID8/IDB4ZmYpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBleHBvcnRMYWJlbCgnVG9vbFNob3BJZFRhYmxlJyk7XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcy50b29sU2hvcHMoKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICAgIGEuYnl0ZShzaG9wLmNvbnRlbnRzW2ldID8/IDB4ZmYpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBleHBvcnRMYWJlbCgnQXJtb3JTaG9wUHJpY2VUYWJsZScpO1xuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMuYXJtb3JTaG9wcygpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICAgICAgYS5ieXRlKE1hdGgucm91bmQoKHNob3AucHJpY2VzW2ldID8/IDApICogMzIpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZXhwb3J0TGFiZWwoJ1Rvb2xTaG9wUHJpY2VUYWJsZScpO1xuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMudG9vbFNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLmJ5dGUoTWF0aC5yb3VuZCgoc2hvcC5wcmljZXNbaV0gPz8gMCkgKiAzMikpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBleHBvcnRMYWJlbCgnSW5uUHJpY2VzJyk7XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcy5pbm5zKCkpIHtcbiAgICAgICAgYS5ieXRlKE1hdGgucm91bmQoKHNob3AucHJpY2VzWzBdID8/IDApICogMzIpKTtcbiAgICAgIH1cbiAgICAgIGV4cG9ydExhYmVsKCdTaG9wTG9jYXRpb25zJyk7XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcykge1xuICAgICAgICBhLmJ5dGUoc2hvcC5sb2NhdGlvbik7XG4gICAgICB9XG4gICAgICBleHBvcnRMYWJlbCgnVG9vbFNob3BTY2FsaW5nJyk7XG4gICAgICBhLmJ5dGUoLi4udGhpcy50b29sU2hvcFNjYWxpbmcpO1xuICAgICAgZXhwb3J0TGFiZWwoJ0FybW9yU2hvcFNjYWxpbmcnKTtcbiAgICAgIGEuYnl0ZSguLi50aGlzLmFybW9yU2hvcFNjYWxpbmcpO1xuICAgICAgZXhwb3J0TGFiZWwoJ0Jhc2VQcmljZXMnKTtcbiAgICAgIGEud29yZCguLi50aGlzLmJhc2VQcmljZXMuc2xpY2UoMHgwZCwgMHgyNykubWFwKHggPT4geCA/PyAwKSk7XG4gICAgICBleHBvcnRMYWJlbCgnSW5uQmFzZVByaWNlJyk7XG4gICAgICBhLndvcmQodGhpcy5pbm5CYXNlUHJpY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUT0RPIC0gY2FuIHdlIGV2ZW4gd3JpdGUgbm9uLWRlZnJhZ2dlZCBzaG9wcz9cbiAgICAgIGEuc2VnbWVudCgnMTAnKTtcbiAgICAgIGEub3JnKDB4OWRhNCk7XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcy5hcm1vclNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLmJ5dGUoc2hvcC5jb250ZW50c1tpXSA/PyAweGZmKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMuYXJtb3JTaG9wcygpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICAgICAgYS53b3JkKHNob3AucHJpY2VzW2ldID8/IDApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcy50b29sU2hvcHMoKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICAgIGEuYnl0ZShzaG9wLmNvbnRlbnRzW2ldID8/IDB4ZmYpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcy50b29sU2hvcHMoKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICAgIGEud29yZChzaG9wLnByaWNlc1tpXSA/PyAwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gW2EubW9kdWxlKCldO1xuICB9XG59XG5cblxuLy8gU2hvcHMgYXJlIHN0cmlwZWQ6IHRvb2wsIGFybW9yLCBpbm4sIHBhd25cbi8vIFNvIHRoZSB0b29sIHNob3BzIGhhdmUgSUQgMCwgNCwgOCwgLi4uLCA0MDsgZXRjXG5leHBvcnQgZW51bSBTaG9wVHlwZSB7XG4gIEFSTU9SID0gMCxcbiAgVE9PTCA9IDEsXG4gIElOTiA9IDIsXG4gIFBBV04gPSAzLFxufVxuXG5jb25zdCBTSE9QX1RZUEVTID0gW1Nob3BUeXBlLkFSTU9SLCBTaG9wVHlwZS5UT09MLCBTaG9wVHlwZS5JTk4sIFNob3BUeXBlLlBBV05dO1xuXG5jb25zdCBDT05URU5UU19BRERSRVNTRVM6ICgoYmFzZTogbnVtYmVyLCBjb3VudDogbnVtYmVyKSA9PiBudW1iZXIpW10gPSBbXG4gIChiYXNlLCBjb3VudCkgPT4gYmFzZSA/IGJhc2UgOiBWQU5JTExBX0FSTU9SX1NIT1BfSVRFTVMsXG4gIChiYXNlLCBjb3VudCkgPT4gYmFzZSA/IGJhc2UgKyA0ICogY291bnQgOiBWQU5JTExBX1RPT0xfU0hPUF9JVEVNUyxcbiAgKGJhc2UsIGNvdW50KSA9PiAwLFxuICAoYmFzZSwgY291bnQpID0+IDAsXG5dO1xuXG5jb25zdCBDT05URU5UU19DT1VOVFMgPSBbNCwgNCwgMCwgMF07XG5cbmNvbnN0IFBSSUNFU19BRERSRVNTRVM6ICgoYmFzZTogbnVtYmVyLCBjb3VudDogbnVtYmVyKSA9PiBudW1iZXIpW10gPSBbXG4gIChiYXNlLCBjb3VudCkgPT4gYmFzZSA/IGJhc2UgKyA4ICogY291bnQgOiBWQU5JTExBX0FSTU9SX1NIT1BfUFJJQ0VTLFxuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlICsgMTIgKiBjb3VudCA6IFZBTklMTEFfVE9PTF9TSE9QX1BSSUNFUyxcbiAgKGJhc2UsIGNvdW50KSA9PiBiYXNlID8gYmFzZSArIDE2ICogY291bnQgOiBWQU5JTExBX0lOTl9QUklDRVMsXG4gIChiYXNlLCBjb3VudCkgPT4gMCxcbl07XG5cbmNvbnN0IFBSSUNFU19DT1VOVFMgPSBbNCwgNCwgMSwgMF07XG5cbmV4cG9ydCBjbGFzcyBTaG9wIGV4dGVuZHMgRW50aXR5IHtcblxuICByZWFkb25seSB1c2VkOiBib29sZWFuO1xuICByZWFkb25seSBsb2NhdGlvbjogbnVtYmVyO1xuICByZWFkb25seSBpbmRleDogbnVtYmVyO1xuICByZWFkb25seSB0eXBlOiBTaG9wVHlwZTtcblxuICAvLyBMaXN0IG9mIHVwIHRvIDQgaXRlbSBJRHMgYmVpbmcgc29sZCBhdCB0aGlzIHNob3AuXG4gIGNvbnRlbnRzOiBudW1iZXJbXTtcblxuICAvLyBNZWFuaW5nIGRlcGVuZHMgb24gd2hldGhlciBzaG9wcyBhcmUgbm9ybWFsaXplZC4gIElmIHNvIHRoZW4gdGhpcyBpc1xuICAvLyB0aGUgYWRqdXN0bWVudCBmcm9tIHRoZSBiYXNlIHByaWNlLCBhcyBhIGZyYWN0aW9uLiAgSWYgbm90IHRoZW4gdGhpc1xuICAvLyBpcyBqdXN0IHRoZSAxNi1iaXQgcHJpY2UuXG4gIHByaWNlczogbnVtYmVyW107XG5cbiAgY29uc3RydWN0b3Iocm9tOiBSb20sIGlkOiBudW1iZXIpIHtcbiAgICBzdXBlcihyb20sIGlkKTtcblxuICAgIHRoaXMudHlwZSA9IFNIT1BfVFlQRVNbaWQgJiAzXTtcbiAgICB0aGlzLmluZGV4ID0gaWQgPj4+IDI7XG5cbiAgICBpZiAocm9tLnNob3BEYXRhVGFibGVzQWRkcmVzcykge1xuICAgICAgLy8gTm9ybWFsaXplZCBwcmljZXMgLSBjb25zdHJ1Y3QgdGhlIHRhYmxlIGxvY2F0aW9uc1xuICAgICAgY29uc3QgYmFzZSA9IHJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3M7XG4gICAgICBjb25zdCBjb3VudCA9IHJvbS5zaG9wQ291bnQ7XG4gICAgICBjb25zdCBsb2NhdGlvblRhYmxlID0gYmFzZSArIDE3ICogY291bnQ7XG4gICAgICB0aGlzLmxvY2F0aW9uID0gcm9tLnByZ1tsb2NhdGlvblRhYmxlICsgaWRdO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBWYW5pbGxhIHNob3BzOiBuZWVkIHRvIGRvIGEgbW9yZSBpbnZvbHZlZCBzZWFyY2ggZm9yIHNob3AgbG9jYXRpb24uXG4gICAgICBsZXQgc2hvcExvY2F0aW9uID0gMHhmZjtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzMgJiYgc2hvcExvY2F0aW9uID09PSAweGZmOyBpKyspIHtcbiAgICAgICAgaWYgKHJvbS5wcmdbVkFOSUxMQV9TSE9QX0lORElDRVMgKyBpXSAhPT0gdGhpcy5pbmRleCkgY29udGludWU7XG4gICAgICAgIGNvbnN0IGxvY2F0aW9uID0gcm9tLnByZ1tWQU5JTExBX1NIT1BfTE9DQVRJT05TICsgaV07XG4gICAgICAgIGZvciAoY29uc3Qgc3Bhd24gb2Ygcm9tLmxvY2F0aW9uc1tsb2NhdGlvbl0uc3Bhd25zKSB7XG4gICAgICAgICAgaWYgKHNwYXduLnR5cGUgIT09IDQpIGNvbnRpbnVlO1xuICAgICAgICAgIGNvbnN0IG9iaiA9IHJvbS5vYmplY3RzW3NwYXduLmlkXTtcbiAgICAgICAgICBpZiAob2JqLmRhdGFbMjVdID09PSAweDIwICsgdGhpcy50eXBlKSB7XG4gICAgICAgICAgICBzaG9wTG9jYXRpb24gPSBsb2NhdGlvbjtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5sb2NhdGlvbiA9IHNob3BMb2NhdGlvbjtcbiAgICB9XG5cbiAgICBjb25zdCByZWFkUHJpY2U6IChpOiBudW1iZXIpID0+IG51bWJlciA9XG4gICAgICAgIHJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3MgP1xuICAgICAgICAgICAgaSA9PiByb20ucHJnW3RoaXMucHJpY2VzQWRkcmVzcyArIGldIC8gMzIgOlxuICAgICAgICAgICAgaSA9PiByZWFkTGl0dGxlRW5kaWFuKHJvbS5wcmcsIHRoaXMucHJpY2VzQWRkcmVzcyArIDIgKiBpKTtcbiAgICB0aGlzLmNvbnRlbnRzID0gdHVwbGUocm9tLnByZywgdGhpcy5jb250ZW50c0FkZHJlc3MsIENPTlRFTlRTX0NPVU5UU1t0aGlzLnR5cGVdKTtcbiAgICB0aGlzLnByaWNlcyA9IHNlcShQUklDRVNfQ09VTlRTW3RoaXMudHlwZV0sIHJlYWRQcmljZSk7XG4gICAgdGhpcy51c2VkID0gdGhpcy5sb2NhdGlvbiAhPT0gMHhmZjtcbiAgfVxuXG4gIC8vIHByaXZhdGUgaXNOb3JtYWxpemVkKCk6IGJvb2xlYW4ge1xuICAvLyAgIHJldHVybiAhIXRoaXMucm9tLnNob3BEYXRhVGFibGVzQWRkcmVzcztcbiAgLy8gfVxuXG4gIGdldCBjb250ZW50c0FkZHJlc3MoKTogbnVtYmVyIHtcbiAgICBjb25zdCBiYXNlID0gQ09OVEVOVFNfQUREUkVTU0VTW3RoaXMudHlwZV0odGhpcy5yb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvbS5zaG9wQ291bnQpO1xuICAgIHJldHVybiBiYXNlICsgNCAqIHRoaXMuaW5kZXg7XG4gIH1cblxuICBnZXQgcHJpY2VzQWRkcmVzcygpOiBudW1iZXIge1xuICAgIGNvbnN0IHNob3BUYWJsZSA9IHRoaXMucm9tLnNob3BEYXRhVGFibGVzQWRkcmVzcztcbiAgICBjb25zdCBiYXNlID0gUFJJQ0VTX0FERFJFU1NFU1t0aGlzLnR5cGVdKHNob3BUYWJsZSwgdGhpcy5yb20uc2hvcENvdW50KTtcbiAgICByZXR1cm4gYmFzZSArIChzaG9wVGFibGUgPyAxIDogMikgKiBQUklDRVNfQ09VTlRTW3RoaXMudHlwZV0gKiB0aGlzLmluZGV4O1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIHNwYXducyBmb3IgdGhlIGdpdmVuIGxvY2F0aW9uIHRvIGluY2x1ZGUgYW4gYXBwcm9wcmlhdGVcbiAgICogc2hvcGtlZXBlci4gIFNob3VsZCBiZSBjYWxsZWQgYWZ0ZXIgY2hhbmdpbmcgbG9jYXRpb25zLlxuICAgKi9cbiAgdXBkYXRlU2hvcGtlZXBlcigpOiB2b2lkIHtcbiAgICAvLyBob3cgdG8gZGV0ZXJtaW5lIHNob3AgdHlwZT9cbiAgICAvLyAgIC0+IGxvb2sgYXQgbG9jYXRpb24ncyBzcGF3biBkYXRhIC0+IG9iamVjdCB0eXBlIDQsIGlkID0+IGRhdGEgJDYyMFxuICAgIC8vICAgICAgMjMgPSBwYXduLCAyMSA9IHRvb2xzLCAyMiA9IGlubiwgMjAgPSBhcm1vclxuICAgIC8vICAgcmV1c2UgdGhlIGdlbmVyaWMgb2JqZWN0cyA0MC4uNDMsIHJlcHVycG9zZSB0aGUgc3BlY2lhbCBvbmVzLlxuICAgIC8vICAgd2UgY2FuIGFsc28gbWFrZSBuZXcgb25lcyBhcyBuZWVkZWQgdXNpbmcgdGhlIHVudXNlZCBvYmplY3Qgc2xvdHNcbiAgICAvLyB3ZSBjb3VsZCBhbHRlcm5hdGl2ZWx5IG1ha2UgbG9jYXRpb24gYW5kL29yIHR5cGUgYSBnZXR0ZXIvc2V0dGVyIHBhaXJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpO1xuICB9XG59XG5cbmNvbnN0IFZBTklMTEFfU0hPUF9MT0NBVElPTlMgPSAweDIxZjU0O1xuY29uc3QgVkFOSUxMQV9TSE9QX0lORElDRVMgPSAweDIxZjc1O1xuY29uc3QgVkFOSUxMQV9BUk1PUl9TSE9QX0lURU1TID0gMHgyMWRhNDtcbmNvbnN0IFZBTklMTEFfQVJNT1JfU0hPUF9QUklDRVMgPSAweDIxZGQwO1xuY29uc3QgVkFOSUxMQV9UT09MX1NIT1BfSVRFTVMgPSAweDIxZTI4O1xuY29uc3QgVkFOSUxMQV9UT09MX1NIT1BfUFJJQ0VTID0gMHgyMWU1NDtcbmNvbnN0IFZBTklMTEFfSU5OX1BSSUNFUyA9IDB4MjFlYWM7XG5jb25zdCBWQU5JTExBX1BBV05fUFJJQ0VfVEFCTEUgPSAweDIxZWMyO1xuIl19