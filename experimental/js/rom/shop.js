import { Entity, EntityArray } from './entity.js';
import { readLittleEndian, seq, tuple } from './util.js';
export class Shops extends EntityArray {
    constructor(rom) {
        super(44);
        this.rom = rom;
        this.innBasePrice = 20;
        this.toolShopScaling = new Array(48).fill(0);
        this.armorShopScaling = new Array(48).fill(0);
        for (let i = 0; i < 44; i++) {
            this[i] = new Shop(rom, i);
        }
        if (rom.shopDataTablesAddress != null) {
            const address = rom.shopDataTablesAddress +
                21 * rom.shopCount +
                2 * rom.scalingLevels;
            this.basePrices = seq(0x49, id => id >= 0xd && id < 0x27 ?
                readLittleEndian(rom.prg, address + 2 * (id - 0xd)) :
                0);
        }
        else {
            this.basePrices =
                seq(0x49, id => readLittleEndian(rom.prg, VANILLA_PAWN_PRICE_TABLE + 2 * id) * 2);
        }
    }
    armorShops() {
        return seq(11, i => this[4 * i]);
    }
    toolShops() {
        return seq(11, i => this[4 * i + 1]);
    }
    inns() {
        return seq(11, i => this[4 * i + 2]);
    }
    pawnShops() {
        return seq(11, i => this[4 * i + 3]);
    }
    write() {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j;
        const a = this.rom.assembler();
        if (this.rescale) {
            function exportLabel(label) {
                a.export(label);
                a.label(label);
            }
            a.segment("10", "fe", "ff");
            a.reloc('ShopData');
            exportLabel('ShopData');
            exportLabel('ArmorShopIdTable');
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_a = shop.contents[i], (_a !== null && _a !== void 0 ? _a : 0xff)));
                }
            }
            exportLabel('ToolShopIdTable');
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_b = shop.contents[i], (_b !== null && _b !== void 0 ? _b : 0xff)));
                }
            }
            exportLabel('ArmorShopPriceTable');
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte(Math.round((_c = shop.prices[i], (_c !== null && _c !== void 0 ? _c : 0)) * 32));
                }
            }
            exportLabel('ToolShopPriceTable');
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte(Math.round((_d = shop.prices[i], (_d !== null && _d !== void 0 ? _d : 0)) * 32));
                }
            }
            exportLabel('InnPrices');
            for (const shop of this.inns()) {
                a.byte(Math.round((_e = shop.prices[0], (_e !== null && _e !== void 0 ? _e : 0)) * 32));
            }
            exportLabel('ShopLocations');
            for (const shop of this) {
                a.byte(shop.location);
            }
            exportLabel('ToolShopScaling');
            a.byte(...this.toolShopScaling);
            exportLabel('ArmorShopScaling');
            a.byte(...this.armorShopScaling);
            exportLabel('BasePrices');
            a.word(...this.basePrices.slice(0x0d, 0x27).map(x => (x !== null && x !== void 0 ? x : 0)));
            exportLabel('InnBasePrice');
            a.word(this.innBasePrice);
        }
        else {
            a.segment('10', 'fe', 'ff');
            a.reloc('ShopData');
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_f = shop.contents[i], (_f !== null && _f !== void 0 ? _f : 0xff)));
                }
            }
            for (const shop of this.armorShops()) {
                for (let i = 0; i < 4; i++) {
                    a.word((_g = shop.prices[i], (_g !== null && _g !== void 0 ? _g : 0)));
                }
            }
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.byte((_h = shop.contents[i], (_h !== null && _h !== void 0 ? _h : 0xff)));
                }
            }
            for (const shop of this.toolShops()) {
                for (let i = 0; i < 4; i++) {
                    a.word((_j = shop.prices[i], (_j !== null && _j !== void 0 ? _j : 0)));
                }
            }
        }
        return [a.module()];
    }
}
export var ShopType;
(function (ShopType) {
    ShopType[ShopType["ARMOR"] = 0] = "ARMOR";
    ShopType[ShopType["TOOL"] = 1] = "TOOL";
    ShopType[ShopType["INN"] = 2] = "INN";
    ShopType[ShopType["PAWN"] = 3] = "PAWN";
})(ShopType || (ShopType = {}));
const SHOP_TYPES = [ShopType.ARMOR, ShopType.TOOL, ShopType.INN, ShopType.PAWN];
const CONTENTS_ADDRESSES = [
    (base, count) => base ? base : VANILLA_ARMOR_SHOP_ITEMS,
    (base, count) => base ? base + 4 * count : VANILLA_TOOL_SHOP_ITEMS,
    (base, count) => 0,
    (base, count) => 0,
];
const CONTENTS_COUNTS = [4, 4, 0, 0];
const PRICES_ADDRESSES = [
    (base, count) => base ? base + 8 * count : VANILLA_ARMOR_SHOP_PRICES,
    (base, count) => base ? base + 12 * count : VANILLA_TOOL_SHOP_PRICES,
    (base, count) => base ? base + 16 * count : VANILLA_INN_PRICES,
    (base, count) => 0,
];
const PRICES_COUNTS = [4, 4, 1, 0];
export class Shop extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.type = SHOP_TYPES[id & 3];
        this.index = id >>> 2;
        if (rom.shopDataTablesAddress) {
            const base = rom.shopDataTablesAddress;
            const count = rom.shopCount;
            const locationTable = base + 17 * count;
            this.location = rom.prg[locationTable + id];
        }
        else {
            let shopLocation = 0xff;
            for (let i = 0; i < 33 && shopLocation === 0xff; i++) {
                if (rom.prg[VANILLA_SHOP_INDICES + i] !== this.index)
                    continue;
                const location = rom.prg[VANILLA_SHOP_LOCATIONS + i];
                for (const spawn of rom.locations[location].spawns) {
                    if (spawn.type !== 4)
                        continue;
                    const obj = rom.objects[spawn.id];
                    if (obj.data[25] === 0x20 + this.type) {
                        shopLocation = location;
                        break;
                    }
                }
            }
            this.location = shopLocation;
        }
        const readPrice = rom.shopDataTablesAddress ?
            i => rom.prg[this.pricesAddress + i] / 32 :
            i => readLittleEndian(rom.prg, this.pricesAddress + 2 * i);
        this.contents = tuple(rom.prg, this.contentsAddress, CONTENTS_COUNTS[this.type]);
        this.prices = seq(PRICES_COUNTS[this.type], readPrice);
        this.used = this.location !== 0xff;
    }
    get contentsAddress() {
        const base = CONTENTS_ADDRESSES[this.type](this.rom.shopDataTablesAddress, this.rom.shopCount);
        return base + 4 * this.index;
    }
    get pricesAddress() {
        const shopTable = this.rom.shopDataTablesAddress;
        const base = PRICES_ADDRESSES[this.type](shopTable, this.rom.shopCount);
        return base + (shopTable ? 1 : 2) * PRICES_COUNTS[this.type] * this.index;
    }
    updateShopkeeper() {
        throw new Error('not implemented');
    }
}
const VANILLA_SHOP_LOCATIONS = 0x21f54;
const VANILLA_SHOP_INDICES = 0x21f75;
const VANILLA_ARMOR_SHOP_ITEMS = 0x21da4;
const VANILLA_ARMOR_SHOP_PRICES = 0x21dd0;
const VANILLA_TOOL_SHOP_ITEMS = 0x21e28;
const VANILLA_TOOL_SHOP_PRICES = 0x21e54;
const VANILLA_INN_PRICES = 0x21eac;
const VANILLA_PAWN_PRICE_TABLE = 0x21ec2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vc2hvcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFdBQVcsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUd2RCxNQUFNLE9BQU8sS0FBTSxTQUFRLFdBQWlCO0lBUTFDLFlBQXFCLEdBQVE7UUFDM0IsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRFMsUUFBRyxHQUFILEdBQUcsQ0FBSztRQUw3QixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUNsQixvQkFBZSxHQUFhLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxxQkFBZ0IsR0FBYSxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFLakQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMzQixJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQzVCO1FBRUQsSUFBSSxHQUFHLENBQUMscUJBQXFCLElBQUksSUFBSSxFQUFFO1lBQ3JDLE1BQU0sT0FBTyxHQUNULEdBQUcsQ0FBQyxxQkFBcUI7Z0JBQ3pCLEVBQUUsR0FBRyxHQUFHLENBQUMsU0FBUztnQkFDbEIsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUM7WUFDMUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLEdBQUcsSUFBSSxFQUFFLEdBQUcsSUFBSSxD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QUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUM1RSxDQUFDO0lBTUQsZ0JBQWdCO1FBT2QsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7Q0FDRjtBQUVELE1BQU0sc0JBQXNCLEdBQUcsT0FBTyxDQUFDO0FBQ3ZDLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDO0FBQ3JDLE1BQU0sd0JBQXdCLEdBQUcsT0FBTyxDQUFDO0FBQ3pDLE1BQU0seUJBQXlCLEdBQUcsT0FBTyxDQUFDO0FBQzFDLE1BQU0sdUJBQXVCLEdBQUcsT0FBTyxDQUFDO0FBQ3hDLE1BQU0sd0JBQXdCLEdBQUcsT0FBTyxDQUFDO0FBQ3pDLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDO0FBQ25DLE1BQU0sd0JBQXdCLEdBQUcsT0FBTyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtNb2R1bGV9IGZyb20gJy4uL2FzbS9tb2R1bGUuanMnO1xuaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0VudGl0eSwgRW50aXR5QXJyYXl9IGZyb20gJy4vZW50aXR5LmpzJztcbmltcG9ydCB7cmVhZExpdHRsZUVuZGlhbiwgc2VxLCB0dXBsZX0gZnJvbSAnLi91dGlsLmpzJztcblxuXG5leHBvcnQgY2xhc3MgU2hvcHMgZXh0ZW5kcyBFbnRpdHlBcnJheTxTaG9wPiB7XG5cbiAgcmVzY2FsZT86IGJvb2xlYW47XG4gIGlubkJhc2VQcmljZSA9IDIwO1xuICB0b29sU2hvcFNjYWxpbmc6IG51bWJlcltdID0gbmV3IEFycmF5KDQ4KS5maWxsKDApO1xuICBhcm1vclNob3BTY2FsaW5nOiBudW1iZXJbXSA9IG5ldyBBcnJheSg0OCkuZmlsbCgwKTtcbiAgYmFzZVByaWNlczogbnVtYmVyW107XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICBzdXBlcig0NCk7IC8vIDQgKiByb20uc2hvcENvdW50KTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ0OyBpKyspIHtcbiAgICAgIHRoaXNbaV0gPSBuZXcgU2hvcChyb20sIGkpO1xuICAgIH1cblxuICAgIGlmIChyb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzICE9IG51bGwpIHtcbiAgICAgIGNvbnN0IGFkZHJlc3MgPVxuICAgICAgICAgIHJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3MgK1xuICAgICAgICAgIDIxICogcm9tLnNob3BDb3VudCArXG4gICAgICAgICAgMiAqIHJvbS5zY2FsaW5nTGV2ZWxzO1xuICAgICAgdGhpcy5iYXNlUHJpY2VzID0gc2VxKDB4NDksIGlkID0+IGlkID49IDB4ZCAmJiBpZCA8IDB4MjcgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRMaXR0bGVFbmRpYW4ocm9tLnByZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgKyAyICogKGlkIC0gMHhkKSkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJhc2VQcmljZXMgPVxuICAgICAgICAgIHNlcSgweDQ5LFxuICAgICAgICAgICAgICBpZCA9PiByZWFkTGl0dGxlRW5kaWFuKHJvbS5wcmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVkFOSUxMQV9QQVdOX1BSSUNFX1RBQkxFICsgMiAqIGlkKSAqIDIpO1xuICAgIH1cbiAgICBcbiAgfVxuXG4gIGFybW9yU2hvcHMoKTogU2hvcFtdIHtcbiAgICByZXR1cm4gc2VxKDExLCBpID0+IHRoaXNbNCAqIGldKTtcbiAgfVxuXG4gIHRvb2xTaG9wcygpOiBTaG9wW10ge1xuICAgIHJldHVybiBzZXEoMTEsIGkgPT4gdGhpc1s0ICogaSArIDFdKTtcbiAgfVxuXG4gIGlubnMoKTogU2hvcFtdIHtcbiAgICByZXR1cm4gc2VxKDExLCBpID0+IHRoaXNbNCAqIGkgKyAyXSk7XG4gIH1cblxuICBwYXduU2hvcHMoKTogU2hvcFtdIHtcbiAgICByZXR1cm4gc2VxKDExLCBpID0+IHRoaXNbNCAqIGkgKyAzXSk7XG4gIH1cblxuICB3cml0ZSgpOiBNb2R1bGVbXSB7XG4gICAgY29uc3QgYSA9IHRoaXMucm9tLmFzc2VtYmxlcigpO1xuICAgIGlmICh0aGlzLnJlc2NhbGUpIHtcbiAgICAgIGZ1bmN0aW9uIGV4cG9ydExhYmVsKGxhYmVsOiBzdHJpbmcpIHtcbiAgICAgICAgYS5leHBvcnQobGFiZWwpO1xuICAgICAgICBhLmxhYmVsKGxhYmVsKTtcbiAgICAgIH1cbiAgICAgIGEuc2VnbWVudChcIjEwXCIsIFwiZmVcIiwgXCJmZlwiKTtcbiAgICAgIGEucmVsb2MoJ1Nob3BEYXRhJyk7IC8vIFRPRE8gLSBicmVhayB0aGlzIHVwIGEgYml0P1xuICAgICAgLy8gTk9URTogVGhpcyBzdHJ1Y3R1cmUgaXMgaGFyZC1jb2RlZCBpbiBSb21PcHRpb24sIHdpdGggdHdvIHBhcmFtZXRlcnM6XG4gICAgICAvLyAgMS4gU0hPUF9DT1VOVCAoMTEpXG4gICAgICAvLyAgMi4gU0NBTElOR19MRVZFTFMgKDQ4KVxuICAgICAgLy8gIDMuIFBhd24gcHJpY2VzOiA1MiBieXRlcyAgIDsgMCA9ICQwZCwgNTAgPSAkMjYsIDUxID0gXCIkMjdcIiAoaW5uKVxuICAgICAgZXhwb3J0TGFiZWwoJ1Nob3BEYXRhJyk7XG4gICAgICBleHBvcnRMYWJlbCgnQXJtb3JTaG9wSWRUYWJsZScpO1xuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMuYXJtb3JTaG9wcygpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICAgICAgYS5ieXRlKHNob3AuY29udGVudHNbaV0gPz8gMHhmZik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGV4cG9ydExhYmVsKCdUb29sU2hvcElkVGFibGUnKTtcbiAgICAgIGZvciAoY29uc3Qgc2hvcCBvZiB0aGlzLnRvb2xTaG9wcygpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICAgICAgYS5ieXRlKHNob3AuY29udGVudHNbaV0gPz8gMHhmZik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGV4cG9ydExhYmVsKCdBcm1vclNob3BQcmljZVRhYmxlJyk7XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcy5hcm1vclNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLmJ5dGUoTWF0aC5yb3VuZCgoc2hvcC5wcmljZXNbaV0gPz8gMCkgKiAzMikpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBleHBvcnRMYWJlbCgnVG9vbFNob3BQcmljZVRhYmxlJyk7XG4gICAgICBmb3IgKGNvbnN0IHNob3Agb2YgdGhpcy50b29sU2hvcHMoKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICAgIGEuYnl0ZShNYXRoLnJvdW5kKChzaG9wLnByaWNlc1tpXSA/PyAwKSAqIDMyKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGV4cG9ydExhYmVsKCdJbm5QcmljZXMnKTtcbiAgICAgIGZvciAoY29uc3Qgc2hvcCBvZiB0aGlzLmlubnMoKSkge1xuICAgICAgICBhLmJ5dGUoTWF0aC5yb3VuZCgoc2hvcC5wcmljZXNbMF0gPz8gMCkgKiAzMikpO1xuICAgICAgfVxuICAgICAgZXhwb3J0TGFiZWwoJ1Nob3BMb2NhdGlvbnMnKTtcbiAgICAgIGZvciAoY29uc3Qgc2hvcCBvZiB0aGlzKSB7XG4gICAgICAgIGEuYnl0ZShzaG9wLmxvY2F0aW9uKTtcbiAgICAgIH1cbiAgICAgIGV4cG9ydExhYmVsKCdUb29sU2hvcFNjYWxpbmcnKTtcbiAgICAgIGEuYnl0ZSguLi50aGlzLnRvb2xTaG9wU2NhbGluZyk7XG4gICAgICBleHBvcnRMYWJlbCgnQXJtb3JTaG9wU2NhbGluZycpO1xuICAgICAgYS5ieXRlKC4uLnRoaXMuYXJtb3JTaG9wU2NhbGluZyk7XG4gICAgICBleHBvcnRMYWJlbCgnQmFzZVByaWNlcycpO1xuICAgICAgYS53b3JkKC4uLnRoaXMuYmFzZVByaWNlcy5zbGljZSgweDBkLCAweDI3KS5tYXAoeCA9PiB4ID8/IDApKTtcbiAgICAgIGV4cG9ydExhYmVsKCdJbm5CYXNlUHJpY2UnKTtcbiAgICAgIGEud29yZCh0aGlzLmlubkJhc2VQcmljZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRPRE8gLSBjYW4gd2UgZXZlbiB3cml0ZSBub24tZGVmcmFnZ2VkIHNob3BzP1xuICAgICAgYS5zZWdtZW50KCcxMCcsICdmZScsICdmZicpO1xuICAgICAgYS5yZWxvYygnU2hvcERhdGEnKTsgLy9hLm9yZygweDlkYTQpO1xuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMuYXJtb3JTaG9wcygpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICAgICAgYS5ieXRlKHNob3AuY29udGVudHNbaV0gPz8gMHhmZik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3Qgc2hvcCBvZiB0aGlzLmFybW9yU2hvcHMoKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgICAgIGEud29yZChzaG9wLnByaWNlc1tpXSA/PyAwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMudG9vbFNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLmJ5dGUoc2hvcC5jb250ZW50c1tpXSA/PyAweGZmKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBzaG9wIG9mIHRoaXMudG9vbFNob3BzKCkpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgICBhLndvcmQoc2hvcC5wcmljZXNbaV0gPz8gMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFthLm1vZHVsZSgpXTtcbiAgfVxufVxuXG5cbi8vIFNob3BzIGFyZSBzdHJpcGVkOiB0b29sLCBhcm1vciwgaW5uLCBwYXduXG4vLyBTbyB0aGUgdG9vbCBzaG9wcyBoYXZlIElEIDAsIDQsIDgsIC4uLiwgNDA7IGV0Y1xuZXhwb3J0IGVudW0gU2hvcFR5cGUge1xuICBBUk1PUiA9IDAsXG4gIFRPT0wgPSAxLFxuICBJTk4gPSAyLFxuICBQQVdOID0gMyxcbn1cblxuY29uc3QgU0hPUF9UWVBFUyA9IFtTaG9wVHlwZS5BUk1PUiwgU2hvcFR5cGUuVE9PTCwgU2hvcFR5cGUuSU5OLCBTaG9wVHlwZS5QQVdOXTtcblxuY29uc3QgQ09OVEVOVFNfQUREUkVTU0VTOiAoKGJhc2U6IG51bWJlciwgY291bnQ6IG51bWJlcikgPT4gbnVtYmVyKVtdID0gW1xuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlIDogVkFOSUxMQV9BUk1PUl9TSE9QX0lURU1TLFxuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlICsgNCAqIGNvdW50IDogVkFOSUxMQV9UT09MX1NIT1BfSVRFTVMsXG4gIChiYXNlLCBjb3VudCkgPT4gMCxcbiAgKGJhc2UsIGNvdW50KSA9PiAwLFxuXTtcblxuY29uc3QgQ09OVEVOVFNfQ09VTlRTID0gWzQsIDQsIDAsIDBdO1xuXG5jb25zdCBQUklDRVNfQUREUkVTU0VTOiAoKGJhc2U6IG51bWJlciwgY291bnQ6IG51bWJlcikgPT4gbnVtYmVyKVtdID0gW1xuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlICsgOCAqIGNvdW50IDogVkFOSUxMQV9BUk1PUl9TSE9QX1BSSUNFUyxcbiAgKGJhc2UsIGNvdW50KSA9PiBiYXNlID8gYmFzZSArIDEyICogY291bnQgOiBWQU5JTExBX1RPT0xfU0hPUF9QUklDRVMsXG4gIChiYXNlLCBjb3VudCkgPT4gYmFzZSA/IGJhc2UgKyAxNiAqIGNvdW50IDogVkFOSUxMQV9JTk5fUFJJQ0VTLFxuICAoYmFzZSwgY291bnQpID0+IDAsXG5dO1xuXG5jb25zdCBQUklDRVNfQ09VTlRTID0gWzQsIDQsIDEsIDBdO1xuXG5leHBvcnQgY2xhc3MgU2hvcCBleHRlbmRzIEVudGl0eSB7XG5cbiAgcmVhZG9ubHkgdXNlZDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgbG9jYXRpb246IG51bWJlcjtcbiAgcmVhZG9ubHkgaW5kZXg6IG51bWJlcjtcbiAgcmVhZG9ubHkgdHlwZTogU2hvcFR5cGU7XG5cbiAgLy8gTGlzdCBvZiB1cCB0byA0IGl0ZW0gSURzIGJlaW5nIHNvbGQgYXQgdGhpcyBzaG9wLlxuICBjb250ZW50czogbnVtYmVyW107XG5cbiAgLy8gTWVhbmluZyBkZXBlbmRzIG9uIHdoZXRoZXIgc2hvcHMgYXJlIG5vcm1hbGl6ZWQuICBJZiBzbyB0aGVuIHRoaXMgaXNcbiAgLy8gdGhlIGFkanVzdG1lbnQgZnJvbSB0aGUgYmFzZSBwcmljZSwgYXMgYSBmcmFjdGlvbi4gIElmIG5vdCB0aGVuIHRoaXNcbiAgLy8gaXMganVzdCB0aGUgMTYtYml0IHByaWNlLlxuICBwcmljZXM6IG51bWJlcltdO1xuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tLCBpZDogbnVtYmVyKSB7XG4gICAgc3VwZXIocm9tLCBpZCk7XG5cbiAgICB0aGlzLnR5cGUgPSBTSE9QX1RZUEVTW2lkICYgM107XG4gICAgdGhpcy5pbmRleCA9IGlkID4+PiAyO1xuXG4gICAgaWYgKHJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3MpIHtcbiAgICAgIC8vIE5vcm1hbGl6ZWQgcHJpY2VzIC0gY29uc3RydWN0IHRoZSB0YWJsZSBsb2NhdGlvbnNcbiAgICAgIGNvbnN0IGJhc2UgPSByb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzO1xuICAgICAgY29uc3QgY291bnQgPSByb20uc2hvcENvdW50O1xuICAgICAgY29uc3QgbG9jYXRpb25UYWJsZSA9IGJhc2UgKyAxNyAqIGNvdW50O1xuICAgICAgdGhpcy5sb2NhdGlvbiA9IHJvbS5wcmdbbG9jYXRpb25UYWJsZSArIGlkXTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVmFuaWxsYSBzaG9wczogbmVlZCB0byBkbyBhIG1vcmUgaW52b2x2ZWQgc2VhcmNoIGZvciBzaG9wIGxvY2F0aW9uLlxuICAgICAgbGV0IHNob3BMb2NhdGlvbiA9IDB4ZmY7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDMzICYmIHNob3BMb2NhdGlvbiA9PT0gMHhmZjsgaSsrKSB7XG4gICAgICAgIGlmIChyb20ucHJnW1ZBTklMTEFfU0hPUF9JTkRJQ0VTICsgaV0gIT09IHRoaXMuaW5kZXgpIGNvbnRpbnVlO1xuICAgICAgICBjb25zdCBsb2NhdGlvbiA9IHJvbS5wcmdbVkFOSUxMQV9TSE9QX0xPQ0FUSU9OUyArIGldO1xuICAgICAgICBmb3IgKGNvbnN0IHNwYXduIG9mIHJvbS5sb2NhdGlvbnNbbG9jYXRpb25dLnNwYXducykge1xuICAgICAgICAgIGlmIChzcGF3bi50eXBlICE9PSA0KSBjb250aW51ZTtcbiAgICAgICAgICBjb25zdCBvYmogPSByb20ub2JqZWN0c1tzcGF3bi5pZF07XG4gICAgICAgICAgaWYgKG9iai5kYXRhWzI1XSA9PT0gMHgyMCArIHRoaXMudHlwZSkge1xuICAgICAgICAgICAgc2hvcExvY2F0aW9uID0gbG9jYXRpb247XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMubG9jYXRpb24gPSBzaG9wTG9jYXRpb247XG4gICAgfVxuXG4gICAgY29uc3QgcmVhZFByaWNlOiAoaTogbnVtYmVyKSA9PiBudW1iZXIgPVxuICAgICAgICByb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzID9cbiAgICAgICAgICAgIGkgPT4gcm9tLnByZ1t0aGlzLnByaWNlc0FkZHJlc3MgKyBpXSAvIDMyIDpcbiAgICAgICAgICAgIGkgPT4gcmVhZExpdHRsZUVuZGlhbihyb20ucHJnLCB0aGlzLnByaWNlc0FkZHJlc3MgKyAyICogaSk7XG4gICAgdGhpcy5jb250ZW50cyA9IHR1cGxlKHJvbS5wcmcsIHRoaXMuY29udGVudHNBZGRyZXNzLCBDT05URU5UU19DT1VOVFNbdGhpcy50eXBlXSk7XG4gICAgdGhpcy5wcmljZXMgPSBzZXEoUFJJQ0VTX0NPVU5UU1t0aGlzLnR5cGVdLCByZWFkUHJpY2UpO1xuICAgIHRoaXMudXNlZCA9IHRoaXMubG9jYXRpb24gIT09IDB4ZmY7XG4gIH1cblxuICAvLyBwcml2YXRlIGlzTm9ybWFsaXplZCgpOiBib29sZWFuIHtcbiAgLy8gICByZXR1cm4gISF0aGlzLnJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3M7XG4gIC8vIH1cblxuICBnZXQgY29udGVudHNBZGRyZXNzKCk6IG51bWJlciB7XG4gICAgY29uc3QgYmFzZSA9IENPTlRFTlRTX0FERFJFU1NFU1t0aGlzLnR5cGVdKHRoaXMucm9tLnNob3BEYXRhVGFibGVzQWRkcmVzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb20uc2hvcENvdW50KTtcbiAgICByZXR1cm4gYmFzZSArIDQgKiB0aGlzLmluZGV4O1xuICB9XG5cbiAgZ2V0IHByaWNlc0FkZHJlc3MoKTogbnVtYmVyIHtcbiAgICBjb25zdCBzaG9wVGFibGUgPSB0aGlzLnJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3M7XG4gICAgY29uc3QgYmFzZSA9IFBSSUNFU19BRERSRVNTRVNbdGhpcy50eXBlXShzaG9wVGFibGUsIHRoaXMucm9tLnNob3BDb3VudCk7XG4gICAgcmV0dXJuIGJhc2UgKyAoc2hvcFRhYmxlID8gMSA6IDIpICogUFJJQ0VTX0NPVU5UU1t0aGlzLnR5cGVdICogdGhpcy5pbmRleDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSBzcGF3bnMgZm9yIHRoZSBnaXZlbiBsb2NhdGlvbiB0byBpbmNsdWRlIGFuIGFwcHJvcHJpYXRlXG4gICAqIHNob3BrZWVwZXIuICBTaG91bGQgYmUgY2FsbGVkIGFmdGVyIGNoYW5naW5nIGxvY2F0aW9ucy5cbiAgICovXG4gIHVwZGF0ZVNob3BrZWVwZXIoKTogdm9pZCB7XG4gICAgLy8gaG93IHRvIGRldGVybWluZSBzaG9wIHR5cGU/XG4gICAgLy8gICAtPiBsb29rIGF0IGxvY2F0aW9uJ3Mgc3Bhd24gZGF0YSAtPiBvYmplY3QgdHlwZSA0LCBpZCA9PiBkYXRhICQ2MjBcbiAgICAvLyAgICAgIDIzID0gcGF3biwgMjEgPSB0b29scywgMjIgPSBpbm4sIDIwID0gYXJtb3JcbiAgICAvLyAgIHJldXNlIHRoZSBnZW5lcmljIG9iamVjdHMgNDAuLjQzLCByZXB1cnBvc2UgdGhlIHNwZWNpYWwgb25lcy5cbiAgICAvLyAgIHdlIGNhbiBhbHNvIG1ha2UgbmV3IG9uZXMgYXMgbmVlZGVkIHVzaW5nIHRoZSB1bnVzZWQgb2JqZWN0IHNsb3RzXG4gICAgLy8gd2UgY291bGQgYWx0ZXJuYXRpdmVseSBtYWtlIGxvY2F0aW9uIGFuZC9vciB0eXBlIGEgZ2V0dGVyL3NldHRlciBwYWlyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdub3QgaW1wbGVtZW50ZWQnKTtcbiAgfVxufVxuXG5jb25zdCBWQU5JTExBX1NIT1BfTE9DQVRJT05TID0gMHgyMWY1NDtcbmNvbnN0IFZBTklMTEFfU0hPUF9JTkRJQ0VTID0gMHgyMWY3NTtcbmNvbnN0IFZBTklMTEFfQVJNT1JfU0hPUF9JVEVNUyA9IDB4MjFkYTQ7XG5jb25zdCBWQU5JTExBX0FSTU9SX1NIT1BfUFJJQ0VTID0gMHgyMWRkMDtcbmNvbnN0IFZBTklMTEFfVE9PTF9TSE9QX0lURU1TID0gMHgyMWUyODtcbmNvbnN0IFZBTklMTEFfVE9PTF9TSE9QX1BSSUNFUyA9IDB4MjFlNTQ7XG5jb25zdCBWQU5JTExBX0lOTl9QUklDRVMgPSAweDIxZWFjO1xuY29uc3QgVkFOSUxMQV9QQVdOX1BSSUNFX1RBQkxFID0gMHgyMWVjMjtcbiJdfQ==