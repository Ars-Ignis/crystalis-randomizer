import { Entity } from './entity.js';
import { readLittleEndian } from './util.js';
export class ObjectData extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.used = true;
        this.name = '';
        this.base = readLittleEndian(rom.prg, this.pointer) + 0x10000;
        this.sfx = rom.prg[this.base];
        this.data = [];
        let a = this.base + 1;
        let m = 0;
        for (let i = 0; i < 32; i++) {
            if (!(i & 7)) {
                m = rom.prg[a++];
            }
            this.data.push(m & 0x80 ? rom.prg[a++] : 0);
            m <<= 1;
        }
    }
    get pointer() {
        return 0x1ac00 + (this.id << 1);
    }
    serialize() {
        const out = [this.sfx];
        for (let i = 0; i < 4; i++) {
            const k = out.length;
            out.push(0);
            for (let j = 0; j < 8; j++) {
                if (this.data[8 * i + j]) {
                    out[k] |= (0x80 >>> j);
                    out.push(this.data[8 * i + j]);
                }
            }
        }
        return out;
    }
    write() {
        const a = this.rom.assembler();
        a.segment('0d');
        a.reloc(`Object_${this.id.toString(16).padStart(2, '0')}`);
        const label = a.pc();
        a.byte(...this.serialize());
        a.org(0xac00 + (this.id << 1));
        a.word(label);
        return [a.module()];
    }
    get(addr) {
        return this.data[(addr - 0x300) >>> 5];
    }
    parents() {
        return [];
    }
    locations() {
        return this.rom.locations.filter((l) => l.used && l.spawns.some(spawn => spawn.isMonster() && spawn.monsterId === this.id));
    }
    palettes(includeChildren = false) {
        if (this.action === 0x22)
            return [3];
        let metaspriteId = this.data[0];
        if (this.action === 0x2a)
            metaspriteId = this.data[31] | 1;
        if (this.action === 0x29)
            metaspriteId = 0x6b;
        if (this.action === 0x26)
            metaspriteId = 0x9c;
        const ms = this.rom.metasprites[metaspriteId];
        const childMs = includeChildren && this.child ?
            this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]] :
            null;
        const s = new Set([...ms.palettes(), ...(childMs ? childMs.palettes() : [])]);
        return [...s];
    }
    isVulnerable(element) {
        return !(this.elements & (1 << element));
    }
    isShadow() {
        return this.id === 0x7b || this.id === 0x8c;
    }
    get metasprite() { return METASPRITE.get(this.data); }
    set metasprite(x) { METASPRITE.set(this.data, x); }
    get speed() { return SPEED.get(this.data); }
    set speed(x) { SPEED.set(this.data, x); }
    get collisionPlane() { return COLLISION_PLANE.get(this.data); }
    set collisionPlane(x) { COLLISION_PLANE.set(this.data, x); }
    get hitbox() { return HITBOX.get(this.data); }
    set hitbox(x) { HITBOX.set(this.data, x); }
    get hp() { return HP.get(this.data); }
    set hp(x) { HP.set(this.data, x); }
    get atk() { return ATK.get(this.data); }
    set atk(x) { ATK.set(this.data, x); }
    get def() { return DEF.get(this.data); }
    set def(x) { DEF.set(this.data, x); }
    get level() { return LEVEL.get(this.data); }
    set level(x) { LEVEL.set(this.data, x); }
    get poison() { return !!POISON.get(this.data); }
    set poison(x) { POISON.set(this.data, x ? 1 : 0); }
    get child() { return CHILD.get(this.data); }
    set child(x) { CHILD.set(this.data, x); }
    get terrainSusceptibility() { return TERRAIN_SUSCEPTIBILITY.get(this.data); }
    set terrainSusceptibility(x) { TERRAIN_SUSCEPTIBILITY.set(this.data, x); }
    get immobile() { return !!IMMOBILE.get(this.data); }
    set immobile(x) { IMMOBILE.set(this.data, x ? 1 : 0); }
    get action() { return ACTION.get(this.data); }
    set action(x) { ACTION.set(this.data, x); }
    get replacement() { return REPLACEMENT.get(this.data); }
    set replacement(x) { REPLACEMENT.set(this.data, x); }
    get goldDrop() { return GOLD_DROP.get(this.data); }
    set goldDrop(x) { GOLD_DROP.set(this.data, x); }
    get elements() { return ELEMENTS.get(this.data); }
    set elements(x) { ELEMENTS.set(this.data, x); }
    get expReward() { return EXP_REWARD.get(this.data); }
    set expReward(x) { EXP_REWARD.set(this.data, x); }
    get attackType() { return ATTACK_TYPE.get(this.data); }
    set attackType(x) { ATTACK_TYPE.set(this.data, x); }
    get statusEffect() { return STATUS_EFFECT.get(this.data); }
    set statusEffect(x) { STATUS_EFFECT.set(this.data, x); }
}
function prop(...spec) {
    return new Stat(...spec);
}
class Stat {
    constructor(...spec) {
        this.spec = spec;
    }
    get(data) {
        let value = 0;
        for (const [addr, mask = 0xff, shift = 0] of this.spec) {
            const index = (addr - 0x300) >>> 5;
            const lsh = shift < 0 ? -shift : 0;
            const rsh = shift < 0 ? 0 : shift;
            value |= ((data[index] & mask) >>> rsh) << lsh;
        }
        return value;
    }
    set(data, value) {
        for (const [addr, mask = 0xff, shift = 0] of this.spec) {
            const index = (addr - 0x300) >>> 5;
            const lsh = shift < 0 ? -shift : 0;
            const rsh = shift < 0 ? 0 : shift;
            const v = (value >>> lsh) << rsh & mask;
            data[index] = data[index] & ~mask | v;
        }
    }
}
const METASPRITE = prop([0x300]);
const SPEED = prop([0x340, 0xf]);
const COLLISION_PLANE = prop([0x3a0, 0xf0, 4]);
const HITBOX = prop([0x420, 0x40, 2], [0x3a0, 0x0f]);
const HP = prop([0x3c0]);
const ATK = prop([0x3e0]);
const DEF = prop([0x400]);
const LEVEL = prop([0x420, 0x1f]);
const POISON = prop([0x420, 0x80, 7]);
const CHILD = prop([0x440]);
const TERRAIN_SUSCEPTIBILITY = prop([0x460]);
const IMMOBILE = prop([0x4a0, 0x80, 7]);
const ACTION = prop([0x4a0, 0x7f]);
const REPLACEMENT = prop([0x4c0]);
const GOLD_DROP = prop([0x500, 0xf0, 4]);
const ELEMENTS = prop([0x500, 0xf]);
const EXP_REWARD = prop([0x520]);
const ATTACK_TYPE = prop([0x540]);
const STATUS_EFFECT = prop([0x560, 0xf]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0ZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vb2JqZWN0ZGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBRW5DLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUczQyxNQUFNLE9BQU8sVUFBVyxTQUFRLE1BQU07SUFVcEMsWUFBWSxHQUFRLEVBQUUsRUFBVTtRQUM5QixLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2YsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsSUFBSSxHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUM5RCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7UUFDdEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1YsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMzQixJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQ1osQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUNsQjtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdB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LElBQUksQ0FBQztJQUM5QyxDQUFDO0lBRUQsSUFBSSxVQUFVLEtBQWEsT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUQsSUFBSSxVQUFVLENBQUMsQ0FBUyxJQUFJLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFM0QsSUFBSSxLQUFLLEtBQWEsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsSUFBSSxLQUFLLENBQUMsQ0FBUyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFakQsSUFBSSxjQUFjLEtBQWEsT0FBTyxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdkUsSUFBSSxjQUFjLENBQUMsQ0FBUyxJQUFJLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFcEUsSUFBSSxNQUFNLEtBQWEsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdEQsSUFBSSxNQUFNLENBQUMsQ0FBUyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFbkQsSUFBSSxFQUFFLEtBQWEsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUMsSUFBSSxFQUFFLENBQUMsQ0FBUyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFM0MsSUFBSSxHQUFHLEtBQWEsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEQsSUFBSSxHQUFHLENBQUMsQ0FBUyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFN0MsSUFBSSxHQUFHLEtBQWEsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEQsSUFBSSxHQUFHLENBQUMsQ0FBUyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFN0MsSUFBSSxLQUFLLEtBQWEsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsSUFBSSxLQUFLLENBQUMsQ0FBUyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFakQsSUFBSSxNQUFNLEtBQWMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pELElBQUksTUFBTSxDQUFDLENBQVUsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU1RCxJQUFJLEtBQUssS0FBYSxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwRCxJQUFJLEtBQUssQ0FBQyxDQUFTLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJ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QUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDN0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3hDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ25DLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDbEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3BDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDakMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUNsQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7TW9kdWxlfSBmcm9tICcuLi9hc20vbW9kdWxlLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtFbnRpdHl9IGZyb20gJy4vZW50aXR5LmpzJztcbmltcG9ydCB7TG9jYXRpb259IGZyb20gJy4vbG9jYXRpb24uanMnO1xuaW1wb3J0IHtyZWFkTGl0dGxlRW5kaWFufSBmcm9tICcuL3V0aWwuanMnO1xuXG4vLyBOT1RFOiBXb3VsZCBiZSBuaWNlIHRvIGNhbGwgdGhpcyBPYmplY3QsIGJ1dCB0aGF0IHNlZW1zIGNvbmZ1c2luZy4uLlxuZXhwb3J0IGNsYXNzIE9iamVjdERhdGEgZXh0ZW5kcyBFbnRpdHkge1xuXG4gIHVzZWQ6IGJvb2xlYW47XG4gIG5hbWU6IHN0cmluZztcblxuICBiYXNlOiBudW1iZXI7XG5cbiAgc2Z4OiBudW1iZXI7XG4gIGRhdGE6IG51bWJlcltdO1xuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tLCBpZDogbnVtYmVyKSB7XG4gICAgc3VwZXIocm9tLCBpZCk7XG4gICAgdGhpcy51c2VkID0gdHJ1ZTtcbiAgICB0aGlzLm5hbWUgPSAnJztcbiAgICB0aGlzLmJhc2UgPSByZWFkTGl0dGxlRW5kaWFuKHJvbS5wcmcsIHRoaXMucG9pbnRlcikgKyAweDEwMDAwO1xuICAgIHRoaXMuc2Z4ID0gcm9tLnByZ1t0aGlzLmJhc2VdO1xuICAgIHRoaXMuZGF0YSA9IFtdO1xuICAgIGxldCBhID0gdGhpcy5iYXNlICsgMTtcbiAgICBsZXQgbSA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzMjsgaSsrKSB7XG4gICAgICBpZiAoIShpICYgNykpIHtcbiAgICAgICAgbSA9IHJvbS5wcmdbYSsrXTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZGF0YS5wdXNoKG0gJiAweDgwID8gcm9tLnByZ1thKytdIDogMCk7XG4gICAgICBtIDw8PSAxO1xuICAgIH1cbiAgfVxuXG4gIGdldCBwb2ludGVyKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIDB4MWFjMDAgKyAodGhpcy5pZCA8PCAxKTtcbiAgfVxuXG4gIC8vIFJldHVybnMgYSBieXRlIGFycmF5IGZvciB0aGlzIGVudHJ5XG4gIHNlcmlhbGl6ZSgpOiBudW1iZXJbXSB7XG4gICAgY29uc3Qgb3V0ID0gW3RoaXMuc2Z4XTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgY29uc3QgayA9IG91dC5sZW5ndGg7XG4gICAgICBvdXQucHVzaCgwKTtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgODsgaisrKSB7XG4gICAgICAgIGlmICh0aGlzLmRhdGFbOCAqIGkgKyBqXSkge1xuICAgICAgICAgIG91dFtrXSB8PSAoMHg4MCA+Pj4gaik7XG4gICAgICAgICAgb3V0LnB1c2godGhpcy5kYXRhWzggKiBpICsgal0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICB3cml0ZSgpOiBNb2R1bGVbXSB7XG4gICAgY29uc3QgYSA9IHRoaXMucm9tLmFzc2VtYmxlcigpO1xuICAgIGEuc2VnbWVudCgnMGQnKTtcbiAgICBhLnJlbG9jKGBPYmplY3RfJHt0aGlzLmlkLnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCAnMCcpfWApO1xuICAgIGNvbnN0IGxhYmVsID0gYS5wYygpO1xuICAgIGEuYnl0ZSguLi50aGlzLnNlcmlhbGl6ZSgpKTtcbiAgICBhLm9yZygweGFjMDAgKyAodGhpcy5pZCA8PCAxKSk7XG4gICAgYS53b3JkKGxhYmVsKTtcbiAgICByZXR1cm4gW2EubW9kdWxlKCldO1xuICB9XG5cbiAgZ2V0KGFkZHI6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YVsoYWRkciAtIDB4MzAwKSA+Pj4gNV07XG4gIH1cblxuICBwYXJlbnRzKCk6IE9iamVjdERhdGFbXSB7XG4gICAgLy8gSWYgdGhpcyBpcyBhIHByb2plY3RpbGUgdGhhdCBpcyB0aGUgcGFyZW50IG9mIHNvbWUgbW9uc3RlcixcbiAgICAvLyByZXR1cm4gYW4gYXJyYXkgb2YgcGFyZW50cyB0aGF0IHNwYXduZWQgaXQuXG4gICAgcmV0dXJuIFtdO1xuICAgIC8vIHJldHVybiB0aGlzLnJvbS5tb25zdGVycy5maWx0ZXIoXG4gICAgLy8gICAgIChtOiBPYmplY3REYXRhKSA9PiBtLmNoaWxkICYmXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvbS5hZEhvY1NwYXduc1ttLmNoaWxkXS5vYmplY3RJZCA9PT0gdGhpcy5pZCk7XG4gIH1cblxuICBsb2NhdGlvbnMoKTogTG9jYXRpb25bXSB7XG4gICAgLy8gVE9ETyAtIGhhbmRsZSBub24tbW9uc3RlciBOUENzLlxuICAgIHJldHVybiB0aGlzLnJvbS5sb2NhdGlvbnMuZmlsdGVyKChsOiBMb2NhdGlvbikgPT5cbiAgICAgICAgbC51c2VkICYmIGwuc3Bhd25zLnNvbWUoc3Bhd24gPT5cbiAgICAgICAgICAgIHNwYXduLmlzTW9uc3RlcigpICYmIHNwYXduLm1vbnN0ZXJJZCA9PT0gdGhpcy5pZCkpO1xuICB9XG5cbiAgcGFsZXR0ZXMoaW5jbHVkZUNoaWxkcmVuID0gZmFsc2UpOiBudW1iZXJbXSB7XG4gICAgLy8gTk9URTogdGhpcyBnZXRzIHRoZSB3cm9uZyByZXN1bHQgZm9yIGljZS9zYW5kIHpvbWJpZXMgYW5kIGJsb2JzLlxuICAgIC8vICAtIG1heSBqdXN0IG5lZWQgdG8gZ3Vlc3MvYXNzdW1lIGFuZCBleHBlcmltZW50P1xuICAgIC8vICAtIHpvbWJpZXMgKGFjdGlvbiAweDIyKSBsb29rIGxpa2Ugc2hvdWxkIGp1c3QgYmUgM1xuICAgIC8vICAtIGxhdmFtZW4vYmxvYnMgKGFjdGlvbiAweDI5KSBhcmUgMlxuICAgIC8vICAtIHdyYWl0aCBzaGFkb3dzIChhY3Rpb24gMHgyNikgYXJlIDNcbiAgICBpZiAodGhpcy5hY3Rpb24gPT09IDB4MjIpIHJldHVybiBbM107IC8vIHpvbWJpZVxuICAgIGxldCBtZXRhc3ByaXRlSWQgPSB0aGlzLmRhdGFbMF07XG4gICAgaWYgKHRoaXMuYWN0aW9uID09PSAweDJhKSBtZXRhc3ByaXRlSWQgPSB0aGlzLmRhdGFbMzFdIHwgMTtcbiAgICBpZiAodGhpcy5hY3Rpb24gPT09IDB4MjkpIG1ldGFzcHJpdGVJZCA9IDB4NmI7IC8vIGJsb2JcbiAgICBpZiAodGhpcy5hY3Rpb24gPT09IDB4MjYpIG1ldGFzcHJpdGVJZCA9IDB4OWM7XG5cbiAgICBjb25zdCBtcyA9IHRoaXMucm9tLm1ldGFzcHJpdGVzW21ldGFzcHJpdGVJZF07XG4gICAgY29uc3QgY2hpbGRNcyA9XG4gICAgICAgIGluY2x1ZGVDaGlsZHJlbiAmJiB0aGlzLmNoaWxkID9cbiAgICAgICAgICAgIHRoaXMucm9tLm1ldGFzcHJpdGVzW1xuICAgICAgICAgICAgICAgIHRoaXMucm9tLm9iamVjdHNbXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucm9tLmFkSG9jU3Bhd25zW3RoaXMuY2hpbGRdLm9iamVjdElkXS5kYXRhWzBdXSA6XG4gICAgICAgICAgICBudWxsO1xuICAgIGNvbnN0IHMgPSBuZXcgU2V0KFsuLi5tcy5wYWxldHRlcygpLCAuLi4oY2hpbGRNcyA/IGNoaWxkTXMucGFsZXR0ZXMoKSA6IFtdKV0pO1xuICAgIHJldHVybiBbLi4uc107XG4gIH1cblxuICAvLyAwIGZvciB3aW5kLCAxIGZvciBmaXJlLCAyIGZvciB3YXRlciwgMyBmb3IgdGh1bmRlclxuICBpc1Z1bG5lcmFibGUoZWxlbWVudDogbnVtYmVyKSB7XG4gICAgcmV0dXJuICEodGhpcy5lbGVtZW50cyAmICgxIDw8IGVsZW1lbnQpKTtcbiAgfVxuXG4gIGlzU2hhZG93KCkge1xuICAgIC8vIE5PVEU6IGludGVybmFsbHkgdGhlIGdhbWUgY2hlY2tzIHRoYXQgdGhlIG1ldGFzcHJpdGVcbiAgICAvLyBpcyAkYTcgKHNlZSAkMzUwZjMpLCBidXQgd2UnbGwganVzdCBoYXJkY29kZS5cbiAgICByZXR1cm4gdGhpcy5pZCA9PT0gMHg3YiB8fCB0aGlzLmlkID09PSAweDhjO1xuICB9XG5cbiAgZ2V0IG1ldGFzcHJpdGUoKTogbnVtYmVyIHsgcmV0dXJuIE1FVEFTUFJJVEUuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IG1ldGFzcHJpdGUoeDogbnVtYmVyKSB7IE1FVEFTUFJJVEUuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgc3BlZWQoKTogbnVtYmVyIHsgcmV0dXJuIFNQRUVELmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBzcGVlZCh4OiBudW1iZXIpIHsgU1BFRUQuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgY29sbGlzaW9uUGxhbmUoKTogbnVtYmVyIHsgcmV0dXJuIENPTExJU0lPTl9QTEFORS5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgY29sbGlzaW9uUGxhbmUoeDogbnVtYmVyKSB7IENPTExJU0lPTl9QTEFORS5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBoaXRib3goKTogbnVtYmVyIHsgcmV0dXJuIEhJVEJPWC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgaGl0Ym94KHg6IG51bWJlcikgeyBISVRCT1guc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgaHAoKTogbnVtYmVyIHsgcmV0dXJuIEhQLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBocCh4OiBudW1iZXIpIHsgSFAuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgYXRrKCk6IG51bWJlciB7IHJldHVybiBBVEsuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGF0ayh4OiBudW1iZXIpIHsgQVRLLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGRlZigpOiBudW1iZXIgeyByZXR1cm4gREVGLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBkZWYoeDogbnVtYmVyKSB7IERFRi5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBsZXZlbCgpOiBudW1iZXIgeyByZXR1cm4gTEVWRUwuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGxldmVsKHg6IG51bWJlcikgeyBMRVZFTC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBwb2lzb24oKTogYm9vbGVhbiB7IHJldHVybiAhIVBPSVNPTi5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgcG9pc29uKHg6IGJvb2xlYW4pIHsgUE9JU09OLnNldCh0aGlzLmRhdGEsIHggPyAxIDogMCk7IH1cblxuICBnZXQgY2hpbGQoKTogbnVtYmVyIHsgcmV0dXJuIENISUxELmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBjaGlsZCh4OiBudW1iZXIpIHsgQ0hJTEQuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgdGVycmFpblN1c2NlcHRpYmlsaXR5KCk6IG51bWJlciB7IHJldHVybiBURVJSQUlOX1NVU0NFUFRJQklMSVRZLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCB0ZXJyYWluU3VzY2VwdGliaWxpdHkoeDogbnVtYmVyKSB7IFRFUlJBSU5fU1VTQ0VQVElCSUxJVFkuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgaW1tb2JpbGUoKTogYm9vbGVhbiB7IHJldHVybiAhIUlNTU9CSUxFLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBpbW1vYmlsZSh4OiBib29sZWFuKSB7IElNTU9CSUxFLnNldCh0aGlzLmRhdGEsIHggPyAxIDogMCk7IH1cblxuICBnZXQgYWN0aW9uKCk6IG51bWJlciB7IHJldHVybiBBQ1RJT04uZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGFjdGlvbih4OiBudW1iZXIpIHsgQUNUSU9OLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IHJlcGxhY2VtZW50KCk6IG51bWJlciB7IHJldHVybiBSRVBMQUNFTUVOVC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgcmVwbGFjZW1lbnQoeDogbnVtYmVyKSB7IFJFUExBQ0VNRU5ULnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGdvbGREcm9wKCk6IG51bWJlciB7IHJldHVybiBHT0xEX0RST1AuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGdvbGREcm9wKHg6IG51bWJlcikgeyBHT0xEX0RST1Auc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgZWxlbWVudHMoKTogbnVtYmVyIHsgcmV0dXJuIEVMRU1FTlRTLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBlbGVtZW50cyh4OiBudW1iZXIpIHsgRUxFTUVOVFMuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICAvKiogVW5wcm9jZXNzZWQgZXhwZXJpZW5jZSByZXdhcmQgKCQ1MjAseCkuICovXG4gIGdldCBleHBSZXdhcmQoKTogbnVtYmVyIHsgcmV0dXJuIEVYUF9SRVdBUkQuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGV4cFJld2FyZCh4OiBudW1iZXIpIHsgRVhQX1JFV0FSRC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBhdHRhY2tUeXBlKCk6IG51bWJlciB7IHJldHVybiBBVFRBQ0tfVFlQRS5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgYXR0YWNrVHlwZSh4OiBudW1iZXIpIHsgQVRUQUNLX1RZUEUuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgc3RhdHVzRWZmZWN0KCk6IG51bWJlciB7IHJldHVybiBTVEFUVVNfRUZGRUNULmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBzdGF0dXNFZmZlY3QoeDogbnVtYmVyKSB7IFNUQVRVU19FRkZFQ1Quc2V0KHRoaXMuZGF0YSwgeCk7IH1cbn1cblxuZnVuY3Rpb24gcHJvcCguLi5zcGVjOiBbbnVtYmVyLCBudW1iZXI/LCBudW1iZXI/XVtdKSB7XG4gIHJldHVybiBuZXcgU3RhdCguLi5zcGVjKTtcbn1cblxuY2xhc3MgU3RhdCB7XG4gIHJlYWRvbmx5IHNwZWM6IFtudW1iZXIsIG51bWJlcj8sIG51bWJlcj9dW107XG5cbiAgY29uc3RydWN0b3IoLi4uc3BlYzogW251bWJlciwgbnVtYmVyPywgbnVtYmVyP11bXSkge1xuICAgIHRoaXMuc3BlYyA9IHNwZWM7XG4gIH1cblxuICBnZXQoZGF0YTogbnVtYmVyW10pIHtcbiAgICBsZXQgdmFsdWUgPSAwO1xuICAgIGZvciAoY29uc3QgW2FkZHIsIG1hc2sgPSAweGZmLCBzaGlmdCA9IDBdIG9mIHRoaXMuc3BlYykge1xuICAgICAgY29uc3QgaW5kZXggPSAoYWRkciAtIDB4MzAwKSA+Pj4gNTtcbiAgICAgIGNvbnN0IGxzaCA9IHNoaWZ0IDwgMCA/IC1zaGlmdCA6IDA7XG4gICAgICBjb25zdCByc2ggPSBzaGlmdCA8IDAgPyAwIDogc2hpZnQ7XG4gICAgICB2YWx1ZSB8PSAoKGRhdGFbaW5kZXhdICYgbWFzaykgPj4+IHJzaCkgPDwgbHNoO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBzZXQoZGF0YTogbnVtYmVyW10sIHZhbHVlOiBudW1iZXIpIHtcbiAgICBmb3IgKGNvbnN0IFthZGRyLCBtYXNrID0gMHhmZiwgc2hpZnQgPSAwXSBvZiB0aGlzLnNwZWMpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gKGFkZHIgLSAweDMwMCkgPj4+IDU7XG4gICAgICBjb25zdCBsc2ggPSBzaGlmdCA8IDAgPyAtc2hpZnQgOiAwO1xuICAgICAgY29uc3QgcnNoID0gc2hpZnQgPCAwID8gMCA6IHNoaWZ0O1xuICAgICAgY29uc3QgdiA9ICh2YWx1ZSA+Pj4gbHNoKSA8PCByc2ggJiBtYXNrO1xuICAgICAgZGF0YVtpbmRleF0gPSBkYXRhW2luZGV4XSAmIH5tYXNrIHwgdjtcbiAgICB9XG4gIH1cbn1cblxuY29uc3QgTUVUQVNQUklURSA9IHByb3AoWzB4MzAwXSk7XG5jb25zdCBTUEVFRCA9IHByb3AoWzB4MzQwLCAweGZdKTtcbmNvbnN0IENPTExJU0lPTl9QTEFORSA9IHByb3AoWzB4M2EwLCAweGYwLCA0XSk7XG5jb25zdCBISVRCT1ggPSBwcm9wKFsweDQyMCwgMHg0MCwgMl0sIFsweDNhMCwgMHgwZl0pO1xuY29uc3QgSFAgPSBwcm9wKFsweDNjMF0pO1xuY29uc3QgQVRLID0gcHJvcChbMHgzZTBdKTtcbmNvbnN0IERFRiA9IHByb3AoWzB4NDAwXSk7XG5jb25zdCBMRVZFTCA9IHByb3AoWzB4NDIwLCAweDFmXSk7XG5jb25zdCBQT0lTT04gPSBwcm9wKFsweDQyMCwgMHg4MCwgN10pO1xuY29uc3QgQ0hJTEQgPSBwcm9wKFsweDQ0MF0pOyAvLyBhZC1ob2Mgc3Bhd24gaW5kZXhcbmNvbnN0IFRFUlJBSU5fU1VTQ0VQVElCSUxJVFkgPSBwcm9wKFsweDQ2MF0pO1xuY29uc3QgSU1NT0JJTEUgPSBwcm9wKFsweDRhMCwgMHg4MCwgN10pOyAvLyB3aWxsIG5vdCBiZSBrbm9ja2VkIGJhY2tcbmNvbnN0IEFDVElPTiA9IHByb3AoWzB4NGEwLCAweDdmXSk7XG5jb25zdCBSRVBMQUNFTUVOVCA9IHByb3AoWzB4NGMwXSk7XG5jb25zdCBHT0xEX0RST1AgPSBwcm9wKFsweDUwMCwgMHhmMCwgNF0pO1xuY29uc3QgRUxFTUVOVFMgPSBwcm9wKFsweDUwMCwgMHhmXSk7XG5jb25zdCBFWFBfUkVXQVJEID0gcHJvcChbMHg1MjBdKTtcbmNvbnN0IEFUVEFDS19UWVBFID0gcHJvcChbMHg1NDBdKTtcbmNvbnN0IFNUQVRVU19FRkZFQ1QgPSBwcm9wKFsweDU2MCwgMHhmXSk7XG4iXX0=