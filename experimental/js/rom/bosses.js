import { die } from '../assert.js';
import { Address, Segment, readLittleEndian, upperCamelToSpaces } from './util.js';
const { $0f, $1b } = Segment;
export class Bosses {
    constructor(rom) {
        this.rom = rom;
        this.Vampire1 = new Boss(this, {
            flag: this.rom.flags.Vampire1,
            kill: 0x0,
            npc: this.rom.npcs.Vampire1,
            shuffled: true,
            sword: 1,
        });
        this.Insect = new Boss(this, {
            flag: this.rom.flags.GiantInsect,
            kill: 0x1,
            npc: this.rom.npcs.Insect,
            sword: 1,
        });
        this.Kelbesque1 = new Boss(this, {
            flag: this.rom.flags.Kelbesque1,
            kill: 0x2,
            npc: this.rom.npcs.Kelbesque1,
            shuffled: true,
        });
        this.Rage = new Boss(this, {
            flag: this.rom.flags.Rage,
            kill: 0x3,
            npc: this.rom.npcs.Rage,
        });
        this.Sabera1 = new Boss(this, {
            address: 0x3656e,
            flag: this.rom.flags.Sabera1,
            kill: 0x4,
            npc: this.rom.npcs.SaberaDisguisedAsMesia,
            shuffled: true,
        });
        this.Vampire2 = new Boss(this, {
            flag: this.rom.flags.Vampire2,
            kill: 0xc,
            npc: this.rom.npcs.Vampire2,
            shuffled: true,
            sword: 1,
        });
        this.Mado1 = new Boss(this, {
            address: 0x3d820,
            flag: this.rom.flags.Mado1,
            kill: 0x5,
            shuffled: true,
        });
        this.Kelbesque2 = new Boss(this, {
            flag: this.rom.flags.Kelbesque2,
            kill: 0x6,
            npc: this.rom.npcs.Kelbesque2,
            shuffled: true,
        });
        this.Sabera2 = new Boss(this, {
            flag: this.rom.flags.Sabera2,
            kill: 0x7,
            npc: this.rom.npcs.Sabera2,
            shuffled: true,
        });
        this.Mado2 = new Boss(this, {
            flag: this.rom.flags.Mado2,
            kill: 0x8,
            npc: this.rom.npcs.Mado2,
            shuffled: true,
        });
        this.Karmine = new Boss(this, {
            flag: this.rom.flags.Karmine,
            kill: 0x9,
            npc: this.rom.npcs.Karmine,
            shuffled: true,
            sword: 2,
        });
        this.Draygon1 = new Boss(this, {
            flag: this.rom.flags.Draygon1,
            kill: 0xa,
            npc: this.rom.npcs.Draygon,
            shuffled: true,
            sword: 2,
        });
        this.StatueOfMoon = new Boss(this, {
            flag: this.rom.flags.UsedBowOfMoon,
            npc: this.rom.npcs.StatueOfMoon,
        });
        this.StatueOfSun = new Boss(this, {
            flag: this.rom.flags.UsedBowOfSun,
            npc: this.rom.npcs.StatueOfSun,
        });
        this.Draygon2 = new Boss(this, {
            flag: this.rom.flags.Draygon2,
            kill: 0xb,
            npc: this.rom.npcs.Draygon,
        });
        this.Dyna = new Boss(this, {
            kill: 0xd,
            object: 0xa4,
        });
        this.musics = [
            new BossMusic($0f, 0xa4b8, [this.Vampire1, this.Vampire2]),
            new BossMusic($0f, 0xa690, [this.Insect]),
            new BossMusic($0f, 0xa99b, [this.Kelbesque1, this.Kelbesque2]),
            new BossMusic($0f, 0xacb1, [this.Sabera1, this.Sabera2]),
            new BossMusic($0f, 0xae0f, [this.Mado1, this.Mado2]),
            new BossMusic($0f, 0xaf83, [this.Karmine]),
            new BossMusic($0f, 0xb187, [this.Draygon1]),
            new BossMusic($0f, 0xb311, [this.Draygon2]),
            new BossMusic($1b, 0xbc30, [this.Dyna]),
        ];
        this.all = [];
        for (const key in this) {
            if (!this.hasOwnProperty(key))
                continue;
            const boss = this[key];
            if (boss instanceof Boss) {
                boss.name = upperCamelToSpaces(key);
                this.all.push(boss);
            }
        }
    }
    isBossFlag(flag) {
        const flags = this.flags || (this.flags = (() => {
            const f = new Set();
            for (const boss of this.all) {
                if (boss.flag != null)
                    f.add(boss.flag.id);
            }
            return f;
        })());
        return flags.has(flag);
    }
    fromLocation(id) {
        return this.all.find(b => b.location === id);
    }
    fromBossKill(num) {
        return this.all.find(b => b.kill === num);
    }
    fromObject(id) {
        return this.all.find(b => b.object === id);
    }
    [Symbol.iterator]() {
        return this.all[Symbol.iterator]();
    }
    write() {
        const a = this.rom.assembler();
        for (const music of this.musics) {
            music.addr.loc(a);
            a.byte(music.bgm);
        }
        return [a.module()];
    }
}
export class BossMusic {
    constructor(seg, org, bosses) {
        this.bosses = bosses;
        this.addr = Address.of(seg, org);
        const rom = bosses[0].bosses.rom;
        this.bgm = this.addr.read(rom.prg);
    }
}
export class Boss {
    constructor(bosses, { flag, npc, kill, shuffled, address, sword = 3, object }) {
        this.bosses = bosses;
        const { prg } = bosses.rom;
        this.flag = flag;
        this.npc = npc;
        this.object =
            address ? prg[address] : npc ? npc.data[1] : (object !== null && object !== void 0 ? object : die(`address, npc, or object is required`));
        this.swordLevel = sword;
        this.shuffled = Boolean(shuffled);
        this.kill = kill;
        if (kill != null) {
            const killAddr = 0x14000 + readLittleEndian(prg, 0x1f96b + 2 * kill);
            const drop = prg[killAddr + 4];
            if (drop !== 0xff)
                this.drop = drop;
            this.location = prg[0x1f95d + kill];
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9zc2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3JvbS9ib3NzZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUlqQyxPQUFPLEVBQVUsT0FBTyxFQUFFLE9BQU8sRUFDekIsZ0JBQWdCLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFFL0QsTUFBTSxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUMsR0FBRyxPQUFPLENBQUM7QUFpQjNCLE1BQU0sT0FBTyxNQUFNO0lBK0dqQixZQUFxQixHQUFRO1FBQVIsUUFBRyxHQUFILEdBQUcsQ0FBSztRQTdHcEIsYUFBUSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUNqQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUTtZQUM3QixJQUFJLEVBQUUsR0FBRztZQUNULEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRO1lBQzNCLFFBQVEsRUFBRSxJQUFJO1lBQ2QsS0FBSyxFQUFFLENBQUM7U0FDVCxDQUFDLENBQUM7UUFDTSxXQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQy9CLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxXQUFXO1lBQ2hDLElBQUksRUFBRSxHQUFHO1lBQ1QsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU07WUFDekIsS0FBSyxFQUFFLENBQUM7U0FDVCxDQUFDLENBQUM7UUFDTSxlQUFVLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ25DLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFVO1lBQy9CLElBQUksRUFBRSxHQUFHO1lBQ1QsR0FBRyxFQUFFLElBQUksQ0FB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QUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFDNUMsTUFBTSxhQUFOLE1BQU0sY0FBTixNQUFNLEdBQUksR0FBRyxDQUFDLHFDQUFxQyxDQUFDLENBQUEsQ0FBQztRQUN6RCxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztRQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLElBQUksSUFBSSxJQUFJLEVBQUU7WUFDaEIsTUFBTSxRQUFRLEdBQUcsT0FBTyxHQUFHLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxPQUFPLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ3JFLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDL0IsSUFBSSxJQUFJLEtBQUssSUFBSTtnQkFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztZQUNwQyxJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUM7U0FDckM7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZHVsZX0gZnJvbSAnLi4vYXNtL21vZHVsZS5qcyc7XG5pbXBvcnQge2RpZX0gZnJvbSAnLi4vYXNzZXJ0LmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtGbGFnfSBmcm9tICcuL2ZsYWdzLmpzJztcbmltcG9ydCB7TnBjfSBmcm9tICcuL25wYy5qcyc7XG5pbXBvcnQge011dGFibGUsIEFkZHJlc3MsIFNlZ21lbnQsXG4gICAgICAgIHJlYWRMaXR0bGVFbmRpYW4sIHVwcGVyQ2FtZWxUb1NwYWNlc30gZnJvbSAnLi91dGlsLmpzJztcblxuY29uc3QgeyQwZiwgJDFifSA9IFNlZ21lbnQ7XG5cbmludGVyZmFjZSBCb3NzRGF0YSB7XG4gIHJlYWRvbmx5IGZsYWc/OiBGbGFnO1xuICByZWFkb25seSBucGM/OiBOcGM7XG4gIHJlYWRvbmx5IGtpbGw/OiBudW1iZXI7XG4gIHJlYWRvbmx5IHNodWZmbGVkPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgYWRkcmVzcz86IG51bWJlcjtcbiAgcmVhZG9ubHkgc3dvcmQ/OiBudW1iZXI7XG4gIHJlYWRvbmx5IG9iamVjdD86IG51bWJlcjtcbn1cblxuLy8gVE9ETyAtIHdlIG5lZWQgYSBjb25zaXN0ZW50IHdheSB0byByZWZlciB0byBib3NzZXMuLi5cbi8vICAtIG1heWJlIGJvc3Nlcy5mcm9tTnBjSWQoKSwgYm9zc2VzLmZyb21PYmplY3RJZCgpLCBib3NzZXMuZnJvbUJvc3NLaWxsKClcblxuLy8gUmVwcmVzZW50cyBhIGJvc3Mgc2xvdC4gIE5vdGUgdGhhdCB0aGUgc3BlY2lmaWMgb2JqZWN0IGlzIHRpZWQgbW9zdCB0aWdodGx5XG4vLyB0byB0aGUgYm9zcyBraWxsIChkcm9wKSwgcmF0aGVyIHRoYW4gdGhlIHNwZWNpZmljIGlkZW50aXR5IG9mIHRoZSBib3NzLlxuZXhwb3J0IGNsYXNzIEJvc3NlcyBpbXBsZW1lbnRzIEl0ZXJhYmxlPEJvc3M+IHtcblxuICByZWFkb25seSBWYW1waXJlMSA9IG5ldyBCb3NzKHRoaXMsIHtcbiAgICBmbGFnOiB0aGlzLnJvbS5mbGFncy5WYW1waXJlMSxcbiAgICBraWxsOiAweDAsXG4gICAgbnBjOiB0aGlzLnJvbS5ucGNzLlZhbXBpcmUxLFxuICAgIHNodWZmbGVkOiB0cnVlLFxuICAgIHN3b3JkOiAxLFxuICB9KTtcbiAgcmVhZG9ubHkgSW5zZWN0ID0gbmV3IEJvc3ModGhpcywge1xuICAgIGZsYWc6IHRoaXMucm9tLmZsYWdzLkdpYW50SW5zZWN0LFxuICAgIGtpbGw6IDB4MSxcbiAgICBucGM6IHRoaXMucm9tLm5wY3MuSW5zZWN0LFxuICAgIHN3b3JkOiAxLFxuICB9KTtcbiAgcmVhZG9ubHkgS2VsYmVzcXVlMSA9IG5ldyBCb3NzKHRoaXMsIHtcbiAgICBmbGFnOiB0aGlzLnJvbS5mbGFncy5LZWxiZXNxdWUxLFxuICAgIGtpbGw6IDB4MixcbiAgICBucGM6IHRoaXMucm9tLm5wY3MuS2VsYmVzcXVlMSxcbiAgICBzaHVmZmxlZDogdHJ1ZSxcbiAgfSk7XG4gIHJlYWRvbmx5IFJhZ2UgPSBuZXcgQm9zcyh0aGlzLCB7XG4gICAgZmxhZzogdGhpcy5yb20uZmxhZ3MuUmFnZSxcbiAgICBraWxsOiAweDMsXG4gICAgbnBjOiB0aGlzLnJvbS5ucGNzLlJhZ2UsXG4gIH0pO1xuICByZWFkb25seSBTYWJlcmExID0gbmV3IEJvc3ModGhpcywge1xuICAgIGFkZHJlc3M6IDB4MzY1NmUsXG4gICAgZmxhZzogdGhpcy5yb20uZmxhZ3MuU2FiZXJhMSxcbiAgICBraWxsOiAweDQsXG4gICAgbnBjOiB0aGlzLnJvbS5ucGNzLlNhYmVyYURpc2d1aXNlZEFzTWVzaWEsXG4gICAgc2h1ZmZsZWQ6IHRydWUsXG4gIH0pO1xuICByZWFkb25seSBWYW1waXJlMiA9IG5ldyBCb3NzKHRoaXMsIHtcbiAgICBmbGFnOiB0aGlzLnJvbS5mbGFncy5WYW1waXJlMixcbiAgICBraWxsOiAweGMsXG4gICAgbnBjOiB0aGlzLnJvbS5ucGNzLlZhbXBpcmUyLFxuICAgIHNodWZmbGVkOiB0cnVlLFxuICAgIHN3b3JkOiAxLFxuICB9KTtcbiAgcmVhZG9ubHkgTWFkbzEgPSBuZXcgQm9zcyh0aGlzLCB7XG4gICAgYWRkcmVzczogMHgzZDgyMCxcbiAgICBmbGFnOiB0aGlzLnJvbS5mbGFncy5NYWRvMSxcbiAgICBraWxsOiAweDUsXG4gICAgc2h1ZmZsZWQ6IHRydWUsXG4gIH0pO1xuICByZWFkb25seSBLZWxiZXNxdWUyID0gbmV3IEJvc3ModGhpcywge1xuICAgIGZsYWc6IHRoaXMucm9tLmZsYWdzLktlbGJlc3F1ZTIsXG4gICAga2lsbDogMHg2LFxuICAgIG5wYzogdGhpcy5yb20ubnBjcy5LZWxiZXNxdWUyLFxuICAgIHNodWZmbGVkOiB0cnVlLFxuICB9KTtcbiAgcmVhZG9ubHkgU2FiZXJhMiA9IG5ldyBCb3NzKHRoaXMsIHtcbiAgICBmbGFnOiB0aGlzLnJvbS5mbGFncy5TYWJlcmEyLFxuICAgIGtpbGw6IDB4NyxcbiAgICBucGM6IHRoaXMucm9tLm5wY3MuU2FiZXJhMixcbiAgICBzaHVmZmxlZDogdHJ1ZSxcbiAgfSk7XG4gIHJlYWRvbmx5IE1hZG8yID0gbmV3IEJvc3ModGhpcywge1xuICAgIGZsYWc6IHRoaXMucm9tLmZsYWdzLk1hZG8yLFxuICAgIGtpbGw6IDB4OCxcbiAgICBucGM6IHRoaXMucm9tLm5wY3MuTWFkbzIsXG4gICAgc2h1ZmZsZWQ6IHRydWUsXG4gIH0pO1xuICByZWFkb25seSBLYXJtaW5lID0gbmV3IEJvc3ModGhpcywge1xuICAgIGZsYWc6IHRoaXMucm9tLmZsYWdzLkthcm1pbmUsXG4gICAga2lsbDogMHg5LFxuICAgIG5wYzogdGhpcy5yb20ubnBjcy5LYXJtaW5lLFxuICAgIHNodWZmbGVkOiB0cnVlLFxuICAgIHN3b3JkOiAyLFxuICB9KTtcbiAgcmVhZG9ubHkgRHJheWdvbjEgPSBuZXcgQm9zcyh0aGlzLCB7XG4gICAgZmxhZzogdGhpcy5yb20uZmxhZ3MuRHJheWdvbjEsXG4gICAga2lsbDogMHhhLFxuICAgIG5wYzogdGhpcy5yb20ubnBjcy5EcmF5Z29uLFxuICAgIHNodWZmbGVkOiB0cnVlLFxuICAgIHN3b3JkOiAyLFxuICB9KTtcbiAgcmVhZG9ubHkgU3RhdHVlT2ZNb29uID0gbmV3IEJvc3ModGhpcywge1xuICAgIGZsYWc6IHRoaXMucm9tLmZsYWdzLlVzZWRCb3dPZk1vb24sXG4gICAgbnBjOiB0aGlzLnJvbS5ucGNzLlN0YXR1ZU9mTW9vbixcbiAgfSk7XG4gIHJlYWRvbmx5IFN0YXR1ZU9mU3VuID0gbmV3IEJvc3ModGhpcywge1xuICAgIGZsYWc6IHRoaXMucm9tLmZsYWdzLlVzZWRCb3dPZlN1bixcbiAgICBucGM6IHRoaXMucm9tLm5wY3MuU3RhdHVlT2ZTdW4sXG4gIH0pO1xuICByZWFkb25seSBEcmF5Z29uMiA9IG5ldyBCb3NzKHRoaXMsIHtcbiAgICBmbGFnOiB0aGlzLnJvbS5mbGFncy5EcmF5Z29uMixcbiAgICBraWxsOiAweGIsXG4gICAgbnBjOiB0aGlzLnJvbS5ucGNzLkRyYXlnb24sXG4gIH0pO1xuICByZWFkb25seSBEeW5hID0gbmV3IEJvc3ModGhpcywge1xuICAgIGtpbGw6IDB4ZCxcbiAgICBvYmplY3Q6IDB4YTQsXG4gIH0pO1xuXG4gIHJlYWRvbmx5IG11c2ljcyA9IFtcbiAgICBuZXcgQm9zc011c2ljKCQwZiwgMHhhNGI4LCBbdGhpcy5WYW1waXJlMSwgdGhpcy5WYW1waXJlMl0pLFxuICAgIG5ldyBCb3NzTXVzaWMoJDBmLCAweGE2OTAsIFt0aGlzLkluc2VjdF0pLFxuICAgIG5ldyBCb3NzTXVzaWMoJDBmLCAweGE5OWIsIFt0aGlzLktlbGJlc3F1ZTEsIHRoaXMuS2VsYmVzcXVlMl0pLFxuICAgIG5ldyBCb3NzTXVzaWMoJDBmLCAweGFjYjEsIFt0aGlzLlNhYmVyYTEsIHRoaXMuU2FiZXJhMl0pLFxuICAgIG5ldyBCb3NzTXVzaWMoJDBmLCAweGFlMGYsIFt0aGlzLk1hZG8xLCB0aGlzLk1hZG8yXSksXG4gICAgbmV3IEJvc3NNdXNpYygkMGYsIDB4YWY4MywgW3RoaXMuS2FybWluZV0pLFxuICAgIG5ldyBCb3NzTXVzaWMoJDBmLCAweGIxODcsIFt0aGlzLkRyYXlnb24xXSksXG4gICAgbmV3IEJvc3NNdXNpYygkMGYsIDB4YjMxMSwgW3RoaXMuRHJheWdvbjJdKSxcbiAgICBuZXcgQm9zc011c2ljKCQxYiwgMHhiYzMwLCBbdGhpcy5EeW5hXSksXG4gIF07XG5cbiAgcHJpdmF0ZSByZWFkb25seSBhbGw6IEJvc3NbXSA9IFtdO1xuICBwcml2YXRlIGZsYWdzPzogU2V0PG51bWJlcj47XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzKSB7XG4gICAgICBpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgY29udGludWU7XG4gICAgICBjb25zdCBib3NzID0gdGhpc1trZXldO1xuICAgICAgaWYgKGJvc3MgaW5zdGFuY2VvZiBCb3NzKSB7XG4gICAgICAgIChib3NzIGFzIE11dGFibGU8Qm9zcz4pLm5hbWUgPSB1cHBlckNhbWVsVG9TcGFjZXMoa2V5KTtcbiAgICAgICAgdGhpcy5hbGwucHVzaChib3NzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpc0Jvc3NGbGFnKGZsYWc6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGZsYWdzID0gdGhpcy5mbGFncyB8fCAodGhpcy5mbGFncyA9ICgoKSA9PiB7XG4gICAgICBjb25zdCBmID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgICBmb3IgKGNvbnN0IGJvc3Mgb2YgdGhpcy5hbGwpIHtcbiAgICAgICAgaWYgKGJvc3MuZmxhZyAhPSBudWxsKSBmLmFkZChib3NzLmZsYWcuaWQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGY7XG4gICAgfSkoKSk7XG4gICAgcmV0dXJuIGZsYWdzLmhhcyhmbGFnKTtcbiAgfVxuXG4gIGZyb21Mb2NhdGlvbihpZDogbnVtYmVyKTogQm9zc3x1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmFsbC5maW5kKGIgPT4gYi5sb2NhdGlvbiA9PT0gaWQpO1xuICB9XG5cbiAgZnJvbUJvc3NLaWxsKG51bTogbnVtYmVyKTogQm9zc3x1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmFsbC5maW5kKGIgPT4gYi5raWxsID09PSBudW0pO1xuICB9XG5cbiAgZnJvbU9iamVjdChpZDogbnVtYmVyKTogQm9zc3x1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmFsbC5maW5kKGIgPT4gYi5vYmplY3QgPT09IGlkKTtcbiAgfVxuXG4gIFtTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8Qm9zcz4ge1xuICAgIHJldHVybiB0aGlzLmFsbFtTeW1ib2wuaXRlcmF0b3JdKCk7XG4gIH1cblxuICB3cml0ZSgpOiBNb2R1bGVbXSB7XG4gICAgY29uc3QgYSA9IHRoaXMucm9tLmFzc2VtYmxlcigpO1xuICAgIGZvciAoY29uc3QgbXVzaWMgb2YgdGhpcy5tdXNpY3MpIHtcbiAgICAgIG11c2ljLmFkZHIubG9jKGEpO1xuICAgICAgYS5ieXRlKG11c2ljLmJnbSk7XG4gICAgfVxuICAgIHJldHVybiBbYS5tb2R1bGUoKV07XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEJvc3NNdXNpYyB7XG4gIGJnbTogbnVtYmVyO1xuICByZWFkb25seSBhZGRyOiBBZGRyZXNzO1xuXG4gIGNvbnN0cnVjdG9yKHNlZzogU2VnbWVudCwgb3JnOiBudW1iZXIsIHJlYWRvbmx5IGJvc3NlczogcmVhZG9ubHkgQm9zc1tdKSB7XG4gICAgdGhpcy5hZGRyID0gQWRkcmVzcy5vZihzZWcsIG9yZyk7XG4gICAgY29uc3Qgcm9tID0gYm9zc2VzWzBdLmJvc3Nlcy5yb207IC8vIHB1bGwgaXQgb3V0IG9mIHNvbWV3aGVyZVxuICAgIHRoaXMuYmdtID0gdGhpcy5hZGRyLnJlYWQocm9tLnByZyk7XG4gIH1cbn1cblxuLy8gTk9URTogY3VycmVudGx5IHRoaXMgZGF0YSBpcyByZWFkLW9ubHkuXG5leHBvcnQgY2xhc3MgQm9zcyB7XG5cbiAgLy8gVE9ETyAtIG1ha2Ugb2JqZWN0IHNldHRhYmxlP1xuICByZWFkb25seSBuYW1lITogc3RyaW5nO1xuICByZWFkb25seSBvYmplY3Q6IG51bWJlcjtcbiAgcmVhZG9ubHkgZmxhZz86IEZsYWc7XG4gIHJlYWRvbmx5IG5wYz86IE5wYztcbiAgcmVhZG9ubHkgc3dvcmRMZXZlbDogbnVtYmVyO1xuICByZWFkb25seSBzaHVmZmxlZDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgZHJvcD86IG51bWJlcjtcbiAgcmVhZG9ubHkga2lsbD86IG51bWJlcjtcbiAgcmVhZG9ubHkgbG9jYXRpb24/OiBudW1iZXI7XG5cbiAgLy8gT25seSB1c2VkIGZvciBsb2dpYy5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYm9zc2VzOiBCb3NzZXMsXG4gICAgICAgICAgICAgIHtmbGFnLCBucGMsIGtpbGwsIHNodWZmbGVkLFxuICAgICAgICAgICAgICAgYWRkcmVzcywgc3dvcmQgPSAzLCBvYmplY3R9OiBCb3NzRGF0YSkge1xuICAgIGNvbnN0IHtwcmd9ID0gYm9zc2VzLnJvbTtcbiAgICB0aGlzLmZsYWcgPSBmbGFnO1xuICAgIHRoaXMubnBjID0gbnBjO1xuICAgIHRoaXMub2JqZWN0ID1cbiAgICAgICAgYWRkcmVzcyA/IHByZ1thZGRyZXNzXSA6IG5wYyA/IG5wYy5kYXRhWzFdIDpcbiAgICAgICAgb2JqZWN0ID8/IGRpZShgYWRkcmVzcywgbnBjLCBvciBvYmplY3QgaXMgcmVxdWlyZWRgKTtcbiAgICB0aGlzLnN3b3JkTGV2ZWwgPSBzd29yZDtcbiAgICB0aGlzLnNodWZmbGVkID0gQm9vbGVhbihzaHVmZmxlZCk7XG4gICAgdGhpcy5raWxsID0ga2lsbDtcbiAgICBpZiAoa2lsbCAhPSBudWxsKSB7XG4gICAgICBjb25zdCBraWxsQWRkciA9IDB4MTQwMDAgKyByZWFkTGl0dGxlRW5kaWFuKHByZywgMHgxZjk2YiArIDIgKiBraWxsKTtcbiAgICAgIGNvbnN0IGRyb3AgPSBwcmdba2lsbEFkZHIgKyA0XTtcbiAgICAgIGlmIChkcm9wICE9PSAweGZmKSB0aGlzLmRyb3AgPSBkcm9wO1xuICAgICAgdGhpcy5sb2NhdGlvbiA9IHByZ1sweDFmOTVkICsga2lsbF07XG4gICAgfVxuICB9XG59XG4iXX0=