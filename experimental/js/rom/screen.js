import { Entity } from './entity.js';
import { tuple } from './util.js';
export class Screen extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.used = true;
        const base = (id > 0xff ? 0x40 + id : id) << 8;
        this.tiles = tuple(rom.prg, base, 0xf0);
    }
    clone(newId) {
        const clone = new Screen(this.rom, newId);
        clone.used = this.used;
        clone.tiles = [...this.tiles];
        return clone;
    }
    allTilesSet() {
        return new Set(this.tiles);
    }
    set2d(start, data) {
        const x0 = start & 0xf;
        const y0 = start >>> 4;
        for (let y = 0; y < data.length; y++) {
            const row = data[y];
            for (let x = 0; x < row.length; x++) {
                const tile = row[x];
                if (tile != null)
                    this.tiles[(y0 + y) << 4 | (x0 + x)] = tile;
            }
        }
    }
    write(writer) {
        let base = this.id << 8;
        if (this.id > 0xff) {
            if (!this.rom.compressedMapData) {
                base += 0x4000;
            }
            else {
                base = (this.id & 0xff00) << 5 | (this.id & 0xff) << 8;
            }
        }
        if ((base & 0xfe000) !== 0x14000) {
            writer.rom.subarray(base, base + 0xf0).set(this.tiles);
        }
        else {
            writer.rom.subarray(base, base + 0xc0).set(this.tiles.slice(0, 0xc0));
        }
    }
}
export class Screens extends Array {
    constructor(rom) {
        super(0x103);
        this.rom = rom;
        this.unallocated = [];
        for (let i = 0; i < 0x103; i++) {
            this[i] = new Screen(rom, i);
        }
    }
    getScreen(id) {
        const arr = id < 0 ? this.unallocated : this;
        const i = id < 0 ? ~id : id;
        return arr[i] || (arr[i] = new Screen(this.rom, id));
    }
    setScreen(id, screen) {
        const arr = id < 0 ? this.unallocated : this;
        const i = id < 0 ? ~id : id;
        arr[i] = screen;
    }
    deleteScreen(id) {
        const arr = id < 0 ? this.unallocated : this;
        const i = id < 0 ? ~id : id;
        delete arr[i];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyZWVuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3JvbS9zY3JlZW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNuQyxPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBSWhDLE1BQU0sT0FBTyxNQUFPLFNBQVEsTUFBTTtJQWdCaEMsWUFBWSxHQUFRLEVBQUUsRUFBVTtRQUM5QixLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2YsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFL0MsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFhO1FBRWpCLE1BQU0sS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDMUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU5QixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFVRCxXQUFXO1FBQ1QsT0FBTyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUdELEtBQUssQ0FBQyxLQUFhLEVBQUUsSUFBaUQ7UUFDcEUsTUFBTSxFQUFFLEdBQUcsS0FBSyxHQUFHLEdBQUcs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QUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUM3QyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzVCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVELFlBQVksQ0FBQyxFQUFVO1FBQ3JCLE1BQU0sR0FBRyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUM3QyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzVCLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RW50aXR5fSBmcm9tICcuL2VudGl0eS5qcyc7XG5pbXBvcnQge3R1cGxlfSBmcm9tICcuL3V0aWwuanMnO1xuaW1wb3J0IHtXcml0ZXJ9IGZyb20gJy4vd3JpdGVyLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuXG5leHBvcnQgY2xhc3MgU2NyZWVuIGV4dGVuZHMgRW50aXR5IHtcblxuICAvLyBXaGF0IGRvIHdlIG5lZWQgdG8gdHJhY2s/XG4gIC8vICAtIHZhbmlsbGEgSUQgKDAuLiQxMDIpXG4gIC8vICAtIHJlbG9jYXRlZCBJRCAoMC4uJDIwMWYpXG4gIC8vICAtIHRpbGVzZXRzIGl0J3MgYSBwYXJ0IG9mXG4gIC8vICAgIC0gZmxhZyBpbmZvIChzZXBhcmF0ZSBmcm9tIGJyaWRnZS93YWxsKT9cbiAgLy8gICAgLSBicmlkZ2Uvd2FsbC9kb29yIGluZm9cbiAgLy8gICAgLSBzdGFpcnNcbiAgLy8gICAgLSBlZGdlIGFuZCBwYXRoIGluZm9cbiAgLy8gICAgLSByZXF1aXJlZC9hbGxvd2VkIG5laWdoYm9ycz9cbiAgLy8gICAgLSB1cGdyYWRlIHBhdGhzP1xuICAvLyBiYXNlOiBudW1iZXI7XG4gIHRpbGVzOiBudW1iZXJbXTsgLy8gYWx3YXlzIDE1eDE2XG4gIHVzZWQ6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3Iocm9tOiBSb20sIGlkOiBudW1iZXIpIHtcbiAgICBzdXBlcihyb20sIGlkKTtcbiAgICB0aGlzLnVzZWQgPSB0cnVlOyAvLyBUT0RPIC0gdHJhY2sgdW51c2VkIHRpbGVzP1xuICAgIGNvbnN0IGJhc2UgPSAoaWQgPiAweGZmID8gMHg0MCArIGlkIDogaWQpIDw8IDg7XG4gICAgLy8gbWV0YXRpbGUgaW5kZXhcbiAgICB0aGlzLnRpbGVzID0gdHVwbGUocm9tLnByZywgYmFzZSwgMHhmMCk7XG4gIH1cblxuICBjbG9uZShuZXdJZDogbnVtYmVyKTogU2NyZWVuIHtcbiAgICAvLyBUT0RPIC0gdXBkYXRlIHRoZSBzZXQgb2Ygc2NyZWVucywgdG9vP1xuICAgIGNvbnN0IGNsb25lID0gbmV3IFNjcmVlbih0aGlzLnJvbSwgbmV3SWQpO1xuICAgIGNsb25lLnVzZWQgPSB0aGlzLnVzZWQ7XG4gICAgY2xvbmUudGlsZXMgPSBbLi4udGhpcy50aWxlc107XG4gICAgLy8gY2xvbmUuYmFzZSA9IHRoaXMuYmFzZTtcbiAgICByZXR1cm4gY2xvbmU7XG4gIH1cblxuICAvLyB0aWxlKHk6IG51bWJlciwgeDogbnVtYmVyKTogbnVtYmVyIHtcbiAgLy8gICByZXR1cm4gdGhpcy50aWxlc1t5IDw8IDQgfCB4XTtcbiAgLy8gfVxuXG4gIC8vIG1ldGF0aWxlKHksIHgpOiBNZXRhdGlsZSB7XG4gIC8vICAgcmV0dXJuIHRoaXMucm9tLm1ldGF0aWxlc1t0aGlzLnRpbGVzW3ldW3hdXTtcbiAgLy8gfVxuXG4gIGFsbFRpbGVzU2V0KCk6IFNldDxudW1iZXI+IHtcbiAgICByZXR1cm4gbmV3IFNldCh0aGlzLnRpbGVzKTtcbiAgfVxuXG4gIC8qKiBXcml0ZSBhIDJkIGJsb2NrIGludG8gdGhlIHRpbGUgYXJyYXkuICovXG4gIHNldDJkKHN0YXJ0OiBudW1iZXIsIGRhdGE6IFJlYWRvbmx5QXJyYXk8UmVhZG9ubHlBcnJheTxudW1iZXIgfCBudWxsPj4pIHtcbiAgICBjb25zdCB4MCA9IHN0YXJ0ICYgMHhmO1xuICAgIGNvbnN0IHkwID0gc3RhcnQgPj4+IDQ7XG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCBkYXRhLmxlbmd0aDsgeSsrKSB7XG4gICAgICBjb25zdCByb3cgPSBkYXRhW3ldO1xuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCByb3cubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgY29uc3QgdGlsZSA9IHJvd1t4XTtcbiAgICAgICAgaWYgKHRpbGUgIT0gbnVsbCkgdGhpcy50aWxlc1soeTAgKyB5KSA8PCA0IHwgKHgwICsgeCldID0gdGlsZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICB3cml0ZSh3cml0ZXI6IFdyaXRlcik6IHZvaWQge1xuICAgIGxldCBiYXNlID0gdGhpcy5pZCA8PCA4O1xuICAgIGlmICh0aGlzLmlkID4gMHhmZikge1xuICAgICAgaWYgKCF0aGlzLnJvbS5jb21wcmVzc2VkTWFwRGF0YSkge1xuICAgICAgICBiYXNlICs9IDB4NDAwMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJhc2UgPSAodGhpcy5pZCAmIDB4ZmYwMCkgPDwgNSB8ICh0aGlzLmlkICYgMHhmZikgPDwgODtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gdGhpcy5pZCA8PCA4IDogKHRoaXMuaWQgPiAweGZmID8gMHg0MCArIHRoaXMuaWQgOiB0aGlzLmlkKSA8PCA4O1xuICAgIGlmICgoYmFzZSAmIDB4ZmUwMDApICE9PSAweDE0MDAwKSB7XG4gICAgICB3cml0ZXIucm9tLnN1YmFycmF5KGJhc2UsIGJhc2UgKyAweGYwKS5zZXQodGhpcy50aWxlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHdlIHJldXNlIHRoZSBsYXN0IDIgcm93cyBvZiBleHRlbmRlZCBzY3JlZW5zIChjb3ZlcmVkIGJ5IEhVRCkgZm9yXG4gICAgICAvLyBnbG9iYWwgZmxhZ3MgaW4gdGhlIHJvbS4gIC0tIG9ubHkgZm9yIHBhZ2UgMTAuLi4hP1xuXG4gICAgICAvLyBUT0RPIC0gb25seSBkbyB0aGlzIGZvciBwYWdlIDEwXG5cbiAgICAgIHdyaXRlci5yb20uc3ViYXJyYXkoYmFzZSwgYmFzZSArIDB4YzApLnNldCh0aGlzLnRpbGVzLnNsaWNlKDAsIDB4YzApKTtcbiAgICB9XG4gIH1cblxuICAvLyBUT0RPIC0gYWNjZXNzb3JzIGZvciB3aGljaCBwYWxldHRlcywgdGlsZXNldHMsIGFuZCBwYXR0ZXJucyBhcmUgdXNlZC9hbGxvd2VkXG59XG5cbi8vIE1ldGF0aWxlIGRvZXNuJ3QgbWVhbiBtdWNoIHdpdGhvdXQgdGlsZXNldCwgcGF0dGVybnMsIGV0Yy5cbi8vIG1heSBuZWVkIHRvIHJldGhpbmsgdGhpcyBvbmUsIG1ha2UgaXQgYSB0cmFuc2llbnQgb2JqZWN0IHRoYXQgZGVwcyBvbiBvdGhlcnMuXG4vLyBjbGFzcyBNZXRhdGlsZSB7XG4vLyAgIGNvbnN0cnVjdG9yKHJvbSwgaWQpIHtcbi8vICAgICB0aGlzLnJvbSA9IHJvbTtcbi8vICAgICB0aGlzLmlkID0gaWQ7XG4vLyAgIH1cbi8vIH1cblxuZXhwb3J0IGNsYXNzIFNjcmVlbnMgZXh0ZW5kcyBBcnJheTxTY3JlZW4+IHtcbiAgcmVhZG9ubHkgdW5hbGxvY2F0ZWQ6IEFycmF5PFNjcmVlbj4gPSBbXTtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICBzdXBlcigweDEwMyk7XG4gICAgLy8gVE9ETyAtIGlmIG1hcHMgYWxyZWFkeSBjb21wYWN0ZWQsIHJlYWQgdGhhdCBpbnN0ZWFkP1xuICAgIC8vICAtIG5lZWQgbG9jYXRpb25zIHRvIGtub3cgd2hlcmUgdG8gbG9vayFcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDB4MTAzOyBpKyspIHtcbiAgICAgIHRoaXNbaV0gPSBuZXcgU2NyZWVuKHJvbSwgaSk7XG4gICAgfVxuICB9XG5cbiAgLy8gbW92ZVNjcmVlbihvbGRJZDogbnVtYmVyLCBuZXdJZDogbnVtYmVyKTogU2NyZWVuIHtcbiAgLy8gICAvLyBFbnRpdHkuaWQgaXMgY29uc3QsIGJ1dCBtYXliZSBzaG91bGRuJ3QgYmU/XG4gIC8vIH1cblxuICBnZXRTY3JlZW4oaWQ6IG51bWJlcik6IFNjcmVlbiB7XG4gICAgY29uc3QgYXJyID0gaWQgPCAwID8gdGhpcy51bmFsbG9jYXRlZCA6IHRoaXM7XG4gICAgY29uc3QgaSA9IGlkIDwgMCA/IH5pZCA6IGlkO1xuICAgIHJldHVybiBhcnJbaV0gfHwgKGFycltpXSA9IG5ldyBTY3JlZW4odGhpcy5yb20sIGlkKSk7XG4gIH1cblxuICBzZXRTY3JlZW4oaWQ6IG51bWJlciwgc2NyZWVuOiBTY3JlZW4pIHtcbiAgICBjb25zdCBhcnIgPSBpZCA8IDAgPyB0aGlzLnVuYWxsb2NhdGVkIDogdGhpcztcbiAgICBjb25zdCBpID0gaWQgPCAwID8gfmlkIDogaWQ7XG4gICAgYXJyW2ldID0gc2NyZWVuO1xuICB9XG5cbiAgZGVsZXRlU2NyZWVuKGlkOiBudW1iZXIpIHtcbiAgICBjb25zdCBhcnIgPSBpZCA8IDAgPyB0aGlzLnVuYWxsb2NhdGVkIDogdGhpcztcbiAgICBjb25zdCBpID0gaWQgPCAwID8gfmlkIDogaWQ7XG4gICAgZGVsZXRlIGFycltpXTtcbiAgfVxufVxuIl19