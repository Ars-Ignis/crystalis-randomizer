export class Metatilesets {
    constructor(rom) {
        this.rom = rom;
        this.grass = this._(0x80, {
            patterns: [0x00, 0x0c],
        });
        this.town = this._(0x84, {});
        this.cave = this._(0x88, {});
        this.dolphinCave = this._(0x88, {});
        this.pyramid = this._(0x8c, {});
        this.river = this._(0x90, {
            animated: [0, 1],
            patterns: [0x14, 0x00],
        });
        this.sea = this._(0x94, {});
        this.mountain = this._(0x94, {});
        this.shrine = this._(0x98, {});
        this.desert = this._(0x9c, {});
        this.mountainRiver = this._(0x9c, {});
        this.swamp = this._(0xa0, {});
        this.house = this._(0xa0, {});
        this.fortress = this._(0xa4, {});
        this.labyrinth = this._(0xa4, {});
        this.iceCave = this._(0xa8, {});
        this.tower = this._(0xac, {});
    }
    _(id, opts) {
        return new Metatileset(this.rom, id, opts);
    }
}
export class Metatileset {
    constructor(rom, tilesetId, data) {
        this.rom = rom;
        this.tilesetId = tilesetId;
        this.data = data;
        this.screens = new Set();
    }
    get tileset() {
        return this.rom.tilesets[this.tilesetId];
    }
    effects() {
        return this.rom.tilesets[this.tilesetId].effects();
    }
    getTile(id) {
        return new Metatile(this.tileset, id);
    }
}
export class Metatile {
    constructor(tileset, id) {
        this.tileset = tileset;
        this.id = id;
        this.copiedFrom = -1;
    }
    get tiles() {
        return [0, 1, 2, 3].map(i => this.tileset.tiles[i][this.id]);
    }
    setTiles(tiles) {
        for (let i = 0; i < 4; i++) {
            const tile = tiles[i];
            if (tile != null)
                this.tileset.tiles[i][this.id] = tile;
        }
        return this;
    }
    get alternative() {
        const alt = this.id < 0x20 ? this.tileset.alternates[this.id] : this.id;
        return alt !== this.id ? alt : null;
    }
    setAlternative(tile) {
        if (this.id >= 0x20)
            return this;
        this.tileset.alternates[this.id] = tile != null ? tile : this.id;
        return this;
    }
    get attrs() {
        return this.tileset.attrs[this.id];
    }
    setAttrs(attrs) {
        this.tileset.attrs[this.id] = attrs;
        return this;
    }
    get effects() {
        return this.tileset.effects().effects[this.id];
    }
    setEffects(effects) {
        this.tileset.effects().effects[this.id] = effects;
        return this;
    }
    copyFrom(other, ...screens) {
        const that = new Metatile(this.tileset, other);
        this.copiedFrom = other;
        this.setTiles(that.tiles);
        if ((this.id | that.id) < 0x20) {
            this.setAlternative(that.alternative);
        }
        this.setAttrs(that.attrs);
        this.setEffects(that.effects);
        return this;
    }
    replaceIn(...screens) {
        if (this.copiedFrom < 0)
            throw new Error(`Must copyFrom first.`);
        for (const screen of screens) {
            screen.replace(this.copiedFrom, this.id);
        }
        return this;
    }
}
const NONE = 0;
const TRIM = 1;
const MAIN = 2;
export function paletteTypes(tileset, location) {
    switch (location) {
        case 0x1a:
            return [MAIN, MAIN, TRIM, (p0, p1, p2) => p0[3] === p1[3] && p1[3] === p2[3]];
        case 0x43:
            return [MAIN, TRIM, TRIM];
        case 0x57:
            return [MAIN, NONE, NONE];
        case 0x60:
            return [MAIN, MAIN, MAIN, (p0, _p1, p2) => p0[2] === p2[2]];
        case 0x64:
        case 0x68:
            return [MAIN, NONE, TRIM];
        case 0x7c:
            return [MAIN, TRIM, TRIM];
    }
    switch (tileset) {
        case 0x80:
        case 0x84:
            return [MAIN, MAIN, TRIM, (p0, p1) => p0[3] === p1[3]];
        case 0x88:
            return [MAIN, TRIM, NONE];
        case 0x8c: return [MAIN, TRIM, MAIN];
        case 0x90: return [MAIN, MAIN, MAIN];
        case 0x94: return [MAIN, TRIM, TRIM, (p0, p1) => p0[3] === p1[3]];
        case 0x98: return [TRIM, TRIM, TRIM];
        case 0x9c: return [MAIN, TRIM, MAIN];
        case 0xa0: return [TRIM, TRIM, TRIM];
        case 0xa4: return [MAIN, MAIN, TRIM];
        case 0xa8: return [MAIN, MAIN, TRIM];
        case 0xac: return [MAIN, TRIM, MAIN];
    }
    throw new Error(`unxpected: ${tileset}`);
}
const ALLOWED_PALETTES = new Map([
    ['path', [...r(0x00, 0x12), ...r(0x15, 0x1b), ...r(0x1e, 0x25),
            ...r(0x26, 0x2b), ...r(0x2c, 0x30), ...r(0x39, 0x3f),
            0x42, ...r(0x44, 0x48), ...r(0x4d, 0x59), ...r(0x80, 0x84),
            0x87, ...r(0x8b, 0x93)]],
    ['mountain', [0x01, ...r(0x03, 0x07), ...r(0x08, 0x0b), 0x0c, 0x0d, 0x0e,
            ...r(0x11, 0x18), 0x19, 0x1a, 0x1c, 0x1d, 0x1e, 0x20, 0x21,
            0x23, 0x27, 0x2a, 0x2b, 0x2f, 0x31, 0x33, 0x36, 0x37, 0x38,
            0x39, 0x3c, 0x42, 0x44, 0x46, 0x4b, 0x4c, 0x4f, 0x53, 0x58,
            ...r(0x80, 0x85), 0x87, 0x88, 0x8b, 0x8e]],
    ['trees', [0x01, 0x02, 0x04, 0x06, ...r(0x07, 0x0f), ...r(0x14, 0x18),
            0x1a, 0x1c, 0x1e, 0x20, 0x23, 0x27, 0x29, 0x2a, 0x2b, 0x2e,
            0x2f, 0x31, 0x33, 0x37, 0x38, 0x39, 0x3c, 0x3d, 0x43, 0x44,
            0x46, 0x49, 0x4a, 0x4b, 0x4f, 0x52, 0x57, 0x6e,
            ...r(0x80, 0x85), 0x87, 0x88, ...r(0x8b, 0x90)]],
]);
const TERRAIN_BY_PALETTE = new Map([
    [0x80, ['path', 'mountain', 'trees']],
    [0x84, ['mountain-path', 'brick', 'trees']],
    [0x88, ['cave wall/ground', 'cave bridge', '']],
    [0x8c, ['floor', 'fire', 'accept']],
    [0x90, ['trees', 'mountain', 'grass']],
    [0x94, ['water/ground', 'mountain', 'shallows']],
    [0x98, ['door', 'room', 'rocks']],
    [0x9c, ['mountain/ground', 'trees', 'desert']],
    [0xa0, ['ground', 'trees', 'some haze']],
    [0xa4, ['', '', '']],
    [0xa8, ['', '', '']],
    [0xac, ['', '', '']],
]);
function r(a, b) {
    return new Array(b - a).fill(0).map((_x, i) => i + a);
}
const [] = [TERRAIN_BY_PALETTE, ALLOWED_PALETTES];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXRpbGVzZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL21ldGF0aWxlc2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLE1BQU0sT0FBTyxZQUFZO0lBK0N2QixZQUE2QixHQUFRO1FBQVIsUUFBRyxHQUFILEdBQUcsQ0FBSztRQTdDNUIsVUFBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQzVCLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7U0FDdkIsQ0FBQyxDQUFDO1FBRU0sU0FBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBR3hCLFNBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUV4QixnQkFBVyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRS9CLFlBQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUUzQixVQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUU7WUFDNUIsUUFBUSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNoQixRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1NBQ3ZCLENBQUMsQ0FBQztRQUVNLFFBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUd2QixhQUFRLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFHNUIsV0FBTSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTFCLFdBQU0sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElB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T0FBTyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDckMsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEUsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNyQyxLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JDLEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDckMsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNyQyxLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JDLEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDcEM7SUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLGNBQWMsT0FBTyxFQUFFLENBQUMsQ0FBQztBQUMzQyxDQUFDO0FBWUQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsQ0FBNEI7SUFDMUQsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7WUFDcEQsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ3BELElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7WUFDMUQsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLENBQUMsVUFBVSxFQUFFLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJO1lBQzNELEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJO1lBQzFELElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUk7WUFDMUQsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSTtZQUMxRCxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkQsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7WUFDMUQsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSTtZQUMxRCxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJO1lBQzFELElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJO1lBQzlDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0NBRTVELENBQUMsQ0FBQztBQWNILE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxHQUFHLENBQTRDO0lBQzVFLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNyQyxDQUFDLElBQUksRUFBRSxDQUFDLGVBQWUsRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDM0MsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxrQkFBa0IsRUFBRSxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFL0MsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUt0QyxDQUFDLElBQUksRUFBRSxDQUFDLGNBQWMsRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDaEQsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRWpDLENBQUMsSUFBSSxFQUFFLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBRzlDLENBQUMsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN4QyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDcEIsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3BCLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztDQUNyQixDQUFDLENBQUM7QUFFSCxTQUFTLENBQUMsQ0FBQyxDQUFTLEVBQUUsQ0FBUztJQUM3QixPQUFPLElBQUksS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3hELENBQUM7QUFFRCxNQUFNLEVBQUUsR0FBRyxDQUFDLGtCQUFrQixFQUFFLGdCQUFnQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7TWV0YXNjcmVlbn0gZnJvbSAnLi9tZXRhc2NyZWVuLmpzJztcbmltcG9ydCB7VGlsZUVmZmVjdHN9IGZyb20gJy4vdGlsZWVmZmVjdHMuanMnO1xuaW1wb3J0IHtUaWxlc2V0fSBmcm9tICcuL3RpbGVzZXQuanMnO1xuaW1wb3J0IHtJbml0aWFsLCBJbml0aWFsUHJvcHN9IGZyb20gJy4vdXRpbC5qcyc7XG5cbi8vIE5PVEU6IE11c3QgYmUgaW5pdGlhbGl6ZWQgQkVGT1JFIE1ldGFzY3JlZW5zXG5leHBvcnQgY2xhc3MgTWV0YXRpbGVzZXRzIHtcblxuICByZWFkb25seSBncmFzcyA9IHRoaXMuXygweDgwLCB7XG4gICAgcGF0dGVybnM6IFsweDAwLCAweDBjXSxcbiAgfSk7XG5cbiAgcmVhZG9ubHkgdG93biA9IHRoaXMuXygweDg0LCB7fSk7XG5cbiAgLy8gc3VwcG9ydHMgd2F0ZXIsIGJ1dCBoYXMgdWdseSB3YWxsXG4gIHJlYWRvbmx5IGNhdmUgPSB0aGlzLl8oMHg4OCwge30pO1xuXG4gIHJlYWRvbmx5IGRvbHBoaW5DYXZlID0gdGhpcy5fKDB4ODgsIHt9KTtcblxuICByZWFkb25seSBweXJhbWlkID0gdGhpcy5fKDB4OGMsIHt9KTtcblxuICByZWFkb25seSByaXZlciA9IHRoaXMuXygweDkwLCB7XG4gICAgYW5pbWF0ZWQ6IFswLCAxXSxcbiAgICBwYXR0ZXJuczogWzB4MTQsIDB4MDBdLCAvLyBUT0RPIC0gYW5pbWF0ZWQgY2xvYmJlcnMgMm5kIGVudHJ5IGFueXdheVxuICB9KTtcblxuICByZWFkb25seSBzZWEgPSB0aGlzLl8oMHg5NCwge30pOyAvLyBwcmltYXJpbHkgdGlsZXMgODAuLmZmXG5cbiAgLy8gcGFydHMgd2l0aCBcImZlYXR1cmVzXCI6IGFyY2hlcyBhbmQgaG91c2VzXG4gIHJlYWRvbmx5IG1vdW50YWluID0gdGhpcy5fKDB4OTQsIHt9KTsgLy8gcHJpbWFyaWx5IHRpbGVzIDAuLjVmXG5cbiAgLy8gTk9URTogZnJlZSBzcGFjZSBmcm9tIDkwLi5mZlxuICByZWFkb25seSBzaHJpbmUgPSB0aGlzLl8oMHg5OCwge30pO1xuXG4gIHJlYWRvbmx5IGRlc2VydCA9IHRoaXMuXygweDljLCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyA1MC4uZmZcblxuICAvLyB0cmFkZXMgZmVhdHVyZXMgZm9yIGNyb3NzYWJsZSByaXZlclxuICByZWFkb25seSBtb3VudGFpblJpdmVyID0gdGhpcy5fKDB4OWMsIHt9KTsgLy8gcHJpbWFyaWx5IHRpbGVzIDAwLi40ZlxuXG4gIHJlYWRvbmx5IHN3YW1wID0gdGhpcy5fKDB4YTAsIHt9KTsgLy8gdGlsZXMgYTAuLmZmXG5cbiAgcmVhZG9ubHkgaG91c2UgPSB0aGlzLl8oMHhhMCwge30pOyAvLyB0aWxlcyAwMC4uOWZcblxuICByZWFkb25seSBmb3J0cmVzcyA9IHRoaXMuXygweGE0LCB7fSk7XG5cbiAgLy8gdmFyaWFudCBvZiB0aGUgZm9ydHJlc3MgbWV0YXRpbGVzZXQsIGJ1dCBtYWtlcyB1c2Ugb2YgdGhlIHBhcmFwZXRzXG4gIHJlYWRvbmx5IGxhYnlyaW50aCA9IHRoaXMuXygweGE0LCB7fSk7XG5cbiAgLy8gc2FtZSBhcyA4OCwgYnV0IHRyYWRlcyByaXZlcnMgZm9yIHByZXR0aWVyIGljZSB3YWxsXG4gIHJlYWRvbmx5IGljZUNhdmUgPSB0aGlzLl8oMHhhOCwge30pO1xuXG4gIHJlYWRvbmx5IHRvd2VyID0gdGhpcy5fKDB4YWMsIHt9KTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJvbTogUm9tKSB7fVxuXG4gIHByaXZhdGUgXyhpZDogbnVtYmVyLCBvcHRzOiBNZXRhdGlsZXNldERhdGEpOiBNZXRhdGlsZXNldCAmIEluaXRpYWwge1xuICAgIHJldHVybiBuZXcgTWV0YXRpbGVzZXQodGhpcy5yb20sIGlkLCBvcHRzKSBhcyBNZXRhdGlsZXNldCAmIEluaXRpYWw7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgTWV0YXRpbGVzZXROYW1lcyA9IEluaXRpYWxQcm9wczxNZXRhdGlsZXNldHM+O1xuXG4vLyBNYXBwcGluZyBmcm9tIG1ldGF0aWxlIElEIHRvIHRpbGUgcXVhZHMgYW5kIHBhbGV0dGUgbnVtYmVyLlxuZXhwb3J0IGNsYXNzIE1ldGF0aWxlc2V0IHtcblxuICAvLyBUT0RPIC0gbWFpbnRhaW4gYW4gaW52YXJpYW50IE1hcDxzY3JlZW4taWQsIFNldDxNZXRhc2NyZWVuPj4sXG4gIC8vICAgICAgICB3aWxsIG5lZWQgdG8gbG9jayBkb3duIChtZXRhKXNjcmVlbiBJRCBmaWVsZCB0byBlbnN1cmVcbiAgLy8gICAgICAgIGludmFyaWFudCBpcyBrZXB0LlxuXG4gIC8vIFRPRE8gLSBwZXJtYW5lbnRseSBhdHRhY2ggYmVoYXZpb3JcbiAgLy8gU3RvcmUgbW9yZSBpbmZvcm1hdGlvbiwgc3VjaCBhcyBzY3JlZW4gdHlwZXMsIGVkZ2UgdHlwZXMsIGV0Yy5cbiAgLy8gTmFtZXMuLi5cbiAgLy8gRG9lcyBwYWxldHRlIGluZm8gYmVsb25nIGhlcmU/ICBNYXliZS4uLlxuXG4gIHJlYWRvbmx5IHNjcmVlbnMgPSBuZXcgU2V0PE1ldGFzY3JlZW4+KCk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20sXG4gICAgICAgICAgICAgIHJlYWRvbmx5IHRpbGVzZXRJZDogbnVtYmVyLFxuICAgICAgICAgICAgICByZWFkb25seSBkYXRhOiBNZXRhdGlsZXNldERhdGEpIHt9XG5cbiAgLy8gVE9ETyAtIGlzIHRoaXMgdW51c2VkP1xuICBnZXQgdGlsZXNldCgpOiBUaWxlc2V0IHtcbiAgICByZXR1cm4gdGhpcy5yb20udGlsZXNldHNbdGhpcy50aWxlc2V0SWRdO1xuICB9XG5cbiAgZWZmZWN0cygpOiBUaWxlRWZmZWN0cyB7XG4gICAgcmV0dXJuIHRoaXMucm9tLnRpbGVzZXRzW3RoaXMudGlsZXNldElkXS5lZmZlY3RzKCk7XG4gIH1cblxuICBnZXRUaWxlKGlkOiBudW1iZXIpOiBNZXRhdGlsZSB7XG4gICAgLy8gVE9ETyAtIGRvZXMgdGhpcyByYXRoZXIgYmVsb25nIGluIHRpbGVzZXQudHM/XG4gICAgcmV0dXJuIG5ldyBNZXRhdGlsZSh0aGlzLnRpbGVzZXQsIGlkKTtcbiAgfVxuXG4gIC8vIHBhc3NhZ2UodGlsZUlkOiBudW1iZXIsIHRpbGVFZmZlY3RzID0gdGhpcy5lZmZlY3RzKCkpOiBUZXJyYWluIHtcbiAgLy8gICBjb25zdCBlZmZlY3RzID0gdGlsZUVmZmVjdHMuZWZmZWN0cztcbiAgLy8gICAvLyBOb3RlOiBmb3IgdGhpcyBwdXJwb3NlLCBwaXRzIGNhbiBiZSB0cmF2ZXJzZWQgYmVjYXVzZSB0aGVyZSBzaG91bGQgYWx3YXlzXG4gIC8vICAgLy8gYmUgYSBwbGF0Zm9ybSBhY3Jvc3MgaXQuICBUaGUgZG9scGhpbiBjb3VudHMgYXMgZmx5aW5nLCBhbmQgd2UgaGF2ZVxuICAvLyAgIC8vIHNwZWNpYWwgbG9naWMgdG8gdHJhbnNsYXRlIHRoYXQuXG4gIC8vICAgY29uc3QgYml0cyA9IGVmZmVjdHNbdGlsZUlkXSAmIDB4MjY7XG4gIC8vICAgaWYgKCFiaXRzKSByZXR1cm4gUGFzc2FnZS5BTFdBWVM7XG4gIC8vICAgLy8gTm90ZTogdGhpcyB3aWxsIGxvc2UgdGhlIGZsaWdodCBiaXQgZnJvbSBhbmdyeSBzZWEgd2F0ZXJmYWxsLCBidXRcbiAgLy8gICAvLyB0aGF0J3MgcHJvYmFibHkgZmluZS5cbiAgLy8gICBpZiAoYml0cyAmIDB4MjApIHJldHVybiBQYXNzYWdlLlNMT1BFO1xuICAvLyAgIC8vIFRPRE8gLSByZXF1aXJlIHRoZSAweDA4IGJpdCBiZWZvcmUgY2hlY2tpbmcgYWx0ZXJuYXRlP1xuICAvLyAgIGlmICh0aWxlSWQgPCAweDIwICYmIHRoaXMuYWx0ZXJuYXRlc1t0aWxlSWRdICE9PSB0aWxlSWQpIHtcbiAgLy8gICAgIGNvbnN0IGFsdEJpdHMgPSBlZmZlY3RzW3RoaXMuYWx0ZXJuYXRlc1t0aWxlSWRdXSAmIDB4MjY7XG4gIC8vICAgICBpZiAoIWFsdEJpdHMpIHJldHVybiBQYXNzYWdlLkZMQUc7XG4gIC8vICAgfVxuICAvLyAgIGlmICghKGJpdHMgJiAweDA0KSkgcmV0dXJuIFBhc3NhZ2UuRkxZO1xuICAvLyAgIHJldHVybiBQYXNzYWdlLk5FVkVSO1xuICAvLyB9XG59XG5cbmV4cG9ydCBjbGFzcyBNZXRhdGlsZSB7XG4gIHByaXZhdGUgY29waWVkRnJvbSA9IC0xO1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSB0aWxlc2V0OiBUaWxlc2V0LCByZWFkb25seSBpZDogbnVtYmVyKSB7fVxuXG4gIC8vIGdldCB0b3BMZWZ0KCk6IG51bWJlciB7IHJldHVybiB0aGlzLnRpbGVzZXQudGlsZXNldC50aWxlc1swXVt0aGlzLmlkXTsgfVxuICAvLyBzZXQgdG9wTGVmdCh4OiBudW1iZXIpIHsgdGhpcy50aWxlc2V0LnRpbGVzZXQudGlsZXNbMF1bdGhpcy5pZF0gPSB4OyB9XG5cbiAgLy8gZ2V0IHRvcFJpZ2h0KCk6IG51bWJlciB7IHJldHVybiB0aGlzLnRpbGVzZXQudGlsZXNldC50aWxlc1sxXVt0aGlzLmlkXTsgfVxuICAvLyBzZXQgdG9wUmlnaHQoeDogbnVtYmVyKSB7IHRoaXMudGlsZXNldC50aWxlc2V0LnRpbGVzWzFdW3RoaXMuaWRdID0geDsgfVxuXG4gIC8vIGdldCBib3R0b21MZWZ0KCk6IG51bWJlciB7IHJldHVybiB0aGlzLnRpbGVzZXQudGlsZXNldC50aWxlc1syXVt0aGlzLmlkXTsgfVxuICAvLyBzZXQgYm90dG9tTGVmdCh4OiBudW1iZXIpIHsgdGhpcy50aWxlc2V0LnRpbGVzZXQudGlsZXNbMl1bdGhpcy5pZF0gPSB4OyB9XG5cbiAgLy8gZ2V0IGJvdHRvbVJpZ2h0KCk6IG51bWJlciB7IHJldHVybiB0aGlzLnRpbGVzZXQudGlsZXNldC50aWxlc1szXVt0aGlzLmlkXTsgfVxuICAvLyBzZXQgYm90dG9tUmlnaHQoeDogbnVtYmVyKSB7IHRoaXMudGlsZXNldC50aWxlc2V0LnRpbGVzWzNdW3RoaXMuaWRdID0geDsgfVxuXG4gIC8vIFRPRE8gLSBnZXR0ZXJzP1xuXG4gIGdldCB0aWxlcygpOiByZWFkb25seSBudW1iZXJbXSB7XG4gICAgcmV0dXJuIFswLCAxLCAyLCAzXS5tYXAoaSA9PiB0aGlzLnRpbGVzZXQudGlsZXNbaV1bdGhpcy5pZF0pO1xuICB9XG4gIHNldFRpbGVzKHRpbGVzOiBSZWFkb25seUFycmF5PG51bWJlcnx1bmRlZmluZWQ+KTogdGhpcyB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgIGNvbnN0IHRpbGUgPSB0aWxlc1tpXTtcbiAgICAgIGlmICh0aWxlICE9IG51bGwpIHRoaXMudGlsZXNldC50aWxlc1tpXVt0aGlzLmlkXSA9IHRpbGU7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZ2V0IGFsdGVybmF0aXZlKCk6IG51bWJlcnxudWxsIHtcbiAgICBjb25zdCBhbHQgPSB0aGlzLmlkIDwgMHgyMCA/IHRoaXMudGlsZXNldC5hbHRlcm5hdGVzW3RoaXMuaWRdIDogdGhpcy5pZDtcbiAgICByZXR1cm4gYWx0ICE9PSB0aGlzLmlkID8gYWx0IDogbnVsbDtcbiAgfVxuICBzZXRBbHRlcm5hdGl2ZSh0aWxlOiBudW1iZXJ8bnVsbCk6IHRoaXMge1xuICAgIGlmICh0aGlzLmlkID49IDB4MjApIHJldHVybiB0aGlzO1xuICAgIHRoaXMudGlsZXNldC5hbHRlcm5hdGVzW3RoaXMuaWRdID0gdGlsZSAhPSBudWxsID8gdGlsZSA6IHRoaXMuaWQ7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBnZXQgYXR0cnMoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy50aWxlc2V0LmF0dHJzW3RoaXMuaWRdO1xuICB9XG4gIHNldEF0dHJzKGF0dHJzOiBudW1iZXIpOiB0aGlzIHtcbiAgICB0aGlzLnRpbGVzZXQuYXR0cnNbdGhpcy5pZF0gPSBhdHRycztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGdldCBlZmZlY3RzKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMudGlsZXNldC5lZmZlY3RzKCkuZWZmZWN0c1t0aGlzLmlkXTtcbiAgfVxuICBzZXRFZmZlY3RzKGVmZmVjdHM6IG51bWJlcik6IHRoaXMge1xuICAgIHRoaXMudGlsZXNldC5lZmZlY3RzKCkuZWZmZWN0c1t0aGlzLmlkXSA9IGVmZmVjdHM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBjb3B5RnJvbShvdGhlcjogbnVtYmVyLCAuLi5zY3JlZW5zOiBNZXRhc2NyZWVuW10pOiB0aGlzIHtcbiAgICBjb25zdCB0aGF0ID0gbmV3IE1ldGF0aWxlKHRoaXMudGlsZXNldCwgb3RoZXIpO1xuICAgIHRoaXMuY29waWVkRnJvbSA9IG90aGVyO1xuICAgIHRoaXMuc2V0VGlsZXModGhhdC50aWxlcyk7XG4gICAgaWYgKCh0aGlzLmlkIHwgdGhhdC5pZCkgPCAweDIwKSB7XG4gICAgICB0aGlzLnNldEFsdGVybmF0aXZlKHRoYXQuYWx0ZXJuYXRpdmUpO1xuICAgIH1cbiAgICB0aGlzLnNldEF0dHJzKHRoYXQuYXR0cnMpO1xuICAgIHRoaXMuc2V0RWZmZWN0cyh0aGF0LmVmZmVjdHMpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcmVwbGFjZUluKC4uLnNjcmVlbnM6IE1ldGFzY3JlZW5bXSk6IHRoaXMge1xuICAgIGlmICh0aGlzLmNvcGllZEZyb20gPCAwKSB0aHJvdyBuZXcgRXJyb3IoYE11c3QgY29weUZyb20gZmlyc3QuYCk7XG4gICAgZm9yIChjb25zdCBzY3JlZW4gb2Ygc2NyZWVucykge1xuICAgICAgc2NyZWVuLnJlcGxhY2UodGhpcy5jb3BpZWRGcm9tLCB0aGlzLmlkKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbn1cblxuaW50ZXJmYWNlIE1ldGF0aWxlc2V0RGF0YSB7XG4gIHBhdHRlcm5zPzogcmVhZG9ubHkgW251bWJlciwgbnVtYmVyXTtcbiAgYW5pbWF0ZWQ/OiByZWFkb25seSBudW1iZXJbXTtcbn1cblxuLy8gY29uc3QgaW5kZXhlZFRpbGVzZXRzOiB7W25hbWU6IHN0cmluZ106IE1ldGF0aWxlc2V0RGF0YX0gPSBUSUxFU0VUUyBhcyBhbnk7XG5cbi8vIGFzc2VydFR5cGU8e1tuYW1lIGluIGtleW9mIHR5cGVvZiBUSUxFU0VUU106IE1ldGF0aWxlc2V0RGF0YX0+KFRJTEVTRVRTKTtcblxuLy8gTk9URTogVGhpcyBjb3VsZCBhdXRvbWF0aWNhbGx5IGNvbnZlcnQgdGhlIGFib3ZlIG5hbWVzIGludG9cbi8vIHByb3BlcnRpZXMgb24gZXhhY3RseSB0aGUgY29ycmVjdCB0aWxlc2V0cywgdGhvdWdoIHdlIGxpa2VseVxuLy8gd2FudCB0byBjaGFuZ2UgdGhlbSBkeW5hbWljYWxseSwgc28gaXQncyBtYXliZSBsZXNzIHJlbGV2YW50P1xuLy8gICAtIHRob3VnaCB3ZSBzaG91bGQgc2V0IHRoZW0gYWxsIHVwZnJvbnQsIGluY2x1ZGluZyB1bmF2YWlsYWJsZSBvbmVzLi4uXG4vLyBjb25zdCBYID0ge1xuLy8gICBhOiB7XG4vLyAgICAgZ3Jhc3M6IHRydWUsXG4vLyAgIH0sXG4vLyAgIGI6IHtcbi8vICAgICB0b3dlcjogdHJ1ZSxcbi8vICAgfSxcbi8vIH0gYXMgY29uc3Q7XG4vLyB0eXBlIFhUeXBlID0gdHlwZW9mIFg7XG4vLyB0eXBlIEZpbHRlcjE8VD4gPSB7W0sgaW4ga2V5b2YgWFR5cGVdOiBYVHlwZVtLXVsndGlsZXNldHMnXSBleHRlbmRzIFQgPyBudW1iZXIgOiBuZXZlcn07XG4vLyB0eXBlIEZpbHRlcjI8VD4gPSAoe1tQIGluIGtleW9mIFRdOiBUW1BdIGV4dGVuZHMgbmV2ZXIgPyBuZXZlciA6IFB9KVtrZXlvZiBUXTtcbi8vIHR5cGUgRmlsdGVyPFQ+ID0gUGljazxGaWx0ZXIxPFQ+LCBGaWx0ZXIyPEZpbHRlcjE8VD4+Pjtcbi8vIGludGVyZmFjZSBTIHtcbi8vICAgdG93ZXI6IEZpbHRlcjx7dG93ZXI6IHRydWV9Pjtcbi8vICAgZ3Jhc3M6IEZpbHRlcjx7Z3Jhc3M6IHRydWV9Pjtcbi8vIH1cbi8vIHR5cGUgRmlsdGVyPFQ+ID0ge1tLIGluIHR5cGVvZiBYXTogKHR5cGVvZiBYKVtLXSBleHRlbmRzIFQgPyBudW1iZXIgOiBuZXZlcjtcbi8vIGludGVyZmFjZSBTIHtcbi8vICAgdG93ZXI6IEZpbHRlcjx7dG93ZXI6IHRydWV9Pjtcbi8vICAgZ3Jhc3M6IEZpbHRlcjx7Z3Jhc3M6IHRydWV9Pjtcbi8vIH1cblxuLy8gZXhwb3J0IGVudW0gUGFzc2FnZSB7XG4vLyAgIEFMV0FZUyA9IDAsXG4vLyAgIFNMT1BFID0gMSxcbi8vICAgRkxBRyA9IDIsXG4vLyAgIEZMWSA9IDMsXG4vLyAgIE5FVkVSID0gNCxcbi8vIH1cblxuLy8gaW50ZXJmYWNlIFBhbGV0dGVIYW5kbGVyIHtcbi8vICAgZG9ub3I6IHN0cmluZ1tdO1xuLy8gICByZWNlaXZlcjogc3RyaW5nW107XG4vLyB9XG5cbi8vIGNvbnN0IE1BSU4gPSB7ZG9ub3I6IFsnbWFpbicsICd0cmltJ10sIHJlY2VpdmVyOiBbJ21haW4nXX07XG4vLyBjb25zdCBUUklNID0ge2Rvbm9yOiBbJ3RyaW0nXSwgcmVjZWl2ZXI6IFsndHJpbSddfTtcbi8vIGNvbnN0IE5PTkUgPSB7ZG9ub3I6IFtdLCByZWNlaXZlcjogW119O1xuY29uc3QgTk9ORSA9IDA7XG5jb25zdCBUUklNID0gMTtcbmNvbnN0IE1BSU4gPSAyO1xudHlwZSBQYWxldHRlSGFuZGxlciA9IG51bWJlcjtcblxudHlwZSBQYWxldHRlID0gcmVhZG9ubHkgW251bWJlciwgbnVtYmVyLCBudW1iZXIsIG51bWJlcl07XG50eXBlIFBhbGV0dGVWYWxpZGF0b3IgPSAocDA6IFBhbGV0dGUsIHAxOiBQYWxldHRlLCBwMjogUGFsZXR0ZSkgPT4gYm9vbGVhbjtcblxudHlwZSBQYWxldHRlU3BlYyA9IHJlYWRvbmx5IFtQYWxldHRlSGFuZGxlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUGFsZXR0ZUhhbmRsZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBhbGV0dGVIYW5kbGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQYWxldHRlVmFsaWRhdG9yP107XG5cbmV4cG9ydCBmdW5jdGlvbiBwYWxldHRlVHlwZXModGlsZXNldDogbnVtYmVyLCBsb2NhdGlvbjogbnVtYmVyKTogUGFsZXR0ZVNwZWMge1xuICAvLyBQdWxsIG91dCBhIGZldyBzcGVjaWFsLWNhc2UgbG9jYXRpb25zLlxuICAvLyBOT1RFOiB1bmRlcmdyb3VuZCBjYXZlcm4gJDY0IGhhcyBtaWRkbGUgZm9yIHdhdGVyLCBtdXN0IGJlICQxZlxuICBzd2l0Y2ggKGxvY2F0aW9uKSB7XG4gIGNhc2UgMHgxYTogLy8gdGlsZXNldCBhMCBzd2FtcFxuICAgIHJldHVybiBbTUFJTiwgTUFJTiwgVFJJTSwgKHAwLCBwMSwgcDIpID0+IHAwWzNdID09PSBwMVszXSAmJiBwMVszXSA9PT0gcDJbM11dO1xuICBjYXNlIDB4NDM6IC8vIHRpbGVzZXQgOTRcbiAgICByZXR1cm4gW01BSU4sIFRSSU0sIFRSSU1dO1xuICBjYXNlIDB4NTc6IC8vIHRpbGVldCA4OFxuICAgIC8vIGRvbid0IGluY2x1ZGUgdGhlIHdhdGVyIGluIHRoZSBub3JtYWwgcG9vbC4uLlxuICAgIHJldHVybiBbTUFJTiwgTk9ORSwgTk9ORV07XG4gIGNhc2UgMHg2MDogLy8gdGlsZXNldCA5NFxuICAgIHJldHVybiBbTUFJTiwgTUFJTiwgTUFJTiwgKHAwLCBfcDEsIHAyKSA9PiBwMFsyXSA9PT0gcDJbMl1dO1xuICBjYXNlIDB4NjQ6IGNhc2UgMHg2ODogLy8gdGlsZXNldCA4OFxuICAgIC8vIHNvbWUgd2F0ZXIgaW4gdGhpcyBjYXZlIHVzZXMgdGhlIEhVRCdzIHBhbGV0dGUgc28gZG9uJ3Qgc2h1ZmZsZSBpdFxuICAgIHJldHVybiBbTUFJTiwgTk9ORSwgVFJJTV07XG4gIGNhc2UgMHg3YzogLy8gdGlsZXNldCA5Y1xuICAgIHJldHVybiBbTUFJTiwgVFJJTSwgVFJJTV07XG4gIH1cblxuICBzd2l0Y2ggKHRpbGVzZXQpIHtcbiAgY2FzZSAweDgwOiBjYXNlIDB4ODQ6XG4gICAgcmV0dXJuIFtNQUlOLCBNQUlOLCBUUklNLCAocDAsIHAxKSA9PiBwMFszXSA9PT0gcDFbM11dO1xuICBjYXNlIDB4ODg6XG4gICAgcmV0dXJuIFtNQUlOLCBUUklNLCBOT05FXTtcbiAgY2FzZSAweDhjOiByZXR1cm4gW01BSU4sIFRSSU0sIE1BSU5dO1xuICBjYXNlIDB4OTA6IHJldHVybiBbTUFJTiwgTUFJTiwgTUFJTl07XG4gIGNhc2UgMHg5NDogcmV0dXJuIFtNQUlOLCBUUklNLCBUUklNLCAocDAsIHAxKSA9PiBwMFszXSA9PT0gcDFbM11dO1xuICBjYXNlIDB4OTg6IHJldHVybiBbVFJJTSwgVFJJTSwgVFJJTV07IC8vIFRPRE8gLSB2YWxpZGF0ZT8hP1xuICBjYXNlIDB4OWM6IHJldHVybiBbTUFJTiwgVFJJTSwgTUFJTl07XG4gIGNhc2UgMHhhMDogcmV0dXJuIFtUUklNLCBUUklNLCBUUklNXTtcbiAgY2FzZSAweGE0OiByZXR1cm4gW01BSU4sIE1BSU4sIFRSSU1dO1xuICBjYXNlIDB4YTg6IHJldHVybiBbTUFJTiwgTUFJTiwgVFJJTV07XG4gIGNhc2UgMHhhYzogcmV0dXJuIFtNQUlOLCBUUklNLCBNQUlOXTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYHVueHBlY3RlZDogJHt0aWxlc2V0fWApO1xufVxuLy8gICBbMHg5OCwgWydkb29yJywgJ3Jvb20nLCAncm9ja3MnXV0sIC8vIHNocmluZVxuLy8gICAvLyBOT1RFOiBoeWRyYSB2ZXJ5IGRpZmY6IChyb2NrL2dyb3VuZCwgYnJpZGdlLCByaXZlcilcbi8vICAgWzB4OWMsIFsnbW91bnRhaW4vZ3JvdW5kJywgJ3RyZWVzJywgJ2Rlc2VydCddXSxcbi8vICAgLy8gTk9URTogdGhpcyBpcyBzd2FtcCwgYnV0IGFsc28gaW5jbHVkZXMgYWxsIGluZG9vcnNcbi8vICAgLy8gYWxsIDMgbmVlZCBzYW1lIGJnIGZvciBzd2FtcFxuLy8gICBbMHhhMCwgWydncm91bmQnLCAndHJlZXMnLCAnc29tZSBoYXplJ11dLFxuLy8gICBbMHhhNCwgWycnLCAnJywgJyddXSwgLy8gZm9ydHJlc3Ncbi8vICAgWzB4YTgsIFsnJywgJycsICcnXV0sIC8vIGljZSBjYXZlXG4vLyAgIFsweGFjLCBbJycsICcnLCAnJ11dLCAvLyBlbmRnYW1lXG4vLyBdKTtcblxuY29uc3QgQUxMT1dFRF9QQUxFVFRFUyA9IG5ldyBNYXA8c3RyaW5nLCByZWFkb25seSBudW1iZXJbXT4oW1xuICBbJ3BhdGgnLCBbLi4ucigweDAwLCAweDEyKSwgLi4ucigweDE1LCAweDFiKSwgLi4ucigweDFlLCAweDI1KSxcbiAgICAgICAgICAgIC4uLnIoMHgyNiwgMHgyYiksIC4uLnIoMHgyYywgMHgzMCksIC4uLnIoMHgzOSwgMHgzZiksXG4gICAgICAgICAgICAweDQyLCAuLi5yKDB4NDQsIDB4NDgpLCAuLi5yKDB4NGQsIDB4NTkpLCAuLi5yKDB4ODAsIDB4ODQpLFxuICAgICAgICAgICAgMHg4NywgLi4ucigweDhiLCAweDkzKV1dLFxuICBbJ21vdW50YWluJywgWzB4MDEsIC4uLnIoMHgwMywgMHgwNyksIC4uLnIoMHgwOCwgMHgwYiksIDB4MGMsIDB4MGQsIDB4MGUsXG4gICAgICAgICAgICAgICAuLi5yKDB4MTEsIDB4MTgpLCAweDE5LCAweDFhLCAweDFjLCAweDFkLCAweDFlLCAweDIwLCAweDIxLFxuICAgICAgICAgICAgICAgMHgyMywgMHgyNywgMHgyYSwgMHgyYiwgMHgyZiwgMHgzMSwgMHgzMywgMHgzNiwgMHgzNywgMHgzOCxcbiAgICAgICAgICAgICAgIDB4MzksIDB4M2MsIDB4NDIsIDB4NDQsIDB4NDYsIDB4NGIsIDB4NGMsIDB4NGYsIDB4NTMsIDB4NTgsXG4gICAgICAgICAgICAgICAuLi5yKDB4ODAsIDB4ODUpLCAweDg3LCAweDg4LCAweDhiLCAweDhlXV0sXG4gIFsndHJlZXMnLCBbMHgwMSwgMHgwMiwgMHgwNCwgMHgwNiwgLi4ucigweDA3LCAweDBmKSwgLi4ucigweDE0LCAweDE4KSxcbiAgICAgICAgICAgICAweDFhLCAweDFjLCAweDFlLCAweDIwLCAweDIzLCAweDI3LCAweDI5LCAweDJhLCAweDJiLCAweDJlLFxuICAgICAgICAgICAgIDB4MmYsIDB4MzEsIDB4MzMsIDB4MzcsIDB4MzgsIDB4MzksIDB4M2MsIDB4M2QsIDB4NDMsIDB4NDQsXG4gICAgICAgICAgICAgMHg0NiwgMHg0OSwgMHg0YSwgMHg0YiwgMHg0ZiwgMHg1MiwgMHg1NywgMHg2ZSxcbiAgICAgICAgICAgICAuLi5yKDB4ODAsIDB4ODUpLCAweDg3LCAweDg4LCAuLi5yKDB4OGIsIDB4OTApXV0sXG5cbl0pO1xuXG4vLyBpbmZlciBjb25zdHJhaW50cz9cbi8vICAtIHRyZWF0IEJHIGNvbG9yIHNlcGFyYXRlbHlcbi8vICAgIC0gZmlndXJlIG91dCB3aGljaCBwYWxzIG9uIGEgbWFwIHNoYXJlIHNhbWUgYmdcbi8vICAgIC0ga2VlcCBibGFjayBvbmVzIGJsYWNrXG4vLyAgICAtIGtlZXAgbGlnaHQgb25lcyBsaWdodCwgZGFyayBvbmVzIGRhcms/XG4vLyAgLSBhbGwgc2hhcmVkIGNvbG9ycyBtb3ZlZCBpbiBsb2Nrc3RlcD9cbi8vICAtIGNhdGVnb3JpemUgaW5kaXZpZHVhbCBjb2xvcnM/XG4vLyAgICBsb29rIGF0IGhvdyBtdWNoIGlzIHVzZWQ/ICBubyBicmlnaHQgY29sb3JzIGZvciB2ZXJ5IGNvbW1vbj9cbi8vICBUT0RPIC0gZml4IHRoZSBuby1pY2UgQkcgZm9yIGh5ZHJhL3N0eHkvZ29hIGluIHRoZSB0aWxlc2V0XG5cbi8vIG5leHQgc3RlcCAtIG1ha2UgcGF0dGVybi9wYWxldHRlIHZpZXdlciAoZWRpdG9yPylcblxuY29uc3QgVEVSUkFJTl9CWV9QQUxFVFRFID0gbmV3IE1hcDxudW1iZXIsIHJlYWRvbmx5IFtzdHJpbmcsIHN0cmluZywgc3RyaW5nXT4oW1xuICBbMHg4MCwgWydwYXRoJywgJ21vdW50YWluJywgJ3RyZWVzJ11dLFxuICBbMHg4NCwgWydtb3VudGFpbi1wYXRoJywgJ2JyaWNrJywgJ3RyZWVzJ11dLFxuICBbMHg4OCwgWydjYXZlIHdhbGwvZ3JvdW5kJywgJ2NhdmUgYnJpZGdlJywgJyddXSxcbiAgLy8gTk9URTogdW5kZXJncm91bmQgY2F2ZXJuICQ2NCBoYXMgbWlkZGxlIGZvciB3YXRlciwgbXVzdCBiZSAkMWZcbiAgWzB4OGMsIFsnZmxvb3InLCAnZmlyZScsICdhY2NlcHQnXV0sXG4gIFsweDkwLCBbJ3RyZWVzJywgJ21vdW50YWluJywgJ2dyYXNzJ11dLFxuICAvLyBOT1RFOiAwIGFuZCAyIG5lZWQgc2FtZSBiYWNrZ3JvdW5kIGZvciBvY2VhblxuICAvLyBsaW1lIHRyZWUgaXMgdmVyeSBkaWZmZXJlbnQgdXNhZ2U6ICh3YXRlciwgdHJlZSB0cnVuaywgdHJlZXMpLlxuICAvLyBtb3VudGFpbnMgYWxzbyBkaWZmZXJlbnQgKHJvY2ssIHRyaW0gKG9uIDI4LzdjKSwgYnJpZGdlKVxuICAvLyBmb3IgbW91bnRhaW5zLCAwIGFuZCAxIGFyZSBzYW1lLWJnXG4gIFsweDk0LCBbJ3dhdGVyL2dyb3VuZCcsICdtb3VudGFpbicsICdzaGFsbG93cyddXSxcbiAgWzB4OTgsIFsnZG9vcicsICdyb29tJywgJ3JvY2tzJ11dLCAvLyBzaHJpbmVcbiAgLy8gTk9URTogaHlkcmEgdmVyeSBkaWZmOiAocm9jay9ncm91bmQsIGJyaWRnZSwgcml2ZXIpXG4gIFsweDljLCBbJ21vdW50YWluL2dyb3VuZCcsICd0cmVlcycsICdkZXNlcnQnXV0sXG4gIC8vIE5PVEU6IHRoaXMgaXMgc3dhbXAsIGJ1dCBhbHNvIGluY2x1ZGVzIGFsbCBpbmRvb3JzXG4gIC8vIGFsbCAzIG5lZWQgc2FtZSBiZyBmb3Igc3dhbXBcbiAgWzB4YTAsIFsnZ3JvdW5kJywgJ3RyZWVzJywgJ3NvbWUgaGF6ZSddXSxcbiAgWzB4YTQsIFsnJywgJycsICcnXV0sIC8vIGZvcnRyZXNzXG4gIFsweGE4LCBbJycsICcnLCAnJ11dLCAvLyBpY2UgY2F2ZVxuICBbMHhhYywgWycnLCAnJywgJyddXSwgLy8gZW5kZ2FtZVxuXSk7XG5cbmZ1bmN0aW9uIHIoYTogbnVtYmVyLCBiOiBudW1iZXIpOiByZWFkb25seSBudW1iZXJbXSB7XG4gIHJldHVybiBuZXcgQXJyYXkoYiAtIGEpLmZpbGwoMCkubWFwKChfeCwgaSkgPT4gaSArIGEpO1xufVxuXG5jb25zdCBbXSA9IFtURVJSQUlOX0JZX1BBTEVUVEUsIEFMTE9XRURfUEFMRVRURVNdO1xuIl19