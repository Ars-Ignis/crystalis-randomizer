import { DefaultMap } from '../util.js';
import { featureMask } from './metascreendata.js';
export class Metatilesets {
    constructor(rom) {
        this.rom = rom;
        this._all = [];
        this.grass = this.tileset(0x80, {
            patterns: [0x00, 0x0c],
        });
        this.town = this.tileset(0x84, {});
        this.cave = this.tileset(0x88, {});
        this.dolphinCave = this.tileset(0x88, {});
        this.pyramid = this.tileset(0x8c, {});
        this.river = this.tileset(0x90, {
            animated: [0, 1],
            patterns: [0x14, 0x00],
        });
        this.sea = this.tileset(0x94, {});
        this.lime = this.tileset(0x94, {});
        this.mountain = this.tileset(0x94, {});
        this.shrine = this.tileset(0x98, {});
        this.desert = this.tileset(0x9c, {});
        this.mountainRiver = this.tileset(0x9c, {});
        this.swamp = this.tileset(0xa0, {
            consolidated: true,
        });
        this.house = this.tileset(0xa0, {});
        this.fortress = this.tileset(0xa4, {});
        this.labyrinth = this.tileset(0xa4, {});
        this.iceCave = this.tileset(0xa8, {});
        this.tower = this.tileset(0xac, {});
        for (const key in this) {
            const value = this[key];
            if (value instanceof Metatileset)
                value.name = key;
        }
    }
    tileset(id, opts) {
        const ts = new Metatileset(this.rom, id, opts);
        this._all.push(ts);
        return ts;
    }
    [Symbol.iterator]() {
        return this._all[Symbol.iterator]();
    }
}
export class Metatileset {
    constructor(rom, tilesetId, data) {
        this.rom = rom;
        this.tilesetId = tilesetId;
        this.data = data;
        this._screens = new Set();
        this._cache = undefined;
    }
    [Symbol.iterator]() {
        return this._screens[Symbol.iterator]();
    }
    get cache() {
        if (!this._cache)
            this._cache = new NeighborCache(this);
        return this._cache;
    }
    get tileset() {
        return this.rom.tilesets[this.tilesetId];
    }
    get empty() {
        const e = this.cache.empty;
        if (!e)
            throw new Error(`No empty screen for ${this.name}`);
        return e;
    }
    effects() {
        return this.tileset.effects();
    }
    getTile(id) {
        return this.tileset.getTile(id);
    }
    addScreen(screen) {
        this._screens.add(screen);
        screen.unsafeAddTileset(this);
        this.invalidate();
    }
    deleteScreen(screen) {
        this._screens.delete(screen);
        screen.unsafeRemoveTileset(this);
        this.invalidate();
    }
    getMetascreens(screenId) {
        var _a;
        return (_a = this.cache.fromId.get(screenId)) !== null && _a !== void 0 ? _a : [];
    }
    getExits(type) {
        return this.cache.exits.get(type);
    }
    getMetascreensFromTileString(tile) {
        return this.cache.tiles.has(tile) ? this.cache.tiles.get(tile) : [];
    }
    getScreensWithOnlyFeatures(...features) {
        let mask = 0;
        for (const feature of features) {
            mask |= featureMask[feature];
        }
        const screens = [];
        for (const s of this) {
            if (!(s.features & ~mask))
                screens.push(s);
        }
        return screens;
    }
    withMod(tile, mod) {
        const out = [];
        for (const s of this.cache.tiles.get(tile)) {
            if (s.data.mod === mod)
                out.push(s);
        }
        return out;
    }
    isBannedVertical(above, below) {
        return this.cache.bannedNeighbors[0].has(above.uid << 16 | below.uid);
    }
    isBannedHorizontal(left, right) {
        return this.cache.bannedNeighbors[1].has(left.uid << 16 | right.uid);
    }
    invalidate() {
        this._cache = undefined;
    }
}
export var Dir;
(function (Dir) {
    Dir.N = 0;
    Dir.W = 1;
    Dir.S = 2;
    Dir.E = 3;
})(Dir || (Dir = {}));
class NeighborCache {
    constructor(tileset) {
        var _a, _b;
        this.tileset = tileset;
        this.fromId = new DefaultMap(() => []);
        this.exits = new DefaultMap(() => []);
        this.tiles = new DefaultMap(() => []);
        this.bannedNeighbors = [new Set(), new Set()];
        let empty = undefined;
        for (const s of tileset) {
            if (s.sid >= 0)
                this.fromId.get(s.sid).push(s);
            if (!empty &&
                s.data.edges === '    ' &&
                s.data.placement !== 'manual' &&
                s.hasFeature('empty') &&
                !((_a = s.data.exits) === null || _a === void 0 ? void 0 : _a.length)) {
                empty = s;
            }
            for (const exit of (_b = s.data.exits) !== null && _b !== void 0 ? _b : []) {
                this.exits.get(exit.type).push(s);
            }
            const tiles = typeof s.data.tile === 'string' ? [s.data.tile] : s.data.tile;
            for (const tile of tiles !== null && tiles !== void 0 ? tiles : []) {
                this.tiles.get(tile.replace(/\|/g, '')).push(s);
            }
            if (s.hasFeature('spikes') || s.hasFeature('ramp') ||
                s.hasFeature('overpass') || s.hasFeature('pit') ||
                s.isEmpty()) {
                this.banDeadEndNeighbor(s);
            }
            const ms = tileset.rom.metascreens;
            this.banDeadEndNeighbor(ms.branchNWE_wall, 1);
            this.banNeighbor(ms.deadEndS_stairs, ms.deadEndN_stairs, 2);
            this.banNeighbor(ms.deadEndNS_stairs, ms.deadEndN_stairs, 2);
            this.banNeighbor(ms.deadEndS_stairs, ms.deadEndNS_stairs, 2);
            this.banNeighbor(ms.deadEndNS_stairs, ms.deadEndNS_stairs, 2);
        }
        this.empty = empty !== null && empty !== void 0 ? empty : tileset.rom.metascreens.caveEmpty;
    }
    banDeadEndNeighbor(s, dirs = 15) {
        var _a, _b;
        for (const t of this.tileset) {
            if (!t.hasFeature('deadend'))
                continue;
            for (let dir = 0; dir < 4; dir++) {
                const mask = 1 << dir;
                if (!(dirs & mask))
                    continue;
                if (((_a = s.data.edges) === null || _a === void 0 ? void 0 : _a[dir]) !== ' ' && ((_b = t.data.edges) === null || _b === void 0 ? void 0 : _b[dir ^ 2]) !== ' ') {
                    this.banNeighbor(s, t, dir);
                }
            }
        }
    }
    banNeighbor(s, t, dir) {
        this.bannedNeighbors[dir & 1]
            .add((dir & 2 ? s : t).uid << 16 | (dir & 2 ? t : s).uid);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXRpbGVzZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL21ldGF0aWxlc2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUEwQixXQUFXLEVBQ3JCLE1BQU0scUJBQXFCLENBQUM7QUFHbkQsTUFBTSxPQUFPLFlBQVk7SUFxRHZCLFlBQTZCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBbkQ3QixTQUFJLEdBQWtCLEVBQUUsQ0FBQztRQUV4QixVQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFDbEMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztTQUN2QixDQUFDLENBQUM7UUFFTSxTQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFHOUIsU0FBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTlCLGdCQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFckMsWUFBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpDLFVBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtZQUNsQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hCLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7U0FDdkIsQ0FBQyxDQUFDO1FBRU0sUUFBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTdCLFNBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxF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MENBQUcsR0FBRyxHQUFHLENBQUMsT0FBTSxHQUFHLEVBQUU7b0JBQ2xFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztpQkFDN0I7YUFDRjtTQUNGO0lBQ0gsQ0FBQztJQUVELFdBQVcsQ0FBQyxDQUFhLEVBQUUsQ0FBYSxFQUFFLEdBQVc7UUFDbkQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO2FBQ3hCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLEVBQUUsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEUsQ0FBQztDQVFGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge01ldGFzY3JlZW59IGZyb20gJy4vbWV0YXNjcmVlbi5qcyc7XG5pbXBvcnQge01ldGF0aWxlfSBmcm9tICcuL21ldGF0aWxlLmpzJztcbmltcG9ydCB7VGlsZUVmZmVjdHN9IGZyb20gJy4vdGlsZWVmZmVjdHMuanMnO1xuaW1wb3J0IHtUaWxlc2V0fSBmcm9tICcuL3RpbGVzZXQuanMnO1xuaW1wb3J0IHtEZWZhdWx0TWFwfSBmcm9tICcuLi91dGlsLmpzJztcbmltcG9ydCB7Q29ubmVjdGlvblR5cGUsIEZlYXR1cmUsIGZlYXR1cmVNYXNrLFxuICAgICAgICBNZXRhc2NyZWVuRGF0YX0gZnJvbSAnLi9tZXRhc2NyZWVuZGF0YS5qcyc7XG5cbi8vIE5PVEU6IE11c3QgYmUgaW5pdGlhbGl6ZWQgQkVGT1JFIE1ldGFzY3JlZW5zXG5leHBvcnQgY2xhc3MgTWV0YXRpbGVzZXRzIGltcGxlbWVudHMgSXRlcmFibGU8TWV0YXRpbGVzZXQ+IHtcblxuICBwcml2YXRlIF9hbGw6IE1ldGF0aWxlc2V0W10gPSBbXTtcblxuICByZWFkb25seSBncmFzcyA9IHRoaXMudGlsZXNldCgweDgwLCB7XG4gICAgcGF0dGVybnM6IFsweDAwLCAweDBjXSxcbiAgfSk7XG5cbiAgcmVhZG9ubHkgdG93biA9IHRoaXMudGlsZXNldCgweDg0LCB7fSk7XG5cbiAgLy8gc3VwcG9ydHMgd2F0ZXIsIGJ1dCBoYXMgdWdseSB3YWxsXG4gIHJlYWRvbmx5IGNhdmUgPSB0aGlzLnRpbGVzZXQoMHg4OCwge30pO1xuXG4gIHJlYWRvbmx5IGRvbHBoaW5DYXZlID0gdGhpcy50aWxlc2V0KDB4ODgsIHt9KTtcblxuICByZWFkb25seSBweXJhbWlkID0gdGhpcy50aWxlc2V0KDB4OGMsIHt9KTtcblxuICByZWFkb25seSByaXZlciA9IHRoaXMudGlsZXNldCgweDkwLCB7XG4gICAgYW5pbWF0ZWQ6IFswLCAxXSxcbiAgICBwYXR0ZXJuczogWzB4MTQsIDB4MDBdLCAvLyBUT0RPIC0gYW5pbWF0ZWQgY2xvYmJlcnMgMm5kIGVudHJ5IGFueXdheVxuICB9KTtcblxuICByZWFkb25seSBzZWEgPSB0aGlzLnRpbGVzZXQoMHg5NCwge30pOyAvLyBwcmltYXJpbHkgdGlsZXMgODAuLmZmXG5cbiAgcmVhZG9ubHkgbGltZSA9IHRoaXMudGlsZXNldCgweDk0LCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyA2MC4uN2ZcblxuICAvLyBwYXJ0cyB3aXRoIFwiZmVhdHVyZXNcIjogYXJjaGVzIGFuZCBob3VzZXNcbiAgcmVhZG9ubHkgbW91bnRhaW4gPSB0aGlzLnRpbGVzZXQoMHg5NCwge30pOyAvLyBwcmltYXJpbHkgdGlsZXMgMC4uNWZcblxuICAvLyBOT1RFOiBmcmVlIHNwYWNlIGZyb20gOTAuLmZmXG4gIHJlYWRvbmx5IHNocmluZSA9IHRoaXMudGlsZXNldCgweDk4LCB7fSk7XG5cbiAgcmVhZG9ubHkgZGVzZXJ0ID0gdGhpcy50aWxlc2V0KDB4OWMsIHt9KTsgLy8gcHJpbWFyaWx5IHRpbGVzIDUwLi5mZlxuXG4gIC8vIHRyYWRlcyBmZWF0dXJlcyBmb3IgY3Jvc3NhYmxlIHJpdmVyXG4gIHJlYWRvbmx5IG1vdW50YWluUml2ZXIgPSB0aGlzLnRpbGVzZXQoMHg5Yywge30pOyAvLyBwcmltYXJpbHkgdGlsZXMgMDAuLjRmXG5cbiAgcmVhZG9ubHkgc3dhbXAgPSB0aGlzLnRpbGVzZXQoMHhhMCwge1xuICAgIGNvbnNvbGlkYXRlZDogdHJ1ZSxcbiAgfSk7IC8vIHRpbGVzIGEwLi5mZlxuXG4gIHJlYWRvbmx5IGhvdXNlID0gdGhpcy50aWxlc2V0KDB4YTAsIHt9KTsgLy8gdGlsZXMgMDAuLjlmXG5cbiAgcmVhZG9ubHkgZm9ydHJlc3MgPSB0aGlzLnRpbGVzZXQoMHhhNCwge30pO1xuXG4gIC8vIHZhcmlhbnQgb2YgdGhlIGZvcnRyZXNzIG1ldGF0aWxlc2V0LCBidXQgbWFrZXMgdXNlIG9mIHRoZSBwYXJhcGV0c1xuICByZWFkb25seSBsYWJ5cmludGggPSB0aGlzLnRpbGVzZXQoMHhhNCwge30pO1xuXG4gIC8vIHNhbWUgYXMgODgsIGJ1dCB0cmFkZXMgcml2ZXJzIGZvciBwcmV0dGllciBpY2Ugd2FsbFxuICByZWFkb25seSBpY2VDYXZlID0gdGhpcy50aWxlc2V0KDB4YTgsIHt9KTtcblxuICByZWFkb25seSB0b3dlciA9IHRoaXMudGlsZXNldCgweGFjLCB7fSk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSByb206IFJvbSkge1xuICAgIC8vIFRhZyBuYW1lcyBmb3IgZGVidWdnaW5nLi4uXG4gICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcyBhcyBvYmplY3QpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gKHRoaXMgYXMgYW55KVtrZXldIGFzIHVua25vd247XG4gICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBNZXRhdGlsZXNldCkgdmFsdWUubmFtZSA9IGtleTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRpbGVzZXQoaWQ6IG51bWJlciwgb3B0czogTWV0YXRpbGVzZXREYXRhKTogTWV0YXRpbGVzZXQge1xuICAgIGNvbnN0IHRzID0gbmV3IE1ldGF0aWxlc2V0KHRoaXMucm9tLCBpZCwgb3B0cyk7XG4gICAgdGhpcy5fYWxsLnB1c2godHMpO1xuICAgIHJldHVybiB0cztcbiAgfVxuXG4gIFtTeW1ib2wuaXRlcmF0b3JdKCkge1xuICAgIHJldHVybiB0aGlzLl9hbGxbU3ltYm9sLml0ZXJhdG9yXSgpO1xuICB9XG59XG5cbi8vIE1hcHBwaW5nIGZyb20gbWV0YXRpbGUgSUQgdG8gdGlsZSBxdWFkcyBhbmQgcGFsZXR0ZSBudW1iZXIuXG5leHBvcnQgY2xhc3MgTWV0YXRpbGVzZXQgaW1wbGVtZW50cyBJdGVyYWJsZTxNZXRhc2NyZWVuPiB7XG5cbiAgLy8gVE9ETyAtIG1haW50YWluIGFuIGludmFyaWFudCBNYXA8c2NyZWVuLWlkLCBTZXQ8TWV0YXNjcmVlbj4+LFxuICAvLyAgICAgICAgd2lsbCBuZWVkIHRvIGxvY2sgZG93biAobWV0YSlzY3JlZW4gSUQgZmllbGQgdG8gZW5zdXJlXG4gIC8vICAgICAgICBpbnZhcmlhbnQgaXMga2VwdC5cblxuICAvLyBUT0RPIC0gcGVybWFuZW50bHkgYXR0YWNoIGJlaGF2aW9yXG4gIC8vIFN0b3JlIG1vcmUgaW5mb3JtYXRpb24sIHN1Y2ggYXMgc2NyZWVuIHR5cGVzLCBlZGdlIHR5cGVzLCBldGMuXG4gIC8vIE5hbWVzLi4uXG4gIC8vIERvZXMgcGFsZXR0ZSBpbmZvIGJlbG9uZyBoZXJlPyAgTWF5YmUuLi5cblxuICBuYW1lPzogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IF9zY3JlZW5zID0gbmV3IFNldDxNZXRhc2NyZWVuPigpO1xuICBwcml2YXRlIF9jYWNoZT86IE5laWdoYm9yQ2FjaGUgPSB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20sXG4gICAgICAgICAgICAgIHJlYWRvbmx5IHRpbGVzZXRJZDogbnVtYmVyLFxuICAgICAgICAgICAgICByZWFkb25seSBkYXRhOiBNZXRhdGlsZXNldERhdGEpIHt9XG5cbiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NjcmVlbnNbU3ltYm9sLml0ZXJhdG9yXSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgY2FjaGUoKTogTmVpZ2hib3JDYWNoZSB7XG4gICAgaWYgKCF0aGlzLl9jYWNoZSkgdGhpcy5fY2FjaGUgPSBuZXcgTmVpZ2hib3JDYWNoZSh0aGlzKTtcbiAgICByZXR1cm4gdGhpcy5fY2FjaGU7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdW5kZXJseWluZyBwaHlzaWNhbCB0aWxlc2V0LiAgTXVsdGlwbGUgTWV0YXRpbGVzZXRzXG4gICAqIG1heSBzaGFyZSB0aGUgc2FtZSBwaHlzaWNhbCB0aWxlc2V0LlxuICAgKi9cbiAgZ2V0IHRpbGVzZXQoKTogVGlsZXNldCB7XG4gICAgcmV0dXJuIHRoaXMucm9tLnRpbGVzZXRzW3RoaXMudGlsZXNldElkXTtcbiAgfVxuXG4gIGdldCBlbXB0eSgpOiBNZXRhc2NyZWVuIHtcbiAgICBjb25zdCBlID0gdGhpcy5jYWNoZS5lbXB0eTtcbiAgICBpZiAoIWUpIHRocm93IG5ldyBFcnJvcihgTm8gZW1wdHkgc2NyZWVuIGZvciAke3RoaXMubmFtZX1gKTtcbiAgICByZXR1cm4gZTtcbiAgfVxuXG4gIC8vIFRPRE8gLSB1c2UgRU1QVFkgYXMgYSBib3JkZXIgc3F1YXJlLi4uIGFsc28gbmVlZFxuICAvLyBhbiBFWElUIGJvcmRlciBzcXVhcmU/ICBIb3cgdG8gbGluayB0aGlzIGludG9cbiAgLy8gXCJhbGxvd2VkXCI/ICBuZWVkcyB0byBsaW5rIHRvIGNoZWNrIGV4aXRzIG9uIGVkZ2UuXG4gIC8vICAgLSBzbyBzdGlsbCBwcm9iYWJseSB3YW50IGFuIEVYSVQgbWV0YXNjcmVlbj9cblxuICBlZmZlY3RzKCk6IFRpbGVFZmZlY3RzIHtcbiAgICByZXR1cm4gdGhpcy50aWxlc2V0LmVmZmVjdHMoKTtcbiAgfVxuXG4gIC8vIEZvcndhcmQgdG8gdGhlIHVuZGVybHlpbmcgVGlsZXNldC5cbiAgZ2V0VGlsZShpZDogbnVtYmVyKTogTWV0YXRpbGUge1xuICAgIHJldHVybiB0aGlzLnRpbGVzZXQuZ2V0VGlsZShpZCk7XG4gIH1cblxuICBhZGRTY3JlZW4oc2NyZWVuOiBNZXRhc2NyZWVuKSB7XG4gICAgdGhpcy5fc2NyZWVucy5hZGQoc2NyZWVuKTtcbiAgICBzY3JlZW4udW5zYWZlQWRkVGlsZXNldCh0aGlzKTtcbiAgICB0aGlzLmludmFsaWRhdGUoKTtcbiAgfVxuXG4gIGRlbGV0ZVNjcmVlbihzY3JlZW46IE1ldGFzY3JlZW4pIHtcbiAgICB0aGlzLl9zY3JlZW5zLmRlbGV0ZShzY3JlZW4pO1xuICAgIHNjcmVlbi51bnNhZmVSZW1vdmVUaWxlc2V0KHRoaXMpO1xuICAgIHRoaXMuaW52YWxpZGF0ZSgpO1xuICB9XG5cbiAgZ2V0TWV0YXNjcmVlbnMoc2NyZWVuSWQ6IG51bWJlcik6IFJlYWRvbmx5QXJyYXk8TWV0YXNjcmVlbj4ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLmZyb21JZC5nZXQoc2NyZWVuSWQpID8/IFtdO1xuICB9XG5cbiAgZ2V0RXhpdHModHlwZTogQ29ubmVjdGlvblR5cGUpOiBSZWFkb25seUFycmF5PE1ldGFzY3JlZW4+IHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5leGl0cy5nZXQodHlwZSk7XG4gIH1cblxuICBnZXRNZXRhc2NyZWVuc0Zyb21UaWxlU3RyaW5nKHRpbGU6IHN0cmluZyk6IHJlYWRvbmx5IE1ldGFzY3JlZW5bXSB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUudGlsZXMuaGFzKHRpbGUpID8gdGhpcy5jYWNoZS50aWxlcy5nZXQodGlsZSkgOiBbXTtcbiAgfVxuXG4gIGdldFNjcmVlbnNXaXRoT25seUZlYXR1cmVzKC4uLmZlYXR1cmVzOiBGZWF0dXJlW10pOiBNZXRhc2NyZWVuW10ge1xuICAgIGxldCBtYXNrID0gMDtcbiAgICBmb3IgKGNvbnN0IGZlYXR1cmUgb2YgZmVhdHVyZXMpIHtcbiAgICAgIG1hc2sgfD0gZmVhdHVyZU1hc2tbZmVhdHVyZV07XG4gICAgfVxuICAgIGNvbnN0IHNjcmVlbnM6IE1ldGFzY3JlZW5bXSA9IFtdO1xuICAgIGZvciAoY29uc3QgcyBvZiB0aGlzKSB7XG4gICAgICBpZiAoIShzLmZlYXR1cmVzICYgfm1hc2spKSBzY3JlZW5zLnB1c2gocyk7XG4gICAgfVxuICAgIHJldHVybiBzY3JlZW5zO1xuICB9XG5cbiAgd2l0aE1vZCh0aWxlOiBzdHJpbmcsIG1vZDogTWV0YXNjcmVlbkRhdGFbJ21vZCddKTogTWV0YXNjcmVlbltdIHtcbiAgICBjb25zdCBvdXQ6IE1ldGFzY3JlZW5bXSA9IFtdO1xuICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLmNhY2hlLnRpbGVzLmdldCh0aWxlKSkge1xuICAgICAgaWYgKHMuZGF0YS5tb2QgPT09IG1vZCkgb3V0LnB1c2gocyk7XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBpc0Jhbm5lZFZlcnRpY2FsKGFib3ZlOiBNZXRhc2NyZWVuLCBiZWxvdzogTWV0YXNjcmVlbik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLmJhbm5lZE5laWdoYm9yc1swXS5oYXMoYWJvdmUudWlkIDw8IDE2IHwgYmVsb3cudWlkKTtcbiAgfVxuXG4gIGlzQmFubmVkSG9yaXpvbnRhbChsZWZ0OiBNZXRhc2NyZWVuLCByaWdodDogTWV0YXNjcmVlbik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLmJhbm5lZE5laWdoYm9yc1sxXS5oYXMobGVmdC51aWQgPDwgMTYgfCByaWdodC51aWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEludmFsaWRhdGUgdGhlIG5laWdoYm9yIGNhY2hlLiAgVGhpcyBpcyBuZWNlc3NhcnkgYW55IHRpbWUgdGhlXG4gICAqIHNjcmVlbnMgY2hhbmdlLlxuICAgKi9cbiAgaW52YWxpZGF0ZSgpIHtcbiAgICB0aGlzLl9jYWNoZSA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8vIGNoZWNrKHMxOiBVaWQsIHMyOiBVaWQsIGRlbHRhOiBudW1iZXIpOiBib29sZWFuIHtcbiAgLy8gICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGUuYWxsb3dlZFtkZWx0YSAmIDFdOyAgLy8gdmVydGljYWwgPSAwLCBob3JpeiA9IDFcbiAgLy8gICBjb25zdCBpbmRleCA9IGRlbHRhID4gMCA/IHMxIDw8IDE2IHwgczIgOiBzMiA8PCAxNiB8IHMxO1xuICAvLyAgIHJldHVybiBjYWNoZS5oYXMoaW5kZXgpO1xuICAvLyB9XG59XG5cbmludGVyZmFjZSBNZXRhdGlsZXNldERhdGEge1xuICBwYXR0ZXJucz86IHJlYWRvbmx5IFtudW1iZXIsIG51bWJlcl07XG4gIGFuaW1hdGVkPzogcmVhZG9ubHkgbnVtYmVyW107XG4gIGNvbnNvbGlkYXRlZD86IGJvb2xlYW47XG59XG5cbi8vIGNvbnN0IEVNUFRZX1NFVDogU2V0PGFueT4gPSBuZXcgY2xhc3MgZXh0ZW5kcyBTZXQge1xuLy8gICBhZGQoKTogdGhpcyB7IHRocm93IG5ldyBFcnJvcigpOyB9XG4vLyB9XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFNwZWNpYWxpemVkIGNhY2hlIG9mIG5laWdoYm9ycy9yZWxhdGlvbnNoaXBzIGluIGEgdGlsZXNldC5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiBcbmV4cG9ydCB0eXBlIERpciA9IDB8MXwyfDM7XG5cbmV4cG9ydCBuYW1lc3BhY2UgRGlyIHtcbiAgZXhwb3J0IGNvbnN0IE46IERpciA9IDA7XG4gIGV4cG9ydCBjb25zdCBXOiBEaXIgPSAxO1xuICBleHBvcnQgY29uc3QgUzogRGlyID0gMjtcbiAgZXhwb3J0IGNvbnN0IEU6IERpciA9IDM7XG59XG5cbmNsYXNzIE5laWdoYm9yQ2FjaGUge1xuICAvLyBbdmVydGljYWwsIGhvcml6b250YWxdLCBpbmRleGVkIGJ5IGRpciAmIDFcbiAgLy8gcmVhZG9ubHkgYWxsb3dlZCA9IFtuZXcgU2V0PFVpZFBhaXI+KCksIG5ldyBTZXQ8VWlkUGFpcj4oKV0gYXMgY29uc3Q7XG4gIC8vIHJlYWRvbmx5IG5laWdoYm9ycyA9IG5ldyBEZWZhdWx0TWFwPFVpZERpciwgU2V0PFVpZD4+KCgpID0+IG5ldyBTZXQoKSk7XG4gIHJlYWRvbmx5IGZyb21JZCA9IG5ldyBEZWZhdWx0TWFwPG51bWJlciwgTWV0YXNjcmVlbltdPigoKSA9PiBbXSk7XG4gIHJlYWRvbmx5IGV4aXRzID0gbmV3IERlZmF1bHRNYXA8Q29ubmVjdGlvblR5cGUsIE1ldGFzY3JlZW5bXT4oKCkgPT4gW10pO1xuICByZWFkb25seSBlbXB0eTogTWV0YXNjcmVlbjtcbiAgcmVhZG9ubHkgdGlsZXMgPSBuZXcgRGVmYXVsdE1hcDxzdHJpbmcsIE1ldGFzY3JlZW5bXT4oKCkgPT4gW10pO1xuICAvLyBhYm92ZSA8PCAxNiB8IGJlbG93LCBsZWZ0IDw8IDE2IHwgcmlnaHRcbiAgcmVhZG9ubHkgYmFubmVkTmVpZ2hib3JzID0gW25ldyBTZXQ8bnVtYmVyPigpLCBuZXcgU2V0PG51bWJlcj4oKV07XG4gIC8vIHByaXZhdGUgcmVhZG9ubHkgdG9nZ2xlcyA9IG5ldyBEZWZhdWx0TWFwPFVpZERpciwgU2V0PFVpZD4+KCgpID0+IG5ldyBTZXQpO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHRpbGVzZXQ6IE1ldGF0aWxlc2V0KSB7XG4gICAgbGV0IGVtcHR5OiBNZXRhc2NyZWVufHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICBmb3IgKGNvbnN0IHMgb2YgdGlsZXNldCkge1xuICAgICAgLy8gUmVnaXN0ZXIgaW4gdGhlIGZyb21JZCBtdWx0aW1hcFxuICAgICAgaWYgKHMuc2lkID49IDApIHRoaXMuZnJvbUlkLmdldChzLnNpZCkucHVzaChzKTtcbiAgICAgIC8vIENoZWNrIGZvciBlbXB0eVxuICAgICAgaWYgKCFlbXB0eSAmJlxuICAgICAgICAgIHMuZGF0YS5lZGdlcyA9PT0gJyAgICAnICYmXG4gICAgICAgICAgcy5kYXRhLnBsYWNlbWVudCAhPT0gJ21hbnVhbCcgJiZcbiAgICAgICAgICBzLmhhc0ZlYXR1cmUoJ2VtcHR5JykgJiZcbiAgICAgICAgICAhcy5kYXRhLmV4aXRzPy5sZW5ndGgpIHtcbiAgICAgICAgZW1wdHkgPSBzO1xuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBleGl0IG9mIHMuZGF0YS5leGl0cyA/PyBbXSkge1xuICAgICAgICB0aGlzLmV4aXRzLmdldChleGl0LnR5cGUpLnB1c2gocyk7XG4gICAgICB9XG4gICAgICAvLyBBZGQgdG8gdGlsZXNcbiAgICAgIGNvbnN0IHRpbGVzID1cbiAgICAgICAgICB0eXBlb2Ygcy5kYXRhLnRpbGUgPT09ICdzdHJpbmcnID8gW3MuZGF0YS50aWxlXSA6IHMuZGF0YS50aWxlO1xuICAgICAgZm9yIChjb25zdCB0aWxlIG9mIHRpbGVzID8/IFtdKSB7XG4gICAgICAgIHRoaXMudGlsZXMuZ2V0KHRpbGUucmVwbGFjZSgvXFx8L2csICcnKSkucHVzaChzKTtcbiAgICAgIH1cbiAgICAgIC8vIENoZWNrIGZvciBiYW5uZWQgdmVydGljYWxzXG4gICAgICBpZiAocy5oYXNGZWF0dXJlKCdzcGlrZXMnKSB8fCBzLmhhc0ZlYXR1cmUoJ3JhbXAnKSB8fFxuICAgICAgICAgIHMuaGFzRmVhdHVyZSgnb3ZlcnBhc3MnKSB8fCBzLmhhc0ZlYXR1cmUoJ3BpdCcpIHx8XG4gICAgICAgICAgcy5pc0VtcHR5KCkpIHtcbiAgICAgICAgdGhpcy5iYW5EZWFkRW5kTmVpZ2hib3Iocyk7XG4gICAgICB9XG4gICAgICAvLyBBZGQgYSBidW5jaCBvZiBmaXhlZCBiYW5zXG4gICAgICBjb25zdCBtcyA9IHRpbGVzZXQucm9tLm1ldGFzY3JlZW5zO1xuICAgICAgdGhpcy5iYW5EZWFkRW5kTmVpZ2hib3IobXMuYnJhbmNoTldFX3dhbGwsIDEpO1xuICAgICAgdGhpcy5iYW5OZWlnaGJvcihtcy5kZWFkRW5kU19zdGFpcnMsIG1zLmRlYWRFbmROX3N0YWlycywgMik7XG4gICAgICB0aGlzLmJhbk5laWdoYm9yKG1zLmRlYWRFbmROU19zdGFpcnMsIG1zLmRlYWRFbmROX3N0YWlycywgMik7XG4gICAgICB0aGlzLmJhbk5laWdoYm9yKG1zLmRlYWRFbmRTX3N0YWlycywgbXMuZGVhZEVuZE5TX3N0YWlycywgMik7XG4gICAgICB0aGlzLmJhbk5laWdoYm9yKG1zLmRlYWRFbmROU19zdGFpcnMsIG1zLmRlYWRFbmROU19zdGFpcnMsIDIpO1xuICAgIH1cbiAgICB0aGlzLmVtcHR5ID0gZW1wdHkgPz8gdGlsZXNldC5yb20ubWV0YXNjcmVlbnMuY2F2ZUVtcHR5O1xuICB9XG5cbiAgYmFuRGVhZEVuZE5laWdoYm9yKHM6IE1ldGFzY3JlZW4sIGRpcnMgPSAxNSkge1xuICAgIGZvciAoY29uc3QgdCBvZiB0aGlzLnRpbGVzZXQpIHtcbiAgICAgIGlmICghdC5oYXNGZWF0dXJlKCdkZWFkZW5kJykpIGNvbnRpbnVlO1xuICAgICAgZm9yIChsZXQgZGlyID0gMDsgZGlyIDwgNDsgZGlyKyspIHtcbiAgICAgICAgY29uc3QgbWFzayA9IDEgPDwgZGlyO1xuICAgICAgICBpZiAoIShkaXJzICYgbWFzaykpIGNvbnRpbnVlO1xuICAgICAgICBpZiAocy5kYXRhLmVkZ2VzPy5bZGlyXSAhPT0gJyAnICYmIHQuZGF0YS5lZGdlcz8uW2RpciBeIDJdICE9PSAnICcpIHtcbiAgICAgICAgICB0aGlzLmJhbk5laWdoYm9yKHMsIHQsIGRpcik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBiYW5OZWlnaGJvcihzOiBNZXRhc2NyZWVuLCB0OiBNZXRhc2NyZWVuLCBkaXI6IG51bWJlcikge1xuICAgIHRoaXMuYmFubmVkTmVpZ2hib3JzW2RpciAmIDFdXG4gICAgICAgIC5hZGQoKGRpciAmIDIgPyBzIDogdCkudWlkIDw8IDE2IHwgKGRpciAmIDIgPyB0IDogcykudWlkKTtcbiAgfVxuXG4gIC8vIFRPRE8gLSB3aGF0IHRvIGRvIHdpdGggYm9yZGVycz8hPyBDYW4gd2UgdHJlYXQgdGhlbSBsaWtlIGEgc2NyZWVuP1xuICAvLyBUaGUgbWFpbiB0aGluZyB0aGF0IG1hdHRlcnMgZm9yIGJvcmRlcnMgaXMgd2hldGhlciBpdCdzIGFuIGVkZ2UgZXhpdFxuICAvLyBvciBub3QuICBXZSBjYW4gYWxyZWFkeSB0cmFjayB0aGlzIGEgYml0IC0gd2UgY291bGQgaGF2ZSBhIGxpc3Qgb2ZcbiAgLy8gYWNjZXB0YWJsZSBlZGdlIHR5cGVzIGZvciBlYWNoIHRpbGVzZXQgLSBcIiBuXCIgbW9zdCBsaWtlbHksIGV4Y2VwdCBmb3JcbiAgLy8gc3dhbXAgKFwiIG5zXCI/KSAgV2Ugc2hvdWxkIGdvIHRocnUgYW5kIG1ha2Ugc3VyZSB0aGVyZSdzIG5vIHJldXNlIG9mXG4gIC8vIGVkZ2UgdHlwZXMgaW4gaW5jb25zaXN0ZW50IHdheXMgKGUuZy4gJ3YnIGZvciBib3RoIGdyYXNzIGFuZCBib3VuZGFyeSlcbn1cbiJdfQ==