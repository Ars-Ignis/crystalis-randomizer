import { DefaultMap } from '../util.js';
import { featureMask } from './metascreendata.js';
export class Metatilesets {
    constructor(rom) {
        this.rom = rom;
        this._all = [];
        this.grass = this.tileset(0x80, {
            patterns: [0x00, 0x0c],
        });
        this.town = this.tileset(0x84, {});
        this.cave = this.tileset(0x88, {});
        this.dolphinCave = this.tileset(0x88, {});
        this.pyramid = this.tileset(0x8c, {});
        this.river = this.tileset(0x90, {
            animated: [0, 1],
            patterns: [0x14, 0x00],
        });
        this.sea = this.tileset(0x94, {});
        this.lime = this.tileset(0x94, {});
        this.mountain = this.tileset(0x94, {});
        this.shrine = this.tileset(0x98, {});
        this.desert = this.tileset(0x9c, {});
        this.mountainRiver = this.tileset(0x9c, {});
        this.swamp = this.tileset(0xa0, {
            consolidated: true,
        });
        this.house = this.tileset(0xa0, {});
        this.fortress = this.tileset(0xa4, {});
        this.labyrinth = this.tileset(0xa4, {});
        this.iceCave = this.tileset(0xa8, {});
        this.tower = this.tileset(0xac, {});
        for (const key in this) {
            const value = this[key];
            if (value instanceof Metatileset)
                value.name = key;
        }
    }
    tileset(id, opts) {
        const ts = new Metatileset(this.rom, id, opts);
        this._all.push(ts);
        return ts;
    }
    [Symbol.iterator]() {
        return this._all[Symbol.iterator]();
    }
}
export class Metatileset {
    constructor(rom, tilesetId, data) {
        this.rom = rom;
        this.tilesetId = tilesetId;
        this.data = data;
        this._screens = new Set();
        this._cache = undefined;
    }
    [Symbol.iterator]() {
        return this._screens[Symbol.iterator]();
    }
    get cache() {
        if (!this._cache)
            this._cache = new NeighborCache(this);
        return this._cache;
    }
    get tileset() {
        return this.rom.tilesets[this.tilesetId];
    }
    get empty() {
        const e = this.cache.empty;
        if (!e)
            throw new Error(`No empty screen for ${this.name}`);
        return e;
    }
    effects() {
        return this.tileset.effects();
    }
    getTile(id) {
        return this.tileset.getTile(id);
    }
    addScreen(screen) {
        this._screens.add(screen);
        screen.unsafeAddTileset(this);
        this.invalidate();
    }
    deleteScreen(screen) {
        this._screens.delete(screen);
        screen.unsafeRemoveTileset(this);
        this.invalidate();
    }
    getMetascreens(screenId) {
        var _a;
        return (_a = this.cache.fromId.get(screenId)) !== null && _a !== void 0 ? _a : [];
    }
    getExits(type) {
        return this.cache.exits.get(type);
    }
    getMetascreensFromTileString(tile) {
        return this.cache.tiles.has(tile) ? this.cache.tiles.get(tile) : [];
    }
    getScreensWithOnlyFeatures(...features) {
        let mask = 0;
        for (const feature of features) {
            mask |= featureMask[feature];
        }
        const screens = [];
        for (const s of this) {
            if (!(s.features & ~mask))
                screens.push(s);
        }
        return screens;
    }
    withMod(tile, mod) {
        const out = [];
        for (const s of this.cache.tiles.get(tile)) {
            if (s.data.mod === mod)
                out.push(s);
        }
        return out;
    }
    unreachableVariant(screen) {
        for (const s of this) {
            if (s.sid === screen.sid && s.isEmpty())
                return s;
        }
        return screen;
    }
    isBannedVertical(above, below) {
        return this.cache.bannedNeighbors[0].has(above.uid << 16 | below.uid);
    }
    isBannedHorizontal(left, right) {
        return this.cache.bannedNeighbors[1].has(left.uid << 16 | right.uid);
    }
    invalidate() {
        this._cache = undefined;
    }
}
export var Dir;
(function (Dir) {
    Dir.N = 0;
    Dir.W = 1;
    Dir.S = 2;
    Dir.E = 3;
})(Dir || (Dir = {}));
class NeighborCache {
    constructor(tileset) {
        var _a, _b;
        this.tileset = tileset;
        this.fromId = new DefaultMap(() => []);
        this.exits = new DefaultMap(() => []);
        this.tiles = new DefaultMap(() => []);
        this.bannedNeighbors = [new Set(), new Set()];
        let empty = undefined;
        for (const s of tileset) {
            if (s.sid >= 0)
                this.fromId.get(s.sid).push(s);
            if (!empty &&
                s.data.edges === '    ' &&
                s.data.placement !== 'manual' &&
                s.hasFeature('empty') &&
                !((_a = s.data.exits) === null || _a === void 0 ? void 0 : _a.length)) {
                empty = s;
            }
            for (const exit of (_b = s.data.exits) !== null && _b !== void 0 ? _b : []) {
                this.exits.get(exit.type).push(s);
            }
            const tiles = typeof s.data.tile === 'string' ? [s.data.tile] : s.data.tile;
            for (const tile of tiles !== null && tiles !== void 0 ? tiles : []) {
                this.tiles.get(tile.replace(/\|/g, '')).push(s);
            }
            if (s.hasFeature('spikes') || s.hasFeature('ramp') ||
                s.hasFeature('overpass') || s.hasFeature('pit') ||
                s.isEmpty()) {
                this.banDeadEndNeighbor(s);
            }
            const ms = tileset.rom.metascreens;
            this.banDeadEndNeighbor(ms.branchNWE_wall, 1);
            this.banNeighbor(ms.deadEndS_stairs, ms.deadEndN_stairs, 2);
            this.banNeighbor(ms.deadEndNS_stairs, ms.deadEndN_stairs, 2);
            this.banNeighbor(ms.deadEndS_stairs, ms.deadEndNS_stairs, 2);
            this.banNeighbor(ms.deadEndNS_stairs, ms.deadEndNS_stairs, 2);
        }
        this.empty = empty !== null && empty !== void 0 ? empty : tileset.rom.metascreens.caveEmpty;
    }
    banDeadEndNeighbor(s, dirs = 15) {
        var _a, _b;
        for (const t of this.tileset) {
            if (!t.hasFeature('deadend'))
                continue;
            for (let dir = 0; dir < 4; dir++) {
                const mask = 1 << dir;
                if (!(dirs & mask))
                    continue;
                if (((_a = s.data.edges) === null || _a === void 0 ? void 0 : _a[dir]) !== ' ' && ((_b = t.data.edges) === null || _b === void 0 ? void 0 : _b[dir ^ 2]) !== ' ') {
                    this.banNeighbor(s, t, dir);
                }
            }
        }
    }
    banNeighbor(s, t, dir) {
        this.bannedNeighbors[dir & 1]
            .add((dir & 2 ? s : t).uid << 16 | (dir & 2 ? t : s).uid);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXRpbGVzZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL21ldGF0aWxlc2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUEwQixXQUFXLEVBQ3JCLE1BQU0scUJBQXFCLENBQUM7QUFHbkQsTUFBTSxPQUFPLFlBQVk7SUFxRHZCLFlBQTZCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBbkQ3QixTQUFJLEdBQWtCLEVBQUUsQ0FBQztRQUV4QixVQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFDbEMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztTQUN2QixDQUFDLENBQUM7UUFFTSxTQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFHOUIsU0FBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTlCLGdCQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFckMsWUFBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpDLFVBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtZQUNsQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hCLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7U0FDdkIsQ0FBQyxDQUFDO1FBRU0sUUFBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTdCLFNBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxF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QyxNQUFNLElBQUksR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDO2dCQUN0QixJQUFJLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO29CQUFFLFNBQVM7Z0JBQzdCLElBQUksT0FBQSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssMENBQUcsR0FBRyxPQUFNLEdBQUcsSUFBSSxPQUFBLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSywwQ0FBRyxHQUFHLEdBQUcsQ0FBQyxPQUFNLEdBQUcsRUFBRTtvQkFDbEUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2lCQUM3QjthQUNGO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsV0FBVyxDQUFDLENBQWEsRUFBRSxDQUFhLEVBQUUsR0FBVztRQUNuRCxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7YUFDeEIsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoRSxDQUFDO0NBUUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7TWV0YXNjcmVlbn0gZnJvbSAnLi9tZXRhc2NyZWVuLmpzJztcbmltcG9ydCB7TWV0YXRpbGV9IGZyb20gJy4vbWV0YXRpbGUuanMnO1xuaW1wb3J0IHtUaWxlRWZmZWN0c30gZnJvbSAnLi90aWxlZWZmZWN0cy5qcyc7XG5pbXBvcnQge1RpbGVzZXR9IGZyb20gJy4vdGlsZXNldC5qcyc7XG5pbXBvcnQge0RlZmF1bHRNYXB9IGZyb20gJy4uL3V0aWwuanMnO1xuaW1wb3J0IHtDb25uZWN0aW9uVHlwZSwgRmVhdHVyZSwgZmVhdHVyZU1hc2ssXG4gICAgICAgIE1ldGFzY3JlZW5EYXRhfSBmcm9tICcuL21ldGFzY3JlZW5kYXRhLmpzJztcblxuLy8gTk9URTogTXVzdCBiZSBpbml0aWFsaXplZCBCRUZPUkUgTWV0YXNjcmVlbnNcbmV4cG9ydCBjbGFzcyBNZXRhdGlsZXNldHMgaW1wbGVtZW50cyBJdGVyYWJsZTxNZXRhdGlsZXNldD4ge1xuXG4gIHByaXZhdGUgX2FsbDogTWV0YXRpbGVzZXRbXSA9IFtdO1xuXG4gIHJlYWRvbmx5IGdyYXNzID0gdGhpcy50aWxlc2V0KDB4ODAsIHtcbiAgICBwYXR0ZXJuczogWzB4MDAsIDB4MGNdLFxuICB9KTtcblxuICByZWFkb25seSB0b3duID0gdGhpcy50aWxlc2V0KDB4ODQsIHt9KTtcblxuICAvLyBzdXBwb3J0cyB3YXRlciwgYnV0IGhhcyB1Z2x5IHdhbGxcbiAgcmVhZG9ubHkgY2F2ZSA9IHRoaXMudGlsZXNldCgweDg4LCB7fSk7XG5cbiAgcmVhZG9ubHkgZG9scGhpbkNhdmUgPSB0aGlzLnRpbGVzZXQoMHg4OCwge30pO1xuXG4gIHJlYWRvbmx5IHB5cmFtaWQgPSB0aGlzLnRpbGVzZXQoMHg4Yywge30pO1xuXG4gIHJlYWRvbmx5IHJpdmVyID0gdGhpcy50aWxlc2V0KDB4OTAsIHtcbiAgICBhbmltYXRlZDogWzAsIDFdLFxuICAgIHBhdHRlcm5zOiBbMHgxNCwgMHgwMF0sIC8vIFRPRE8gLSBhbmltYXRlZCBjbG9iYmVycyAybmQgZW50cnkgYW55d2F5XG4gIH0pO1xuXG4gIHJlYWRvbmx5IHNlYSA9IHRoaXMudGlsZXNldCgweDk0LCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyA4MC4uZmZcblxuICByZWFkb25seSBsaW1lID0gdGhpcy50aWxlc2V0KDB4OTQsIHt9KTsgLy8gcHJpbWFyaWx5IHRpbGVzIDYwLi43ZlxuXG4gIC8vIHBhcnRzIHdpdGggXCJmZWF0dXJlc1wiOiBhcmNoZXMgYW5kIGhvdXNlc1xuICByZWFkb25seSBtb3VudGFpbiA9IHRoaXMudGlsZXNldCgweDk0LCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyAwLi41ZlxuXG4gIC8vIE5PVEU6IGZyZWUgc3BhY2UgZnJvbSA5MC4uZmZcbiAgcmVhZG9ubHkgc2hyaW5lID0gdGhpcy50aWxlc2V0KDB4OTgsIHt9KTtcblxuICByZWFkb25seSBkZXNlcnQgPSB0aGlzLnRpbGVzZXQoMHg5Yywge30pOyAvLyBwcmltYXJpbHkgdGlsZXMgNTAuLmZmXG5cbiAgLy8gdHJhZGVzIGZlYXR1cmVzIGZvciBjcm9zc2FibGUgcml2ZXJcbiAgcmVhZG9ubHkgbW91bnRhaW5SaXZlciA9IHRoaXMudGlsZXNldCgweDljLCB7fSk7IC8vIHByaW1hcmlseSB0aWxlcyAwMC4uNGZcblxuICByZWFkb25seSBzd2FtcCA9IHRoaXMudGlsZXNldCgweGEwLCB7XG4gICAgY29uc29saWRhdGVkOiB0cnVlLFxuICB9KTsgLy8gdGlsZXMgYTAuLmZmXG5cbiAgcmVhZG9ubHkgaG91c2UgPSB0aGlzLnRpbGVzZXQoMHhhMCwge30pOyAvLyB0aWxlcyAwMC4uOWZcblxuICByZWFkb25seSBmb3J0cmVzcyA9IHRoaXMudGlsZXNldCgweGE0LCB7fSk7XG5cbiAgLy8gdmFyaWFudCBvZiB0aGUgZm9ydHJlc3MgbWV0YXRpbGVzZXQsIGJ1dCBtYWtlcyB1c2Ugb2YgdGhlIHBhcmFwZXRzXG4gIHJlYWRvbmx5IGxhYnlyaW50aCA9IHRoaXMudGlsZXNldCgweGE0LCB7fSk7XG5cbiAgLy8gc2FtZSBhcyA4OCwgYnV0IHRyYWRlcyByaXZlcnMgZm9yIHByZXR0aWVyIGljZSB3YWxsXG4gIHJlYWRvbmx5IGljZUNhdmUgPSB0aGlzLnRpbGVzZXQoMHhhOCwge30pO1xuXG4gIHJlYWRvbmx5IHRvd2VyID0gdGhpcy50aWxlc2V0KDB4YWMsIHt9KTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJvbTogUm9tKSB7XG4gICAgLy8gVGFnIG5hbWVzIGZvciBkZWJ1Z2dpbmcuLi5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzIGFzIG9iamVjdCkge1xuICAgICAgY29uc3QgdmFsdWUgPSAodGhpcyBhcyBhbnkpW2tleV0gYXMgdW5rbm93bjtcbiAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE1ldGF0aWxlc2V0KSB2YWx1ZS5uYW1lID0ga2V5O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdGlsZXNldChpZDogbnVtYmVyLCBvcHRzOiBNZXRhdGlsZXNldERhdGEpOiBNZXRhdGlsZXNldCB7XG4gICAgY29uc3QgdHMgPSBuZXcgTWV0YXRpbGVzZXQodGhpcy5yb20sIGlkLCBvcHRzKTtcbiAgICB0aGlzLl9hbGwucHVzaCh0cyk7XG4gICAgcmV0dXJuIHRzO1xuICB9XG5cbiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FsbFtTeW1ib2wuaXRlcmF0b3JdKCk7XG4gIH1cbn1cblxuLy8gTWFwcHBpbmcgZnJvbSBtZXRhdGlsZSBJRCB0byB0aWxlIHF1YWRzIGFuZCBwYWxldHRlIG51bWJlci5cbmV4cG9ydCBjbGFzcyBNZXRhdGlsZXNldCBpbXBsZW1lbnRzIEl0ZXJhYmxlPE1ldGFzY3JlZW4+IHtcblxuICAvLyBUT0RPIC0gbWFpbnRhaW4gYW4gaW52YXJpYW50IE1hcDxzY3JlZW4taWQsIFNldDxNZXRhc2NyZWVuPj4sXG4gIC8vICAgICAgICB3aWxsIG5lZWQgdG8gbG9jayBkb3duIChtZXRhKXNjcmVlbiBJRCBmaWVsZCB0byBlbnN1cmVcbiAgLy8gICAgICAgIGludmFyaWFudCBpcyBrZXB0LlxuXG4gIC8vIFRPRE8gLSBwZXJtYW5lbnRseSBhdHRhY2ggYmVoYXZpb3JcbiAgLy8gU3RvcmUgbW9yZSBpbmZvcm1hdGlvbiwgc3VjaCBhcyBzY3JlZW4gdHlwZXMsIGVkZ2UgdHlwZXMsIGV0Yy5cbiAgLy8gTmFtZXMuLi5cbiAgLy8gRG9lcyBwYWxldHRlIGluZm8gYmVsb25nIGhlcmU/ICBNYXliZS4uLlxuXG4gIG5hbWU/OiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3NjcmVlbnMgPSBuZXcgU2V0PE1ldGFzY3JlZW4+KCk7XG4gIHByaXZhdGUgX2NhY2hlPzogTmVpZ2hib3JDYWNoZSA9IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSxcbiAgICAgICAgICAgICAgcmVhZG9ubHkgdGlsZXNldElkOiBudW1iZXIsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IGRhdGE6IE1ldGF0aWxlc2V0RGF0YSkge31cblxuICBbU3ltYm9sLml0ZXJhdG9yXSgpIHtcbiAgICByZXR1cm4gdGhpcy5fc2NyZWVuc1tTeW1ib2wuaXRlcmF0b3JdKCk7XG4gIH1cblxuICBwcml2YXRlIGdldCBjYWNoZSgpOiBOZWlnaGJvckNhY2hlIHtcbiAgICBpZiAoIXRoaXMuX2NhY2hlKSB0aGlzLl9jYWNoZSA9IG5ldyBOZWlnaGJvckNhY2hlKHRoaXMpO1xuICAgIHJldHVybiB0aGlzLl9jYWNoZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB1bmRlcmx5aW5nIHBoeXNpY2FsIHRpbGVzZXQuICBNdWx0aXBsZSBNZXRhdGlsZXNldHNcbiAgICogbWF5IHNoYXJlIHRoZSBzYW1lIHBoeXNpY2FsIHRpbGVzZXQuXG4gICAqL1xuICBnZXQgdGlsZXNldCgpOiBUaWxlc2V0IHtcbiAgICByZXR1cm4gdGhpcy5yb20udGlsZXNldHNbdGhpcy50aWxlc2V0SWRdO1xuICB9XG5cbiAgZ2V0IGVtcHR5KCk6IE1ldGFzY3JlZW4ge1xuICAgIGNvbnN0IGUgPSB0aGlzLmNhY2hlLmVtcHR5O1xuICAgIGlmICghZSkgdGhyb3cgbmV3IEVycm9yKGBObyBlbXB0eSBzY3JlZW4gZm9yICR7dGhpcy5uYW1lfWApO1xuICAgIHJldHVybiBlO1xuICB9XG5cbiAgLy8gVE9ETyAtIHVzZSBFTVBUWSBhcyBhIGJvcmRlciBzcXVhcmUuLi4gYWxzbyBuZWVkXG4gIC8vIGFuIEVYSVQgYm9yZGVyIHNxdWFyZT8gIEhvdyB0byBsaW5rIHRoaXMgaW50b1xuICAvLyBcImFsbG93ZWRcIj8gIG5lZWRzIHRvIGxpbmsgdG8gY2hlY2sgZXhpdHMgb24gZWRnZS5cbiAgLy8gICAtIHNvIHN0aWxsIHByb2JhYmx5IHdhbnQgYW4gRVhJVCBtZXRhc2NyZWVuP1xuXG4gIGVmZmVjdHMoKTogVGlsZUVmZmVjdHMge1xuICAgIHJldHVybiB0aGlzLnRpbGVzZXQuZWZmZWN0cygpO1xuICB9XG5cbiAgLy8gRm9yd2FyZCB0byB0aGUgdW5kZXJseWluZyBUaWxlc2V0LlxuICBnZXRUaWxlKGlkOiBudW1iZXIpOiBNZXRhdGlsZSB7XG4gICAgcmV0dXJuIHRoaXMudGlsZXNldC5nZXRUaWxlKGlkKTtcbiAgfVxuXG4gIGFkZFNjcmVlbihzY3JlZW46IE1ldGFzY3JlZW4pIHtcbiAgICB0aGlzLl9zY3JlZW5zLmFkZChzY3JlZW4pO1xuICAgIHNjcmVlbi51bnNhZmVBZGRUaWxlc2V0KHRoaXMpO1xuICAgIHRoaXMuaW52YWxpZGF0ZSgpO1xuICB9XG5cbiAgZGVsZXRlU2NyZWVuKHNjcmVlbjogTWV0YXNjcmVlbikge1xuICAgIHRoaXMuX3NjcmVlbnMuZGVsZXRlKHNjcmVlbik7XG4gICAgc2NyZWVuLnVuc2FmZVJlbW92ZVRpbGVzZXQodGhpcyk7XG4gICAgdGhpcy5pbnZhbGlkYXRlKCk7XG4gIH1cblxuICBnZXRNZXRhc2NyZWVucyhzY3JlZW5JZDogbnVtYmVyKTogUmVhZG9ubHlBcnJheTxNZXRhc2NyZWVuPiB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuZnJvbUlkLmdldChzY3JlZW5JZCkgPz8gW107XG4gIH1cblxuICBnZXRFeGl0cyh0eXBlOiBDb25uZWN0aW9uVHlwZSk6IFJlYWRvbmx5QXJyYXk8TWV0YXNjcmVlbj4ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLmV4aXRzLmdldCh0eXBlKTtcbiAgfVxuXG4gIGdldE1ldGFzY3JlZW5zRnJvbVRpbGVTdHJpbmcodGlsZTogc3RyaW5nKTogcmVhZG9ubHkgTWV0YXNjcmVlbltdIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS50aWxlcy5oYXModGlsZSkgPyB0aGlzLmNhY2hlLnRpbGVzLmdldCh0aWxlKSA6IFtdO1xuICB9XG5cbiAgZ2V0U2NyZWVuc1dpdGhPbmx5RmVhdHVyZXMoLi4uZmVhdHVyZXM6IEZlYXR1cmVbXSk6IE1ldGFzY3JlZW5bXSB7XG4gICAgbGV0IG1hc2sgPSAwO1xuICAgIGZvciAoY29uc3QgZmVhdHVyZSBvZiBmZWF0dXJlcykge1xuICAgICAgbWFzayB8PSBmZWF0dXJlTWFza1tmZWF0dXJlXTtcbiAgICB9XG4gICAgY29uc3Qgc2NyZWVuczogTWV0YXNjcmVlbltdID0gW107XG4gICAgZm9yIChjb25zdCBzIG9mIHRoaXMpIHtcbiAgICAgIGlmICghKHMuZmVhdHVyZXMgJiB+bWFzaykpIHNjcmVlbnMucHVzaChzKTtcbiAgICB9XG4gICAgcmV0dXJuIHNjcmVlbnM7XG4gIH1cblxuICB3aXRoTW9kKHRpbGU6IHN0cmluZywgbW9kOiBNZXRhc2NyZWVuRGF0YVsnbW9kJ10pOiBNZXRhc2NyZWVuW10ge1xuICAgIGNvbnN0IG91dDogTWV0YXNjcmVlbltdID0gW107XG4gICAgZm9yIChjb25zdCBzIG9mIHRoaXMuY2FjaGUudGlsZXMuZ2V0KHRpbGUpKSB7XG4gICAgICBpZiAocy5kYXRhLm1vZCA9PT0gbW9kKSBvdXQucHVzaChzKTtcbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHVucmVhY2hhYmxlVmFyaWFudChzY3JlZW46IE1ldGFzY3JlZW4pOiBNZXRhc2NyZWVuIHtcbiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcykge1xuICAgICAgaWYgKHMuc2lkID09PSBzY3JlZW4uc2lkICYmIHMuaXNFbXB0eSgpKSByZXR1cm4gcztcbiAgICB9XG4gICAgcmV0dXJuIHNjcmVlbjtcbiAgfVxuXG4gIGlzQmFubmVkVmVydGljYWwoYWJvdmU6IE1ldGFzY3JlZW4sIGJlbG93OiBNZXRhc2NyZWVuKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuYmFubmVkTmVpZ2hib3JzWzBdLmhhcyhhYm92ZS51aWQgPDwgMTYgfCBiZWxvdy51aWQpO1xuICB9XG5cbiAgaXNCYW5uZWRIb3Jpem9udGFsKGxlZnQ6IE1ldGFzY3JlZW4sIHJpZ2h0OiBNZXRhc2NyZWVuKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuYmFubmVkTmVpZ2hib3JzWzFdLmhhcyhsZWZ0LnVpZCA8PCAxNiB8IHJpZ2h0LnVpZCk7XG4gIH1cblxuICAvKipcbiAgICogSW52YWxpZGF0ZSB0aGUgbmVpZ2hib3IgY2FjaGUuICBUaGlzIGlzIG5lY2Vzc2FyeSBhbnkgdGltZSB0aGVcbiAgICogc2NyZWVucyBjaGFuZ2UuXG4gICAqL1xuICBpbnZhbGlkYXRlKCkge1xuICAgIHRoaXMuX2NhY2hlID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgLy8gY2hlY2soczE6IFVpZCwgczI6IFVpZCwgZGVsdGE6IG51bWJlcik6IGJvb2xlYW4ge1xuICAvLyAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZS5hbGxvd2VkW2RlbHRhICYgMV07ICAvLyB2ZXJ0aWNhbCA9IDAsIGhvcml6ID0gMVxuICAvLyAgIGNvbnN0IGluZGV4ID0gZGVsdGEgPiAwID8gczEgPDwgMTYgfCBzMiA6IHMyIDw8IDE2IHwgczE7XG4gIC8vICAgcmV0dXJuIGNhY2hlLmhhcyhpbmRleCk7XG4gIC8vIH1cbn1cblxuaW50ZXJmYWNlIE1ldGF0aWxlc2V0RGF0YSB7XG4gIHBhdHRlcm5zPzogcmVhZG9ubHkgW251bWJlciwgbnVtYmVyXTtcbiAgYW5pbWF0ZWQ/OiByZWFkb25seSBudW1iZXJbXTtcbiAgY29uc29saWRhdGVkPzogYm9vbGVhbjtcbn1cblxuLy8gY29uc3QgRU1QVFlfU0VUOiBTZXQ8YW55PiA9IG5ldyBjbGFzcyBleHRlbmRzIFNldCB7XG4vLyAgIGFkZCgpOiB0aGlzIHsgdGhyb3cgbmV3IEVycm9yKCk7IH1cbi8vIH1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gU3BlY2lhbGl6ZWQgY2FjaGUgb2YgbmVpZ2hib3JzL3JlbGF0aW9uc2hpcHMgaW4gYSB0aWxlc2V0LlxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuIFxuZXhwb3J0IHR5cGUgRGlyID0gMHwxfDJ8MztcblxuZXhwb3J0IG5hbWVzcGFjZSBEaXIge1xuICBleHBvcnQgY29uc3QgTjogRGlyID0gMDtcbiAgZXhwb3J0IGNvbnN0IFc6IERpciA9IDE7XG4gIGV4cG9ydCBjb25zdCBTOiBEaXIgPSAyO1xuICBleHBvcnQgY29uc3QgRTogRGlyID0gMztcbn1cblxuY2xhc3MgTmVpZ2hib3JDYWNoZSB7XG4gIC8vIFt2ZXJ0aWNhbCwgaG9yaXpvbnRhbF0sIGluZGV4ZWQgYnkgZGlyICYgMVxuICAvLyByZWFkb25seSBhbGxvd2VkID0gW25ldyBTZXQ8VWlkUGFpcj4oKSwgbmV3IFNldDxVaWRQYWlyPigpXSBhcyBjb25zdDtcbiAgLy8gcmVhZG9ubHkgbmVpZ2hib3JzID0gbmV3IERlZmF1bHRNYXA8VWlkRGlyLCBTZXQ8VWlkPj4oKCkgPT4gbmV3IFNldCgpKTtcbiAgcmVhZG9ubHkgZnJvbUlkID0gbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBNZXRhc2NyZWVuW10+KCgpID0+IFtdKTtcbiAgcmVhZG9ubHkgZXhpdHMgPSBuZXcgRGVmYXVsdE1hcDxDb25uZWN0aW9uVHlwZSwgTWV0YXNjcmVlbltdPigoKSA9PiBbXSk7XG4gIHJlYWRvbmx5IGVtcHR5OiBNZXRhc2NyZWVuO1xuICByZWFkb25seSB0aWxlcyA9IG5ldyBEZWZhdWx0TWFwPHN0cmluZywgTWV0YXNjcmVlbltdPigoKSA9PiBbXSk7XG4gIC8vIGFib3ZlIDw8IDE2IHwgYmVsb3csIGxlZnQgPDwgMTYgfCByaWdodFxuICByZWFkb25seSBiYW5uZWROZWlnaGJvcnMgPSBbbmV3IFNldDxudW1iZXI+KCksIG5ldyBTZXQ8bnVtYmVyPigpXTtcbiAgLy8gcHJpdmF0ZSByZWFkb25seSB0b2dnbGVzID0gbmV3IERlZmF1bHRNYXA8VWlkRGlyLCBTZXQ8VWlkPj4oKCkgPT4gbmV3IFNldCk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgdGlsZXNldDogTWV0YXRpbGVzZXQpIHtcbiAgICBsZXQgZW1wdHk6IE1ldGFzY3JlZW58dW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgIGZvciAoY29uc3QgcyBvZiB0aWxlc2V0KSB7XG4gICAgICAvLyBSZWdpc3RlciBpbiB0aGUgZnJvbUlkIG11bHRpbWFwXG4gICAgICBpZiAocy5zaWQgPj0gMCkgdGhpcy5mcm9tSWQuZ2V0KHMuc2lkKS5wdXNoKHMpO1xuICAgICAgLy8gQ2hlY2sgZm9yIGVtcHR5XG4gICAgICBpZiAoIWVtcHR5ICYmXG4gICAgICAgICAgcy5kYXRhLmVkZ2VzID09PSAnICAgICcgJiZcbiAgICAgICAgICBzLmRhdGEucGxhY2VtZW50ICE9PSAnbWFudWFsJyAmJlxuICAgICAgICAgIHMuaGFzRmVhdHVyZSgnZW1wdHknKSAmJlxuICAgICAgICAgICFzLmRhdGEuZXhpdHM/Lmxlbmd0aCkge1xuICAgICAgICBlbXB0eSA9IHM7XG4gICAgICB9XG4gICAgICBmb3IgKGNvbnN0IGV4aXQgb2Ygcy5kYXRhLmV4aXRzID8/IFtdKSB7XG4gICAgICAgIHRoaXMuZXhpdHMuZ2V0KGV4aXQudHlwZSkucHVzaChzKTtcbiAgICAgIH1cbiAgICAgIC8vIEFkZCB0byB0aWxlc1xuICAgICAgY29uc3QgdGlsZXMgPVxuICAgICAgICAgIHR5cGVvZiBzLmRhdGEudGlsZSA9PT0gJ3N0cmluZycgPyBbcy5kYXRhLnRpbGVdIDogcy5kYXRhLnRpbGU7XG4gICAgICBmb3IgKGNvbnN0IHRpbGUgb2YgdGlsZXMgPz8gW10pIHtcbiAgICAgICAgdGhpcy50aWxlcy5nZXQodGlsZS5yZXBsYWNlKC9cXHwvZywgJycpKS5wdXNoKHMpO1xuICAgICAgfVxuICAgICAgLy8gQ2hlY2sgZm9yIGJhbm5lZCB2ZXJ0aWNhbHNcbiAgICAgIGlmIChzLmhhc0ZlYXR1cmUoJ3NwaWtlcycpIHx8IHMuaGFzRmVhdHVyZSgncmFtcCcpIHx8XG4gICAgICAgICAgcy5oYXNGZWF0dXJlKCdvdmVycGFzcycpIHx8IHMuaGFzRmVhdHVyZSgncGl0JykgfHxcbiAgICAgICAgICBzLmlzRW1wdHkoKSkge1xuICAgICAgICB0aGlzLmJhbkRlYWRFbmROZWlnaGJvcihzKTtcbiAgICAgIH1cbiAgICAgIC8vIEFkZCBhIGJ1bmNoIG9mIGZpeGVkIGJhbnNcbiAgICAgIGNvbnN0IG1zID0gdGlsZXNldC5yb20ubWV0YXNjcmVlbnM7XG4gICAgICB0aGlzLmJhbkRlYWRFbmROZWlnaGJvcihtcy5icmFuY2hOV0Vfd2FsbCwgMSk7XG4gICAgICB0aGlzLmJhbk5laWdoYm9yKG1zLmRlYWRFbmRTX3N0YWlycywgbXMuZGVhZEVuZE5fc3RhaXJzLCAyKTtcbiAgICAgIHRoaXMuYmFuTmVpZ2hib3IobXMuZGVhZEVuZE5TX3N0YWlycywgbXMuZGVhZEVuZE5fc3RhaXJzLCAyKTtcbiAgICAgIHRoaXMuYmFuTmVpZ2hib3IobXMuZGVhZEVuZFNfc3RhaXJzLCBtcy5kZWFkRW5kTlNfc3RhaXJzLCAyKTtcbiAgICAgIHRoaXMuYmFuTmVpZ2hib3IobXMuZGVhZEVuZE5TX3N0YWlycywgbXMuZGVhZEVuZE5TX3N0YWlycywgMik7XG4gICAgfVxuICAgIHRoaXMuZW1wdHkgPSBlbXB0eSA/PyB0aWxlc2V0LnJvbS5tZXRhc2NyZWVucy5jYXZlRW1wdHk7XG4gIH1cblxuICBiYW5EZWFkRW5kTmVpZ2hib3IoczogTWV0YXNjcmVlbiwgZGlycyA9IDE1KSB7XG4gICAgZm9yIChjb25zdCB0IG9mIHRoaXMudGlsZXNldCkge1xuICAgICAgaWYgKCF0Lmhhc0ZlYXR1cmUoJ2RlYWRlbmQnKSkgY29udGludWU7XG4gICAgICBmb3IgKGxldCBkaXIgPSAwOyBkaXIgPCA0OyBkaXIrKykge1xuICAgICAgICBjb25zdCBtYXNrID0gMSA8PCBkaXI7XG4gICAgICAgIGlmICghKGRpcnMgJiBtYXNrKSkgY29udGludWU7XG4gICAgICAgIGlmIChzLmRhdGEuZWRnZXM/LltkaXJdICE9PSAnICcgJiYgdC5kYXRhLmVkZ2VzPy5bZGlyIF4gMl0gIT09ICcgJykge1xuICAgICAgICAgIHRoaXMuYmFuTmVpZ2hib3IocywgdCwgZGlyKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGJhbk5laWdoYm9yKHM6IE1ldGFzY3JlZW4sIHQ6IE1ldGFzY3JlZW4sIGRpcjogbnVtYmVyKSB7XG4gICAgdGhpcy5iYW5uZWROZWlnaGJvcnNbZGlyICYgMV1cbiAgICAgICAgLmFkZCgoZGlyICYgMiA/IHMgOiB0KS51aWQgPDwgMTYgfCAoZGlyICYgMiA/IHQgOiBzKS51aWQpO1xuICB9XG5cbiAgLy8gVE9ETyAtIHdoYXQgdG8gZG8gd2l0aCBib3JkZXJzPyE/IENhbiB3ZSB0cmVhdCB0aGVtIGxpa2UgYSBzY3JlZW4/XG4gIC8vIFRoZSBtYWluIHRoaW5nIHRoYXQgbWF0dGVycyBmb3IgYm9yZGVycyBpcyB3aGV0aGVyIGl0J3MgYW4gZWRnZSBleGl0XG4gIC8vIG9yIG5vdC4gIFdlIGNhbiBhbHJlYWR5IHRyYWNrIHRoaXMgYSBiaXQgLSB3ZSBjb3VsZCBoYXZlIGEgbGlzdCBvZlxuICAvLyBhY2NlcHRhYmxlIGVkZ2UgdHlwZXMgZm9yIGVhY2ggdGlsZXNldCAtIFwiIG5cIiBtb3N0IGxpa2VseSwgZXhjZXB0IGZvclxuICAvLyBzd2FtcCAoXCIgbnNcIj8pICBXZSBzaG91bGQgZ28gdGhydSBhbmQgbWFrZSBzdXJlIHRoZXJlJ3Mgbm8gcmV1c2Ugb2ZcbiAgLy8gZWRnZSB0eXBlcyBpbiBpbmNvbnNpc3RlbnQgd2F5cyAoZS5nLiAndicgZm9yIGJvdGggZ3Jhc3MgYW5kIGJvdW5kYXJ5KVxufVxuIl19