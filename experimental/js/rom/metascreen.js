import { featureMask } from './metascreendata.js';
import { DefaultMap } from '../util.js';
export class Metascreen {
    constructor(rom, uid, data) {
        var _a, _b, _c, _d, _e;
        this.rom = rom;
        this.uid = uid;
        this.data = data;
        this._tilesets = new Set();
        this.used = false;
        this.neighbors = [
            new DefaultMap((s) => this._checkNeighbor(s, 0)),
            new DefaultMap((s) => this._checkNeighbor(s, 1)),
        ];
        for (const tileset of Object.values(data.tilesets)) {
            if (!tileset.requires)
                this.used = true;
        }
        let features = 0;
        for (const feature of (_a = data.feature) !== null && _a !== void 0 ? _a : []) {
            const mask = featureMask[feature];
            if (mask != null)
                features |= mask;
        }
        for (const exit of (_b = data.exits) !== null && _b !== void 0 ? _b : []) {
            if (exit.type === 'stair:down' || exit.type === 'stair:up') {
                features |= featureMask[exit.type];
            }
        }
        this._features = features;
        this._isEmpty = Boolean(features & featureMask['empty']);
        this.flag = data.flag;
        const cxn = [[[]], [[]], [[]], [[]]];
        this.connections = cxn;
        for (let i = 0; i < 4; i++) {
            let poiIndex = 0;
            let exitIndex = 0;
            let cur = cxn[i][0];
            for (const term of (_c = this.data.connect) !== null && _c !== void 0 ? _c : '') {
                if (connectionBlocks[i].includes(term)) {
                    cxn[i].push(cur = []);
                    continue;
                }
                let delta;
                if (connectionBlockSet.has(term))
                    continue;
                if (term === 'p') {
                    delta = 0xf0 | poiIndex++;
                }
                else if (term === 'x') {
                    delta = 0xe0 | exitIndex++;
                }
                else {
                    const num = parseInt(term, 16);
                    if (!num)
                        throw new Error(`bad term: '${term}'`);
                    const channel = (num & 3) << (num & 4);
                    const offset = num & 8 ? (num & 4 ? 0x0100 : 0x1000) : 0;
                    delta = channel | offset;
                }
                cur.push(delta);
            }
            while (poiIndex < ((_d = this.data.poi) === null || _d === void 0 ? void 0 : _d.length)) {
                cur.push(0xf0 | poiIndex++);
            }
            while (exitIndex < ((_e = this.data.exits) === null || _e === void 0 ? void 0 : _e.length)) {
                cur.push(0xe0 | exitIndex++);
            }
        }
    }
    get features() {
        return this._features;
    }
    get manual() {
        return Boolean(this._features & manualFeatureMask);
    }
    get counted() {
        return Boolean(this._features & countedFeatureMask);
    }
    hasFeature(feature) {
        return Boolean(this._features & featureMask[feature]);
    }
    hasFeatures(features) {
        return (this._features & features) === features;
    }
    withFeature(feature) {
        throw new Error();
    }
    isEmpty() {
        return this._isEmpty;
    }
    hasStair() {
        return Boolean(this._features & (featureMask['stair:up'] |
            featureMask['stair:down']));
    }
    withObstruction() {
        throw new Error();
    }
    isCompatibleWithTileset(id) {
        for (const tileset of this._tilesets) {
            if (tileset.tilesetId === id)
                return true;
        }
        return false;
    }
    replace(from, to) {
        const { tiles } = this.screen;
        for (let i = 0; i < tiles.length; i++) {
            if (tiles[i] === from)
                tiles[i] = to;
        }
        return this;
    }
    remove() {
        for (const tileset of this.tilesets()) {
            tileset.deleteScreen(this);
        }
    }
    tilesets() {
        const tilesets = [];
        for (const key in this.data.tilesets) {
            tilesets.push(this.rom.metatilesets[key]);
        }
        return tilesets;
    }
    setGridTile(...tile) {
        this.data.tile = tile;
        for (const tileset of this.tilesets()) {
            tileset.invalidate();
        }
    }
    gridTiles() {
        var _a;
        let t = (_a = this.data.tile) !== null && _a !== void 0 ? _a : [];
        if (!Array.isArray(t))
            t = [t];
        return t.map(s => s.replace(/\|/g, ''));
    }
    get sid() {
        return this.data.id;
    }
    set sid(sid) {
        if (this.sid === sid)
            return;
        this.rom.metascreens.renumber(this.sid, sid);
    }
    get screen() {
        const { sid, rom: { screens } } = this;
        return sid < 0 ? screens.unallocated[~sid] : screens[sid];
    }
    unsafeSetId(sid) {
        this.data.id = sid;
        for (const tileset of this._tilesets) {
            tileset.invalidate();
        }
    }
    unsafeAddTileset(tileset) {
        this._tilesets.add(tileset);
    }
    unsafeRemoveTileset(tileset) {
        this._tilesets.delete(tileset);
    }
    edgeExits() {
        var _a;
        let mask = 0;
        for (const e of (_a = this.data.exits) !== null && _a !== void 0 ? _a : []) {
            const dir = edgeTypeMap[e.type];
            if (dir != null)
                mask |= (1 << dir);
        }
        return mask;
    }
    edgeIndex(edgeType) {
        var _a;
        let index = 0;
        const edge = (_a = this.data.edges) !== null && _a !== void 0 ? _a : '';
        for (let i = 0; i < 4; i++) {
            if (edge[i] === ' ')
                continue;
            if (edge[i] !== edgeType)
                return undefined;
            index |= (1 << i);
        }
        return index;
    }
    findExitType(tile, single, seamless) {
        var _a, _b;
        for (const exit of (_a = this.data.exits) !== null && _a !== void 0 ? _a : []) {
            if (exit.type.startsWith('seamless') !== seamless)
                continue;
            const t0 = single && exit.type === 'edge:bottom' && tile >= 0xc0 ?
                tile + 0x20 : tile;
            if (exit.exits.includes(t0) || ((_b = exit.allowedExits) !== null && _b !== void 0 ? _b : []).includes(t0)) {
                return exit;
            }
        }
        return undefined;
    }
    findExitByType(type) {
        const exit = this.data.exits.find(e => e.type === type);
        if (!exit)
            throw new Error(`no exit ${type}`);
        return exit;
    }
    findEntranceType(coord, single) {
        var _a, _b;
        for (const exit of (_a = this.data.exits) !== null && _a !== void 0 ? _a : []) {
            if (exit.type.startsWith('seamless'))
                continue;
            const c0 = single && exit.type === 'edge:bottom' && coord >= 0xbf00 ?
                coord + 0x2000 : coord;
            const t0 = (c0 & 0xf0) >> 4 | (c0 & 0xf000) >> 8;
            if (exit.entrance === c0 ||
                exit.exits.includes(t0) || ((_b = exit.allowedExits) !== null && _b !== void 0 ? _b : []).includes(t0)) {
                return exit.type;
            }
        }
        return undefined;
    }
    addCustomFlag(defaultValue) {
        this.flag = defaultValue ? 'custom:true' : 'custom:false';
    }
    checkNeighbor(that, dir) {
        const a = dir & 2 ? this : that;
        const b = dir & 2 ? that : this;
        return a.neighbors[dir & 1].get(b);
    }
    _checkNeighbor(that, dir) {
        const e1 = this.data.edges;
        const e2 = that.data.edges;
        if (e1 && e2) {
            const opp = dir ^ 2;
            if (e1[opp] !== '*' && e1[opp] === e2[dir])
                return true;
        }
        return false;
    }
}
const edgeTypeMap = {
    'edge:top': 0,
    'edge:left': 1,
    'edge:bottom': 2,
    'edge:right': 3,
};
const connectionBlocks = [
    '|:',
    '|:=-',
    '|',
    '|=',
];
const connectionBlockSet = new Set(['|', ':', '-', '=']);
const manualFeatures = new Set([
    'arena', 'portoa1', 'portoa2', 'portoa3', 'lake', 'overpass', 'underpass',
    'lighthouse', 'cabin', 'windmill', 'altar', 'pyramid', 'crypt',
]);
const countedFeatures = new Set([
    'pit', 'spikes', 'bridge', 'wall', 'ramp', 'whirlpool',
]);
const manualFeatureMask = [...manualFeatures].map(f => featureMask[f]).reduce((a, b) => a | b);
const countedFeatureMask = [...countedFeatures].map(f => featureMask[f]).reduce((a, b) => a | b);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vbWV0YXNjcmVlbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0MsV0FBVyxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFJaEQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLFlBQVksQ0FBQztBQUl0QyxNQUFNLE9BQU8sVUFBVTtJQTZCckIsWUFBcUIsR0FBUSxFQUFXLEdBQVEsRUFDM0IsSUFBb0I7O1FBRHBCLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFBVyxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQzNCLFNBQUksR0FBSixJQUFJLENBQWdCO1FBNUJ4QixjQUFTLEdBQUcsSUFBSSxHQUFHLEVBQWUsQ0FBQztRQWNwRCxTQUFJLEdBQUcsS0FBSyxDQUFDO1FBS0osY0FBUyxHQUFHO1lBQ25CLElBQUksVUFBVSxDQUFzQixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDckUsSUFBSSxVQUFVLENBQXNCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUM3RCxDQUFDO1FBT1QsS0FBSyxNQUFNLE9BQU8sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUNsRCxJQUFJLENBQUMsT0FBUSxDQUFDLFFBQVE7Z0JBQUUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDMUM7UUFHRCxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDakIsS0FBSyxNQUFNLE9BQU8sVUFBSSxJQUFJLENBQUMsT0FBTyxtQ0FBSSxFQUFFLEVBQUU7WUFDeEMsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xDLElBQUksSUFBSSxJQUFJLElBQUk7Z0JBQUUsUUFBUSxJQUFJLElBQUksQ0FBQztTQU1wQztRQUNELEtBQUssTUFBTSxJQUFJLFVBQUksSUFBSSxDQUFDLEtBQUssbUNBQUksRUFBRSxFQUFFO1lBQ25DLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxZQUFZLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxVQUFVLEVBQUU7Z0JBQzFELFFBQVEsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3BDO1NBQ0Y7UUFDRCxJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztRQUMxQixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBSXRCLE1BQU0sR0FBRyxHQUFpQixDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUVuRCxJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsQ0FBQztRQUN2QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzFCLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQztZQUNqQixJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7WUFDbEIsSUFBSSxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLEtBQUssTUFBTSxJQUFJLFVBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLG1DQUFJLEVBQUUsRUFBRTtnQkFDMUMsSUFBSSxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7b0JBQ3RDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO29CQUN0QixTQUFTO2lCQUNWO2dCQUNELElBQUksS0FBSyxDQUFDO2dCQUNWLElBQUksa0JBQWtCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztvQkFBRSxTQUFTO2dCQUMzQyxJQUFJLElBQUksS0FBSyxHQUFHLEVBQUU7b0JBQ2hCLEtBQUssR0FBRyxJQUFJLEdBQUcsUUFBUSxFQUFFLENBQUM7aUJBQzNCO3FCQUFNLElBQUksSUFBSSxLQUFLLEdBQUcsRUFBRTtvQkFDdkIsS0FBSyxHQUFHLElBQUksR0FBRyxTQUFTLEVBQUUsQ0FBQztpQkFDNUI7cUJBQU07b0JBQ0wsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDL0IsSUFBSSxDQUFDLEdBQUc7d0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxjQUFjLElBQUksR0FBRyxDQUFDLENBQUM7b0JBQ2pELE1BQU0sT0FBTyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUN2QyxNQUFNLE1BQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDekQsS0FBSyxHQUFHLE9BQU8sR0FBRyxNQUFNLENBQUM7aUJBQzFCO2dCQUNELEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDakI7WUFDRCxPQUFPLFFBQVEsSUFBRyxNQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRywwQ0FBRSxNQUFPLENBQUEsRUFBRTtnQkFDeEMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxFQUFFLENBQUMsQ0FBQzthQUM3QjtZQUNELE9BQU8sU0FBUyxJQUFHLE1BQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLDBDQUFFLE1BQU8sQ0FBQSxFQUFFO2dCQUMzQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLEVBQUUsQ0FBQyxDQUFDO2FBQzlCO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFJLE1BQU07UUFDUixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLGlCQUFpQixDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELElBQUksT0FBTztRQUNULE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsa0JBQWtCLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBTUQsVUFBVSxDQUFDLE9BQWdCO1FBQ3pCLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVELFdBQVcsQ0FBQyxRQUFnQjtRQUMxQixPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsS0FBSyxRQUFRLENBQUM7SUFDbEQsQ0FBQztJQUdELFdBQVcsQ0FBQyxPQUFnQjtRQUUxQixNQUFNLElBQUksS0FBSyxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVELE9BQU87UUFDTCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQztJQUVELFFBQVE7UUFDTixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQztZQUN2QixXQUFXLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFHRCxlQUFlO1FBQ2IsTUFBTSxJQUFJLEtBQUssRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFFRCx1QkFBdUIsQ0FBQyxFQUFVO1FBQ2hDLEtBQUssTUFBTSxPQUFPLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNwQyxJQUFJLE9BQU8sQ0FBQyxTQUFTLEtBQUssRUFBRTtnQkFBRSxPQUFPLElBQUksQ0FBQztTQUMzQztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUtELE9BQU8sQ0FBQyxJQUFZLEVBQUUsRUFBVTtRQUM5QixNQUFNLEVBQUMsS0FBSyxFQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUM1QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNyQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJO2dCQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDdEM7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxNQUFNO1FBSUosS0FBSyxNQUFNLE9BQU8sSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDckMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM1QjtJQUNILENBQUM7SUFFRCxRQUFRO1FBQ04sTUFBTSxRQUFRLEdBQWtCLEVBQUUsQ0FBQztRQUNuQyxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ3BDLFFBQVEsQ0FBQyxJQUFJLENBQ1QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBeUIsQ0FBZ0IsQ0FBQyxDQUFDO1NBQ3RFO1FBQ0QsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVELFdBQVcsQ0FBQyxHQUFHLElBQWM7UUFDM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLEtBQUssTUFBTSxPQUFPLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQ3JDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUN0QjtJQUNILENBQUM7SUFFRCxTQUFTOztRQUNQLElBQUksQ0FBQyxTQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxtQ0FBSSxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsSUFBSSxHQUFHO1FBQ0wsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRUQsSUFBSSxHQUFHLENBQUMsR0FBVztRQUNqQixJQUFJLElBQUksQ0FBQyxHQUFHLEtBQUssR0FBRztZQUFFLE9BQU87UUFDN0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVELElBQUksTUFBTTtRQUNSLE1BQU0sRUFBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUMsT0FBTyxFQUFDLEVBQUMsR0FBRyxJQUFJLENBQUM7UUFDbkMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBR0QsV0FBVyxDQUFDLEdBQVc7UUFDcEIsSUFBSSxDQUFDLElBQXFCLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQztRQUNyQyxLQUFLLE1BQU0sT0FBTyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDcEMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUVELGdCQUFnQixDQUFDLE9BQW9CO1FBQ25DLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxPQUFvQjtRQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBR0QsU0FBUzs7UUFDUCxJQUFJLElBQUksR0FBRyxDQUFDLENBQUM7UUFDYixLQUFLLE1BQU0sQ0FBQyxVQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxtQ0FBSSxFQUFFLEVBQUU7WUFDckMsTUFBTSxHQUFHLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoQyxJQUFJLEdBQUcsSUFBSSxJQUFJO2dCQUFFLElBQUksSUFBSSxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztTQUNyQztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELFNBQVMsQ0FBQyxRQUFnQjs7UUFDeEIsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsTUFBTSxJQUFJLFNBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLG1DQUFJLEVBQUUsQ0FBQztRQUNuQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzFCLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUc7Z0JBQUUsU0FBUztZQUM5QixJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRO2dCQUFFLE9BQU8sU0FBUyxDQUFDO1lBQzNDLEtBQUssSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNuQjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELFlBQVksQ0FBQyxJQUFZLEVBQUUsTUFBZSxFQUM3QixRQUFpQjs7UUFDNUIsS0FBSyxNQUFNLElBQUksVUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssbUNBQUksRUFBRSxFQUFFO1lBQ3hDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEtBQUssUUFBUTtnQkFBRSxTQUFTO1lBQzVELE1BQU0sRUFBRSxHQUFHLE1BQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLGFBQWEsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLENBQUM7Z0JBQzlELElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUN2QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLE9BQUMsSUFBSSxDQUFDLFlBQVksbUNBQUksRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUNyRSxPQUFPLElBQUksQ0FBQzthQUNiO1NBQ0Y7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQsY0FBYyxDQUFDLElBQW9CO1FBQ2pDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLElBQUk7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM5QyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxLQUFhLEVBQUUsTUFBZTs7UUFDN0MsS0FBSyxNQUFNLElBQUksVUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssbUNBQUksRUFBRSxFQUFFO1lBQ3hDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDO2dCQUFFLFNBQVM7WUFDL0MsTUFBTSxFQUFFLEdBQUcsTUFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssYUFBYSxJQUFJLEtBQUssSUFBSSxNQUFNLENBQUMsQ0FBQztnQkFDakUsS0FBSyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzNCLE1BQU0sRUFBRSxHQUFHLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakQsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLEVBQUU7Z0JBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLE9BQUMsSUFBSSxDQUFDLFlBQVksbUNBQUksRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUNyRSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDbEI7U0FDRjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRCxhQUFhLENBQUMsWUFBcUI7UUFDakMsSUFBSSxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDO0lBWTVELENBQUM7SUFTRCxhQUFhLENBQUMsSUFBZ0IsRUFBRSxHQUFXO1FBRXpDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ2hDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ2hDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFHTyxjQUFjLENBQUMsSUFBZ0IsRUFBRSxHQUFRO1FBQy9DLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQzNCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQzNCLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRTtZQUNaLE1BQU0sR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDcEIsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDO2dCQUFFLE9BQU8sSUFBSSxDQUFDO1NBQ3pEO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0NBQ0Y7QUFFRCxNQUFNLFdBQVcsR0FBcUM7SUFDcEQsVUFBVSxFQUFFLENBQUM7SUFDYixXQUFXLEVBQUUsQ0FBQztJQUNkLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLFlBQVksRUFBRSxDQUFDO0NBQ2hCLENBQUM7QUFFRixNQUFNLGdCQUFnQixHQUFHO0lBQ3ZCLElBQUk7SUFDSixNQUFNO0lBQ04sR0FBRztJQUNILElBQUk7Q0FDTCxDQUFDO0FBQ0YsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFFekQsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQVU7SUFDdEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVztJQUN6RSxZQUFZLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU87Q0FDL0QsQ0FBQyxDQUFDO0FBQ0gsTUFBTSxlQUFlLEdBQUcsSUFBSSxHQUFHLENBQVU7SUFDdkMsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxXQUFXO0NBQ3ZELENBQUMsQ0FBQztBQUVILE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxDQUFDLEdBQUcsQ0FDN0MsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDM0QsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEdBQUcsZUFBZSxDQUFDLENBQUMsR0FBRyxDQUMvQyxDQUFDLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29ubmVjdGlvbiwgQ29ubmVjdGlvblR5cGUsIEZlYXR1cmUsIE1ldGFzY3JlZW5EYXRhLFxuICAgICAgICBmZWF0dXJlTWFza30gZnJvbSAnLi9tZXRhc2NyZWVuZGF0YS5qcyc7XG5pbXBvcnQge01ldGF0aWxlc2V0LCBNZXRhdGlsZXNldHN9IGZyb20gJy4vbWV0YXRpbGVzZXQuanMnO1xuaW1wb3J0IHtTY3JlZW59IGZyb20gJy4vc2NyZWVuLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtEZWZhdWx0TWFwfSBmcm9tICcuLi91dGlsLmpzJztcblxuZXhwb3J0IHR5cGUgVWlkID0gbnVtYmVyICYge19fdWlkX186IG5ldmVyfTtcblxuZXhwb3J0IGNsYXNzIE1ldGFzY3JlZW4ge1xuICBwcml2YXRlIHJlYWRvbmx5IF9mZWF0dXJlczogbnVtYmVyOyAvLyA9IG5ldyBTZXQ8RmVhdHVyZT4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBfdGlsZXNldHMgPSBuZXcgU2V0PE1ldGF0aWxlc2V0PigpO1xuICBwcml2YXRlIHJlYWRvbmx5IF9pc0VtcHR5OiBib29sZWFuO1xuICAvLyBrZXk6IGJpdHNldCAtIDEgZm9yIGZsaWdodCwgMiBmb3Igbm9GbGFnXG4gIC8vIHZhbHVlOiBzZWdtZW50cywgZWFjaCBjb250YWluaW5nIGFuIG9mZnNldCB0byBhZGQgdG8gcG9zPDw4IHRvIGdldFxuICAvLyAgICAgICAgY29ubmVjdGlvbiBwb2ludHMgKGUuZy4gMDAwMSwgMDEwMSwgMTAyMCwgZXRjKS5cbiAgcmVhZG9ubHkgY29ubmVjdGlvbnM6IFJlYWRvbmx5QXJyYXk8UmVhZG9ubHlBcnJheTxSZWFkb25seUFycmF5PG51bWJlcj4+PjtcbiAgLy8gVE9ETyAtIGl0IG1pZ2h0IG1ha2Ugc2Vuc2UgdG8gYnVpbGQgaW4gJzw+cCcgaW50byB0aGUgY29ubmVjdGlvbnMgc3RyaW5nLFxuICAvLyBpbmRpY2F0aW5nIHdoaWNoIHBhcnRpdGlvbnMgaGF2ZSBleGl0cyBvciBQT0kgKGluIG9yZGVyKS4gIEJ1dCB0aGUgQVBJXG4gIC8vIGZvciBleHBvc2luZyB0aGlzIGlzIHVnbHkuICBBbm90aGVyIGFsdGVybmF0aXZlIHdvdWxkIGJlIHRvIGRlZGljYXRlXG4gIC8vIGEgcG9ydGlvbiBvZiBcInNwZWN0cnVtXCIgdG8gcG9pIGFuZCBleGl0cywgZS5nLiBbZjAuLmYzXSBmb3IgUE9JLCBbZTAuLmUzXVxuICAvLyBmb3IgZXhpdHMsIGFuZCB0aGVuIHdlIGNhbiBidWlsZCBpdCBkaXJlY3RseSBpbnRvIGNvbm5lY3Rpb25zLCBhbmQgdGhleVxuICAvLyB3aWxsIHNob3cgdXAgaW4gdGhlIHJlc3VsdHMuXG4gIC8vcG9pOiBBcnJheTx7eDogbnVtYmVyLCB5OiBudW1iZXIsIHByaW9yaXR5OiBudW1iZXIsIHNlZ21lbnQ6IG51bWJlcn0+O1xuXG4gIHVzZWQgPSBmYWxzZTtcblxuICBmbGFnPzogJ2Fsd2F5cycgfCAnY2FsbScgfCAnY3VzdG9tOmZhbHNlJyB8ICdjdXN0b206dHJ1ZSc7XG4gIG5hbWU/OiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkgbmVpZ2hib3JzID0gW1xuICAgIG5ldyBEZWZhdWx0TWFwPE1ldGFzY3JlZW4sIGJvb2xlYW4+KChzKSA9PiB0aGlzLl9jaGVja05laWdoYm9yKHMsIDApKSxcbiAgICBuZXcgRGVmYXVsdE1hcDxNZXRhc2NyZWVuLCBib29sZWFuPigocykgPT4gdGhpcy5fY2hlY2tOZWlnaGJvcihzLCAxKSksXG4gIF0gYXMgY29uc3Q7XG5cbiAgLy9yZWFkb25seSBmZWF0dXJlQ291bnQ6IFJlYWRvbmx5TWFwPEZlYXR1cmUsIG51bWJlcj47XG5cbiAgLy8gVE9ETyAtIG1ha2UgZGF0YSBwcml2YXRlP1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSwgcmVhZG9ubHkgdWlkOiBVaWQsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IGRhdGE6IE1ldGFzY3JlZW5EYXRhKSB7XG4gICAgZm9yIChjb25zdCB0aWxlc2V0IG9mIE9iamVjdC52YWx1ZXMoZGF0YS50aWxlc2V0cykpIHtcbiAgICAgIGlmICghdGlsZXNldCEucmVxdWlyZXMpIHRoaXMudXNlZCA9IHRydWU7XG4gICAgfVxuICAgIC8vIGxldCBmaXhlZCA9IGZhbHNlO1xuICAgIC8vIGNvbnN0IGZlYXR1cmVDb3VudCA9IG5ldyBEZWZhdWx0TWFwPEZlYXR1cmUsIG51bWJlcj4oKCkgPT4gMCk7XG4gICAgbGV0IGZlYXR1cmVzID0gMDtcbiAgICBmb3IgKGNvbnN0IGZlYXR1cmUgb2YgZGF0YS5mZWF0dXJlID8/IFtdKSB7XG4gICAgICBjb25zdCBtYXNrID0gZmVhdHVyZU1hc2tbZmVhdHVyZV07XG4gICAgICBpZiAobWFzayAhPSBudWxsKSBmZWF0dXJlcyB8PSBtYXNrO1xuICAgICAgLy8gdGhpcy5fZmVhdHVyZXMuYWRkKGZlYXR1cmUpO1xuICAgICAgLy8gaWYgKGZpeGVkRmVhdHVyZXMuaGFzKGZlYXR1cmUpKSBmaXhlZCA9IHRydWU7XG4gICAgICAvLyBpZiAoZml4ZWRDb3VudEZlYXR1cmVzLmhhcyhmZWF0dXJlKSkge1xuICAgICAgLy8gICBmZWF0dXJlQ291bnQuc2V0KGZlYXR1cmUsIGZlYXR1cmVDb3VudC5nZXQoZmVhdHVyZSkgKyAxKTtcbiAgICAgIC8vIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCBleGl0IG9mIGRhdGEuZXhpdHMgPz8gW10pIHtcbiAgICAgIGlmIChleGl0LnR5cGUgPT09ICdzdGFpcjpkb3duJyB8fCBleGl0LnR5cGUgPT09ICdzdGFpcjp1cCcpIHtcbiAgICAgICAgZmVhdHVyZXMgfD0gZmVhdHVyZU1hc2tbZXhpdC50eXBlXTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fZmVhdHVyZXMgPSBmZWF0dXJlcztcbiAgICB0aGlzLl9pc0VtcHR5ID0gQm9vbGVhbihmZWF0dXJlcyAmIGZlYXR1cmVNYXNrWydlbXB0eSddKTtcbiAgICB0aGlzLmZsYWcgPSBkYXRhLmZsYWc7XG4gICAgLy8gdGhpcy5maXhlZCA9IGZpeGVkO1xuICAgIC8vIHRoaXMuZmVhdHVyZUNvdW50ID0gZmVhdHVyZUNvdW50O1xuICAgIC8vIFRPRE8gLSBidWlsZCBcImNvbm5lY3Rpb25zXCIgYnkgaXRlcmF0aW5nIG92ZXIgMC4uMy5cbiAgICBjb25zdCBjeG46IG51bWJlcltdW11bXSA9IFtbW11dLCBbW11dLCBbW11dLCBbW11dXTtcblxuICAgIHRoaXMuY29ubmVjdGlvbnMgPSBjeG47XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgIGxldCBwb2lJbmRleCA9IDA7XG4gICAgICBsZXQgZXhpdEluZGV4ID0gMDtcbiAgICAgIGxldCBjdXIgPSBjeG5baV1bMF07XG4gICAgICBmb3IgKGNvbnN0IHRlcm0gb2YgdGhpcy5kYXRhLmNvbm5lY3QgPz8gJycpIHtcbiAgICAgICAgaWYgKGNvbm5lY3Rpb25CbG9ja3NbaV0uaW5jbHVkZXModGVybSkpIHtcbiAgICAgICAgICBjeG5baV0ucHVzaChjdXIgPSBbXSk7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGRlbHRhO1xuICAgICAgICBpZiAoY29ubmVjdGlvbkJsb2NrU2V0Lmhhcyh0ZXJtKSkgY29udGludWU7XG4gICAgICAgIGlmICh0ZXJtID09PSAncCcpIHtcbiAgICAgICAgICBkZWx0YSA9IDB4ZjAgfCBwb2lJbmRleCsrO1xuICAgICAgICB9IGVsc2UgaWYgKHRlcm0gPT09ICd4Jykge1xuICAgICAgICAgIGRlbHRhID0gMHhlMCB8IGV4aXRJbmRleCsrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IG51bSA9IHBhcnNlSW50KHRlcm0sIDE2KTtcbiAgICAgICAgICBpZiAoIW51bSkgdGhyb3cgbmV3IEVycm9yKGBiYWQgdGVybTogJyR7dGVybX0nYCk7IC8vIGNvbnRpbnVlPz8/XG4gICAgICAgICAgY29uc3QgY2hhbm5lbCA9IChudW0gJiAzKSA8PCAobnVtICYgNCk7IC8vIDAxLCAwMiwgMDMsIDEwLCAyMCwgb3IgMzBcbiAgICAgICAgICBjb25zdCBvZmZzZXQgPSBudW0gJiA4ID8gKG51bSAmIDQgPyAweDAxMDAgOiAweDEwMDApIDogMDtcbiAgICAgICAgICBkZWx0YSA9IGNoYW5uZWwgfCBvZmZzZXQ7XG4gICAgICAgIH1cbiAgICAgICAgY3VyLnB1c2goZGVsdGEpO1xuICAgICAgfVxuICAgICAgd2hpbGUgKHBvaUluZGV4IDwgdGhpcy5kYXRhLnBvaT8ubGVuZ3RoISkge1xuICAgICAgICBjdXIucHVzaCgweGYwIHwgcG9pSW5kZXgrKyk7XG4gICAgICB9XG4gICAgICB3aGlsZSAoZXhpdEluZGV4IDwgdGhpcy5kYXRhLmV4aXRzPy5sZW5ndGghKSB7XG4gICAgICAgIGN1ci5wdXNoKDB4ZTAgfCBleGl0SW5kZXgrKyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0IGZlYXR1cmVzKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX2ZlYXR1cmVzO1xuICB9XG5cbiAgZ2V0IG1hbnVhbCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbih0aGlzLl9mZWF0dXJlcyAmIG1hbnVhbEZlYXR1cmVNYXNrKTtcbiAgfVxuXG4gIGdldCBjb3VudGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBCb29sZWFuKHRoaXMuX2ZlYXR1cmVzICYgY291bnRlZEZlYXR1cmVNYXNrKTtcbiAgfVxuXG4gIC8vIGZlYXR1cmVzKCk6IEl0ZXJhYmxlPEZlYXR1cmU+IHtcbiAgLy8gICByZXR1cm4gdGhpcy5fZmVhdHVyZXMudmFsdWVzKCk7XG4gIC8vIH1cblxuICBoYXNGZWF0dXJlKGZlYXR1cmU6IEZlYXR1cmUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbih0aGlzLl9mZWF0dXJlcyAmIGZlYXR1cmVNYXNrW2ZlYXR1cmVdKTtcbiAgfVxuXG4gIGhhc0ZlYXR1cmVzKGZlYXR1cmVzOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKHRoaXMuX2ZlYXR1cmVzICYgZmVhdHVyZXMpID09PSBmZWF0dXJlcztcbiAgfVxuXG4gIC8qKiBSZXR1cm4gYSBuZXcgbWV0YXNjcmVlbiB3aXRoIHRoZSBzYW1lIHByb2ZpbGUgYnV0IGFuIGV4dHJhIGZlYXR1cmUuICovXG4gIHdpdGhGZWF0dXJlKGZlYXR1cmU6IEZlYXR1cmUpOiBNZXRhc2NyZWVuW10ge1xuICAgIC8vIFRPRE8gLSBpbmRleCB0aGlzP1xuICAgIHRocm93IG5ldyBFcnJvcigpO1xuICB9XG5cbiAgaXNFbXB0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5faXNFbXB0eTtcbiAgfVxuXG4gIGhhc1N0YWlyKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBCb29sZWFuKHRoaXMuX2ZlYXR1cmVzICYgKGZlYXR1cmVNYXNrWydzdGFpcjp1cCddIHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlTWFza1snc3RhaXI6ZG93biddKSk7XG4gIH1cblxuICAvKiogUmV0dXJuIGEgbmV3IG1ldGFzY3JlZW4gd2l0aCB0aGUgc2FtZSBwcm9maWxlIGJ1dCBtb3JlIG9ic3RydWN0ZWQuICovXG4gIHdpdGhPYnN0cnVjdGlvbigpOiBNZXRhc2NyZWVuW10ge1xuICAgIHRocm93IG5ldyBFcnJvcigpO1xuICB9XG5cbiAgaXNDb21wYXRpYmxlV2l0aFRpbGVzZXQoaWQ6IG51bWJlcikge1xuICAgIGZvciAoY29uc3QgdGlsZXNldCBvZiB0aGlzLl90aWxlc2V0cykge1xuICAgICAgaWYgKHRpbGVzZXQudGlsZXNldElkID09PSBpZCkgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXBsYWNlIG9jY3VycmVuY2VzIG9mIGEgbWV0YXRpbGUgd2l0aGluIHRoaXMgc2NyZWVuLlxuICAgKi9cbiAgcmVwbGFjZShmcm9tOiBudW1iZXIsIHRvOiBudW1iZXIpOiBNZXRhc2NyZWVuIHtcbiAgICBjb25zdCB7dGlsZXN9ID0gdGhpcy5zY3JlZW47XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aWxlcy5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHRpbGVzW2ldID09PSBmcm9tKSB0aWxlc1tpXSA9IHRvO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHJlbW92ZSgpIHtcbiAgICAvLyBSZW1vdmUgc2VsZiBmcm9tIGFsbCBtZXRhdGlsZXNldHMuICBVc2VkIGJ5IGxhYnlyaW50aFZhcmlhbnQgdG9cbiAgICAvLyBlbnN1cmUgaW1wb3NzaWJsZSB2YXJpYW50cyBhcmVuJ3QgYWRkZWQgKG5vdGU6IHdpdGggYSBkZWRpY2F0ZWRcbiAgICAvLyBwYWdlIHdlIGNvdWxkIG1ha2UgbW9yZSBhdmFpbGFibGUpLlxuICAgIGZvciAoY29uc3QgdGlsZXNldCBvZiB0aGlzLnRpbGVzZXRzKCkpIHtcbiAgICAgIHRpbGVzZXQuZGVsZXRlU2NyZWVuKHRoaXMpO1xuICAgIH1cbiAgfVxuXG4gIHRpbGVzZXRzKCk6IE1ldGF0aWxlc2V0W10ge1xuICAgIGNvbnN0IHRpbGVzZXRzOiBNZXRhdGlsZXNldFtdID0gW107XG4gICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5kYXRhLnRpbGVzZXRzKSB7XG4gICAgICB0aWxlc2V0cy5wdXNoKFxuICAgICAgICAgIHRoaXMucm9tLm1ldGF0aWxlc2V0c1trZXkgYXMga2V5b2YgTWV0YXRpbGVzZXRzXSBhcyBNZXRhdGlsZXNldCk7XG4gICAgfVxuICAgIHJldHVybiB0aWxlc2V0cztcbiAgfVxuXG4gIHNldEdyaWRUaWxlKC4uLnRpbGU6IHN0cmluZ1tdKSB7XG4gICAgdGhpcy5kYXRhLnRpbGUgPSB0aWxlO1xuICAgIGZvciAoY29uc3QgdGlsZXNldCBvZiB0aGlzLnRpbGVzZXRzKCkpIHtcbiAgICAgIHRpbGVzZXQuaW52YWxpZGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIGdyaWRUaWxlcygpOiBzdHJpbmdbXSB7XG4gICAgbGV0IHQgPSB0aGlzLmRhdGEudGlsZSA/PyBbXTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkodCkpIHQgPSBbdF07XG4gICAgcmV0dXJuIHQubWFwKHMgPT4gcy5yZXBsYWNlKC9cXHwvZywgJycpKTtcbiAgfVxuXG4gIGdldCBzaWQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhLmlkO1xuICB9XG5cbiAgc2V0IHNpZChzaWQ6IG51bWJlcikge1xuICAgIGlmICh0aGlzLnNpZCA9PT0gc2lkKSByZXR1cm47XG4gICAgdGhpcy5yb20ubWV0YXNjcmVlbnMucmVudW1iZXIodGhpcy5zaWQsIHNpZCk7XG4gIH1cblxuICBnZXQgc2NyZWVuKCk6IFNjcmVlbiB7XG4gICAgY29uc3Qge3NpZCwgcm9tOiB7c2NyZWVuc319ID0gdGhpcztcbiAgICByZXR1cm4gc2lkIDwgMCA/IHNjcmVlbnMudW5hbGxvY2F0ZWRbfnNpZF0gOiBzY3JlZW5zW3NpZF07XG4gIH1cblxuICAvLyBPbmx5IE1ldGFzY3JlZW5zLnJlbnVtYmVyIHNob3VsZCBjYWxsIHRoaXMuXG4gIHVuc2FmZVNldElkKHNpZDogbnVtYmVyKSB7XG4gICAgKHRoaXMuZGF0YSBhcyB7aWQ6IG51bWJlcn0pLmlkID0gc2lkO1xuICAgIGZvciAoY29uc3QgdGlsZXNldCBvZiB0aGlzLl90aWxlc2V0cykge1xuICAgICAgdGlsZXNldC5pbnZhbGlkYXRlKCk7XG4gICAgfVxuICB9XG4gIC8vIE9ubHkgTWV0YXRpbGVzZXQuYWRkU2NyZWVuIHNob3VsZCBjYWxsIHRoaXMuXG4gIHVuc2FmZUFkZFRpbGVzZXQodGlsZXNldDogTWV0YXRpbGVzZXQpIHtcbiAgICB0aGlzLl90aWxlc2V0cy5hZGQodGlsZXNldCk7XG4gIH1cbiAgLy8gT25seSBNZXRhdGlsZXNldC5yZW1vdmVTY3JlZW4gc2hvdWxkIGNhbGwgdGhpcy5cbiAgdW5zYWZlUmVtb3ZlVGlsZXNldCh0aWxlc2V0OiBNZXRhdGlsZXNldCkge1xuICAgIHRoaXMuX3RpbGVzZXRzLmRlbGV0ZSh0aWxlc2V0KTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGEgYml0IG1hc2sgb2YgZWRnZXMgdGhhdCBfY291bGRfIGV4aXQ6IDE9TiwgMj1XLCA0PVMsIDg9RS4gKi9cbiAgZWRnZUV4aXRzKCk6IG51bWJlciB7XG4gICAgbGV0IG1hc2sgPSAwO1xuICAgIGZvciAoY29uc3QgZSBvZiB0aGlzLmRhdGEuZXhpdHMgPz8gW10pIHtcbiAgICAgIGNvbnN0IGRpciA9IGVkZ2VUeXBlTWFwW2UudHlwZV07XG4gICAgICBpZiAoZGlyICE9IG51bGwpIG1hc2sgfD0gKDEgPDwgZGlyKTtcbiAgICB9XG4gICAgcmV0dXJuIG1hc2s7XG4gIH1cblxuICBlZGdlSW5kZXgoZWRnZVR5cGU6IHN0cmluZyk6IG51bWJlcnx1bmRlZmluZWQge1xuICAgIGxldCBpbmRleCA9IDA7XG4gICAgY29uc3QgZWRnZSA9IHRoaXMuZGF0YS5lZGdlcyA/PyAnJztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgaWYgKGVkZ2VbaV0gPT09ICcgJykgY29udGludWU7XG4gICAgICBpZiAoZWRnZVtpXSAhPT0gZWRnZVR5cGUpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICBpbmRleCB8PSAoMSA8PCBpKTtcbiAgICB9XG4gICAgcmV0dXJuIGluZGV4O1xuICB9XG5cbiAgZmluZEV4aXRUeXBlKHRpbGU6IG51bWJlciwgc2luZ2xlOiBib29sZWFuLFxuICAgICAgICAgICAgICAgc2VhbWxlc3M6IGJvb2xlYW4pOiBDb25uZWN0aW9ufHVuZGVmaW5lZCB7XG4gICAgZm9yIChjb25zdCBleGl0IG9mIHRoaXMuZGF0YS5leGl0cyA/PyBbXSkge1xuICAgICAgaWYgKGV4aXQudHlwZS5zdGFydHNXaXRoKCdzZWFtbGVzcycpICE9PSBzZWFtbGVzcykgY29udGludWU7XG4gICAgICBjb25zdCB0MCA9IHNpbmdsZSAmJiBleGl0LnR5cGUgPT09ICdlZGdlOmJvdHRvbScgJiYgdGlsZSA+PSAweGMwID9cbiAgICAgICAgICB0aWxlICsgMHgyMCA6IHRpbGU7XG4gICAgICBpZiAoZXhpdC5leGl0cy5pbmNsdWRlcyh0MCkgfHwgKGV4aXQuYWxsb3dlZEV4aXRzID8/IFtdKS5pbmNsdWRlcyh0MCkpIHtcbiAgICAgICAgcmV0dXJuIGV4aXQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBmaW5kRXhpdEJ5VHlwZSh0eXBlOiBDb25uZWN0aW9uVHlwZSk6IENvbm5lY3Rpb24ge1xuICAgIGNvbnN0IGV4aXQgPSB0aGlzLmRhdGEuZXhpdHMhLmZpbmQoZSA9PiBlLnR5cGUgPT09IHR5cGUpO1xuICAgIGlmICghZXhpdCkgdGhyb3cgbmV3IEVycm9yKGBubyBleGl0ICR7dHlwZX1gKTtcbiAgICByZXR1cm4gZXhpdDtcbiAgfVxuXG4gIGZpbmRFbnRyYW5jZVR5cGUoY29vcmQ6IG51bWJlciwgc2luZ2xlOiBib29sZWFuKTogQ29ubmVjdGlvblR5cGV8dW5kZWZpbmVkIHtcbiAgICBmb3IgKGNvbnN0IGV4aXQgb2YgdGhpcy5kYXRhLmV4aXRzID8/IFtdKSB7XG4gICAgICBpZiAoZXhpdC50eXBlLnN0YXJ0c1dpdGgoJ3NlYW1sZXNzJykpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgYzAgPSBzaW5nbGUgJiYgZXhpdC50eXBlID09PSAnZWRnZTpib3R0b20nICYmIGNvb3JkID49IDB4YmYwMCA/XG4gICAgICAgICAgY29vcmQgKyAweDIwMDAgOiBjb29yZDtcbiAgICAgIGNvbnN0IHQwID0gKGMwICYgMHhmMCkgPj4gNCB8IChjMCAmIDB4ZjAwMCkgPj4gODtcbiAgICAgIGlmIChleGl0LmVudHJhbmNlID09PSBjMCB8fFxuICAgICAgICAgIGV4aXQuZXhpdHMuaW5jbHVkZXModDApIHx8IChleGl0LmFsbG93ZWRFeGl0cyA/PyBbXSkuaW5jbHVkZXModDApKSB7XG4gICAgICAgIHJldHVybiBleGl0LnR5cGU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBhZGRDdXN0b21GbGFnKGRlZmF1bHRWYWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuZmxhZyA9IGRlZmF1bHRWYWx1ZSA/ICdjdXN0b206dHJ1ZScgOiAnY3VzdG9tOmZhbHNlJztcblxuICAgIC8vIFRPRE8gLSBmb3Igbm93LCBjdXN0b20gZmxhZ3MgYXJlIHNldCBieSBkZWZhdWx0LlxuXG4gICAgLy8gaWYgKCFmbGFnQWxsKSByZXR1cm47XG4gICAgLy8gZm9yIChjb25zdCBsb2Mgb2YgdGhpcy5yb20ubG9jYXRpb25zKSB7XG4gICAgLy8gICBpZiAoIWxvYy51c2VkKSBjb250aW51ZTtcbiAgICAvLyAgIGZvciAoY29uc3QgcG9zIG9mIGxvYy5tZXRhLmFsbFBvcygpKSB7XG4gICAgLy8gICAgIGlmIChsb2MubWV0YS5nZXRVaWQocG9zKSAhPT0gdGhpcy51aWQpIGNvbnRpbnVlO1xuICAgIC8vICAgICBsb2MubWV0YS5jdXN0b21GbGFncy5zZXQocG9zLCB0aGlzLnJvbS5mbGFncy5BbHdheXNUcnVlKTtcbiAgICAvLyAgIH1cbiAgICAvLyB9XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIHRoaXMgY2FuIG5laWdoYm9yIHRoYXQgaW4gJ2RpcicgZGlyZWN0aW9uLlxuICAgKiBJZiBkaXIgaXMgMCwgY2hlY2tzIHRoYXQgJ3RoYXQnIGlzIGFib3ZlICd0aGlzJy5cbiAgICogSWYgZGlyIGlzIDEsIGNoZWNrcyB0aGF0ICd0aGF0JyBpcyBsZWZ0IG9mICd0aGlzJy5cbiAgICogSWYgZGlyIGlzIDIsIGNoZWNrcyB0aGF0ICd0aGF0JyBpcyBiZWxvdyAndGhpcycuXG4gICAqIElmIGRpciBpcyAzLCBjaGVja3MgdGhhdCAndGhhdCcgaXMgcmlnaHQgb2YgJ3RoaXMnLlxuICAgKi9cbiAgY2hlY2tOZWlnaGJvcih0aGF0OiBNZXRhc2NyZWVuLCBkaXI6IG51bWJlcikge1xuICAgIC8vIGNoZWNrOiAwIC0+IHRoYXRbdmVydF0uZ2V0KHRoaXMpIC0+IHRoaXMgaXMgdW5kZXIgdGhhdFxuICAgIGNvbnN0IGEgPSBkaXIgJiAyID8gdGhpcyA6IHRoYXQ7XG4gICAgY29uc3QgYiA9IGRpciAmIDIgPyB0aGF0IDogdGhpcztcbiAgICByZXR1cm4gYS5uZWlnaGJvcnNbZGlyICYgMV0uZ2V0KGIpO1xuICB9XG5cbiAgLyoqIEBwYXJhbSBkaXIgMCB0byBjaGVjayBpZiB0aGF0IGlzIHVuZGVyIHRoaXMsIDEgaWYgdGhhdCBpcyByaWdodCBvZiB0aGlzICovXG4gIHByaXZhdGUgX2NoZWNrTmVpZ2hib3IodGhhdDogTWV0YXNjcmVlbiwgZGlyOiAwfDEpOiBib29sZWFuIHtcbiAgICBjb25zdCBlMSA9IHRoaXMuZGF0YS5lZGdlcztcbiAgICBjb25zdCBlMiA9IHRoYXQuZGF0YS5lZGdlcztcbiAgICBpZiAoZTEgJiYgZTIpIHtcbiAgICAgIGNvbnN0IG9wcCA9IGRpciBeIDI7XG4gICAgICBpZiAoZTFbb3BwXSAhPT0gJyonICYmIGUxW29wcF0gPT09IGUyW2Rpcl0pIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuY29uc3QgZWRnZVR5cGVNYXA6IHtbQyBpbiBDb25uZWN0aW9uVHlwZV0/OiBudW1iZXJ9ID0ge1xuICAnZWRnZTp0b3AnOiAwLFxuICAnZWRnZTpsZWZ0JzogMSxcbiAgJ2VkZ2U6Ym90dG9tJzogMixcbiAgJ2VkZ2U6cmlnaHQnOiAzLFxufTtcblxuY29uc3QgY29ubmVjdGlvbkJsb2NrcyA9IFtcbiAgJ3w6JywgLy8gYnJlYWsgd2FsbCwgZm9ybSBicmlkZ2UsIGJ1dCBubyBmbGlnaHRcbiAgJ3w6PS0nLCAvLyBubyB3YWxscy9icmlkZ2UvZmxpZ2h0XG4gICd8JywgLy8gZmxpZ2h0IGFuZCBicmVhayB3YWxsc1xuICAnfD0nLCAvLyBmbGlnaHQgb25seVxuXTtcbmNvbnN0IGNvbm5lY3Rpb25CbG9ja1NldCA9IG5ldyBTZXQoWyd8JywgJzonLCAnLScsICc9J10pO1xuXG5jb25zdCBtYW51YWxGZWF0dXJlcyA9IG5ldyBTZXQ8RmVhdHVyZT4oW1xuICAnYXJlbmEnLCAncG9ydG9hMScsICdwb3J0b2EyJywgJ3BvcnRvYTMnLCAnbGFrZScsICdvdmVycGFzcycsICd1bmRlcnBhc3MnLFxuICAnbGlnaHRob3VzZScsICdjYWJpbicsICd3aW5kbWlsbCcsICdhbHRhcicsICdweXJhbWlkJywgJ2NyeXB0Jyxcbl0pO1xuY29uc3QgY291bnRlZEZlYXR1cmVzID0gbmV3IFNldDxGZWF0dXJlPihbXG4gICdwaXQnLCAnc3Bpa2VzJywgJ2JyaWRnZScsICd3YWxsJywgJ3JhbXAnLCAnd2hpcmxwb29sJyxcbl0pO1xuXG5jb25zdCBtYW51YWxGZWF0dXJlTWFzayA9IFsuLi5tYW51YWxGZWF0dXJlc10ubWFwKFxuICAgIGYgPT4gZmVhdHVyZU1hc2tbZl0gYXMgbnVtYmVyKS5yZWR1Y2UoKGEsIGIpID0+IGEgfCBiKTtcbmNvbnN0IGNvdW50ZWRGZWF0dXJlTWFzayA9IFsuLi5jb3VudGVkRmVhdHVyZXNdLm1hcChcbiAgICBmID0+IGZlYXR1cmVNYXNrW2ZdIGFzIG51bWJlcikucmVkdWNlKChhLCBiKSA9PiBhIHwgYik7XG4iXX0=