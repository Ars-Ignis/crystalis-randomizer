#!/usr/bin/env node -r esm
import './build_info.js';
import { EXPECTED_CRC32 } from './rom.js';
import { FlagSet, PRESETS } from './flagset.js';
import { crc32 } from './crc32.js';
import * as fs from 'fs';
import * as patch from './patch.js';
import { UsageError, breakLines } from './util.js';
import { NodeReader } from './nodereader.js';
import * as version from './version.js';
import { disableAsserts } from './assert.js';
const usage = (code) => {
    console.log(`Crystalis Randomizer v${version.VERSION}
Usage: cryr [OPTIONS...] rom.nes

Options
  --flags=FLAGSET    Specify the flagset.
  --preset=PRESET    Specify the preset by name.
                     Spaces and capitalization are ignored.
  --seed=SEED        Specify the seed.
  --output=PATTERN   Specify the output filename pattern.
                     May include placeholders:
                       %n: input base filename
                       %v: cryr version hash
                       %s: seed
                       %f: flagset
                       %c: checksum
                     The default pattern is "%n_%c".
  --count=NUMBER     Number of shuffled roms to generate.
                     This flag is not compatible with specifying
                     a seed manually, nor with output patterns
                     that don't include %s or %c.
  --force            Don't fail due to wrong input file checksum.

Flags
  The randomizer supports a number of options, documented in detail
  at https://crystalisrandomizer.com.  Spaces are ignored.

Presets
${PRESETS.map(showPreset).join('\n\n')}`);
    process.exit(code);
};
const showPreset = ({ title, flags, descr }) => {
    const LINE_LENGTH = 68;
    const flagLen = LINE_LENGTH - title.length - 6;
    const flagLines = breakLines(flags, flagLen);
    const descrLines = breakLines(descr, LINE_LENGTH - 2);
    const indent = '\n' + ' '.repeat(title.length + 5);
    return `  ${title}: "${flagLines.join(indent)}"
  ${descrLines.join('\n  ')}`;
};
const main = (...args) => {
    let flags = '@FullShuffle';
    let count = 1;
    let seed = '';
    let output = '%n_%c';
    let force = false;
    while (args[0] && args[0].startsWith('--')) {
        let arg = args.shift().substring(2);
        let value = undefined;
        const eq = arg.indexOf('=');
        if (eq >= 0) {
            value = arg.substring(eq + 1);
            arg = arg.substring(0, eq);
        }
        else {
            value = args.shift();
        }
        if (arg == 'flags' && value) {
            flags = value;
        }
        else if (arg == 'preset' && value) {
            flags = '@' + value.replace(/ /g, '');
        }
        else if (arg == 'output' && value) {
            output = value;
        }
        else if (arg == 'seed' && value) {
            seed = value;
        }
        else if (arg == 'count' && value) {
            count = Number(value);
        }
        else if (arg == 'force') {
            force = true;
            disableAsserts();
            if (value != null)
                args.unshift(value);
        }
        else if (arg == 'help') {
            usage(0);
        }
        else if (arg == 'version' || arg == '-v') {
            console.log(version.VERSION);
            process.exit(0);
        }
        else if (arg == 'list-presets') {
            for (const { title } of PRESETS) {
                console.log(title.replace(/ /g, ''));
            }
            process.exit(0);
        }
        else {
            console.error(`Bad argument: ${arg}`);
            usage(1);
        }
    }
    if (args.length != 1)
        usage(1);
    if (count > 1) {
        if (seed)
            fail('Cannot specify both --count and --seed');
        if (!/%[sc]/.test(output)) {
            fail('--output must have a %c or %s placeholder when --count is given');
        }
    }
    const flagset = new FlagSet(flags);
    const rom = new Uint8Array(fs.readFileSync(args[0]).buffer);
    if (crc32(rom) != EXPECTED_CRC32) {
        console.error(`WARNING: Bad CRC for input rom: ${crc32(rom).toString(16)}`);
        if (!force)
            fail('Run with --force to proceed anyway');
        console.error('Proceeding anyway');
    }
    return Promise.all(new Array(count).fill(0).map(async () => {
        const s = patch.parseSeed(seed);
        console.log(`Seed: ${s.toString(16)}`);
        const shuffled = rom.slice();
        const c = await patch.shuffle(shuffled, s, flagset, new NodeReader());
        const n = args[0].replace('.nes', '');
        const f = String(flagset).replace(/ /g, '');
        const v = version.VERSION;
        const filename = fillTemplate(output, { c, n, s, v, f, '%': '%' }) + '.nes';
        await new Promise((resolve, reject) => fs.writeFile(filename, shuffled, (err) => err ? reject(err) : resolve()));
        console.log(`Wrote ${filename}`);
    }));
};
function fail(message) {
    console.error(message);
    throw process.exit(2);
}
function fillTemplate(str, arg) {
    const terms = [];
    while (str) {
        const index = str.indexOf('%');
        if (index < 0) {
            terms.push(str);
            str = '';
        }
        else {
            terms.push(str.substring(0, index));
            const ch = str[index + 1];
            if (!(ch in arg))
                throw new Error(`Bad placeholder: %${ch}`);
            terms.push(arg[ch]);
            str = str.substring(index + 2);
        }
    }
    return terms.join('');
}
process.on('unhandledRejection', (error) => {
    console.error(typeof error === 'string' ?
        error :
        error instanceof UsageError ? error.message : error.stack);
    process.exit(1);
});
const asyncMain = async () => {
    try {
        await main(...process.argv.slice(2));
    }
    catch (error) {
        if (error instanceof UsageError) {
            console.error(error.message);
            console.error(`Try passing --help for documentation.`);
            process.exit(1);
        }
        throw error;
    }
};
asyncMain()
    .then(() => process.exit(0));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2pzL2NsaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxpQkFBaUIsQ0FBQztBQUV6QixPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ3hDLE9BQU8sRUFBQyxPQUFPLEVBQUUsT0FBTyxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBRTlDLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDakMsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLEtBQUssTUFBTSxZQUFZLENBQUM7QUFDcEMsT0FBTyxFQUFDLFVBQVUsRUFBRSxVQUFVLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDakQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sS0FBSyxPQUFPLE1BQU0sY0FBYyxDQUFDO0FBQ3hDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxhQUFhLENBQUM7QUFJM0MsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRTtJQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixPQUFPLENBQUMsT0FBTzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0VBMkJwRCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNyQixDQUFDLENBQUM7QUFFRixNQUFNLFVBQVUsR0FBRyxDQUFDLEVBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQVMsRUFBRSxFQUFFO0lBQ25ELE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQztJQUN2QixNQUFNLE9BQU8sR0FBRyxXQUFXLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FB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cEM7SUFFRCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUN6RCxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN2QyxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDN0IsTUFBTSxDQUFDLEdBQUcsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksVUFBVSxFQUFFLENBQUMsQ0FBQztRQUN0RSxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN0QyxNQUFNLENBQUMsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUM1QyxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1FBQzFCLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxNQUFNLEVBQUUsRUFBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUMxRSxNQUFNLElBQUksT0FBTyxDQUNiLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FDN0IsUUFBUSxFQUFFLFFBQVEsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyRSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUNuQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ04sQ0FBQyxDQUFDO0FBRUYsU0FBUyxJQUFJLENBQUMsT0FBZTtJQUMzQixPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZCLE1BQU0sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN4QixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsR0FBVyxFQUFFLEdBQTZCO0lBQzlELE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUNqQixPQUFPLEdBQUcsRUFBRTtRQUNWLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFO1lBQ2IsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQixHQUFHLEdBQUcsRUFBRSxDQUFDO1NBQ1Y7YUFBTTtZQUNMLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNwQyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUM7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUM3RCxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLEdBQUcsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztTQUNoQztLQUNGO0lBQ0QsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxPQUFPLENBQUMsRUFBRSxDQUFDLG9CQUFvQixFQUFFLENBQUMsS0FBVSxFQUFFLEVBQUU7SUFDOUMsT0FBTyxDQUFDLEtBQUssQ0FDVCxPQUFPLEtBQUssS0FBSyxRQUFRLENBQUMsQ0FBQztRQUN2QixLQUFLLENBQUMsQ0FBQztRQUNQLEtBQUssWUFBWSxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxTQUFTLEdBQ1gsS0FBSyxJQUFJLEVBQUU7SUFDYixJQUFJO1FBQ0YsTUFBTSxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3RDO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZCxJQUFJLEtBQUssWUFBWSxVQUFVLEVBQUU7WUFDL0IsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDN0IsT0FBTyxDQUFDLEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO1lBQ3ZELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDakI7UUFDRCxNQUFNLEtBQUssQ0FBQztLQUNiO0FBQ0gsQ0FBQyxDQUFBO0FBRWUsU0FBUyxFQUFFO0tBQ04sSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGUgLXIgZXNtXG5cbmltcG9ydCAnLi9idWlsZF9pbmZvLmpzJzsgLy8gc2lkZSBlZmZlY3QgZ2xvYmFsIHNldCAoYWZmZWN0cyB2ZXJzaW9uIG1vZHVsZSlcblxuaW1wb3J0IHtFWFBFQ1RFRF9DUkMzMn0gZnJvbSAnLi9yb20uanMnO1xuaW1wb3J0IHtGbGFnU2V0LCBQUkVTRVRTfSBmcm9tICcuL2ZsYWdzZXQuanMnO1xuaW1wb3J0IHtQcmVzZXR9IGZyb20gJy4vZmxhZ3MvZmxhZy5qcyc7XG5pbXBvcnQge2NyYzMyfSBmcm9tICcuL2NyYzMyLmpzJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGNoIGZyb20gJy4vcGF0Y2guanMnO1xuaW1wb3J0IHtVc2FnZUVycm9yLCBicmVha0xpbmVzfSBmcm9tICcuL3V0aWwuanMnO1xuaW1wb3J0IHtOb2RlUmVhZGVyfSBmcm9tICcuL25vZGVyZWFkZXIuanMnO1xuaW1wb3J0ICogYXMgdmVyc2lvbiBmcm9tICcuL3ZlcnNpb24uanMnO1xuaW1wb3J0IHtkaXNhYmxlQXNzZXJ0c30gZnJvbSAnLi9hc3NlcnQuanMnO1xuXG4vLyBVc2FnZTogbm9kZSBjbGkuanMgWy0tZmxhZ3M9PEZMQUdTPl0gWy0tc2VlZD08U0VFRD5dIHJvbS5uZXNcblxuY29uc3QgdXNhZ2UgPSAoY29kZTogbnVtYmVyKSA9PiB7XG4gIGNvbnNvbGUubG9nKGBDcnlzdGFsaXMgUmFuZG9taXplciB2JHt2ZXJzaW9uLlZFUlNJT059XG5Vc2FnZTogY3J5ciBbT1BUSU9OUy4uLl0gcm9tLm5lc1xuXG5PcHRpb25zXG4gIC0tZmxhZ3M9RkxBR1NFVCAgICBTcGVjaWZ5IHRoZSBmbGFnc2V0LlxuICAtLXByZXNldD1QUkVTRVQgICAgU3BlY2lmeSB0aGUgcHJlc2V0IGJ5IG5hbWUuXG4gICAgICAgICAgICAgICAgICAgICBTcGFjZXMgYW5kIGNhcGl0YWxpemF0aW9uIGFyZSBpZ25vcmVkLlxuICAtLXNlZWQ9U0VFRCAgICAgICAgU3BlY2lmeSB0aGUgc2VlZC5cbiAgLS1vdXRwdXQ9UEFUVEVSTiAgIFNwZWNpZnkgdGhlIG91dHB1dCBmaWxlbmFtZSBwYXR0ZXJuLlxuICAgICAgICAgICAgICAgICAgICAgTWF5IGluY2x1ZGUgcGxhY2Vob2xkZXJzOlxuICAgICAgICAgICAgICAgICAgICAgICAlbjogaW5wdXQgYmFzZSBmaWxlbmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAldjogY3J5ciB2ZXJzaW9uIGhhc2hcbiAgICAgICAgICAgICAgICAgICAgICAgJXM6IHNlZWRcbiAgICAgICAgICAgICAgICAgICAgICAgJWY6IGZsYWdzZXRcbiAgICAgICAgICAgICAgICAgICAgICAgJWM6IGNoZWNrc3VtXG4gICAgICAgICAgICAgICAgICAgICBUaGUgZGVmYXVsdCBwYXR0ZXJuIGlzIFwiJW5fJWNcIi5cbiAgLS1jb3VudD1OVU1CRVIgICAgIE51bWJlciBvZiBzaHVmZmxlZCByb21zIHRvIGdlbmVyYXRlLlxuICAgICAgICAgICAgICAgICAgICAgVGhpcyBmbGFnIGlzIG5vdCBjb21wYXRpYmxlIHdpdGggc3BlY2lmeWluZ1xuICAgICAgICAgICAgICAgICAgICAgYSBzZWVkIG1hbnVhbGx5LCBub3Igd2l0aCBvdXRwdXQgcGF0dGVybnNcbiAgICAgICAgICAgICAgICAgICAgIHRoYXQgZG9uJ3QgaW5jbHVkZSAlcyBvciAlYy5cbiAgLS1mb3JjZSAgICAgICAgICAgIERvbid0IGZhaWwgZHVlIHRvIHdyb25nIGlucHV0IGZpbGUgY2hlY2tzdW0uXG5cbkZsYWdzXG4gIFRoZSByYW5kb21pemVyIHN1cHBvcnRzIGEgbnVtYmVyIG9mIG9wdGlvbnMsIGRvY3VtZW50ZWQgaW4gZGV0YWlsXG4gIGF0IGh0dHBzOi8vY3J5c3RhbGlzcmFuZG9taXplci5jb20uICBTcGFjZXMgYXJlIGlnbm9yZWQuXG5cblByZXNldHNcbiR7UFJFU0VUUy5tYXAoc2hvd1ByZXNldCkuam9pbignXFxuXFxuJyl9YCk7XG4gIHByb2Nlc3MuZXhpdChjb2RlKTtcbn07XG5cbmNvbnN0IHNob3dQcmVzZXQgPSAoe3RpdGxlLCBmbGFncywgZGVzY3J9OiBQcmVzZXQpID0+IHtcbiAgY29uc3QgTElORV9MRU5HVEggPSA2ODtcbiAgY29uc3QgZmxhZ0xlbiA9IExJTkVfTEVOR1RIIC0gdGl0bGUubGVuZ3RoIC0gNjtcbiAgY29uc3QgZmxhZ0xpbmVzID0gYnJlYWtMaW5lcyhmbGFncywgZmxhZ0xlbik7XG4gIGNvbnN0IGRlc2NyTGluZXMgPSBicmVha0xpbmVzKGRlc2NyLCBMSU5FX0xFTkdUSCAtIDIpO1xuICBjb25zdCBpbmRlbnQgPSAnXFxuJyArICcgJy5yZXBlYXQodGl0bGUubGVuZ3RoICsgNSk7XG4gIHJldHVybiBgICAke3RpdGxlfTogXCIke2ZsYWdMaW5lcy5qb2luKGluZGVudCl9XCJcbiAgJHtkZXNjckxpbmVzLmpvaW4oJ1xcbiAgJyl9YDtcbn07XG5cbmNvbnN0IG1haW4gPSAoLi4uYXJnczogc3RyaW5nW10pID0+IHtcbiAgbGV0IGZsYWdzID0gJ0BGdWxsU2h1ZmZsZSc7XG4gIGxldCBjb3VudCA9IDE7XG4gIGxldCBzZWVkID0gJyc7XG4gIGxldCBvdXRwdXQgPSAnJW5fJWMnO1xuICBsZXQgZm9yY2UgPSBmYWxzZTtcbiAgd2hpbGUgKGFyZ3NbMF0gJiYgYXJnc1swXS5zdGFydHNXaXRoKCctLScpKSB7XG4gICAgbGV0IGFyZyA9IGFyZ3Muc2hpZnQoKSEuc3Vic3RyaW5nKDIpO1xuICAgIGxldCB2YWx1ZSA9IHVuZGVmaW5lZDtcbiAgICBjb25zdCBlcSA9IGFyZy5pbmRleE9mKCc9Jyk7XG4gICAgaWYgKGVxID49IDApIHtcbiAgICAgIHZhbHVlID0gYXJnLnN1YnN0cmluZyhlcSArIDEpO1xuICAgICAgYXJnID0gYXJnLnN1YnN0cmluZygwLCBlcSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhbHVlID0gYXJncy5zaGlmdCgpO1xuICAgIH1cbiAgICBpZiAoYXJnID09ICdmbGFncycgJiYgdmFsdWUpIHtcbiAgICAgIGZsYWdzID0gdmFsdWU7XG4gICAgfSBlbHNlIGlmIChhcmcgPT0gJ3ByZXNldCcgJiYgdmFsdWUpIHtcbiAgICAgIGZsYWdzID0gJ0AnICsgdmFsdWUucmVwbGFjZSgvIC9nLCAnJyk7XG4gICAgfSBlbHNlIGlmIChhcmcgPT0gJ291dHB1dCcgJiYgdmFsdWUpIHtcbiAgICAgIG91dHB1dCA9IHZhbHVlO1xuICAgIH0gZWxzZSBpZiAoYXJnID09ICdzZWVkJyAmJiB2YWx1ZSkge1xuICAgICAgc2VlZCA9IHZhbHVlO1xuICAgIH0gZWxzZSBpZiAoYXJnID09ICdjb3VudCcgJiYgdmFsdWUpIHtcbiAgICAgIGNvdW50ID0gTnVtYmVyKHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PSAnZm9yY2UnKSB7XG4gICAgICBmb3JjZSA9IHRydWU7XG4gICAgICBkaXNhYmxlQXNzZXJ0cygpO1xuICAgICAgaWYgKHZhbHVlICE9IG51bGwpIGFyZ3MudW5zaGlmdCh2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChhcmcgPT0gJ2hlbHAnKSB7XG4gICAgICB1c2FnZSgwKTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PSAndmVyc2lvbicgfHwgYXJnID09ICctdicpIHtcbiAgICAgIGNvbnNvbGUubG9nKHZlcnNpb24uVkVSU0lPTik7XG4gICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgfSBlbHNlIGlmIChhcmcgPT0gJ2xpc3QtcHJlc2V0cycpIHtcbiAgICAgIC8vIHVuZG9jdW1lbnRlZCBmbGFnXG4gICAgICBmb3IgKGNvbnN0IHt0aXRsZX0gb2YgUFJFU0VUUykge1xuICAgICAgICBjb25zb2xlLmxvZyh0aXRsZS5yZXBsYWNlKC8gL2csICcnKSk7XG4gICAgICB9XG4gICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEJhZCBhcmd1bWVudDogJHthcmd9YCk7XG4gICAgICB1c2FnZSgxKTtcbiAgICB9XG4gIH1cblxuICBpZiAoYXJncy5sZW5ndGggIT0gMSkgdXNhZ2UoMSk7XG4gIGlmIChjb3VudCA+IDEpIHtcbiAgICBpZiAoc2VlZCkgZmFpbCgnQ2Fubm90IHNwZWNpZnkgYm90aCAtLWNvdW50IGFuZCAtLXNlZWQnKTtcbiAgICBpZiAoIS8lW3NjXS8udGVzdChvdXRwdXQpKSB7XG4gICAgICBmYWlsKCctLW91dHB1dCBtdXN0IGhhdmUgYSAlYyBvciAlcyBwbGFjZWhvbGRlciB3aGVuIC0tY291bnQgaXMgZ2l2ZW4nKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBmbGFnc2V0ID0gbmV3IEZsYWdTZXQoZmxhZ3MpO1xuICBjb25zdCByb20gPSBuZXcgVWludDhBcnJheShmcy5yZWFkRmlsZVN5bmMoYXJnc1swXSkuYnVmZmVyKTtcbiAgaWYgKGNyYzMyKHJvbSkgIT0gRVhQRUNURURfQ1JDMzIpIHtcbiAgICBjb25zb2xlLmVycm9yKGBXQVJOSU5HOiBCYWQgQ1JDIGZvciBpbnB1dCByb206ICR7Y3JjMzIocm9tKS50b1N0cmluZygxNil9YCk7XG4gICAgaWYgKCFmb3JjZSkgZmFpbCgnUnVuIHdpdGggLS1mb3JjZSB0byBwcm9jZWVkIGFueXdheScpO1xuICAgIGNvbnNvbGUuZXJyb3IoJ1Byb2NlZWRpbmcgYW55d2F5Jyk7XG4gIH1cblxuICByZXR1cm4gUHJvbWlzZS5hbGwobmV3IEFycmF5KGNvdW50KS5maWxsKDApLm1hcChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcyA9IHBhdGNoLnBhcnNlU2VlZChzZWVkKTtcbiAgICBjb25zb2xlLmxvZyhgU2VlZDogJHtzLnRvU3RyaW5nKDE2KX1gKTtcbiAgICBjb25zdCBzaHVmZmxlZCA9IHJvbS5zbGljZSgpO1xuICAgIGNvbnN0IGMgPSBhd2FpdCBwYXRjaC5zaHVmZmxlKHNodWZmbGVkLCBzLCBmbGFnc2V0LCBuZXcgTm9kZVJlYWRlcigpKTtcbiAgICBjb25zdCBuID0gYXJnc1swXS5yZXBsYWNlKCcubmVzJywgJycpO1xuICAgIGNvbnN0IGYgPSBTdHJpbmcoZmxhZ3NldCkucmVwbGFjZSgvIC9nLCAnJyk7XG4gICAgY29uc3QgdiA9IHZlcnNpb24uVkVSU0lPTjtcbiAgICBjb25zdCBmaWxlbmFtZSA9IGZpbGxUZW1wbGF0ZShvdXRwdXQsIHtjLCBuLCBzLCB2LCBmLCAnJSc6ICclJ30pICsgJy5uZXMnO1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKFxuICAgICAgICAocmVzb2x2ZSwgcmVqZWN0KSA9PiBmcy53cml0ZUZpbGUoXG4gICAgICAgICAgICBmaWxlbmFtZSwgc2h1ZmZsZWQsIChlcnIpID0+IGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZSgpKSk7XG4gICAgY29uc29sZS5sb2coYFdyb3RlICR7ZmlsZW5hbWV9YCk7XG4gIH0pKTtcbn07XG5cbmZ1bmN0aW9uIGZhaWwobWVzc2FnZTogc3RyaW5nKTogbmV2ZXIge1xuICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpO1xuICB0aHJvdyBwcm9jZXNzLmV4aXQoMik7XG59XG5cbmZ1bmN0aW9uIGZpbGxUZW1wbGF0ZShzdHI6IHN0cmluZywgYXJnOiB7W2tleTogc3RyaW5nXTogdW5rbm93bn0pOiBzdHJpbmcge1xuICBjb25zdCB0ZXJtcyA9IFtdO1xuICB3aGlsZSAoc3RyKSB7XG4gICAgY29uc3QgaW5kZXggPSBzdHIuaW5kZXhPZignJScpO1xuICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgIHRlcm1zLnB1c2goc3RyKTtcbiAgICAgIHN0ciA9ICcnO1xuICAgIH0gZWxzZSB7XG4gICAgICB0ZXJtcy5wdXNoKHN0ci5zdWJzdHJpbmcoMCwgaW5kZXgpKTtcbiAgICAgIGNvbnN0IGNoID0gc3RyW2luZGV4ICsgMV07XG4gICAgICBpZiAoIShjaCBpbiBhcmcpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBwbGFjZWhvbGRlcjogJSR7Y2h9YCk7XG4gICAgICB0ZXJtcy5wdXNoKGFyZ1tjaF0pO1xuICAgICAgc3RyID0gc3RyLnN1YnN0cmluZyhpbmRleCArIDIpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdGVybXMuam9pbignJyk7XG59XG5cbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChlcnJvcjogYW55KSA9PiB7XG4gIGNvbnNvbGUuZXJyb3IoXG4gICAgICB0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnID9cbiAgICAgICAgICBlcnJvciA6XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBVc2FnZUVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLnN0YWNrKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufSk7XG5cbmNvbnN0IGFzeW5jTWFpbiA9XG4gICAgYXN5bmMgKCkgPT4ge1xuICB0cnkge1xuICAgIGF3YWl0IG1haW4oLi4ucHJvY2Vzcy5hcmd2LnNsaWNlKDIpKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVc2FnZUVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgY29uc29sZS5lcnJvcihgVHJ5IHBhc3NpbmcgLS1oZWxwIGZvciBkb2N1bWVudGF0aW9uLmApO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG4gICAgICAgICAgICAgICAgYXN5bmNNYWluKClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gcHJvY2Vzcy5leGl0KDApKTtcbiJdfQ==