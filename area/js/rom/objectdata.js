import { Entity } from './entity.js';
import { readLittleEndian } from './util.js';
import { Constraint } from './constraint.js';
export class ObjectData extends Entity {
    constructor(parent, id) {
        super(parent.rom, id);
        this.constraint = Constraint.ALL;
        parent[id] = this;
        this.used = true;
        this.name = '';
        this.base = readLittleEndian(this.rom.prg, this.pointer) + 0x10000;
        this.sfx = this.rom.prg[this.base];
        this.data = [];
        let a = this.base + 1;
        let m = 0;
        for (let i = 0; i < 32; i++) {
            if (!(i & 7)) {
                m = this.rom.prg[a++];
            }
            this.data.push(m & 0x80 ? this.rom.prg[a++] : 0);
            m <<= 1;
        }
    }
    get pointer() {
        return 0x1ac00 + (this.id << 1);
    }
    serialize() {
        const out = [this.sfx];
        for (let i = 0; i < 4; i++) {
            const k = out.length;
            out.push(0);
            for (let j = 0; j < 8; j++) {
                if (this.data[8 * i + j]) {
                    out[k] |= (0x80 >>> j);
                    out.push(this.data[8 * i + j]);
                }
            }
        }
        return out;
    }
    write() {
        const name = `Object_${this.id.toString(16).padStart(2, '0')}`;
        const a = this.rom.assembler();
        a.segment('0d');
        a.reloc(name);
        const label = a.pc();
        a.byte(...this.serialize());
        a.org(0xac00 + (this.id << 1), `${name}_Ptr`);
        a.word(label);
        return [a.module()];
    }
    get(addr) {
        return this.data[(addr - 0x300) >>> 5];
    }
    parents() {
        return [];
    }
    spawnedChild() {
        var _a;
        const hasChild = (_a = this.rom.objectActions[this.action]) === null || _a === void 0 ? void 0 : _a.data.hasChild;
        if (!hasChild)
            return undefined;
        const spawn = this.rom.adHocSpawns[this.child];
        const spawnId = spawn && spawn.objectId;
        if (spawnId == null)
            return undefined;
        return this.rom.objects[spawnId];
    }
    spawnedReplacement() {
        if (!this.replacement)
            return undefined;
        return this.rom.objects[this.replacement];
    }
    locations() {
        return this.rom.locations.filter((l) => l.used && l.spawns.some(spawn => spawn.isMonster() && spawn.monsterId === this.id));
    }
    palettes(includeChildren = false) {
        var _a, _b;
        if (this.action === 0x22)
            return [3];
        let metaspriteId = this.data[0];
        if (this.action === 0x2a)
            metaspriteId = this.data[31] | 1;
        if (this.action === 0x29)
            metaspriteId = 0x6b;
        if (this.action === 0x26)
            metaspriteId = 0x9c;
        const ms = this.rom.metasprites[metaspriteId];
        const childMs = includeChildren && this.child ?
            this.rom.metasprites[this.rom.objects[this.rom.adHocSpawns[this.child].objectId].data[0]] :
            null;
        const s = new Set([...((_a = ms === null || ms === void 0 ? void 0 : ms.palettes()) !== null && _a !== void 0 ? _a : []),
            ...((_b = childMs === null || childMs === void 0 ? void 0 : childMs.palettes()) !== null && _b !== void 0 ? _b : [])]);
        return [...s];
    }
    isVulnerable(element) {
        return !(this.elements & (1 << element));
    }
    isShadow() {
        return this.id === 0x7b || this.id === 0x8c;
    }
    get metasprite() { return METASPRITE.get(this.data); }
    set metasprite(x) { METASPRITE.set(this.data, x); }
    get speed() { return SPEED.get(this.data); }
    set speed(x) { SPEED.set(this.data, x); }
    get collisionPlane() { return COLLISION_PLANE.get(this.data); }
    set collisionPlane(x) { COLLISION_PLANE.set(this.data, x); }
    get hitbox() { return HITBOX.get(this.data); }
    set hitbox(x) { HITBOX.set(this.data, x); }
    get hp() { return HP.get(this.data); }
    set hp(x) { HP.set(this.data, x); }
    get atk() { return ATK.get(this.data); }
    set atk(x) { ATK.set(this.data, x); }
    get def() { return DEF.get(this.data); }
    set def(x) { DEF.set(this.data, x); }
    get level() { return LEVEL.get(this.data); }
    set level(x) { LEVEL.set(this.data, x); }
    get poison() { return !!POISON.get(this.data); }
    set poison(x) { POISON.set(this.data, x ? 1 : 0); }
    get child() { return CHILD.get(this.data); }
    set child(x) { CHILD.set(this.data, x); }
    get terrainSusceptibility() { return TERRAIN_SUSCEPTIBILITY.get(this.data); }
    set terrainSusceptibility(x) { TERRAIN_SUSCEPTIBILITY.set(this.data, x); }
    get immobile() { return !!IMMOBILE.get(this.data); }
    set immobile(x) { IMMOBILE.set(this.data, x ? 1 : 0); }
    get action() { return ACTION.get(this.data); }
    set action(x) { ACTION.set(this.data, x); }
    get replacement() { return REPLACEMENT.get(this.data); }
    set replacement(x) { REPLACEMENT.set(this.data, x); }
    get goldDrop() { return GOLD_DROP.get(this.data); }
    set goldDrop(x) { GOLD_DROP.set(this.data, x); }
    get elements() { return ELEMENTS.get(this.data); }
    set elements(x) { ELEMENTS.set(this.data, x); }
    get expReward() { return EXP_REWARD.get(this.data); }
    set expReward(x) { EXP_REWARD.set(this.data, x); }
    get attackType() { return ATTACK_TYPE.get(this.data); }
    set attackType(x) { ATTACK_TYPE.set(this.data, x); }
    get statusEffect() { return STATUS_EFFECT.get(this.data); }
    set statusEffect(x) { STATUS_EFFECT.set(this.data, x); }
    toString() {
        return super.toString() + (this.name ? ' ' + this.name : '');
    }
}
function prop(...spec) {
    return new Stat(...spec);
}
class Stat {
    constructor(...spec) {
        this.spec = spec;
    }
    get(data) {
        let value = 0;
        for (const [addr, mask = 0xff, shift = 0] of this.spec) {
            const index = (addr - 0x300) >>> 5;
            const lsh = shift < 0 ? -shift : 0;
            const rsh = shift < 0 ? 0 : shift;
            value |= ((data[index] & mask) >>> rsh) << lsh;
        }
        return value;
    }
    set(data, value) {
        for (const [addr, mask = 0xff, shift = 0] of this.spec) {
            const index = (addr - 0x300) >>> 5;
            const lsh = shift < 0 ? -shift : 0;
            const rsh = shift < 0 ? 0 : shift;
            const v = (value >>> lsh) << rsh & mask;
            data[index] = data[index] & ~mask | v;
        }
    }
}
const METASPRITE = prop([0x300]);
const SPEED = prop([0x340, 0xf]);
const COLLISION_PLANE = prop([0x3a0, 0xf0, 4]);
const HITBOX = prop([0x420, 0x40, 2], [0x3a0, 0x0f]);
const HP = prop([0x3c0]);
const ATK = prop([0x3e0]);
const DEF = prop([0x400]);
const LEVEL = prop([0x420, 0x1f]);
const POISON = prop([0x420, 0x80, 7]);
const CHILD = prop([0x440]);
const TERRAIN_SUSCEPTIBILITY = prop([0x460]);
const IMMOBILE = prop([0x4a0, 0x80, 7]);
const ACTION = prop([0x4a0, 0x7f]);
const REPLACEMENT = prop([0x4c0]);
const GOLD_DROP = prop([0x500, 0xf0, 4]);
const ELEMENTS = prop([0x500, 0xf]);
const EXP_REWARD = prop([0x520]);
const ATTACK_TYPE = prop([0x540]);
const STATUS_EFFECT = prop([0x560, 0xf]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0ZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vb2JqZWN0ZGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXJDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFJN0MsTUFBTSxPQUFPLFVBQVcsU0FBUSxNQUFNO0lBWXBDLFlBQVksTUFBZSxFQUFFLEVBQVU7UUFDckMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFIeEIsZUFBVSxHQUFlLFVBQVUsQ0FBQyxHQUFHLENBQUM7UUFJdEMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUNuRSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNWLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDM0IsSUFBSSxDQUFDLENBQUMsQ0FB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QVMsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTNELElBQUksS0FBSyxLQUFhLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BELElBQUksS0FBSyxDQUFDLENBQVMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWpELElBQUksY0FBYyxLQUFhLE9BQU8sZUFBZSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZFLElBQUksY0FBYyxDQUFDLENBQVMsSUFBSSxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXBFLElBQUksTUFBTSxLQUFhLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RELElBQUksTUFBTSxDQUFDLENBQVMsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRW5ELElBQUksRUFBRSxLQUFhLE9BQU8sRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlDLElBQUksRUFBRSxDQUFDLENBQVMsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTNDLElBQUksR0FBRyxLQUFhLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hELElBQUksR0FBRyxDQUFDLENBQVMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTdDLElBQUksR0FBRyxLQUFhLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hELElBQUksR0FBRyxDQUFDLENBQVMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTdDLElBQUksS0FBSyxLQUFhLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BELElBQUksS0FBSyxDQUFDLENBQVMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWpELElBQUksTUFBTSxLQUFjLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6RCxJQUFJLE1BQU0sQ0FBQyxDQUFVLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFNUQsSUFBSSxLQUFLLEtBQWEsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsSUFBSSxLQUFLLENBQUMsQ0FBUyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFakQsSUFBSSxxQkFBcUIsS0FBYSxPQUFPLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JGLElBQUkscUJBQXFCLENBQUMsQ0FBUyxJQUFJLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVsRixJQUFJLFFBQVEsS0FBYyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0QsSUFBSSxRQUFRLENBQUMsQ0FBVSxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWhFLElBQUksTUFBTSxLQUFhLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RELElBQUksTUFBTSxDQUFDLENBQVMsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRW5ELElBQUksV0FBVyxLQUFhLE9BQU8sV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hFLElBQUksV0FBVyxDQUFDLENBQVMsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTdELElBQUksUUFBUSxLQUFhLE9BQU8sU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNELElBQUksUUFBUSxDQUFDLENBQVMsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXhELElBQUksUUFBUSxLQUFhLE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFELElBQUksUUFBUSxDQUFDLENBQVMsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBR3ZELElBQUksU0FBUyxLQUFhLE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdELElBQUksU0FBUyxDQUFDLENBQVMsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTFELElBQUksVUFBVSxLQUFhLE9BQU8sV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQy9ELElBQUksVUFBVSxDQUFDLENBQVMsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTVELElBQUksWUFBWSxLQUFhLE9BQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25FLElBQUksWUFBWSxDQUFDLENBQVMsSUFBSSxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWhFLFFBQVE7UUFDTixPQUFPLEtBQUssQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMvRCxDQUFDO0NBQ0Y7QUFFRCxTQUFTLElBQUksQ0FBQyxHQUFHLElBQWtDO0lBQ2pELE9BQU8sSUFBSSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztBQUMzQixDQUFDO0FBRUQsTUFBTSxJQUFJO0lBR1IsWUFBWSxHQUFHLElBQWtDO1FBQy9DLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFFRCxHQUFHLENBQUMsSUFBYztRQUNoQixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxHQUFHLElBQUksRUFBRSxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUN0RCxNQUFNLEtBQUssR0FBRyxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkMsTUFBTSxHQUFHLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLEdBQUcsR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUNsQyxLQUFLLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUM7U0FDaEQ7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxHQUFHLENBQUMsSUFBYyxFQUFFLEtBQWE7UUFDL0IsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksR0FBRyxJQUFJLEVBQUUsS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDdEQsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25DLE1BQU0sR0FBRyxHQUFHLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsTUFBTSxHQUFHLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDbEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEtBQUssR0FBRyxDQUFDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQztZQUN4QyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztTQUN2QztJQUNILENBQUM7Q0FDRjtBQUVELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDakMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDakMsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQy9DLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNyRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQ3pCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDMUIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUMxQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNsQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUM1QixNQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDN0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3hDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ25DLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDbEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3BDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDakMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUNsQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZHVsZSB9IGZyb20gJy4uL2FzbS9tb2R1bGUuanMnO1xuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi9lbnRpdHkuanMnO1xuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICcuL2xvY2F0aW9uLmpzJztcbmltcG9ydCB7IHJlYWRMaXR0bGVFbmRpYW4gfSBmcm9tICcuL3V0aWwuanMnO1xuaW1wb3J0IHsgQ29uc3RyYWludCB9IGZyb20gJy4vY29uc3RyYWludC5qcyc7XG5pbXBvcnQgdHlwZSB7IE9iamVjdHMgfSBmcm9tICcuL29iamVjdHMuanMnO1xuXG4vLyBOT1RFOiBXb3VsZCBiZSBuaWNlIHRvIGNhbGwgdGhpcyBPYmplY3QsIGJ1dCB0aGF0IHNlZW1zIGNvbmZ1c2luZy4uLlxuZXhwb3J0IGNsYXNzIE9iamVjdERhdGEgZXh0ZW5kcyBFbnRpdHkge1xuXG4gIHVzZWQ6IGJvb2xlYW47XG4gIG5hbWU6IHN0cmluZztcblxuICBiYXNlOiBudW1iZXI7XG5cbiAgc2Z4OiBudW1iZXI7XG4gIGRhdGE6IG51bWJlcltdO1xuXG4gIGNvbnN0cmFpbnQ6IENvbnN0cmFpbnQgPSBDb25zdHJhaW50LkFMTDtcblxuICBjb25zdHJ1Y3RvcihwYXJlbnQ6IE9iamVjdHMsIGlkOiBudW1iZXIpIHtcbiAgICBzdXBlcihwYXJlbnQucm9tLCBpZCk7XG4gICAgcGFyZW50W2lkXSA9IHRoaXM7XG4gICAgdGhpcy51c2VkID0gdHJ1ZTtcbiAgICB0aGlzLm5hbWUgPSAnJztcbiAgICB0aGlzLmJhc2UgPSByZWFkTGl0dGxlRW5kaWFuKHRoaXMucm9tLnByZywgdGhpcy5wb2ludGVyKSArIDB4MTAwMDA7XG4gICAgdGhpcy5zZnggPSB0aGlzLnJvbS5wcmdbdGhpcy5iYXNlXTtcbiAgICB0aGlzLmRhdGEgPSBbXTtcbiAgICBsZXQgYSA9IHRoaXMuYmFzZSArIDE7XG4gICAgbGV0IG0gPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzI7IGkrKykge1xuICAgICAgaWYgKCEoaSAmIDcpKSB7XG4gICAgICAgIG0gPSB0aGlzLnJvbS5wcmdbYSsrXTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZGF0YS5wdXNoKG0gJiAweDgwID8gdGhpcy5yb20ucHJnW2ErK10gOiAwKTtcbiAgICAgIG0gPDw9IDE7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHBvaW50ZXIoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gMHgxYWMwMCArICh0aGlzLmlkIDw8IDEpO1xuICB9XG5cbiAgLy8gUmV0dXJucyBhIGJ5dGUgYXJyYXkgZm9yIHRoaXMgZW50cnlcbiAgc2VyaWFsaXplKCk6IG51bWJlcltdIHtcbiAgICBjb25zdCBvdXQgPSBbdGhpcy5zZnhdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICBjb25zdCBrID0gb3V0Lmxlbmd0aDtcbiAgICAgIG91dC5wdXNoKDApO1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA4OyBqKyspIHtcbiAgICAgICAgaWYgKHRoaXMuZGF0YVs4ICogaSArIGpdKSB7XG4gICAgICAgICAgb3V0W2tdIHw9ICgweDgwID4+PiBqKTtcbiAgICAgICAgICBvdXQucHVzaCh0aGlzLmRhdGFbOCAqIGkgKyBqXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHdyaXRlKCk6IE1vZHVsZVtdIHtcbiAgICBjb25zdCBuYW1lID0gYE9iamVjdF8ke3RoaXMuaWQudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICcwJyl9YDtcbiAgICBjb25zdCBhID0gdGhpcy5yb20uYXNzZW1ibGVyKCk7XG4gICAgYS5zZWdtZW50KCcwZCcpO1xuICAgIGEucmVsb2MobmFtZSk7XG4gICAgY29uc3QgbGFiZWwgPSBhLnBjKCk7XG4gICAgYS5ieXRlKC4uLnRoaXMuc2VyaWFsaXplKCkpO1xuICAgIGEub3JnKDB4YWMwMCArICh0aGlzLmlkIDw8IDEpLCBgJHtuYW1lfV9QdHJgKTtcbiAgICBhLndvcmQobGFiZWwpO1xuICAgIHJldHVybiBbYS5tb2R1bGUoKV07XG4gIH1cblxuICBnZXQoYWRkcjogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhWyhhZGRyIC0gMHgzMDApID4+PiA1XTtcbiAgfVxuXG4gIHBhcmVudHMoKTogT2JqZWN0RGF0YVtdIHtcbiAgICAvLyBJZiB0aGlzIGlzIGEgcHJvamVjdGlsZSB0aGF0IGlzIHRoZSBwYXJlbnQgb2Ygc29tZSBtb25zdGVyLFxuICAgIC8vIHJldHVybiBhbiBhcnJheSBvZiBwYXJlbnRzIHRoYXQgc3Bhd25lZCBpdC5cbiAgICByZXR1cm4gW107XG4gICAgLy8gcmV0dXJuIHRoaXMucm9tLm1vbnN0ZXJzLmZpbHRlcihcbiAgICAvLyAgICAgKG06IE9iamVjdERhdGEpID0+IG0uY2hpbGQgJiZcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm9tLmFkSG9jU3Bhd25zW20uY2hpbGRdLm9iamVjdElkID09PSB0aGlzLmlkKTtcbiAgfVxuXG4gIHNwYXduZWRDaGlsZCgpOiBPYmplY3REYXRhfHVuZGVmaW5lZCB7XG4gICAgY29uc3QgaGFzQ2hpbGQgPSB0aGlzLnJvbS5vYmplY3RBY3Rpb25zW3RoaXMuYWN0aW9uXT8uZGF0YS5oYXNDaGlsZDtcbiAgICBpZiAoIWhhc0NoaWxkKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIGNvbnN0IHNwYXduID0gdGhpcy5yb20uYWRIb2NTcGF3bnNbdGhpcy5jaGlsZF07XG4gICAgY29uc3Qgc3Bhd25JZCA9IHNwYXduICYmIHNwYXduLm9iamVjdElkO1xuICAgIGlmIChzcGF3bklkID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgcmV0dXJuIHRoaXMucm9tLm9iamVjdHNbc3Bhd25JZF07XG4gIH1cblxuICBzcGF3bmVkUmVwbGFjZW1lbnQoKTogT2JqZWN0RGF0YXx1bmRlZmluZWQge1xuICAgIGlmICghdGhpcy5yZXBsYWNlbWVudCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICByZXR1cm4gdGhpcy5yb20ub2JqZWN0c1t0aGlzLnJlcGxhY2VtZW50XTtcbiAgfVxuXG4gIGxvY2F0aW9ucygpOiBMb2NhdGlvbltdIHtcbiAgICAvLyBUT0RPIC0gaGFuZGxlIG5vbi1tb25zdGVyIE5QQ3MuXG4gICAgcmV0dXJuIHRoaXMucm9tLmxvY2F0aW9ucy5maWx0ZXIoKGw6IExvY2F0aW9uKSA9PlxuICAgICAgICBsLnVzZWQgJiYgbC5zcGF3bnMuc29tZShzcGF3biA9PlxuICAgICAgICAgICAgc3Bhd24uaXNNb25zdGVyKCkgJiYgc3Bhd24ubW9uc3RlcklkID09PSB0aGlzLmlkKSk7XG4gIH1cblxuICBwYWxldHRlcyhpbmNsdWRlQ2hpbGRyZW4gPSBmYWxzZSk6IG51bWJlcltdIHtcbiAgICAvLyBOT1RFOiB0aGlzIGdldHMgdGhlIHdyb25nIHJlc3VsdCBmb3IgaWNlL3NhbmQgem9tYmllcyBhbmQgYmxvYnMuXG4gICAgLy8gIC0gbWF5IGp1c3QgbmVlZCB0byBndWVzcy9hc3N1bWUgYW5kIGV4cGVyaW1lbnQ/XG4gICAgLy8gIC0gem9tYmllcyAoYWN0aW9uIDB4MjIpIGxvb2sgbGlrZSBzaG91bGQganVzdCBiZSAzXG4gICAgLy8gIC0gbGF2YW1lbi9ibG9icyAoYWN0aW9uIDB4MjkpIGFyZSAyXG4gICAgLy8gIC0gd3JhaXRoIHNoYWRvd3MgKGFjdGlvbiAweDI2KSBhcmUgM1xuICAgIGlmICh0aGlzLmFjdGlvbiA9PT0gMHgyMikgcmV0dXJuIFszXTsgLy8gem9tYmllXG4gICAgbGV0IG1ldGFzcHJpdGVJZCA9IHRoaXMuZGF0YVswXTtcbiAgICBpZiAodGhpcy5hY3Rpb24gPT09IDB4MmEpIG1ldGFzcHJpdGVJZCA9IHRoaXMuZGF0YVszMV0gfCAxO1xuICAgIGlmICh0aGlzLmFjdGlvbiA9PT0gMHgyOSkgbWV0YXNwcml0ZUlkID0gMHg2YjsgLy8gYmxvYlxuICAgIGlmICh0aGlzLmFjdGlvbiA9PT0gMHgyNikgbWV0YXNwcml0ZUlkID0gMHg5YztcblxuICAgIGNvbnN0IG1zID0gdGhpcy5yb20ubWV0YXNwcml0ZXNbbWV0YXNwcml0ZUlkXTtcbiAgICBjb25zdCBjaGlsZE1zID1cbiAgICAgICAgaW5jbHVkZUNoaWxkcmVuICYmIHRoaXMuY2hpbGQgP1xuICAgICAgICAgICAgdGhpcy5yb20ubWV0YXNwcml0ZXNbXG4gICAgICAgICAgICAgICAgdGhpcy5yb20ub2JqZWN0c1tcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yb20uYWRIb2NTcGF3bnNbdGhpcy5jaGlsZF0ub2JqZWN0SWRdLmRhdGFbMF1dIDpcbiAgICAgICAgICAgIG51bGw7XG4gICAgY29uc3QgcyA9IG5ldyBTZXQoWy4uLihtcz8ucGFsZXR0ZXMoKSA/PyBbXSksXG4gICAgICAgICAgICAgICAgICAgICAgIC4uLihjaGlsZE1zPy5wYWxldHRlcygpID8/IFtdKV0pO1xuICAgIHJldHVybiBbLi4uc107XG4gIH1cblxuICAvLyAwIGZvciB3aW5kLCAxIGZvciBmaXJlLCAyIGZvciB3YXRlciwgMyBmb3IgdGh1bmRlclxuICBpc1Z1bG5lcmFibGUoZWxlbWVudDogbnVtYmVyKSB7XG4gICAgcmV0dXJuICEodGhpcy5lbGVtZW50cyAmICgxIDw8IGVsZW1lbnQpKTtcbiAgfVxuXG4gIGlzU2hhZG93KCkge1xuICAgIC8vIE5PVEU6IGludGVybmFsbHkgdGhlIGdhbWUgY2hlY2tzIHRoYXQgdGhlIG1ldGFzcHJpdGVcbiAgICAvLyBpcyAkYTcgKHNlZSAkMzUwZjMpLCBidXQgd2UnbGwganVzdCBoYXJkY29kZS5cbiAgICByZXR1cm4gdGhpcy5pZCA9PT0gMHg3YiB8fCB0aGlzLmlkID09PSAweDhjO1xuICB9XG5cbiAgZ2V0IG1ldGFzcHJpdGUoKTogbnVtYmVyIHsgcmV0dXJuIE1FVEFTUFJJVEUuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IG1ldGFzcHJpdGUoeDogbnVtYmVyKSB7IE1FVEFTUFJJVEUuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgc3BlZWQoKTogbnVtYmVyIHsgcmV0dXJuIFNQRUVELmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBzcGVlZCh4OiBudW1iZXIpIHsgU1BFRUQuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgY29sbGlzaW9uUGxhbmUoKTogbnVtYmVyIHsgcmV0dXJuIENPTExJU0lPTl9QTEFORS5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgY29sbGlzaW9uUGxhbmUoeDogbnVtYmVyKSB7IENPTExJU0lPTl9QTEFORS5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBoaXRib3goKTogbnVtYmVyIHsgcmV0dXJuIEhJVEJPWC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgaGl0Ym94KHg6IG51bWJlcikgeyBISVRCT1guc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgaHAoKTogbnVtYmVyIHsgcmV0dXJuIEhQLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBocCh4OiBudW1iZXIpIHsgSFAuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgYXRrKCk6IG51bWJlciB7IHJldHVybiBBVEsuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGF0ayh4OiBudW1iZXIpIHsgQVRLLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGRlZigpOiBudW1iZXIgeyByZXR1cm4gREVGLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBkZWYoeDogbnVtYmVyKSB7IERFRi5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBsZXZlbCgpOiBudW1iZXIgeyByZXR1cm4gTEVWRUwuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGxldmVsKHg6IG51bWJlcikgeyBMRVZFTC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBwb2lzb24oKTogYm9vbGVhbiB7IHJldHVybiAhIVBPSVNPTi5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgcG9pc29uKHg6IGJvb2xlYW4pIHsgUE9JU09OLnNldCh0aGlzLmRhdGEsIHggPyAxIDogMCk7IH1cblxuICBnZXQgY2hpbGQoKTogbnVtYmVyIHsgcmV0dXJuIENISUxELmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBjaGlsZCh4OiBudW1iZXIpIHsgQ0hJTEQuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgdGVycmFpblN1c2NlcHRpYmlsaXR5KCk6IG51bWJlciB7IHJldHVybiBURVJSQUlOX1NVU0NFUFRJQklMSVRZLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCB0ZXJyYWluU3VzY2VwdGliaWxpdHkoeDogbnVtYmVyKSB7IFRFUlJBSU5fU1VTQ0VQVElCSUxJVFkuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgaW1tb2JpbGUoKTogYm9vbGVhbiB7IHJldHVybiAhIUlNTU9CSUxFLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBpbW1vYmlsZSh4OiBib29sZWFuKSB7IElNTU9CSUxFLnNldCh0aGlzLmRhdGEsIHggPyAxIDogMCk7IH1cblxuICBnZXQgYWN0aW9uKCk6IG51bWJlciB7IHJldHVybiBBQ1RJT04uZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGFjdGlvbih4OiBudW1iZXIpIHsgQUNUSU9OLnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IHJlcGxhY2VtZW50KCk6IG51bWJlciB7IHJldHVybiBSRVBMQUNFTUVOVC5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgcmVwbGFjZW1lbnQoeDogbnVtYmVyKSB7IFJFUExBQ0VNRU5ULnNldCh0aGlzLmRhdGEsIHgpOyB9XG5cbiAgZ2V0IGdvbGREcm9wKCk6IG51bWJlciB7IHJldHVybiBHT0xEX0RST1AuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGdvbGREcm9wKHg6IG51bWJlcikgeyBHT0xEX0RST1Auc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgZWxlbWVudHMoKTogbnVtYmVyIHsgcmV0dXJuIEVMRU1FTlRTLmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBlbGVtZW50cyh4OiBudW1iZXIpIHsgRUxFTUVOVFMuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICAvKiogVW5wcm9jZXNzZWQgZXhwZXJpZW5jZSByZXdhcmQgKCQ1MjAseCkuICovXG4gIGdldCBleHBSZXdhcmQoKTogbnVtYmVyIHsgcmV0dXJuIEVYUF9SRVdBUkQuZ2V0KHRoaXMuZGF0YSk7IH1cbiAgc2V0IGV4cFJld2FyZCh4OiBudW1iZXIpIHsgRVhQX1JFV0FSRC5zZXQodGhpcy5kYXRhLCB4KTsgfVxuXG4gIGdldCBhdHRhY2tUeXBlKCk6IG51bWJlciB7IHJldHVybiBBVFRBQ0tfVFlQRS5nZXQodGhpcy5kYXRhKTsgfVxuICBzZXQgYXR0YWNrVHlwZSh4OiBudW1iZXIpIHsgQVRUQUNLX1RZUEUuc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICBnZXQgc3RhdHVzRWZmZWN0KCk6IG51bWJlciB7IHJldHVybiBTVEFUVVNfRUZGRUNULmdldCh0aGlzLmRhdGEpOyB9XG4gIHNldCBzdGF0dXNFZmZlY3QoeDogbnVtYmVyKSB7IFNUQVRVU19FRkZFQ1Quc2V0KHRoaXMuZGF0YSwgeCk7IH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gc3VwZXIudG9TdHJpbmcoKSArICh0aGlzLm5hbWUgPyAnICcgKyB0aGlzLm5hbWUgOiAnJyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJvcCguLi5zcGVjOiBbbnVtYmVyLCBudW1iZXI/LCBudW1iZXI/XVtdKSB7XG4gIHJldHVybiBuZXcgU3RhdCguLi5zcGVjKTtcbn1cblxuY2xhc3MgU3RhdCB7XG4gIHJlYWRvbmx5IHNwZWM6IFtudW1iZXIsIG51bWJlcj8sIG51bWJlcj9dW107XG5cbiAgY29uc3RydWN0b3IoLi4uc3BlYzogW251bWJlciwgbnVtYmVyPywgbnVtYmVyP11bXSkge1xuICAgIHRoaXMuc3BlYyA9IHNwZWM7XG4gIH1cblxuICBnZXQoZGF0YTogbnVtYmVyW10pIHtcbiAgICBsZXQgdmFsdWUgPSAwO1xuICAgIGZvciAoY29uc3QgW2FkZHIsIG1hc2sgPSAweGZmLCBzaGlmdCA9IDBdIG9mIHRoaXMuc3BlYykge1xuICAgICAgY29uc3QgaW5kZXggPSAoYWRkciAtIDB4MzAwKSA+Pj4gNTtcbiAgICAgIGNvbnN0IGxzaCA9IHNoaWZ0IDwgMCA/IC1zaGlmdCA6IDA7XG4gICAgICBjb25zdCByc2ggPSBzaGlmdCA8IDAgPyAwIDogc2hpZnQ7XG4gICAgICB2YWx1ZSB8PSAoKGRhdGFbaW5kZXhdICYgbWFzaykgPj4+IHJzaCkgPDwgbHNoO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBzZXQoZGF0YTogbnVtYmVyW10sIHZhbHVlOiBudW1iZXIpIHtcbiAgICBmb3IgKGNvbnN0IFthZGRyLCBtYXNrID0gMHhmZiwgc2hpZnQgPSAwXSBvZiB0aGlzLnNwZWMpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gKGFkZHIgLSAweDMwMCkgPj4+IDU7XG4gICAgICBjb25zdCBsc2ggPSBzaGlmdCA8IDAgPyAtc2hpZnQgOiAwO1xuICAgICAgY29uc3QgcnNoID0gc2hpZnQgPCAwID8gMCA6IHNoaWZ0O1xuICAgICAgY29uc3QgdiA9ICh2YWx1ZSA+Pj4gbHNoKSA8PCByc2ggJiBtYXNrO1xuICAgICAgZGF0YVtpbmRleF0gPSBkYXRhW2luZGV4XSAmIH5tYXNrIHwgdjtcbiAgICB9XG4gIH1cbn1cblxuY29uc3QgTUVUQVNQUklURSA9IHByb3AoWzB4MzAwXSk7XG5jb25zdCBTUEVFRCA9IHByb3AoWzB4MzQwLCAweGZdKTtcbmNvbnN0IENPTExJU0lPTl9QTEFORSA9IHByb3AoWzB4M2EwLCAweGYwLCA0XSk7XG5jb25zdCBISVRCT1ggPSBwcm9wKFsweDQyMCwgMHg0MCwgMl0sIFsweDNhMCwgMHgwZl0pO1xuY29uc3QgSFAgPSBwcm9wKFsweDNjMF0pO1xuY29uc3QgQVRLID0gcHJvcChbMHgzZTBdKTtcbmNvbnN0IERFRiA9IHByb3AoWzB4NDAwXSk7XG5jb25zdCBMRVZFTCA9IHByb3AoWzB4NDIwLCAweDFmXSk7XG5jb25zdCBQT0lTT04gPSBwcm9wKFsweDQyMCwgMHg4MCwgN10pO1xuY29uc3QgQ0hJTEQgPSBwcm9wKFsweDQ0MF0pOyAvLyBhZC1ob2Mgc3Bhd24gaW5kZXhcbmNvbnN0IFRFUlJBSU5fU1VTQ0VQVElCSUxJVFkgPSBwcm9wKFsweDQ2MF0pO1xuY29uc3QgSU1NT0JJTEUgPSBwcm9wKFsweDRhMCwgMHg4MCwgN10pOyAvLyB3aWxsIG5vdCBiZSBrbm9ja2VkIGJhY2tcbmNvbnN0IEFDVElPTiA9IHByb3AoWzB4NGEwLCAweDdmXSk7XG5jb25zdCBSRVBMQUNFTUVOVCA9IHByb3AoWzB4NGMwXSk7XG5jb25zdCBHT0xEX0RST1AgPSBwcm9wKFsweDUwMCwgMHhmMCwgNF0pO1xuY29uc3QgRUxFTUVOVFMgPSBwcm9wKFsweDUwMCwgMHhmXSk7XG5jb25zdCBFWFBfUkVXQVJEID0gcHJvcChbMHg1MjBdKTtcbmNvbnN0IEFUVEFDS19UWVBFID0gcHJvcChbMHg1NDBdKTtcbmNvbnN0IFNUQVRVU19FRkZFQ1QgPSBwcm9wKFsweDU2MCwgMHhmXSk7XG4iXX0=