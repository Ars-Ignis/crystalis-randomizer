import { Metalocation } from '../rom/metalocation.js';
import { DefaultMap } from '../util.js';
const HOUSE_ICON = 0x06;
const TALL_HOUSE_ICON = 0x21;
const icons = new Map([
    ['pawn', 0x36],
    ['inn', 0x37],
    ['armor', 0x38],
    ['tool', 0x39],
    ['tavern', 0x3b],
]);
const shops = new Set(['inn', 'armor', 'tool', 'pawn']);
const compat = new Set([...shops, 'house', 'tavern']);
export function shuffleHouses(rom, flags, random) {
    var _a, _b, _c;
    const { locations: { Goa, GoaFortress_Exit, Shyron }, metascreens: { squareTownNE_house, fortressTownEntrance, mountainPathE_gate }, } = rom;
    const palaceTowns = new Set([Goa.id, Shyron.id]);
    const firstPassOutsides = new Set([
        squareTownNE_house.data.id,
        fortressTownEntrance.data.id,
        mountainPathE_gate.data.id,
    ]);
    if (flags.shuffleAreas()) {
        for (const loc of [Goa, GoaFortress_Exit, Shyron]) {
            loc.data.houseType = 'palace';
        }
    }
    const byType = new DefaultMap(() => []);
    const byLocPos = new DefaultMap(() => []);
    const screens = new DefaultMap(() => new Set());
    for (const location of rom.locations) {
        if (!location.used)
            continue;
        if (location.data.houseType == null)
            continue;
        let bottomExit;
        for (const [pos, type, spec] of location.meta.exits()) {
            const coord = (pos & 0xf0) << 4 |
                (location.meta.get(pos).findExitByType(type).entrance >>> 8);
            if (!bottomExit || coord > bottomExit[3]) {
                bottomExit = [pos, type, spec, coord];
            }
        }
        for (const [pos, type, spec] of [bottomExit]) {
            const house = {
                type: location.data.houseType,
                inside: [location.id << 8 | pos, type],
                outside: spec,
            };
            let locpos = spec[0];
            byLocPos.get(locpos).push(house);
            byType.get(location.data.houseType).push(house);
            const screen = rom.locations[locpos >>> 8]
                .screens[(locpos >>> 4) & 0xf][locpos & 0xf];
            screens.get(screen).add(locpos);
        }
    }
    const secondPass = new Map();
    const firstPass = new Map();
    for (const [scr, locposs] of random.ishuffle(screens)) {
        if (locposs.size >= 2 || firstPassOutsides.has(scr)) {
            firstPass.set(scr, locposs);
        }
        else {
            secondPass.set(scr, locposs);
        }
    }
    const hasInn = new Set();
    const inns = byType.get('inn');
    for (const [, locposs] of [...firstPass, ...secondPass]) {
        const map = new Map();
        let first = true;
        for (const locpos of locposs) {
            for (const house of byLocPos.get(locpos)) {
                let eligible = first && compat.has(house.type) ?
                    [...compat].map(t => byType.get(t)) :
                    [byType.get((_a = map.get(house.outside[1])) !== null && _a !== void 0 ? _a : house.type)];
                eligible = eligible.filter(x => x.length);
                if (house.type === 'palace' && palaceTowns.has(house.outside[0] >>> 8)) {
                    eligible = eligible.map(x => x.filter(h => !palaceTowns.has(h.inside[0] >>> 8)));
                }
                const allowInn = [...locposs].every(lp => !hasInn.has(lp >>> 8));
                if (!allowInn && eligible.length > 1) {
                    eligible = eligible.filter(x => x !== inns);
                }
                else if (allowInn && eligible.some(x => x === inns)) {
                    eligible = [inns];
                }
                const replacement = random.pickAndRemove(...eligible);
                if (replacement.type === 'inn') {
                    for (const lp of locposs) {
                        hasInn.add(lp >>> 8);
                    }
                }
                map.set(house.outside[1], replacement.type);
                if (rom.spoiler) {
                    rom.spoiler.addHouse(replacement.inside[0] >>> 8, house.outside[0] >>> 8);
                }
                Metalocation.connect(rom, house.outside, replacement.inside);
                if (!first)
                    continue;
                if (icons.get(house.type) === icons.get(replacement.type))
                    continue;
                const outside = rom.locations[house.outside[0] >>> 8];
                if (outside.meta.tileset !== rom.metatilesets.town)
                    continue;
                const exits = Metalocation.findExitTiles(rom, house.outside);
                if (exits.length > 1)
                    continue;
                let coord = exits[0] - 0x20;
                if ((exits[0] & 0xf0) < 0x20)
                    coord -= 0x0f10;
                const pos = coord >> 8;
                const tile = coord & 0xff;
                const icon = (_b = icons.get(replacement.type)) !== null && _b !== void 0 ? _b : (((_c = outside.meta.get(pos).data.tallHouses) === null || _c === void 0 ? void 0 : _c.includes(tile)) ?
                    TALL_HOUSE_ICON : HOUSE_ICON);
                rom.screens[outside.screens[pos >> 4][pos & 0xf]].tiles[tile] = icon;
            }
            first = false;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZWhvdXNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9wYXNzL3NodWZmbGVob3VzZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBOEJBLE9BQU8sRUFBWSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUloRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBUXhDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQztBQUN4QixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUM7QUFDN0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQW9CO0lBQ3ZDLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztJQUNkLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQztJQUNiLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQztJQUNmLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztJQUNkLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQztDQUNqQixDQUFDLENBQUM7QUFFSCxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBWSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDbkUsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQVksQ0FBQyxHQUFHLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUVqRSxNQUFNLFVBQVUsYUFBYSxDQUFDLEdBQVEsRUFBRSxLQUFjLEVBQUUsTUFBYzs7SUFDcEUsTUFBTSxFQUNKLFNBQVMsRUFBRSxFQUFDLEdBQUcsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUMsRUFDMUMsV0FBVyxFQUFFLEVBQUMsa0JBQWtCLEVBQ2xCLG9CQUFvQixFQUNwQixrQkFBa0IsRUFBQyxHQUNsQyxHQUFHLEdBQUcsQ0FBQztJQUNSLE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFD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LEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUM3RCxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQztvQkFBRSxTQUFTO2dCQUMvQixJQUFJLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO2dCQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUk7b0JBQUUsS0FBSyxJQUFJLE1BQU0sQ0FBQztnQkFDOUMsTUFBTSxHQUFHLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQztnQkFDdkIsTUFBTSxJQUFJLEdBQUcsS0FBSyxHQUFHLElBQUksQ0FBQztnQkFDMUIsTUFBTSxJQUFJLFNBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLG1DQUN0QyxDQUFDLE9BQUEsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsMENBQUUsUUFBUSxDQUFDLElBQUksR0FBRSxDQUFDO29CQUN2RCxlQUFlLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUNqQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDdEU7WUFDRCxLQUFLLEdBQUcsS0FBSyxDQUFDO1NBQ2Y7S0FDRjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTaHVmZmxlIGhvdXNlL3Nob3Avc2hlZC9wYWxhY2UgZW50cmFuY2VzLlxuLy8gVGhpcyBpcyB0cmlja3kgZm9yIGEgbnVtYmVyIG9mIHJlYXNvbnMuICBXZSBuZWVkIHRvIHBheSBhdHRlbnRpb24gdG9cbi8vIGtlZXAgdGhlIHJpZ2h0IGljb24gYWJvdmUgZWFjaCBkb29yLCB3aGljaCBpcyBleHRyYSB0cmlja3kgZm9yIHRoZVxuLy8gKHZhbmlsbGEpIDUgc2NyZWVucyB0aGF0IHNoYXJlIHR3byB0b3ducy4gIFRoaXMgY2FuIGJlIG1pdGlnYXRlZCBieVxuLy8gZXhwYW5kaW5nIHRoZSBzY3JlZW4gc3BhY2UgaW50byB0aGUgZXh0cmEgUk9NIGFyZWEsIGJ1dCBpdCdzIG5pY2UgdG9cbi8vIHN0aWxsIHdvcmsgd2l0aG91dCB0aGF0LlxuXG4vLyBOT1RFOiBJdCdzIHBvc3NpYmxlIHRoYXQgd2Ugc2h1ZmZsZSBhbGwgdGhlIHNwaGVyZS0wIGNoZWNrcyBhd2F5IGZyb21cbi8vIExlYWYuICBJZiB0aGVyZSdzIG5vIGV4dHJhIHBhc3NhZ2UgdGhlbiB3ZSBtYXkgZW5kIHVwIHdpdGggYW4gaW1wb3NzaWJsZVxuLy8gc2h1ZmZsZS4gIEluIHRoYXQgY2FzZSwgd2UgbmVlZCB0byBmaW5kIGEgd2F5IHRvIHJlZ3JvdXAuICBGb3Igbm93LCB0aGVcbi8vIGVhc2llc3Qgb3B0aW9uIG1heSBiZSB0byBsZWF2ZSB0aG9zZSB0d28gaG91c2VzIG91dCBvZiB0aGUgc2h1ZmZsZS4uLlxuXG5cbi8vIE5PVEU6IHRoZXJlJ3MgYSBidWcgd2hlbiBlbnRyYW5jZXMgYXJlIG91dCBvZiBvcmRlclxuLy8gICAtIHdhcnAgdG8gdG93bnMgY29tZXMgb3V0IG9mIGRvb3Jcbi8vICAgLSBib2F0IGJyb2tlbiBpZiBub3QgZW50cmFuY2UgMCAoZS5nLiBsaWdodGhvdXNlIG9yIGJvYXQgaG91c2UpXG4vLyAtPiBtaWdodCBiZSBuaWNlIHRvIGZpeCBib2F0LCBidXQgZ2VuZXJhbGx5IHdlJ3ZlIGhhZCBhbGwgc29ydHMgb2Zcbi8vICAgIGlzc3VlcyBmcm9tIGVudHJhbmNlIHJlb3JkZXJpbmcgLSB3ZSBzaG91bGQgdHJ5IHRvIGZpeCBpdCBzb1xuLy8gICAgdGhhdCB0aGUgZW50cmFuY2UgdHlwZXMgYXJlIHByZXNlcnZlZCBhcyBtdWNoIGFzIHBvc3NpYmxlXG4vLyAgICAoaS5lLiBlZGdlL2RpcmVjdGlvbiB2cyBkb29yLCBldGMpXG4vLyAgIC0gY2FuIHdlIGRlZmVyIHRoZSBkZWNpc2lvbiBvZiB3aGljaCBlbnRyYW5jZSBudW1iZXIgdG8gdXNlXG4vLyAgICAgdW50aWwgYSBsaXR0bGUgbGF0ZXIsIGFuZCBqdXN0IGluZGlyZWN0IGl0IGZvciBhIHdoaWxlP1xuLy8gICAtIGlmIG1hemUgc2h1ZmZsZSBpcyBvbiwgaXQgY291bGQgYmUgaGFyZCB0byBmaWd1cmUgb3V0IHdoaWNoXG4vLyAgICAgaXMgd2hpY2g/IGV4Y2VwdCB3ZSBkbyBrbm93IHRoZSBleGl0IHR5cGVzIGFuZCB0aGUgbnVtYmVyXG4vLyAgICAgYmVmb3JlIHdlIGFzc2lnbiBhbnl0aGluZy4uLiBzbyBtYWtlIGEgbWFwcGluZyBhbmQgdGhlbiBmaWxsXG4vLyAgICAgaW4gYW55IGdhcHMuXG5cblxuaW1wb3J0IHsgUmFuZG9tIH0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7IFJvbSB9IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQgeyBFeGl0U3BlYywgTWV0YWxvY2F0aW9uIH0gZnJvbSAnLi4vcm9tL21ldGFsb2NhdGlvbi5qcyc7XG5pbXBvcnQgeyBIb3VzZVR5cGUgfSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgQ29ubmVjdGlvblR5cGUgfSBmcm9tICcuLi9yb20vbWV0YXNjcmVlbmRhdGEuanMnO1xuaW1wb3J0IHsgRmxhZ1NldCB9IGZyb20gJy4uL2ZsYWdzZXQuanMnO1xuaW1wb3J0IHsgRGVmYXVsdE1hcCB9IGZyb20gJy4uL3V0aWwuanMnO1xuXG5pbnRlcmZhY2UgSG91c2Uge1xuICB0eXBlOiBIb3VzZVR5cGU7XG4gIGluc2lkZTogRXhpdFNwZWM7XG4gIG91dHNpZGU6IEV4aXRTcGVjO1xufVxuXG5jb25zdCBIT1VTRV9JQ09OID0gMHgwNjtcbmNvbnN0IFRBTExfSE9VU0VfSUNPTiA9IDB4MjE7XG5jb25zdCBpY29ucyA9IG5ldyBNYXA8SG91c2VUeXBlLCBudW1iZXI+KFtcbiAgWydwYXduJywgMHgzNl0sXG4gIFsnaW5uJywgMHgzN10sXG4gIFsnYXJtb3InLCAweDM4XSxcbiAgWyd0b29sJywgMHgzOV0sXG4gIFsndGF2ZXJuJywgMHgzYl0sXG5dKTtcblxuY29uc3Qgc2hvcHMgPSBuZXcgU2V0PEhvdXNlVHlwZT4oWydpbm4nLCAnYXJtb3InLCAndG9vbCcsICdwYXduJ10pO1xuY29uc3QgY29tcGF0ID0gbmV3IFNldDxIb3VzZVR5cGU+KFsuLi5zaG9wcywgJ2hvdXNlJywgJ3RhdmVybiddKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHNodWZmbGVIb3VzZXMocm9tOiBSb20sIGZsYWdzOiBGbGFnU2V0LCByYW5kb206IFJhbmRvbSkge1xuICBjb25zdCB7XG4gICAgbG9jYXRpb25zOiB7R29hLCBHb2FGb3J0cmVzc19FeGl0LCBTaHlyb259LFxuICAgIG1ldGFzY3JlZW5zOiB7c3F1YXJlVG93bk5FX2hvdXNlLFxuICAgICAgICAgICAgICAgICAgZm9ydHJlc3NUb3duRW50cmFuY2UsXG4gICAgICAgICAgICAgICAgICBtb3VudGFpblBhdGhFX2dhdGV9LFxuICB9ID0gcm9tO1xuICBjb25zdCBwYWxhY2VUb3ducyA9IG5ldyBTZXQoW0dvYS5pZCwgU2h5cm9uLmlkXSk7XG4gIGNvbnN0IGZpcnN0UGFzc091dHNpZGVzID0gbmV3IFNldChbXG4gICAgLy8gTk9URTogc3R1ZGVudC9icm9rYWhhbmEgc2hvdWxkIGJlIGluIGZpcnN0IHBhc3MuXG4gICAgc3F1YXJlVG93bk5FX2hvdXNlLmRhdGEuaWQsXG4gICAgZm9ydHJlc3NUb3duRW50cmFuY2UuZGF0YS5pZCxcbiAgICBtb3VudGFpblBhdGhFX2dhdGUuZGF0YS5pZCxcbiAgXSk7XG5cbiAgaWYgKGZsYWdzLnNodWZmbGVBcmVhcygpKSB7XG4gICAgLy8gU2V0IGEgZmV3IGFkZGl0aW9uYWwgbG9jYXRpb25zIGFzIHBhbGFjZXNcbiAgICBmb3IgKGNvbnN0IGxvYyBvZiBbR29hLCBHb2FGb3J0cmVzc19FeGl0LCBTaHlyb25dKSB7XG4gICAgICBsb2MuZGF0YS5ob3VzZVR5cGUgPSAncGFsYWNlJztcbiAgICB9XG4gIH1cblxuICAvLyBGaXJzdCBvcmRlciBvZiBidXNpbmVzczogY29sbGVjdCBhbGwgdGhlIGNvbm5lY3Rpb25zLlxuICBjb25zdCBieVR5cGUgPSBuZXcgRGVmYXVsdE1hcDxIb3VzZVR5cGUsIEhvdXNlW10+KCgpID0+IFtdKTtcbiAgY29uc3QgYnlMb2NQb3MgPSBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIEhvdXNlW10+KCgpID0+IFtdKTsgLy8ga2V5OiBMb2NQb3NcbiAgY29uc3Qgc2NyZWVucyA9IG5ldyBEZWZhdWx0TWFwPG51bWJlciwgU2V0PG51bWJlcj4+KCgpID0+IG5ldyBTZXQoKSk7IC8vIFNjcklkIC0+IExvY1Bvc1xuICBmb3IgKGNvbnN0IGxvY2F0aW9uIG9mIHJvbS5sb2NhdGlvbnMpIHtcbiAgICBpZiAoIWxvY2F0aW9uLnVzZWQpIGNvbnRpbnVlO1xuICAgIGlmIChsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSA9PSBudWxsKSBjb250aW51ZTtcbiAgICAvLyBQcmV2ZW50IGltcG9zc2libGUgc2h1ZmZsZXMgYnkgZW5zdXJpbmcgaXRlbXMgaW4gc3BoZXJlLTBcbiAgICAvLyBOb3RlOiBpZiB3ZSBoYXZlIHRoZSBHQkMgY2F2ZSwgd2UgY291bGQgcG90ZW50aWFsbHkgbGV0IHRoZXNlXG4gICAgLy8gaG91c2VzIGZsb2F0LCBzaW5jZSB3ZSdyZSBndWFyYW50ZWVkIHR3byBleHRyYSBjaGVja3MgKHRob3VnaFxuICAgIC8vIG1pbWljcyBhcmUgc2h1ZmZsZWQgZWFybHkgbm93LCBzbyB0aGF0IGNvdWxkIHN0aWxsIGNhdXNlIGEgcHJvYmxlbSkuXG4gICAgLy9pZiAobG9jYXRpb24gPT09IExlYWZfRWxkZXJIb3VzZSB8fCBsb2NhdGlvbiA9PT0gTGVhZl9TdHVkZW50SG91c2UpIGNvbnRpbnVlO1xuICAgIC8vIFRoZXJlJ3Mgc29tZXRoaW5nIGdsaXRjaHkgYWJvdXQgdGhpcyBvbmUgLSB3aGVuIHdlIGVtZXJnZSxcbiAgICAvLyB0aGUgc2NyZWVuIHNjcm9sbHMgYW5kIGxvY2tzLlxuICAgIC8vaWYgKGxvY2F0aW9uID09PSBCb2F0SG91c2UpIGNvbnRpbnVlO1xuXG4gICAgLy8gRm9yIG5vbi1zaG9wcywgZmluZCB0aGUgYm90dG9tIGVkZ2VcbiAgICBsZXQgYm90dG9tRXhpdCE6IFtudW1iZXIsIENvbm5lY3Rpb25UeXBlLCBFeGl0U3BlYywgbnVtYmVyXTtcbiAgICBmb3IgKGNvbnN0IFtwb3MsIHR5cGUsIHNwZWNdIG9mIGxvY2F0aW9uLm1ldGEuZXhpdHMoKSkge1xuICAgICAgLy8gRmluZCBhYnNvbHV0ZSBZIGNvb3JkaW5hdGUgb2YgYWN0dWFsIGV4aXRcbiAgICAgIGNvbnN0IGNvb3JkID1cbiAgICAgICAgICAocG9zICYgMHhmMCkgPDwgNCB8XG4gICAgICAgICAgKGxvY2F0aW9uLm1ldGEuZ2V0KHBvcykuZmluZEV4aXRCeVR5cGUodHlwZSkuZW50cmFuY2UgPj4+IDgpO1xuICAgICAgaWYgKCFib3R0b21FeGl0IHx8IGNvb3JkID4gYm90dG9tRXhpdFszXSkge1xuICAgICAgICBib3R0b21FeGl0ID0gW3BvcywgdHlwZSwgc3BlYywgY29vcmRdO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtwb3MsIHR5cGUsIHNwZWNdIG9mIFtib3R0b21FeGl0XSkge1xuICAgICAgLy8gaWYgKHR5cGUgPT09ICdlZGdlOmJvdHRvbScgfHwgc2hvcHMuaGFzKGxvY2F0aW9uLmRhdGEuaG91c2VUeXBlKSB8fFxuICAgICAgLy8gICAgKGxvY2F0aW9uLm1ldGEudGlsZXNldCA9PT0gcm9tLm1ldGF0aWxlc2V0cy5mb3J0cmVzcyAmJlxuICAgICAgLy8gICAgIHR5cGUgPT09ICdzdGFpcjpkb3duJykgfHxcbiAgICAgIC8vICAgIChsb2NhdGlvbiA9PT0gR29hRm9ydHJlc3NfRXhpdCAmJlxuICAgICAgLy8gICAgIHR5cGUgPT09ICdzdGFpcjpkb3duJyAmJlxuICAgICAgLy8gICAgIHBvcyA9PT0gMHgzMSkpIHtcbiAgICAgICAgY29uc3QgaG91c2U6IEhvdXNlID0ge1xuICAgICAgICAgIHR5cGU6IGxvY2F0aW9uLmRhdGEuaG91c2VUeXBlLFxuICAgICAgICAgIGluc2lkZTogW2xvY2F0aW9uLmlkIDw8IDggfCBwb3MsIHR5cGVdLFxuICAgICAgICAgIG91dHNpZGU6IHNwZWMsXG4gICAgICAgIH07XG4gICAgICAgIGxldCBsb2Nwb3MgPSBzcGVjWzBdO1xuICAgICAgICAvLyBDaGVjayBvdXRzaWRlIHNwZWMgZm9yIHNoeXJvbi4uLlxuICAgICAgICAvLyBpZiAobG9jYXRpb24gPT09IFNoeXJvbiAmJlxuICAgICAgICAvLyAgICAgKGxvY2F0aW9uLmRhdGEuaG91c2VUeXBlID09PSAnYXJtb3InIHx8XG4gICAgICAgIC8vICAgICAgbG9jYXRpb24uZGF0YS5ob3VzZVR5cGUgPT09ICd0b29sJykpIHtcbiAgICAgICAgLy8gICBsb2Nwb3MgLT0gMHgxMDsgLy8gaWNvbiBpcyBhY3R1YWxseSBvbiBwcmV2aW91cyBzY3JlZW5cbiAgICAgICAgLy8gfVxuICAgICAgICBieUxvY1Bvcy5nZXQobG9jcG9zKS5wdXNoKGhvdXNlKTtcbiAgICAgICAgYnlUeXBlLmdldChsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSkucHVzaChob3VzZSk7XG4gICAgICAgIGNvbnN0IHNjcmVlbiA9XG4gICAgICAgICAgICByb20ubG9jYXRpb25zW2xvY3BvcyA+Pj4gOF1cbiAgICAgICAgICAgICAgICAuc2NyZWVuc1sobG9jcG9zID4+PiA0KSAmIDB4Zl1bbG9jcG9zICYgMHhmXTtcbiAgICAgICAgc2NyZWVucy5nZXQoc2NyZWVuKS5hZGQobG9jcG9zKTtcbiAgICAgIC8vIH1cbiAgICB9XG4gIH1cblxuICAvLyBUd28gcGFzc2VzOiAxLiBvbmx5IGhhbmRsZSBvdmVybG9hZGVkIHNjcmVlbnM7IDIuIGFsbCB0aGUgcmVzdC5cbiAgY29uc3Qgc2Vjb25kUGFzcyA9IG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKTtcbiAgY29uc3QgZmlyc3RQYXNzID0gbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpO1xuICBmb3IgKGNvbnN0IFtzY3IsIGxvY3Bvc3NdIG9mIHJhbmRvbS5pc2h1ZmZsZShzY3JlZW5zKSkge1xuICAgIGlmIChsb2Nwb3NzLnNpemUgPj0gMiB8fCBmaXJzdFBhc3NPdXRzaWRlcy5oYXMoc2NyKSkge1xuICAgICAgZmlyc3RQYXNzLnNldChzY3IsIGxvY3Bvc3MpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZWNvbmRQYXNzLnNldChzY3IsIGxvY3Bvc3MpO1xuICAgIH1cbiAgfVxuICBjb25zdCBoYXNJbm4gPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgY29uc3QgaW5ucyA9IGJ5VHlwZS5nZXQoJ2lubicpO1xuICBmb3IgKGNvbnN0IFssIGxvY3Bvc3NdIG9mIFsuLi5maXJzdFBhc3MsIC4uLnNlY29uZFBhc3NdKSB7XG4gICAgLy9jb25zb2xlLmxvZyhgc2h1ZmZsaW5nIHNjcmVlbiAke3Njci50b1N0cmluZygxNil9OiAke1suLi5sb2Nwb3NzXS5tYXAobD0+bC50b1N0cmluZygxNikpLmpvaW4oJywnKX1gKTtcbiAgICBjb25zdCBtYXAgPSBuZXcgTWFwPENvbm5lY3Rpb25UeXBlLCBIb3VzZVR5cGU+KCk7XG4gICAgbGV0IGZpcnN0ID0gdHJ1ZTtcbiAgICBmb3IgKGNvbnN0IGxvY3BvcyBvZiBsb2Nwb3NzKSB7XG4gICAgICBmb3IgKGNvbnN0IGhvdXNlIG9mIGJ5TG9jUG9zLmdldChsb2Nwb3MpKSB7XG4gICAgICAgIGxldCBlbGlnaWJsZSA9IGZpcnN0ICYmIGNvbXBhdC5oYXMoaG91c2UudHlwZSkgP1xuICAgICAgICAgIFsuLi5jb21wYXRdLm1hcCh0ID0+IGJ5VHlwZS5nZXQodCkpIDpcbiAgICAgICAgICBbYnlUeXBlLmdldChtYXAuZ2V0KGhvdXNlLm91dHNpZGVbMV0pID8/IGhvdXNlLnR5cGUpXTtcbiAgICAgICAgZWxpZ2libGUgPSBlbGlnaWJsZS5maWx0ZXIoeCA9PiB4Lmxlbmd0aCk7XG4gICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBjb25uZWN0IHRoZSBcInBhbGFjZSB0b3duc1wiIChnb2EgYW5kIHNoeXJvbikgaW5cbiAgICAgICAgLy8gYSBjbG9zZWQgbG9vcCwgZWl0aGVyIHRvIGl0c2VsZiAoZ29hJ3MgZW50cmFuY2UgaXMgaW5zaWRlIGl0c2VsZilcbiAgICAgICAgLy8gb3IgaW4gYSBmaWd1cmUtZWl0aGVyIChnb2EgdG9wID0+IHNoeXJvbiwgYW5kIHNoeXJvbiB0ZW1wbGUgPT4gZ29hKS5cbiAgICAgICAgaWYgKGhvdXNlLnR5cGUgPT09ICdwYWxhY2UnICYmIHBhbGFjZVRvd25zLmhhcyhob3VzZS5vdXRzaWRlWzBdID4+PiA4KSkge1xuICAgICAgICAgIGVsaWdpYmxlID0gZWxpZ2libGUubWFwKHggPT4geC5maWx0ZXIoXG4gICAgICAgICAgICAgIGggPT4gIXBhbGFjZVRvd25zLmhhcyhoLmluc2lkZVswXSA+Pj4gOCkpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBBdm9pZCBtb3JlIHRoYW4gb25lIGlubiBwZXIgdG93biwgc2luY2UgdGhhdCdzIGxhbWUuXG4gICAgICAgIC8vIEFsc28sIHBsYWNlIGlubnMgZmlyc3Qgc28gYXMgdG8gbW9zdCBldmVubHkgZGlzdHJpYnV0ZSB0aGVtLlxuICAgICAgICBjb25zdCBhbGxvd0lubiA9IFsuLi5sb2Nwb3NzXS5ldmVyeShscCA9PiAhaGFzSW5uLmhhcyhscCA+Pj4gOCkpO1xuICAgICAgICBpZiAoIWFsbG93SW5uICYmIGVsaWdpYmxlLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICBlbGlnaWJsZSA9IGVsaWdpYmxlLmZpbHRlcih4ID0+IHggIT09IGlubnMpO1xuICAgICAgICB9IGVsc2UgaWYgKGFsbG93SW5uICYmIGVsaWdpYmxlLnNvbWUoeCA9PiB4ID09PSBpbm5zKSkge1xuICAgICAgICAgIGVsaWdpYmxlID0gW2lubnNdO1xuICAgICAgICB9XG4gICAgICAgIC8vIE5PVEU6IGlmIHN0dWRlbnQgaXMgc3RheWluZyBwdXQgdGhlbiBkb24ndCBzaHVmZmxlIGJyb2thaGFuYSB0byBhIG5vbi1ob3VzZVxuICAgICAgICAvLyBUT0RPIC0gYmV0dGVyIGNvbmRpdGlvbiwgcGFydGljdWxhcmx5IGlmIHdlIF9kb18gc2h1ZmZsZSBzdHVkZW50IG9yIGlmIHdlIHNwbGl0IHNjcmVlbnNcbiAgICAgICAgLy8gaWYgKChob3VzZS5vdXRzaWRlWzBdID4+PiA4KSA9PT0gR29hX0hvdXNlLmlkICYmIGJ5VHlwZS5nZXQoJ2hvdXNlJykubGVuZ3RoKSB7XG4gICAgICAgIC8vICAgZWxpZ2libGUgPSBbYnlUeXBlLmdldCgnaG91c2UnKV07XG4gICAgICAgIC8vIH1cbiAgICAgICAgLy8gQWxzbyBwcmV2ZW50IG11bHRpcGxlIGlubnMgaW4gdGhlIHNhbWUgdG93bj9cbiAgICAgICAgY29uc3QgcmVwbGFjZW1lbnQgPSByYW5kb20ucGlja0FuZFJlbW92ZSguLi5lbGlnaWJsZSk7XG4gICAgICAgIGlmIChyZXBsYWNlbWVudC50eXBlID09PSAnaW5uJykge1xuICAgICAgICAgIGZvciAoY29uc3QgbHAgb2YgbG9jcG9zcykge1xuICAgICAgICAgICAgaGFzSW5uLmFkZChscCA+Pj4gOCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG1hcC5zZXQoaG91c2Uub3V0c2lkZVsxXSwgcmVwbGFjZW1lbnQudHlwZSk7XG4gICAgICAgIGlmIChyb20uc3BvaWxlcikge1xuICAgICAgICAgIHJvbS5zcG9pbGVyLmFkZEhvdXNlKHJlcGxhY2VtZW50Lmluc2lkZVswXSA+Pj4gOCwgaG91c2Uub3V0c2lkZVswXSA+Pj4gOCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gTWFrZSB0aGUgY29ubmVjdGlvblxuICAgICAgICAvL2NvbnNvbGUubG9nKGBjb25uZWN0ICR7cm9tLmxvY2F0aW9uc1tob3VzZS5vdXRzaWRlWzBdPj4+OF0ubmFtZX0gJHtob3VzZS5vdXRzaWRlWzBdLnRvU3RyaW5nKDE2KX0gJHtob3VzZS5vdXRzaWRlWzFdfSAtLSAke3JvbS5sb2NhdGlvbnNbcmVwbGFjZW1lbnQuaW5zaWRlWzBdPj4+OF0ubmFtZX0gJHtyZXBsYWNlbWVudC5pbnNpZGVbMF0udG9TdHJpbmcoMTYpfSAke3JlcGxhY2VtZW50Lmluc2lkZVsxXX1gKTtcbiAgICAgICAgTWV0YWxvY2F0aW9uLmNvbm5lY3Qocm9tLCBob3VzZS5vdXRzaWRlLCByZXBsYWNlbWVudC5pbnNpZGUpO1xuICAgICAgICAvLyBSZXBsYWNlIHRoZSBpY29uIChpZiBhcHBsaWNhYmxlKVxuICAgICAgICBpZiAoIWZpcnN0KSBjb250aW51ZTtcbiAgICAgICAgaWYgKGljb25zLmdldChob3VzZS50eXBlKSA9PT0gaWNvbnMuZ2V0KHJlcGxhY2VtZW50LnR5cGUpKSBjb250aW51ZTtcbiAgICAgICAgY29uc3Qgb3V0c2lkZSA9IHJvbS5sb2NhdGlvbnNbaG91c2Uub3V0c2lkZVswXSA+Pj4gOF07XG4gICAgICAgIGlmIChvdXRzaWRlLm1ldGEudGlsZXNldCAhPT0gcm9tLm1ldGF0aWxlc2V0cy50b3duKSBjb250aW51ZTtcbiAgICAgICAgY29uc3QgZXhpdHMgPSBNZXRhbG9jYXRpb24uZmluZEV4aXRUaWxlcyhyb20sIGhvdXNlLm91dHNpZGUpO1xuICAgICAgICBpZiAoZXhpdHMubGVuZ3RoID4gMSkgY29udGludWU7XG4gICAgICAgIGxldCBjb29yZCA9IGV4aXRzWzBdIC0gMHgyMDtcbiAgICAgICAgaWYgKChleGl0c1swXSAmIDB4ZjApIDwgMHgyMCkgY29vcmQgLT0gMHgwZjEwOyAvLyBmdW5ueSB2ZXJ0aWNhbCBtYXRoXG4gICAgICAgIGNvbnN0IHBvcyA9IGNvb3JkID4+IDg7XG4gICAgICAgIGNvbnN0IHRpbGUgPSBjb29yZCAmIDB4ZmY7XG4gICAgICAgIGNvbnN0IGljb24gPSBpY29ucy5nZXQocmVwbGFjZW1lbnQudHlwZSkgPz9cbiAgICAgICAgICAob3V0c2lkZS5tZXRhLmdldChwb3MpLmRhdGEudGFsbEhvdXNlcz8uaW5jbHVkZXModGlsZSkgP1xuICAgICAgICAgICBUQUxMX0hPVVNFX0lDT04gOiBIT1VTRV9JQ09OKTtcbiAgICAgICAgcm9tLnNjcmVlbnNbb3V0c2lkZS5zY3JlZW5zW3BvcyA+PiA0XVtwb3MgJiAweGZdXS50aWxlc1t0aWxlXSA9IGljb247XG4gICAgICB9XG4gICAgICBmaXJzdCA9IGZhbHNlO1xuICAgIH1cbiAgfVxufVxuIl19