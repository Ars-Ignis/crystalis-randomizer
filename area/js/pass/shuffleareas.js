import { Location } from '../rom/location.js';
import { DefaultMap } from '../util.js';
import { UnionFind } from '../unionfind.js';
const connMap = new Map([
    ['stair:up', 'C'],
    ['edge:top', 'N'],
    ['edge:left', 'W'],
    ['edge:right', 'E'],
    ['cave', 'C'],
    ['door', 'C'],
    ['door2', 'C'],
    ['door3', 'C'],
    ['fortress', 'F'],
]);
const connInverse = new Map([
    ['N', 'S'],
    ['S', 'N'],
    ['E', 'W'],
    ['W', 'E'],
    ['C', 'X'],
    ['X', 'C'],
    ['F', 'O'],
    ['O', 'F'],
]);
function makeExit(loc, [pos, type, [revLocPos, revType]]) {
    let conn = connMap.get(type) || connInverse.get(connMap.get(revType));
    let shuffle = false;
    const area = loc.id.toString(16);
    const key = (loc.id << 8 | pos).toString(16) + ' ' + type;
    const revLoc = loc.rom.locations[revLocPos >>> 8];
    const revPos = revLocPos & 0xff;
    const revKey = revLocPos.toString(16) + ' ' + revType;
    const revArea = revLoc.id.toString(16);
    const reverse = {
        loc: revLoc, pos: revPos, type: revType,
        area: revArea, key: revKey, reverse: null, origRev: null,
        get conn() { return connInverse.get(conn); },
        set conn(c) { conn = connInverse.get(c); },
        get shuffle() { return shuffle; },
        set shuffle(s) {
            if (s && !conn)
                throw new Error(`shuffle without conn`);
            shuffle = s;
        },
    };
    const exit = {
        loc, pos, type, key, reverse, area, origRev: reverse,
        get conn() { return conn; },
        set conn(c) { conn = c; },
        get shuffle() { return shuffle; },
        set shuffle(s) {
            if (s && !conn)
                throw new Error(`shuffle without conn`);
            shuffle = s;
        },
    };
    reverse.reverse = reverse.origRev = exit;
    return exit;
}
function matchExit(exit, finder) {
    if (typeof finder === 'string')
        return exit.type === finder;
    if (typeof finder === 'number')
        return exit.pos === finder;
    if (finder instanceof Location)
        return exit.reverse.loc === finder;
    return finder.every(f => matchExit(exit, f));
}
export function shuffleAreas(rom, flags, random) {
    if (!flags.shuffleAreas())
        return;
    const { locations: loc } = rom;
    const exits = new Map();
    const exitsByLocation = new DefaultMap(() => []);
    for (const location of rom.locations) {
        for (const exitSpec of location.meta.exits()) {
            if (location === loc.CordelPlainEast && (exitSpec[0] & 0x0f) < 5)
                continue;
            if (location === loc.CordelPlainWest && (exitSpec[0] & 0x0f) > 4)
                continue;
            if (location.isTower())
                continue;
            const exit = makeExit(location, exitSpec);
            if (exit.loc === loc.Portoa_FortuneTeller)
                continue;
            if (exit.reverse.loc === loc.Portoa_FortuneTeller)
                continue;
            if (exits.has(exit.key))
                continue;
            if (exits.has(exit.reverse.key)) {
                throw new Error(`Inconsistent exits: ${exit.key} | ${exit.reverse.key}`);
            }
            exits.set(exit.key, exit);
            exits.set(exit.reverse.key, exit.reverse);
            exitsByLocation.get(exit.loc).push(exit);
            exitsByLocation.get(exit.reverse.loc).push(exit.reverse);
        }
    }
    function findExits(location, ...finders) {
        const out = [];
        for (const exit of exitsByLocation.get(location)) {
            for (const finder of finders) {
                if (matchExit(exit, finder)) {
                    out.push(exit);
                    break;
                }
            }
        }
        return out;
    }
    for (const exit of findExits(loc.ValleyOfWind, 'door', 'windmill')) {
        exit.area = 'windmill';
    }
    for (const exit of findExits(loc.AngrySea, 0x64)) {
        exit.area = 'lighthouse';
    }
    findExits(loc.Portoa_FishermanIsland, 'edge:right')[0].oneWay = true;
    function mark(loc, ...exits) {
        for (const exit of findExits(loc, ...exits)) {
            exit.shuffle = true;
        }
    }
    function markOutside(...locs) {
        const set = new Set(locs);
        for (const loc of locs) {
            for (const exit of exitsByLocation.get(loc)) {
                if (!set.has(exit.reverse.loc))
                    exit.shuffle = true;
            }
        }
    }
    markOutside(loc.Leaf_OutsideStart);
    mark(loc.ValleyOfWind, 'cave', 'door', 'edge:bottom', 'edge:top', 'edge:left', 'edge:right');
    markOutside(loc.WindmillCave);
    markOutside(loc.EastCave1, loc.EastCave2, loc.EastCave3);
    markOutside(loc.ZebuCave, loc.MtSabreWest_Cave1);
    markOutside(loc.CordelPlainWest, loc.CordelPlainEast);
    markOutside(loc.WaterfallValleyNorth, loc.WaterfallValleySouth);
    markOutside(loc.KirisaMeadow);
    markOutside(loc.LimeTreeLake);
    mark(loc.Portoa_FishermanIsland, 'edge:right');
    mark(loc.PortoaPalace_ThroneRoom, 'door');
    mark(loc.Joel, 'edge:bottom');
    markOutside(loc.JoelSecretPassage);
    mark(loc.EvilSpiritIsland1, 'stair:up');
    mark(loc.ZombieTown, 'cave');
    mark(loc.AngrySea, 'edge:top');
    markOutside(loc.SwanGate);
    mark(loc.GoaValley, 'edge:left');
    markOutside(loc.Desert1);
    markOutside(loc.GoaFortressBasement);
    markOutside(loc.DesertCave1);
    markOutside(loc.SaharaOutsideCave);
    markOutside(loc.DesertCave2);
    mark(loc.Desert2, 'stair:down');
    if (!flags.shuffleHouses()) {
        const palaces = [
            [loc.ZombieTown, 'fortress'],
            [loc.MtHydra, 'gate'],
            [loc.Desert2, 'fortress'],
            [loc.Goa, 'edge:top'],
            [loc.Portoa, 'fortress'],
            [loc.Shyron, 'fortress'],
            [loc.GoaValley, 'fortress'],
            [loc.OasisCave_Entrance, 'stair:up'],
            [loc.MtHydra_OutsideShyron, 'gate'],
            [loc.Crypt_Entrance, 'crypt'],
        ];
        for (const [outside, inside] of palaces) {
            const [exit] = findExits(outside, inside);
            exit.conn = 'F';
            exit.shuffle = true;
        }
    }
    const uf = new UnionFind();
    for (const exit of exits.values()) {
        if (exit.shuffle)
            continue;
        uf.union([exit.area, exit.reverse.area]);
    }
    const areaExits = new DefaultMap(() => []);
    for (const exit of exits.values()) {
        if (!exit.shuffle)
            continue;
        areaExits.get(exit.area = uf.find(exit.area)).push(exit);
    }
    const start = exitsByLocation.get(loc.MezameShrine)[0].area;
    function traverse() {
        const seen = new Set();
        const map = new Map();
        const partitions = [];
        for (const area of [start, ...areaExits.keys()]) {
            if (seen.has(area))
                continue;
            const queue = new Set([area]);
            const partition = [];
            for (const next of queue) {
                seen.add(next);
                for (const exit of areaExits.get(next)) {
                    map.set(exit, partitions.length);
                    partition.push(exit);
                    if (exit.oneWay || seen.has(exit.reverse.area))
                        continue;
                    queue.add(exit.reverse.area);
                }
            }
            partitions.push(partition);
        }
        let min = 0;
        for (let i = 1; i < partitions.length; i++) {
            if (partitions[i].length < partitions[min].length)
                min = i;
        }
        return [partitions.length, map, partitions[min]];
    }
    const exitsByConn = new DefaultMap(() => []);
    for (const exit of exits.values()) {
        if (!exit.shuffle || !exit.conn)
            continue;
        exitsByConn.get(exit.conn).push(exit);
    }
    for (const c of 'NWCF') {
        const original = exitsByConn.get(c);
        const shuffled = random.shuffle([...original]).map(e => e.reverse);
        for (let i = 0; i < shuffled.length; i++) {
            const exit1 = original[i];
            const exit2 = shuffled[i];
            [exit1.reverse, exit2.reverse] = [exit2, exit1];
        }
    }
    let iterations = 0;
    let [count, traversal, pool] = traverse();
    while (iterations-- > 0 || count > 1) {
        const exit1 = random.pick(pool);
        let eligible = exitsByConn.get(exit1.conn);
        if (count > 1) {
            const avoid = traversal.get(exit1);
            eligible = eligible.filter(e => traversal.get(e) !== avoid);
        }
        const exit2 = random.pick(eligible);
        const rev1 = exit1.reverse;
        const rev2 = exit2.reverse;
        exit1.reverse = rev2;
        rev2.reverse = exit1;
        exit2.reverse = rev1;
        rev1.reverse = exit2;
        [count, traversal, pool] = traverse();
        if (iterations < -10)
            debugger;
    }
    for (const exit of exits.values()) {
        if (exit.reverse !== exit.origRev) {
            function showExit(e) { return `${e.loc.name} ${e.type}(${e.pos.toString(16)})`; }
            console.log(`${showExit(exit)}  =>  ${showExit(exit.reverse)}  (was ${showExit(exit.origRev)})`);
        }
        exit.loc.meta.attach(exit.pos, exit.reverse.loc.meta, exit.reverse.pos, exit.type, exit.reverse.type);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZWFyZWFzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3Mvc2h1ZmZsZWFyZWFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVdBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUc5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQTRCNUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQWlDO0lBQ3RELENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQztJQUNqQixDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUM7SUFDakIsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDO0lBQ2xCLENBQUMsWUFBWSxFQUFFLEdBQUcsQ0FBQztJQUNuQixDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUM7SUFDYixDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUM7SUFDYixDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUM7SUFDZCxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUM7SUFDZCxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUM7Q0FDbEIsQ0FBQyxDQUFDO0FBTUgsTUFBTSxXQUFXLEdBQUcsSUFBSSxHQUFHLENBQWlDO0lBQzFELENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztDQUNYLENBQUMsQ0FBQztBQUVILFNBQVMsUUFBUSxDQUFDLEdBQWEs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QUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN2RixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDbEc7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQ2pELElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNwRDtBQUlILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTaHVmZmxlIGFyZWFzLlxuLy8gVGhpcyBpcyBkb25lIF9hZnRlcl8gc2h1ZmZsaW5nIGhvdXNlcy4gIFRoZXJlJ3MgYSBmZXcgcG9zc2libGVcbi8vIGFwcHJvYWNoZXMgdG8gdGhpcy4gIEhlcmUgd2Ugc2ltcGx5IGVudW1lcmF0ZSB0aGUgYXJlYXMgKG5vdFxuLy8gdXNpbmcgdGhlIGRhdGEgaW4gcm9tL2xvY2F0aW9uLCBzaW5jZSB3ZSBhY3R1YWxseSB3YW50IHRvIGJhc2Vcbi8vIHRoaW5ncyBvbiB0aGUgZXhpdHMgcmF0aGVyIHRoYW4gdGhlIGxvY2F0aW9ucykgYW5kIGRvIHN3YXBzIG9uXG4vLyBwYWlycyBvZiBleGl0cywgbWFpbnRhaW5pbmcgYSBncmFwaCBvZiBhcmVhcy4gIEJ5IGRlZmluaW5nIHRoZVxuLy8gYXJlYXMgY29hcnNlciBvciBmaW5lciwgd2UgY2FuIGNvbnRyb2wgdGhlIGNyYXppbmVzcy5cblxuaW1wb3J0IHsgUmFuZG9tIH0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7IFJvbSB9IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQgeyBFeGl0U3BlYywgUG9zIH0gZnJvbSAnLi4vcm9tL21ldGFsb2NhdGlvbi5qcyc7XG5pbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJy4uL3JvbS9sb2NhdGlvbi5qcyc7XG5pbXBvcnQgeyBDb25uZWN0aW9uVHlwZSB9IGZyb20gJy4uL3JvbS9tZXRhc2NyZWVuZGF0YS5qcyc7XG5pbXBvcnQgeyBGbGFnU2V0IH0gZnJvbSAnLi4vZmxhZ3NldC5qcyc7XG5pbXBvcnQgeyBEZWZhdWx0TWFwIH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5pbXBvcnQgeyBVbmlvbkZpbmQgfSBmcm9tICcuLi91bmlvbmZpbmQuanMnO1xuXG5pbnRlcmZhY2UgQXJlYSB7XG4gIG5hbWU6IHN0cmluZztcbiAgZXhpdHM6IE1hcDxzdHJpbmcsIEFyZWFFeGl0PjtcbiAgLy9leHBlY3RlZEV4aXRzOiBudW1iZXI7XG59XG5pbnRlcmZhY2UgQXJlYUV4aXQge1xuICBjb25uOiBBcmVhQ29ubmVjdGlvbjtcbiAgZGVzdDogQXJlYTtcbiAgZGVzdEtleTogc3RyaW5nO1xuICBsb2NQb3M6IG51bWJlcjtcbiAgZXhpdFR5cGU6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEV4aXQge1xuICByZWFkb25seSBsb2M6IExvY2F0aW9uO1xuICByZWFkb25seSBwb3M6IFBvcztcbiAgcmVhZG9ubHkgdHlwZTogQ29ubmVjdGlvblR5cGU7XG4gIHJlYWRvbmx5IGtleTogc3RyaW5nO1xuICBjb25uOiBBcmVhQ29ubmVjdGlvbnx1bmRlZmluZWQ7IC8vIGNhbm5vdCBzaHVmZmxlIHdpdGhvdXRcbiAgcmV2ZXJzZTogRXhpdDtcbiAgc2h1ZmZsZTogYm9vbGVhbjtcbiAgYXJlYTogc3RyaW5nO1xuICBvbmVXYXk/OiBib29sZWFuOyAvLyBjYW4ndCBnbyB0aGlzIHdheVxuICBvcmlnUmV2OiBFeGl0O1xufVxuXG5jb25zdCBjb25uTWFwID0gbmV3IE1hcDxDb25uZWN0aW9uVHlwZSwgQXJlYUNvbm5lY3Rpb24+KFtcbiAgWydzdGFpcjp1cCcsICdDJ10sXG4gIFsnZWRnZTp0b3AnLCAnTiddLFxuICBbJ2VkZ2U6bGVmdCcsICdXJ10sXG4gIFsnZWRnZTpyaWdodCcsICdFJ10sXG4gIFsnY2F2ZScsICdDJ10sXG4gIFsnZG9vcicsICdDJ10sXG4gIFsnZG9vcjInLCAnQyddLFxuICBbJ2Rvb3IzJywgJ0MnXSxcbiAgWydmb3J0cmVzcycsICdGJ10sXG5dKTtcblxudHlwZSBFeGl0RGVzY3JpcHRvciA9IHJlYWRvbmx5IFtQb3MsIENvbm5lY3Rpb25UeXBlLCBFeGl0U3BlY107XG50eXBlIEV4aXRGaW5kZXIgPSBQb3N8Q29ubmVjdGlvblR5cGV8cmVhZG9ubHkgRXhpdEZpbmRlcltdO1xudHlwZSBBcmVhQ29ubmVjdGlvbiA9ICdOJ3wnUyd8J1cnfCdFJ3wnQyd8J1gnfCdGJ3wnTyc7XG4vL3R5cGUgQXJlYUV4aXRTcGVjID0gcmVhZG9ubHkgW0FyZWFDb25uZWN0aW9uLCBFeGl0RmluZGVyLCBBcmVhLCBib29sZWFuP107XG5jb25zdCBjb25uSW52ZXJzZSA9IG5ldyBNYXA8QXJlYUNvbm5lY3Rpb24sIEFyZWFDb25uZWN0aW9uPihbXG4gIFsnTicsICdTJ10sXG4gIFsnUycsICdOJ10sXG4gIFsnRScsICdXJ10sXG4gIFsnVycsICdFJ10sXG4gIFsnQycsICdYJ10sXG4gIFsnWCcsICdDJ10sXG4gIFsnRicsICdPJ10sXG4gIFsnTycsICdGJ10sXG5dKTtcblxuZnVuY3Rpb24gbWFrZUV4aXQobG9jOiBMb2NhdGlvbiwgW3BvcywgdHlwZSwgW3JldkxvY1BvcywgcmV2VHlwZV1dOiBFeGl0RGVzY3JpcHRvcik6IEV4aXQge1xuICBsZXQgY29ubiA9IGNvbm5NYXAuZ2V0KHR5cGUpIHx8IGNvbm5JbnZlcnNlLmdldChjb25uTWFwLmdldChyZXZUeXBlKSEpO1xuICBsZXQgc2h1ZmZsZSA9IGZhbHNlO1xuICBjb25zdCBhcmVhID0gbG9jLmlkLnRvU3RyaW5nKDE2KTtcbiAgY29uc3Qga2V5ID0gKGxvYy5pZCA8PCA4IHwgcG9zKS50b1N0cmluZygxNikgKyAnICcgKyB0eXBlO1xuICBjb25zdCByZXZMb2MgPSBsb2Mucm9tLmxvY2F0aW9uc1tyZXZMb2NQb3MgPj4+IDhdO1xuICBjb25zdCByZXZQb3MgPSByZXZMb2NQb3MgJiAweGZmO1xuICBjb25zdCByZXZLZXkgPSByZXZMb2NQb3MudG9TdHJpbmcoMTYpICsgJyAnICsgcmV2VHlwZTtcbiAgY29uc3QgcmV2QXJlYSA9IHJldkxvYy5pZC50b1N0cmluZygxNik7XG4gIGNvbnN0IHJldmVyc2U6IEV4aXQgPSB7XG4gICAgbG9jOiByZXZMb2MsIHBvczogcmV2UG9zLCB0eXBlOiByZXZUeXBlLFxuICAgIGFyZWE6IHJldkFyZWEsIGtleTogcmV2S2V5LCByZXZlcnNlOiBudWxsISwgb3JpZ1JldjogbnVsbCEsXG4gICAgZ2V0IGNvbm4oKSB7IHJldHVybiBjb25uSW52ZXJzZS5nZXQoY29ubiEpOyB9LFxuICAgIHNldCBjb25uKGMpIHsgY29ubiA9IGNvbm5JbnZlcnNlLmdldChjISk7IH0sXG4gICAgZ2V0IHNodWZmbGUoKSB7IHJldHVybiBzaHVmZmxlOyB9LFxuICAgIHNldCBzaHVmZmxlKHMpIHtcbiAgICAgIGlmIChzICYmICFjb25uKSB0aHJvdyBuZXcgRXJyb3IoYHNodWZmbGUgd2l0aG91dCBjb25uYCk7XG4gICAgICBzaHVmZmxlID0gcztcbiAgICB9LFxuICB9O1xuICBjb25zdCBleGl0OiBFeGl0ID0ge1xuICAgIGxvYywgcG9zLCB0eXBlLCBrZXksIHJldmVyc2UsIGFyZWEsIG9yaWdSZXY6IHJldmVyc2UsXG4gICAgZ2V0IGNvbm4oKSB7IHJldHVybiBjb25uOyB9LFxuICAgIHNldCBjb25uKGMpIHsgY29ubiA9IGM7IH0sXG4gICAgZ2V0IHNodWZmbGUoKSB7IHJldHVybiBzaHVmZmxlOyB9LFxuICAgIHNldCBzaHVmZmxlKHMpIHtcbiAgICAgIGlmIChzICYmICFjb25uKSB0aHJvdyBuZXcgRXJyb3IoYHNodWZmbGUgd2l0aG91dCBjb25uYCk7XG4gICAgICBzaHVmZmxlID0gcztcbiAgICB9LFxuICB9O1xuICByZXZlcnNlLnJldmVyc2UgPSByZXZlcnNlLm9yaWdSZXYgPSBleGl0O1xuICByZXR1cm4gZXhpdDtcbn1cblxuZnVuY3Rpb24gbWF0Y2hFeGl0KGV4aXQ6IEV4aXQsIGZpbmRlcjogRXhpdEZpbmRlcik6IGJvb2xlYW4ge1xuICBpZiAodHlwZW9mIGZpbmRlciA9PT0gJ3N0cmluZycpIHJldHVybiBleGl0LnR5cGUgPT09IGZpbmRlcjtcbiAgaWYgKHR5cGVvZiBmaW5kZXIgPT09ICdudW1iZXInKSByZXR1cm4gZXhpdC5wb3MgPT09IGZpbmRlcjtcbiAgaWYgKGZpbmRlciBpbnN0YW5jZW9mIExvY2F0aW9uKSByZXR1cm4gZXhpdC5yZXZlcnNlLmxvYyA9PT0gZmluZGVyO1xuICByZXR1cm4gZmluZGVyLmV2ZXJ5KGYgPT4gbWF0Y2hFeGl0KGV4aXQsIGYpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNodWZmbGVBcmVhcyhyb206IFJvbSwgZmxhZ3M6IEZsYWdTZXQsIHJhbmRvbTogUmFuZG9tKSB7XG4gIGlmICghZmxhZ3Muc2h1ZmZsZUFyZWFzKCkpIHJldHVybjtcbiAgY29uc3Qge2xvY2F0aW9uczogbG9jfSA9IHJvbTtcblxuICAvLyBDYXRhbG9ndWUgYWxsIHRoZSBleGl0cyBpbiB0aGUgZ2FtZVxuICBjb25zdCBleGl0cyA9IG5ldyBNYXA8c3RyaW5nLCBFeGl0PigpO1xuICBjb25zdCBleGl0c0J5TG9jYXRpb24gPSBuZXcgRGVmYXVsdE1hcDxMb2NhdGlvbiwgRXhpdFtdPigoKSA9PiBbXSk7XG4gIGZvciAoY29uc3QgbG9jYXRpb24gb2Ygcm9tLmxvY2F0aW9ucykge1xuICAgIGZvciAoY29uc3QgZXhpdFNwZWMgb2YgbG9jYXRpb24ubWV0YS5leGl0cygpKSB7XG4gICAgICAvLyBOT1RFOiBDb3JkZWwgYW5kIFRvd2VyIGJvdGggYnJlYWsgdGhlIDE6MSBtYXBwaW5nIGJldHdlZW4gZXhpdHMuXG4gICAgICAvLyBGb3IgQ29yZGVsLCB1c2UgdGhlIFgtY29vcmRpbmF0ZSB0byBvbmx5IHBpY2sgdGhlIFwicmVhbFwiIGV4aXQuXG4gICAgICAvLyBTa2lwIFRvd2VyIGVudGlyZWx5LCBzaW5jZSB3ZSBkb24ndCBzaHVmZmxlIGl0LlxuICAgICAgaWYgKGxvY2F0aW9uID09PSBsb2MuQ29yZGVsUGxhaW5FYXN0ICYmIChleGl0U3BlY1swXSAmIDB4MGYpIDwgNSkgY29udGludWU7XG4gICAgICBpZiAobG9jYXRpb24gPT09IGxvYy5Db3JkZWxQbGFpbldlc3QgJiYgKGV4aXRTcGVjWzBdICYgMHgwZikgPiA0KSBjb250aW51ZTtcbiAgICAgIGlmIChsb2NhdGlvbi5pc1Rvd2VyKCkpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgZXhpdCA9IG1ha2VFeGl0KGxvY2F0aW9uLCBleGl0U3BlYyk7XG4gICAgICAvLyBTa2lwIHRoZSBGb3J0dW5lIFRlbGxlciBlbnRpcmVseSBzaW5jZSBpdCBjb25mdXNlcyB0aGUgbG9naWM6XG4gICAgICAvLyBzaGUgZG9lc24ndCBhY3R1YWxseSBjb25uZWN0IHRoZSB1bmRlcmdyb3VuZCBjYXZlIHRvIHBvcnRvYSxcbiAgICAgIC8vIGFuZCBpdCdzIGlycmVsZXZhbnQgYW55d2F5IHNpbmNlIGl0J3Mgbm90IHJlcXVpcmVkIHRvIGdvIHRoZXJlLlxuICAgICAgaWYgKGV4aXQubG9jID09PSBsb2MuUG9ydG9hX0ZvcnR1bmVUZWxsZXIpIGNvbnRpbnVlO1xuICAgICAgaWYgKGV4aXQucmV2ZXJzZS5sb2MgPT09IGxvYy5Qb3J0b2FfRm9ydHVuZVRlbGxlcikgY29udGludWU7XG4gICAgICBpZiAoZXhpdHMuaGFzKGV4aXQua2V5KSkgY29udGludWU7XG4gICAgICBpZiAoZXhpdHMuaGFzKGV4aXQucmV2ZXJzZS5rZXkpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW5jb25zaXN0ZW50IGV4aXRzOiAke2V4aXQua2V5fSB8ICR7ZXhpdC5yZXZlcnNlLmtleX1gKTtcbiAgICAgIH1cbiAgICAgIGV4aXRzLnNldChleGl0LmtleSwgZXhpdCk7XG4gICAgICBleGl0cy5zZXQoZXhpdC5yZXZlcnNlLmtleSwgZXhpdC5yZXZlcnNlKTtcbiAgICAgIGV4aXRzQnlMb2NhdGlvbi5nZXQoZXhpdC5sb2MpLnB1c2goZXhpdCk7XG4gICAgICBleGl0c0J5TG9jYXRpb24uZ2V0KGV4aXQucmV2ZXJzZS5sb2MpLnB1c2goZXhpdC5yZXZlcnNlKTtcbiAgICB9XG4gIH1cblxuICAvLyBNYWtlIHNlcGFyYXRlIGFyZWFzIGZvciB3aW5kbWlsbCBhbmQgbGlnaHRob3VzZVxuICBmdW5jdGlvbiBmaW5kRXhpdHMobG9jYXRpb246IExvY2F0aW9uLCAuLi5maW5kZXJzOiBFeGl0RmluZGVyW10pOiBFeGl0W10ge1xuICAgIGNvbnN0IG91dCA9IFtdO1xuICAgIGZvciAoY29uc3QgZXhpdCBvZiBleGl0c0J5TG9jYXRpb24uZ2V0KGxvY2F0aW9uKSkge1xuICAgICAgZm9yIChjb25zdCBmaW5kZXIgb2YgZmluZGVycykge1xuICAgICAgICBpZiAobWF0Y2hFeGl0KGV4aXQsIGZpbmRlcikpIHtcbiAgICAgICAgICBvdXQucHVzaChleGl0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9XG4gIGZvciAoY29uc3QgZXhpdCBvZiBmaW5kRXhpdHMobG9jLlZhbGxleU9mV2luZCwgJ2Rvb3InLCAnd2luZG1pbGwnKSkge1xuICAgIGV4aXQuYXJlYSA9ICd3aW5kbWlsbCc7XG4gIH1cbiAgZm9yIChjb25zdCBleGl0IG9mIGZpbmRFeGl0cyhsb2MuQW5ncnlTZWEsIDB4NjQpKSB7XG4gICAgZXhpdC5hcmVhID0gJ2xpZ2h0aG91c2UnO1xuICB9XG4gIGZpbmRFeGl0cyhsb2MuUG9ydG9hX0Zpc2hlcm1hbklzbGFuZCwgJ2VkZ2U6cmlnaHQnKVswXS5vbmVXYXkgPSB0cnVlO1xuICBcbiAgLy8gTWFyayB0aGUgZXhpdHMgdGhhdCBhcmUgZWxpZ2libGUgdG8gYmUgc2h1ZmZsZWQuXG4gIGZ1bmN0aW9uIG1hcmsobG9jOiBMb2NhdGlvbiwgLi4uZXhpdHM6IEV4aXRGaW5kZXJbXSk6IHZvaWQge1xuICAgIGZvciAoY29uc3QgZXhpdCBvZiBmaW5kRXhpdHMobG9jLCAuLi5leGl0cykpIHtcbiAgICAgIGV4aXQuc2h1ZmZsZSA9IHRydWU7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIG1hcmtPdXRzaWRlKC4uLmxvY3M6IExvY2F0aW9uW10pOiB2b2lkIHtcbiAgICBjb25zdCBzZXQgPSBuZXcgU2V0KGxvY3MpO1xuICAgIGZvciAoY29uc3QgbG9jIG9mIGxvY3MpIHtcbiAgICAgIGZvciAoY29uc3QgZXhpdCBvZiBleGl0c0J5TG9jYXRpb24uZ2V0KGxvYykpIHtcbiAgICAgICAgaWYgKCFzZXQuaGFzKGV4aXQucmV2ZXJzZS5sb2MpKSBleGl0LnNodWZmbGUgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG1hcmtPdXRzaWRlKGxvYy5MZWFmX091dHNpZGVTdGFydCk7XG4gIC8vbWFyayhsb2MuTGVhZiwgbG9jLkxlYWZfT3V0c2lkZVN0YXJ0KTtcbiAgbWFyayhsb2MuVmFsbGV5T2ZXaW5kLCAnY2F2ZScsICdkb29yJywgJ2VkZ2U6Ym90dG9tJywgJ2VkZ2U6dG9wJywgJ2VkZ2U6bGVmdCcsICdlZGdlOnJpZ2h0Jyk7XG4gIC8qaWYgKGZsYWdzLnNodWZmbGVIb3VzZXMoKSkqLyBtYXJrT3V0c2lkZShsb2MuV2luZG1pbGxDYXZlKTtcbiAgbWFya091dHNpZGUobG9jLkVhc3RDYXZlMSwgbG9jLkVhc3RDYXZlMiwgbG9jLkVhc3RDYXZlMyk7XG4gIG1hcmtPdXRzaWRlKGxvYy5aZWJ1Q2F2ZSwgbG9jLk10U2FicmVXZXN0X0NhdmUxKTtcbiAgbWFya091dHNpZGUobG9jLkNvcmRlbFBsYWluV2VzdCwgbG9jLkNvcmRlbFBsYWluRWFzdCk7XG4gIG1hcmtPdXRzaWRlKGxvYy5XYXRlcmZhbGxWYWxsZXlOb3J0aCwgbG9jLldhdGVyZmFsbFZhbGxleVNvdXRoKTtcbiAgbWFya091dHNpZGUobG9jLktpcmlzYU1lYWRvdyk7XG4gIG1hcmtPdXRzaWRlKGxvYy5MaW1lVHJlZUxha2UpO1xuICBtYXJrKGxvYy5Qb3J0b2FfRmlzaGVybWFuSXNsYW5kLCAnZWRnZTpyaWdodCcpOyAvLyAoUG9ydG9hKVxuICBtYXJrKGxvYy5Qb3J0b2FQYWxhY2VfVGhyb25lUm9vbSwgJ2Rvb3InKTsgLy8gKHVuZGVyZ3JvdW5kIGNoYW5uZWwpXG4gIG1hcmsobG9jLkpvZWwsICdlZGdlOmJvdHRvbScpOyAvLyAoYW5ncnkgc2VhKVxuICBtYXJrT3V0c2lkZShsb2MuSm9lbFNlY3JldFBhc3NhZ2UpOyAvLyBtYXliZSBub3Q/XG4gIC8vZmluZEV4aXRzKGxvYy5FdmlsU3Bpcml0SXNsYW5kMSwgbG9jLkV2aWxTcGlyaXRJc2xhbmQyKVswXS5jb25uID0gJ0MnO1xuICBtYXJrKGxvYy5FdmlsU3Bpcml0SXNsYW5kMSwgJ3N0YWlyOnVwJyk7IC8vIChFU0kgMilcbiAgbWFyayhsb2MuWm9tYmllVG93biwgJ2NhdmUnKTsgLy8gKEVTSSAzKVxuICBtYXJrKGxvYy5BbmdyeVNlYSwgJ2VkZ2U6dG9wJyk7XG4gIG1hcmtPdXRzaWRlKGxvYy5Td2FuR2F0ZSk7XG4gIG1hcmsobG9jLkdvYVZhbGxleSwgJ2VkZ2U6bGVmdCcpOyAvLyAoTXQgSHlkcmEpXG4gIG1hcmtPdXRzaWRlKGxvYy5EZXNlcnQxKTtcbiAgbWFya091dHNpZGUobG9jLkdvYUZvcnRyZXNzQmFzZW1lbnQpO1xuICBtYXJrT3V0c2lkZShsb2MuRGVzZXJ0Q2F2ZTEpO1xuICBtYXJrT3V0c2lkZShsb2MuU2FoYXJhT3V0c2lkZUNhdmUpO1xuICBtYXJrT3V0c2lkZShsb2MuRGVzZXJ0Q2F2ZTIpO1xuICBtYXJrKGxvYy5EZXNlcnQyLCAnc3RhaXI6ZG93bicpO1xuICBpZiAoIWZsYWdzLnNodWZmbGVIb3VzZXMoKSkge1xuICAgIC8vIEFsc28gbWFyayB0aGUgZm9ydHJlc3Nlcy9wYWxhY2VzXG4gICAgY29uc3QgcGFsYWNlczogW0xvY2F0aW9uLCBFeGl0RmluZGVyXVtdID0gW1xuICAgICAgLy8gTm9ybWFsIHBhbGFjZXNcbiAgICAgIFtsb2MuWm9tYmllVG93biwgJ2ZvcnRyZXNzJ10sIC8vIFNhYmVyYVxuICAgICAgW2xvYy5NdEh5ZHJhLCAnZ2F0ZSddLCAvLyBTdHl4XG4gICAgICBbbG9jLkRlc2VydDIsICdmb3J0cmVzcyddLCAvLyBQeXJhbWlkXG4gICAgICBbbG9jLkdvYSwgJ2VkZ2U6dG9wJ10sIC8vIEdvYSBGb3J0cmVzc1xuICAgICAgW2xvYy5Qb3J0b2EsICdmb3J0cmVzcyddLCAvLyBQYWxhY2VcbiAgICAgIFtsb2MuU2h5cm9uLCAnZm9ydHJlc3MnXSwgLy8gVGVtcGxlXG4gICAgICAvLyBbbG9jLlVuZGVyZ3JvdW5kQ2hhbm5lbCwgbG9jLlBvcnRvYV9Bc2luYVJvb21dLCA/P1xuICAgICAgLy8gRXh0cmFzXG4gICAgICBbbG9jLkdvYVZhbGxleSwgJ2ZvcnRyZXNzJ10sIC8vIEdvYSBUb3duXG4gICAgICBbbG9jLk9hc2lzQ2F2ZV9FbnRyYW5jZSwgJ3N0YWlyOnVwJ10sIC8vIEdvYSBGb3J0cmVzcyBiYWNrZG9vclxuICAgICAgW2xvYy5NdEh5ZHJhX091dHNpZGVTaHlyb24sICdnYXRlJ10sIC8vIFNoeXJvblxuICAgICAgW2xvYy5DcnlwdF9FbnRyYW5jZSwgJ2NyeXB0J10sXG4gICAgXTtcbiAgICBmb3IgKGNvbnN0IFtvdXRzaWRlLCBpbnNpZGVdIG9mIHBhbGFjZXMpIHtcbiAgICAgIGNvbnN0IFtleGl0XSA9IGZpbmRFeGl0cyhvdXRzaWRlLCBpbnNpZGUpO1xuICAgICAgZXhpdC5jb25uID0gJ0YnO1xuICAgICAgZXhpdC5zaHVmZmxlID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICAvLyBESUFHTk9TVElDOiBjaGVjayB0aGF0IGFsbCB0aGUgZXhpdHMgYXJlIGNvcnJlY3RcbiAgLy8gY29uc3Qgc2VlbiA9IG5ldyBTZXQoKTtcbiAgLy8gZm9yIChjb25zdCBleGl0IG9mIGV4aXRzLnZhbHVlcygpKSB7XG4gIC8vICAgaWYgKCFleGl0LnNodWZmbGUpIGNvbnRpbnVlO1xuICAvLyAgIGlmIChzZWVuLmhhcyhleGl0KSkgY29udGludWU7XG4gIC8vICAgc2Vlbi5hZGQoZXhpdC5yZXZlcnNlKTtcbiAgLy8gICBjb25zb2xlLmxvZyhgKCR7ZXhpdC5jb25ufSkgJHtleGl0LmxvYy5uYW1lfSAgPD09PiAgJHtleGl0LnJldmVyc2UubG9jLm5hbWV9ICgke2V4aXQucmV2ZXJzZS5jb25ufSlgKTtcbiAgLy8gfVxuXG4gIC8vIE5leHQgZmluZCBhbGwgdGhlIG5vbi1zaHVmZmxlZCBleGl0cyBhbmQgVW5pb25GaW5kIHRoZW0hXG4gIGNvbnN0IHVmID0gbmV3IFVuaW9uRmluZDxzdHJpbmc+KCk7XG4gIGZvciAoY29uc3QgZXhpdCBvZiBleGl0cy52YWx1ZXMoKSkge1xuICAgIGlmIChleGl0LnNodWZmbGUpIGNvbnRpbnVlO1xuICAgIHVmLnVuaW9uKFtleGl0LmFyZWEsIGV4aXQucmV2ZXJzZS5hcmVhXSk7XG4gIH1cbiAgLy9jb25zdCBhcmVhVG9Mb2NhdGlvbk1hcCA9IG5ldyBNYXAoKTtcbiAgY29uc3QgYXJlYUV4aXRzID0gbmV3IERlZmF1bHRNYXA8c3RyaW5nLCBFeGl0W10+KCgpID0+IFtdKTtcbiAgZm9yIChjb25zdCBleGl0IG9mIGV4aXRzLnZhbHVlcygpKSB7XG4gICAgLy9hcmVhVG9Mb2NhdGlvbk1hcC5zZXQoZXhpdC5hcmVhLCBleGl0LmxvYy5uYW1lKTtcbiAgICBpZiAoIWV4aXQuc2h1ZmZsZSkgY29udGludWU7XG4gICAgYXJlYUV4aXRzLmdldChleGl0LmFyZWEgPSB1Zi5maW5kKGV4aXQuYXJlYSkpLnB1c2goZXhpdCk7XG4gIH1cblxuICAvLyBESUFHTk9TVElDOiBjaGVjayB0aGF0IHRoZSBhcmVhcyBhcmUgY29ycmVjdFxuICAvLyBmb3IgKGNvbnN0IHNldCBvZiB1Zi5zZXRzKCkpIHtcbiAgLy8gICBjb25zb2xlLmxvZyhgQXJlYTogJHtbLi4uc2V0XS5tYXAobCA9PiBhcmVhVG9Mb2NhdGlvbk1hcC5nZXQobCkpLmpvaW4oJywgJyl9YCk7XG4gIC8vIH1cblxuICAvLyBQYXJ0aXRpb25zIGFyZWEga2V5cy4gIFJldHVybnMgdGhlIG51bWJlciBvZiBwYXJ0aXRpb25zICg+MSBtZWFuc1xuICAvLyB0aGUgbWFwIGlzIGRpc2Nvbm5lY3Rpb24pLCBhIG1hcCBmcm9tIGV4aXQgdG8gcGFydGl0aW9uIG51bWJlciwgYW5kXG4gIC8vIHRoZSBsaXN0IG9mIGV4aXRzIGluIHRoZSBzbWFsbGVzdCBwYXJ0aXRpb24sIHRvIGJlIHVzZWQgYXMgYSBwb29sXG4gIC8vIG9mIGV4aXRzIHRvIHN3YXAgbmV4dCB0byBoYXZlIHRoZSBiZXN0IGNoYW5jZSB0byByZWNvbm5lY3RpbmcuXG4gIGNvbnN0IHN0YXJ0ID0gZXhpdHNCeUxvY2F0aW9uLmdldChsb2MuTWV6YW1lU2hyaW5lKVswXS5hcmVhO1xuICBmdW5jdGlvbiB0cmF2ZXJzZSgpOiBbbnVtYmVyLCBNYXA8RXhpdCwgbnVtYmVyPiwgRXhpdFtdXSB7XG4gICAgY29uc3Qgc2VlbiA9IG5ldyBTZXQoKTtcbiAgICBjb25zdCBtYXAgPSBuZXcgTWFwPEV4aXQsIG51bWJlcj4oKTtcbiAgICBjb25zdCBwYXJ0aXRpb25zOiBFeGl0W11bXSA9IFtdO1xuICAgIGZvciAoY29uc3QgYXJlYSBvZiBbc3RhcnQsIC4uLmFyZWFFeGl0cy5rZXlzKCldKSB7XG4gICAgICBpZiAoc2Vlbi5oYXMoYXJlYSkpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgcXVldWUgPSBuZXcgU2V0KFthcmVhXSk7XG4gICAgICBjb25zdCBwYXJ0aXRpb246IEV4aXRbXSA9IFtdO1xuICAgICAgZm9yIChjb25zdCBuZXh0IG9mIHF1ZXVlKSB7XG4gICAgICAgIHNlZW4uYWRkKG5leHQpO1xuICAgICAgICBmb3IgKGNvbnN0IGV4aXQgb2YgYXJlYUV4aXRzLmdldChuZXh0KSkge1xuICAgICAgICAgIG1hcC5zZXQoZXhpdCwgcGFydGl0aW9ucy5sZW5ndGgpO1xuICAgICAgICAgIHBhcnRpdGlvbi5wdXNoKGV4aXQpO1xuICAgICAgICAgIGlmIChleGl0Lm9uZVdheSB8fCBzZWVuLmhhcyhleGl0LnJldmVyc2UuYXJlYSkpIGNvbnRpbnVlO1xuICAgICAgICAgIHF1ZXVlLmFkZChleGl0LnJldmVyc2UuYXJlYSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHBhcnRpdGlvbnMucHVzaChwYXJ0aXRpb24pO1xuICAgIH1cbiAgICBsZXQgbWluID0gMDtcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IHBhcnRpdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChwYXJ0aXRpb25zW2ldLmxlbmd0aCA8IHBhcnRpdGlvbnNbbWluXS5sZW5ndGgpIG1pbiA9IGk7XG4gICAgfVxuICAgIHJldHVybiBbcGFydGl0aW9ucy5sZW5ndGgsIG1hcCwgcGFydGl0aW9uc1ttaW5dXTtcbiAgfVxuXG4gIGNvbnN0IGV4aXRzQnlDb25uID0gbmV3IERlZmF1bHRNYXA8QXJlYUNvbm5lY3Rpb24sIEV4aXRbXT4oKCkgPT4gW10pO1xuICBmb3IgKGNvbnN0IGV4aXQgb2YgZXhpdHMudmFsdWVzKCkpIHtcbiAgICBpZiAoIWV4aXQuc2h1ZmZsZSB8fCAhZXhpdC5jb25uKSBjb250aW51ZTtcbiAgICBleGl0c0J5Q29ubi5nZXQoZXhpdC5jb25uKS5wdXNoKGV4aXQpO1xuICB9XG5cbiAgZm9yIChjb25zdCBjIG9mICgnTldDRicgYXMgSXRlcmFibGU8QXJlYUNvbm5lY3Rpb24+KSkge1xuICAgIGNvbnN0IG9yaWdpbmFsID0gZXhpdHNCeUNvbm4uZ2V0KGMpITtcbiAgICBjb25zdCBzaHVmZmxlZCA9IHJhbmRvbS5zaHVmZmxlKFsuLi5vcmlnaW5hbF0pLm1hcChlID0+IGUucmV2ZXJzZSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaHVmZmxlZC5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgZXhpdDEgPSBvcmlnaW5hbFtpXTtcbiAgICAgIGNvbnN0IGV4aXQyID0gc2h1ZmZsZWRbaV07XG4gICAgICBbZXhpdDEucmV2ZXJzZSwgZXhpdDIucmV2ZXJzZV0gPSBbZXhpdDIsIGV4aXQxXTtcbiAgICB9XG4gIH1cblxuICAvLyBSZWNvbm5lY3QgYW55IGRpc2Nvbm5lY3RlZCBwaWVjZXNcbiAgbGV0IGl0ZXJhdGlvbnMgPSAwO1xuICBsZXQgW2NvdW50LCB0cmF2ZXJzYWwsIHBvb2xdID0gdHJhdmVyc2UoKTtcbiAgd2hpbGUgKGl0ZXJhdGlvbnMtLSA+IDAgfHwgY291bnQgPiAxKSB7IC8vIGNvdWxkIHN3aXRjaCBvcmRlcj9cbiAgICBjb25zdCBleGl0MSA9IHJhbmRvbS5waWNrKHBvb2wpO1xuICAgIGxldCBlbGlnaWJsZSA9IGV4aXRzQnlDb25uLmdldChleGl0MS5jb25uISk7XG4gICAgaWYgKGNvdW50ID4gMSkge1xuICAgICAgY29uc3QgYXZvaWQgPSB0cmF2ZXJzYWwuZ2V0KGV4aXQxKTtcbiAgICAgIGVsaWdpYmxlID0gZWxpZ2libGUuZmlsdGVyKGUgPT4gdHJhdmVyc2FsLmdldChlKSAhPT0gYXZvaWQpO1xuICAgIH1cbiAgICBjb25zdCBleGl0MiA9IHJhbmRvbS5waWNrKGVsaWdpYmxlKTtcbiAgICBjb25zdCByZXYxID0gZXhpdDEucmV2ZXJzZTtcbiAgICBjb25zdCByZXYyID0gZXhpdDIucmV2ZXJzZTtcbiAgICBleGl0MS5yZXZlcnNlID0gcmV2MjtcbiAgICByZXYyLnJldmVyc2UgPSBleGl0MTtcbiAgICBleGl0Mi5yZXZlcnNlID0gcmV2MTtcbiAgICByZXYxLnJldmVyc2UgPSBleGl0MjtcbiAgICBbY291bnQsIHRyYXZlcnNhbCwgcG9vbF0gPSB0cmF2ZXJzZSgpO1xuICAgIGlmIChpdGVyYXRpb25zIDwgLTEwKSBkZWJ1Z2dlcjtcbiAgfVxuXG4gIGZvciAoY29uc3QgZXhpdCBvZiBleGl0cy52YWx1ZXMoKSkge1xuICAgIGlmIChleGl0LnJldmVyc2UgIT09IGV4aXQub3JpZ1Jldikge1xuICAgICAgZnVuY3Rpb24gc2hvd0V4aXQoZTogRXhpdCkgeyByZXR1cm4gYCR7ZS5sb2MubmFtZX0gJHtlLnR5cGV9KCR7ZS5wb3MudG9TdHJpbmcoMTYpfSlgOyB9XG4gICAgICBjb25zb2xlLmxvZyhgJHtzaG93RXhpdChleGl0KX0gID0+ICAke3Nob3dFeGl0KGV4aXQucmV2ZXJzZSl9ICAod2FzICR7c2hvd0V4aXQoZXhpdC5vcmlnUmV2KX0pYCk7XG4gICAgfVxuXG4gICAgZXhpdC5sb2MubWV0YS5hdHRhY2goZXhpdC5wb3MsIGV4aXQucmV2ZXJzZS5sb2MubWV0YSwgZXhpdC5yZXZlcnNlLnBvcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICBleGl0LnR5cGUsIGV4aXQucmV2ZXJzZS50eXBlKTtcbiAgfVxuXG4gIC8vY29uc29sZS5sb2codHJhdmVyc2UoKSk7XG4gIC8vZGVidWdnZXI7XG59XG5cbi8vIGZ1bmN0aW9uIG1hdGNoRXhpdChmaW5kZXI6IEV4aXRGaW5kZXIpOlxuLy8gICAgICAgKGU6IHJlYWRvbmx5IFtudW1iZXIsIENvbm5lY3Rpb25UeXBlLCBFeGl0U3BlY10pID0+IGJvb2xlYW4ge1xuLy8gICBpZiAodHlwZW9mIGZpbmRlciA9PT0gJ3N0cmluZycpIHJldHVybiAoWywgdF0pID0+IHQgPT09IGZpbmRlcjtcbi8vICAgaWYgKHR5cGVvZiBmaW5kZXIgPT09ICdudW1iZXInKSByZXR1cm4gKFtwXSkgPT4gcCA9PT0gZmluZGVyO1xuLy8gICBpZiAoZmluZGVyIGluc3RhbmNlb2YgTG9jYXRpb24pIHJldHVybiAoWywsIFtsXV0pID0+IChsID4+PiA4KSA9PT0gZmluZGVyLmlkO1xuLy8gICBjb25zdCBtYXRjaGVycyA9IGZpbmRlci5tYXAobWF0Y2hFeGl0KTtcbi8vICAgcmV0dXJuIChlKSA9PiBtYXRjaGVycy5ldmVyeShmID0+IGYoZSkpO1xuLy8gfVxuXG4vLyBmdW5jdGlvbiBleGl0S2V5KGxvY1BvczogbnVtYmVyLCBleGl0VHlwZTogQ29ubmVjdGlvblR5cGUpIHtcbi8vICAgcmV0dXJuIGxvY1Bvcy50b1N0cmluZygxNikgKyAnICcgKyBleGl0VHlwZTtcbi8vIH1cblxuLy8gZnVuY3Rpb24gYWRkRXhpdHMoZnJvbUxvYzogTG9jYXRpb24sXG4vLyAgICAgICAgICAgICAgICAgICAuLi5leGl0U3BlY3M6IEFyZWFFeGl0U3BlY1tdKTogdm9pZCB7XG4vLyAgIGNvbnN0IGV4aXRzID0gWy4uLmZyb21Mb2MubWV0YS5leGl0cygpXTtcbi8vICAgZm9yIChjb25zdCBbY29ubmVjdGlvbiwgZmluZGVyLCB0b0FyZWEsIG9uZVdheV0gb2YgZXhpdFNwZWNzKSB7XG4vLyAgICAgY29uc3QgW2V4aXQsIC4uLnJlc3RdID0gZXhpdHMuZmlsdGVyKG1hdGNoRXhpdChmaW5kZXIpKTtcbi8vICAgICBpZiAoIWV4aXQpIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBleGl0OiAke2ZpbmRlcn0gaW4gJHtmcm9tTG9jfWApO1xuLy8gICAgIGlmIChyZXN0Lmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKGBBbWJpZ3VvdXMgZXhpdDogJHtmaW5kZXJ9IGluICR7ZnJvbUxvY31gKTtcbi8vICAgICBjb25zdCBmcm9tTG9jUG9zID0gZnJvbUxvYy5pZCA8PCA4IHwgZXhpdFswXTtcbi8vICAgICBjb25zdCBmcm9tVHlwZSA9IGV4aXRbMV07XG4vLyAgICAgY29uc3QgZnJvbUtleSA9IGV4aXRLZXkoZnJvbUxvY1BvcywgZnJvbVR5cGUpO1xuLy8gICAgIGNvbnN0IFt0b0xvY1BvcywgdG9UeXBlXSA9IGV4aXRbMl07XG4vLyAgICAgY29uc3QgdG9LZXkgPSBleGl0S2V5KHRvTG9jUG9zLCB0b1R5cGUpO1xuLy8gICAgIGNvbnN0IGZyb21FeGl0ID0ge1xuLy8gICAgICAgY29ubjogY29ubmVjdGlvbixcbi8vICAgICAgIGRlc3Q6IHRvQXJlYSxcbi8vICAgICAgIGRlc3RLZXk6IHRvS2V5LFxuLy8gICAgICAgbG9jUG9zOiBmcm9tTG9jUG9zLFxuLy8gICAgICAgZXhpdFR5cGU6IGZyb21UeXBlLFxuLy8gICAgIH07XG4vLyAgICAgY29uc3QgdG9FeGl0ID0ge1xuLy8gICAgICAgY29ubjogY29ubkludmVyc2UuZ2V0KGNvbm5lY3Rpb24pISxcbi8vICAgICAgIGRlc3Q6IGZyb21BcmVhLFxuLy8gICAgICAgZGVzdEtleTogZnJvbUtleSxcbi8vICAgICAgIGxvY1BvczogdG9Mb2NQb3MsXG4vLyAgICAgICBleGl0VHlwZTogdG9UeXBlLFxuLy8gICAgIH07XG4vLyAgICAgZnJvbUFyZWEuZXhpdHMuc2V0KGZyb21LZXksIGZyb21FeGl0KTtcbi8vICAgICBpZiAoIW9uZVdheSkgdG9BcmVhLmV4aXRzLnNldCh0b0tleSwgdG9FeGl0KTtcbi8vICAgfVxuLy8gfVxuXG4vLyBmdW5jdGlvbiBidWlsZEtleShsb2M6IExvY2F0aW9ufG51bGwsXG4vLyAgICAgICAgICAgICAgICAgICBbcG9zLCB0eXBdOiByZWFkb25seSBbUG9zLCBDb25uZWN0aW9uVHlwZSwgLi4udW5rbm93bltdXSk6IHN0cmluZyB7XG4vLyAgIHJldHVybiAoKGxvYyA/IGxvYy5pZCA8PCA4IDogMCkgfCBwb3MpLnRvU3RyaW5nKDE2KSArICcgJyArIHR5cDtcbi8vIH1cblxuXG4vLyBjbGFzcyBFeGl0TWFwIHtcbi8vICAgZXhpdHMgPSBuZXcgTWFwPHN0cmluZywgRXhpdD4oKTtcblxuLy8gICBsb2NhdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuLy8gICBleGl0c0J5TG9jYXRpb24gPSBuZXcgRGVmYXVsdE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PigoKSA9PiBuZXcgU2V0KCkpO1xuLy8gICBvcHBvc2l0ZXMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuXG4vLyAgIHNwbGl0TG9jYXRpb24obG9jOiBMb2NhdGlvbiwgLi4uZmluZGVyczogRXhpdEZpbmRlcltdKSB7XG4vLyAgICAgY29uc3QgbWF0Y2hlcnMgPSBmaW5kZXJzLm1hcChtYXRjaEV4aXQpO1xuLy8gICAgIGxldCBrZXk6IHN0cmluZ3x1bmRlZmluZWQ7XG4vLyAgICAgZm9yIChjb25zdCBleGl0IG9mIGxvYy5tZXRhLmV4aXRzKCkpIHtcbi8vICAgICAgIGZvciAoY29uc3QgbWF0Y2hlciBvZiBtYXRjaGVycykge1xuLy8gICAgICAgICBpZiAoIW1hdGNoZXIoZXhpdCkpIGNvbnRpbnVlO1xuLy8gICAgICAgICBsZXQgZXhpdEtleSA9IGJ1aWxkS2V5KGxvYywgZXhpdCk7XG4vLyAgICAgICAgIGlmIChrZXkgPT0gdW5kZWZpbmVkKSBrZXkgPSBleGl0S2V5O1xuLy8gICAgICAgICB0aGlzLmxvY2F0aW9ucy5zZXQoZXhpdEtleSwga2V5KTtcbi8vICAgICAgICAgYnJlYWs7XG4vLyAgICAgICB9XG4vLyAgICAgfVxuLy8gICB9XG5cbi8vICAgbG9jYXRpb25LZXkobG9jOiBMb2NhdGlvbiwgZXhpdDogRXhpdERlc2NyaXB0b3IpOiBzdHJpbmcge1xuLy8gICAgIGNvbnN0IGtleSA9IGJ1aWxkS2V5KGxvYywgZXhpdCk7XG4vLyAgICAgbGV0IHZhbHVlID0gdGhpcy5sb2NhdGlvbnMuZ2V0KGtleSk7XG4vLyAgICAgaWYgKCF2YWx1ZSkgdGhpcy5sb2NhdGlvbnMuc2V0KGtleSwgdmFsdWUgPSBsb2MuaWQudG9TdHJpbmcoMTYpKTtcblxuLy8gICAgIC8vIFRPRE8gLSB0aGlzLmV4aXRzQnlMb2NhdGlvblxuXG4vLyAgICAgcmV0dXJuIHZhbHVlO1xuLy8gICB9XG5cbi8vICAgcHJpdmF0ZSBhZGRFeGl0SW50ZXJuYWwoZnJvbUtleTogc3RyaW5nLCB0b0tleTogc3RyaW5nKTogdm9pZCB7XG4gICAgXG4vLyAgIH1cblxuLy8gICBhZGRFeGl0KGxvYzogTG9jYXRpb24sIGNvbm46IEFyZWFDb25uZWN0aW9uLCBleGl0PzogRXhpdEZpbmRlcik6IHZvaWQge1xuICAgIFxuLy8gICB9XG4vLyAgIGFkZEV4aXRzKGxvYzogTG9jYXRpb24sIC4uLmV4aXRzOiBFeGl0RmluZGVyW10pOiB2b2lkIHtcblxuLy8gICB9XG4vLyAgIGFkZEFsbEV4aXRzKGxvYzogTG9jYXRpb24pOiB2b2lkIHtcbi8vICAgICBmb3IgKGNvbnN0IGV4aXQgb2YgbG9jLm1ldGEuZXhpdHMoKSkge1xuICAgICAgXG4vLyAgICAgICBjb25zdCBmcm9tS2V5ID0gYnVpbGRLZXkobG9jLCBleGl0KTtcbi8vICAgICAgIGNvbnN0IHRvS2V5ID0gYnVpbGRLZXkobnVsbCwgZXhpdFsyXSk7XG4vLyAgICAgICB0aGlzLmFkZEV4aXRJbnRlcm5hbChmcm9tS2V5LCB0b0tleSk7XG4vLyAgICAgfVxuLy8gICB9XG4gIFxuLy8gICAvLyBhcmVhKGxvYzogTG9jYXRpb24sIGZpbmRlcjogRXhpdEZpbmRlcik6IHN0cmluZyB7XG4vLyAgIC8vICAgLy8gXG4vLyAgIC8vIH1cbi8vIH1cblxuLy8gZnVuY3Rpb24gdW51c2VkKCkge1xuLy8gICBhZGRFeGl0cyhhcmVhLlN0YXJ0LCBsb2MuTGVhZl9PdXRzaWRlU3RhcnQsIFsnVycsIGxvYy5MZWFmLCBhcmVhLkxlYWZdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5XaW5kVmFsbGV5LCBsb2MuVmFsbGV5T2ZXaW5kLFxuLy8gICAgICAgICAgICBbJ1MnLCBsb2MuTGVhZiwgYXJlYS5MZWFmXSxcbi8vICAgICAgICAgICAgWydDJywgbG9jLlplYnVDYXZlLCBhcmVhLlplYnVdLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuU2VhbGVkQ2F2ZTEsIGFyZWEuU2VhbGVkQ2F2ZV0pO1xuLy8gICBpZiAoZmxhZ3Muc2h1ZmZsZUhvdXNlcygpKSB7XG4vLyAgICAgYWRkRXhpdHMoYXJlYS5XaW5kVmFsbGV5LCBsb2MuVmFsbGV5T2ZXaW5kLCBbJ0MnLCAweDAyLCBhcmVhLldpbmRtaWxsQ2F2ZV0pO1xuLy8gICAgIGFkZEV4aXRzKGFyZWEuV2luZG1pbGwsIGxvYy5WYWxsZXlPZldpbmQsIFsnQycsICdkb29yJywgYXJlYS5XaW5kbWlsbENhdmVdKTtcbi8vICAgfVxuLy8gICBpZiAoZmxhZ3MuYWRkRWFzdENhdmUoKSkge1xuLy8gICAgIGFkZEV4aXRzKGFyZWEuV2luZFZhbGxleSwgbG9jLlZhbGxleU9mV2luZCxcbi8vICAgICAgICAgICAgICBbJ0MnLCBsb2MuRWFzdENhdmUxLCBhcmVhLkVhc3RDYXZlXSk7XG4vLyAgICAgLy8gTk9URTogV2UgY291bGQgcG9zc2libHkgYWRkIGV4aXQxIGFuZCBleGl0MiwgYnV0IGl0J3Ncbi8vICAgICAvLyBoYXJkIHRvIGZpZ3VyZSBvdXQgaWYgKDEpIHRoZXkgZXZlbiBleGlzdCwgYW5kICgyKSBpZlxuLy8gICAgIC8vIHRoZXkgZG8sIHdoaWNoIF9hcmVhXyB0aGV5IGdvIHRvLiAgRm9yIG5vdywgd2UnbGwgdHJlYXRcbi8vICAgICAvLyBpdCBhcyBhIHRlcm1pbmFsLCBzaW5jZSB0aGUgb3RoZXIgZXhpdHMgYXJlIGFscmVhZHlcbi8vICAgICAvLyBzb21ld2hhdCByYW5kb21pemVkLlxuLy8gICB9XG4vLyAgIGFkZEV4aXRzKGFyZWEuQ29yZGVsUGxhaW4sIGxvYy5Db3JkZWxQbGFpbldlc3QsXG4vLyAgICAgICAgICAgIFsnQycsIGxvYy5TZWFsZWRDYXZlOCwgYXJlYS5TZWFsZWRDYXZlXSxcbi8vICAgICAgICAgICAgWydXJywgbG9jLkJyeW5tYWVyLCBhcmVhLkJyeW5tYWVyXSxcbi8vICAgICAgICAgICAgWydXJywgbG9jLk10U2FicmVXZXN0X0xvd2VyLCBhcmVhLlNhYnJlV2VzdF0sXG4vLyAgICAgICAgICAgIFsnTicsIGxvYy5PdXRzaWRlU3RvbUhvdXNlLCBhcmVhLlN0b21Ib3VzZV0sXG4vLyAgICAgICAgICAgIFsnUycsIGxvYy5BbWF6b25lcywgYXJlYS5BbWF6b25lc10pO1xuLy8gICBhZGRFeGl0cyhhcmVhLkNvcmRlbFBsYWluLCBsb2MuQ29yZGVsUGxhaW5FYXN0LFxuLy8gICAgICAgICAgICBbJ0UnLCBsb2MuU3dhbXAsIGFyZWEuU3dhbXBdLFxuLy8gICAgICAgICAgICBbJ04nLCBsb2MuTXRTYWJyZU5vcnRoX01haW4sIGFyZWEuU2FicmVOb3J0aF0pO1xuLy8gICBhZGRFeGl0cyhhcmVhLldhdGVyZmFsbFZhbGxleSwgbG9jLldhdGVyZmFsbFZhbGxleU5vcnRoLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuTXRTYWJyZU5vcnRoX1N1bW1pdENhdmUsIGFyZWEuU2FicmVOb3J0aF0sXG4vLyAgICAgICAgICAgIFsnVycsIGxvYy5Qb3J0b2EsIGFyZWEuUG9ydG9hXSxcbi8vICAgICAgICAgICAgWydDJywgbG9jLldhdGVyZmFsbENhdmUxLCBhcmVhLldhdGVyZmFsbENhdmVdLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuRm9nTGFtcENhdmUxLCBhcmVhLkZvZ0xhbXBDYXZlXSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuV2F0ZXJmYWxsVmFsbGV5LCBsb2MuV2F0ZXJmYWxsVmFsbGV5U291dGgsXG4vLyAgICAgICAgICAgIFsnQycsIGxvYy5LaXJpc2FQbGFudENhdmUxLCBhcmVhLktpcmlzYUNhdmVdLFxuLy8gICAgICAgICAgICBbJ1cnLCBsb2MuTGltZVRyZWVWYWxsZXksIGFyZWEuTGltZVRyZWVWYWxsZXldKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5LaXJpc2FDYXZlLCBsb2MuS2lyaXNhUGxhbnRDYXZlMyxcbi8vICAgICAgICAgICAgWydYJywgbG9jLktpcmlzYU1lYWRvdywgYXJlYS5LaXJpc2FNZWFkb3ddKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5MaW1lVHJlZUxha2UsIGxvYy5MaW1lVHJlZUxha2UsXG4vLyAgICAgICAgICAgIFsnWCcsIGxvYy5MaW1lVHJlZVZhbGxleSwgYXJlYS5MaW1lVHJlZVZhbGxleV0sXG4vLyAgICAgICAgICAgIFsnQycsIGxvYy5NZXNpYVNocmluZSwgYXJlYS5NZXNpYVNocmluZV0pO1xuLy8gICBhZGRFeGl0cyhhcmVhLkFuZ3J5U2VhLCBsb2MuUG9ydG9hX0Zpc2hlcm1hbklzbGFuZCxcbi8vICAgICAgICAgICAgLy8gVE9ETyAtIGhvdyB0byBtYWtlIHRoaXMgb25lLXdheT9cbi8vICAgICAgICAgICAgWydFJywgbG9jLlBvcnRvYSwgYXJlYS5Qb3J0b2EsIHRydWVdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5BbmdyeVNlYSwgbG9jLkV2aWxTcGlyaXRJc2xhbmQxLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuRXZpbFNwaXJpdElzbGFuZDIsIGFyZWEuRXZpbFNwaXJpdElzbGFuZF0pO1xuLy8gICBhZGRFeGl0cyhhcmVhLkFuZ3J5U2VhLCBsb2MuQW5ncnlTZWEsXG4vLyAgICAgICAgICAgIFsnQycsIGxvYy5Kb2VsLCBhcmVhLkpvZWxdLFxuLy8gICAgICAgICAgICBbJ04nLCBsb2MuU3dhbiwgYXJlYS5Td2FuXSk7XG4vLyAgIGlmICghZmxhZ3Muc2h1ZmZsZUhvdXNlcygpKSB7XG4vLyAgICAgLy8gVE9ETyAtIHdyb25nIGFyZWEgaWYgd2UgaGF2ZSBob3VzZSBzaHVmZmxlLi4uPyBob3cgdG8gZml4P1xuLy8gICAgIGFkZEV4aXRzKGFyZWEuSm9lbFBhc3NhZ2UsIGxvYy5Kb2VsU2VjcmV0UGFzc2FnZSxcbi8vICAgICAgICAgICAgICBbJ1gnLCBsb2MuSm9lbF9TaGVkLCBhcmVhLkpvZWxdLFxuLy8gICAgICAgICAgICAgIFsnWCcsIGxvYy5BbmdyeVNlYSwgYXJlYS5MaWdodGhvdXNlXSk7XG4vLyAgIH1cbi8vICAgYWRkRXhpdHMoYXJlYS5ab21iaWVUb3duLCBsb2MuWm9tYmllVG93bixcbi8vICAgICAgICAgICAgWydDJywgJ2NhdmUnLCBhcmVhLkV2aWxTcGlyaXRJc2xhbmRdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5Td2FuLCBsb2MuU3dhbiwgWydXJywgbG9jLlN3YW5HYXRlLCBhcmVhLlN3YW5HYXRlXSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuR29hVmFsbGV5LCBsb2MuR29hVmFsbGV5LFxuLy8gICAgICAgICAgICBbJ0UnLCBsb2MuU3dhbkdhdGUsIGFyZWEuU3dhbkdhdGVdLFxuLy8gICAgICAgICAgICBbJ1cnLCBsb2MuTXRIeWRyYSwgYXJlYS5IeWRyYV0sXG4vLyAgICAgICAgICAgIFsnUycsIGxvYy5EZXNlcnQxLCBhcmVhLkRlc2VydDFdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5EZXNlcnQxLCBsb2MuRGVzZXJ0MSxcbi8vICAgICAgICAgICAgWydDJywgbG9jLk9hc2lzQ2F2ZV9FbnRyYW5jZSwgYXJlYS5PYXNpc0NhdmVdLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuRGVzZXJ0Q2F2ZTEsIGFyZWEuRGVzZXJ0Q2F2ZTFdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5PYXNpc0NhdmUsIGxvYy5PYXNpc0NhdmVNYWluLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuR29hRm9ydHJlc3NCYXNlbWVudCwgYXJlYS5Hb2FCYXNlbWVudF0pO1xuLy8gICBhZGRFeGl0cyhhcmVhLkRlc2VydENhdmUxLCBsb2MuRGVzZXJ0Q2F2ZTEsXG4vLyAgICAgICAgICAgIFsnWCcsIGxvYy5TYWhhcmFNZWFkb3csIGFyZWEuU2FoYXJhXSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuU2FoYXJhRXhpdCwgbG9jLlNhaGFyYU91dHNpZGVDYXZlLFxuLy8gICAgICAgICAgICBbJ1cnLCBsb2MuU2FoYXJhLCBhcmVhLlNhaGFyYV0sXG4vLyAgICAgICAgICAgIFsnQycsIGxvYy5EZXNlcnRDYXZlMiwgYXJlYS5EZXNlcnRDYXZlMl0pO1xuLy8gICBhZGRFeGl0cyhhcmVhLkVuZCwgbG9jLkRlc2VydDIsIFsnQycsIGxvYy5EZXNlcnRDYXZlMiwgYXJlYS5EZXNlcnRDYXZlMl0pO1xuXG4vLyAgIC8vIFdlJ3ZlIGdvdCB0aGUgd2hvbGUgZ3JhcGggc2V0IHVwLiAgTm93IHdlIG5lZWQgYSBmdW5jdGlvbiB0byB0cmF2ZXJzZSB0aGVcbi8vICAgLy8gZ3JhcGggYW5kIG1ha2Ugc3VyZSBpdCdzIHZhbGlkLlxuLy8gICBjb25zdCBhbGxBcmVhcyA9IE9iamVjdC5rZXlzKGFyZWEpLm1hcChrID0+IGFyZWFbayBhcyBrZXlvZiB0eXBlb2YgYXJlYV0pXG4vLyAgICAgICAuZmlsdGVyKGEgPT4gYS5leGl0cy5zaXplKTtcbi8vICAgZnVuY3Rpb24gdHJhdmVyc2UoKTogQXJyYXk8TWFwPEFyZWFDb25uZWN0aW9uLCBBcmVhRXhpdFtdPj4ge1xuLy8gICAgIGNvbnN0IHNlZW4gPSBuZXcgU2V0KCk7XG4vLyAgICAgY29uc3Qgb3V0ID0gW107XG4vLyAgICAgZm9yIChjb25zdCBhIG9mIFthcmVhLlN0YXJ0LCAuLi5hbGxBcmVhc10pIHtcbi8vICAgICAgIGlmIChzZWVuLmhhcyhhKSkgY29udGludWU7XG4vLyAgICAgICBjb25zdCBxdWV1ZSA9IG5ldyBTZXQoW2FdKTtcbi8vICAgICAgIGNvbnN0IG1hcCA9IG5ldyBEZWZhdWx0TWFwPEFyZWFDb25uZWN0aW9uLCBBcmVhRXhpdFtdPigoKSA9PiBbXSk7XG4vLyAgICAgICBmb3IgKGNvbnN0IG5leHQgb2YgcXVldWUpIHtcbi8vICAgICAgICAgZm9yIChjb25zdCBleGl0IG9mIG5leHQuZXhpdHMudmFsdWVzKCkpIHtcbi8vICAgICAgICAgICBpZiAoc2Vlbi5oYXMoZXhpdC5kZXN0KSkgY29udGludWU7XG4vLyAgICAgICAgICAgc2Vlbi5hZGQoZXhpdC5kZXN0KTtcbi8vICAgICAgICAgICBxdWV1ZS5hZGQoZXhpdC5kZXN0KTtcbi8vICAgICAgICAgICBtYXAuZ2V0KGV4aXQuY29ubikucHVzaChleGl0KTtcbi8vICAgICAgICAgICBjb25zdCByZXZlcnNlID0gZXhpdC5kZXN0LmV4aXRzLmdldChleGl0LmRlc3RLZXkpO1xuLy8gICAgICAgICAgIGlmIChyZXZlcnNlKSBtYXAuZ2V0KHJldmVyc2UuY29ubikucHVzaChyZXZlcnNlKTtcbi8vICAgICAgICAgfVxuLy8gICAgICAgfVxuLy8gICAgICAgb3V0LnB1c2gobWFwKTtcbi8vICAgICB9XG4vLyAgICAgcmV0dXJuIG91dDtcbi8vICAgfVxuXG4vLyAgIC8vIEJhc2ljIHBsYW46IHBpY2sgdHdvIHJhbmRvbSBleGl0cyBvZiB0aGUgc2FtZSB0eXBlLlxuLy8gICBsZXQgaXRlcnMgPSAxMDA7XG4vLyAgIGxldCB0cmF2ZXJzYWwgPSB0cmF2ZXJzZSgpO1xuLy8gICB3aGlsZSAoaXRlcnMtLSA+IDAgfHwgdHJhdmVyc2FsLmxlbmd0aCA+IDEpIHtcbi8vICAgICBpZiAodHJhdmVyc2FsLmxlbmd0aCA+IDIpIHJhbmRvbS5zaHVmZmxlKHRyYXZlcnNhbCk7XG4vLyAgICAgaWYgKHRyYXZlcnNhbC5sZW5ndGggPiAxKSB7XG4vLyAgICAgICAvLyBwaWNrIGFuIGNvbm4gdHlwZSB0aGF0J3MgcHJlc2VudCBpbiBib3RoIHNldHNcbi8vICAgICB9XG4vLyAgICAgdHJhdmVyc2FsID0gdHJhdmVyc2UoKTtcbi8vICAgfVxuLy8gfVxuIl19