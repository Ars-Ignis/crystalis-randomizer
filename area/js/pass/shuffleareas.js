import { Location } from '../rom/location.js';
import { DefaultMap } from '../util.js';
import { UnionFind } from '../unionfind.js';
const connMap = new Map([
    ['stair:up', 'C'],
    ['edge:top', 'N'],
    ['edge:left', 'W'],
    ['edge:right', 'E'],
    ['cave', 'C'],
    ['door', 'C'],
    ['door2', 'C'],
    ['door3', 'C'],
    ['fortress', 'F'],
]);
const connInverse = new Map([
    ['N', 'S'],
    ['S', 'N'],
    ['E', 'W'],
    ['W', 'E'],
    ['C', 'X'],
    ['X', 'C'],
    ['F', 'O'],
    ['O', 'F'],
]);
function makeExit(loc, [pos, type, [revLocPos, revType]]) {
    let conn = connMap.get(type) || connInverse.get(connMap.get(revType));
    let shuffle = false;
    const area = loc.id.toString(16);
    const key = (loc.id << 8 | pos).toString(16) + ' ' + type;
    const revLoc = loc.rom.locations[revLocPos >>> 8];
    const revPos = revLocPos & 0xff;
    const revKey = revLocPos.toString(16) + ' ' + revType;
    const revArea = revLoc.id.toString(16);
    const reverse = {
        loc: revLoc, pos: revPos, type: revType,
        area: revArea, key: revKey, reverse: null, origRev: null,
        get conn() { return connInverse.get(conn); },
        set conn(c) { conn = connInverse.get(c); },
        get shuffle() { return shuffle; },
        set shuffle(s) {
            if (s && !conn)
                throw new Error(`shuffle without conn`);
            shuffle = s;
        },
    };
    const exit = {
        loc, pos, type, key, reverse, area, origRev: reverse,
        get conn() { return conn; },
        set conn(c) { conn = c; },
        get shuffle() { return shuffle; },
        set shuffle(s) {
            if (s && !conn)
                throw new Error(`shuffle without conn`);
            shuffle = s;
        },
    };
    reverse.reverse = reverse.origRev = exit;
    return exit;
}
function matchExit(exit, finder) {
    if (typeof finder === 'string')
        return exit.type === finder;
    if (typeof finder === 'number')
        return exit.pos === finder;
    if (finder instanceof Location)
        return exit.reverse.loc === finder;
    return finder.every(f => matchExit(exit, f));
}
export function shuffleAreas(rom, flags, random) {
    if (!flags.shuffleAreas())
        return;
    const { locations: loc } = rom;
    const exits = new Map();
    const exitsByLocation = new DefaultMap(() => []);
    for (const location of rom.locations) {
        for (const exitSpec of location.meta.exits()) {
            if (location === loc.CordelPlainEast && (exitSpec[0] & 0x0f) < 5)
                continue;
            if (location === loc.CordelPlainWest && (exitSpec[0] & 0x0f) > 4)
                continue;
            if (location.isTower())
                continue;
            const exit = makeExit(location, exitSpec);
            if (exit.loc === loc.Portoa_FortuneTeller)
                continue;
            if (exit.reverse.loc === loc.Portoa_FortuneTeller)
                continue;
            if (exits.has(exit.key))
                continue;
            if (exits.has(exit.reverse.key)) {
                throw new Error(`Inconsistent exits: ${exit.key} | ${exit.reverse.key}`);
            }
            exits.set(exit.key, exit);
            exits.set(exit.reverse.key, exit.reverse);
            exitsByLocation.get(exit.loc).push(exit);
            exitsByLocation.get(exit.reverse.loc).push(exit.reverse);
        }
    }
    function findExits(location, ...finders) {
        const out = [];
        for (const exit of exitsByLocation.get(location)) {
            for (const finder of finders) {
                if (matchExit(exit, finder)) {
                    out.push(exit);
                    break;
                }
            }
        }
        return out;
    }
    if (flags.shuffleHouses()) {
        for (const exit of findExits(loc.ValleyOfWind, 'door', 'windmill')) {
            exit.area = 'windmill';
        }
    }
    for (const exit of findExits(loc.AngrySea, 0x64)) {
        exit.area = 'lighthouse';
    }
    findExits(loc.Portoa_FishermanIsland, loc.Portoa)[0].oneWay = true;
    function mark(loc, ...exits) {
        for (const exit of findExits(loc, ...exits)) {
            exit.shuffle = true;
        }
    }
    function markOutside(...locs) {
        const set = new Set(locs);
        for (const loc of locs) {
            for (const exit of exitsByLocation.get(loc)) {
                if (!set.has(exit.reverse.loc))
                    exit.shuffle = true;
            }
        }
    }
    mark(loc.Leaf, loc.Leaf_OutsideStart);
    markOutside(loc.ValleyOfWind, loc.WindmillCave, loc.Windmill);
    if (flags.shuffleHouses())
        markOutside(loc.WindmillCave);
    markOutside(loc.EastCave1, loc.EastCave2, loc.EastCave3);
    markOutside(loc.ZebuCave, loc.MtSabreWest_Cave1);
    markOutside(loc.CordelPlainWest, loc.CordelPlainEast);
    markOutside(loc.WaterfallValleyNorth, loc.WaterfallValleySouth);
    markOutside(loc.KirisaMeadow);
    markOutside(loc.LimeTreeLake);
    mark(loc.Portoa_FishermanIsland, loc.Portoa);
    mark(loc.UndergroundChannel, loc.PortoaPalace_ThroneRoom);
    mark(loc.AngrySea, loc.Joel);
    markOutside(loc.JoelSecretPassage);
    mark(loc.EvilSpiritIsland1, loc.EvilSpiritIsland2);
    mark(loc.ZombieTown, loc.EvilSpiritIsland3);
    mark(loc.AngrySea, loc.Swan);
    markOutside(loc.SwanGate);
    mark(loc.GoaValley, loc.MtHydra);
    markOutside(loc.Desert1);
    markOutside(loc.GoaFortressBasement);
    markOutside(loc.DesertCave1);
    markOutside(loc.SaharaOutsideCave);
    markOutside(loc.DesertCave2);
    if (!flags.shuffleHouses()) {
        const palaces = [
            [loc.ZombieTown, loc.SaberaPalace1],
            [loc.MtHydra, loc.Styx1],
            [loc.Desert2, loc.Pyramid_Entrance],
            [loc.Goa, loc.GoaFortress_Entrance],
            [loc.Portoa, loc.Portoa_PalaceEntrance],
            [loc.Shyron, loc.Shyron_Temple],
            [loc.GoaValley, loc.Goa],
            [loc.OasisCave_Entrance, loc.GoaFortress_Exit],
            [loc.MtHydra_OutsideShyron, loc.Shyron],
        ];
        for (const [outside, inside] of palaces) {
            const [exit] = findExits(outside, inside);
            exit.conn = 'F';
            exit.shuffle = true;
        }
    }
    const uf = new UnionFind();
    for (const exit of exits.values()) {
        if (exit.shuffle)
            continue;
        uf.union([exit.area, exit.reverse.area]);
    }
    const areaExits = new DefaultMap(() => []);
    for (const exit of exits.values()) {
        if (!exit.shuffle)
            continue;
        areaExits.get(exit.area = uf.find(exit.area)).push(exit);
    }
    const start = exitsByLocation.get(loc.MezameShrine)[0].area;
    function traverse() {
        const seen = new Set();
        const map = new Map();
        const partitions = [];
        for (const area of [start, ...areaExits.keys()]) {
            if (seen.has(area))
                continue;
            const queue = new Set([area]);
            const partition = [];
            for (const next of queue) {
                seen.add(next);
                for (const exit of areaExits.get(next)) {
                    map.set(exit, partitions.length);
                    partition.push(exit);
                    if (exit.oneWay || seen.has(exit.reverse.area))
                        continue;
                    queue.add(exit.reverse.area);
                }
            }
            partitions.push(partition);
        }
        let min = 0;
        for (let i = 1; i < partitions.length; i++) {
            if (partitions[i].length < partitions[min].length)
                min = i;
        }
        return [partitions.length, map, partitions[min]];
    }
    const exitsByConn = new DefaultMap(() => []);
    for (const exit of exits.values()) {
        if (!exit.shuffle || !exit.conn)
            continue;
        exitsByConn.get(exit.conn).push(exit);
    }
    for (const c of 'NWCF') {
        const original = exitsByConn.get(c);
        const shuffled = random.shuffle([...original]).map(e => e.reverse);
        for (let i = 0; i < shuffled.length; i++) {
            const exit1 = original[i];
            const exit2 = shuffled[i];
            [exit1.reverse, exit2.reverse] = [exit2, exit1];
        }
    }
    let iterations = 0;
    let [count, traversal, pool] = traverse();
    while (iterations-- > 0 || count > 1) {
        const exit1 = random.pick(pool);
        let eligible = exitsByConn.get(exit1.conn);
        if (count > 1) {
            const avoid = traversal.get(exit1);
            eligible = eligible.filter(e => traversal.get(e) !== avoid);
        }
        const exit2 = random.pick(eligible);
        const rev1 = exit1.reverse;
        const rev2 = exit2.reverse;
        exit1.reverse = rev2;
        rev2.reverse = exit1;
        exit2.reverse = rev1;
        rev1.reverse = exit2;
        [count, traversal, pool] = traverse();
        if (iterations < -10)
            debugger;
    }
    for (const exit of exits.values()) {
        if (exit.reverse !== exit.origRev) {
            function showExit(e) { return `${e.loc.name} ${e.type}(${e.pos.toString(16)})`; }
            console.log(`${showExit(exit)}  =>  ${showExit(exit.reverse)}  (was ${showExit(exit.origRev)})`);
        }
        exit.loc.meta.attach(exit.pos, exit.reverse.loc.meta, exit.reverse.pos, exit.type, exit.reverse.type);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZWFyZWFzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3Mvc2h1ZmZsZWFyZWFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVdBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUc5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQTRCNUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQWlDO0lBQ3RELENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQztJQUNqQixDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUM7SUFDakIsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDO0lBQ2xCLENBQUMsWUFBWSxFQUFFLEdBQUcsQ0FBQztJQUNuQixDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUM7SUFDYixDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUM7SUFDYixDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUM7SUFDZCxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUM7SUFDZCxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUM7Q0FDbEIsQ0FBQyxDQUFDO0FBTUgsTUFBTSxXQUFXLEdBQUcsSUFBSSxHQUFHLENBQWlDO0lBQzFELENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUNWLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztDQUNYLENBQUMsQ0FBQztBQUVILFNBQVMsUUFBUSxDQUFDLEdBQWEs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Q0FBQyxNQUFNLEVBQUUsRUFBRTtRQUNqQyxJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNqQyxTQUFTLFFBQVEsQ0FBQyxDQUFPLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDdkYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2xHO1FBRUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUNqRCxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDcEQ7QUFJSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU2h1ZmZsZSBhcmVhcy5cbi8vIFRoaXMgaXMgZG9uZSBfYWZ0ZXJfIHNodWZmbGluZyBob3VzZXMuICBUaGVyZSdzIGEgZmV3IHBvc3NpYmxlXG4vLyBhcHByb2FjaGVzIHRvIHRoaXMuICBIZXJlIHdlIHNpbXBseSBlbnVtZXJhdGUgdGhlIGFyZWFzIChub3Rcbi8vIHVzaW5nIHRoZSBkYXRhIGluIHJvbS9sb2NhdGlvbiwgc2luY2Ugd2UgYWN0dWFsbHkgd2FudCB0byBiYXNlXG4vLyB0aGluZ3Mgb24gdGhlIGV4aXRzIHJhdGhlciB0aGFuIHRoZSBsb2NhdGlvbnMpIGFuZCBkbyBzd2FwcyBvblxuLy8gcGFpcnMgb2YgZXhpdHMsIG1haW50YWluaW5nIGEgZ3JhcGggb2YgYXJlYXMuICBCeSBkZWZpbmluZyB0aGVcbi8vIGFyZWFzIGNvYXJzZXIgb3IgZmluZXIsIHdlIGNhbiBjb250cm9sIHRoZSBjcmF6aW5lc3MuXG5cbmltcG9ydCB7IFJhbmRvbSB9IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQgeyBSb20gfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHsgRXhpdFNwZWMsIFBvcyB9IGZyb20gJy4uL3JvbS9tZXRhbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHsgQ29ubmVjdGlvblR5cGUgfSBmcm9tICcuLi9yb20vbWV0YXNjcmVlbmRhdGEuanMnO1xuaW1wb3J0IHsgRmxhZ1NldCB9IGZyb20gJy4uL2ZsYWdzZXQuanMnO1xuaW1wb3J0IHsgRGVmYXVsdE1hcCB9IGZyb20gJy4uL3V0aWwuanMnO1xuaW1wb3J0IHsgVW5pb25GaW5kIH0gZnJvbSAnLi4vdW5pb25maW5kLmpzJztcblxuaW50ZXJmYWNlIEFyZWEge1xuICBuYW1lOiBzdHJpbmc7XG4gIGV4aXRzOiBNYXA8c3RyaW5nLCBBcmVhRXhpdD47XG4gIC8vZXhwZWN0ZWRFeGl0czogbnVtYmVyO1xufVxuaW50ZXJmYWNlIEFyZWFFeGl0IHtcbiAgY29ubjogQXJlYUNvbm5lY3Rpb247XG4gIGRlc3Q6IEFyZWE7XG4gIGRlc3RLZXk6IHN0cmluZztcbiAgbG9jUG9zOiBudW1iZXI7XG4gIGV4aXRUeXBlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBFeGl0IHtcbiAgcmVhZG9ubHkgbG9jOiBMb2NhdGlvbjtcbiAgcmVhZG9ubHkgcG9zOiBQb3M7XG4gIHJlYWRvbmx5IHR5cGU6IENvbm5lY3Rpb25UeXBlO1xuICByZWFkb25seSBrZXk6IHN0cmluZztcbiAgY29ubjogQXJlYUNvbm5lY3Rpb258dW5kZWZpbmVkOyAvLyBjYW5ub3Qgc2h1ZmZsZSB3aXRob3V0XG4gIHJldmVyc2U6IEV4aXQ7XG4gIHNodWZmbGU6IGJvb2xlYW47XG4gIGFyZWE6IHN0cmluZztcbiAgb25lV2F5PzogYm9vbGVhbjsgLy8gY2FuJ3QgZ28gdGhpcyB3YXlcbiAgb3JpZ1JldjogRXhpdDtcbn1cblxuY29uc3QgY29ubk1hcCA9IG5ldyBNYXA8Q29ubmVjdGlvblR5cGUsIEFyZWFDb25uZWN0aW9uPihbXG4gIFsnc3RhaXI6dXAnLCAnQyddLFxuICBbJ2VkZ2U6dG9wJywgJ04nXSxcbiAgWydlZGdlOmxlZnQnLCAnVyddLFxuICBbJ2VkZ2U6cmlnaHQnLCAnRSddLFxuICBbJ2NhdmUnLCAnQyddLFxuICBbJ2Rvb3InLCAnQyddLFxuICBbJ2Rvb3IyJywgJ0MnXSxcbiAgWydkb29yMycsICdDJ10sXG4gIFsnZm9ydHJlc3MnLCAnRiddLFxuXSk7XG5cbnR5cGUgRXhpdERlc2NyaXB0b3IgPSByZWFkb25seSBbUG9zLCBDb25uZWN0aW9uVHlwZSwgRXhpdFNwZWNdO1xudHlwZSBFeGl0RmluZGVyID0gTG9jYXRpb258UG9zfENvbm5lY3Rpb25UeXBlfHJlYWRvbmx5IEV4aXRGaW5kZXJbXTtcbnR5cGUgQXJlYUNvbm5lY3Rpb24gPSAnTid8J1MnfCdXJ3wnRSd8J0MnfCdYJ3wnRid8J08nO1xuLy90eXBlIEFyZWFFeGl0U3BlYyA9IHJlYWRvbmx5IFtBcmVhQ29ubmVjdGlvbiwgRXhpdEZpbmRlciwgQXJlYSwgYm9vbGVhbj9dO1xuY29uc3QgY29ubkludmVyc2UgPSBuZXcgTWFwPEFyZWFDb25uZWN0aW9uLCBBcmVhQ29ubmVjdGlvbj4oW1xuICBbJ04nLCAnUyddLFxuICBbJ1MnLCAnTiddLFxuICBbJ0UnLCAnVyddLFxuICBbJ1cnLCAnRSddLFxuICBbJ0MnLCAnWCddLFxuICBbJ1gnLCAnQyddLFxuICBbJ0YnLCAnTyddLFxuICBbJ08nLCAnRiddLFxuXSk7XG5cbmZ1bmN0aW9uIG1ha2VFeGl0KGxvYzogTG9jYXRpb24sIFtwb3MsIHR5cGUsIFtyZXZMb2NQb3MsIHJldlR5cGVdXTogRXhpdERlc2NyaXB0b3IpOiBFeGl0IHtcbiAgbGV0IGNvbm4gPSBjb25uTWFwLmdldCh0eXBlKSB8fCBjb25uSW52ZXJzZS5nZXQoY29ubk1hcC5nZXQocmV2VHlwZSkhKTtcbiAgbGV0IHNodWZmbGUgPSBmYWxzZTtcbiAgY29uc3QgYXJlYSA9IGxvYy5pZC50b1N0cmluZygxNik7XG4gIGNvbnN0IGtleSA9IChsb2MuaWQgPDwgOCB8IHBvcykudG9TdHJpbmcoMTYpICsgJyAnICsgdHlwZTtcbiAgY29uc3QgcmV2TG9jID0gbG9jLnJvbS5sb2NhdGlvbnNbcmV2TG9jUG9zID4+PiA4XTtcbiAgY29uc3QgcmV2UG9zID0gcmV2TG9jUG9zICYgMHhmZjtcbiAgY29uc3QgcmV2S2V5ID0gcmV2TG9jUG9zLnRvU3RyaW5nKDE2KSArICcgJyArIHJldlR5cGU7XG4gIGNvbnN0IHJldkFyZWEgPSByZXZMb2MuaWQudG9TdHJpbmcoMTYpO1xuICBjb25zdCByZXZlcnNlOiBFeGl0ID0ge1xuICAgIGxvYzogcmV2TG9jLCBwb3M6IHJldlBvcywgdHlwZTogcmV2VHlwZSxcbiAgICBhcmVhOiByZXZBcmVhLCBrZXk6IHJldktleSwgcmV2ZXJzZTogbnVsbCEsIG9yaWdSZXY6IG51bGwhLFxuICAgIGdldCBjb25uKCkgeyByZXR1cm4gY29ubkludmVyc2UuZ2V0KGNvbm4hKTsgfSxcbiAgICBzZXQgY29ubihjKSB7IGNvbm4gPSBjb25uSW52ZXJzZS5nZXQoYyEpOyB9LFxuICAgIGdldCBzaHVmZmxlKCkgeyByZXR1cm4gc2h1ZmZsZTsgfSxcbiAgICBzZXQgc2h1ZmZsZShzKSB7XG4gICAgICBpZiAocyAmJiAhY29ubikgdGhyb3cgbmV3IEVycm9yKGBzaHVmZmxlIHdpdGhvdXQgY29ubmApO1xuICAgICAgc2h1ZmZsZSA9IHM7XG4gICAgfSxcbiAgfTtcbiAgY29uc3QgZXhpdDogRXhpdCA9IHtcbiAgICBsb2MsIHBvcywgdHlwZSwga2V5LCByZXZlcnNlLCBhcmVhLCBvcmlnUmV2OiByZXZlcnNlLFxuICAgIGdldCBjb25uKCkgeyByZXR1cm4gY29ubjsgfSxcbiAgICBzZXQgY29ubihjKSB7IGNvbm4gPSBjOyB9LFxuICAgIGdldCBzaHVmZmxlKCkgeyByZXR1cm4gc2h1ZmZsZTsgfSxcbiAgICBzZXQgc2h1ZmZsZShzKSB7XG4gICAgICBpZiAocyAmJiAhY29ubikgdGhyb3cgbmV3IEVycm9yKGBzaHVmZmxlIHdpdGhvdXQgY29ubmApO1xuICAgICAgc2h1ZmZsZSA9IHM7XG4gICAgfSxcbiAgfTtcbiAgcmV2ZXJzZS5yZXZlcnNlID0gcmV2ZXJzZS5vcmlnUmV2ID0gZXhpdDtcbiAgcmV0dXJuIGV4aXQ7XG59XG5cbmZ1bmN0aW9uIG1hdGNoRXhpdChleGl0OiBFeGl0LCBmaW5kZXI6IEV4aXRGaW5kZXIpOiBib29sZWFuIHtcbiAgaWYgKHR5cGVvZiBmaW5kZXIgPT09ICdzdHJpbmcnKSByZXR1cm4gZXhpdC50eXBlID09PSBmaW5kZXI7XG4gIGlmICh0eXBlb2YgZmluZGVyID09PSAnbnVtYmVyJykgcmV0dXJuIGV4aXQucG9zID09PSBmaW5kZXI7XG4gIGlmIChmaW5kZXIgaW5zdGFuY2VvZiBMb2NhdGlvbikgcmV0dXJuIGV4aXQucmV2ZXJzZS5sb2MgPT09IGZpbmRlcjtcbiAgcmV0dXJuIGZpbmRlci5ldmVyeShmID0+IG1hdGNoRXhpdChleGl0LCBmKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzaHVmZmxlQXJlYXMocm9tOiBSb20sIGZsYWdzOiBGbGFnU2V0LCByYW5kb206IFJhbmRvbSkge1xuICBpZiAoIWZsYWdzLnNodWZmbGVBcmVhcygpKSByZXR1cm47XG4gIGNvbnN0IHtsb2NhdGlvbnM6IGxvY30gPSByb207XG5cbiAgLy8gQ2F0YWxvZ3VlIGFsbCB0aGUgZXhpdHMgaW4gdGhlIGdhbWVcbiAgY29uc3QgZXhpdHMgPSBuZXcgTWFwPHN0cmluZywgRXhpdD4oKTtcbiAgY29uc3QgZXhpdHNCeUxvY2F0aW9uID0gbmV3IERlZmF1bHRNYXA8TG9jYXRpb24sIEV4aXRbXT4oKCkgPT4gW10pO1xuICBmb3IgKGNvbnN0IGxvY2F0aW9uIG9mIHJvbS5sb2NhdGlvbnMpIHtcbiAgICBmb3IgKGNvbnN0IGV4aXRTcGVjIG9mIGxvY2F0aW9uLm1ldGEuZXhpdHMoKSkge1xuICAgICAgLy8gTk9URTogQ29yZGVsIGFuZCBUb3dlciBib3RoIGJyZWFrIHRoZSAxOjEgbWFwcGluZyBiZXR3ZWVuIGV4aXRzLlxuICAgICAgLy8gRm9yIENvcmRlbCwgdXNlIHRoZSBYLWNvb3JkaW5hdGUgdG8gb25seSBwaWNrIHRoZSBcInJlYWxcIiBleGl0LlxuICAgICAgLy8gU2tpcCBUb3dlciBlbnRpcmVseSwgc2luY2Ugd2UgZG9uJ3Qgc2h1ZmZsZSBpdC5cbiAgICAgIGlmIChsb2NhdGlvbiA9PT0gbG9jLkNvcmRlbFBsYWluRWFzdCAmJiAoZXhpdFNwZWNbMF0gJiAweDBmKSA8IDUpIGNvbnRpbnVlO1xuICAgICAgaWYgKGxvY2F0aW9uID09PSBsb2MuQ29yZGVsUGxhaW5XZXN0ICYmIChleGl0U3BlY1swXSAmIDB4MGYpID4gNCkgY29udGludWU7XG4gICAgICBpZiAobG9jYXRpb24uaXNUb3dlcigpKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IGV4aXQgPSBtYWtlRXhpdChsb2NhdGlvbiwgZXhpdFNwZWMpO1xuICAgICAgLy8gU2tpcCB0aGUgRm9ydHVuZSBUZWxsZXIgZW50aXJlbHkgc2luY2UgaXQgY29uZnVzZXMgdGhlIGxvZ2ljOlxuICAgICAgLy8gc2hlIGRvZXNuJ3QgYWN0dWFsbHkgY29ubmVjdCB0aGUgdW5kZXJncm91bmQgY2F2ZSB0byBwb3J0b2EsXG4gICAgICAvLyBhbmQgaXQncyBpcnJlbGV2YW50IGFueXdheSBzaW5jZSBpdCdzIG5vdCByZXF1aXJlZCB0byBnbyB0aGVyZS5cbiAgICAgIGlmIChleGl0LmxvYyA9PT0gbG9jLlBvcnRvYV9Gb3J0dW5lVGVsbGVyKSBjb250aW51ZTtcbiAgICAgIGlmIChleGl0LnJldmVyc2UubG9jID09PSBsb2MuUG9ydG9hX0ZvcnR1bmVUZWxsZXIpIGNvbnRpbnVlO1xuICAgICAgaWYgKGV4aXRzLmhhcyhleGl0LmtleSkpIGNvbnRpbnVlO1xuICAgICAgaWYgKGV4aXRzLmhhcyhleGl0LnJldmVyc2Uua2V5KSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEluY29uc2lzdGVudCBleGl0czogJHtleGl0LmtleX0gfCAke2V4aXQucmV2ZXJzZS5rZXl9YCk7XG4gICAgICB9XG4gICAgICBleGl0cy5zZXQoZXhpdC5rZXksIGV4aXQpO1xuICAgICAgZXhpdHMuc2V0KGV4aXQucmV2ZXJzZS5rZXksIGV4aXQucmV2ZXJzZSk7XG4gICAgICBleGl0c0J5TG9jYXRpb24uZ2V0KGV4aXQubG9jKS5wdXNoKGV4aXQpO1xuICAgICAgZXhpdHNCeUxvY2F0aW9uLmdldChleGl0LnJldmVyc2UubG9jKS5wdXNoKGV4aXQucmV2ZXJzZSk7XG4gICAgfVxuICB9XG5cbiAgLy8gTWFrZSBzZXBhcmF0ZSBhcmVhcyBmb3Igd2luZG1pbGwgYW5kIGxpZ2h0aG91c2VcbiAgZnVuY3Rpb24gZmluZEV4aXRzKGxvY2F0aW9uOiBMb2NhdGlvbiwgLi4uZmluZGVyczogRXhpdEZpbmRlcltdKTogRXhpdFtdIHtcbiAgICBjb25zdCBvdXQgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGV4aXQgb2YgZXhpdHNCeUxvY2F0aW9uLmdldChsb2NhdGlvbikpIHtcbiAgICAgIGZvciAoY29uc3QgZmluZGVyIG9mIGZpbmRlcnMpIHtcbiAgICAgICAgaWYgKG1hdGNoRXhpdChleGl0LCBmaW5kZXIpKSB7XG4gICAgICAgICAgb3V0LnB1c2goZXhpdCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuICBpZiAoZmxhZ3Muc2h1ZmZsZUhvdXNlcygpKSB7XG4gICAgZm9yIChjb25zdCBleGl0IG9mIGZpbmRFeGl0cyhsb2MuVmFsbGV5T2ZXaW5kLCAnZG9vcicsICd3aW5kbWlsbCcpKSB7XG4gICAgICBleGl0LmFyZWEgPSAnd2luZG1pbGwnO1xuICAgIH1cbiAgfVxuICBmb3IgKGNvbnN0IGV4aXQgb2YgZmluZEV4aXRzKGxvYy5BbmdyeVNlYSwgMHg2NCkpIHtcbiAgICBleGl0LmFyZWEgPSAnbGlnaHRob3VzZSc7XG4gIH1cbiAgZmluZEV4aXRzKGxvYy5Qb3J0b2FfRmlzaGVybWFuSXNsYW5kLCBsb2MuUG9ydG9hKVswXS5vbmVXYXkgPSB0cnVlO1xuICBcbiAgLy8gTWFyayB0aGUgZXhpdHMgdGhhdCBhcmUgZWxpZ2libGUgdG8gYmUgc2h1ZmZsZWQuXG4gIGZ1bmN0aW9uIG1hcmsobG9jOiBMb2NhdGlvbiwgLi4uZXhpdHM6IEV4aXRGaW5kZXJbXSk6IHZvaWQge1xuICAgIGZvciAoY29uc3QgZXhpdCBvZiBmaW5kRXhpdHMobG9jLCAuLi5leGl0cykpIHtcbiAgICAgIGV4aXQuc2h1ZmZsZSA9IHRydWU7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIG1hcmtPdXRzaWRlKC4uLmxvY3M6IExvY2F0aW9uW10pOiB2b2lkIHtcbiAgICBjb25zdCBzZXQgPSBuZXcgU2V0KGxvY3MpO1xuICAgIGZvciAoY29uc3QgbG9jIG9mIGxvY3MpIHtcbiAgICAgIGZvciAoY29uc3QgZXhpdCBvZiBleGl0c0J5TG9jYXRpb24uZ2V0KGxvYykpIHtcbiAgICAgICAgaWYgKCFzZXQuaGFzKGV4aXQucmV2ZXJzZS5sb2MpKSBleGl0LnNodWZmbGUgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICAgIFxuICBtYXJrKGxvYy5MZWFmLCBsb2MuTGVhZl9PdXRzaWRlU3RhcnQpO1xuICBtYXJrT3V0c2lkZShsb2MuVmFsbGV5T2ZXaW5kLCBsb2MuV2luZG1pbGxDYXZlLCBsb2MuV2luZG1pbGwpO1xuICBpZiAoZmxhZ3Muc2h1ZmZsZUhvdXNlcygpKSBtYXJrT3V0c2lkZShsb2MuV2luZG1pbGxDYXZlKTtcbiAgbWFya091dHNpZGUobG9jLkVhc3RDYXZlMSwgbG9jLkVhc3RDYXZlMiwgbG9jLkVhc3RDYXZlMyk7XG4gIG1hcmtPdXRzaWRlKGxvYy5aZWJ1Q2F2ZSwgbG9jLk10U2FicmVXZXN0X0NhdmUxKTtcbiAgbWFya091dHNpZGUobG9jLkNvcmRlbFBsYWluV2VzdCwgbG9jLkNvcmRlbFBsYWluRWFzdCk7XG4gIG1hcmtPdXRzaWRlKGxvYy5XYXRlcmZhbGxWYWxsZXlOb3J0aCwgbG9jLldhdGVyZmFsbFZhbGxleVNvdXRoKTtcbiAgbWFya091dHNpZGUobG9jLktpcmlzYU1lYWRvdyk7XG4gIG1hcmtPdXRzaWRlKGxvYy5MaW1lVHJlZUxha2UpO1xuICBtYXJrKGxvYy5Qb3J0b2FfRmlzaGVybWFuSXNsYW5kLCBsb2MuUG9ydG9hKTtcbiAgbWFyayhsb2MuVW5kZXJncm91bmRDaGFubmVsLCBsb2MuUG9ydG9hUGFsYWNlX1Rocm9uZVJvb20pO1xuICBtYXJrKGxvYy5BbmdyeVNlYSwgbG9jLkpvZWwpO1xuICBtYXJrT3V0c2lkZShsb2MuSm9lbFNlY3JldFBhc3NhZ2UpOyAvLyA/Pz9cbiAgLy9maW5kRXhpdHMobG9jLkV2aWxTcGlyaXRJc2xhbmQxLCBsb2MuRXZpbFNwaXJpdElzbGFuZDIpWzBdLmNvbm4gPSAnQyc7XG4gIG1hcmsobG9jLkV2aWxTcGlyaXRJc2xhbmQxLCBsb2MuRXZpbFNwaXJpdElzbGFuZDIpO1xuICBtYXJrKGxvYy5ab21iaWVUb3duLCBsb2MuRXZpbFNwaXJpdElzbGFuZDMpO1xuICBtYXJrKGxvYy5BbmdyeVNlYSwgbG9jLlN3YW4pO1xuICBtYXJrT3V0c2lkZShsb2MuU3dhbkdhdGUpO1xuICBtYXJrKGxvYy5Hb2FWYWxsZXksIGxvYy5NdEh5ZHJhKTtcbiAgbWFya091dHNpZGUobG9jLkRlc2VydDEpO1xuICBtYXJrT3V0c2lkZShsb2MuR29hRm9ydHJlc3NCYXNlbWVudCk7XG4gIG1hcmtPdXRzaWRlKGxvYy5EZXNlcnRDYXZlMSk7XG4gIG1hcmtPdXRzaWRlKGxvYy5TYWhhcmFPdXRzaWRlQ2F2ZSk7XG4gIG1hcmtPdXRzaWRlKGxvYy5EZXNlcnRDYXZlMik7XG4gIGlmICghZmxhZ3Muc2h1ZmZsZUhvdXNlcygpKSB7XG4gICAgLy8gQWxzbyBtYXJrIHRoZSBmb3J0cmVzc2VzL3BhbGFjZXNcbiAgICBjb25zdCBwYWxhY2VzOiBbTG9jYXRpb24sIExvY2F0aW9uXVtdID0gW1xuICAgICAgLy8gTm9ybWFsIHBhbGFjZXNcbiAgICAgIFtsb2MuWm9tYmllVG93biwgbG9jLlNhYmVyYVBhbGFjZTFdLFxuICAgICAgW2xvYy5NdEh5ZHJhLCBsb2MuU3R5eDFdLFxuICAgICAgW2xvYy5EZXNlcnQyLCBsb2MuUHlyYW1pZF9FbnRyYW5jZV0sXG4gICAgICBbbG9jLkdvYSwgbG9jLkdvYUZvcnRyZXNzX0VudHJhbmNlXSxcbiAgICAgIFtsb2MuUG9ydG9hLCBsb2MuUG9ydG9hX1BhbGFjZUVudHJhbmNlXSxcbiAgICAgIFtsb2MuU2h5cm9uLCBsb2MuU2h5cm9uX1RlbXBsZV0sXG4gICAgICAvLyBbbG9jLlVuZGVyZ3JvdW5kQ2hhbm5lbCwgbG9jLlBvcnRvYV9Bc2luYVJvb21dLCA/P1xuICAgICAgLy8gRXh0cmFzXG4gICAgICBbbG9jLkdvYVZhbGxleSwgbG9jLkdvYV0sXG4gICAgICBbbG9jLk9hc2lzQ2F2ZV9FbnRyYW5jZSwgbG9jLkdvYUZvcnRyZXNzX0V4aXRdLFxuICAgICAgW2xvYy5NdEh5ZHJhX091dHNpZGVTaHlyb24sIGxvYy5TaHlyb25dLFxuICAgIF07XG4gICAgZm9yIChjb25zdCBbb3V0c2lkZSwgaW5zaWRlXSBvZiBwYWxhY2VzKSB7XG4gICAgICBjb25zdCBbZXhpdF0gPSBmaW5kRXhpdHMob3V0c2lkZSwgaW5zaWRlKTtcbiAgICAgIGV4aXQuY29ubiA9ICdGJztcbiAgICAgIGV4aXQuc2h1ZmZsZSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgLy8gRElBR05PU1RJQzogY2hlY2sgdGhhdCBhbGwgdGhlIGV4aXRzIGFyZSBjb3JyZWN0XG4gIC8vIGNvbnN0IHNlZW4gPSBuZXcgU2V0KCk7XG4gIC8vIGZvciAoY29uc3QgZXhpdCBvZiBleGl0cy52YWx1ZXMoKSkge1xuICAvLyAgIGlmICghZXhpdC5zaHVmZmxlKSBjb250aW51ZTtcbiAgLy8gICBpZiAoc2Vlbi5oYXMoZXhpdCkpIGNvbnRpbnVlO1xuICAvLyAgIHNlZW4uYWRkKGV4aXQucmV2ZXJzZSk7XG4gIC8vICAgY29uc29sZS5sb2coYCgke2V4aXQuY29ubn0pICR7ZXhpdC5sb2MubmFtZX0gIDw9PT4gICR7ZXhpdC5yZXZlcnNlLmxvYy5uYW1lfSAoJHtleGl0LnJldmVyc2UuY29ubn0pYCk7XG4gIC8vIH1cblxuICAvLyBOZXh0IGZpbmQgYWxsIHRoZSBub24tc2h1ZmZsZWQgZXhpdHMgYW5kIFVuaW9uRmluZCB0aGVtIVxuICBjb25zdCB1ZiA9IG5ldyBVbmlvbkZpbmQ8c3RyaW5nPigpO1xuICBmb3IgKGNvbnN0IGV4aXQgb2YgZXhpdHMudmFsdWVzKCkpIHtcbiAgICBpZiAoZXhpdC5zaHVmZmxlKSBjb250aW51ZTtcbiAgICB1Zi51bmlvbihbZXhpdC5hcmVhLCBleGl0LnJldmVyc2UuYXJlYV0pO1xuICB9XG4gIC8vY29uc3QgYXJlYVRvTG9jYXRpb25NYXAgPSBuZXcgTWFwKCk7XG4gIGNvbnN0IGFyZWFFeGl0cyA9IG5ldyBEZWZhdWx0TWFwPHN0cmluZywgRXhpdFtdPigoKSA9PiBbXSk7XG4gIGZvciAoY29uc3QgZXhpdCBvZiBleGl0cy52YWx1ZXMoKSkge1xuICAgIC8vYXJlYVRvTG9jYXRpb25NYXAuc2V0KGV4aXQuYXJlYSwgZXhpdC5sb2MubmFtZSk7XG4gICAgaWYgKCFleGl0LnNodWZmbGUpIGNvbnRpbnVlO1xuICAgIGFyZWFFeGl0cy5nZXQoZXhpdC5hcmVhID0gdWYuZmluZChleGl0LmFyZWEpKS5wdXNoKGV4aXQpO1xuICB9XG5cbiAgLy8gRElBR05PU1RJQzogY2hlY2sgdGhhdCB0aGUgYXJlYXMgYXJlIGNvcnJlY3RcbiAgLy8gZm9yIChjb25zdCBzZXQgb2YgdWYuc2V0cygpKSB7XG4gIC8vICAgY29uc29sZS5sb2coYEFyZWE6ICR7Wy4uLnNldF0ubWFwKGwgPT4gYXJlYVRvTG9jYXRpb25NYXAuZ2V0KGwpKS5qb2luKCcsICcpfWApO1xuICAvLyB9XG5cbiAgLy8gUGFydGl0aW9ucyBhcmVhIGtleXMuICBSZXR1cm5zIHRoZSBudW1iZXIgb2YgcGFydGl0aW9ucyAoPjEgbWVhbnNcbiAgLy8gdGhlIG1hcCBpcyBkaXNjb25uZWN0aW9uKSwgYSBtYXAgZnJvbSBleGl0IHRvIHBhcnRpdGlvbiBudW1iZXIsIGFuZFxuICAvLyB0aGUgbGlzdCBvZiBleGl0cyBpbiB0aGUgc21hbGxlc3QgcGFydGl0aW9uLCB0byBiZSB1c2VkIGFzIGEgcG9vbFxuICAvLyBvZiBleGl0cyB0byBzd2FwIG5leHQgdG8gaGF2ZSB0aGUgYmVzdCBjaGFuY2UgdG8gcmVjb25uZWN0aW5nLlxuICBjb25zdCBzdGFydCA9IGV4aXRzQnlMb2NhdGlvbi5nZXQobG9jLk1lemFtZVNocmluZSlbMF0uYXJlYTtcbiAgZnVuY3Rpb24gdHJhdmVyc2UoKTogW251bWJlciwgTWFwPEV4aXQsIG51bWJlcj4sIEV4aXRbXV0ge1xuICAgIGNvbnN0IHNlZW4gPSBuZXcgU2V0KCk7XG4gICAgY29uc3QgbWFwID0gbmV3IE1hcDxFeGl0LCBudW1iZXI+KCk7XG4gICAgY29uc3QgcGFydGl0aW9uczogRXhpdFtdW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGFyZWEgb2YgW3N0YXJ0LCAuLi5hcmVhRXhpdHMua2V5cygpXSkge1xuICAgICAgaWYgKHNlZW4uaGFzKGFyZWEpKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IHF1ZXVlID0gbmV3IFNldChbYXJlYV0pO1xuICAgICAgY29uc3QgcGFydGl0aW9uOiBFeGl0W10gPSBbXTtcbiAgICAgIGZvciAoY29uc3QgbmV4dCBvZiBxdWV1ZSkge1xuICAgICAgICBzZWVuLmFkZChuZXh0KTtcbiAgICAgICAgZm9yIChjb25zdCBleGl0IG9mIGFyZWFFeGl0cy5nZXQobmV4dCkpIHtcbiAgICAgICAgICBtYXAuc2V0KGV4aXQsIHBhcnRpdGlvbnMubGVuZ3RoKTtcbiAgICAgICAgICBwYXJ0aXRpb24ucHVzaChleGl0KTtcbiAgICAgICAgICBpZiAoZXhpdC5vbmVXYXkgfHwgc2Vlbi5oYXMoZXhpdC5yZXZlcnNlLmFyZWEpKSBjb250aW51ZTtcbiAgICAgICAgICBxdWV1ZS5hZGQoZXhpdC5yZXZlcnNlLmFyZWEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBwYXJ0aXRpb25zLnB1c2gocGFydGl0aW9uKTtcbiAgICB9XG4gICAgbGV0IG1pbiA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCBwYXJ0aXRpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAocGFydGl0aW9uc1tpXS5sZW5ndGggPCBwYXJ0aXRpb25zW21pbl0ubGVuZ3RoKSBtaW4gPSBpO1xuICAgIH1cbiAgICByZXR1cm4gW3BhcnRpdGlvbnMubGVuZ3RoLCBtYXAsIHBhcnRpdGlvbnNbbWluXV07XG4gIH1cblxuICBjb25zdCBleGl0c0J5Q29ubiA9IG5ldyBEZWZhdWx0TWFwPEFyZWFDb25uZWN0aW9uLCBFeGl0W10+KCgpID0+IFtdKTtcbiAgZm9yIChjb25zdCBleGl0IG9mIGV4aXRzLnZhbHVlcygpKSB7XG4gICAgaWYgKCFleGl0LnNodWZmbGUgfHwgIWV4aXQuY29ubikgY29udGludWU7XG4gICAgZXhpdHNCeUNvbm4uZ2V0KGV4aXQuY29ubikucHVzaChleGl0KTtcbiAgfVxuXG4gIGZvciAoY29uc3QgYyBvZiAoJ05XQ0YnIGFzIEl0ZXJhYmxlPEFyZWFDb25uZWN0aW9uPikpIHtcbiAgICBjb25zdCBvcmlnaW5hbCA9IGV4aXRzQnlDb25uLmdldChjKSE7XG4gICAgY29uc3Qgc2h1ZmZsZWQgPSByYW5kb20uc2h1ZmZsZShbLi4ub3JpZ2luYWxdKS5tYXAoZSA9PiBlLnJldmVyc2UpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2h1ZmZsZWQubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGV4aXQxID0gb3JpZ2luYWxbaV07XG4gICAgICBjb25zdCBleGl0MiA9IHNodWZmbGVkW2ldO1xuICAgICAgW2V4aXQxLnJldmVyc2UsIGV4aXQyLnJldmVyc2VdID0gW2V4aXQyLCBleGl0MV07XG4gICAgfVxuICB9XG5cbiAgLy8gUmVjb25uZWN0IGFueSBkaXNjb25uZWN0ZWQgcGllY2VzXG4gIGxldCBpdGVyYXRpb25zID0gMDtcbiAgbGV0IFtjb3VudCwgdHJhdmVyc2FsLCBwb29sXSA9IHRyYXZlcnNlKCk7XG4gIHdoaWxlIChpdGVyYXRpb25zLS0gPiAwIHx8IGNvdW50ID4gMSkgeyAvLyBjb3VsZCBzd2l0Y2ggb3JkZXI/XG4gICAgY29uc3QgZXhpdDEgPSByYW5kb20ucGljayhwb29sKTtcbiAgICBsZXQgZWxpZ2libGUgPSBleGl0c0J5Q29ubi5nZXQoZXhpdDEuY29ubiEpO1xuICAgIGlmIChjb3VudCA+IDEpIHtcbiAgICAgIGNvbnN0IGF2b2lkID0gdHJhdmVyc2FsLmdldChleGl0MSk7XG4gICAgICBlbGlnaWJsZSA9IGVsaWdpYmxlLmZpbHRlcihlID0+IHRyYXZlcnNhbC5nZXQoZSkgIT09IGF2b2lkKTtcbiAgICB9XG4gICAgY29uc3QgZXhpdDIgPSByYW5kb20ucGljayhlbGlnaWJsZSk7XG4gICAgY29uc3QgcmV2MSA9IGV4aXQxLnJldmVyc2U7XG4gICAgY29uc3QgcmV2MiA9IGV4aXQyLnJldmVyc2U7XG4gICAgZXhpdDEucmV2ZXJzZSA9IHJldjI7XG4gICAgcmV2Mi5yZXZlcnNlID0gZXhpdDE7XG4gICAgZXhpdDIucmV2ZXJzZSA9IHJldjE7XG4gICAgcmV2MS5yZXZlcnNlID0gZXhpdDI7XG4gICAgW2NvdW50LCB0cmF2ZXJzYWwsIHBvb2xdID0gdHJhdmVyc2UoKTtcbiAgICBpZiAoaXRlcmF0aW9ucyA8IC0xMCkgZGVidWdnZXI7XG4gIH1cblxuICBmb3IgKGNvbnN0IGV4aXQgb2YgZXhpdHMudmFsdWVzKCkpIHtcbiAgICBpZiAoZXhpdC5yZXZlcnNlICE9PSBleGl0Lm9yaWdSZXYpIHtcbiAgICAgIGZ1bmN0aW9uIHNob3dFeGl0KGU6IEV4aXQpIHsgcmV0dXJuIGAke2UubG9jLm5hbWV9ICR7ZS50eXBlfSgke2UucG9zLnRvU3RyaW5nKDE2KX0pYDsgfVxuICAgICAgY29uc29sZS5sb2coYCR7c2hvd0V4aXQoZXhpdCl9ICA9PiAgJHtzaG93RXhpdChleGl0LnJldmVyc2UpfSAgKHdhcyAke3Nob3dFeGl0KGV4aXQub3JpZ1Jldil9KWApO1xuICAgIH1cblxuICAgIGV4aXQubG9jLm1ldGEuYXR0YWNoKGV4aXQucG9zLCBleGl0LnJldmVyc2UubG9jLm1ldGEsIGV4aXQucmV2ZXJzZS5wb3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgZXhpdC50eXBlLCBleGl0LnJldmVyc2UudHlwZSk7XG4gIH1cblxuICAvL2NvbnNvbGUubG9nKHRyYXZlcnNlKCkpO1xuICAvL2RlYnVnZ2VyO1xufVxuXG4vLyBmdW5jdGlvbiBtYXRjaEV4aXQoZmluZGVyOiBFeGl0RmluZGVyKTpcbi8vICAgICAgIChlOiByZWFkb25seSBbbnVtYmVyLCBDb25uZWN0aW9uVHlwZSwgRXhpdFNwZWNdKSA9PiBib29sZWFuIHtcbi8vICAgaWYgKHR5cGVvZiBmaW5kZXIgPT09ICdzdHJpbmcnKSByZXR1cm4gKFssIHRdKSA9PiB0ID09PSBmaW5kZXI7XG4vLyAgIGlmICh0eXBlb2YgZmluZGVyID09PSAnbnVtYmVyJykgcmV0dXJuIChbcF0pID0+IHAgPT09IGZpbmRlcjtcbi8vICAgaWYgKGZpbmRlciBpbnN0YW5jZW9mIExvY2F0aW9uKSByZXR1cm4gKFssLCBbbF1dKSA9PiAobCA+Pj4gOCkgPT09IGZpbmRlci5pZDtcbi8vICAgY29uc3QgbWF0Y2hlcnMgPSBmaW5kZXIubWFwKG1hdGNoRXhpdCk7XG4vLyAgIHJldHVybiAoZSkgPT4gbWF0Y2hlcnMuZXZlcnkoZiA9PiBmKGUpKTtcbi8vIH1cblxuLy8gZnVuY3Rpb24gZXhpdEtleShsb2NQb3M6IG51bWJlciwgZXhpdFR5cGU6IENvbm5lY3Rpb25UeXBlKSB7XG4vLyAgIHJldHVybiBsb2NQb3MudG9TdHJpbmcoMTYpICsgJyAnICsgZXhpdFR5cGU7XG4vLyB9XG5cbi8vIGZ1bmN0aW9uIGFkZEV4aXRzKGZyb21Mb2M6IExvY2F0aW9uLFxuLy8gICAgICAgICAgICAgICAgICAgLi4uZXhpdFNwZWNzOiBBcmVhRXhpdFNwZWNbXSk6IHZvaWQge1xuLy8gICBjb25zdCBleGl0cyA9IFsuLi5mcm9tTG9jLm1ldGEuZXhpdHMoKV07XG4vLyAgIGZvciAoY29uc3QgW2Nvbm5lY3Rpb24sIGZpbmRlciwgdG9BcmVhLCBvbmVXYXldIG9mIGV4aXRTcGVjcykge1xuLy8gICAgIGNvbnN0IFtleGl0LCAuLi5yZXN0XSA9IGV4aXRzLmZpbHRlcihtYXRjaEV4aXQoZmluZGVyKSk7XG4vLyAgICAgaWYgKCFleGl0KSB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgZXhpdDogJHtmaW5kZXJ9IGluICR7ZnJvbUxvY31gKTtcbi8vICAgICBpZiAocmVzdC5sZW5ndGgpIHRocm93IG5ldyBFcnJvcihgQW1iaWd1b3VzIGV4aXQ6ICR7ZmluZGVyfSBpbiAke2Zyb21Mb2N9YCk7XG4vLyAgICAgY29uc3QgZnJvbUxvY1BvcyA9IGZyb21Mb2MuaWQgPDwgOCB8IGV4aXRbMF07XG4vLyAgICAgY29uc3QgZnJvbVR5cGUgPSBleGl0WzFdO1xuLy8gICAgIGNvbnN0IGZyb21LZXkgPSBleGl0S2V5KGZyb21Mb2NQb3MsIGZyb21UeXBlKTtcbi8vICAgICBjb25zdCBbdG9Mb2NQb3MsIHRvVHlwZV0gPSBleGl0WzJdO1xuLy8gICAgIGNvbnN0IHRvS2V5ID0gZXhpdEtleSh0b0xvY1BvcywgdG9UeXBlKTtcbi8vICAgICBjb25zdCBmcm9tRXhpdCA9IHtcbi8vICAgICAgIGNvbm46IGNvbm5lY3Rpb24sXG4vLyAgICAgICBkZXN0OiB0b0FyZWEsXG4vLyAgICAgICBkZXN0S2V5OiB0b0tleSxcbi8vICAgICAgIGxvY1BvczogZnJvbUxvY1Bvcyxcbi8vICAgICAgIGV4aXRUeXBlOiBmcm9tVHlwZSxcbi8vICAgICB9O1xuLy8gICAgIGNvbnN0IHRvRXhpdCA9IHtcbi8vICAgICAgIGNvbm46IGNvbm5JbnZlcnNlLmdldChjb25uZWN0aW9uKSEsXG4vLyAgICAgICBkZXN0OiBmcm9tQXJlYSxcbi8vICAgICAgIGRlc3RLZXk6IGZyb21LZXksXG4vLyAgICAgICBsb2NQb3M6IHRvTG9jUG9zLFxuLy8gICAgICAgZXhpdFR5cGU6IHRvVHlwZSxcbi8vICAgICB9O1xuLy8gICAgIGZyb21BcmVhLmV4aXRzLnNldChmcm9tS2V5LCBmcm9tRXhpdCk7XG4vLyAgICAgaWYgKCFvbmVXYXkpIHRvQXJlYS5leGl0cy5zZXQodG9LZXksIHRvRXhpdCk7XG4vLyAgIH1cbi8vIH1cblxuLy8gZnVuY3Rpb24gYnVpbGRLZXkobG9jOiBMb2NhdGlvbnxudWxsLFxuLy8gICAgICAgICAgICAgICAgICAgW3BvcywgdHlwXTogcmVhZG9ubHkgW1BvcywgQ29ubmVjdGlvblR5cGUsIC4uLnVua25vd25bXV0pOiBzdHJpbmcge1xuLy8gICByZXR1cm4gKChsb2MgPyBsb2MuaWQgPDwgOCA6IDApIHwgcG9zKS50b1N0cmluZygxNikgKyAnICcgKyB0eXA7XG4vLyB9XG5cblxuLy8gY2xhc3MgRXhpdE1hcCB7XG4vLyAgIGV4aXRzID0gbmV3IE1hcDxzdHJpbmcsIEV4aXQ+KCk7XG5cbi8vICAgbG9jYXRpb25zID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbi8vICAgZXhpdHNCeUxvY2F0aW9uID0gbmV3IERlZmF1bHRNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKCkgPT4gbmV3IFNldCgpKTtcbi8vICAgb3Bwb3NpdGVzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcblxuLy8gICBzcGxpdExvY2F0aW9uKGxvYzogTG9jYXRpb24sIC4uLmZpbmRlcnM6IEV4aXRGaW5kZXJbXSkge1xuLy8gICAgIGNvbnN0IG1hdGNoZXJzID0gZmluZGVycy5tYXAobWF0Y2hFeGl0KTtcbi8vICAgICBsZXQga2V5OiBzdHJpbmd8dW5kZWZpbmVkO1xuLy8gICAgIGZvciAoY29uc3QgZXhpdCBvZiBsb2MubWV0YS5leGl0cygpKSB7XG4vLyAgICAgICBmb3IgKGNvbnN0IG1hdGNoZXIgb2YgbWF0Y2hlcnMpIHtcbi8vICAgICAgICAgaWYgKCFtYXRjaGVyKGV4aXQpKSBjb250aW51ZTtcbi8vICAgICAgICAgbGV0IGV4aXRLZXkgPSBidWlsZEtleShsb2MsIGV4aXQpO1xuLy8gICAgICAgICBpZiAoa2V5ID09IHVuZGVmaW5lZCkga2V5ID0gZXhpdEtleTtcbi8vICAgICAgICAgdGhpcy5sb2NhdGlvbnMuc2V0KGV4aXRLZXksIGtleSk7XG4vLyAgICAgICAgIGJyZWFrO1xuLy8gICAgICAgfVxuLy8gICAgIH1cbi8vICAgfVxuXG4vLyAgIGxvY2F0aW9uS2V5KGxvYzogTG9jYXRpb24sIGV4aXQ6IEV4aXREZXNjcmlwdG9yKTogc3RyaW5nIHtcbi8vICAgICBjb25zdCBrZXkgPSBidWlsZEtleShsb2MsIGV4aXQpO1xuLy8gICAgIGxldCB2YWx1ZSA9IHRoaXMubG9jYXRpb25zLmdldChrZXkpO1xuLy8gICAgIGlmICghdmFsdWUpIHRoaXMubG9jYXRpb25zLnNldChrZXksIHZhbHVlID0gbG9jLmlkLnRvU3RyaW5nKDE2KSk7XG5cbi8vICAgICAvLyBUT0RPIC0gdGhpcy5leGl0c0J5TG9jYXRpb25cblxuLy8gICAgIHJldHVybiB2YWx1ZTtcbi8vICAgfVxuXG4vLyAgIHByaXZhdGUgYWRkRXhpdEludGVybmFsKGZyb21LZXk6IHN0cmluZywgdG9LZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIFxuLy8gICB9XG5cbi8vICAgYWRkRXhpdChsb2M6IExvY2F0aW9uLCBjb25uOiBBcmVhQ29ubmVjdGlvbiwgZXhpdD86IEV4aXRGaW5kZXIpOiB2b2lkIHtcbiAgICBcbi8vICAgfVxuLy8gICBhZGRFeGl0cyhsb2M6IExvY2F0aW9uLCAuLi5leGl0czogRXhpdEZpbmRlcltdKTogdm9pZCB7XG5cbi8vICAgfVxuLy8gICBhZGRBbGxFeGl0cyhsb2M6IExvY2F0aW9uKTogdm9pZCB7XG4vLyAgICAgZm9yIChjb25zdCBleGl0IG9mIGxvYy5tZXRhLmV4aXRzKCkpIHtcbiAgICAgIFxuLy8gICAgICAgY29uc3QgZnJvbUtleSA9IGJ1aWxkS2V5KGxvYywgZXhpdCk7XG4vLyAgICAgICBjb25zdCB0b0tleSA9IGJ1aWxkS2V5KG51bGwsIGV4aXRbMl0pO1xuLy8gICAgICAgdGhpcy5hZGRFeGl0SW50ZXJuYWwoZnJvbUtleSwgdG9LZXkpO1xuLy8gICAgIH1cbi8vICAgfVxuICBcbi8vICAgLy8gYXJlYShsb2M6IExvY2F0aW9uLCBmaW5kZXI6IEV4aXRGaW5kZXIpOiBzdHJpbmcge1xuLy8gICAvLyAgIC8vIFxuLy8gICAvLyB9XG4vLyB9XG5cbi8vIGZ1bmN0aW9uIHVudXNlZCgpIHtcbi8vICAgYWRkRXhpdHMoYXJlYS5TdGFydCwgbG9jLkxlYWZfT3V0c2lkZVN0YXJ0LCBbJ1cnLCBsb2MuTGVhZiwgYXJlYS5MZWFmXSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuV2luZFZhbGxleSwgbG9jLlZhbGxleU9mV2luZCxcbi8vICAgICAgICAgICAgWydTJywgbG9jLkxlYWYsIGFyZWEuTGVhZl0sXG4vLyAgICAgICAgICAgIFsnQycsIGxvYy5aZWJ1Q2F2ZSwgYXJlYS5aZWJ1XSxcbi8vICAgICAgICAgICAgWydDJywgbG9jLlNlYWxlZENhdmUxLCBhcmVhLlNlYWxlZENhdmVdKTtcbi8vICAgaWYgKGZsYWdzLnNodWZmbGVIb3VzZXMoKSkge1xuLy8gICAgIGFkZEV4aXRzKGFyZWEuV2luZFZhbGxleSwgbG9jLlZhbGxleU9mV2luZCwgWydDJywgMHgwMiwgYXJlYS5XaW5kbWlsbENhdmVdKTtcbi8vICAgICBhZGRFeGl0cyhhcmVhLldpbmRtaWxsLCBsb2MuVmFsbGV5T2ZXaW5kLCBbJ0MnLCAnZG9vcicsIGFyZWEuV2luZG1pbGxDYXZlXSk7XG4vLyAgIH1cbi8vICAgaWYgKGZsYWdzLmFkZEVhc3RDYXZlKCkpIHtcbi8vICAgICBhZGRFeGl0cyhhcmVhLldpbmRWYWxsZXksIGxvYy5WYWxsZXlPZldpbmQsXG4vLyAgICAgICAgICAgICAgWydDJywgbG9jLkVhc3RDYXZlMSwgYXJlYS5FYXN0Q2F2ZV0pO1xuLy8gICAgIC8vIE5PVEU6IFdlIGNvdWxkIHBvc3NpYmx5IGFkZCBleGl0MSBhbmQgZXhpdDIsIGJ1dCBpdCdzXG4vLyAgICAgLy8gaGFyZCB0byBmaWd1cmUgb3V0IGlmICgxKSB0aGV5IGV2ZW4gZXhpc3QsIGFuZCAoMikgaWZcbi8vICAgICAvLyB0aGV5IGRvLCB3aGljaCBfYXJlYV8gdGhleSBnbyB0by4gIEZvciBub3csIHdlJ2xsIHRyZWF0XG4vLyAgICAgLy8gaXQgYXMgYSB0ZXJtaW5hbCwgc2luY2UgdGhlIG90aGVyIGV4aXRzIGFyZSBhbHJlYWR5XG4vLyAgICAgLy8gc29tZXdoYXQgcmFuZG9taXplZC5cbi8vICAgfVxuLy8gICBhZGRFeGl0cyhhcmVhLkNvcmRlbFBsYWluLCBsb2MuQ29yZGVsUGxhaW5XZXN0LFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuU2VhbGVkQ2F2ZTgsIGFyZWEuU2VhbGVkQ2F2ZV0sXG4vLyAgICAgICAgICAgIFsnVycsIGxvYy5CcnlubWFlciwgYXJlYS5CcnlubWFlcl0sXG4vLyAgICAgICAgICAgIFsnVycsIGxvYy5NdFNhYnJlV2VzdF9Mb3dlciwgYXJlYS5TYWJyZVdlc3RdLFxuLy8gICAgICAgICAgICBbJ04nLCBsb2MuT3V0c2lkZVN0b21Ib3VzZSwgYXJlYS5TdG9tSG91c2VdLFxuLy8gICAgICAgICAgICBbJ1MnLCBsb2MuQW1hem9uZXMsIGFyZWEuQW1hem9uZXNdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5Db3JkZWxQbGFpbiwgbG9jLkNvcmRlbFBsYWluRWFzdCxcbi8vICAgICAgICAgICAgWydFJywgbG9jLlN3YW1wLCBhcmVhLlN3YW1wXSxcbi8vICAgICAgICAgICAgWydOJywgbG9jLk10U2FicmVOb3J0aF9NYWluLCBhcmVhLlNhYnJlTm9ydGhdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5XYXRlcmZhbGxWYWxsZXksIGxvYy5XYXRlcmZhbGxWYWxsZXlOb3J0aCxcbi8vICAgICAgICAgICAgWydDJywgbG9jLk10U2FicmVOb3J0aF9TdW1taXRDYXZlLCBhcmVhLlNhYnJlTm9ydGhdLFxuLy8gICAgICAgICAgICBbJ1cnLCBsb2MuUG9ydG9hLCBhcmVhLlBvcnRvYV0sXG4vLyAgICAgICAgICAgIFsnQycsIGxvYy5XYXRlcmZhbGxDYXZlMSwgYXJlYS5XYXRlcmZhbGxDYXZlXSxcbi8vICAgICAgICAgICAgWydDJywgbG9jLkZvZ0xhbXBDYXZlMSwgYXJlYS5Gb2dMYW1wQ2F2ZV0pO1xuLy8gICBhZGRFeGl0cyhhcmVhLldhdGVyZmFsbFZhbGxleSwgbG9jLldhdGVyZmFsbFZhbGxleVNvdXRoLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuS2lyaXNhUGxhbnRDYXZlMSwgYXJlYS5LaXJpc2FDYXZlXSxcbi8vICAgICAgICAgICAgWydXJywgbG9jLkxpbWVUcmVlVmFsbGV5LCBhcmVhLkxpbWVUcmVlVmFsbGV5XSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuS2lyaXNhQ2F2ZSwgbG9jLktpcmlzYVBsYW50Q2F2ZTMsXG4vLyAgICAgICAgICAgIFsnWCcsIGxvYy5LaXJpc2FNZWFkb3csIGFyZWEuS2lyaXNhTWVhZG93XSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuTGltZVRyZWVMYWtlLCBsb2MuTGltZVRyZWVMYWtlLFxuLy8gICAgICAgICAgICBbJ1gnLCBsb2MuTGltZVRyZWVWYWxsZXksIGFyZWEuTGltZVRyZWVWYWxsZXldLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuTWVzaWFTaHJpbmUsIGFyZWEuTWVzaWFTaHJpbmVdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5BbmdyeVNlYSwgbG9jLlBvcnRvYV9GaXNoZXJtYW5Jc2xhbmQsXG4vLyAgICAgICAgICAgIC8vIFRPRE8gLSBob3cgdG8gbWFrZSB0aGlzIG9uZS13YXk/XG4vLyAgICAgICAgICAgIFsnRScsIGxvYy5Qb3J0b2EsIGFyZWEuUG9ydG9hLCB0cnVlXSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuQW5ncnlTZWEsIGxvYy5FdmlsU3Bpcml0SXNsYW5kMSxcbi8vICAgICAgICAgICAgWydDJywgbG9jLkV2aWxTcGlyaXRJc2xhbmQyLCBhcmVhLkV2aWxTcGlyaXRJc2xhbmRdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5BbmdyeVNlYSwgbG9jLkFuZ3J5U2VhLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuSm9lbCwgYXJlYS5Kb2VsXSxcbi8vICAgICAgICAgICAgWydOJywgbG9jLlN3YW4sIGFyZWEuU3dhbl0pO1xuLy8gICBpZiAoIWZsYWdzLnNodWZmbGVIb3VzZXMoKSkge1xuLy8gICAgIC8vIFRPRE8gLSB3cm9uZyBhcmVhIGlmIHdlIGhhdmUgaG91c2Ugc2h1ZmZsZS4uLj8gaG93IHRvIGZpeD9cbi8vICAgICBhZGRFeGl0cyhhcmVhLkpvZWxQYXNzYWdlLCBsb2MuSm9lbFNlY3JldFBhc3NhZ2UsXG4vLyAgICAgICAgICAgICAgWydYJywgbG9jLkpvZWxfU2hlZCwgYXJlYS5Kb2VsXSxcbi8vICAgICAgICAgICAgICBbJ1gnLCBsb2MuQW5ncnlTZWEsIGFyZWEuTGlnaHRob3VzZV0pO1xuLy8gICB9XG4vLyAgIGFkZEV4aXRzKGFyZWEuWm9tYmllVG93biwgbG9jLlpvbWJpZVRvd24sXG4vLyAgICAgICAgICAgIFsnQycsICdjYXZlJywgYXJlYS5FdmlsU3Bpcml0SXNsYW5kXSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuU3dhbiwgbG9jLlN3YW4sIFsnVycsIGxvYy5Td2FuR2F0ZSwgYXJlYS5Td2FuR2F0ZV0pO1xuLy8gICBhZGRFeGl0cyhhcmVhLkdvYVZhbGxleSwgbG9jLkdvYVZhbGxleSxcbi8vICAgICAgICAgICAgWydFJywgbG9jLlN3YW5HYXRlLCBhcmVhLlN3YW5HYXRlXSxcbi8vICAgICAgICAgICAgWydXJywgbG9jLk10SHlkcmEsIGFyZWEuSHlkcmFdLFxuLy8gICAgICAgICAgICBbJ1MnLCBsb2MuRGVzZXJ0MSwgYXJlYS5EZXNlcnQxXSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuRGVzZXJ0MSwgbG9jLkRlc2VydDEsXG4vLyAgICAgICAgICAgIFsnQycsIGxvYy5PYXNpc0NhdmVfRW50cmFuY2UsIGFyZWEuT2FzaXNDYXZlXSxcbi8vICAgICAgICAgICAgWydDJywgbG9jLkRlc2VydENhdmUxLCBhcmVhLkRlc2VydENhdmUxXSk7XG4vLyAgIGFkZEV4aXRzKGFyZWEuT2FzaXNDYXZlLCBsb2MuT2FzaXNDYXZlTWFpbixcbi8vICAgICAgICAgICAgWydDJywgbG9jLkdvYUZvcnRyZXNzQmFzZW1lbnQsIGFyZWEuR29hQmFzZW1lbnRdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5EZXNlcnRDYXZlMSwgbG9jLkRlc2VydENhdmUxLFxuLy8gICAgICAgICAgICBbJ1gnLCBsb2MuU2FoYXJhTWVhZG93LCBhcmVhLlNhaGFyYV0pO1xuLy8gICBhZGRFeGl0cyhhcmVhLlNhaGFyYUV4aXQsIGxvYy5TYWhhcmFPdXRzaWRlQ2F2ZSxcbi8vICAgICAgICAgICAgWydXJywgbG9jLlNhaGFyYSwgYXJlYS5TYWhhcmFdLFxuLy8gICAgICAgICAgICBbJ0MnLCBsb2MuRGVzZXJ0Q2F2ZTIsIGFyZWEuRGVzZXJ0Q2F2ZTJdKTtcbi8vICAgYWRkRXhpdHMoYXJlYS5FbmQsIGxvYy5EZXNlcnQyLCBbJ0MnLCBsb2MuRGVzZXJ0Q2F2ZTIsIGFyZWEuRGVzZXJ0Q2F2ZTJdKTtcblxuLy8gICAvLyBXZSd2ZSBnb3QgdGhlIHdob2xlIGdyYXBoIHNldCB1cC4gIE5vdyB3ZSBuZWVkIGEgZnVuY3Rpb24gdG8gdHJhdmVyc2UgdGhlXG4vLyAgIC8vIGdyYXBoIGFuZCBtYWtlIHN1cmUgaXQncyB2YWxpZC5cbi8vICAgY29uc3QgYWxsQXJlYXMgPSBPYmplY3Qua2V5cyhhcmVhKS5tYXAoayA9PiBhcmVhW2sgYXMga2V5b2YgdHlwZW9mIGFyZWFdKVxuLy8gICAgICAgLmZpbHRlcihhID0+IGEuZXhpdHMuc2l6ZSk7XG4vLyAgIGZ1bmN0aW9uIHRyYXZlcnNlKCk6IEFycmF5PE1hcDxBcmVhQ29ubmVjdGlvbiwgQXJlYUV4aXRbXT4+IHtcbi8vICAgICBjb25zdCBzZWVuID0gbmV3IFNldCgpO1xuLy8gICAgIGNvbnN0IG91dCA9IFtdO1xuLy8gICAgIGZvciAoY29uc3QgYSBvZiBbYXJlYS5TdGFydCwgLi4uYWxsQXJlYXNdKSB7XG4vLyAgICAgICBpZiAoc2Vlbi5oYXMoYSkpIGNvbnRpbnVlO1xuLy8gICAgICAgY29uc3QgcXVldWUgPSBuZXcgU2V0KFthXSk7XG4vLyAgICAgICBjb25zdCBtYXAgPSBuZXcgRGVmYXVsdE1hcDxBcmVhQ29ubmVjdGlvbiwgQXJlYUV4aXRbXT4oKCkgPT4gW10pO1xuLy8gICAgICAgZm9yIChjb25zdCBuZXh0IG9mIHF1ZXVlKSB7XG4vLyAgICAgICAgIGZvciAoY29uc3QgZXhpdCBvZiBuZXh0LmV4aXRzLnZhbHVlcygpKSB7XG4vLyAgICAgICAgICAgaWYgKHNlZW4uaGFzKGV4aXQuZGVzdCkpIGNvbnRpbnVlO1xuLy8gICAgICAgICAgIHNlZW4uYWRkKGV4aXQuZGVzdCk7XG4vLyAgICAgICAgICAgcXVldWUuYWRkKGV4aXQuZGVzdCk7XG4vLyAgICAgICAgICAgbWFwLmdldChleGl0LmNvbm4pLnB1c2goZXhpdCk7XG4vLyAgICAgICAgICAgY29uc3QgcmV2ZXJzZSA9IGV4aXQuZGVzdC5leGl0cy5nZXQoZXhpdC5kZXN0S2V5KTtcbi8vICAgICAgICAgICBpZiAocmV2ZXJzZSkgbWFwLmdldChyZXZlcnNlLmNvbm4pLnB1c2gocmV2ZXJzZSk7XG4vLyAgICAgICAgIH1cbi8vICAgICAgIH1cbi8vICAgICAgIG91dC5wdXNoKG1hcCk7XG4vLyAgICAgfVxuLy8gICAgIHJldHVybiBvdXQ7XG4vLyAgIH1cblxuLy8gICAvLyBCYXNpYyBwbGFuOiBwaWNrIHR3byByYW5kb20gZXhpdHMgb2YgdGhlIHNhbWUgdHlwZS5cbi8vICAgbGV0IGl0ZXJzID0gMTAwO1xuLy8gICBsZXQgdHJhdmVyc2FsID0gdHJhdmVyc2UoKTtcbi8vICAgd2hpbGUgKGl0ZXJzLS0gPiAwIHx8IHRyYXZlcnNhbC5sZW5ndGggPiAxKSB7XG4vLyAgICAgaWYgKHRyYXZlcnNhbC5sZW5ndGggPiAyKSByYW5kb20uc2h1ZmZsZSh0cmF2ZXJzYWwpO1xuLy8gICAgIGlmICh0cmF2ZXJzYWwubGVuZ3RoID4gMSkge1xuLy8gICAgICAgLy8gcGljayBhbiBjb25uIHR5cGUgdGhhdCdzIHByZXNlbnQgaW4gYm90aCBzZXRzXG4vLyAgICAgfVxuLy8gICAgIHRyYXZlcnNhbCA9IHRyYXZlcnNlKCk7XG4vLyAgIH1cbi8vIH1cbiJdfQ==