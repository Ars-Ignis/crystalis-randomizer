import { DefaultMap } from '../util.js';
import { ACTION_SCRIPTS, Monster } from './monster.js';
import { Constraint } from './constraint.js';
export class Graphics {
    constructor(rom) {
        this.rom = rom;
        this.monsterConstraints = new Map();
        this.npcConstraints = new Map();
        this.allSpritePalettes = new Set();
        const allSpawns = new DefaultMap(() => []);
        for (const l of rom.locations) {
            if (!l.used)
                continue;
            for (let i = 0; i < l.spawns.length; i++) {
                const s = l.spawns[i];
                if (!s.used)
                    continue;
                if (s.isMonster()) {
                    allSpawns.get(s.monsterId).push([l, i, s]);
                }
                else if (s.isNpc() || s.isBoss()) {
                    allSpawns.get(~s.id).push([l, i, s]);
                }
            }
        }
        for (const [m, spawns] of allSpawns) {
            if (m < 0) {
                const npc = rom.npcs[~m];
                const metaspriteIds = [npc.data[3]];
                const metasprite = rom.metasprites[metaspriteIds[0]];
                if (!metasprite)
                    throw new Error(`bad NPC: ${~m}`);
                if (npc.data[2] === 0xd0)
                    metaspriteIds.push(0xc0);
                const offset = npc.data[2] < 0x80 ? npc.data[2] & 0x70 : 0;
                let constraint = this.computeConstraint(metaspriteIds, spawns, true, offset);
                if (~m === 0x5f)
                    constraint = constraint.ignorePalette();
                this.npcConstraints.set(~m, constraint);
            }
            else {
                let constraint = Constraint.ALL;
                const parent = this.rom.objects[m];
                if (!(parent instanceof Monster)) {
                    throw new Error(`expected monster: ${parent} from ${spawns}`);
                }
                for (const obj of allObjects(rom, parent)) {
                    const action = ACTION_SCRIPTS.get(obj.action);
                    const metaspriteFn = action && action.metasprites || (() => [obj.metasprite]);
                    const child = this.computeConstraint(metaspriteFn(obj), spawns, obj.id === m, obj.data[1]);
                    const meet = constraint.meet(child);
                    if (!meet)
                        throw new Error(`Bad meet for ${m} with ${obj.id}`);
                    if (meet)
                        constraint = meet;
                }
                this.monsterConstraints.set(parent.id, constraint);
                parent.constraint = constraint;
            }
        }
    }
    getMonsterConstraint(locationId, monsterId) {
        const c = this.monsterConstraints.get(monsterId) || Constraint.NONE;
        if ((locationId & 0x58) === 0x58)
            return c;
        const m = this.rom.objects[monsterId].goldDrop;
        if (!m)
            return c;
        return c.meet(Constraint.COIN) || Constraint.NONE;
    }
    getNpcConstraint(locationId, npcId) {
        const c = this.npcConstraints.get(npcId) || Constraint.NONE;
        if (locationId === 0x1e && npcId === 0x60) {
            return c.meet(Constraint.STOM_FIGHT);
        }
        return c;
    }
    shufflePalettes(random) {
        const pal = [...this.allSpritePalettes];
        for (const [k, c] of this.monsterConstraints) {
            this.monsterConstraints.set(k, c.shufflePalette(random, pal));
        }
        for (const [k, c] of this.npcConstraints) {
            this.npcConstraints.set(k, c.shufflePalette(random, pal));
        }
    }
    configure(location, spawn) {
        if (!spawn.used)
            return;
        const c = spawn.isMonster() ? this.monsterConstraints.get(spawn.monsterId) :
            spawn.isNpc() ? this.npcConstraints.get(spawn.id) :
                spawn.isChest() ? (spawn.id < 0x70 ? Constraint.TREASURE_CHEST :
                    Constraint.MIMIC) :
                    undefined;
        if (!c)
            return;
        if (c.shift === 3 || c.float.length >= 2) {
            throw new Error(`don't know what to do with two floats`);
        }
        else if (!c.float.length) {
            spawn.patternBank = Number(c.shift === 2);
        }
        else if (c.float[0].has(location.spritePatterns[0])) {
            spawn.patternBank = 0;
        }
        else if (c.float[0].has(location.spritePatterns[1])) {
            spawn.patternBank = 1;
        }
        else if (spawn.isMonster()) {
            throw new Error(`no matching pattern bank`);
        }
    }
    computeConstraint(metaspriteIds, spawns, shiftable, offset = 0) {
        const patterns = new Set();
        const palettes = new Set();
        for (const metasprite of metaspriteIds.map(s => this.rom.metasprites[s])) {
            for (const p of metasprite.palettes()) {
                palettes.add(p);
            }
            for (const p of metasprite.patternBanks(offset)) {
                patterns.add(p);
            }
        }
        shiftable = shiftable && patterns.size == 1 && [...patterns][0] === 2;
        const locs = new Map();
        for (const [l, , spawn] of spawns) {
            locs.set(spawn.patternBank && shiftable ? ~l.id : l.id, spawn);
        }
        let child = undefined;
        for (let [l, spawn] of locs) {
            const loc = this.rom.locations[l < 0 ? ~l : l];
            for (const pal of palettes) {
                if (pal > 1)
                    this.allSpritePalettes.add(loc.spritePalettes[pal - 2]);
            }
            const c = Constraint.fromSpawn(palettes, patterns, loc, spawn, shiftable);
            child = child ? child.join(c) : c;
            if (!shiftable && spawn.patternBank)
                child = child.shifted();
        }
        if (!child)
            throw new Error(`Expected child to appear`);
        return child;
    }
}
function* allObjects(rom, parent) {
    yield parent;
    const repl = parent.spawnedReplacement();
    if (repl)
        yield* allObjects(rom, repl);
    const child = parent.spawnedChild();
    if (child)
        yield* allObjects(rom, child);
    if (parent.id === 0x50)
        yield rom.objects[0x5f];
    if (parent.id === 0x53)
        yield rom.objects[0x69];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvcm9tL2dyYXBoaWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFFdEMsT0FBTyxFQUFDLGNBQWMsRUFBRSxPQUFPLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDckQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBUTNDLE1BQU0sT0FBTyxRQUFRO0lBT25CLFlBQXFCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBTHJCLHVCQUFrQixHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQ25ELG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFFdkQsc0JBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUtwQyxNQUFNLFNBQVMsR0FDWCxJQUFJLFVBQVUsQ0FBb0QsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFaEYsS0FBSyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQzdCLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSTtnQkFBRSxTQUFTO1lBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJO29CQUFFLFNBQVM7Z0JBQ3RCLElBQUksQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO29CQUNqQixTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFF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QUFHLFVBQVUsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQzFFLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQyxJQUFJLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQyxXQUFXO2dCQUFFLEtBQUssR0FBRyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7U0FLOUQ7UUFHRCxJQUFJLENBQUMsS0FBSztZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztRQUl4RCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FDRjtBQUVELFFBQVEsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFRLEVBQUUsTUFBZTtJQUM1QyxNQUFNLE1BQU0sQ0FBQztJQUNiLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBQ3pDLElBQUksSUFBSTtRQUFFLEtBQUssQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkMsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3BDLElBQUksS0FBSztRQUFFLEtBQUssQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFNekMsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLElBQUk7UUFBRSxNQUFNLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFZLENBQUM7SUFDM0QsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLElBQUk7UUFBRSxNQUFNLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFZLENBQUM7QUFDN0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtEZWZhdWx0TWFwfSBmcm9tICcuLi91dGlsLmpzJztcbmltcG9ydCB7TG9jYXRpb24sIFNwYXdufSBmcm9tICcuL2xvY2F0aW9uLmpzJztcbmltcG9ydCB7QUNUSU9OX1NDUklQVFMsIE1vbnN0ZXJ9IGZyb20gJy4vbW9uc3Rlci5qcyc7XG5pbXBvcnQge0NvbnN0cmFpbnR9IGZyb20gJy4vY29uc3RyYWludC5qcyc7XG5pbXBvcnQge1JhbmRvbX0gZnJvbSAnLi4vcmFuZG9tLmpzJztcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4vLyBUaGlzIGFjdHVhbGx5IGFwcGVhcnMgdG8gYmUgbW9yZSBvZiBhIEdyYXBoaWNzQ29uc3RyYWludHMgY2xhc3M/XG4vLyAgIC0gbWF5YmUgZG9uJ3Qgc3RvcmUgdGhlIGNvbnN0cmFpbnRzIG9uIE1vbnN0ZXI/XG5cbmV4cG9ydCBjbGFzcyBHcmFwaGljcyB7XG5cbiAgcHJpdmF0ZSBtb25zdGVyQ29uc3RyYWludHMgPSBuZXcgTWFwPG51bWJlciwgQ29uc3RyYWludD4oKTtcbiAgcHJpdmF0ZSBucGNDb25zdHJhaW50cyA9IG5ldyBNYXA8bnVtYmVyLCBDb25zdHJhaW50PigpO1xuXG4gIGFsbFNwcml0ZVBhbGV0dGVzID0gbmV3IFNldDxudW1iZXI+KCk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICAvLyBJdGVyYXRlIG92ZXIgbG9jYXRpb25zL3NwYXducyB0byBidWlsZCBtdWx0aW1hcCBvZiB3aGVyZSBtb25zdGVycyBhcHBlYXIuXG4gICAgLy8gUG9zdGl2ZSBrZXlzIGFyZSBtb25zdGVycywgbmVnYXRpdmUga2V5cyBhcmUgTlBDcy5cbiAgICBjb25zdCBhbGxTcGF3bnMgPVxuICAgICAgICBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIEFycmF5PHJlYWRvbmx5IFtMb2NhdGlvbiwgbnVtYmVyLCBTcGF3bl0+PigoKSA9PiBbXSk7XG5cbiAgICBmb3IgKGNvbnN0IGwgb2Ygcm9tLmxvY2F0aW9ucykge1xuICAgICAgaWYgKCFsLnVzZWQpIGNvbnRpbnVlO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsLnNwYXducy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzID0gbC5zcGF3bnNbaV07XG4gICAgICAgIGlmICghcy51c2VkKSBjb250aW51ZTtcbiAgICAgICAgaWYgKHMuaXNNb25zdGVyKCkpIHtcbiAgICAgICAgICBhbGxTcGF3bnMuZ2V0KHMubW9uc3RlcklkKS5wdXNoKFtsLCBpLCBzXSk7XG4gICAgICAgIH0gZWxzZSBpZiAocy5pc05wYygpIHx8IHMuaXNCb3NzKCkpIHtcbiAgICAgICAgICBhbGxTcGF3bnMuZ2V0KH5zLmlkKS5wdXNoKFtsLCBpLCBzXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgLy8gRm9yIGVhY2ggbW9uc3RlciwgZGV0ZXJtaW5lIHdoaWNoIHBhdHRlcm5zIGFuZCBwYWxldHRlcyBhcmUgdXNlZC5cbiAgICBmb3IgKGNvbnN0IFttLCBzcGF3bnNdIG9mIGFsbFNwYXducykge1xuICAgICAgLy8gVE9ETyAtIGZvbGQgaW50byBwYXRjaC5zaHVmZmxlTW9uc3RlcnNcbiAgICAgIC8vaWYgKG0gPT09IDApIGNvbnRpbnVlOyAvLyB1c2VkIHRvIHN1cHByZXNzIGJ1Z2d5IHN0cmF5IHNwYXduc1xuICAgICAgaWYgKG0gPCAwKSB7IC8vIE5QQ1xuICAgICAgICBjb25zdCBucGMgPSByb20ubnBjc1t+bV07XG4gICAgICAgIGNvbnN0IG1ldGFzcHJpdGVJZHMgPSBbbnBjLmRhdGFbM11dO1xuICAgICAgICBjb25zdCBtZXRhc3ByaXRlID0gcm9tLm1ldGFzcHJpdGVzW21ldGFzcHJpdGVJZHNbMF1dO1xuICAgICAgICBpZiAoIW1ldGFzcHJpdGUpIHRocm93IG5ldyBFcnJvcihgYmFkIE5QQzogJHt+bX1gKTtcbiAgICAgICAgLy8gSGFyZGNvZGUgZXhjZXB0aW9uIGZvciBqdW1waW5nIG1hbiAoYWN0aW9uIHNjcmlwdCAkNTApXG4gICAgICAgIGlmIChucGMuZGF0YVsyXSA9PT0gMHhkMCkgbWV0YXNwcml0ZUlkcy5wdXNoKDB4YzApO1xuICAgICAgICAvLyBDb21wdXRlIGNvbnN0cmFpbnRcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbnBjLmRhdGFbMl0gPCAweDgwID8gbnBjLmRhdGFbMl0gJiAweDcwIDogMDtcbiAgICAgICAgbGV0IGNvbnN0cmFpbnQgPVxuICAgICAgICAgICAgdGhpcy5jb21wdXRlQ29uc3RyYWludChtZXRhc3ByaXRlSWRzLCBzcGF3bnMsIHRydWUsIG9mZnNldCk7XG4gICAgICAgIC8vIFRPRE8gLSBiZXR0ZXIgd2F5IHN0cmVhbWxpbmUgdGhpcy4uLj8gKHRvcm5lbCBvbiBzYWJyZSlcbiAgICAgICAgaWYgKH5tID09PSAweDVmKSBjb25zdHJhaW50ID0gY29uc3RyYWludC5pZ25vcmVQYWxldHRlKCk7XG4gICAgICAgIHRoaXMubnBjQ29uc3RyYWludHMuc2V0KH5tLCBjb25zdHJhaW50KTtcbiAgICAgIH0gZWxzZSB7IC8vIG1vbnN0ZXJcbiAgICAgICAgbGV0IGNvbnN0cmFpbnQgPSBDb25zdHJhaW50LkFMTDtcbiAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5yb20ub2JqZWN0c1ttXTtcbiAgICAgICAgaWYgKCEocGFyZW50IGluc3RhbmNlb2YgTW9uc3RlcikpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGV4cGVjdGVkIG1vbnN0ZXI6ICR7cGFyZW50fSBmcm9tICR7c3Bhd25zfWApO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3Qgb2JqIG9mIGFsbE9iamVjdHMocm9tLCBwYXJlbnQpKSB7XG4gICAgICAgICAgY29uc3QgYWN0aW9uID0gQUNUSU9OX1NDUklQVFMuZ2V0KG9iai5hY3Rpb24pO1xuICAgICAgICAgIGNvbnN0IG1ldGFzcHJpdGVGbjogKG06IE1vbnN0ZXIpID0+IHJlYWRvbmx5IG51bWJlcltdID1cbiAgICAgICAgICAgICAgYWN0aW9uICYmIGFjdGlvbi5tZXRhc3ByaXRlcyB8fCAoKCkgPT4gW29iai5tZXRhc3ByaXRlXSk7XG4gICAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLmNvbXB1dGVDb25zdHJhaW50KG1ldGFzcHJpdGVGbihvYmopLCBzcGF3bnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5pZCA9PT0gbSwgb2JqLmRhdGFbMV0pO1xuICAgICAgICAgIGNvbnN0IG1lZXQgPSBjb25zdHJhaW50Lm1lZXQoY2hpbGQpO1xuICAgICAgICAgIGlmICghbWVldCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWVldCBmb3IgJHttfSB3aXRoICR7b2JqLmlkfWApO1xuICAgICAgICAgIGlmIChtZWV0KSBjb25zdHJhaW50ID0gbWVldDtcbiAgICAgICAgICAvLyBUT0RPIC0gZWxzZSBlcnJvcj8gd2Fybj9cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cy5zZXQocGFyZW50LmlkLCBjb25zdHJhaW50KTtcbiAgICAgICAgcGFyZW50LmNvbnN0cmFpbnQgPSBjb25zdHJhaW50OyAgLy8gZm9yIGRlYnVnZ2luZ1xuICAgICAgfVxuICAgIH0gICAgXG4gIH1cblxuICBnZXRNb25zdGVyQ29uc3RyYWludChsb2NhdGlvbklkOiBudW1iZXIsIG1vbnN0ZXJJZDogbnVtYmVyKTogQ29uc3RyYWludCB7XG4gICAgY29uc3QgYyA9IHRoaXMubW9uc3RlckNvbnN0cmFpbnRzLmdldChtb25zdGVySWQpIHx8IENvbnN0cmFpbnQuTk9ORTtcbiAgICBpZiAoKGxvY2F0aW9uSWQgJiAweDU4KSA9PT0gMHg1OCkgcmV0dXJuIGM7XG4gICAgY29uc3QgbSA9IHRoaXMucm9tLm9iamVjdHNbbW9uc3RlcklkXS5nb2xkRHJvcDtcbiAgICBpZiAoIW0pIHJldHVybiBjO1xuICAgIHJldHVybiBjLm1lZXQoQ29uc3RyYWludC5DT0lOKSB8fCBDb25zdHJhaW50Lk5PTkU7XG4gIH1cblxuICBnZXROcGNDb25zdHJhaW50KGxvY2F0aW9uSWQ6IG51bWJlciwgbnBjSWQ6IG51bWJlcik6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IGMgPSB0aGlzLm5wY0NvbnN0cmFpbnRzLmdldChucGNJZCkgfHwgQ29uc3RyYWludC5OT05FO1xuICAgIGlmIChsb2NhdGlvbklkID09PSAweDFlICYmIG5wY0lkID09PSAweDYwKSB7XG4gICAgICAvLyBUT0RPOiBjaGFuZ2UgdGhpcyB0byBhY3R1YWxseSBsb29rIGF0IHRoZSBsb2NhdGlvbidzIHRyaWdnZXJzP1xuICAgICAgcmV0dXJuIGMubWVldChDb25zdHJhaW50LlNUT01fRklHSFQpO1xuICAgIH1cbiAgICByZXR1cm4gYztcbiAgfVxuXG4gIHNodWZmbGVQYWxldHRlcyhyYW5kb206IFJhbmRvbSk6IHZvaWQge1xuICAgIGNvbnN0IHBhbCA9IFsuLi50aGlzLmFsbFNwcml0ZVBhbGV0dGVzXTtcbiAgICBmb3IgKGNvbnN0IFtrLCBjXSBvZiB0aGlzLm1vbnN0ZXJDb25zdHJhaW50cykge1xuICAgICAgdGhpcy5tb25zdGVyQ29uc3RyYWludHMuc2V0KGssIGMuc2h1ZmZsZVBhbGV0dGUocmFuZG9tLCBwYWwpKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBbaywgY10gb2YgdGhpcy5ucGNDb25zdHJhaW50cykge1xuICAgICAgdGhpcy5ucGNDb25zdHJhaW50cy5zZXQoaywgYy5zaHVmZmxlUGFsZXR0ZShyYW5kb20sIHBhbCkpO1xuICAgIH1cbiAgfVxuXG4gIGNvbmZpZ3VyZShsb2NhdGlvbjogTG9jYXRpb24sIHNwYXduOiBTcGF3bikge1xuICAgIGlmICghc3Bhd24udXNlZCkgcmV0dXJuO1xuICAgIGNvbnN0IGMgPSBzcGF3bi5pc01vbnN0ZXIoKSA/IHRoaXMubW9uc3RlckNvbnN0cmFpbnRzLmdldChzcGF3bi5tb25zdGVySWQpIDpcbiAgICAgICAgc3Bhd24uaXNOcGMoKSA/IHRoaXMubnBjQ29uc3RyYWludHMuZ2V0KHNwYXduLmlkKSA6XG4gICAgICAgIHNwYXduLmlzQ2hlc3QoKSA/IChzcGF3bi5pZCA8IDB4NzAgPyBDb25zdHJhaW50LlRSRUFTVVJFX0NIRVNUIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbnN0cmFpbnQuTUlNSUMpIDpcbiAgICAgICAgdW5kZWZpbmVkO1xuICAgIGlmICghYykgcmV0dXJuO1xuICAgIGlmIChjLnNoaWZ0ID09PSAzIHx8IGMuZmxvYXQubGVuZ3RoID49IDIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgZG9uJ3Qga25vdyB3aGF0IHRvIGRvIHdpdGggdHdvIGZsb2F0c2ApO1xuICAgIH0gZWxzZSBpZiAoIWMuZmxvYXQubGVuZ3RoKSB7XG4gICAgICBzcGF3bi5wYXR0ZXJuQmFuayA9IE51bWJlcihjLnNoaWZ0ID09PSAyKTtcbiAgICB9IGVsc2UgaWYgKGMuZmxvYXRbMF0uaGFzKGxvY2F0aW9uLnNwcml0ZVBhdHRlcm5zWzBdKSkge1xuICAgICAgc3Bhd24ucGF0dGVybkJhbmsgPSAwO1xuICAgIH0gZWxzZSBpZiAoYy5mbG9hdFswXS5oYXMobG9jYXRpb24uc3ByaXRlUGF0dGVybnNbMV0pKSB7XG4gICAgICBzcGF3bi5wYXR0ZXJuQmFuayA9IDE7XG4gICAgfSBlbHNlIGlmIChzcGF3bi5pc01vbnN0ZXIoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBubyBtYXRjaGluZyBwYXR0ZXJuIGJhbmtgKTtcbiAgICB9XG4gIH1cblxuICBjb21wdXRlQ29uc3RyYWludChtZXRhc3ByaXRlSWRzOiByZWFkb25seSBudW1iZXJbXSxcbiAgICAgICAgICAgICAgICAgICAgc3Bhd25zOiBTcGF3bnMsXG4gICAgICAgICAgICAgICAgICAgIHNoaWZ0YWJsZTogYm9vbGVhbixcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gMCk6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IHBhdHRlcm5zID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgY29uc3QgcGFsZXR0ZXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBmb3IgKGNvbnN0IG1ldGFzcHJpdGUgb2YgbWV0YXNwcml0ZUlkcy5tYXAocyA9PiB0aGlzLnJvbS5tZXRhc3ByaXRlc1tzXSkpIHtcbiAgICAgIC8vIFdoaWNoIHBhbGV0dGUgYW5kIHBhdHRlcm4gYmFua3MgYXJlIHJlZmVyZW5jZWQ/XG4gICAgICBmb3IgKGNvbnN0IHAgb2YgbWV0YXNwcml0ZS5wYWxldHRlcygpKSB7XG4gICAgICAgIHBhbGV0dGVzLmFkZChwKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgcCBvZiBtZXRhc3ByaXRlLnBhdHRlcm5CYW5rcyhvZmZzZXQpKSB7XG4gICAgICAgIHBhdHRlcm5zLmFkZChwKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBvYmoudXNlZFBhbGV0dGVzID0gWy4uLnBhbGV0dGVzXTtcbiAgICAvLyBvYmoudXNlZFBhdHRlcm5zID0gWy4uLnBhdHRlcm5zXTtcblxuICAgIC8vIElmIG9ubHkgdGhpcmQtYmFuayBwYXR0ZXJucyBhcmUgdXNlZCwgdGhlbiB0aGUgbWV0YXNwcml0ZSBjYW4gYmVcbiAgICAvLyBzaGlmdGVkIHRvIGZvdXJ0aCBiYW5rIHdoZW4gbmVjZXNzYXJ5LiAgVGhpcyBpcyBvbmx5IHRydWUgZm9yIE5QQ1xuICAgIC8vIHNwYXducy4gIEFkIGhvYyBzcGF3bnMgY2Fubm90IGJlIHNoaWZ0ZWQgKHlldD8pLlxuICAgIHNoaWZ0YWJsZSA9IHNoaWZ0YWJsZSAmJiBwYXR0ZXJucy5zaXplID09IDEgJiYgWy4uLnBhdHRlcm5zXVswXSA9PT0gMjtcblxuICAgIC8vIElmIHRoZSBzcGF3biBzZXRzIHBhdHRlcm5CYW5rIHRoZW4gd2UgbmVlZCB0byBpbmNyZW1lbnQgZWFjaCBwYXR0ZXJuLlxuICAgIC8vIFdlIGhhdmUgdGhlIGZyZWVkb20gdG8gc2V0IHRoaXMgdG8gZWl0aGVyLCBkZXBlbmRpbmcuXG4gICAgY29uc3QgbG9jcyA9IG5ldyBNYXA8bnVtYmVyLCBTcGF3bj4oKTtcbiAgICBmb3IgKGNvbnN0IFtsLCAsIHNwYXduXSBvZiBzcGF3bnMpIHtcbiAgICAgIGxvY3Muc2V0KHNwYXduLnBhdHRlcm5CYW5rICYmIHNoaWZ0YWJsZSA/IH5sLmlkIDogbC5pZCwgc3Bhd24pO1xuICAgIH1cblxuICAgIC8vIFRPRE8gLSBDb25zdHJhaW50QnVpbGRlclxuICAgIC8vICAgLS0ga2VlcHMgdHJhY2sgb25seSBvZiByZWxldmFudCBmYWN0b3JzLCBpbiBhIGpvaW4uXG4gICAgLy8gICAgICAtLT4gbm8gbWVldGluZyBpbnZvbHZlZCFcbiAgICBsZXQgY2hpbGQgPSB1bmRlZmluZWQ7XG5cbiAgICBmb3IgKGxldCBbbCwgc3Bhd25dIG9mIGxvY3MpIHtcbiAgICAgIGNvbnN0IGxvYyA9IHRoaXMucm9tLmxvY2F0aW9uc1tsIDwgMCA/IH5sIDogbF07XG4gICAgICBmb3IgKGNvbnN0IHBhbCBvZiBwYWxldHRlcykge1xuICAgICAgICBpZiAocGFsID4gMSkgdGhpcy5hbGxTcHJpdGVQYWxldHRlcy5hZGQobG9jLnNwcml0ZVBhbGV0dGVzW3BhbCAtIDJdKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGMgPSBDb25zdHJhaW50LmZyb21TcGF3bihwYWxldHRlcywgcGF0dGVybnMsIGxvYywgc3Bhd24sIHNoaWZ0YWJsZSk7XG4gICAgICBjaGlsZCA9IGNoaWxkID8gY2hpbGQuam9pbihjKSA6IGM7XG4gICAgICBpZiAoIXNoaWZ0YWJsZSAmJiBzcGF3bi5wYXR0ZXJuQmFuaykgY2hpbGQgPSBjaGlsZC5zaGlmdGVkKCk7XG5cbiAgICAgIC8vIC0tLSBoYW5kbGUgc2hpZnRzIGJldHRlci4uLj8gc3VwcG9zZSBlLmcuIG11bHRpcGxlIHBhbDInc1xuICAgICAgLy8gICAgLT4gd2Ugd2FudCB0byBqb2luIHRoZW0gLSB3aWxsIGhhdmUgbXVsdGlwbGUgc2hpZnRhYmxlcy4uLlxuICAgICAgLy9jb25zdHJhaW50ID0gY29uc3RyYWludC5cbiAgICB9XG5cbiAgICAvLyBJZiB3ZSdyZSBzaGlmdGFibGUsIHNhdmUgdGhlIHNldCBvZiBwb3NzaWJsZSBzaGlmdCBiYW5rc1xuICAgIGlmICghY2hpbGQpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgY2hpbGQgdG8gYXBwZWFyYCk7XG4gICAgLy8gaWYgKGNoaWxkLmZsb2F0Lmxlbmd0aCA9PT0gMSkge1xuICAgIC8vICAgcGFyZW50LnNoaWZ0UGF0dGVybnMgPSBuZXcgU2V0KGNoaWxkLmZsb2F0WzBdKTtcbiAgICAvLyB9XG4gICAgcmV0dXJuIGNoaWxkO1xuICB9XG59XG5cbmZ1bmN0aW9uKiBhbGxPYmplY3RzKHJvbTogUm9tLCBwYXJlbnQ6IE1vbnN0ZXIpOiBJdGVyYWJsZTxNb25zdGVyPiB7XG4gIHlpZWxkIHBhcmVudDtcbiAgY29uc3QgcmVwbCA9IHBhcmVudC5zcGF3bmVkUmVwbGFjZW1lbnQoKTtcbiAgaWYgKHJlcGwpIHlpZWxkKiBhbGxPYmplY3RzKHJvbSwgcmVwbCk7XG4gIGNvbnN0IGNoaWxkID0gcGFyZW50LnNwYXduZWRDaGlsZCgpO1xuICBpZiAoY2hpbGQpIHlpZWxkKiBhbGxPYmplY3RzKHJvbSwgY2hpbGQpO1xuICAvLyBUT0RPIC0gdGhlc2UgZG9uJ3QgbWFrZSBzZW5zZSB0byBwdXQgaW4gc3Bhd25lZFJlcGxhY2VtZW50IGJlY2F1c2VcbiAgLy8gd2UgZG9uJ3Qgd2FudCB0byBvdmVyLWluZmxhdGUgcmVkIHNsaW1lcyBkdWUgdG8gZ2lhbnQgcmVkIHNsaW1lcydcbiAgLy8gZGlmZmljdWx0eSwgc2luY2UgbW9zdCBmb2xrcyB3aWxsIG5ldmVyIGhhdmUgdG8gZGVhbCB3aXRoIHRoYXQuXG4gIC8vIEJ1dCB3ZSBkbyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZXkgZ2V0IFwidW4tZmxvYXRlZFwiIHNpbmNlIHRoZVxuICAvLyByZXBsYWNlbWVudCBzcGF3biB3aWxsIG5vdCBzaGFyZSB0aGUgc2FtZSAzODA6MjAgKGZvciBub3cpLlxuICBpZiAocGFyZW50LmlkID09PSAweDUwKSB5aWVsZCByb20ub2JqZWN0c1sweDVmXSBhcyBNb25zdGVyOyAvLyBibHVlIHNsaW1lXG4gIGlmIChwYXJlbnQuaWQgPT09IDB4NTMpIHlpZWxkIHJvbS5vYmplY3RzWzB4NjldIGFzIE1vbnN0ZXI7IC8vIHJlZCBzbGltZVxufVxuXG50eXBlIFNwYXducyA9IFJlYWRvbmx5QXJyYXk8cmVhZG9ubHkgW0xvY2F0aW9uLCBudW1iZXIsIFNwYXduXT47XG4iXX0=