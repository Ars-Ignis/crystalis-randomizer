#!/usr/bin/env node -r esm
import './build_info.js';
import { EXPECTED_CRC32 } from './rom.js';
import { FlagSet, PRESETS } from './flagset.js';
import { crc32 } from './crc32.js';
import * as fs from 'fs';
import * as patch from './patch.js';
import { UsageError, breakLines } from './util.js';
import { NodeReader } from './nodereader.js';
import * as version from './version.js';
import { disableAsserts } from './assert.js';
const usage = (code) => {
    console.log(`Crystalis Randomizer v${version.VERSION}
Usage: cryr [OPTIONS...] rom.nes

Options
  --flags=FLAGSET    Specify the flagset.
  --preset=PRESET    Specify the preset by name.
                     Spaces and capitalization are ignored.
  --seed=SEED        Specify the seed.
  --output=PATTERN   Specify the output filename pattern.
                     May include placeholders:
                       %n: input base filename
                       %v: cryr version hash
                       %s: seed
                       %f: flagset
                       %c: checksum
                     The default pattern is "%n_%c".
  --count=NUMBER     Number of shuffled roms to generate.
                     This flag is not compatible with specifying
                     a seed manually, nor with output patterns
                     that don't include %s or %c.
  --force            Don't fail due to wrong input file checksum.

Flags
  The randomizer supports a number of options, documented in detail
  at https://crystalisrandomizer.com.  Spaces are ignored.

Presets
${PRESETS.map(showPreset).join('\n\n')}`);
    process.exit(code);
};
const showPreset = ({ title, flags, descr }) => {
    const LINE_LENGTH = 68;
    const flagLen = LINE_LENGTH - title.length - 6;
    const flagLines = breakLines(flags, flagLen);
    const descrLines = breakLines(descr, LINE_LENGTH - 2);
    const indent = '\n' + ' '.repeat(title.length + 5);
    return `  ${title}: "${flagLines.join(indent)}"
  ${descrLines.join('\n  ')}`;
};
const main = (...args) => {
    let flags = '@FullShuffle';
    let count = 1;
    let seed = '';
    let output = '%n_%c';
    let force = false;
    while (args[0] && args[0].startsWith('--')) {
        let arg = args.shift().substring(2);
        let value = undefined;
        const eq = arg.indexOf('=');
        if (eq >= 0) {
            value = arg.substring(eq + 1);
            arg = arg.substring(0, eq);
        }
        else {
            value = args.shift();
        }
        if (arg == 'flags' && value) {
            flags = value;
        }
        else if (arg == 'preset' && value) {
            flags = '@' + value.replace(/ /g, '');
        }
        else if (arg == 'output' && value) {
            output = value;
        }
        else if (arg == 'seed' && value) {
            seed = value;
        }
        else if (arg == 'count' && value) {
            count = Number(value);
        }
        else if (arg == 'force') {
            force = true;
            disableAsserts();
            if (value != null)
                args.unshift(value);
        }
        else if (arg == 'help') {
            usage(0);
        }
        else if (arg == 'version' || arg == '-v') {
            console.log(version.VERSION);
            process.exit(0);
        }
        else if (arg == 'list-presets') {
            for (const { title } of PRESETS) {
                console.log(title.replace(/ /g, ''));
            }
            process.exit(0);
        }
        else {
            console.error(`Bad argument: ${arg}`);
            usage(1);
        }
    }
    if (args.length != 1)
        usage(1);
    if (count > 1) {
        if (seed)
            fail('Cannot specify both --count and --seed');
        if (!/%[sc]/.test(output)) {
            fail('--output must have a %c or %s placeholder when --count is given');
        }
    }
    const flagset = new FlagSet(flags);
    const rom = new Uint8Array(fs.readFileSync(args[0]).buffer);
    if (crc32(rom) != EXPECTED_CRC32) {
        console.error(`WARNING: Bad CRC for input rom: ${crc32(rom).toString(16)}`);
        if (!force)
            fail('Run with --force to proceed anyway');
        console.error('Proceeding anyway');
    }
    return Promise.all(new Array(count).fill(0).map(async () => {
        const s = patch.parseSeed(seed);
        console.log(`Seed: ${s.toString(16)}`);
        const orig = rom.slice();
        const [shuffled, c] = await patch.shuffle(orig, s, flagset, new NodeReader());
        const n = args[0].replace('.nes', '');
        const f = String(flagset).replace(/ /g, '');
        const v = version.VERSION;
        const filename = fillTemplate(output, { c, n, s, v, f, '%': '%' }) + '.nes';
        await new Promise((resolve, reject) => fs.writeFile(filename, shuffled, (err) => err ? reject(err) : resolve()));
        console.log(`Wrote ${filename}`);
    }));
};
function fail(message) {
    console.error(message);
    throw process.exit(2);
}
function fillTemplate(str, arg) {
    const terms = [];
    while (str) {
        const index = str.indexOf('%');
        if (index < 0) {
            terms.push(str);
            str = '';
        }
        else {
            terms.push(str.substring(0, index));
            const ch = str[index + 1];
            if (!(ch in arg))
                throw new Error(`Bad placeholder: %${ch}`);
            terms.push(arg[ch]);
            str = str.substring(index + 2);
        }
    }
    return terms.join('');
}
process.on('unhandledRejection', (error) => {
    console.error(typeof error === 'string' ?
        error :
        error instanceof UsageError ? error.message : error.stack);
    process.exit(1);
});
const asyncMain = async () => {
    try {
        await main(...process.argv.slice(2));
    }
    catch (error) {
        if (error instanceof UsageError) {
            console.error(error.message);
            console.error(`Try passing --help for documentation.`);
            process.exit(1);
        }
        throw error;
    }
};
asyncMain().then(() => process.exit(0));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2pzL2NsaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxpQkFBaUIsQ0FBQztBQUV6QixPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ3hDLE9BQU8sRUFBQyxPQUFPLEVBQUUsT0FBTyxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBRTlDLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDakMsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLEtBQUssTUFBTSxZQUFZLENBQUM7QUFDcEMsT0FBTyxFQUFDLFVBQVUsRUFBRSxVQUFVLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDakQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sS0FBSyxPQUFPLE1BQU0sY0FBYyxDQUFDO0FBQ3hDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxhQUFhLENBQUM7QUFJM0MsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRTtJQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixPQUFPLENBQUMsT0FBTzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0VBMkJwRCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNyQixDQUFDLENBQUM7QUFFRixNQUFNLFVBQVUsR0FBRyxDQUFDLEVBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQVMsRUFBRSxFQUFFO0lBQ25ELE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQztJQUN2QixNQUFNLE9BQU8sR0FBRyxXQUFXLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FB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LENBQUMsRUFBRSxDQUFDLENBQUM7QUFDeEIsQ0FBQztBQUVELE9BQU8sQ0FBQyxFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxLQUFVLEVBQUUsRUFBRTtJQUM5QyxPQUFPLENBQUMsS0FBSyxDQUNULE9BQU8sS0FBSyxLQUFLLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZCLEtBQUssQ0FBQyxDQUFDO1FBQ1AsS0FBSyxZQUFZLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25FLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEIsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLFNBQVMsR0FDWCxLQUFLLElBQUksRUFBRTtJQUNiLElBQUk7UUFDRixNQUFNLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDdEM7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNkLElBQUksS0FBSyxZQUFZLFVBQVUsRUFBRTtZQUMvQixPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM3QixPQUFPLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7WUFDdkQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNqQjtRQUNELE1BQU0sS0FBSyxDQUFDO0tBQ2I7QUFDSCxDQUFDLENBQUE7QUFFRCxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZSAtciBlc21cblxuaW1wb3J0ICcuL2J1aWxkX2luZm8uanMnOyAvLyBzaWRlIGVmZmVjdCBnbG9iYWwgc2V0IChhZmZlY3RzIHZlcnNpb24gbW9kdWxlKVxuXG5pbXBvcnQge0VYUEVDVEVEX0NSQzMyfSBmcm9tICcuL3JvbS5qcyc7XG5pbXBvcnQge0ZsYWdTZXQsIFBSRVNFVFN9IGZyb20gJy4vZmxhZ3NldC5qcyc7XG5pbXBvcnQge1ByZXNldH0gZnJvbSAnLi9mbGFncy9mbGFnLmpzJztcbmltcG9ydCB7Y3JjMzJ9IGZyb20gJy4vY3JjMzIuanMnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0Y2ggZnJvbSAnLi9wYXRjaC5qcyc7XG5pbXBvcnQge1VzYWdlRXJyb3IsIGJyZWFrTGluZXN9IGZyb20gJy4vdXRpbC5qcyc7XG5pbXBvcnQge05vZGVSZWFkZXJ9IGZyb20gJy4vbm9kZXJlYWRlci5qcyc7XG5pbXBvcnQgKiBhcyB2ZXJzaW9uIGZyb20gJy4vdmVyc2lvbi5qcyc7XG5pbXBvcnQge2Rpc2FibGVBc3NlcnRzfSBmcm9tICcuL2Fzc2VydC5qcyc7XG5cbi8vIFVzYWdlOiBub2RlIGNsaS5qcyBbLS1mbGFncz08RkxBR1M+XSBbLS1zZWVkPTxTRUVEPl0gcm9tLm5lc1xuXG5jb25zdCB1c2FnZSA9IChjb2RlOiBudW1iZXIpID0+IHtcbiAgY29uc29sZS5sb2coYENyeXN0YWxpcyBSYW5kb21pemVyIHYke3ZlcnNpb24uVkVSU0lPTn1cblVzYWdlOiBjcnlyIFtPUFRJT05TLi4uXSByb20ubmVzXG5cbk9wdGlvbnNcbiAgLS1mbGFncz1GTEFHU0VUICAgIFNwZWNpZnkgdGhlIGZsYWdzZXQuXG4gIC0tcHJlc2V0PVBSRVNFVCAgICBTcGVjaWZ5IHRoZSBwcmVzZXQgYnkgbmFtZS5cbiAgICAgICAgICAgICAgICAgICAgIFNwYWNlcyBhbmQgY2FwaXRhbGl6YXRpb24gYXJlIGlnbm9yZWQuXG4gIC0tc2VlZD1TRUVEICAgICAgICBTcGVjaWZ5IHRoZSBzZWVkLlxuICAtLW91dHB1dD1QQVRURVJOICAgU3BlY2lmeSB0aGUgb3V0cHV0IGZpbGVuYW1lIHBhdHRlcm4uXG4gICAgICAgICAgICAgICAgICAgICBNYXkgaW5jbHVkZSBwbGFjZWhvbGRlcnM6XG4gICAgICAgICAgICAgICAgICAgICAgICVuOiBpbnB1dCBiYXNlIGZpbGVuYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICV2OiBjcnlyIHZlcnNpb24gaGFzaFxuICAgICAgICAgICAgICAgICAgICAgICAlczogc2VlZFxuICAgICAgICAgICAgICAgICAgICAgICAlZjogZmxhZ3NldFxuICAgICAgICAgICAgICAgICAgICAgICAlYzogY2hlY2tzdW1cbiAgICAgICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHBhdHRlcm4gaXMgXCIlbl8lY1wiLlxuICAtLWNvdW50PU5VTUJFUiAgICAgTnVtYmVyIG9mIHNodWZmbGVkIHJvbXMgdG8gZ2VuZXJhdGUuXG4gICAgICAgICAgICAgICAgICAgICBUaGlzIGZsYWcgaXMgbm90IGNvbXBhdGlibGUgd2l0aCBzcGVjaWZ5aW5nXG4gICAgICAgICAgICAgICAgICAgICBhIHNlZWQgbWFudWFsbHksIG5vciB3aXRoIG91dHB1dCBwYXR0ZXJuc1xuICAgICAgICAgICAgICAgICAgICAgdGhhdCBkb24ndCBpbmNsdWRlICVzIG9yICVjLlxuICAtLWZvcmNlICAgICAgICAgICAgRG9uJ3QgZmFpbCBkdWUgdG8gd3JvbmcgaW5wdXQgZmlsZSBjaGVja3N1bS5cblxuRmxhZ3NcbiAgVGhlIHJhbmRvbWl6ZXIgc3VwcG9ydHMgYSBudW1iZXIgb2Ygb3B0aW9ucywgZG9jdW1lbnRlZCBpbiBkZXRhaWxcbiAgYXQgaHR0cHM6Ly9jcnlzdGFsaXNyYW5kb21pemVyLmNvbS4gIFNwYWNlcyBhcmUgaWdub3JlZC5cblxuUHJlc2V0c1xuJHtQUkVTRVRTLm1hcChzaG93UHJlc2V0KS5qb2luKCdcXG5cXG4nKX1gKTtcbiAgcHJvY2Vzcy5leGl0KGNvZGUpO1xufTtcblxuY29uc3Qgc2hvd1ByZXNldCA9ICh7dGl0bGUsIGZsYWdzLCBkZXNjcn06IFByZXNldCkgPT4ge1xuICBjb25zdCBMSU5FX0xFTkdUSCA9IDY4O1xuICBjb25zdCBmbGFnTGVuID0gTElORV9MRU5HVEggLSB0aXRsZS5sZW5ndGggLSA2O1xuICBjb25zdCBmbGFnTGluZXMgPSBicmVha0xpbmVzKGZsYWdzLCBmbGFnTGVuKTtcbiAgY29uc3QgZGVzY3JMaW5lcyA9IGJyZWFrTGluZXMoZGVzY3IsIExJTkVfTEVOR1RIIC0gMik7XG4gIGNvbnN0IGluZGVudCA9ICdcXG4nICsgJyAnLnJlcGVhdCh0aXRsZS5sZW5ndGggKyA1KTtcbiAgcmV0dXJuIGAgICR7dGl0bGV9OiBcIiR7ZmxhZ0xpbmVzLmpvaW4oaW5kZW50KX1cIlxuICAke2Rlc2NyTGluZXMuam9pbignXFxuICAnKX1gO1xufTtcblxuY29uc3QgbWFpbiA9ICguLi5hcmdzOiBzdHJpbmdbXSkgPT4ge1xuICBsZXQgZmxhZ3MgPSAnQEZ1bGxTaHVmZmxlJztcbiAgbGV0IGNvdW50ID0gMTtcbiAgbGV0IHNlZWQgPSAnJztcbiAgbGV0IG91dHB1dCA9ICclbl8lYyc7XG4gIGxldCBmb3JjZSA9IGZhbHNlO1xuICB3aGlsZSAoYXJnc1swXSAmJiBhcmdzWzBdLnN0YXJ0c1dpdGgoJy0tJykpIHtcbiAgICBsZXQgYXJnID0gYXJncy5zaGlmdCgpIS5zdWJzdHJpbmcoMik7XG4gICAgbGV0IHZhbHVlID0gdW5kZWZpbmVkO1xuICAgIGNvbnN0IGVxID0gYXJnLmluZGV4T2YoJz0nKTtcbiAgICBpZiAoZXEgPj0gMCkge1xuICAgICAgdmFsdWUgPSBhcmcuc3Vic3RyaW5nKGVxICsgMSk7XG4gICAgICBhcmcgPSBhcmcuc3Vic3RyaW5nKDAsIGVxKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFsdWUgPSBhcmdzLnNoaWZ0KCk7XG4gICAgfVxuICAgIGlmIChhcmcgPT0gJ2ZsYWdzJyAmJiB2YWx1ZSkge1xuICAgICAgZmxhZ3MgPSB2YWx1ZTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PSAncHJlc2V0JyAmJiB2YWx1ZSkge1xuICAgICAgZmxhZ3MgPSAnQCcgKyB2YWx1ZS5yZXBsYWNlKC8gL2csICcnKTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PSAnb3V0cHV0JyAmJiB2YWx1ZSkge1xuICAgICAgb3V0cHV0ID0gdmFsdWU7XG4gICAgfSBlbHNlIGlmIChhcmcgPT0gJ3NlZWQnICYmIHZhbHVlKSB7XG4gICAgICBzZWVkID0gdmFsdWU7XG4gICAgfSBlbHNlIGlmIChhcmcgPT0gJ2NvdW50JyAmJiB2YWx1ZSkge1xuICAgICAgY291bnQgPSBOdW1iZXIodmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoYXJnID09ICdmb3JjZScpIHtcbiAgICAgIGZvcmNlID0gdHJ1ZTtcbiAgICAgIGRpc2FibGVBc3NlcnRzKCk7XG4gICAgICBpZiAodmFsdWUgIT0gbnVsbCkgYXJncy51bnNoaWZ0KHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PSAnaGVscCcpIHtcbiAgICAgIHVzYWdlKDApO1xuICAgIH0gZWxzZSBpZiAoYXJnID09ICd2ZXJzaW9uJyB8fCBhcmcgPT0gJy12Jykge1xuICAgICAgY29uc29sZS5sb2codmVyc2lvbi5WRVJTSU9OKTtcbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PSAnbGlzdC1wcmVzZXRzJykge1xuICAgICAgLy8gdW5kb2N1bWVudGVkIGZsYWdcbiAgICAgIGZvciAoY29uc3Qge3RpdGxlfSBvZiBQUkVTRVRTKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKHRpdGxlLnJlcGxhY2UoLyAvZywgJycpKTtcbiAgICAgIH1cbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihgQmFkIGFyZ3VtZW50OiAke2FyZ31gKTtcbiAgICAgIHVzYWdlKDEpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChhcmdzLmxlbmd0aCAhPSAxKSB1c2FnZSgxKTtcbiAgaWYgKGNvdW50ID4gMSkge1xuICAgIGlmIChzZWVkKSBmYWlsKCdDYW5ub3Qgc3BlY2lmeSBib3RoIC0tY291bnQgYW5kIC0tc2VlZCcpO1xuICAgIGlmICghLyVbc2NdLy50ZXN0KG91dHB1dCkpIHtcbiAgICAgIGZhaWwoJy0tb3V0cHV0IG11c3QgaGF2ZSBhICVjIG9yICVzIHBsYWNlaG9sZGVyIHdoZW4gLS1jb3VudCBpcyBnaXZlbicpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGZsYWdzZXQgPSBuZXcgRmxhZ1NldChmbGFncyk7XG4gIGNvbnN0IHJvbSA9IG5ldyBVaW50OEFycmF5KGZzLnJlYWRGaWxlU3luYyhhcmdzWzBdKS5idWZmZXIpO1xuICBpZiAoY3JjMzIocm9tKSAhPSBFWFBFQ1RFRF9DUkMzMikge1xuICAgIGNvbnNvbGUuZXJyb3IoYFdBUk5JTkc6IEJhZCBDUkMgZm9yIGlucHV0IHJvbTogJHtjcmMzMihyb20pLnRvU3RyaW5nKDE2KX1gKTtcbiAgICBpZiAoIWZvcmNlKSBmYWlsKCdSdW4gd2l0aCAtLWZvcmNlIHRvIHByb2NlZWQgYW55d2F5Jyk7XG4gICAgY29uc29sZS5lcnJvcignUHJvY2VlZGluZyBhbnl3YXknKTtcbiAgfVxuXG4gIHJldHVybiBQcm9taXNlLmFsbChuZXcgQXJyYXkoY291bnQpLmZpbGwoMCkubWFwKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBzID0gcGF0Y2gucGFyc2VTZWVkKHNlZWQpO1xuICAgIGNvbnNvbGUubG9nKGBTZWVkOiAke3MudG9TdHJpbmcoMTYpfWApO1xuICAgIGNvbnN0IG9yaWcgPSByb20uc2xpY2UoKTtcbiAgICBjb25zdCBbc2h1ZmZsZWQsIGNdID1cbiAgICAgICAgYXdhaXQgcGF0Y2guc2h1ZmZsZShvcmlnLCBzLCBmbGFnc2V0LCBuZXcgTm9kZVJlYWRlcigpKTtcbiAgICBjb25zdCBuID0gYXJnc1swXS5yZXBsYWNlKCcubmVzJywgJycpO1xuICAgIGNvbnN0IGYgPSBTdHJpbmcoZmxhZ3NldCkucmVwbGFjZSgvIC9nLCAnJyk7XG4gICAgY29uc3QgdiA9IHZlcnNpb24uVkVSU0lPTjtcbiAgICBjb25zdCBmaWxlbmFtZSA9IGZpbGxUZW1wbGF0ZShvdXRwdXQsIHtjLCBuLCBzLCB2LCBmLCAnJSc6ICclJ30pICsgJy5uZXMnO1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKFxuICAgICAgICAocmVzb2x2ZSwgcmVqZWN0KSA9PiBmcy53cml0ZUZpbGUoXG4gICAgICAgICAgICBmaWxlbmFtZSwgc2h1ZmZsZWQsIChlcnIpID0+IGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZSgpKSk7XG4gICAgY29uc29sZS5sb2coYFdyb3RlICR7ZmlsZW5hbWV9YCk7XG4gIH0pKTtcbn07XG5cbmZ1bmN0aW9uIGZhaWwobWVzc2FnZTogc3RyaW5nKTogbmV2ZXIge1xuICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpO1xuICB0aHJvdyBwcm9jZXNzLmV4aXQoMik7XG59XG5cbmZ1bmN0aW9uIGZpbGxUZW1wbGF0ZShzdHI6IHN0cmluZywgYXJnOiB7W2tleTogc3RyaW5nXTogdW5rbm93bn0pOiBzdHJpbmcge1xuICBjb25zdCB0ZXJtcyA9IFtdO1xuICB3aGlsZSAoc3RyKSB7XG4gICAgY29uc3QgaW5kZXggPSBzdHIuaW5kZXhPZignJScpO1xuICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgIHRlcm1zLnB1c2goc3RyKTtcbiAgICAgIHN0ciA9ICcnO1xuICAgIH0gZWxzZSB7XG4gICAgICB0ZXJtcy5wdXNoKHN0ci5zdWJzdHJpbmcoMCwgaW5kZXgpKTtcbiAgICAgIGNvbnN0IGNoID0gc3RyW2luZGV4ICsgMV07XG4gICAgICBpZiAoIShjaCBpbiBhcmcpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBwbGFjZWhvbGRlcjogJSR7Y2h9YCk7XG4gICAgICB0ZXJtcy5wdXNoKGFyZ1tjaF0pO1xuICAgICAgc3RyID0gc3RyLnN1YnN0cmluZyhpbmRleCArIDIpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdGVybXMuam9pbignJyk7XG59XG5cbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChlcnJvcjogYW55KSA9PiB7XG4gIGNvbnNvbGUuZXJyb3IoXG4gICAgICB0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnID9cbiAgICAgICAgICBlcnJvciA6XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBVc2FnZUVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLnN0YWNrKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufSk7XG5cbmNvbnN0IGFzeW5jTWFpbiA9XG4gICAgYXN5bmMgKCkgPT4ge1xuICB0cnkge1xuICAgIGF3YWl0IG1haW4oLi4ucHJvY2Vzcy5hcmd2LnNsaWNlKDIpKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVc2FnZUVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgY29uc29sZS5lcnJvcihgVHJ5IHBhc3NpbmcgLS1oZWxwIGZvciBkb2N1bWVudGF0aW9uLmApO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG5hc3luY01haW4oKS50aGVuKCgpID0+IHByb2Nlc3MuZXhpdCgwKSk7XG4iXX0=