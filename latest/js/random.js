const IM1 = 2147483563;
const IM2 = 2147483399;
const AM = 1 / IM1;
const IMM1 = IM1 - 1;
const IA1 = 40014;
const IA2 = 40692;
const IQ1 = 53668;
const IQ2 = 52774;
const IR1 = 12211;
const IR2 = 3791;
const NTAB = 32;
const NDIV = 1 + Math.floor(IMM1 / NTAB);
const EPS = 1.2e-7;
const RNMX = 1 - EPS;
export class Random {
    constructor(seed = Math.floor(Math.random() * 0x100000000)) {
        this.idum = 0;
        this.idum2 = 0;
        this.iy = 0;
        this.iv = [];
        this.z1 = null;
        this.seed(seed);
    }
    static newSeed() {
        return Math.floor(Math.random() * 0x100000000);
    }
    seed(seed) {
        this.idum = Math.max(1, Math.floor(seed));
        this.idum2 = this.idum;
        this.iy = 0;
        this.iv = new Array(NTAB).fill(0);
        for (let j = NTAB + 7; j >= 0; j--) {
            const k = Math.floor(this.idum / IQ1);
            this.idum = IA1 * (this.idum - k * IQ1) - k * IR1;
            if (this.idum < 0)
                this.idum += IM1;
            if (j < NTAB)
                this.iv[j] = this.idum;
        }
        this.iy = this.iv[0];
    }
    next() {
        let k = Math.floor(this.idum / IQ1);
        this.idum = IA1 * (this.idum - k * IQ1) - k * IR1;
        if (this.idum < 0)
            this.idum += IM1;
        k = Math.floor(this.idum2 / IQ2);
        this.idum2 = IA2 * (this.idum2 - k * IQ2) - k * IR2;
        if (this.idum2 < 0)
            this.idum2 += IM2;
        const j = Math.floor(this.iy / NDIV);
        this.iy = this.iv[j] - this.idum2;
        this.iv[j] = this.idum;
        if (this.iy < 1)
            this.iy += IMM1;
        return Math.min(AM * this.iy, RNMX);
    }
    nextInt(n) {
        return Math.floor(this.next() * n);
    }
    nextNormal(mean = 0, stdev = 1, min = -Infinity, max = Infinity) {
        while (true) {
            let z = this.z1;
            if (z == null) {
                const r = Math.sqrt(-2 * Math.log(this.next()));
                const theta = TWOPI * this.next();
                z = r * Math.cos(theta);
                this.z1 = r * Math.sin(theta);
            }
            else {
                this.z1 = null;
            }
            z = mean + z * stdev;
            if (z >= min && z <= max)
                return z;
        }
    }
    shuffle(array) {
        for (let i = array.length; i;) {
            const j = this.nextInt(i--);
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    *ishuffle(iterable) {
        const arr = [];
        if (!Array.isArray(iterable)) {
            if (hasSize(iterable)) {
                const iter = iterable[Symbol.iterator]();
                for (let i = 0; i < iterable.size; i++) {
                    const j = this.nextInt(iterable.size - i);
                    const k = Math.max(i, j);
                    while (arr.length <= k) {
                        arr.push(iter.next().value);
                    }
                    yield arr[j];
                    arr[j] = arr[i];
                }
                return;
            }
            else {
                iterable = [...iterable];
            }
        }
        if (!Array.isArray(iterable))
            throw new Error('impossible');
        for (let i = 0; i < iterable.length; i++) {
            const j = i + this.nextInt(iterable.length - i);
            yield j in arr ? arr[j] : iterable[j];
            arr[j] = i in arr ? arr[i] : iterable[i];
        }
    }
    pick(arr) {
        if (!arr.length)
            throw new Error('empty array');
        return arr[this.nextInt(arr.length)];
    }
    pickWeighted(arr) {
        if (!arr.length)
            throw new Error('empty array');
        let total = 0;
        for (const [weight] of arr)
            total += weight;
        let choice = this.next() * total;
        for (const [weight, elem] of arr) {
            if (choice < weight)
                return elem;
            choice -= weight;
        }
        throw new Error('bad weights');
    }
    bitGenerator() {
        let bits = 0;
        let next = 0;
        return () => {
            if (!bits) {
                bits = 32;
                next = this.nextInt(0x100000000);
            }
            bits--;
            const result = !(next & 1);
            next >>>= 1;
            return result;
        };
    }
}
function hasSize(iter) {
    return 'size' in iter;
}
const TWOPI = 2 * Math.PI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFuZG9tLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2pzL3JhbmRvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUM7QUFDdkIsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDO0FBQ3ZCLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDbkIsTUFBTSxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztBQUNyQixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUM7QUFDbEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDO0FBQ2xCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQztBQUNsQixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUM7QUFDbEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDO0FBQ2xCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQztBQUNqQixNQUFNLElBQUksR0FBRyxFQUFFLENBQUM7QUFDaEIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQztBQUNuQixNQUFNLElBQUksR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBRXJCLE1BQU0sT0FBTyxNQUFNO0lBYWpCLFlBQVksT0FBZSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxXQUFXLENBQUM7UUFOMUQsU0FBSSxHQUFXLENBQUMsQ0FBQztRQUNqQixVQUFLLEdBQVcsQ0FBQyxDQUFDO1FBQ2xCLE9BQUUsR0FBVyxDQUFDLENBQUM7UUFDZixPQUFFLEdBQWEsRUFBRSxDQUFDO1FBQ2xCLE9BQUUsR0FBa0IsSUFBSSxDQUFDO1FBRy9CLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQVpELE1BQU0sQ0FBQyxPQUFPO1FBQ1osT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxXQUFXLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBWUQsSUFBSSxDQUFDLElBQVk7UUFDZixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDWixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQyxLQUFLLElBQUksQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNsQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDdEMsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO1lBQ2xELElBQUksSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDO2dCQUFFLElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxHQUFHLElBQUk7Z0JBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ3RDO1FBQ0QsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxJQUFJO1FBQ0YsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUNsRCxJQUFJLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQztZQUFFLElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDO1FBQ3BDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ3BELElBQUksSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDO1lBQUUsSUFBSSxDQUFDLEtBQUssSUFBSSxHQUFHLENBQUM7UUFDdEMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN2QixJQUFJLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQztZQUFFLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQsT0FBTyxDQUFDLENBQVM7UUFDZixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCxVQUFVLENBQUMsT0FBZSxDQUFDLEVBQ2hCLFFBQWdCLENBQUMsRUFDakIsTUFBYyxDQUFDLFFBQVEsRUFDdkIsTUFBYyxRQUFRO1FBQy9CLE9BQU8sSUFBSSxFQUFFO1lBQ1gsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUU7Z0JBQ2IsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hELE1BQU0sS0FBSyxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2xDLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDeEIsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUMvQjtpQkFBTTtnQkFDTCxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQzthQUNoQjtZQUNELENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUc7Z0JBQUUsT0FBTyxDQUFDLENBQUM7U0FDcEM7SUFDSCxDQUFDO0lBRUQsT0FBTyxDQUFtQyxLQUFRO1FBQ2hELEtBQUssSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUc7WUFDN0IsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzVCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzdDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBR0QsQ0FBRSxRQUFRLENBQUksUUFBcUI7UUFDakMsTUFBTSxHQUFHLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzVCLElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNyQixNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7Z0JBQ3pDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUN0QyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQzFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUN6QixPQUFPLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO3dCQUN0QixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztxQkFDN0I7b0JBQ0QsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2IsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDakI7Z0JBQ0QsT0FBTzthQUNSO2lCQUFNO2dCQUNMLFFBQVEsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUM7YUFDMUI7U0FDRjtRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDNUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNoRCxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMxQztJQUNILENBQUM7SUFFRCxJQUFJLENBQUksR0FBaUI7UUFDdkIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNoRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxZQUFZLENBQUksR0FBd0M7UUFDdEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNoRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxLQUFLLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHO1lBQUUsS0FBSyxJQUFJLE1BQU0sQ0FBQztRQUM1QyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQ2pDLEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUU7WUFDaEMsSUFBSSxNQUFNLEdBQUcsTUFBTTtnQkFBRSxPQUFPLElBQUksQ0FBQztZQUNqQyxNQUFNLElBQUksTUFBTSxDQUFDO1NBQ2xCO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQsWUFBWTtRQUNWLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztRQUNiLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztRQUNiLE9BQU8sR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDVCxJQUFJLEdBQUcsRUFBRSxDQUFDO2dCQUNWLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQ2xDO1lBQ0QsSUFBSSxFQUFFLENBQUM7WUFDUCxNQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzNCLElBQUksTUFBTSxDQUFDLENBQUE7WUFDWCxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFLRCxTQUFTLE9BQU8sQ0FBSSxJQUFpQjtJQUNuQyxPQUFPLE1BQU0sSUFBSSxJQUFJLENBQUM7QUFDeEIsQ0FBQztBQUVELE1BQU0sS0FBSyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgSU0xID0gMjE0NzQ4MzU2MztcbmNvbnN0IElNMiA9IDIxNDc0ODMzOTk7XG5jb25zdCBBTSA9IDEgLyBJTTE7XG5jb25zdCBJTU0xID0gSU0xIC0gMTtcbmNvbnN0IElBMSA9IDQwMDE0O1xuY29uc3QgSUEyID0gNDA2OTI7XG5jb25zdCBJUTEgPSA1MzY2ODtcbmNvbnN0IElRMiA9IDUyNzc0O1xuY29uc3QgSVIxID0gMTIyMTE7XG5jb25zdCBJUjIgPSAzNzkxO1xuY29uc3QgTlRBQiA9IDMyO1xuY29uc3QgTkRJViA9IDEgKyBNYXRoLmZsb29yKElNTTEgLyBOVEFCKTtcbmNvbnN0IEVQUyA9IDEuMmUtNztcbmNvbnN0IFJOTVggPSAxIC0gRVBTO1xuXG5leHBvcnQgY2xhc3MgUmFuZG9tIHtcblxuICAvLyBSZXR1cm5zIGEgbmV3IHNlZWQgYXQgcmFuZG9tLCB1c2luZyB0aGUgc3lzdGVtIFBSTkcuXG4gIHN0YXRpYyBuZXdTZWVkKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwKTtcbiAgfVxuXG4gIHByaXZhdGUgaWR1bTogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBpZHVtMjogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBpeTogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBpdjogbnVtYmVyW10gPSBbXTtcbiAgcHJpdmF0ZSB6MTogbnVtYmVyIHwgbnVsbCA9IG51bGw7IC8vIGV4dHJhIG5vcm1hbCBkZXZpYXRlXG5cbiAgY29uc3RydWN0b3Ioc2VlZDogbnVtYmVyID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMHgxMDAwMDAwMDApKSB7XG4gICAgdGhpcy5zZWVkKHNlZWQpO1xuICB9XG5cbiAgc2VlZChzZWVkOiBudW1iZXIpIHtcbiAgICB0aGlzLmlkdW0gPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKHNlZWQpKTtcbiAgICB0aGlzLmlkdW0yID0gdGhpcy5pZHVtO1xuICAgIHRoaXMuaXkgPSAwO1xuICAgIHRoaXMuaXYgPSBuZXcgQXJyYXkoTlRBQikuZmlsbCgwKTtcbiAgICBmb3IgKGxldCBqID0gTlRBQiArIDc7IGogPj0gMDsgai0tKSB7XG4gICAgICBjb25zdCBrID0gTWF0aC5mbG9vcih0aGlzLmlkdW0gLyBJUTEpO1xuICAgICAgdGhpcy5pZHVtID0gSUExICogKHRoaXMuaWR1bSAtIGsgKiBJUTEpIC0gayAqIElSMTtcbiAgICAgIGlmICh0aGlzLmlkdW0gPCAwKSB0aGlzLmlkdW0gKz0gSU0xO1xuICAgICAgaWYgKGogPCBOVEFCKSB0aGlzLml2W2pdID0gdGhpcy5pZHVtO1xuICAgIH1cbiAgICB0aGlzLml5ID0gdGhpcy5pdlswXTtcbiAgfVxuXG4gIG5leHQoKTogbnVtYmVyIHtcbiAgICBsZXQgayA9IE1hdGguZmxvb3IodGhpcy5pZHVtIC8gSVExKTtcbiAgICB0aGlzLmlkdW0gPSBJQTEgKiAodGhpcy5pZHVtIC0gayAqIElRMSkgLSBrICogSVIxO1xuICAgIGlmICh0aGlzLmlkdW0gPCAwKSB0aGlzLmlkdW0gKz0gSU0xO1xuICAgIGsgPSBNYXRoLmZsb29yKHRoaXMuaWR1bTIgLyBJUTIpO1xuICAgIHRoaXMuaWR1bTIgPSBJQTIgKiAodGhpcy5pZHVtMiAtIGsgKiBJUTIpIC0gayAqIElSMjtcbiAgICBpZiAodGhpcy5pZHVtMiA8IDApIHRoaXMuaWR1bTIgKz0gSU0yO1xuICAgIGNvbnN0IGogPSBNYXRoLmZsb29yKHRoaXMuaXkgLyBORElWKTtcbiAgICB0aGlzLml5ID0gdGhpcy5pdltqXSAtIHRoaXMuaWR1bTI7XG4gICAgdGhpcy5pdltqXSA9IHRoaXMuaWR1bTtcbiAgICBpZiAodGhpcy5peSA8IDEpIHRoaXMuaXkgKz0gSU1NMTtcbiAgICByZXR1cm4gTWF0aC5taW4oQU0gKiB0aGlzLml5LCBSTk1YKTtcbiAgfVxuXG4gIG5leHRJbnQobjogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTWF0aC5mbG9vcih0aGlzLm5leHQoKSAqIG4pO1xuICB9XG5cbiAgbmV4dE5vcm1hbChtZWFuOiBudW1iZXIgPSAwLFxuICAgICAgICAgICAgIHN0ZGV2OiBudW1iZXIgPSAxLFxuICAgICAgICAgICAgIG1pbjogbnVtYmVyID0gLUluZmluaXR5LFxuICAgICAgICAgICAgIG1heDogbnVtYmVyID0gSW5maW5pdHkpIHtcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgbGV0IHogPSB0aGlzLnoxO1xuICAgICAgaWYgKHogPT0gbnVsbCkge1xuICAgICAgICBjb25zdCByID0gTWF0aC5zcXJ0KC0yICogTWF0aC5sb2codGhpcy5uZXh0KCkpKTtcbiAgICAgICAgY29uc3QgdGhldGEgPSBUV09QSSAqIHRoaXMubmV4dCgpO1xuICAgICAgICB6ID0gciAqIE1hdGguY29zKHRoZXRhKTtcbiAgICAgICAgdGhpcy56MSA9IHIgKiBNYXRoLnNpbih0aGV0YSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnoxID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIHogPSBtZWFuICsgeiAqIHN0ZGV2O1xuICAgICAgaWYgKHogPj0gbWluICYmIHogPD0gbWF4KSByZXR1cm4gejtcbiAgICB9XG4gIH1cblxuICBzaHVmZmxlPFQgZXh0ZW5kcyB1bmtub3duW10gfCBVaW50OEFycmF5PihhcnJheTogVCk6IFQge1xuICAgIGZvciAobGV0IGkgPSBhcnJheS5sZW5ndGg7IGk7KSB7XG4gICAgICBjb25zdCBqID0gdGhpcy5uZXh0SW50KGktLSk7XG4gICAgICBbYXJyYXlbaV0sIGFycmF5W2pdXSA9IFthcnJheVtqXSwgYXJyYXlbaV1dO1xuICAgIH1cbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICAvKiogRG9lcyBub3QgZGVzdHJveSB0aGUgaW5wdXQgaXRlcmFibGUuICovXG4gICogaXNodWZmbGU8VD4oaXRlcmFibGU6IEl0ZXJhYmxlPFQ+KTogSXRlcmFibGVJdGVyYXRvcjxUPiB7XG4gICAgY29uc3QgYXJyOiBUW10gPSBbXTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoaXRlcmFibGUpKSB7XG4gICAgICBpZiAoaGFzU2l6ZShpdGVyYWJsZSkpIHtcbiAgICAgICAgY29uc3QgaXRlciA9IGl0ZXJhYmxlW1N5bWJvbC5pdGVyYXRvcl0oKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVyYWJsZS5zaXplOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBqID0gdGhpcy5uZXh0SW50KGl0ZXJhYmxlLnNpemUgLSBpKTtcbiAgICAgICAgICBjb25zdCBrID0gTWF0aC5tYXgoaSwgaik7XG4gICAgICAgICAgd2hpbGUgKGFyci5sZW5ndGggPD0gaykge1xuICAgICAgICAgICAgYXJyLnB1c2goaXRlci5uZXh0KCkudmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB5aWVsZCBhcnJbal07XG4gICAgICAgICAgYXJyW2pdID0gYXJyW2ldO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjsgLy8gVE9ETyAtIHdoeSB3YXMgdGhpcyBub3QgcmVxdWlyZWQ/XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpdGVyYWJsZSA9IFsuLi5pdGVyYWJsZV07XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghQXJyYXkuaXNBcnJheShpdGVyYWJsZSkpIHRocm93IG5ldyBFcnJvcignaW1wb3NzaWJsZScpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlcmFibGUubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGogPSBpICsgdGhpcy5uZXh0SW50KGl0ZXJhYmxlLmxlbmd0aCAtIGkpO1xuICAgICAgeWllbGQgaiBpbiBhcnIgPyBhcnJbal0gOiBpdGVyYWJsZVtqXTtcbiAgICAgIGFycltqXSA9IGkgaW4gYXJyID8gYXJyW2ldIDogaXRlcmFibGVbaV07XG4gICAgfVxuICB9XG5cbiAgcGljazxUPihhcnI6IHJlYWRvbmx5IFRbXSk6IFQge1xuICAgIGlmICghYXJyLmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdlbXB0eSBhcnJheScpO1xuICAgIHJldHVybiBhcnJbdGhpcy5uZXh0SW50KGFyci5sZW5ndGgpXTtcbiAgfVxuXG4gIHBpY2tXZWlnaHRlZDxUPihhcnI6IFJlYWRvbmx5QXJyYXk8cmVhZG9ubHkgW251bWJlciwgVF0+KTogVCB7XG4gICAgaWYgKCFhcnIubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ2VtcHR5IGFycmF5Jyk7XG4gICAgbGV0IHRvdGFsID0gMDtcbiAgICBmb3IgKGNvbnN0IFt3ZWlnaHRdIG9mIGFycikgdG90YWwgKz0gd2VpZ2h0O1xuICAgIGxldCBjaG9pY2UgPSB0aGlzLm5leHQoKSAqIHRvdGFsO1xuICAgIGZvciAoY29uc3QgW3dlaWdodCwgZWxlbV0gb2YgYXJyKSB7XG4gICAgICBpZiAoY2hvaWNlIDwgd2VpZ2h0KSByZXR1cm4gZWxlbTtcbiAgICAgIGNob2ljZSAtPSB3ZWlnaHQ7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcignYmFkIHdlaWdodHMnKTtcbiAgfVxuXG4gIGJpdEdlbmVyYXRvcigpOiAoKSA9PiBib29sZWFuIHtcbiAgICBsZXQgYml0cyA9IDA7XG4gICAgbGV0IG5leHQgPSAwO1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAoIWJpdHMpIHtcbiAgICAgICAgYml0cyA9IDMyO1xuICAgICAgICBuZXh0ID0gdGhpcy5uZXh0SW50KDB4MTAwMDAwMDAwKTtcbiAgICAgIH1cbiAgICAgIGJpdHMtLTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9ICEobmV4dCAmIDEpO1xuICAgICAgbmV4dCA+Pj49IDFcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgSGFzU2l6ZTxUPiBleHRlbmRzIEl0ZXJhYmxlPFQ+IHtcbiAgcmVhZG9ubHkgc2l6ZTogbnVtYmVyO1xufVxuZnVuY3Rpb24gaGFzU2l6ZTxUPihpdGVyOiBJdGVyYWJsZTxUPik6IGl0ZXIgaXMgSGFzU2l6ZTxUPiB7XG4gIHJldHVybiAnc2l6ZScgaW4gaXRlcjtcbn1cblxuY29uc3QgVFdPUEkgPSAyICogTWF0aC5QSTtcblxuLy8gLy8gUHJvdmlkZSBhIHN0YXRpYyBzaW5nbGV0b24gaW5zdGFuY2UuXG4vLyBsZXQgcmFuZG9tID0gKCgpID0+IHtcbi8vICAgbGV0IHNlZWQgPSAwO1xuLy8gICBpZiAod2luZG93ICYmIHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaCkge1xuLy8gICAgIGZvciAoY29uc3QgY29tcG9uZW50IG9mIHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cmluZygxKS5zcGxpdCgnJicpKSB7XG4vLyAgICAgICBjb25zdCBzcGxpdCA9IGNvbXBvbmVudC5zcGxpdCgnPScpO1xuLy8gICAgICAgaWYgKHNwbGl0WzBdID09PSAnc2VlZCcpIHtcbi8vICAgICAgICAgc2VlZCA9IE51bWJlcihzcGxpdFsxXSkgfHwgMDtcbi8vICAgICAgIH1cbi8vICAgICB9XG4vLyAgIH1cbi8vICAgaWYgKCFzZWVkKSB7XG4vLyAgICAgc2VlZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwKTtcbi8vICAgfVxuLy8gICByZXR1cm4gbmV3IFJhbmRvbShzZWVkKTtcbi8vIH0pKCk7XG4vLyBSYW5kb20ubmV4dEludCA9IChuKSA9PiByYW5kb20ubmV4dEludChuKTtcbi8vIFJhbmRvbS5uZXh0ID0gKCkgPT4gcmFuZG9tLm5leHQoKTtcbi8vIFJhbmRvbS5zZWVkID0gKHMpID0+IHJhbmRvbS5zZWVkKHMpO1xuIl19