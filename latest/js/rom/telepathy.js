import { MessageId } from './messageid.js';
import { readBigEndian, readLittleEndian, seq, tuple, write, writeLittleEndian } from './util.js';
export var Sage;
(function (Sage) {
    Sage[Sage["TORNEL"] = 0] = "TORNEL";
    Sage[Sage["ZEBU"] = 1] = "ZEBU";
    Sage[Sage["ASINA"] = 2] = "ASINA";
    Sage[Sage["KENSU"] = 3] = "KENSU";
})(Sage || (Sage = {}));
export var DefaultMessage;
(function (DefaultMessage) {
    DefaultMessage[DefaultMessage["INSUFFICIENT_MAGIC"] = 0] = "INSUFFICIENT_MAGIC";
    DefaultMessage[DefaultMessage["FREE_MAGIC"] = 1] = "FREE_MAGIC";
    DefaultMessage[DefaultMessage["IGNORED"] = 2] = "IGNORED";
    DefaultMessage[DefaultMessage["DEFAULT"] = 3] = "DEFAULT";
})(DefaultMessage || (DefaultMessage = {}));
const RESULT_TABLE = 0x1c22f;
const VANILLA_LEVELS_TABLE = 0x1c213;
const VANILLA_LOCATION_TABLE = 0x1d8f4;
const VANILLA_MAIN_TABLE = 0x1d9f4;
const VANILLA_DEFAULTS_TABLE = 0x1da2c;
export class Telepathy {
    constructor(rom) {
        this.rom = rom;
        this.sages = seq(4, i => new SageData(this, i));
        this.resultTable = tuple(rom.prg, RESULT_TABLE, 64);
        if (rom.telepathyTablesAddress) {
            this.groupsByLocation = [];
            this.minimumLevels = [];
        }
        else {
            this.groupsByLocation = tuple(rom.prg, VANILLA_LOCATION_TABLE, 256);
            this.minimumLevels = tuple(rom.prg, VANILLA_LEVELS_TABLE, 7);
        }
    }
    write(writer) {
        let table = this.rom.telepathyTablesAddress;
        const promises = [];
        if (table) {
            write(writer.rom, RESULT_TABLE, this.resultTable.map(x => x < 4 ? x : x >>> 1));
            for (let i = 0; i < 4; i++) {
                const sage = this.sages[i];
                for (let j = 1; j < 4; j++) {
                    const a = table + 8 * j + 2 * i;
                    write(writer.rom, a, this.sages[i].defaultMessages[j].data);
                }
                promises.push(writer.write(sage.messageGroups[0].bytes(), 0x1c000, 0x1e000, `Sage ${i}`)
                    .then(a => writeLittleEndian(writer.rom, table + 2 * i, a - 0x14000)));
            }
        }
        else {
            write(writer.rom, RESULT_TABLE, this.resultTable);
            write(writer.rom, VANILLA_LEVELS_TABLE, this.minimumLevels);
            write(writer.rom, VANILLA_LOCATION_TABLE, this.groupsByLocation);
            for (let i = 0; i < 4; i++) {
                const sage = this.sages[i];
                table = VANILLA_DEFAULTS_TABLE + 2 * i;
                for (let j = 0; j < 4; j++) {
                    write(writer.rom, table + 8 * j, sage.defaultMessages[j].data);
                }
                table = VANILLA_MAIN_TABLE + 2 * i;
                for (let j = 0, len = sage.messageGroups.length; j < len; j++) {
                    promises.push(writer.write(sage.messageGroups[j].bytes(), 0x1c000, 0x1e000, `Sage ${i}`)
                        .then(a => writeLittleEndian(writer.rom, table + 8 * j, a - 0x14000)));
                }
            }
        }
        return Promise.all(promises).then(() => { });
    }
}
export class SageData {
    constructor(telepathy, sage) {
        this.telepathy = telepathy;
        this.sage = sage;
        const rom = telepathy.rom;
        let defs;
        let main;
        let count;
        if (rom.telepathyTablesAddress) {
            main = defs = rom.telepathyTablesAddress + 2 * sage;
            count = 1;
        }
        else {
            defs = VANILLA_DEFAULTS_TABLE + 2 * sage;
            main = VANILLA_MAIN_TABLE + 2 * sage;
            count = 7;
        }
        this.defaultMessages = seq(4, i => MessageId.from(rom.prg, defs + 8 * i));
        this.messageGroups = seq(count, i => TelepathyMessageGroup.from(rom.prg, main + 8 * i));
    }
}
export class TelepathyMessageGroup {
    constructor(messages) {
        this.messages = messages;
    }
    bytes() {
        const bytes = [];
        for (let i = 0, len = this.messages.length; i < len; i++) {
            const [f, m1, m2] = this.messages[i];
            let word = f >= 0 ? f : 0x2000 | ~f;
            if (i === len - 1)
                word |= 0x8000;
            if (m2)
                word |= 0x4000;
            bytes.push(word >>= 8, word & 0xff, ...m1.data, ...(m2 ? m2.data : []));
        }
        return bytes;
    }
    static from(data, address) {
        const group = new TelepathyMessageGroup([]);
        address = readLittleEndian(data, address) + 0x14000;
        let word = 0;
        while (!(word & 0x8000)) {
            word = readBigEndian(data, address);
            address += 2;
            let flag = word & 0x1fff;
            if (word & 0x2000)
                flag = ~flag;
            const message = [flag, MessageId.from(data, address)];
            address += 2;
            if (word & 0x4000) {
                message.push(MessageId.from(data, address));
                address += 2;
            }
            group.messages.push(message);
        }
        return group;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVsZXBhdGh5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3JvbS90ZWxlcGF0aHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3pDLE9BQU8sRUFBTyxhQUFhLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFJdEcsTUFBTSxDQUFOLElBQVksSUFLWDtBQUxELFdBQVksSUFBSTtJQUNkLG1DQUFVLENBQUE7SUFDViwrQkFBVSxDQUFBO0lBQ1YsaUNBQVUsQ0FBQTtJQUNWLGlDQUFVLENBQUE7QUFDWixDQUFDLEVBTFcsSUFBSSxLQUFKLElBQUksUUFLZjtBQUVELE1BQU0sQ0FBTixJQUFZLGNBU1g7QUFURCxXQUFZLGNBQWM7SUFFeEIsK0VBQXNCLENBQUE7SUFFdEIsK0RBQXNCLENBQUE7SUFFdEIseURBQXNCLENBQUE7SUFFdEIseURBQXNCLENBQUE7QUFDeEIsQ0FBQyxFQVRXLGNBQWMsS0FBZCxjQUFjLFFBU3pCO0FBRUQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDO0FBUTdCLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDO0FBQ3JDLE1BQU0sc0JBQXNCLEdBQUcsT0FBTyxDQUFDO0FBQ3ZDLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDO0FBQ25DLE1BQU0sc0JBQXNCLEdBQUcsT0FBTyxDQUFDO0FBRXZDLE1BQU0sT0FBTyxTQUFTO0lBUXBCLFlBQXFCLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxX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QUFDLENBQUM7WUFDYixJQUFJLElBQUksR0FBRyxNQUFNLEVBQUU7Z0JBQ2pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDNUMsT0FBTyxJQUFJLENBQUMsQ0FBQzthQUNkO1lBQ0QsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDOUI7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7TWVzc2FnZUlkfSBmcm9tICcuL21lc3NhZ2VpZC5qcyc7XG5pbXBvcnQge0RhdGEsIHJlYWRCaWdFbmRpYW4sIHJlYWRMaXR0bGVFbmRpYW4sIHNlcSwgdHVwbGUsIHdyaXRlLCB3cml0ZUxpdHRsZUVuZGlhbn0gZnJvbSAnLi91dGlsLmpzJztcbmltcG9ydCB7V3JpdGVyfSBmcm9tICcuL3dyaXRlci5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcblxuZXhwb3J0IGVudW0gU2FnZSB7XG4gIFRPUk5FTCA9IDAsXG4gIFpFQlUgICA9IDEsXG4gIEFTSU5BICA9IDIsXG4gIEtFTlNVICA9IDMsXG59XG5cbmV4cG9ydCBlbnVtIERlZmF1bHRNZXNzYWdlIHtcbiAgLy8gcHJvYmFibHkgdW51c2VkXG4gIElOU1VGRklDSUVOVF9NQUdJQyA9IDAsXG4gIC8vIG1lc3NhZ2UgZm9yIHJlc3RvcmluZyBNUFxuICBGUkVFX01BR0lDICAgICAgICAgPSAxLFxuICAvLyBzYWdlcyBpZ25vcmluZyB0aGUgcGxheWVyXG4gIElHTk9SRUQgICAgICAgICAgICA9IDIsXG4gIC8vIG5vIGluZm9ybWF0aW9uIChvciB1bmRlcmxldmVsZWQpXG4gIERFRkFVTFQgICAgICAgICAgICA9IDMsXG59XG5cbmNvbnN0IFJFU1VMVF9UQUJMRSA9IDB4MWMyMmY7XG5cbi8vIFRoZXNlIHRhYmxlcyBtYXkgYmUgbW92ZWQgaW4gdGhlIHJhbmRvbWl6ZWQgdmVyc2lvbi4gIFRoZSBsb2NhdGlvbnNcbi8vIGFuZCBsZXZlbHMgdGFibGVzIGFyZSBub3QgcmVsZXZhbnQsIHNvIHRoZXkncmUgcmVtb3ZlZCwgYWxvbmcgd2l0aFxuLy8gdGhlIHJlc3VsdC1tYXAgdGFibGUsIHdoaWNoIHdlIHNpbXBseSBhcHBseSBpbi1wbGFjZSB0byB0aGUgcmVzdWx0XG4vLyB0YWJsZSAod2hpY2ggaXMgbm90IG1vdmVkKS4gIEV2ZXJ5dGhpbmcgZWxzZSBpcyBjcnVuY2hlZCBkb3duIHRvXG4vLyBqdXN0IHRoZSBkZWZhdWx0cyB0YWJsZSwgYnkgcmVkdWNpbmcgdGhlIG1haW4gdGFibGUgaW50byBhIHNpbmdsZVxuLy8gbWVzc2FlIGdyb3VwIGFuZCBjcmFtbWluZyBpdCBpbnRvIHRoZSB1bnVzZWQgMCBzbG90LlxuY29uc3QgVkFOSUxMQV9MRVZFTFNfVEFCTEUgPSAweDFjMjEzO1xuY29uc3QgVkFOSUxMQV9MT0NBVElPTl9UQUJMRSA9IDB4MWQ4ZjQ7XG5jb25zdCBWQU5JTExBX01BSU5fVEFCTEUgPSAweDFkOWY0O1xuY29uc3QgVkFOSUxMQV9ERUZBVUxUU19UQUJMRSA9IDB4MWRhMmM7XG5cbmV4cG9ydCBjbGFzcyBUZWxlcGF0aHkge1xuXG4gIC8vIEluZGV4ZWQgYnkgU2FnZVxuICBzYWdlczogU2FnZURhdGFbXTtcbiAgZ3JvdXBzQnlMb2NhdGlvbjogbnVtYmVyW107XG4gIG1pbmltdW1MZXZlbHM6IG51bWJlcltdO1xuICByZXN1bHRUYWJsZTogbnVtYmVyW107XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcm9tOiBSb20pIHtcbiAgICB0aGlzLnNhZ2VzID0gc2VxKDQsIGkgPT4gbmV3IFNhZ2VEYXRhKHRoaXMsIGkpKTtcbiAgICB0aGlzLnJlc3VsdFRhYmxlID0gdHVwbGUocm9tLnByZywgUkVTVUxUX1RBQkxFLCA2NCk7XG4gICAgaWYgKHJvbS50ZWxlcGF0aHlUYWJsZXNBZGRyZXNzKSB7XG4gICAgICB0aGlzLmdyb3Vwc0J5TG9jYXRpb24gPSBbXTtcbiAgICAgIHRoaXMubWluaW11bUxldmVscyA9IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmdyb3Vwc0J5TG9jYXRpb24gPSB0dXBsZShyb20ucHJnLCBWQU5JTExBX0xPQ0FUSU9OX1RBQkxFLCAyNTYpO1xuICAgICAgdGhpcy5taW5pbXVtTGV2ZWxzID0gdHVwbGUocm9tLnByZywgVkFOSUxMQV9MRVZFTFNfVEFCTEUsIDcpO1xuICAgIH1cbiAgfVxuXG4gIHdyaXRlKHdyaXRlcjogV3JpdGVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgbGV0IHRhYmxlID0gdGhpcy5yb20udGVsZXBhdGh5VGFibGVzQWRkcmVzcztcbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuICAgIGlmICh0YWJsZSkge1xuICAgICAgLy8gdGVsZXBhdGh5IG5vcm1hbGl6ZWQsIHdyaXRlIHRvIG5ldyBsb2NhdGlvblxuICAgICAgLy8gYWxzbywgY3J1bmNoIGRvd24gdGhlIHJlc3VsdHMuXG4gICAgICB3cml0ZSh3cml0ZXIucm9tLCBSRVNVTFRfVEFCTEUsIHRoaXMucmVzdWx0VGFibGUubWFwKHggPT4geCA8IDQgPyB4IDogeCA+Pj4gMSkpO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgY29uc3Qgc2FnZSA9IHRoaXMuc2FnZXNbaV07XG4gICAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgNDsgaisrKSB7XG4gICAgICAgICAgY29uc3QgYSA9IHRhYmxlICsgOCAqIGogKyAyICogaTtcbiAgICAgICAgICB3cml0ZSh3cml0ZXIucm9tLCBhLCB0aGlzLnNhZ2VzW2ldLmRlZmF1bHRNZXNzYWdlc1tqXS5kYXRhKTtcbiAgICAgICAgfVxuICAgICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICAgICAgd3JpdGVyLndyaXRlKHNhZ2UubWVzc2FnZUdyb3Vwc1swXS5ieXRlcygpLCAweDFjMDAwLCAweDFlMDAwLCBgU2FnZSAke2l9YClcbiAgICAgICAgICAgICAgICAudGhlbihhID0+IHdyaXRlTGl0dGxlRW5kaWFuKHdyaXRlci5yb20sIHRhYmxlICsgMiAqIGksIGEgLSAweDE0MDAwKSkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB3cml0ZSh3cml0ZXIucm9tLCBSRVNVTFRfVEFCTEUsIHRoaXMucmVzdWx0VGFibGUpO1xuICAgICAgd3JpdGUod3JpdGVyLnJvbSwgVkFOSUxMQV9MRVZFTFNfVEFCTEUsIHRoaXMubWluaW11bUxldmVscyk7XG4gICAgICB3cml0ZSh3cml0ZXIucm9tLCBWQU5JTExBX0xPQ0FUSU9OX1RBQkxFLCB0aGlzLmdyb3Vwc0J5TG9jYXRpb24pO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgICAgY29uc3Qgc2FnZSA9IHRoaXMuc2FnZXNbaV07XG4gICAgICAgIHRhYmxlID0gVkFOSUxMQV9ERUZBVUxUU19UQUJMRSArIDIgKiBpO1xuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDQ7IGorKykge1xuICAgICAgICAgIHdyaXRlKHdyaXRlci5yb20sIHRhYmxlICsgOCAqIGosXG4gICAgICAgICAgICAgICAgc2FnZS5kZWZhdWx0TWVzc2FnZXNbal0uZGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgdGFibGUgPSBWQU5JTExBX01BSU5fVEFCTEUgKyAyICogaTtcbiAgICAgICAgZm9yIChsZXQgaiA9IDAsIGxlbiA9IHNhZ2UubWVzc2FnZUdyb3Vwcy5sZW5ndGg7IGogPCBsZW47IGorKykge1xuICAgICAgICAgIHByb21pc2VzLnB1c2goXG4gICAgICAgICAgICAgIHdyaXRlci53cml0ZShzYWdlLm1lc3NhZ2VHcm91cHNbal0uYnl0ZXMoKSwgMHgxYzAwMCwgMHgxZTAwMCwgYFNhZ2UgJHtpfWApXG4gICAgICAgICAgICAgICAgICAudGhlbihhID0+IHdyaXRlTGl0dGxlRW5kaWFuKHdyaXRlci5yb20sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlICsgOCAqIGosIGEgLSAweDE0MDAwKSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbigoKSA9PiB7fSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFNhZ2VEYXRhIHtcblxuICAvLyBJbmRleGVkIGJ5IERlZmF1bHRNZXNzYWdlXG4gIGRlZmF1bHRNZXNzYWdlczogTWVzc2FnZUlkW107XG4gIG1lc3NhZ2VHcm91cHM6IFRlbGVwYXRoeU1lc3NhZ2VHcm91cFtdO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHRlbGVwYXRoeTogVGVsZXBhdGh5LCByZWFkb25seSBzYWdlOiBTYWdlKSB7XG4gICAgY29uc3Qgcm9tID0gdGVsZXBhdGh5LnJvbTtcbiAgICBsZXQgZGVmczogbnVtYmVyO1xuICAgIGxldCBtYWluOiBudW1iZXI7XG4gICAgbGV0IGNvdW50OiBudW1iZXI7XG4gICAgaWYgKHJvbS50ZWxlcGF0aHlUYWJsZXNBZGRyZXNzKSB7XG4gICAgICBtYWluID0gZGVmcyA9IHJvbS50ZWxlcGF0aHlUYWJsZXNBZGRyZXNzICsgMiAqIHNhZ2U7XG4gICAgICBjb3VudCA9IDE7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlZnMgPSBWQU5JTExBX0RFRkFVTFRTX1RBQkxFICsgMiAqIHNhZ2U7XG4gICAgICBtYWluID0gVkFOSUxMQV9NQUlOX1RBQkxFICsgMiAqIHNhZ2U7XG4gICAgICBjb3VudCA9IDc7XG4gICAgfVxuICAgIHRoaXMuZGVmYXVsdE1lc3NhZ2VzID0gc2VxKDQsIGkgPT4gTWVzc2FnZUlkLmZyb20ocm9tLnByZywgZGVmcyArIDggKiBpKSk7XG4gICAgdGhpcy5tZXNzYWdlR3JvdXBzID0gc2VxKGNvdW50LCBpID0+IFRlbGVwYXRoeU1lc3NhZ2VHcm91cC5mcm9tKHJvbS5wcmcsIG1haW4gKyA4ICogaSkpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZWxlcGF0aHlNZXNzYWdlR3JvdXAge1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBtZXNzYWdlczogW251bWJlciwgTWVzc2FnZUlkLCBNZXNzYWdlSWQ/XVtdKSB7fVxuXG4gIGJ5dGVzKCk6IG51bWJlcltdIHtcbiAgICBjb25zdCBieXRlczogbnVtYmVyW10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gdGhpcy5tZXNzYWdlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgY29uc3QgW2YsIG0xLCBtMl0gPSB0aGlzLm1lc3NhZ2VzW2ldO1xuICAgICAgbGV0IHdvcmQgPSBmID49IDAgPyBmIDogMHgyMDAwIHwgfmY7XG4gICAgICBpZiAoaSA9PT0gbGVuIC0gMSkgd29yZCB8PSAweDgwMDA7XG4gICAgICBpZiAobTIpIHdvcmQgfD0gMHg0MDAwO1xuICAgICAgYnl0ZXMucHVzaCh3b3JkID4+PSA4LCB3b3JkICYgMHhmZiwgLi4ubTEuZGF0YSwgLi4uKG0yID8gbTIuZGF0YSA6IFtdKSk7XG4gICAgfVxuICAgIHJldHVybiBieXRlcztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tKGRhdGE6IERhdGE8bnVtYmVyPiwgYWRkcmVzczogbnVtYmVyKTogVGVsZXBhdGh5TWVzc2FnZUdyb3VwIHtcbiAgICAvLyBhZGRyZXNzIHBvaW50cyB0byBkYXRhIHRhYmxlIHBvaW50ZXIuXG4gICAgLy8gZnJvbSB0aGVyZSB3ZSByZWFkIGFsdGVybmF0aW5nIGZsYWdzIGFuZCBtZXNzYWdlIElEcy5cbiAgICBjb25zdCBncm91cCA9IG5ldyBUZWxlcGF0aHlNZXNzYWdlR3JvdXAoW10pO1xuICAgIGFkZHJlc3MgPSByZWFkTGl0dGxlRW5kaWFuKGRhdGEsIGFkZHJlc3MpICsgMHgxNDAwMDtcbiAgICBsZXQgd29yZCA9IDA7XG4gICAgd2hpbGUgKCEod29yZCAmIDB4ODAwMCkpIHtcbiAgICAgIHdvcmQgPSByZWFkQmlnRW5kaWFuKGRhdGEsIGFkZHJlc3MpO1xuICAgICAgYWRkcmVzcyArPSAyO1xuICAgICAgbGV0IGZsYWcgPSB3b3JkICYgMHgxZmZmO1xuICAgICAgaWYgKHdvcmQgJiAweDIwMDApIGZsYWcgPSB+ZmxhZztcbiAgICAgIGNvbnN0IG1lc3NhZ2U6IFtudW1iZXIsIE1lc3NhZ2VJZCwgTWVzc2FnZUlkP10gPVxuICAgICAgICAgIFtmbGFnLCBNZXNzYWdlSWQuZnJvbShkYXRhLCBhZGRyZXNzKV07XG4gICAgICBhZGRyZXNzICs9IDI7XG4gICAgICBpZiAod29yZCAmIDB4NDAwMCkge1xuICAgICAgICBtZXNzYWdlLnB1c2goTWVzc2FnZUlkLmZyb20oZGF0YSwgYWRkcmVzcykpO1xuICAgICAgICBhZGRyZXNzICs9IDI7XG4gICAgICB9XG4gICAgICBncm91cC5tZXNzYWdlcy5wdXNoKG1lc3NhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4gZ3JvdXA7XG4gIH1cbn1cbiJdfQ==