import { Entity } from './entity.js';
import { hex, readLittleEndian, seq, tuple } from './util.js';
const METASPRITE_TABLE = 0x3845c;
export class Metasprite extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.mirrored = null;
        this.pointer = METASPRITE_TABLE + (this.id << 1);
        this.base = readLittleEndian(rom.prg, this.pointer) + 0x30000;
        this.used = this.base >= 0x38000;
        if (rom.prg[this.base] === 0xff) {
            const target = readLittleEndian(rom.prg, this.base + 1);
            for (let i = 0; i < 256; i++) {
                if (readLittleEndian(rom.prg, METASPRITE_TABLE + (i << 1)) === target) {
                    this.mirrored = i;
                    break;
                }
            }
            if (this.mirrored == null) {
                throw new Error(`could not find mirrored sprite for ${hex(id)}: ${hex(target)}`);
            }
            this.size = 0;
            this.frameMask = 0;
            this.frames = 0;
            this.sprites = [];
        }
        else {
            this.mirrored = null;
            this.size = rom.prg[this.base];
            this.frameMask = rom.prg[this.base + 1];
            this.frames = this.frameMask + 1;
            this.sprites = seq(this.frames, f => {
                const a = this.base + 2 + f * 4 * this.size;
                const sprites = [];
                for (let i = 0; i < this.size; i++) {
                    if (rom.prg[a + 4 * i] === 0x80)
                        break;
                    sprites.push(tuple(rom.prg, a + 4 * i, 4));
                }
                return sprites;
            });
        }
    }
    patternBanks() {
        if (!this.used)
            return [];
        let ms = this;
        if (ms.mirrored) {
            ms = this.rom.metasprites[ms.mirrored];
        }
        const pats = new Set();
        for (const version of ms.sprites) {
            for (const [dx, , , pat] of version) {
                if (dx === 0x80)
                    break;
                pats.add(pat >>> 6);
            }
        }
        return [...pats];
    }
    palettes() {
        if (!this.used)
            return [];
        let ms = this;
        if (ms.mirrored) {
            ms = this.rom.metasprites[ms.mirrored];
        }
        const pals = new Set();
        for (const version of ms.sprites) {
            for (const [dx, , attr] of version) {
                if (dx === 0x80)
                    break;
                pals.add(attr & 3);
            }
        }
        return [...pals];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YXNwcml0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vbWV0YXNwcml0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBQyxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUc1RCxNQUFNLGdCQUFnQixHQUFHLE9BQU8sQ0FBQztBQUtqQyxNQUFNLE9BQU8sVUFBVyxTQUFRLE1BQU07SUFZcEMsWUFBWSxHQUFRLEVBQUUsRUFBVTtRQUM5QixLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBUmpCLGFBQVEsR0FBa0IsSUFBSSxDQUFDO1FBVTdCLElBQUksQ0FBQyxPQUFPLEdBQUcsZ0JBQWdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBQzlELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksSUFBSSxPQUFPLENBQUM7UUFFakMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFFL0IsTUFBTSxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3hELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQzVCLElBQUksZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxnQkFBZ0IsR0FB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QUFFO1lBQ2YsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUN4QztRQUNELE1BQU0sSUFBSSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDL0IsS0FBSyxNQUFNLE9BQU8sSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFO1lBQ2hDLEtBQUssTUFBTSxDQUFDLEVBQUUsRUFBRSxBQUFELEVBQUcsSUFBSSxDQUFDLElBQUksT0FBTyxFQUFFO2dCQUNsQyxJQUFJLEVBQUUsS0FBSyxJQUFJO29CQUFFLE1BQU07Z0JBQ3ZCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQ3BCO1NBQ0Y7UUFDRCxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNuQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0VudGl0eX0gZnJvbSAnLi9lbnRpdHkuanMnO1xuaW1wb3J0IHtoZXgsIHJlYWRMaXR0bGVFbmRpYW4sIHNlcSwgdHVwbGV9IGZyb20gJy4vdXRpbC5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcblxuY29uc3QgTUVUQVNQUklURV9UQUJMRSA9IDB4Mzg0NWM7XG5cbi8vIFtkeCwgZHksIGF0dHJpYnV0ZXMsIHBhdHRlcm4gaWRdXG50eXBlIFNwcml0ZSA9IFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdO1xuXG5leHBvcnQgY2xhc3MgTWV0YXNwcml0ZSBleHRlbmRzIEVudGl0eSB7XG5cbiAgcG9pbnRlcjogbnVtYmVyO1xuICBiYXNlOiBudW1iZXI7XG4gIHVzZWQ6IGJvb2xlYW47XG4gIG1pcnJvcmVkOiBudW1iZXIgfCBudWxsID0gbnVsbDtcbiAgc2l6ZTogbnVtYmVyO1xuICBmcmFtZU1hc2s6IG51bWJlcjtcbiAgZnJhbWVzOiBudW1iZXI7XG4gIC8vIGBzaXplYCBzcHJpdGVzIGZvciBlYWNoIGZyYW1lXG4gIHNwcml0ZXM6IFNwcml0ZVtdW107XG5cbiAgY29uc3RydWN0b3Iocm9tOiBSb20sIGlkOiBudW1iZXIpIHtcbiAgICBzdXBlcihyb20sIGlkKTtcblxuICAgIHRoaXMucG9pbnRlciA9IE1FVEFTUFJJVEVfVEFCTEUgKyAodGhpcy5pZCA8PCAxKTtcbiAgICB0aGlzLmJhc2UgPSByZWFkTGl0dGxlRW5kaWFuKHJvbS5wcmcsIHRoaXMucG9pbnRlcikgKyAweDMwMDAwO1xuICAgIHRoaXMudXNlZCA9IHRoaXMuYmFzZSA+PSAweDM4MDAwO1xuXG4gICAgaWYgKHJvbS5wcmdbdGhpcy5iYXNlXSA9PT0gMHhmZikge1xuICAgICAgLy8gZmluZCB0aGUgSUQgb2YgdGhlIHNwcml0ZSB0aGF0J3MgbWlycm9yZWQuXG4gICAgICBjb25zdCB0YXJnZXQgPSByZWFkTGl0dGxlRW5kaWFuKHJvbS5wcmcsIHRoaXMuYmFzZSArIDEpO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTY7IGkrKykge1xuICAgICAgICBpZiAocmVhZExpdHRsZUVuZGlhbihyb20ucHJnLCBNRVRBU1BSSVRFX1RBQkxFICsgKGkgPDwgMSkpID09PSB0YXJnZXQpIHtcbiAgICAgICAgICB0aGlzLm1pcnJvcmVkID0gaTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHRoaXMubWlycm9yZWQgPT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGNvdWxkIG5vdCBmaW5kIG1pcnJvcmVkIHNwcml0ZSBmb3IgJHtoZXgoaWQpfTogJHtoZXgodGFyZ2V0KX1gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2l6ZSA9IDA7XG4gICAgICB0aGlzLmZyYW1lTWFzayA9IDA7XG4gICAgICB0aGlzLmZyYW1lcyA9IDA7XG4gICAgICB0aGlzLnNwcml0ZXMgPSBbXTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5taXJyb3JlZCA9IG51bGw7XG4gICAgICB0aGlzLnNpemUgPSByb20ucHJnW3RoaXMuYmFzZV07XG4gICAgICB0aGlzLmZyYW1lTWFzayA9IHJvbS5wcmdbdGhpcy5iYXNlICsgMV07XG4gICAgICB0aGlzLmZyYW1lcyA9IHRoaXMuZnJhbWVNYXNrICsgMTtcblxuICAgICAgdGhpcy5zcHJpdGVzID0gc2VxKHRoaXMuZnJhbWVzLCBmID0+IHtcbiAgICAgICAgY29uc3QgYSA9IHRoaXMuYmFzZSArIDIgKyBmICogNCAqIHRoaXMuc2l6ZTtcbiAgICAgICAgY29uc3Qgc3ByaXRlczogW251bWJlciwgbnVtYmVyLCBudW1iZXIsIG51bWJlcl1bXSA9IFtdO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2l6ZTsgaSsrKSB7XG4gICAgICAgICAgaWYgKHJvbS5wcmdbYSArIDQgKiBpXSA9PT0gMHg4MCkgYnJlYWs7XG4gICAgICAgICAgc3ByaXRlcy5wdXNoKHR1cGxlKHJvbS5wcmcsIGEgKyA0ICogaSwgNCkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzcHJpdGVzO1xuICAgICAgfSk7XG4gICAgICAvLyBOT1RFOiB3aGVuIHJlLWVuY29kaW5nIHRoaXMsIGZpbGwgaW4gJDgwIGZvciBhbGxcbiAgICAgIC8vIG1pc3Npbmcgcm93cyBmcm9tIG5vbi1maW5hbCBmcmFtZXMuICBGb3IgdGhlIGZpbmFsXG4gICAgICAvLyBmcmFtZSwganVzdCB3cml0ZSBhIHNpbmdsZSByb3cgb2YgJDgwIChvciBtYXliZVxuICAgICAgLy8gZXZlbiBqdXN0IGEgc2luZ2xlIG9uZSwgaWYgb25seSB0aGUgZmlyc3QgaXMgdXNlZCkuXG4gICAgfVxuICB9XG5cbiAgcGF0dGVybkJhbmtzKCk6IG51bWJlcltdIHtcbiAgICBpZiAoIXRoaXMudXNlZCkgcmV0dXJuIFtdO1xuICAgIGxldCBtczogTWV0YXNwcml0ZSA9IHRoaXM7XG4gICAgaWYgKG1zLm1pcnJvcmVkKSB7XG4gICAgICBtcyA9IHRoaXMucm9tLm1ldGFzcHJpdGVzW21zLm1pcnJvcmVkXTtcbiAgICB9XG4gICAgY29uc3QgcGF0cyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGZvciAoY29uc3QgdmVyc2lvbiBvZiBtcy5zcHJpdGVzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtkeCwgLCAsIHBhdF0gb2YgdmVyc2lvbikge1xuICAgICAgICBpZiAoZHggPT09IDB4ODApIGJyZWFrO1xuICAgICAgICBwYXRzLmFkZChwYXQgPj4+IDYpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gWy4uLnBhdHNdO1xuICB9XG5cbiAgLy8gcmV0dXJucyBhbiBhcnJheSBvZiBbMC4uM11cbiAgcGFsZXR0ZXMoKTogbnVtYmVyW10ge1xuICAgIGlmICghdGhpcy51c2VkKSByZXR1cm4gW107XG4gICAgbGV0IG1zOiBNZXRhc3ByaXRlID0gdGhpcztcbiAgICBpZiAobXMubWlycm9yZWQpIHtcbiAgICAgIG1zID0gdGhpcy5yb20ubWV0YXNwcml0ZXNbbXMubWlycm9yZWRdO1xuICAgIH1cbiAgICBjb25zdCBwYWxzID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgZm9yIChjb25zdCB2ZXJzaW9uIG9mIG1zLnNwcml0ZXMpIHtcbiAgICAgIGZvciAoY29uc3QgW2R4LCAsIGF0dHJdIG9mIHZlcnNpb24pIHtcbiAgICAgICAgaWYgKGR4ID09PSAweDgwKSBicmVhaztcbiAgICAgICAgcGFscy5hZGQoYXR0ciAmIDMpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gWy4uLnBhbHNdO1xuICB9XG59XG4iXX0=