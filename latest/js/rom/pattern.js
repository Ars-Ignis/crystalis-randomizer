import { Entity } from './entity.js';
import { reverseBits, seq, tuple } from './util.js';
export class Pattern extends Entity {
    constructor(rom, id, pixels) {
        super(rom, id);
        this.pixels = pixels || tuple(rom.chr, id << 4, 16);
    }
    pixelAt(y, x) {
        return (this.pixels[y | 8] >> x & 1) << 1 | (this.pixels[y] >> x & 1);
    }
    flipH() {
        return new Pattern(this.rom, -1, this.pixels.map(reverseBits));
    }
    flipV() {
        return new Pattern(this.rom, -1, seq(16, y => this.pixels[y & 8 | ~y & 7]));
    }
    flip(type) {
        let p = this;
        if (type & Flip.HORIZONTAL)
            p = p.flipH();
        if (type & Flip.VERTICAL)
            p = p.flipV();
        return p;
    }
    write() {
        const a = this.id << 4;
        this.rom.chr.subarray(a, a + 16).set(this.pixels);
        return [];
    }
}
export class Patterns {
    constructor(rom) {
        this._all = [];
        this._all = seq(rom.chr.length >> 4, i => new Pattern(rom, i));
    }
    get(page, tile_idx) {
        if (!tile_idx) {
            return this._all[page];
        }
        return this._all[page | tile_idx];
    }
    set(page, tile_idx, pixels) {
        this._all[page | tile_idx].pixels = pixels;
    }
    [Symbol.iterator]() {
        return this._all[Symbol.iterator]();
    }
}
Patterns.HUD_LF = parsePattern(`
    +xxxxxoo
    +oxxxxo+
    +oxx++o+
    +oxx+oo+
    +++x++o+
    xooo+oo+
    xxxx+xoo
    xxxxoxxx
  `);
Patterns.HUD_PW = parsePattern(`
    +++xxxxx
    +oo+oxxx
    +++oxxxx
    +ooxxxxx
    +o+o+o+x
    xo+o+o+x
    xxo+o+ox
    xxxoxoxx
  `);
Patterns.HUD_EY = parsePattern(`
    +++xxxoo
    +ooxxxo+
    ++x+o+o+
    +oo+o+o+
    +++o+oo+
    ooox+oo+
    xxxx+ooo
    xxxxxxxx
  `);
Patterns.HUD_LV = parsePattern(`
    xxxxxxxx
    +xxxxxxx
    +oxxxxxx
    +ox+ox+o
    +ox+ox+o
    +++x++ox
    xooox+ox
    xxxxxoxx
  `);
Patterns.HUD_DL = parsePattern(`
    xxxxxxxx
    ++xxxxxx
    +o+o+xxx
    +o+o+oxx
    +o+o+oxx
    ++ox+oxx
    xoxx+++x
    xxxxxooo
  `);
Patterns.HUD_MP = parsePattern(`
    +oxx+xxx
    ++o++oxx
    +o+o+oxx
    +oxo+++x
    +oxo+oo+
    xxxx+++o
    xxxx+oox
    xxxx+oxx
  `);
Patterns.HUD_EX = parsePattern(`
    +++xxxxx
    +oooxxxx
    +++xxxxx
    +oooxxxx
    +++x+o+o
    xooox+ox
    xxxx+o+o
    xxxxxoxo
  `);
function parsePattern(data) {
    const text = data.replace(/\s/g, '');
    if (text.length !== 64)
        throw new Error(`Bad CHR tile: ${text}`);
    let arr = new Array(16).fill(0);
    for (let i = 0, c = ''; c = text.charAt(i); ++i) {
        let off = i >>> 3;
        let lo = off;
        let hi = off | 8;
        let col = ~i & 7;
        if (c === '+' || c === 'o') {
            arr[lo] |= 1 << col;
        }
        if (c === 'x' || c === 'o') {
            arr[hi] |= 1 << col;
        }
    }
    return arr;
}
export var Flip;
(function (Flip) {
    Flip[Flip["HORIZONTAL"] = 64] = "HORIZONTAL";
    Flip[Flip["VERTICAL"] = 128] = "VERTICAL";
})(Flip || (Flip = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0dGVybi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vcGF0dGVybi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUVsRCxNQUFNLE9BQU8sT0FBUSxTQUFRLE1BQU07SUFJakMsWUFBWSxHQUFRLEVBQUUsRUFBVSxFQUFFLE1BQWlCO1FBQ2pELEtBQUssQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDZixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFHRCxPQUFPLENBQUMsQ0FBUyxFQUFFLENBQVM7UUFDMUIsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQsS0FBSztRQUNILE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRCxLQUFLO1FBQ0gsT0FBTyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFD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LElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUU7UUFDN0MsSUFBSSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQixJQUFJLEVBQUUsR0FBRyxHQUFHLENBQUM7UUFDYixJQUFJLEVBQUUsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRTtZQUMxQixHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQztTQUNyQjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQzFCLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDO1NBQ3JCO0tBQ0Y7SUFDRCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFFRCxNQUFNLENBQU4sSUFBWSxJQUdYO0FBSEQsV0FBWSxJQUFJO0lBQ2QsNENBQWlCLENBQUE7SUFDakIseUNBQWUsQ0FBQTtBQUNqQixDQUFDLEVBSFcsSUFBSSxLQUFKLElBQUksUUFHZiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7TW9kdWxlfSBmcm9tICcuLi9hc20vbW9kdWxlLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtFbnRpdHl9IGZyb20gJy4vZW50aXR5LmpzJztcbmltcG9ydCB7cmV2ZXJzZUJpdHMsIHNlcSwgdHVwbGV9IGZyb20gJy4vdXRpbC5qcyc7XG5cbmV4cG9ydCBjbGFzcyBQYXR0ZXJuIGV4dGVuZHMgRW50aXR5IHtcblxuICBwaXhlbHM6IG51bWJlcltdO1xuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tLCBpZDogbnVtYmVyLCBwaXhlbHM/OiBudW1iZXJbXSkge1xuICAgIHN1cGVyKHJvbSwgaWQpO1xuICAgIHRoaXMucGl4ZWxzID0gcGl4ZWxzIHx8IHR1cGxlKHJvbS5jaHIsIGlkIDw8IDQsIDE2KTtcbiAgfVxuXG4gIC8vIFRha2VzIHggYW5kIHkgZnJvbSAwLi43LCByZXR1cm5zIGEgY29sb3IgMC4uMy5cbiAgcGl4ZWxBdCh5OiBudW1iZXIsIHg6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuICh0aGlzLnBpeGVsc1t5IHwgOF0gPj4geCAmIDEpIDw8IDEgfCAodGhpcy5waXhlbHNbeV0gPj4geCAmIDEpO1xuICB9XG5cbiAgZmxpcEgoKTogUGF0dGVybiB7XG4gICAgcmV0dXJuIG5ldyBQYXR0ZXJuKHRoaXMucm9tLCAtMSwgdGhpcy5waXhlbHMubWFwKHJldmVyc2VCaXRzKSk7XG4gIH1cblxuICBmbGlwVigpOiBQYXR0ZXJuIHtcbiAgICByZXR1cm4gbmV3IFBhdHRlcm4odGhpcy5yb20sIC0xLCBzZXEoMTYsIHkgPT4gdGhpcy5waXhlbHNbeSAmIDggfCB+eSAmIDddKSk7XG4gIH1cblxuICBmbGlwKHR5cGU6IEZsaXApOiBQYXR0ZXJuIHtcbiAgICBsZXQgcDogUGF0dGVybiA9IHRoaXM7XG4gICAgaWYgKHR5cGUgJiBGbGlwLkhPUklaT05UQUwpIHAgPSBwLmZsaXBIKCk7XG4gICAgaWYgKHR5cGUgJiBGbGlwLlZFUlRJQ0FMKSBwID0gcC5mbGlwVigpO1xuICAgIHJldHVybiBwO1xuICB9XG5cbiAgd3JpdGUoKTogTW9kdWxlW10ge1xuICAgIC8vIFRPRE86IGludGVncmF0ZSBDSFIgYXMgYSBzZXBhcmF0ZSBvdXRwdXQvb2Zmc2V0IGluIGxpbmtlcj9cbiAgICBjb25zdCBhID0gdGhpcy5pZCA8PCA0O1xuICAgIHRoaXMucm9tLmNoci5zdWJhcnJheShhLCBhICsgMTYpLnNldCh0aGlzLnBpeGVscyk7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYXR0ZXJucyBpbXBsZW1lbnRzIEl0ZXJhYmxlPFBhdHRlcm4+IHtcbiAgcHJpdmF0ZSBfYWxsOiBQYXR0ZXJuW10gPSBbXTtcblxuICBnZXQocGFnZTogbnVtYmVyLCB0aWxlX2lkeD86IG51bWJlcik6IFBhdHRlcm4ge1xuICAgIGlmICghdGlsZV9pZHgpIHtcbiAgICAgIHJldHVybiB0aGlzLl9hbGxbcGFnZV07XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9hbGxbcGFnZSB8IHRpbGVfaWR4XTtcbiAgfVxuXG4gIHNldChwYWdlOiBudW1iZXIsIHRpbGVfaWR4OiBudW1iZXIsIHBpeGVsczogbnVtYmVyW10pIHtcbiAgICB0aGlzLl9hbGxbcGFnZSB8IHRpbGVfaWR4XS5waXhlbHMgPSBwaXhlbHM7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihyb206IFJvbSkge1xuICAgIHRoaXMuX2FsbCA9IHNlcShyb20uY2hyLmxlbmd0aCA+PiA0LCBpID0+IG5ldyBQYXR0ZXJuKHJvbSwgaSkpO1xuICB9XG5cbiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FsbFtTeW1ib2wuaXRlcmF0b3JdKCk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEhVRF9MRiA9IHBhcnNlUGF0dGVybihgXG4gICAgK3h4eHh4b29cbiAgICArb3h4eHhvK1xuICAgICtveHgrK28rXG4gICAgK294eCtvbytcbiAgICArKyt4KytvK1xuICAgIHhvb28rb28rXG4gICAgeHh4eCt4b29cbiAgICB4eHh4b3h4eFxuICBgKTtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBIVURfUFcgPSBwYXJzZVBhdHRlcm4oYFxuICAgICsrK3h4eHh4XG4gICAgK29vK294eHhcbiAgICArKytveHh4eFxuICAgICtvb3h4eHh4XG4gICAgK28rbytvK3hcbiAgICB4bytvK28reFxuICAgIHh4bytvK294XG4gICAgeHh4b3hveHhcbiAgYCk7XG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgSFVEX0VZID0gcGFyc2VQYXR0ZXJuKGBcbiAgICArKyt4eHhvb1xuICAgICtvb3h4eG8rXG4gICAgKyt4K28rbytcbiAgICArb28rbytvK1xuICAgICsrK28rb28rXG4gICAgb29veCtvbytcbiAgICB4eHh4K29vb1xuICAgIHh4eHh4eHh4XG4gIGApO1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEhVRF9MViA9IHBhcnNlUGF0dGVybihgXG4gICAgeHh4eHh4eHhcbiAgICAreHh4eHh4eFxuICAgICtveHh4eHh4XG4gICAgK294K294K29cbiAgICArb3grb3grb1xuICAgICsrK3grK294XG4gICAgeG9vb3grb3hcbiAgICB4eHh4eG94eFxuICBgKTtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBIVURfREwgPSBwYXJzZVBhdHRlcm4oYFxuICAgIHh4eHh4eHh4XG4gICAgKyt4eHh4eHhcbiAgICArbytvK3h4eFxuICAgICtvK28rb3h4XG4gICAgK28rbytveHhcbiAgICArK294K294eFxuICAgIHhveHgrKyt4XG4gICAgeHh4eHhvb29cbiAgYCk7XG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgSFVEX01QID0gcGFyc2VQYXR0ZXJuKGBcbiAgICArb3h4K3h4eFxuICAgICsrbysrb3h4XG4gICAgK28rbytveHhcbiAgICArb3hvKysreFxuICAgICtveG8rb28rXG4gICAgeHh4eCsrK29cbiAgICB4eHh4K29veFxuICAgIHh4eHgrb3h4XG4gIGApO1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEhVRF9FWCA9IHBhcnNlUGF0dGVybihgXG4gICAgKysreHh4eHhcbiAgICArb29veHh4eFxuICAgICsrK3h4eHh4XG4gICAgK29vb3h4eHhcbiAgICArKyt4K28rb1xuICAgIHhvb294K294XG4gICAgeHh4eCtvK29cbiAgICB4eHh4eG94b1xuICBgKTtcbn1cblxuZnVuY3Rpb24gcGFyc2VQYXR0ZXJuKGRhdGE6IFN0cmluZykgOiBudW1iZXJbXSB7XG4gIGNvbnN0IHRleHQgPSBkYXRhLnJlcGxhY2UoL1xccy9nLCAnJyk7XG4gIGlmICh0ZXh0Lmxlbmd0aCAhPT0gNjQpIHRocm93IG5ldyBFcnJvcihgQmFkIENIUiB0aWxlOiAke3RleHR9YCk7XG4gIGxldCBhcnI6IG51bWJlcltdID0gbmV3IEFycmF5KDE2KS5maWxsKDApO1xuICBmb3IgKGxldCBpID0gMCwgYz0nJzsgYyA9IHRleHQuY2hhckF0KGkpOyArK2kpIHtcbiAgICBsZXQgb2ZmID0gaSA+Pj4gMztcbiAgICBsZXQgbG8gPSBvZmY7XG4gICAgbGV0IGhpID0gb2ZmIHwgODtcbiAgICBsZXQgY29sID0gfmkgJiA3O1xuICAgIGlmIChjID09PSAnKycgfHwgYyA9PT0gJ28nKSB7XG4gICAgICBhcnJbbG9dIHw9IDEgPDwgY29sO1xuICAgIH1cbiAgICBpZiAoYyA9PT0gJ3gnIHx8IGMgPT09ICdvJykge1xuICAgICAgYXJyW2hpXSB8PSAxIDw8IGNvbDtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGFycjtcbn1cblxuZXhwb3J0IGVudW0gRmxpcCB7XG4gIEhPUklaT05UQUwgPSAweDQwLFxuICBWRVJUSUNBTCA9IDB4ODAsXG59XG4iXX0=