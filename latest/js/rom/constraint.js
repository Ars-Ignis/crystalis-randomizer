import { seq } from "./util.js";
import { iters } from "../util.js";
const EMPTY_ITERATOR = {
    next() { return { done: true }; },
};
const NONE = {
    get size() { return 0; },
    has() { return false; },
    [Symbol.iterator]() { return EMPTY_ITERATOR; },
};
const ALL = {
    get size() { return Infinity; },
    has() { return true; },
    [Symbol.iterator]() { throw new Error('cannot iterate'); },
};
class Bit {
    constructor(bit) {
        this.bit = bit;
    }
    get size() { return 1; }
    has(x) { return x === this.bit; }
    [Symbol.iterator]() { return [this.bit][Symbol.iterator](); }
}
function bit(x) {
    return new Bit(x);
}
var CSet;
(function (CSet) {
    function intersect(a, b) {
        if (a === ALL || !b.size)
            return b;
        if (b === ALL || !a.size)
            return a;
        const out = new Set();
        for (const x of a) {
            if (b.has(x))
                out.add(x);
        }
        if (!out.size)
            return NONE;
        return out;
    }
    CSet.intersect = intersect;
    function union(a, b) {
        if (a === ALL || !b.size)
            return a;
        if (b === ALL || !a.size)
            return b;
        const out = new Set(a);
        for (const x of b) {
            out.add(x);
        }
        return out;
    }
    CSet.union = union;
    function isSubset(subset, superset) {
        if (superset === ALL || !subset.size)
            return true;
        if (subset.size > superset.size)
            return false;
        for (const x of subset) {
            if (!superset.has(x))
                return false;
        }
        return true;
    }
    CSet.isSubset = isSubset;
    function label(x) {
        return x === ALL ? 'all' : [...x].sort().join(' ');
    }
    CSet.label = label;
})(CSet || (CSet = {}));
export class Constraint {
    constructor(fixed, float, shift) {
        this.fixed = fixed;
        this.float = float;
        this.shift = shift;
    }
    get pat0() { return this.fixed[0]; }
    get pat1() { return this.fixed[1]; }
    get pal2() { return this.fixed[2]; }
    get pal3() { return this.fixed[3]; }
    static get ALL() {
        return new Constraint([ALL, ALL, ALL, ALL], [], 0);
    }
    static get NONE() {
        return new Constraint([NONE, NONE, NONE, NONE], [], 0);
    }
    static get MIMIC() {
        return new Constraint([ALL, bit(0x6c), ALL, ALL], [], 2);
    }
    static get TREASURE_CHEST() {
        return new Constraint([ALL, ALL, ALL, ALL], [TREASURE_CHEST_BANKS], 0);
    }
    static get BOSS() {
        return new Constraint([TREASURE_CHEST_BANKS, ALL, ALL, ALL], [], 0);
    }
    static get COIN() {
        return new Constraint([COIN_BANKS, ALL, ALL, ALL], [], 0);
    }
    static get STOM_FIGHT() {
        return new Constraint([ALL, new Set([0x4d]), ALL, ALL], [], 0);
    }
    static get KENSU_CHEST() {
        return new Constraint([new Set([0x51]), ALL, ALL, ALL], [], 0);
    }
    static forLocation(id) {
        switch (id) {
            case 0x03:
                return new Constraint([ALL, bit(0x60), ALL, bit(0x20)], [], 0);
            case 0x60:
            case 0x64:
            case 0x68:
                return new Constraint([ALL, bit(0x52), ALL, bit(0x08)], [], 0);
        }
        return Constraint.ALL;
    }
    static fromSpawn(palettes, patterns, location, spawn, shiftable) {
        const [firstPattern, ...rest] = patterns;
        shiftable = shiftable && firstPattern === 2 && !rest.length;
        if (shiftable && spawn.patternBank)
            patterns = new Set([3]);
        const pat0 = shiftable || !patterns.has(2) ? ALL : bit(location.spritePatterns[0]);
        const pat1 = shiftable || !patterns.has(3) ? ALL : bit(location.spritePatterns[1]);
        const float = shiftable ? [bit(location.spritePatterns[spawn.patternBank])] : [];
        const pal2 = palettes.has(2) ? bit(location.spritePalettes[0]) : ALL;
        const pal3 = palettes.has(3) ? bit(location.spritePalettes[1]) : ALL;
        return new Constraint([pat0, pat1, pal2, pal3], float, 0);
    }
    ignorePalette() {
        return new Constraint([this.fixed[0], this.fixed[1], ALL, ALL], this.float, this.shift);
    }
    shufflePalette(random, usedPalettes) {
        const fixed = [...this.fixed];
        for (let i = 2; i < 4; i++) {
            if (fixed[i] === ALL)
                continue;
            const size = Math.floor(5 - Math.log2(random.nextInt(15) + 2));
            const out = fixed[i] = new Set();
            for (let i = 0; i < size; i++) {
                out.add(random.pick(usedPalettes));
            }
        }
        return new Constraint(fixed, this.float, this.shift);
    }
    shifted() {
        return new Constraint(this.fixed, this.float, this.shift | 2);
    }
    join(that) {
        const fixed = seq(4, i => CSet.union(this.fixed[i], that.fixed[i]));
        if (this.float.length != that.float.length) {
            console.dir(this);
            console.dir(that);
            throw new Error(`incompatible float: ${this.float} ${that.float}`);
        }
        const float = seq(this.float.length, i => CSet.union(this.float[i], that.float[i]));
        return new Constraint(fixed, float, this.shift | that.shift);
    }
    fix(location, random) {
        const nextInt = random ? (x) => random.nextInt(x) : () => 0;
        const pick = random ? (xs) => random.pick([...xs]) :
            (xs) => xs[Symbol.iterator]().next().value;
        const fixed = [...this.fixed];
        if (this.float.length) {
            const x0 = nextInt(2);
            const x1 = 1 - x0;
            if (x0 < this.float.length)
                fixed[0] = CSet.intersect(fixed[0], this.float[x0]);
            if (x1 < this.float.length)
                fixed[1] = CSet.intersect(fixed[1], this.float[x1]);
        }
        if (fixed[0] !== ALL)
            location.spritePatterns[0] = pick([...fixed[0]]);
        if (fixed[1] !== ALL)
            location.spritePatterns[1] = pick([...fixed[1]]);
        if (fixed[2] !== ALL)
            location.spritePalettes[0] = pick([...fixed[2]]);
        if (fixed[3] !== ALL)
            location.spritePalettes[1] = pick([...fixed[3]]);
    }
    meet(that, joinPatterns = false) {
        const result = this.tryMeet(that, joinPatterns);
        if (!result)
            throw new Error(`Could not reconcile patterns`);
        return result;
    }
    tryMeet(that, joinPatterns = false) {
        const fixed = [];
        let shift = this.shift | that.shift;
        for (let i = 0; i < 4; i++) {
            let meet = CSet.intersect(this.fixed[i], that.fixed[i]);
            if (!meet.size) {
                if (!joinPatterns || i < 2)
                    return undefined;
                meet = CSet.union(this.fixed[i], that.fixed[i]);
            }
            fixed.push(meet);
        }
        const inverseFloat = new Map();
        const float = [];
        for (const s of iters.concat(this.float, that.float)) {
            if (s === ALL)
                throw new Error(`Unexpected unconstrained float`);
            let found = false;
            for (const p of s) {
                const prev = inverseFloat.get(p);
                if (prev != null) {
                    for (const r of float[prev])
                        inverseFloat.delete(r);
                    float[prev] = CSet.intersect(float[prev], s);
                    for (const r of float[prev])
                        inverseFloat.set(r, prev);
                    found = true;
                    break;
                }
            }
            if (found)
                break;
            for (const p of s)
                inverseFloat.set(p, float.length);
            float.push(s);
            if (float.length > 2)
                return undefined;
        }
        for (let i = 0; i < float.length; i++) {
            for (let j = 0; j < 2; j++) {
                const intersect = CSet.intersect(float[i], fixed[j]);
                if (!intersect.size) {
                    const c = fixed[1 - j] = CSet.intersect(float[i], fixed[1 - j]);
                    shift |= 1 << (1 - j);
                    if (!c.size)
                        return undefined;
                    float.splice(i, 1);
                    i = -1;
                    break;
                }
                else if (intersect.size === float[i].size) {
                }
            }
        }
        return new Constraint(fixed, float, shift);
    }
}
const TREASURE_CHEST_BANKS = new Set([
    0x5e, 0x5f, 0x60, 0x61, 0x64, 0x65, 0x66, 0x67,
    0x68, 0x69, 0x6a, 0x6c, 0x6d, 0x6e, 0x6f, 0x70,
    0x74, 0x75, 0x76, 0x77,
]);
const COIN_BANKS = new Set([
    0x5e, 0x5f, 0x60, 0x61, 0x63, 0x64, 0x65, 0x66,
    0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c, 0x6d, 0x6e,
    0x6f, 0x70, 0x74, 0x75, 0x76, 0x77,
]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RyYWludC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vY29uc3RyYWludC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQzlCLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFZakMsTUFBTSxjQUFjLEdBQXFCO0lBQ3ZDLElBQUksS0FBSyxPQUFPLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBUSxDQUFDLENBQUMsQ0FBQztDQUN2QyxDQUFDO0FBRUYsTUFBTSxJQUFJLEdBQVM7SUFDakIsSUFBSSxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLEdBQUcsS0FBSyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDdkIsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssT0FBTyxjQUFjLENBQUMsQ0FBQyxDQUFDO0NBQy9DLENBQUM7QUFFRixNQUFNLEdBQUcsR0FBUztJQUNoQixJQUFJLElBQUksS0FBSyxPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDL0IsR0FBRyxLQUFLLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN0QixDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxNQUFNLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDO0NBQzNELENBQUE7QUFFRCxNQUFNLEdBQUc7SUFDUCxZQUFxQixHQUFXO1FBQVgsUUFBRyxHQUFILEdBQUcsQ0FBUTtJQUFHLENBQUM7SUFDcEMsSUFBSSxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLEdBQUcsQ0FBQyxDQUFTLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssT0FB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QUUsSUFBSSxFQUFFLElBQUk7Q0FDbkMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMb2NhdGlvbiwgU3Bhd259IGZyb20gXCIuL2xvY2F0aW9uLmpzXCI7XG5pbXBvcnQge3NlcX0gZnJvbSBcIi4vdXRpbC5qc1wiO1xuaW1wb3J0IHtpdGVyc30gZnJvbSBcIi4uL3V0aWwuanNcIjtcbmltcG9ydCB7UmFuZG9tfSBmcm9tIFwiLi4vcmFuZG9tLmpzXCI7XG5cbi8vIENvbnN0cmFpbnQgZm9yIHBhdHRlcm4gYW5kIHBhbGV0dGUgcGFnZXMuXG4vLyBBbGxvd3MgbXVsdGlwbGUgcG9zc2liaWxpdGllcywgYW5kIGEgY2FsbGJhY2sgd2hlbiBvbmUgaXMgcGlja2VkLlxuXG5pbnRlcmZhY2UgQ1NldCB7XG4gIHJlYWRvbmx5IHNpemU6IG51bWJlcjtcbiAgaGFzOiAoeDogbnVtYmVyKSA9PiBib29sZWFuO1xuICBbU3ltYm9sLml0ZXJhdG9yXTogKCkgPT4gSXRlcmF0b3I8bnVtYmVyPjtcbn1cblxuY29uc3QgRU1QVFlfSVRFUkFUT1I6IEl0ZXJhdG9yPG51bWJlcj4gPSB7XG4gIG5leHQoKSB7IHJldHVybiB7ZG9uZTogdHJ1ZX0gYXMgYW55OyB9LFxufTtcblxuY29uc3QgTk9ORTogQ1NldCA9IHtcbiAgZ2V0IHNpemUoKSB7IHJldHVybiAwOyB9LFxuICBoYXMoKSB7IHJldHVybiBmYWxzZTsgfSxcbiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7IHJldHVybiBFTVBUWV9JVEVSQVRPUjsgfSxcbn07XG5cbmNvbnN0IEFMTDogQ1NldCA9IHtcbiAgZ2V0IHNpemUoKSB7IHJldHVybiBJbmZpbml0eTsgfSxcbiAgaGFzKCkgeyByZXR1cm4gdHJ1ZTsgfSxcbiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7IHRocm93IG5ldyBFcnJvcignY2Fubm90IGl0ZXJhdGUnKTsgfSxcbn1cblxuY2xhc3MgQml0IGltcGxlbWVudHMgQ1NldCB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGJpdDogbnVtYmVyKSB7fVxuICBnZXQgc2l6ZSgpIHsgcmV0dXJuIDE7IH1cbiAgaGFzKHg6IG51bWJlcikgeyByZXR1cm4geCA9PT0gdGhpcy5iaXQ7IH1cbiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7IHJldHVybiBbdGhpcy5iaXRdW1N5bWJvbC5pdGVyYXRvcl0oKTsgfVxufVxuXG5mdW5jdGlvbiBiaXQoeDogbnVtYmVyKTogQml0IHtcbiAgcmV0dXJuIG5ldyBCaXQoeCk7XG59XG5cbm5hbWVzcGFjZSBDU2V0IHtcbiAgZXhwb3J0IGZ1bmN0aW9uIGludGVyc2VjdChhOiBDU2V0LCBiOiBDU2V0KTogQ1NldCB7XG4gICAgaWYgKGEgPT09IEFMTCB8fCAhYi5zaXplKSByZXR1cm4gYjtcbiAgICBpZiAoYiA9PT0gQUxMIHx8ICFhLnNpemUpIHJldHVybiBhO1xuICAgIGNvbnN0IG91dCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGZvciAoY29uc3QgeCBvZiBhKSB7XG4gICAgICBpZiAoYi5oYXMoeCkpIG91dC5hZGQoeCk7XG4gICAgfVxuICAgIGlmICghb3V0LnNpemUpIHJldHVybiBOT05FO1xuICAgIHJldHVybiBvdXQ7XG4gIH1cbiAgZXhwb3J0IGZ1bmN0aW9uIHVuaW9uKGE6IENTZXQsIGI6IENTZXQpOiBDU2V0IHtcbiAgICBpZiAoYSA9PT0gQUxMIHx8ICFiLnNpemUpIHJldHVybiBhO1xuICAgIGlmIChiID09PSBBTEwgfHwgIWEuc2l6ZSkgcmV0dXJuIGI7XG4gICAgY29uc3Qgb3V0ID0gbmV3IFNldChhKTtcbiAgICBmb3IgKGNvbnN0IHggb2YgYikge1xuICAgICAgb3V0LmFkZCh4KTtcbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuICBleHBvcnQgZnVuY3Rpb24gaXNTdWJzZXQoc3Vic2V0OiBDU2V0LCBzdXBlcnNldDogQ1NldCk6IGJvb2xlYW4ge1xuICAgIGlmIChzdXBlcnNldCA9PT0gQUxMIHx8ICFzdWJzZXQuc2l6ZSkgcmV0dXJuIHRydWU7XG4gICAgaWYgKHN1YnNldC5zaXplID4gc3VwZXJzZXQuc2l6ZSkgcmV0dXJuIGZhbHNlO1xuICAgIGZvciAoY29uc3QgeCBvZiBzdWJzZXQpIHtcbiAgICAgIGlmICghc3VwZXJzZXQuaGFzKHgpKSByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGV4cG9ydCBmdW5jdGlvbiBsYWJlbCh4OiBDU2V0KTogc3RyaW5nIHtcbiAgICByZXR1cm4geCA9PT0gQUxMID8gJ2FsbCcgOiBbLi4ueF0uc29ydCgpLmpvaW4oJyAnKTtcbiAgfVxufVxuXG4vLyBjbGFzcyBDb25zdHJhaW50U2V0IHtcbi8vICAgY29uc3RydWN0b3IocmVhZG9ubHkgYWxsb3dlZD86IFNldDxudW1iZXI+KSB7fVxuXG4vLyAgIGdldCBzaXplKCkgeyByZXR1cm4gdGhpcy5hbGxvd2VkID8gdGhpcy5hbGxvd2VkLnNpemUgOiBJbmZpbml0eTsgfVxuLy8gICBoYXMoeDogbnVtYmVyKSB7IHJldHVybiB0aGlzLmFsbG93ZWQgPyB0aGlzLmFsbG93ZWQuaGFzKHgpIDogdHJ1ZTsgfVxuLy8gICBpbnRlcnNlY3QodGhhdDogQ29uc3RyYWludFNldCk6IENvbnN0cmFpbnRTZXQge1xuLy8gICAgIGlmICghdGhpcy5hbGxvd2VkKSByZXR1cm4gdGhhdDtcbi8vICAgICBpZiAoIXRoYXQuYWxsb3dlZCkgcmV0dXJuIHRoaXM7XG4vLyAgICAgY29uc3Qgb3V0ID0gbmV3IFNldDxudW1iZXI+KCk7XG4vLyAgICAgZm9yIChjb25zdCB4IG9mIHRoaXMuYWxsb3dlZCkge1xuLy8gICAgICAgaWYgKHRoYXQuYWxsb3dlZC5oYXMoeCkpIG91dC5hZGQoeCk7XG4vLyAgICAgfVxuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludFNldChvdXQpO1xuLy8gICB9ICAgIFxuLy8gICB1bmlvbih0aGF0OiBDb25zdHJhaW50U2V0KTogQ29uc3RyYWludFNldCB7XG4vLyAgICAgaWYgKCF0aGlzLmFsbG93ZWQpIHJldHVybiB0aGlzO1xuLy8gICAgIGlmICghdGhhdC5hbGxvd2VkKSByZXR1cm4gdGhhdDtcbi8vICAgICBjb25zdCBvdXQgPSBuZXcgU2V0KHRoaXMuYWxsb3dlZCk7XG4vLyAgICAgZm9yIChjb25zdCB4IG9mIHRoYXQuYWxsb3dlZCkge1xuLy8gICAgICAgb3V0LmFkZCh4KTtcbi8vICAgICB9XG4vLyAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50U2V0KG91dCk7XG4vLyAgIH1cbi8vIH1cblxuLy8gY29uc3QgVU5DT05TVFJBSU5FRCA9IG5ldyBDb25zdHJhaW50U2V0KCk7XG5cbi8vIGZ1bmN0aW9uIGNvbnN0cmFpbnQoeDogbnVtYmVyKTogQ29uc3RyYWludFNldCB7XG4vLyAgIHJldHVybiBuZXcgQ29uc3RyYWludFNldChuZXcgU2V0KFt4XSkpO1xuLy8gfVxuXG5leHBvcnQgY2xhc3MgQ29uc3RyYWludCB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGZpeGVkOiBSZWFkb25seUFycmF5PENTZXQ+LCAvLyBsZW5ndGggYWx3YXlzIDRcbiAgICAgICAgICAgICAgcmVhZG9ubHkgZmxvYXQ6IFJlYWRvbmx5QXJyYXk8Q1NldD4sXG4gICAgICAgICAgICAgIC8vIGJpdHNldCBvZiBwYWdlcyB0aGF0IGhhdmUgYmVlbiBzaGlmdGVkIGZyb20gYSBmbG9hdC5cbiAgICAgICAgICAgICAgcmVhZG9ubHkgc2hpZnQ6IG51bWJlcikge31cblxuICBnZXQgcGF0MCgpOiBDU2V0IHsgcmV0dXJuIHRoaXMuZml4ZWRbMF07IH1cbiAgZ2V0IHBhdDEoKTogQ1NldCB7IHJldHVybiB0aGlzLmZpeGVkWzFdOyB9XG4gIGdldCBwYWwyKCk6IENTZXQgeyByZXR1cm4gdGhpcy5maXhlZFsyXTsgfVxuICBnZXQgcGFsMygpOiBDU2V0IHsgcmV0dXJuIHRoaXMuZml4ZWRbM107IH1cblxuICBzdGF0aWMgZ2V0IEFMTCgpIHtcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW0FMTCwgQUxMLCBBTEwsIEFMTF0sIFtdLCAwKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgTk9ORSgpIHtcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW05PTkUsIE5PTkUsIE5PTkUsIE5PTkVdLCBbXSwgMCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0IE1JTUlDKCkge1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbQUxMLCBiaXQoMHg2YyksIEFMTCwgQUxMXSwgW10sIDIpO1xuICB9XG5cbiAgc3RhdGljIGdldCBUUkVBU1VSRV9DSEVTVCgpIHtcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW0FMTCwgQUxMLCBBTEwsIEFMTF0sIFtUUkVBU1VSRV9DSEVTVF9CQU5LU10sIDApO1xuICB9XG5cbiAgc3RhdGljIGdldCBCT1NTKCkge1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbVFJFQVNVUkVfQ0hFU1RfQkFOS1MsIEFMTCwgQUxMLCBBTExdLCBbXSwgMCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0IENPSU4oKSB7XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtDT0lOX0JBTktTLCBBTEwsIEFMTCwgQUxMXSwgW10sIDApO1xuICB9XG5cbiAgc3RhdGljIGdldCBTVE9NX0ZJR0hUKCkge1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbQUxMLCBuZXcgU2V0KFsweDRkXSksIEFMTCwgQUxMXSwgW10sIDApO1xuICB9XG5cbiAgc3RhdGljIGdldCBLRU5TVV9DSEVTVCgpIHtcbiAgICAvLyBLZW5zdSBleHBsaWNpdGx5IGdpdmVzIGhpcyBsaWdodGhvc3VlIGNoZXN0IGEgc3ByaXRlIG9mZnNldCBvZiA5XG4gICAgLy8gKHZpYSAkMWY3ZDIgaW4gdGhlIGJvc3MgY2hlc3QgdGFibGUpLCB3aGljaCBjYW4gb25seSBiZSBzYXRpc2ZpZWRcbiAgICAvLyBpZiAkNTEgKHRoZSBzbGVlcGluZyBOUEMgcGFnZSkgaXMgaW4gdGhlIGZpcnN0IHNsb3QuICBXZSBjb3VsZFxuICAgIC8vIGJlIG1vcmUgZmxleGlibGUgaWYgd2UgcmV3cm90ZSB0aGF0IG9mZnNldCwgYnV0IHRoZW4gd2Ugd291bGRuJ3RcbiAgICAvLyBnZXQgYm90aCB2ZXJzaW9ucyBvZiBLZW5zdSBzbyBlYXNpbHkuXG4gICAgLy8gTk9URTogYWZ0ZXIgd2UgZ2V0IHRoZSBjaGVzdCwgd2UgY291bGQgcmVzZXQgdGhlIHBhdHRlcm5zIGJ5XG4gICAgLy8gICAgICAgc2h1bnRpbmcgJDNkNDU4XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtuZXcgU2V0KFsweDUxXSksIEFMTCwgQUxMLCBBTExdLCBbXSwgMCk7XG4gIH1cblxuICAvLyBSZXR1cm5zIHRoZSBcInN0YXJ0aW5nIGNvbnN0cmFpbnRcIiBmb3IgdGhlIGdpdmVuIGxvY2F0aW9uLCB0YWtpbmcgdGhpbmdzIGxpa2VcbiAgLy8gd2luZG1pbGwgYmxhZGVzIGludG8gYWNjb3VudC5cbiAgc3RhdGljIGZvckxvY2F0aW9uKGlkOiBudW1iZXIpOiBDb25zdHJhaW50IHtcbiAgICBzd2l0Y2ggKGlkKSB7XG4gICAgY2FzZSAweDAzOiAvLyB2YWxsZXkgb2Ygd2luZCAod2luZG1pbGwgYmxhZGVzKVxuICAgICAgLy8gVE9ETyAtIHBhdHRlcm4gYmFuayBpcyBzaGlmdGFibGUsIGJ1dCBuZWVkIHRvIGxpbmsgdG8gc3Bhd24gMyxlMFxuICAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtBTEwsIGJpdCgweDYwKSwgQUxMLCBiaXQoMHgyMCldLCBbXSwgMCk7XG4gICAgLy9jYXNlIDB4MWE6IC8vIHN3YW1wIChjaGlsZClcbiAgICAvLyAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtBTEwsIGJpdCgweDRmKSwgQUxMLCBiaXQoMHgyMyldLCBbXSk7XG4gICAgY2FzZSAweDYwOiAvLyBhbmdyeSBzZWEgKGRvbHBoaW4pXG4gICAgY2FzZSAweDY0OiAvLyB1bmRlcmdyb3VuZCBjaGFubmVsXG4gICAgY2FzZSAweDY4OiAvLyBFU0kgZW50cmFuY2VcbiAgICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbQUxMLCBiaXQoMHg1MiksIEFMTCxiaXQoMHgwOCldLCBbXSwgMCk7XG4gICAgfVxuICAgIHJldHVybiBDb25zdHJhaW50LkFMTDtcbiAgfVxuXG4gIC8vIE5PVEU6IFN0YXRpYyBzcGF3bnMgbWF5IGJlIHNoaWZ0YWJsZTsgYWQtaG9jIHNwYXducyBhcmUgbm90LlxuICBzdGF0aWMgZnJvbVNwYXduKHBhbGV0dGVzOiBTZXQ8bnVtYmVyPixcbiAgICAgICAgICAgICAgICAgICBwYXR0ZXJuczogU2V0PG51bWJlcj4sXG4gICAgICAgICAgICAgICAgICAgbG9jYXRpb246IExvY2F0aW9uLCBcbiAgICAgICAgICAgICAgICAgICBzcGF3bjogU3Bhd24sXG4gICAgICAgICAgICAgICAgICAgc2hpZnRhYmxlOiBib29sZWFuKTogQ29uc3RyYWludCB7XG4gICAgY29uc3QgW2ZpcnN0UGF0dGVybiwgLi4ucmVzdF0gPSBwYXR0ZXJucztcbiAgICBzaGlmdGFibGUgPSBzaGlmdGFibGUgJiYgZmlyc3RQYXR0ZXJuID09PSAyICYmICFyZXN0Lmxlbmd0aDtcbiAgICBpZiAoc2hpZnRhYmxlICYmIHNwYXduLnBhdHRlcm5CYW5rKSBwYXR0ZXJucyA9IG5ldyBTZXQoWzNdKTtcbiAgICBjb25zdCBwYXQwID0gc2hpZnRhYmxlIHx8ICFwYXR0ZXJucy5oYXMoMikgPyBBTEwgOiBiaXQobG9jYXRpb24uc3ByaXRlUGF0dGVybnNbMF0pO1xuICAgIGNvbnN0IHBhdDEgPSBzaGlmdGFibGUgfHwgIXBhdHRlcm5zLmhhcygzKSA/IEFMTCA6IGJpdChsb2NhdGlvbi5zcHJpdGVQYXR0ZXJuc1sxXSk7XG4gICAgY29uc3QgZmxvYXQgPSBzaGlmdGFibGUgPyBbYml0KGxvY2F0aW9uLnNwcml0ZVBhdHRlcm5zW3NwYXduLnBhdHRlcm5CYW5rXSldIDogW107XG4gICAgY29uc3QgcGFsMiA9IHBhbGV0dGVzLmhhcygyKSA/IGJpdChsb2NhdGlvbi5zcHJpdGVQYWxldHRlc1swXSkgOiBBTEw7XG4gICAgY29uc3QgcGFsMyA9IHBhbGV0dGVzLmhhcygzKSA/IGJpdChsb2NhdGlvbi5zcHJpdGVQYWxldHRlc1sxXSkgOiBBTEw7XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtwYXQwLCBwYXQxLCBwYWwyLCBwYWwzXSwgZmxvYXQsIDApO1xuICB9XG5cbiAgLy8gVE9ETyAtIGNvbWJpbmUgdGhlc2UuLi5cblxuICBpZ25vcmVQYWxldHRlKCk6IENvbnN0cmFpbnQge1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbdGhpcy5maXhlZFswXSwgdGhpcy5maXhlZFsxXSwgQUxMLCBBTExdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZsb2F0LCB0aGlzLnNoaWZ0KTtcbiAgfVxuXG4gIHNodWZmbGVQYWxldHRlKHJhbmRvbTogUmFuZG9tLCB1c2VkUGFsZXR0ZXM6IHJlYWRvbmx5IG51bWJlcltdKTogQ29uc3RyYWludCB7XG4gICAgY29uc3QgZml4ZWQgPSBbLi4udGhpcy5maXhlZF07XG4gICAgZm9yIChsZXQgaSA9IDI7IGkgPCA0OyBpKyspIHtcbiAgICAgIGlmIChmaXhlZFtpXSA9PT0gQUxMKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IHNpemUgPSBNYXRoLmZsb29yKDUgLSBNYXRoLmxvZzIocmFuZG9tLm5leHRJbnQoMTUpICsgMikpO1xuICAgICAgY29uc3Qgb3V0ID0gZml4ZWRbaV0gPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7XG4gICAgICAgIG91dC5hZGQocmFuZG9tLnBpY2sodXNlZFBhbGV0dGVzKSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChmaXhlZCwgdGhpcy5mbG9hdCwgdGhpcy5zaGlmdCk7XG4gIH1cblxuICBzaGlmdGVkKCk6IENvbnN0cmFpbnQge1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludCh0aGlzLmZpeGVkLCB0aGlzLmZsb2F0LCB0aGlzLnNoaWZ0IHwgMik7XG4gIH1cblxuICAvLyBBbGwgdGhlIHBvc3NpYmxlIGNvbnN0cmFpbnRzIGZvciBhIGdpdmVuIG1vbnN0ZXIgYXJlIGpvaW5lZCB0b2dldGhlci5cbiAgLy8gU28gaWYgdGhlIHNhbWUgbW9uc3RlciBzaG93cyB1cCB3aXRoIHR3byBkaWZmZXJlbnQgcGFsZXR0ZXMsIHRoZW4gd2VcbiAgLy8gZW5kIHVwIHdpdGggYSB0d28tZWxlbWVudCBzZXQgZm9yIGl0cyBwYWxldHRlLlxuICBqb2luKHRoYXQ6IENvbnN0cmFpbnQpOiBDb25zdHJhaW50IHtcbiAgICBjb25zdCBmaXhlZCA9IHNlcSg0LCBpID0+IENTZXQudW5pb24odGhpcy5maXhlZFtpXSwgdGhhdC5maXhlZFtpXSkpO1xuICAgIGlmICh0aGlzLmZsb2F0Lmxlbmd0aCAhPSB0aGF0LmZsb2F0Lmxlbmd0aCkge1xuICAgICAgY29uc29sZS5kaXIodGhpcyk7IGNvbnNvbGUuZGlyKHRoYXQpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBpbmNvbXBhdGlibGUgZmxvYXQ6ICR7dGhpcy5mbG9hdH0gJHt0aGF0LmZsb2F0fWApO1xuICAgIH1cbiAgICBjb25zdCBmbG9hdCA9IHNlcSh0aGlzLmZsb2F0Lmxlbmd0aCwgaSA9PiBDU2V0LnVuaW9uKHRoaXMuZmxvYXRbaV0sIHRoYXQuZmxvYXRbaV0pKTtcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoZml4ZWQsIGZsb2F0LCB0aGlzLnNoaWZ0IHwgdGhhdC5zaGlmdCk7XG5cbiAgICAvLyBjb25zdCBmbG9hdE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBDU2V0PigpO1xuICAgIC8vIGZvciAoY29uc3QgcyBvZiBpdGVycy5jb25jYXQodGhpcy5mbG9hdCwgdGhhdC5mbG9hdCkpIHtcbiAgICAvLyAgIGZsb2F0TWFwLnNldChDU2V0LmxhYmVsKHMpLCBzKTtcbiAgICAvLyB9XG4gICAgLy8gY29uc3QgZmxvYXQgPSBbLi4uZmxvYXRNYXAudmFsdWVzKCldO1xuICAgIC8vIGlmIChmbG9hdC5sZW5ndGggPiAyKSB7XG4gICAgLy8gICAvLyBuZWVkIHRvIGRvIHNvbWV0aGluZz9cbiAgICAvLyB9XG5cbiAgICAvLyBjb25zdCBwYXQwID0gdGhpcy5wYXQwICYmIHRoYXQucGF0MCAmJiB0aGlzLnBhdDAudW5pb24odGhhdC5wYXQwKTtcbiAgICAvLyBjb25zdCBwYXQxID0gdGhpcy5wYXQxICYmIHRoYXQucGF0MSAmJiB0aGlzLnBhdDEudW5pb24odGhhdC5wYXQxKTtcbiAgICAvLyBjb25zdCBwYXRYID0gdGhpcy5wYXRYICYmIHRoYXQucGF0WCAmJiB0aGlzLnBhdFgudW5pb24odGhhdC5wYXRYKTtcbiAgICAvLyBjb25zdCBwYXRZID0gdGhpcy5wYXRZICYmIHRoYXQucGF0WSAmJiB0aGlzLnBhdFkudW5pb24odGhhdC5wYXRZKTtcbiAgICAvLyBjb25zdCBwYWwyID0gdGhpcy5wYWwyICYmIHRoYXQucGFsMiAmJiB0aGlzLnBhbDIudW5pb24odGhhdC5wYWwyKTtcbiAgICAvLyBjb25zdCBwYWwzID0gdGhpcy5wYWwzICYmIHRoYXQucGFsMyAmJiB0aGlzLnBhbDMudW5pb24odGhhdC5wYWwzKTtcbiAgICAvLyBjb25zdCBzaGlmdGFibGUgPSB0aGlzLnNoaWZ0YWJsZSB8fCB0aGF0LnNoaWZ0YWJsZTtcbiAgICAvLyByZXR1cm4gbmV3IENvbnN0cmFpbnQocGF0MCwgcGF0MSwgcGF0WCwgcGF0WSwgcGFsMiwgcGFsMywgc2hpZnRhYmxlKTtcbiAgfVxuXG4gIGZpeChsb2NhdGlvbjogTG9jYXRpb24sIHJhbmRvbT86IFJhbmRvbSkge1xuICAgIC8vIENvbmNyZXRpemVzIHRoZSBcImZsb2F0XCIgZWxlbWVudHMuXG4gICAgY29uc3QgbmV4dEludDogKHg6IG51bWJlcikgPT4gbnVtYmVyID1cbiAgICAgICAgcmFuZG9tID8gKHgpID0+IHJhbmRvbS5uZXh0SW50KHgpIDogKCkgPT4gMDtcbiAgICBjb25zdCBwaWNrOiA8VD4oeDogSXRlcmFibGU8VD4pID0+IFQgPVxuICAgICAgICByYW5kb20gPyAoeHMpID0+IHJhbmRvbS5waWNrKFsuLi54c10pIDpcbiAgICAgICAgICAgICAgICAgKHhzKSA9PiB4c1tTeW1ib2wuaXRlcmF0b3JdKCkubmV4dCgpLnZhbHVlO1xuICAgIGNvbnN0IGZpeGVkID0gWy4uLnRoaXMuZml4ZWRdO1xuICAgIGlmICh0aGlzLmZsb2F0Lmxlbmd0aCkge1xuICAgICAgLy8gVE9ETyAtIGlmIGZsb2F0Lmxlbmd0aCA9PT0gMSB0aGVuIG9uZSBmaXhlZCBiYW5rIG1pZ2h0IGJlIGJldHRlciB0aGFuIHRoZVxuICAgICAgLy8gb3RoZXIgKGkuZS4gaWYgcGF0MCBpcyBbMTFdIGFuZCBwYXQxIGlzIEFMTCwgYW5kIGZsb2F0WzBdIGlzIFsxMV0sIHRoZW4gaXRcbiAgICAgIC8vIHdvdWxkIGJlIHNpbGx5IHRvIHBpY2sgcGF0MSB0byBiZSBbMTFdLiAgRXhjZXB0IHRoYXQgYnkgdGhlIHRpbWUgd2UgcnVuIHRoaXMsXG4gICAgICAvLyBpdCdzIGlycmVsZXZhbnQsIHNpbmNlIG5vIG5ldyBwYXR0ZXJucyBhcmUgZ29pbmcgdG8gYmUgYWRkZWQgYW55d2F5LlxuICAgICAgY29uc3QgeDAgPSBuZXh0SW50KDIpO1xuICAgICAgY29uc3QgeDEgPSAxIC0geDA7XG4gICAgICBpZiAoeDAgPCB0aGlzLmZsb2F0Lmxlbmd0aCkgZml4ZWRbMF0gPSBDU2V0LmludGVyc2VjdChmaXhlZFswXSwgdGhpcy5mbG9hdFt4MF0pO1xuICAgICAgaWYgKHgxIDwgdGhpcy5mbG9hdC5sZW5ndGgpIGZpeGVkWzFdID0gQ1NldC5pbnRlcnNlY3QoZml4ZWRbMV0sIHRoaXMuZmxvYXRbeDFdKTtcbiAgICB9XG4gICAgaWYgKGZpeGVkWzBdICE9PSBBTEwpIGxvY2F0aW9uLnNwcml0ZVBhdHRlcm5zWzBdID0gcGljayhbLi4uZml4ZWRbMF1dKTtcbiAgICBpZiAoZml4ZWRbMV0gIT09IEFMTCkgbG9jYXRpb24uc3ByaXRlUGF0dGVybnNbMV0gPSBwaWNrKFsuLi5maXhlZFsxXV0pO1xuICAgIGlmIChmaXhlZFsyXSAhPT0gQUxMKSBsb2NhdGlvbi5zcHJpdGVQYWxldHRlc1swXSA9IHBpY2soWy4uLmZpeGVkWzJdXSk7XG4gICAgaWYgKGZpeGVkWzNdICE9PSBBTEwpIGxvY2F0aW9uLnNwcml0ZVBhbGV0dGVzWzFdID0gcGljayhbLi4uZml4ZWRbM11dKTtcbiAgfVxuXG4gIC8vIFRPRE8gLSBzaG91bGQgam9pblBhdHRlcm5zIGV2ZXIgYmUgZmFsc2U/XG4gIG1lZXQodGhhdDogQ29uc3RyYWludCwgam9pblBhdHRlcm5zID0gZmFsc2UpOiBDb25zdHJhaW50IHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnRyeU1lZXQodGhhdCwgam9pblBhdHRlcm5zKTtcbiAgICBpZiAoIXJlc3VsdCkgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgcmVjb25jaWxlIHBhdHRlcm5zYCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKiBAcGFyYW0gZm9yY2UgYWxsb3cgaW5jb21wYXRpYmxlIHBhbGV0dGVzLiAqL1xuICB0cnlNZWV0KHRoYXQ6IENvbnN0cmFpbnQsIGpvaW5QYXR0ZXJucyA9IGZhbHNlKTogQ29uc3RyYWludCB8IHVuZGVmaW5lZCB7XG4gICAgLy8gVGhpcyBpcyB0aGUgdHJpY2t5IG9uZS4gIEl0J3MgdXNlZCAoYSkgdG8gY29tYmluZSBwcm9qZWN0aWxlcyB3aXRoXG4gICAgLy8gdGhlaXIgcGFyZW50cywgYW5kIChiKSB0byBhZGQgYWRkaXRpb25hbCBtb25zdGVycyB0byBhIGxvY2F0aW9uLlxuICAgIC8vIFdlIG5lZWQgdG8gbWFpbnRhaW4gc29tZSBpbnZhcmlhbnRzOiAoMSkgSWYgcGF0MCBvciBwYXQxIGlzIHNldCxcbiAgICAvLyB0aGVuIHBhdFggYW5kIHBhdFkgbXVzdCBpbnRlcnNlY3QgaXQuICBPdGhlcndpc2Ugd2UgY29sbGFwc2UgdGhlXG4gICAgLy8gbm9uLWludGVyc2VjdGluZyBvbmUgZG93bi4gIElmIGFueSBjb25zdHJhaW50IGlzIGVtcHR5LCByZXR1cm5cbiAgICAvLyB1bmRlZmluZWQuXG5cbiAgICBjb25zdCBmaXhlZCA9IFtdO1xuICAgIGxldCBzaGlmdCA9IHRoaXMuc2hpZnQgfCB0aGF0LnNoaWZ0O1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICBsZXQgbWVldCA9IENTZXQuaW50ZXJzZWN0KHRoaXMuZml4ZWRbaV0sIHRoYXQuZml4ZWRbaV0pO1xuICAgICAgaWYgKCFtZWV0LnNpemUpIHtcbiAgICAgICAgaWYgKCFqb2luUGF0dGVybnMgfHwgaSA8IDIpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIG1lZXQgPSBDU2V0LnVuaW9uKHRoaXMuZml4ZWRbaV0sIHRoYXQuZml4ZWRbaV0pO1xuICAgICAgfVxuICAgICAgZml4ZWQucHVzaChtZWV0KTtcbiAgICB9XG5cbiAgICAvLyBOb3cgZGVhbCB3aXRoIHRoZSBmbG9hdCBzbG90cy5cbiAgICAvLyBXZSBtYXkgbmVlZCB0byBkbyBzb21lIG1lcmdpbmcsIGkuZS4gaWYgdGhpcy5mbG9hdCBhbmQgdGhhdC5mbG9hdCBib3RoXG4gICAgLy8gaGF2ZSBlbGVtZW50cy4gIElmIHRoZXkncmUgdGhlIHNhbWUgZWxlbWVudCB0aGVuIHdlJ3JlIG9rYXkuLi4gIFdlIHNob3VsZFxuICAgIC8vIGVhZ2VybHkgbWVldCBhbnkgcGFpcnMgcG9zc2libGUuLi5cblxuICAgIC8vIEludmFyaWFudDogYWxsIGVsZW1lbnRzIGluIGZsb2F0IGFyZSBkaXNqb2ludCBmcm9tIG9uZSBhbm90aGVyLlxuICAgIC8vIEludmFyaWFudDogYWxsIGVsZW1lbnRzIGluIGZsb2F0IG92ZXJsYXAgd2l0aCBhdCBsZWFzdCBvbmUgZml4ZWQgc2V0LlxuXG4gICAgY29uc3QgaW52ZXJzZUZsb2F0ID0gbmV3IE1hcDxudW1iZXIsIG51bWJlcj4oKTtcbiAgICBjb25zdCBmbG9hdDogQ1NldFtdID0gW107XG4gICAgZm9yIChjb25zdCBzIG9mIGl0ZXJzLmNvbmNhdCh0aGlzLmZsb2F0LCB0aGF0LmZsb2F0KSkge1xuICAgICAgaWYgKHMgPT09IEFMTCkgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHVuY29uc3RyYWluZWQgZmxvYXRgKTtcbiAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgICAgZm9yIChjb25zdCBwIG9mIHMpIHtcbiAgICAgICAgY29uc3QgcHJldiA9IGludmVyc2VGbG9hdC5nZXQocCk7XG4gICAgICAgIGlmIChwcmV2ICE9IG51bGwpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IHIgb2YgZmxvYXRbcHJldl0pIGludmVyc2VGbG9hdC5kZWxldGUocik7XG4gICAgICAgICAgZmxvYXRbcHJldl0gPSBDU2V0LmludGVyc2VjdChmbG9hdFtwcmV2XSwgcyk7XG4gICAgICAgICAgZm9yIChjb25zdCByIG9mIGZsb2F0W3ByZXZdKSBpbnZlcnNlRmxvYXQuc2V0KHIsIHByZXYpO1xuICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGZvdW5kKSBicmVhaztcblxuICAgICAgLy8gTm8gaW50ZXJzZWN0aW9uIGJldHdlZW4gdGhpcyBmbG9hdGluZyBjb25zdHJhaW50IGFuZCBhbnkgcHJldmlvdXMsXG4gICAgICAvLyBzbyBhZGQgaXQuICBJZiB0aGVyZSdzIG1vcmUgdGhhbiB0d28sIHdlJ3JlIG91dCBvZiBsdWNrLlxuICAgICAgZm9yIChjb25zdCBwIG9mIHMpIGludmVyc2VGbG9hdC5zZXQocCwgZmxvYXQubGVuZ3RoKTtcbiAgICAgIGZsb2F0LnB1c2gocyk7XG4gICAgICBpZiAoZmxvYXQubGVuZ3RoID4gMikgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICAvLyBOb3cgdGhhdCBmbG9hdCBpcyBjb21wbGV0ZSwgY2hlY2sgdGhlIGludmFyaWFudCB0aGF0IGV2ZXJ5IGZsb2F0aW5nXG4gICAgLy8gc2V0IGludGVyc2VjdHMgd2l0aCBib3RoIGZpeGVkIHNsb3RzLlxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmxvYXQubGVuZ3RoOyBpKyspIHtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMjsgaisrKSB7XG4gICAgICAgIGNvbnN0IGludGVyc2VjdCA9IENTZXQuaW50ZXJzZWN0KGZsb2F0W2ldLCBmaXhlZFtqXSk7XG4gICAgICAgIGlmICghaW50ZXJzZWN0LnNpemUpIHtcbiAgICAgICAgICAvLyBBIGZsb2F0IGlzIGRpc2pvaW50IGZyb20gYSBmaXhlZDogcmVzb2x2ZSB0aGUgb3RoZXIgZml4ZWQgc2xvdC5cbiAgICAgICAgICBjb25zdCBjID0gZml4ZWRbMSAtIGpdID0gQ1NldC5pbnRlcnNlY3QoZmxvYXRbaV0sIGZpeGVkWzEgLSBqXSk7XG4gICAgICAgICAgc2hpZnQgfD0gMSA8PCAoMSAtIGopO1xuICAgICAgICAgIGlmICghYy5zaXplKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgIGZsb2F0LnNwbGljZShpLCAxKTtcbiAgICAgICAgICAvLyBSZXNldCB0aGUgb3V0ZXIgZm9yIGxvb3AgYW5kIGNoZWNrIGFnYWluLlxuICAgICAgICAgIGkgPSAtMTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfSBlbHNlIGlmIChpbnRlcnNlY3Quc2l6ZSA9PT0gZmxvYXRbaV0uc2l6ZSkge1xuICAgICAgICAgIC8vIElmIGZsb2F0W2ldIGlzIGEgc3Vic2V0IG9mIGZpeGVkW2pdIHRoZW4ganVzdCBkcm9wIHRoZSBmbG9hdC5cbiAgICAgICAgICAvLyBmbG9hdC5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgLy8gaS0tO1xuICAgICAgICAgIC8vIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQXQgdGhpcyBwb2ludCwgdGhlIGludmFyaWFudHMgYXJlIHNhdGlzZmllZCwgc28gd2UgY2FuIHJldHVybi5cbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoZml4ZWQsIGZsb2F0LCBzaGlmdCk7XG5cbiAgICAvLyBjb25zdCBwYWwyID0gKHRoaXMucGFsMiB8fCBVTkNPTlNUUkFJTkVEKS5pbnRlcnNlY3QodGhhdC5wYWwyIHx8IFVOQ09OU1RSQUlORUQpO1xuICAgIC8vIGNvbnN0IHBhbDMgPSAodGhpcy5wYWwzIHx8IFVOQ09OU1RSQUlORUQpLmludGVyc2VjdCh0aGF0LnBhbDMgfHwgVU5DT05TVFJBSU5FRCk7XG5cbiAgICAvLyBsZXQgcGF0MCA9ICh0aGlzLnBhdDAgfHwgVU5DT05TVFJBSU5FRCkuaW50ZXJzZWN0KHRoYXQucGF0MCB8fCBVTkNPTlNUUkFJTkVEKTtcbiAgICAvLyBsZXQgcGF0MSA9ICh0aGlzLnBhdDEgfHwgVU5DT05TVFJBSU5FRCkuaW50ZXJzZWN0KHRoYXQucGF0MSB8fCBVTkNPTlNUUkFJTkVEKTtcblxuICAgIC8vIGxldCBwYXRYID0gdW5kZWZpbmVkO1xuICAgIC8vIGxldCBwYXRZID0gdW5kZWZpbmVkO1xuXG4gICAgLy8gLy8gSW5zdGVhZCAtIGxpc3Qgb2YgZmxvYXRpbmcgcGF0dGVybnM/XG4gICAgLy8gLy8gXG5cbiAgICAvLyBpZiAodGhpcy5wYXRYICYmIHRoYXQucGF0WCkge1xuICAgIC8vICAgLy8gaXMgdGhlcmUgYW55IG92ZXJsYXA/XG4gICAgLy8gICBjb25zdCBtZWV0ID0gdGhpcy5wYXRYLmludGVyc2VjdCh0aGF0LnBhdFgpO1xuICAgIC8vICAgaWYgKG1lZXQuc2l6ZSkge1xuICAgIC8vICAgICBwYXRYID0gbWVldDtcbiAgICAvLyAgIH0gZWxzZSBpZiAoIXRoaXMucGF0WSAmJiAhdGhhdC5wYXRZKSB7XG4gICAgLy8gICAgIHBhdFggPSB0aGlzLnBhdFg7XG4gICAgLy8gICAgIHBhdFkgPSB0aGF0LnBhdFg7XG4gICAgLy8gICB9XG4gICAgLy8gfVxuXG4gICAgLy8gbGV0IHBhdFggPSAodGhpcy5wYXRYIHx8IFVOQ09OU1RSQUlORUQpLmludGVyc2VjdCh0aGF0LnBhdFggfHwgVU5DT05TVFJBSU5FRCk7XG4gICAgLy8gbGV0IHBhdFkgPSAodGhpcy5wYXRZIHx8IFVOQ09OU1RSQUlORUQpLmludGVyc2VjdCh0aGF0LnBhdFkgfHwgVU5DT05TVFJBSU5FRCk7XG4gIH1cbn1cblxuLy8gTUlHSFQgYmUgcG9zc2libGUgdG8gaGF2ZSBhIGNvbWJpbmF0aW9uP1xuLy8gICAtLSBzdXBwb3NlIHdlIGhhdmUgb3JjcyB3aXRoIHBhdFggPSAxfDIgYW5kIGF4ZSBoYXMgcGF0MiA9IDF8My5cbi8vICAgICAgdGhlbiBwYXQxPTIscGF0Mj0zIGlzIGFuIG9wdGlvbi4uLiBidXQgaXQncyBsZXNzIG9idmlvdXMuXG4vLyAgIC0tIHdlIG5lZWQgYSBcIm1lZXRcIiBmdW5jdGlvbmFsaXR5IGZvciBjb21iaW5pbmcgbW9uc3RlcnMgdy8gcHJvamVjdGlsZXNcblxuLy8gVHdvIGRpZmZlcmVudCBjb25zdHJhaW50cywgd2l0aCAoc2xpZ2h0bHkgZGlmZmVyZW50KT8gYmVoYXZpb3I6XG4vLyAgIC0gNSBzZXRzXG4vLyAgIC0gcnVsZXMgZm9yIGludGVyYWN0aW9uIG9mIHBhdDAsIHBhdDEsIHBhdFhcbi8vICAgLSAocGF0MCxwYXQxKSBhbmQgcGF0WCBtdXN0IG5vdCBiZSBkaXNqb2ludFxuLy8gICAgIGlmIHBhdDAgZGlzam9pbnQgZnJvbSBwYXRYIHRoZW4gcGF0MSA8LSBwYXRYLlxuLy8gICAtIGlmIGFueSBzZXQgcmVkdWNlZCB0byAxIGVsZW1lbnQsIGl0J3MgZml4ZWRcbi8vICAgLSBhbHNvIHBhdFkgYnV0IGl0J3MgbmV2ZXIgc3RvcmVkPz8gIGl0J3MgcG9zc2libGVcbi8vICAgICB0aGF0IGl0IGlzIHN0b3JlZCBhbmQgaGFzIHRoZSBzYW1lIHJ1bGVzXG4vLyAgICAgLT4gY29sbGFzZSBhcyBzb29uIGFzIHBvc3NpYmxlLi4uXG5cbi8vIGNsYXNzIFN0YXRpY0NvbnN0cmFpbnQgZXh0ZW5kcyBHcmFwaGljc0NvbnN0cmFpbnQge1xuLy8gICByZWFkb25seSBwYXQwPzogU2V0PG51bWJlcj47XG4vLyAgIHJlYWRvbmx5IHBhdDE/OiBTZXQ8bnVtYmVyPjtcbi8vIH1cblxuLy8gY2xhc3MgU2hpZnRDb25zdHJhaW50IGV4dGVuZHMgR3JhcGhpY3NDb25zdHJhaW50IHtcbi8vICAgcmVhZG9ubHkgcGF0WDogU2V0PG51bWJlcj47XG4vLyB9XG5cbi8vIGV4cG9ydCBjbGFzcyBYQ29uc3RyYWludCB7XG5cbi8vICAgcmVhZG9ubHkgb3B0aW9ucyA9IG5ldyBNYXA8c3RyaW5nLCBPcHRpb24+KCk7XG5cbi8vICAgY29uc3RydWN0b3Iob3B0aW9uczogcmVhZG9ubHkgT3B0aW9uW10gfCBNYXA8c3RyaW5nLCBPcHRpb24+ID0gW0FMTF0sXG4vLyAgICAgICAgICAgICAgIHJlYWRvbmx5IHNoaWZ0YWJsZT86IG51bWJlcikge1xuLy8gICAgIGlmIChvcHRpb25zIGluc3RhbmNlb2YgTWFwKSB7XG4vLyAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuLy8gICAgIH0gZWxzZSB7XG4vLyAgICAgICBmb3IgKGxldCBvcHRpb24gb2Ygb3B0aW9ucykge1xuLy8gICAgICAgICBjb25zdCBsYWJlbCA9IG9wdGlvbi5sYWJlbCgpO1xuLy8gICAgICAgICBjb25zdCBwcmV2ID0gdGhpcy5vcHRpb25zLmdldChsYWJlbCk7XG4vLyAgICAgICAgIGlmIChwcmV2KSBvcHRpb24gPSBwcmV2Lm1lZXQob3B0aW9uKSE7XG4vLyAgICAgICAgIHRoaXMub3B0aW9ucy5zZXQobGFiZWwsIG9wdGlvbik7XG4vLyAgICAgICB9XG4vLyAgICAgfVxuLy8gICB9XG5cbi8vICAgc3RhdGljIHNoaWZ0YWJsZShwYWdlOiBudW1iZXIpOiBDb25zdHJhaW50IHtcbi8vICAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW10sIHBhZ2UpO1xuLy8gICB9XG5cbi8vICAgc3RhdGljIHBhdDAocGFnZXM6IEl0ZXJhYmxlPG51bWJlcj4pOiBDb25zdHJhaW50IHtcbi8vICAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoWy4uLnBhZ2VzXS5tYXAocCA9PiBuZXcgT3B0aW9uKHApKSk7XG4vLyAgIH1cblxuLy8gICBzdGF0aWMgcGF0MShwYWdlczogSXRlcmFibGU8bnVtYmVyPik6IENvbnN0cmFpbnQge1xuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbLi4ucGFnZXNdLm1hcChwID0+IG5ldyBPcHRpb24oLTEsIHApKSk7XG4vLyAgIH1cblxuLy8gICBzdGF0aWMgcGFsMihwYWdlczogSXRlcmFibGU8bnVtYmVyPik6IENvbnN0cmFpbnQge1xuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbLi4ucGFnZXNdLm1hcChwID0+IG5ldyBPcHRpb24oLTEsIC0xLCBwKSkpO1xuLy8gICB9XG5cbi8vICAgc3RhdGljIHBhbDMocGFnZXM6IEl0ZXJhYmxlPG51bWJlcj4pOiBDb25zdHJhaW50IHtcbi8vICAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoWy4uLnBhZ2VzXS5tYXAocCA9PiBuZXcgT3B0aW9uKC0xLCAtMSwgLTEsIHApKSk7XG4vLyAgIH1cblxuLy8gICBzcGF3bihzbG90OiBudW1iZXIpOiBDb25zdHJhaW50IHtcbi8vICAgICAvLyByZWFsaXplIGEgc2hpZnRhYmxlIGludG8gYSBjb25jcmV0ZSBjb25zdHJhaW50XG4vLyAgICAgaWYgKHRoaXMuc2hpZnRhYmxlID09IG51bGwpIHJldHVybiB0aGlzO1xuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbXG4vLyAgICAgICBuZXcgT3B0aW9uKHRoaXMuc2hpZnRhYmxlLCAtMSwgLTEsIC0xLCBuZXcgTWFwKFtbc2xvdCwgMF1dKSksXG4vLyAgICAgICBuZXcgT3B0aW9uKC0xLCB0aGlzLnNoaWZ0YWJsZSwgLTEsIC0xLCBuZXcgTWFwKFtbc2xvdCwgMV1dKSlcbi8vICAgICBdKS5tZWV0KG5ldyBDb25zdHJhaW50KHRoaXMub3B0aW9ucykpO1xuLy8gICB9XG5cbi8vICAgam9pbih0aGF0OiBDb25zdHJhaW50KTogQ29uc3RyYWludCB7XG4vLyAgICAgaWYgKHRoaXMuc2hpZnRhYmxlICE9IG51bGwgJiYgdGhhdC5zaGlmdGFibGUgIT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdib3RoIHNoaWZ0Jyk7XG4vLyAgICAgY29uc3Qgb3V0ID0gbmV3IE1hcDxzdHJpbmcsIE9wdGlvbj4oKTtcbi8vICAgICBmb3IgKGxldCBbbGFiZWwsIG9wdGlvbl0gb2YgWy4uLnRoaXMub3B0aW9ucywgLi4udGhhdC5vcHRpb25zXSkge1xuLy8gICAgICAgY29uc3QgcHJldiA9IG91dC5nZXQobGFiZWwpO1xuLy8gICAgICAgaWYgKHByZXYpIG9wdGlvbiA9IHByZXYubWVldChvcHRpb24pITtcbi8vICAgICAgIG91dC5zZXQobGFiZWwsIG9wdGlvbik7XG4vLyAgICAgfVxuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludChvdXQsIHRoaXMuc2hpZnRhYmxlICE9IG51bGwgPyB0aGlzLnNoaWZ0YWJsZSA6IHRoYXQuc2hpZnRhYmxlKTtcbi8vICAgfVxuXG4vLyAgIG1lZXQodGhhdDogQ29uc3RyYWludCk6IENvbnN0cmFpbnQge1xuLy8gICAgIC8vIFRha2UgdGhlIGNyb3NzIHByb2R1Y3Qgb2YgYm90aCBzZXRzIG9mIG9wdGlvbnMuXG4vLyAgICAgaWYgKHRoaXMuc2hpZnRhYmxlICE9IG51bGwgJiYgdGhhdC5zaGlmdGFibGUgIT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdib3RoIHNoaWZ0Jyk7XG4vLyAgICAgY29uc3Qgb3V0ID0gbmV3IE1hcDxzdHJpbmcsIE9wdGlvbj4oKTtcbi8vICAgICBmb3IgKGNvbnN0IGEgb2YgdGhpcy5vcHRpb25zLnZhbHVlcygpKSB7XG4vLyAgICAgICBmb3IgKGNvbnN0IGIgb2YgdGhhdC5vcHRpb25zLnZhbHVlcygpKSB7XG4vLyAgICAgICAgIGxldCBvcHRpb24gPSBhLm1lZXQoYik7XG4vLyAgICAgICAgIGlmICghb3B0aW9uKSBjb250aW51ZTtcbi8vICAgICAgICAgY29uc3QgbGFiZWwgPSBvcHRpb24ubGFiZWwoKTtcbi8vICAgICAgICAgY29uc3QgcHJldiA9IG91dC5nZXQobGFiZWwpO1xuLy8gICAgICAgICBpZiAocHJldikgb3B0aW9uID0gcHJldi5tZWV0KG9wdGlvbikhO1xuLy8gICAgICAgICBvdXQuc2V0KGxhYmVsLCBvcHRpb24pO1xuLy8gICAgICAgfVxuLy8gICAgIH1cbi8vICAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQob3V0LCB0aGlzLnNoaWZ0YWJsZSAhPSBudWxsID8gdGhpcy5zaGlmdGFibGUgOiB0aGF0LnNoaWZ0YWJsZSk7XG4vLyAgIH1cbi8vIH1cblxuLy8gZXhwb3J0IGNsYXNzIE9wdGlvbiB7XG4vLyAgIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHBhdDA6IG51bWJlciA9IC0xLFxuLy8gICAgICAgICAgICAgICByZWFkb25seSBwYXQxOiBudW1iZXIgPSAtMSxcbi8vICAgICAgICAgICAgICAgcmVhZG9ubHkgcGFsMjogbnVtYmVyID0gLTEsXG4vLyAgICAgICAgICAgICAgIHJlYWRvbmx5IHBhbDM6IG51bWJlciA9IC0xLFxuLy8gICAgICAgICAgICAgICByZWFkb25seSBwYWdlcyA9IG5ldyBNYXA8bnVtYmVyLCBudW1iZXI+KCkpIHt9XG5cbi8vICAgbWVldCh0aGF0OiBPcHRpb24pOiBPcHRpb24gfCBudWxsIHtcbi8vICAgICBjb25zdCBwYXQwID0gbWVldCh0aGlzLnBhdDAsIHRoYXQucGF0MCk7XG4vLyAgICAgY29uc3QgcGF0MSA9IG1lZXQodGhpcy5wYXQxLCB0aGF0LnBhdDEpO1xuLy8gICAgIGNvbnN0IHBhbDIgPSBtZWV0KHRoaXMucGFsMiwgdGhhdC5wYWwyKTtcbi8vICAgICBjb25zdCBwYWwzID0gbWVldCh0aGlzLnBhbDMsIHRoYXQucGFsMyk7XG4vLyAgICAgaWYgKGlzTmFOKHBhdDApIHx8IGlzTmFOKHBhdDEpIHx8IGlzTmFOKHBhbDIpIHx8IGlzTmFOKHBhbDMpKSByZXR1cm4gbnVsbDtcbi8vICAgICByZXR1cm4gbmV3IE9wdGlvbihwYXQwLCBwYXQxLCBwYWwyLCBwYWwzLCBuZXcgTWFwKFsuLi50aGlzLnBhZ2VzLCAuLi50aGF0LnBhZ2VzXSkpO1xuLy8gICB9XG5cbi8vICAgbGFiZWwoKTogc3RyaW5nIHtcbi8vICAgICByZXR1cm4gYCR7dGhpcy5wYXQwfSAke3RoaXMucGF0MX0gJHt0aGlzLnBhbDJ9ICR7dGhpcy5wYWwzfWA7XG4vLyAgIH1cbi8vIH1cblxuLy8gY29uc3QgQUxMID0gbmV3IE9wdGlvbigpO1xuXG4vLyBmdW5jdGlvbiBtZWV0KGE6IG51bWJlciwgYjogbnVtYmVyKTogbnVtYmVyIHtcbi8vICAgaWYgKGEgPCAwKSByZXR1cm4gYjtcbi8vICAgaWYgKGIgPCAwKSByZXR1cm4gYTtcbi8vICAgaWYgKGEgPT09IGIpIHJldHVybiBhO1xuLy8gICByZXR1cm4gTmFOO1xuLy8gfVxuXG5jb25zdCBUUkVBU1VSRV9DSEVTVF9CQU5LUyA9IG5ldyBTZXQoW1xuICAvLyBOT1RFOiAkNTEgaGFzIHRoZSB0cmVhc3VyZSBjaGVzdCBzcHJpdGVzLCBidXQgaW4gdGhlIHdyb25nIHNwb3QuXG4gIDB4NWUsIDB4NWYsIDB4NjAsIDB4NjEsIDB4NjQsIDB4NjUsIDB4NjYsIDB4NjcsXG4gIDB4NjgsIDB4NjksIDB4NmEsIDB4NmMsIDB4NmQsIDB4NmUsIDB4NmYsIDB4NzAsXG4gIDB4NzQsIDB4NzUsIDB4NzYsIDB4NzcsXG5dKTtcblxuY29uc3QgQ09JTl9CQU5LUyA9IG5ldyBTZXQoW1xuICAweDVlLCAweDVmLCAweDYwLCAweDYxLCAweDYzLCAweDY0LCAweDY1LCAweDY2LFxuICAweDY3LCAweDY4LCAweDY5LCAweDZhLCAweDZiLCAweDZjLCAweDZkLCAweDZlLFxuICAweDZmLCAweDcwLCAweDc0LCAweDc1LCAweDc2LCAweDc3LFxuXSk7XG4iXX0=