import { seq } from "./util.js";
import { iters } from "../util.js";
const EMPTY_ITERATOR = {
    next() { return { done: true }; },
};
const NONE = {
    get size() { return 0; },
    has() { return false; },
    [Symbol.iterator]() { return EMPTY_ITERATOR; },
};
const ALL = {
    get size() { return Infinity; },
    has() { return true; },
    [Symbol.iterator]() { throw new Error('cannot iterate'); },
};
class Bit {
    constructor(bit) {
        this.bit = bit;
    }
    get size() { return 1; }
    has(x) { return x === this.bit; }
    [Symbol.iterator]() { return [this.bit][Symbol.iterator](); }
}
function bit(x) {
    return new Bit(x);
}
var CSet;
(function (CSet) {
    function intersect(a, b) {
        if (a === ALL || !b.size)
            return b;
        if (b === ALL || !a.size)
            return a;
        const out = new Set();
        for (const x of a) {
            if (b.has(x))
                out.add(x);
        }
        if (!out.size)
            return NONE;
        return out;
    }
    CSet.intersect = intersect;
    function union(a, b) {
        if (a === ALL || !b.size)
            return a;
        if (b === ALL || !a.size)
            return b;
        const out = new Set(a);
        for (const x of b) {
            out.add(x);
        }
        return out;
    }
    CSet.union = union;
    function isSubset(subset, superset) {
        if (superset === ALL || !subset.size)
            return true;
        if (subset.size > superset.size)
            return false;
        for (const x of subset) {
            if (!superset.has(x))
                return false;
        }
        return true;
    }
    CSet.isSubset = isSubset;
    function label(x) {
        return x === ALL ? 'all' : [...x].sort().join(' ');
    }
    CSet.label = label;
})(CSet || (CSet = {}));
export class Constraint {
    constructor(fixed, float, shift) {
        this.fixed = fixed;
        this.float = float;
        this.shift = shift;
    }
    get pat0() { return this.fixed[0]; }
    get pat1() { return this.fixed[1]; }
    get pal2() { return this.fixed[2]; }
    get pal3() { return this.fixed[3]; }
    static get ALL() {
        return new Constraint([ALL, ALL, ALL, ALL], [], 0);
    }
    static get NONE() {
        return new Constraint([NONE, NONE, NONE, NONE], [], 0);
    }
    static get MIMIC() {
        return new Constraint([ALL, bit(0x6c), ALL, ALL], [], 2);
    }
    static get TREASURE_CHEST() {
        return new Constraint([ALL, ALL, ALL, ALL], [TREASURE_CHEST_BANKS], 0);
    }
    static get BOSS() {
        return new Constraint([TREASURE_CHEST_BANKS, ALL, ALL, ALL], [], 0);
    }
    static get COIN() {
        return new Constraint([COIN_BANKS, ALL, ALL, ALL], [], 0);
    }
    static get STOM_FIGHT() {
        return new Constraint([ALL, new Set([0x4d]), ALL, ALL], [], 0);
    }
    static get GUARDIAN_STATUE() {
        return new Constraint([new Set([0x74]), new Set([0x62]), ALL, ALL], [], 0);
    }
    static get SHOOTING_WALL() {
        return new Constraint([new Set([0x61]), ALL, ALL], [], 0);
    }
    static get KENSU_CHEST() {
        return new Constraint([new Set([0x51]), ALL, ALL, ALL], [], 0);
    }
    static forLocation(id) {
        switch (id) {
            case 0x03:
                return new Constraint([ALL, bit(0x60), ALL, bit(0x20)], [], 0);
            case 0x60:
            case 0x64:
            case 0x68:
                return new Constraint([ALL, bit(0x52), ALL, bit(0x08)], [], 0);
        }
        return Constraint.ALL;
    }
    static fromSpawn(palettes, patterns, location, spawn, shiftable) {
        const [firstPattern, ...rest] = patterns;
        shiftable = shiftable && firstPattern === 2 && !rest.length;
        if (shiftable && spawn.patternBank)
            patterns = new Set([3]);
        const pat0 = shiftable || !patterns.has(2) ? ALL : bit(location.spritePatterns[0]);
        const pat1 = shiftable || !patterns.has(3) ? ALL : bit(location.spritePatterns[1]);
        const float = shiftable ? [bit(location.spritePatterns[spawn.patternBank])] : [];
        const pal2 = palettes.has(2) ? bit(location.spritePalettes[0]) : ALL;
        const pal3 = palettes.has(3) ? bit(location.spritePalettes[1]) : ALL;
        return new Constraint([pat0, pat1, pal2, pal3], float, 0);
    }
    ignorePalette() {
        return new Constraint([this.fixed[0], this.fixed[1], ALL, ALL], this.float, this.shift);
    }
    shufflePalette(random, usedPalettes) {
        const fixed = [...this.fixed];
        for (let i = 2; i < 4; i++) {
            if (fixed[i] === ALL)
                continue;
            const size = Math.floor(5 - Math.log2(random.nextInt(15) + 2));
            const out = fixed[i] = new Set();
            for (let i = 0; i < size; i++) {
                out.add(random.pick(usedPalettes));
            }
        }
        return new Constraint(fixed, this.float, this.shift);
    }
    shifted() {
        return new Constraint(this.fixed, this.float, this.shift | 2);
    }
    join(that) {
        const fixed = seq(4, i => CSet.union(this.fixed[i], that.fixed[i]));
        if (this.float.length != that.float.length) {
            console.dir(this);
            console.dir(that);
            throw new Error(`incompatible float: ${this.float} ${that.float}`);
        }
        const float = seq(this.float.length, i => CSet.union(this.float[i], that.float[i]));
        return new Constraint(fixed, float, this.shift | that.shift);
    }
    fix(location, random) {
        const nextInt = random ? (x) => random.nextInt(x) : () => 0;
        const pick = random ? (xs) => random.pick([...xs]) :
            (xs) => xs[Symbol.iterator]().next().value;
        const fixed = [...this.fixed];
        if (this.float.length) {
            const x0 = nextInt(2);
            const x1 = 1 - x0;
            if (x0 < this.float.length)
                fixed[0] = CSet.intersect(fixed[0], this.float[x0]);
            if (x1 < this.float.length)
                fixed[1] = CSet.intersect(fixed[1], this.float[x1]);
        }
        if (fixed[0] !== ALL)
            location.spritePatterns[0] = pick([...fixed[0]]);
        if (fixed[1] !== ALL)
            location.spritePatterns[1] = pick([...fixed[1]]);
        if (fixed[2] !== ALL)
            location.spritePalettes[0] = pick([...fixed[2]]);
        if (fixed[3] !== ALL)
            location.spritePalettes[1] = pick([...fixed[3]]);
    }
    meet(that, joinPatterns = false) {
        const result = this.tryMeet(that, joinPatterns);
        if (!result)
            throw new Error(`Could not reconcile patterns`);
        return result;
    }
    tryMeet(that, joinPatterns = false) {
        const fixed = [];
        let shift = this.shift | that.shift;
        for (let i = 0; i < 4; i++) {
            let meet = CSet.intersect(this.fixed[i], that.fixed[i]);
            if (!meet.size) {
                if (!joinPatterns || i < 2)
                    return undefined;
                meet = CSet.union(this.fixed[i], that.fixed[i]);
            }
            fixed.push(meet);
        }
        const inverseFloat = new Map();
        const float = [];
        for (const s of iters.concat(this.float, that.float)) {
            if (s === ALL)
                throw new Error(`Unexpected unconstrained float`);
            let found = false;
            for (const p of s) {
                const prev = inverseFloat.get(p);
                if (prev != null) {
                    for (const r of float[prev])
                        inverseFloat.delete(r);
                    float[prev] = CSet.intersect(float[prev], s);
                    for (const r of float[prev])
                        inverseFloat.set(r, prev);
                    found = true;
                    break;
                }
            }
            if (found)
                break;
            for (const p of s)
                inverseFloat.set(p, float.length);
            float.push(s);
            if (float.length > 2)
                return undefined;
        }
        for (let i = 0; i < float.length; i++) {
            for (let j = 0; j < 2; j++) {
                const intersect = CSet.intersect(float[i], fixed[j]);
                if (!intersect.size) {
                    const c = fixed[1 - j] = CSet.intersect(float[i], fixed[1 - j]);
                    shift |= 1 << (1 - j);
                    if (!c.size)
                        return undefined;
                    float.splice(i, 1);
                    i = -1;
                    break;
                }
                else if (intersect.size === float[i].size) {
                }
            }
        }
        return new Constraint(fixed, float, shift);
    }
}
const TREASURE_CHEST_BANKS = new Set([
    0x5e, 0x5f, 0x60, 0x61, 0x64, 0x65, 0x66, 0x67,
    0x68, 0x69, 0x6a, 0x6c, 0x6d, 0x6e, 0x6f, 0x70,
    0x74, 0x75, 0x76, 0x77,
]);
const COIN_BANKS = new Set([
    0x5e, 0x5f, 0x60, 0x61, 0x63, 0x64, 0x65, 0x66,
    0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c, 0x6d, 0x6e,
    0x6f, 0x70, 0x74, 0x75, 0x76, 0x77,
]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RyYWludC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vY29uc3RyYWludC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQzlCLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFZakMsTUFBTSxjQUFjLEdBQXFCO0lBQ3ZDLElBQUksS0FBSyxPQUFPLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBUSxDQUFDLENBQUMsQ0FBQztDQUN2QyxDQUFDO0FBRUYsTUFBTSxJQUFJLEdBQVM7SUFDakIsSUFBSSxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLEdBQUcsS0FBSyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDdkIsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssT0FBTyxjQUFjLENBQUMsQ0FBQyxDQUFDO0NBQy9DLENBQUM7QUFFRixNQUFNLEdBQUcsR0FBUztJQUNoQixJQUFJLElBQUksS0FBSyxPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDL0IsR0FBRyxLQUFLLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN0QixDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxNQUFNLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDO0NBQzNELENBQUE7QUFFRCxNQUFNLEdBQUc7SUFDUCxZQUFxQixHQUFXO1FBQVgsUUFBRyxHQUFILEdBQUcsQ0FBUTtJQUFHLENBQUM7SUFDcEMsSUFBSSxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLEdBQUcsQ0FBQyxDQUFTLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssT0FB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QUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDbEIsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNO2dCQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDaEYsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNO2dCQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDakY7UUFDRCxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHO1lBQUUsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkUsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRztZQUFFLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUc7WUFBRSxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2RSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHO1lBQUUsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENB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RSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSTtJQUM5QyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJO0NBQ3ZCLENBQUMsQ0FBQztBQUVILE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxDQUFDO0lBQ3pCLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJO0lBQzlDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJO0lBQzlDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSTtDQUNuQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0xvY2F0aW9uLCBTcGF3bn0gZnJvbSBcIi4vbG9jYXRpb24uanNcIjtcbmltcG9ydCB7c2VxfSBmcm9tIFwiLi91dGlsLmpzXCI7XG5pbXBvcnQge2l0ZXJzfSBmcm9tIFwiLi4vdXRpbC5qc1wiO1xuaW1wb3J0IHtSYW5kb219IGZyb20gXCIuLi9yYW5kb20uanNcIjtcblxuLy8gQ29uc3RyYWludCBmb3IgcGF0dGVybiBhbmQgcGFsZXR0ZSBwYWdlcy5cbi8vIEFsbG93cyBtdWx0aXBsZSBwb3NzaWJpbGl0aWVzLCBhbmQgYSBjYWxsYmFjayB3aGVuIG9uZSBpcyBwaWNrZWQuXG5cbmludGVyZmFjZSBDU2V0IHtcbiAgcmVhZG9ubHkgc2l6ZTogbnVtYmVyO1xuICBoYXM6ICh4OiBudW1iZXIpID0+IGJvb2xlYW47XG4gIFtTeW1ib2wuaXRlcmF0b3JdOiAoKSA9PiBJdGVyYXRvcjxudW1iZXI+O1xufVxuXG5jb25zdCBFTVBUWV9JVEVSQVRPUjogSXRlcmF0b3I8bnVtYmVyPiA9IHtcbiAgbmV4dCgpIHsgcmV0dXJuIHtkb25lOiB0cnVlfSBhcyBhbnk7IH0sXG59O1xuXG5jb25zdCBOT05FOiBDU2V0ID0ge1xuICBnZXQgc2l6ZSgpIHsgcmV0dXJuIDA7IH0sXG4gIGhhcygpIHsgcmV0dXJuIGZhbHNlOyB9LFxuICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsgcmV0dXJuIEVNUFRZX0lURVJBVE9SOyB9LFxufTtcblxuY29uc3QgQUxMOiBDU2V0ID0ge1xuICBnZXQgc2l6ZSgpIHsgcmV0dXJuIEluZmluaXR5OyB9LFxuICBoYXMoKSB7IHJldHVybiB0cnVlOyB9LFxuICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsgdGhyb3cgbmV3IEVycm9yKCdjYW5ub3QgaXRlcmF0ZScpOyB9LFxufVxuXG5jbGFzcyBCaXQgaW1wbGVtZW50cyBDU2V0IHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYml0OiBudW1iZXIpIHt9XG4gIGdldCBzaXplKCkgeyByZXR1cm4gMTsgfVxuICBoYXMoeDogbnVtYmVyKSB7IHJldHVybiB4ID09PSB0aGlzLmJpdDsgfVxuICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsgcmV0dXJuIFt0aGlzLmJpdF1bU3ltYm9sLml0ZXJhdG9yXSgpOyB9XG59XG5cbmZ1bmN0aW9uIGJpdCh4OiBudW1iZXIpOiBCaXQge1xuICByZXR1cm4gbmV3IEJpdCh4KTtcbn1cblxubmFtZXNwYWNlIENTZXQge1xuICBleHBvcnQgZnVuY3Rpb24gaW50ZXJzZWN0KGE6IENTZXQsIGI6IENTZXQpOiBDU2V0IHtcbiAgICBpZiAoYSA9PT0gQUxMIHx8ICFiLnNpemUpIHJldHVybiBiO1xuICAgIGlmIChiID09PSBBTEwgfHwgIWEuc2l6ZSkgcmV0dXJuIGE7XG4gICAgY29uc3Qgb3V0ID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgZm9yIChjb25zdCB4IG9mIGEpIHtcbiAgICAgIGlmIChiLmhhcyh4KSkgb3V0LmFkZCh4KTtcbiAgICB9XG4gICAgaWYgKCFvdXQuc2l6ZSkgcmV0dXJuIE5PTkU7XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuICBleHBvcnQgZnVuY3Rpb24gdW5pb24oYTogQ1NldCwgYjogQ1NldCk6IENTZXQge1xuICAgIGlmIChhID09PSBBTEwgfHwgIWIuc2l6ZSkgcmV0dXJuIGE7XG4gICAgaWYgKGIgPT09IEFMTCB8fCAhYS5zaXplKSByZXR1cm4gYjtcbiAgICBjb25zdCBvdXQgPSBuZXcgU2V0KGEpO1xuICAgIGZvciAoY29uc3QgeCBvZiBiKSB7XG4gICAgICBvdXQuYWRkKHgpO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9XG4gIGV4cG9ydCBmdW5jdGlvbiBpc1N1YnNldChzdWJzZXQ6IENTZXQsIHN1cGVyc2V0OiBDU2V0KTogYm9vbGVhbiB7XG4gICAgaWYgKHN1cGVyc2V0ID09PSBBTEwgfHwgIXN1YnNldC5zaXplKSByZXR1cm4gdHJ1ZTtcbiAgICBpZiAoc3Vic2V0LnNpemUgPiBzdXBlcnNldC5zaXplKSByZXR1cm4gZmFsc2U7XG4gICAgZm9yIChjb25zdCB4IG9mIHN1YnNldCkge1xuICAgICAgaWYgKCFzdXBlcnNldC5oYXMoeCkpIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgZXhwb3J0IGZ1bmN0aW9uIGxhYmVsKHg6IENTZXQpOiBzdHJpbmcge1xuICAgIHJldHVybiB4ID09PSBBTEwgPyAnYWxsJyA6IFsuLi54XS5zb3J0KCkuam9pbignICcpO1xuICB9XG59XG5cbi8vIGNsYXNzIENvbnN0cmFpbnRTZXQge1xuLy8gICBjb25zdHJ1Y3RvcihyZWFkb25seSBhbGxvd2VkPzogU2V0PG51bWJlcj4pIHt9XG5cbi8vICAgZ2V0IHNpemUoKSB7IHJldHVybiB0aGlzLmFsbG93ZWQgPyB0aGlzLmFsbG93ZWQuc2l6ZSA6IEluZmluaXR5OyB9XG4vLyAgIGhhcyh4OiBudW1iZXIpIHsgcmV0dXJuIHRoaXMuYWxsb3dlZCA/IHRoaXMuYWxsb3dlZC5oYXMoeCkgOiB0cnVlOyB9XG4vLyAgIGludGVyc2VjdCh0aGF0OiBDb25zdHJhaW50U2V0KTogQ29uc3RyYWludFNldCB7XG4vLyAgICAgaWYgKCF0aGlzLmFsbG93ZWQpIHJldHVybiB0aGF0O1xuLy8gICAgIGlmICghdGhhdC5hbGxvd2VkKSByZXR1cm4gdGhpcztcbi8vICAgICBjb25zdCBvdXQgPSBuZXcgU2V0PG51bWJlcj4oKTtcbi8vICAgICBmb3IgKGNvbnN0IHggb2YgdGhpcy5hbGxvd2VkKSB7XG4vLyAgICAgICBpZiAodGhhdC5hbGxvd2VkLmhhcyh4KSkgb3V0LmFkZCh4KTtcbi8vICAgICB9XG4vLyAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50U2V0KG91dCk7XG4vLyAgIH0gICAgXG4vLyAgIHVuaW9uKHRoYXQ6IENvbnN0cmFpbnRTZXQpOiBDb25zdHJhaW50U2V0IHtcbi8vICAgICBpZiAoIXRoaXMuYWxsb3dlZCkgcmV0dXJuIHRoaXM7XG4vLyAgICAgaWYgKCF0aGF0LmFsbG93ZWQpIHJldHVybiB0aGF0O1xuLy8gICAgIGNvbnN0IG91dCA9IG5ldyBTZXQodGhpcy5hbGxvd2VkKTtcbi8vICAgICBmb3IgKGNvbnN0IHggb2YgdGhhdC5hbGxvd2VkKSB7XG4vLyAgICAgICBvdXQuYWRkKHgpO1xuLy8gICAgIH1cbi8vICAgICByZXR1cm4gbmV3IENvbnN0cmFpbnRTZXQob3V0KTtcbi8vICAgfVxuLy8gfVxuXG4vLyBjb25zdCBVTkNPTlNUUkFJTkVEID0gbmV3IENvbnN0cmFpbnRTZXQoKTtcblxuLy8gZnVuY3Rpb24gY29uc3RyYWludCh4OiBudW1iZXIpOiBDb25zdHJhaW50U2V0IHtcbi8vICAgcmV0dXJuIG5ldyBDb25zdHJhaW50U2V0KG5ldyBTZXQoW3hdKSk7XG4vLyB9XG5cbmV4cG9ydCBjbGFzcyBDb25zdHJhaW50IHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgZml4ZWQ6IFJlYWRvbmx5QXJyYXk8Q1NldD4sIC8vIGxlbmd0aCBhbHdheXMgNFxuICAgICAgICAgICAgICByZWFkb25seSBmbG9hdDogUmVhZG9ubHlBcnJheTxDU2V0PixcbiAgICAgICAgICAgICAgLy8gYml0c2V0IG9mIHBhZ2VzIHRoYXQgaGF2ZSBiZWVuIHNoaWZ0ZWQgZnJvbSBhIGZsb2F0LlxuICAgICAgICAgICAgICByZWFkb25seSBzaGlmdDogbnVtYmVyKSB7fVxuXG4gIGdldCBwYXQwKCk6IENTZXQgeyByZXR1cm4gdGhpcy5maXhlZFswXTsgfVxuICBnZXQgcGF0MSgpOiBDU2V0IHsgcmV0dXJuIHRoaXMuZml4ZWRbMV07IH1cbiAgZ2V0IHBhbDIoKTogQ1NldCB7IHJldHVybiB0aGlzLmZpeGVkWzJdOyB9XG4gIGdldCBwYWwzKCk6IENTZXQgeyByZXR1cm4gdGhpcy5maXhlZFszXTsgfVxuXG4gIHN0YXRpYyBnZXQgQUxMKCkge1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbQUxMLCBBTEwsIEFMTCwgQUxMXSwgW10sIDApO1xuICB9XG5cbiAgc3RhdGljIGdldCBOT05FKCkge1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbTk9ORSwgTk9ORSwgTk9ORSwgTk9ORV0sIFtdLCAwKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgTUlNSUMoKSB7XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtBTEwsIGJpdCgweDZjKSwgQUxMLCBBTExdLCBbXSwgMik7XG4gIH1cblxuICBzdGF0aWMgZ2V0IFRSRUFTVVJFX0NIRVNUKCkge1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbQUxMLCBBTEwsIEFMTCwgQUxMXSwgW1RSRUFTVVJFX0NIRVNUX0JBTktTXSwgMCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0IEJPU1MoKSB7XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtUUkVBU1VSRV9DSEVTVF9CQU5LUywgQUxMLCBBTEwsIEFMTF0sIFtdLCAwKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgQ09JTigpIHtcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW0NPSU5fQkFOS1MsIEFMTCwgQUxMLCBBTExdLCBbXSwgMCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0IFNUT01fRklHSFQoKSB7XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtBTEwsIG5ldyBTZXQoWzB4NGRdKSwgQUxMLCBBTExdLCBbXSwgMCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0IEdVQVJESUFOX1NUQVRVRSgpIHtcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW25ldyBTZXQoWzB4NzRdKSwgbmV3IFNldChbMHg2Ml0pLCBBTEwsIEFMTF0sIFtdLCAwKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgU0hPT1RJTkdfV0FMTCgpIHtcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW25ldyBTZXQoWzB4NjFdKSwgQUxMLCBBTExdLCBbXSwgMCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0IEtFTlNVX0NIRVNUKCkge1xuICAgIC8vIEtlbnN1IGV4cGxpY2l0bHkgZ2l2ZXMgaGlzIGxpZ2h0aG9zdWUgY2hlc3QgYSBzcHJpdGUgb2Zmc2V0IG9mIDlcbiAgICAvLyAodmlhICQxZjdkMiBpbiB0aGUgYm9zcyBjaGVzdCB0YWJsZSksIHdoaWNoIGNhbiBvbmx5IGJlIHNhdGlzZmllZFxuICAgIC8vIGlmICQ1MSAodGhlIHNsZWVwaW5nIE5QQyBwYWdlKSBpcyBpbiB0aGUgZmlyc3Qgc2xvdC4gIFdlIGNvdWxkXG4gICAgLy8gYmUgbW9yZSBmbGV4aWJsZSBpZiB3ZSByZXdyb3RlIHRoYXQgb2Zmc2V0LCBidXQgdGhlbiB3ZSB3b3VsZG4ndFxuICAgIC8vIGdldCBib3RoIHZlcnNpb25zIG9mIEtlbnN1IHNvIGVhc2lseS5cbiAgICAvLyBOT1RFOiBhZnRlciB3ZSBnZXQgdGhlIGNoZXN0LCB3ZSBjb3VsZCByZXNldCB0aGUgcGF0dGVybnMgYnlcbiAgICAvLyAgICAgICBzaHVudGluZyAkM2Q0NThcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW25ldyBTZXQoWzB4NTFdKSwgQUxMLCBBTEwsIEFMTF0sIFtdLCAwKTtcbiAgfVxuXG4gIC8vIFJldHVybnMgdGhlIFwic3RhcnRpbmcgY29uc3RyYWludFwiIGZvciB0aGUgZ2l2ZW4gbG9jYXRpb24sIHRha2luZyB0aGluZ3MgbGlrZVxuICAvLyB3aW5kbWlsbCBibGFkZXMgaW50byBhY2NvdW50LlxuICBzdGF0aWMgZm9yTG9jYXRpb24oaWQ6IG51bWJlcik6IENvbnN0cmFpbnQge1xuICAgIHN3aXRjaCAoaWQpIHtcbiAgICBjYXNlIDB4MDM6IC8vIHZhbGxleSBvZiB3aW5kICh3aW5kbWlsbCBibGFkZXMpXG4gICAgICAvLyBUT0RPIC0gcGF0dGVybiBiYW5rIGlzIHNoaWZ0YWJsZSwgYnV0IG5lZWQgdG8gbGluayB0byBzcGF3biAzLGUwXG4gICAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW0FMTCwgYml0KDB4NjApLCBBTEwsIGJpdCgweDIwKV0sIFtdLCAwKTtcbiAgICAvL2Nhc2UgMHgxYTogLy8gc3dhbXAgKGNoaWxkKVxuICAgIC8vICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW0FMTCwgYml0KDB4NGYpLCBBTEwsIGJpdCgweDIzKV0sIFtdKTtcbiAgICBjYXNlIDB4NjA6IC8vIGFuZ3J5IHNlYSAoZG9scGhpbilcbiAgICBjYXNlIDB4NjQ6IC8vIHVuZGVyZ3JvdW5kIGNoYW5uZWxcbiAgICBjYXNlIDB4Njg6IC8vIEVTSSBlbnRyYW5jZVxuICAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtBTEwsIGJpdCgweDUyKSwgQUxMLGJpdCgweDA4KV0sIFtdLCAwKTtcbiAgICB9XG4gICAgcmV0dXJuIENvbnN0cmFpbnQuQUxMO1xuICB9XG5cbiAgLy8gTk9URTogU3RhdGljIHNwYXducyBtYXkgYmUgc2hpZnRhYmxlOyBhZC1ob2Mgc3Bhd25zIGFyZSBub3QuXG4gIHN0YXRpYyBmcm9tU3Bhd24ocGFsZXR0ZXM6IFNldDxudW1iZXI+LFxuICAgICAgICAgICAgICAgICAgIHBhdHRlcm5zOiBTZXQ8bnVtYmVyPixcbiAgICAgICAgICAgICAgICAgICBsb2NhdGlvbjogTG9jYXRpb24sIFxuICAgICAgICAgICAgICAgICAgIHNwYXduOiBTcGF3bixcbiAgICAgICAgICAgICAgICAgICBzaGlmdGFibGU6IGJvb2xlYW4pOiBDb25zdHJhaW50IHtcbiAgICBjb25zdCBbZmlyc3RQYXR0ZXJuLCAuLi5yZXN0XSA9IHBhdHRlcm5zO1xuICAgIHNoaWZ0YWJsZSA9IHNoaWZ0YWJsZSAmJiBmaXJzdFBhdHRlcm4gPT09IDIgJiYgIXJlc3QubGVuZ3RoO1xuICAgIGlmIChzaGlmdGFibGUgJiYgc3Bhd24ucGF0dGVybkJhbmspIHBhdHRlcm5zID0gbmV3IFNldChbM10pO1xuICAgIGNvbnN0IHBhdDAgPSBzaGlmdGFibGUgfHwgIXBhdHRlcm5zLmhhcygyKSA/IEFMTCA6IGJpdChsb2NhdGlvbi5zcHJpdGVQYXR0ZXJuc1swXSk7XG4gICAgY29uc3QgcGF0MSA9IHNoaWZ0YWJsZSB8fCAhcGF0dGVybnMuaGFzKDMpID8gQUxMIDogYml0KGxvY2F0aW9uLnNwcml0ZVBhdHRlcm5zWzFdKTtcbiAgICBjb25zdCBmbG9hdCA9IHNoaWZ0YWJsZSA/IFtiaXQobG9jYXRpb24uc3ByaXRlUGF0dGVybnNbc3Bhd24ucGF0dGVybkJhbmtdKV0gOiBbXTtcbiAgICBjb25zdCBwYWwyID0gcGFsZXR0ZXMuaGFzKDIpID8gYml0KGxvY2F0aW9uLnNwcml0ZVBhbGV0dGVzWzBdKSA6IEFMTDtcbiAgICBjb25zdCBwYWwzID0gcGFsZXR0ZXMuaGFzKDMpID8gYml0KGxvY2F0aW9uLnNwcml0ZVBhbGV0dGVzWzFdKSA6IEFMTDtcbiAgICByZXR1cm4gbmV3IENvbnN0cmFpbnQoW3BhdDAsIHBhdDEsIHBhbDIsIHBhbDNdLCBmbG9hdCwgMCk7XG4gIH1cblxuICAvLyBUT0RPIC0gY29tYmluZSB0aGVzZS4uLlxuXG4gIGlnbm9yZVBhbGV0dGUoKTogQ29uc3RyYWludCB7XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFt0aGlzLmZpeGVkWzBdLCB0aGlzLmZpeGVkWzFdLCBBTEwsIEFMTF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXQsIHRoaXMuc2hpZnQpO1xuICB9XG5cbiAgc2h1ZmZsZVBhbGV0dGUocmFuZG9tOiBSYW5kb20sIHVzZWRQYWxldHRlczogcmVhZG9ubHkgbnVtYmVyW10pOiBDb25zdHJhaW50IHtcbiAgICBjb25zdCBmaXhlZCA9IFsuLi50aGlzLmZpeGVkXTtcbiAgICBmb3IgKGxldCBpID0gMjsgaSA8IDQ7IGkrKykge1xuICAgICAgaWYgKGZpeGVkW2ldID09PSBBTEwpIGNvbnRpbnVlO1xuICAgICAgY29uc3Qgc2l6ZSA9IE1hdGguZmxvb3IoNSAtIE1hdGgubG9nMihyYW5kb20ubmV4dEludCgxNSkgKyAyKSk7XG4gICAgICBjb25zdCBvdXQgPSBmaXhlZFtpXSA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHtcbiAgICAgICAgb3V0LmFkZChyYW5kb20ucGljayh1c2VkUGFsZXR0ZXMpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KGZpeGVkLCB0aGlzLmZsb2F0LCB0aGlzLnNoaWZ0KTtcbiAgfVxuXG4gIHNoaWZ0ZWQoKTogQ29uc3RyYWludCB7XG4gICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KHRoaXMuZml4ZWQsIHRoaXMuZmxvYXQsIHRoaXMuc2hpZnQgfCAyKTtcbiAgfVxuXG4gIC8vIEFsbCB0aGUgcG9zc2libGUgY29uc3RyYWludHMgZm9yIGEgZ2l2ZW4gbW9uc3RlciBhcmUgam9pbmVkIHRvZ2V0aGVyLlxuICAvLyBTbyBpZiB0aGUgc2FtZSBtb25zdGVyIHNob3dzIHVwIHdpdGggdHdvIGRpZmZlcmVudCBwYWxldHRlcywgdGhlbiB3ZVxuICAvLyBlbmQgdXAgd2l0aCBhIHR3by1lbGVtZW50IHNldCBmb3IgaXRzIHBhbGV0dGUuXG4gIGpvaW4odGhhdDogQ29uc3RyYWludCk6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IGZpeGVkID0gc2VxKDQsIGkgPT4gQ1NldC51bmlvbih0aGlzLmZpeGVkW2ldLCB0aGF0LmZpeGVkW2ldKSk7XG4gICAgaWYgKHRoaXMuZmxvYXQubGVuZ3RoICE9IHRoYXQuZmxvYXQubGVuZ3RoKSB7XG4gICAgICBjb25zb2xlLmRpcih0aGlzKTsgY29uc29sZS5kaXIodGhhdCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGluY29tcGF0aWJsZSBmbG9hdDogJHt0aGlzLmZsb2F0fSAke3RoYXQuZmxvYXR9YCk7XG4gICAgfVxuICAgIGNvbnN0IGZsb2F0ID0gc2VxKHRoaXMuZmxvYXQubGVuZ3RoLCBpID0+IENTZXQudW5pb24odGhpcy5mbG9hdFtpXSwgdGhhdC5mbG9hdFtpXSkpO1xuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChmaXhlZCwgZmxvYXQsIHRoaXMuc2hpZnQgfCB0aGF0LnNoaWZ0KTtcblxuICAgIC8vIGNvbnN0IGZsb2F0TWFwID0gbmV3IE1hcDxzdHJpbmcsIENTZXQ+KCk7XG4gICAgLy8gZm9yIChjb25zdCBzIG9mIGl0ZXJzLmNvbmNhdCh0aGlzLmZsb2F0LCB0aGF0LmZsb2F0KSkge1xuICAgIC8vICAgZmxvYXRNYXAuc2V0KENTZXQubGFiZWwocyksIHMpO1xuICAgIC8vIH1cbiAgICAvLyBjb25zdCBmbG9hdCA9IFsuLi5mbG9hdE1hcC52YWx1ZXMoKV07XG4gICAgLy8gaWYgKGZsb2F0Lmxlbmd0aCA+IDIpIHtcbiAgICAvLyAgIC8vIG5lZWQgdG8gZG8gc29tZXRoaW5nP1xuICAgIC8vIH1cblxuICAgIC8vIGNvbnN0IHBhdDAgPSB0aGlzLnBhdDAgJiYgdGhhdC5wYXQwICYmIHRoaXMucGF0MC51bmlvbih0aGF0LnBhdDApO1xuICAgIC8vIGNvbnN0IHBhdDEgPSB0aGlzLnBhdDEgJiYgdGhhdC5wYXQxICYmIHRoaXMucGF0MS51bmlvbih0aGF0LnBhdDEpO1xuICAgIC8vIGNvbnN0IHBhdFggPSB0aGlzLnBhdFggJiYgdGhhdC5wYXRYICYmIHRoaXMucGF0WC51bmlvbih0aGF0LnBhdFgpO1xuICAgIC8vIGNvbnN0IHBhdFkgPSB0aGlzLnBhdFkgJiYgdGhhdC5wYXRZICYmIHRoaXMucGF0WS51bmlvbih0aGF0LnBhdFkpO1xuICAgIC8vIGNvbnN0IHBhbDIgPSB0aGlzLnBhbDIgJiYgdGhhdC5wYWwyICYmIHRoaXMucGFsMi51bmlvbih0aGF0LnBhbDIpO1xuICAgIC8vIGNvbnN0IHBhbDMgPSB0aGlzLnBhbDMgJiYgdGhhdC5wYWwzICYmIHRoaXMucGFsMy51bmlvbih0aGF0LnBhbDMpO1xuICAgIC8vIGNvbnN0IHNoaWZ0YWJsZSA9IHRoaXMuc2hpZnRhYmxlIHx8IHRoYXQuc2hpZnRhYmxlO1xuICAgIC8vIHJldHVybiBuZXcgQ29uc3RyYWludChwYXQwLCBwYXQxLCBwYXRYLCBwYXRZLCBwYWwyLCBwYWwzLCBzaGlmdGFibGUpO1xuICB9XG5cbiAgZml4KGxvY2F0aW9uOiBMb2NhdGlvbiwgcmFuZG9tPzogUmFuZG9tKSB7XG4gICAgLy8gQ29uY3JldGl6ZXMgdGhlIFwiZmxvYXRcIiBlbGVtZW50cy5cbiAgICBjb25zdCBuZXh0SW50OiAoeDogbnVtYmVyKSA9PiBudW1iZXIgPVxuICAgICAgICByYW5kb20gPyAoeCkgPT4gcmFuZG9tLm5leHRJbnQoeCkgOiAoKSA9PiAwO1xuICAgIGNvbnN0IHBpY2s6IDxUPih4OiBJdGVyYWJsZTxUPikgPT4gVCA9XG4gICAgICAgIHJhbmRvbSA/ICh4cykgPT4gcmFuZG9tLnBpY2soWy4uLnhzXSkgOlxuICAgICAgICAgICAgICAgICAoeHMpID0+IHhzW1N5bWJvbC5pdGVyYXRvcl0oKS5uZXh0KCkudmFsdWU7XG4gICAgY29uc3QgZml4ZWQgPSBbLi4udGhpcy5maXhlZF07XG4gICAgaWYgKHRoaXMuZmxvYXQubGVuZ3RoKSB7XG4gICAgICAvLyBUT0RPIC0gaWYgZmxvYXQubGVuZ3RoID09PSAxIHRoZW4gb25lIGZpeGVkIGJhbmsgbWlnaHQgYmUgYmV0dGVyIHRoYW4gdGhlXG4gICAgICAvLyBvdGhlciAoaS5lLiBpZiBwYXQwIGlzIFsxMV0gYW5kIHBhdDEgaXMgQUxMLCBhbmQgZmxvYXRbMF0gaXMgWzExXSwgdGhlbiBpdFxuICAgICAgLy8gd291bGQgYmUgc2lsbHkgdG8gcGljayBwYXQxIHRvIGJlIFsxMV0uICBFeGNlcHQgdGhhdCBieSB0aGUgdGltZSB3ZSBydW4gdGhpcyxcbiAgICAgIC8vIGl0J3MgaXJyZWxldmFudCwgc2luY2Ugbm8gbmV3IHBhdHRlcm5zIGFyZSBnb2luZyB0byBiZSBhZGRlZCBhbnl3YXkuXG4gICAgICBjb25zdCB4MCA9IG5leHRJbnQoMik7XG4gICAgICBjb25zdCB4MSA9IDEgLSB4MDtcbiAgICAgIGlmICh4MCA8IHRoaXMuZmxvYXQubGVuZ3RoKSBmaXhlZFswXSA9IENTZXQuaW50ZXJzZWN0KGZpeGVkWzBdLCB0aGlzLmZsb2F0W3gwXSk7XG4gICAgICBpZiAoeDEgPCB0aGlzLmZsb2F0Lmxlbmd0aCkgZml4ZWRbMV0gPSBDU2V0LmludGVyc2VjdChmaXhlZFsxXSwgdGhpcy5mbG9hdFt4MV0pO1xuICAgIH1cbiAgICBpZiAoZml4ZWRbMF0gIT09IEFMTCkgbG9jYXRpb24uc3ByaXRlUGF0dGVybnNbMF0gPSBwaWNrKFsuLi5maXhlZFswXV0pO1xuICAgIGlmIChmaXhlZFsxXSAhPT0gQUxMKSBsb2NhdGlvbi5zcHJpdGVQYXR0ZXJuc1sxXSA9IHBpY2soWy4uLmZpeGVkWzFdXSk7XG4gICAgaWYgKGZpeGVkWzJdICE9PSBBTEwpIGxvY2F0aW9uLnNwcml0ZVBhbGV0dGVzWzBdID0gcGljayhbLi4uZml4ZWRbMl1dKTtcbiAgICBpZiAoZml4ZWRbM10gIT09IEFMTCkgbG9jYXRpb24uc3ByaXRlUGFsZXR0ZXNbMV0gPSBwaWNrKFsuLi5maXhlZFszXV0pO1xuICB9XG5cbiAgLy8gVE9ETyAtIHNob3VsZCBqb2luUGF0dGVybnMgZXZlciBiZSBmYWxzZT9cbiAgbWVldCh0aGF0OiBDb25zdHJhaW50LCBqb2luUGF0dGVybnMgPSBmYWxzZSk6IENvbnN0cmFpbnQge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMudHJ5TWVldCh0aGF0LCBqb2luUGF0dGVybnMpO1xuICAgIGlmICghcmVzdWx0KSB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCByZWNvbmNpbGUgcGF0dGVybnNgKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqIEBwYXJhbSBmb3JjZSBhbGxvdyBpbmNvbXBhdGlibGUgcGFsZXR0ZXMuICovXG4gIHRyeU1lZXQodGhhdDogQ29uc3RyYWludCwgam9pblBhdHRlcm5zID0gZmFsc2UpOiBDb25zdHJhaW50IHwgdW5kZWZpbmVkIHtcbiAgICAvLyBUaGlzIGlzIHRoZSB0cmlja3kgb25lLiAgSXQncyB1c2VkIChhKSB0byBjb21iaW5lIHByb2plY3RpbGVzIHdpdGhcbiAgICAvLyB0aGVpciBwYXJlbnRzLCBhbmQgKGIpIHRvIGFkZCBhZGRpdGlvbmFsIG1vbnN0ZXJzIHRvIGEgbG9jYXRpb24uXG4gICAgLy8gV2UgbmVlZCB0byBtYWludGFpbiBzb21lIGludmFyaWFudHM6ICgxKSBJZiBwYXQwIG9yIHBhdDEgaXMgc2V0LFxuICAgIC8vIHRoZW4gcGF0WCBhbmQgcGF0WSBtdXN0IGludGVyc2VjdCBpdC4gIE90aGVyd2lzZSB3ZSBjb2xsYXBzZSB0aGVcbiAgICAvLyBub24taW50ZXJzZWN0aW5nIG9uZSBkb3duLiAgSWYgYW55IGNvbnN0cmFpbnQgaXMgZW1wdHksIHJldHVyblxuICAgIC8vIHVuZGVmaW5lZC5cblxuICAgIGNvbnN0IGZpeGVkID0gW107XG4gICAgbGV0IHNoaWZ0ID0gdGhpcy5zaGlmdCB8IHRoYXQuc2hpZnQ7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgIGxldCBtZWV0ID0gQ1NldC5pbnRlcnNlY3QodGhpcy5maXhlZFtpXSwgdGhhdC5maXhlZFtpXSk7XG4gICAgICBpZiAoIW1lZXQuc2l6ZSkge1xuICAgICAgICBpZiAoIWpvaW5QYXR0ZXJucyB8fCBpIDwgMikgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgbWVldCA9IENTZXQudW5pb24odGhpcy5maXhlZFtpXSwgdGhhdC5maXhlZFtpXSk7XG4gICAgICB9XG4gICAgICBmaXhlZC5wdXNoKG1lZXQpO1xuICAgIH1cblxuICAgIC8vIE5vdyBkZWFsIHdpdGggdGhlIGZsb2F0IHNsb3RzLlxuICAgIC8vIFdlIG1heSBuZWVkIHRvIGRvIHNvbWUgbWVyZ2luZywgaS5lLiBpZiB0aGlzLmZsb2F0IGFuZCB0aGF0LmZsb2F0IGJvdGhcbiAgICAvLyBoYXZlIGVsZW1lbnRzLiAgSWYgdGhleSdyZSB0aGUgc2FtZSBlbGVtZW50IHRoZW4gd2UncmUgb2theS4uLiAgV2Ugc2hvdWxkXG4gICAgLy8gZWFnZXJseSBtZWV0IGFueSBwYWlycyBwb3NzaWJsZS4uLlxuXG4gICAgLy8gSW52YXJpYW50OiBhbGwgZWxlbWVudHMgaW4gZmxvYXQgYXJlIGRpc2pvaW50IGZyb20gb25lIGFub3RoZXIuXG4gICAgLy8gSW52YXJpYW50OiBhbGwgZWxlbWVudHMgaW4gZmxvYXQgb3ZlcmxhcCB3aXRoIGF0IGxlYXN0IG9uZSBmaXhlZCBzZXQuXG5cbiAgICBjb25zdCBpbnZlcnNlRmxvYXQgPSBuZXcgTWFwPG51bWJlciwgbnVtYmVyPigpO1xuICAgIGNvbnN0IGZsb2F0OiBDU2V0W10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHMgb2YgaXRlcnMuY29uY2F0KHRoaXMuZmxvYXQsIHRoYXQuZmxvYXQpKSB7XG4gICAgICBpZiAocyA9PT0gQUxMKSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdW5jb25zdHJhaW5lZCBmbG9hdGApO1xuICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgICBmb3IgKGNvbnN0IHAgb2Ygcykge1xuICAgICAgICBjb25zdCBwcmV2ID0gaW52ZXJzZUZsb2F0LmdldChwKTtcbiAgICAgICAgaWYgKHByZXYgIT0gbnVsbCkge1xuICAgICAgICAgIGZvciAoY29uc3QgciBvZiBmbG9hdFtwcmV2XSkgaW52ZXJzZUZsb2F0LmRlbGV0ZShyKTtcbiAgICAgICAgICBmbG9hdFtwcmV2XSA9IENTZXQuaW50ZXJzZWN0KGZsb2F0W3ByZXZdLCBzKTtcbiAgICAgICAgICBmb3IgKGNvbnN0IHIgb2YgZmxvYXRbcHJldl0pIGludmVyc2VGbG9hdC5zZXQociwgcHJldik7XG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoZm91bmQpIGJyZWFrO1xuXG4gICAgICAvLyBObyBpbnRlcnNlY3Rpb24gYmV0d2VlbiB0aGlzIGZsb2F0aW5nIGNvbnN0cmFpbnQgYW5kIGFueSBwcmV2aW91cyxcbiAgICAgIC8vIHNvIGFkZCBpdC4gIElmIHRoZXJlJ3MgbW9yZSB0aGFuIHR3bywgd2UncmUgb3V0IG9mIGx1Y2suXG4gICAgICBmb3IgKGNvbnN0IHAgb2YgcykgaW52ZXJzZUZsb2F0LnNldChwLCBmbG9hdC5sZW5ndGgpO1xuICAgICAgZmxvYXQucHVzaChzKTtcbiAgICAgIGlmIChmbG9hdC5sZW5ndGggPiAyKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8vIE5vdyB0aGF0IGZsb2F0IGlzIGNvbXBsZXRlLCBjaGVjayB0aGUgaW52YXJpYW50IHRoYXQgZXZlcnkgZmxvYXRpbmdcbiAgICAvLyBzZXQgaW50ZXJzZWN0cyB3aXRoIGJvdGggZml4ZWQgc2xvdHMuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbG9hdC5sZW5ndGg7IGkrKykge1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAyOyBqKyspIHtcbiAgICAgICAgY29uc3QgaW50ZXJzZWN0ID0gQ1NldC5pbnRlcnNlY3QoZmxvYXRbaV0sIGZpeGVkW2pdKTtcbiAgICAgICAgaWYgKCFpbnRlcnNlY3Quc2l6ZSkge1xuICAgICAgICAgIC8vIEEgZmxvYXQgaXMgZGlzam9pbnQgZnJvbSBhIGZpeGVkOiByZXNvbHZlIHRoZSBvdGhlciBmaXhlZCBzbG90LlxuICAgICAgICAgIGNvbnN0IGMgPSBmaXhlZFsxIC0gal0gPSBDU2V0LmludGVyc2VjdChmbG9hdFtpXSwgZml4ZWRbMSAtIGpdKTtcbiAgICAgICAgICBzaGlmdCB8PSAxIDw8ICgxIC0gaik7XG4gICAgICAgICAgaWYgKCFjLnNpemUpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgZmxvYXQuc3BsaWNlKGksIDEpO1xuICAgICAgICAgIC8vIFJlc2V0IHRoZSBvdXRlciBmb3IgbG9vcCBhbmQgY2hlY2sgYWdhaW4uXG4gICAgICAgICAgaSA9IC0xO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9IGVsc2UgaWYgKGludGVyc2VjdC5zaXplID09PSBmbG9hdFtpXS5zaXplKSB7XG4gICAgICAgICAgLy8gSWYgZmxvYXRbaV0gaXMgYSBzdWJzZXQgb2YgZml4ZWRbal0gdGhlbiBqdXN0IGRyb3AgdGhlIGZsb2F0LlxuICAgICAgICAgIC8vIGZsb2F0LnNwbGljZShpLCAxKTtcbiAgICAgICAgICAvLyBpLS07XG4gICAgICAgICAgLy8gYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBdCB0aGlzIHBvaW50LCB0aGUgaW52YXJpYW50cyBhcmUgc2F0aXNmaWVkLCBzbyB3ZSBjYW4gcmV0dXJuLlxuICAgIHJldHVybiBuZXcgQ29uc3RyYWludChmaXhlZCwgZmxvYXQsIHNoaWZ0KTtcblxuICAgIC8vIGNvbnN0IHBhbDIgPSAodGhpcy5wYWwyIHx8IFVOQ09OU1RSQUlORUQpLmludGVyc2VjdCh0aGF0LnBhbDIgfHwgVU5DT05TVFJBSU5FRCk7XG4gICAgLy8gY29uc3QgcGFsMyA9ICh0aGlzLnBhbDMgfHwgVU5DT05TVFJBSU5FRCkuaW50ZXJzZWN0KHRoYXQucGFsMyB8fCBVTkNPTlNUUkFJTkVEKTtcblxuICAgIC8vIGxldCBwYXQwID0gKHRoaXMucGF0MCB8fCBVTkNPTlNUUkFJTkVEKS5pbnRlcnNlY3QodGhhdC5wYXQwIHx8IFVOQ09OU1RSQUlORUQpO1xuICAgIC8vIGxldCBwYXQxID0gKHRoaXMucGF0MSB8fCBVTkNPTlNUUkFJTkVEKS5pbnRlcnNlY3QodGhhdC5wYXQxIHx8IFVOQ09OU1RSQUlORUQpO1xuXG4gICAgLy8gbGV0IHBhdFggPSB1bmRlZmluZWQ7XG4gICAgLy8gbGV0IHBhdFkgPSB1bmRlZmluZWQ7XG5cbiAgICAvLyAvLyBJbnN0ZWFkIC0gbGlzdCBvZiBmbG9hdGluZyBwYXR0ZXJucz9cbiAgICAvLyAvLyBcblxuICAgIC8vIGlmICh0aGlzLnBhdFggJiYgdGhhdC5wYXRYKSB7XG4gICAgLy8gICAvLyBpcyB0aGVyZSBhbnkgb3ZlcmxhcD9cbiAgICAvLyAgIGNvbnN0IG1lZXQgPSB0aGlzLnBhdFguaW50ZXJzZWN0KHRoYXQucGF0WCk7XG4gICAgLy8gICBpZiAobWVldC5zaXplKSB7XG4gICAgLy8gICAgIHBhdFggPSBtZWV0O1xuICAgIC8vICAgfSBlbHNlIGlmICghdGhpcy5wYXRZICYmICF0aGF0LnBhdFkpIHtcbiAgICAvLyAgICAgcGF0WCA9IHRoaXMucGF0WDtcbiAgICAvLyAgICAgcGF0WSA9IHRoYXQucGF0WDtcbiAgICAvLyAgIH1cbiAgICAvLyB9XG5cbiAgICAvLyBsZXQgcGF0WCA9ICh0aGlzLnBhdFggfHwgVU5DT05TVFJBSU5FRCkuaW50ZXJzZWN0KHRoYXQucGF0WCB8fCBVTkNPTlNUUkFJTkVEKTtcbiAgICAvLyBsZXQgcGF0WSA9ICh0aGlzLnBhdFkgfHwgVU5DT05TVFJBSU5FRCkuaW50ZXJzZWN0KHRoYXQucGF0WSB8fCBVTkNPTlNUUkFJTkVEKTtcbiAgfVxufVxuXG4vLyBNSUdIVCBiZSBwb3NzaWJsZSB0byBoYXZlIGEgY29tYmluYXRpb24/XG4vLyAgIC0tIHN1cHBvc2Ugd2UgaGF2ZSBvcmNzIHdpdGggcGF0WCA9IDF8MiBhbmQgYXhlIGhhcyBwYXQyID0gMXwzLlxuLy8gICAgICB0aGVuIHBhdDE9MixwYXQyPTMgaXMgYW4gb3B0aW9uLi4uIGJ1dCBpdCdzIGxlc3Mgb2J2aW91cy5cbi8vICAgLS0gd2UgbmVlZCBhIFwibWVldFwiIGZ1bmN0aW9uYWxpdHkgZm9yIGNvbWJpbmluZyBtb25zdGVycyB3LyBwcm9qZWN0aWxlc1xuXG4vLyBUd28gZGlmZmVyZW50IGNvbnN0cmFpbnRzLCB3aXRoIChzbGlnaHRseSBkaWZmZXJlbnQpPyBiZWhhdmlvcjpcbi8vICAgLSA1IHNldHNcbi8vICAgLSBydWxlcyBmb3IgaW50ZXJhY3Rpb24gb2YgcGF0MCwgcGF0MSwgcGF0WFxuLy8gICAtIChwYXQwLHBhdDEpIGFuZCBwYXRYIG11c3Qgbm90IGJlIGRpc2pvaW50XG4vLyAgICAgaWYgcGF0MCBkaXNqb2ludCBmcm9tIHBhdFggdGhlbiBwYXQxIDwtIHBhdFguXG4vLyAgIC0gaWYgYW55IHNldCByZWR1Y2VkIHRvIDEgZWxlbWVudCwgaXQncyBmaXhlZFxuLy8gICAtIGFsc28gcGF0WSBidXQgaXQncyBuZXZlciBzdG9yZWQ/PyAgaXQncyBwb3NzaWJsZVxuLy8gICAgIHRoYXQgaXQgaXMgc3RvcmVkIGFuZCBoYXMgdGhlIHNhbWUgcnVsZXNcbi8vICAgICAtPiBjb2xsYXNlIGFzIHNvb24gYXMgcG9zc2libGUuLi5cblxuLy8gY2xhc3MgU3RhdGljQ29uc3RyYWludCBleHRlbmRzIEdyYXBoaWNzQ29uc3RyYWludCB7XG4vLyAgIHJlYWRvbmx5IHBhdDA/OiBTZXQ8bnVtYmVyPjtcbi8vICAgcmVhZG9ubHkgcGF0MT86IFNldDxudW1iZXI+O1xuLy8gfVxuXG4vLyBjbGFzcyBTaGlmdENvbnN0cmFpbnQgZXh0ZW5kcyBHcmFwaGljc0NvbnN0cmFpbnQge1xuLy8gICByZWFkb25seSBwYXRYOiBTZXQ8bnVtYmVyPjtcbi8vIH1cblxuLy8gZXhwb3J0IGNsYXNzIFhDb25zdHJhaW50IHtcblxuLy8gICByZWFkb25seSBvcHRpb25zID0gbmV3IE1hcDxzdHJpbmcsIE9wdGlvbj4oKTtcblxuLy8gICBjb25zdHJ1Y3RvcihvcHRpb25zOiByZWFkb25seSBPcHRpb25bXSB8IE1hcDxzdHJpbmcsIE9wdGlvbj4gPSBbQUxMXSxcbi8vICAgICAgICAgICAgICAgcmVhZG9ubHkgc2hpZnRhYmxlPzogbnVtYmVyKSB7XG4vLyAgICAgaWYgKG9wdGlvbnMgaW5zdGFuY2VvZiBNYXApIHtcbi8vICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4vLyAgICAgfSBlbHNlIHtcbi8vICAgICAgIGZvciAobGV0IG9wdGlvbiBvZiBvcHRpb25zKSB7XG4vLyAgICAgICAgIGNvbnN0IGxhYmVsID0gb3B0aW9uLmxhYmVsKCk7XG4vLyAgICAgICAgIGNvbnN0IHByZXYgPSB0aGlzLm9wdGlvbnMuZ2V0KGxhYmVsKTtcbi8vICAgICAgICAgaWYgKHByZXYpIG9wdGlvbiA9IHByZXYubWVldChvcHRpb24pITtcbi8vICAgICAgICAgdGhpcy5vcHRpb25zLnNldChsYWJlbCwgb3B0aW9uKTtcbi8vICAgICAgIH1cbi8vICAgICB9XG4vLyAgIH1cblxuLy8gICBzdGF0aWMgc2hpZnRhYmxlKHBhZ2U6IG51bWJlcik6IENvbnN0cmFpbnQge1xuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbXSwgcGFnZSk7XG4vLyAgIH1cblxuLy8gICBzdGF0aWMgcGF0MChwYWdlczogSXRlcmFibGU8bnVtYmVyPik6IENvbnN0cmFpbnQge1xuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbLi4ucGFnZXNdLm1hcChwID0+IG5ldyBPcHRpb24ocCkpKTtcbi8vICAgfVxuXG4vLyAgIHN0YXRpYyBwYXQxKHBhZ2VzOiBJdGVyYWJsZTxudW1iZXI+KTogQ29uc3RyYWludCB7XG4vLyAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFsuLi5wYWdlc10ubWFwKHAgPT4gbmV3IE9wdGlvbigtMSwgcCkpKTtcbi8vICAgfVxuXG4vLyAgIHN0YXRpYyBwYWwyKHBhZ2VzOiBJdGVyYWJsZTxudW1iZXI+KTogQ29uc3RyYWludCB7XG4vLyAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFsuLi5wYWdlc10ubWFwKHAgPT4gbmV3IE9wdGlvbigtMSwgLTEsIHApKSk7XG4vLyAgIH1cblxuLy8gICBzdGF0aWMgcGFsMyhwYWdlczogSXRlcmFibGU8bnVtYmVyPik6IENvbnN0cmFpbnQge1xuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludChbLi4ucGFnZXNdLm1hcChwID0+IG5ldyBPcHRpb24oLTEsIC0xLCAtMSwgcCkpKTtcbi8vICAgfVxuXG4vLyAgIHNwYXduKHNsb3Q6IG51bWJlcik6IENvbnN0cmFpbnQge1xuLy8gICAgIC8vIHJlYWxpemUgYSBzaGlmdGFibGUgaW50byBhIGNvbmNyZXRlIGNvbnN0cmFpbnRcbi8vICAgICBpZiAodGhpcy5zaGlmdGFibGUgPT0gbnVsbCkgcmV0dXJuIHRoaXM7XG4vLyAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KFtcbi8vICAgICAgIG5ldyBPcHRpb24odGhpcy5zaGlmdGFibGUsIC0xLCAtMSwgLTEsIG5ldyBNYXAoW1tzbG90LCAwXV0pKSxcbi8vICAgICAgIG5ldyBPcHRpb24oLTEsIHRoaXMuc2hpZnRhYmxlLCAtMSwgLTEsIG5ldyBNYXAoW1tzbG90LCAxXV0pKVxuLy8gICAgIF0pLm1lZXQobmV3IENvbnN0cmFpbnQodGhpcy5vcHRpb25zKSk7XG4vLyAgIH1cblxuLy8gICBqb2luKHRoYXQ6IENvbnN0cmFpbnQpOiBDb25zdHJhaW50IHtcbi8vICAgICBpZiAodGhpcy5zaGlmdGFibGUgIT0gbnVsbCAmJiB0aGF0LnNoaWZ0YWJsZSAhPSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ2JvdGggc2hpZnQnKTtcbi8vICAgICBjb25zdCBvdXQgPSBuZXcgTWFwPHN0cmluZywgT3B0aW9uPigpO1xuLy8gICAgIGZvciAobGV0IFtsYWJlbCwgb3B0aW9uXSBvZiBbLi4udGhpcy5vcHRpb25zLCAuLi50aGF0Lm9wdGlvbnNdKSB7XG4vLyAgICAgICBjb25zdCBwcmV2ID0gb3V0LmdldChsYWJlbCk7XG4vLyAgICAgICBpZiAocHJldikgb3B0aW9uID0gcHJldi5tZWV0KG9wdGlvbikhO1xuLy8gICAgICAgb3V0LnNldChsYWJlbCwgb3B0aW9uKTtcbi8vICAgICB9XG4vLyAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KG91dCwgdGhpcy5zaGlmdGFibGUgIT0gbnVsbCA/IHRoaXMuc2hpZnRhYmxlIDogdGhhdC5zaGlmdGFibGUpO1xuLy8gICB9XG5cbi8vICAgbWVldCh0aGF0OiBDb25zdHJhaW50KTogQ29uc3RyYWludCB7XG4vLyAgICAgLy8gVGFrZSB0aGUgY3Jvc3MgcHJvZHVjdCBvZiBib3RoIHNldHMgb2Ygb3B0aW9ucy5cbi8vICAgICBpZiAodGhpcy5zaGlmdGFibGUgIT0gbnVsbCAmJiB0aGF0LnNoaWZ0YWJsZSAhPSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ2JvdGggc2hpZnQnKTtcbi8vICAgICBjb25zdCBvdXQgPSBuZXcgTWFwPHN0cmluZywgT3B0aW9uPigpO1xuLy8gICAgIGZvciAoY29uc3QgYSBvZiB0aGlzLm9wdGlvbnMudmFsdWVzKCkpIHtcbi8vICAgICAgIGZvciAoY29uc3QgYiBvZiB0aGF0Lm9wdGlvbnMudmFsdWVzKCkpIHtcbi8vICAgICAgICAgbGV0IG9wdGlvbiA9IGEubWVldChiKTtcbi8vICAgICAgICAgaWYgKCFvcHRpb24pIGNvbnRpbnVlO1xuLy8gICAgICAgICBjb25zdCBsYWJlbCA9IG9wdGlvbi5sYWJlbCgpO1xuLy8gICAgICAgICBjb25zdCBwcmV2ID0gb3V0LmdldChsYWJlbCk7XG4vLyAgICAgICAgIGlmIChwcmV2KSBvcHRpb24gPSBwcmV2Lm1lZXQob3B0aW9uKSE7XG4vLyAgICAgICAgIG91dC5zZXQobGFiZWwsIG9wdGlvbik7XG4vLyAgICAgICB9XG4vLyAgICAgfVxuLy8gICAgIHJldHVybiBuZXcgQ29uc3RyYWludChvdXQsIHRoaXMuc2hpZnRhYmxlICE9IG51bGwgPyB0aGlzLnNoaWZ0YWJsZSA6IHRoYXQuc2hpZnRhYmxlKTtcbi8vICAgfVxuLy8gfVxuXG4vLyBleHBvcnQgY2xhc3MgT3B0aW9uIHtcbi8vICAgY29uc3RydWN0b3IocmVhZG9ubHkgcGF0MDogbnVtYmVyID0gLTEsXG4vLyAgICAgICAgICAgICAgIHJlYWRvbmx5IHBhdDE6IG51bWJlciA9IC0xLFxuLy8gICAgICAgICAgICAgICByZWFkb25seSBwYWwyOiBudW1iZXIgPSAtMSxcbi8vICAgICAgICAgICAgICAgcmVhZG9ubHkgcGFsMzogbnVtYmVyID0gLTEsXG4vLyAgICAgICAgICAgICAgIHJlYWRvbmx5IHBhZ2VzID0gbmV3IE1hcDxudW1iZXIsIG51bWJlcj4oKSkge31cblxuLy8gICBtZWV0KHRoYXQ6IE9wdGlvbik6IE9wdGlvbiB8IG51bGwge1xuLy8gICAgIGNvbnN0IHBhdDAgPSBtZWV0KHRoaXMucGF0MCwgdGhhdC5wYXQwKTtcbi8vICAgICBjb25zdCBwYXQxID0gbWVldCh0aGlzLnBhdDEsIHRoYXQucGF0MSk7XG4vLyAgICAgY29uc3QgcGFsMiA9IG1lZXQodGhpcy5wYWwyLCB0aGF0LnBhbDIpO1xuLy8gICAgIGNvbnN0IHBhbDMgPSBtZWV0KHRoaXMucGFsMywgdGhhdC5wYWwzKTtcbi8vICAgICBpZiAoaXNOYU4ocGF0MCkgfHwgaXNOYU4ocGF0MSkgfHwgaXNOYU4ocGFsMikgfHwgaXNOYU4ocGFsMykpIHJldHVybiBudWxsO1xuLy8gICAgIHJldHVybiBuZXcgT3B0aW9uKHBhdDAsIHBhdDEsIHBhbDIsIHBhbDMsIG5ldyBNYXAoWy4uLnRoaXMucGFnZXMsIC4uLnRoYXQucGFnZXNdKSk7XG4vLyAgIH1cblxuLy8gICBsYWJlbCgpOiBzdHJpbmcge1xuLy8gICAgIHJldHVybiBgJHt0aGlzLnBhdDB9ICR7dGhpcy5wYXQxfSAke3RoaXMucGFsMn0gJHt0aGlzLnBhbDN9YDtcbi8vICAgfVxuLy8gfVxuXG4vLyBjb25zdCBBTEwgPSBuZXcgT3B0aW9uKCk7XG5cbi8vIGZ1bmN0aW9uIG1lZXQoYTogbnVtYmVyLCBiOiBudW1iZXIpOiBudW1iZXIge1xuLy8gICBpZiAoYSA8IDApIHJldHVybiBiO1xuLy8gICBpZiAoYiA8IDApIHJldHVybiBhO1xuLy8gICBpZiAoYSA9PT0gYikgcmV0dXJuIGE7XG4vLyAgIHJldHVybiBOYU47XG4vLyB9XG5cbmNvbnN0IFRSRUFTVVJFX0NIRVNUX0JBTktTID0gbmV3IFNldChbXG4gIC8vIE5PVEU6ICQ1MSBoYXMgdGhlIHRyZWFzdXJlIGNoZXN0IHNwcml0ZXMsIGJ1dCBpbiB0aGUgd3Jvbmcgc3BvdC5cbiAgMHg1ZSwgMHg1ZiwgMHg2MCwgMHg2MSwgMHg2NCwgMHg2NSwgMHg2NiwgMHg2NyxcbiAgMHg2OCwgMHg2OSwgMHg2YSwgMHg2YywgMHg2ZCwgMHg2ZSwgMHg2ZiwgMHg3MCxcbiAgMHg3NCwgMHg3NSwgMHg3NiwgMHg3Nyxcbl0pO1xuXG5jb25zdCBDT0lOX0JBTktTID0gbmV3IFNldChbXG4gIDB4NWUsIDB4NWYsIDB4NjAsIDB4NjEsIDB4NjMsIDB4NjQsIDB4NjUsIDB4NjYsXG4gIDB4NjcsIDB4NjgsIDB4NjksIDB4NmEsIDB4NmIsIDB4NmMsIDB4NmQsIDB4NmUsXG4gIDB4NmYsIDB4NzAsIDB4NzQsIDB4NzUsIDB4NzYsIDB4NzcsXG5dKTtcbiJdfQ==