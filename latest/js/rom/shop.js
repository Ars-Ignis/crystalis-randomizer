import { Entity } from './entity.js';
import { readLittleEndian, seq, tuple, writeLittleEndian } from './util.js';
export var ShopType;
(function (ShopType) {
    ShopType[ShopType["ARMOR"] = 0] = "ARMOR";
    ShopType[ShopType["TOOL"] = 1] = "TOOL";
    ShopType[ShopType["INN"] = 2] = "INN";
    ShopType[ShopType["PAWN"] = 3] = "PAWN";
})(ShopType || (ShopType = {}));
const SHOP_TYPES = [ShopType.ARMOR, ShopType.TOOL, ShopType.INN, ShopType.PAWN];
const CONTENTS_ADDRESSES = [
    (base, count) => base ? base : VANILLA_ARMOR_SHOP_ITEMS,
    (base, count) => base ? base + 4 * count : VANILLA_TOOL_SHOP_ITEMS,
    (base, count) => 0,
    (base, count) => 0,
];
const CONTENTS_COUNTS = [4, 4, 0, 0];
const PRICES_ADDRESSES = [
    (base, count) => base ? base + 8 * count : VANILLA_ARMOR_SHOP_PRICES,
    (base, count) => base ? base + 12 * count : VANILLA_TOOL_SHOP_PRICES,
    (base, count) => base ? base + 16 * count : VANILLA_INN_PRICES,
    (base, count) => 0,
];
const PRICES_COUNTS = [4, 4, 1, 0];
export class Shop extends Entity {
    constructor(rom, id) {
        super(rom, id);
        this.type = SHOP_TYPES[id & 3];
        this.index = id >>> 2;
        if (rom.shopDataTablesAddress) {
            const base = rom.shopDataTablesAddress;
            const count = rom.shopCount;
            const locationTable = base + 17 * count;
            this.location = rom.prg[locationTable + id];
        }
        else {
            let shopLocation = 0xff;
            for (let i = 0; i < 33 && shopLocation === 0xff; i++) {
                if (rom.prg[VANILLA_SHOP_INDICES + i] !== this.index)
                    continue;
                const location = rom.prg[VANILLA_SHOP_LOCATIONS + i];
                for (const spawn of rom.locations[location].spawns) {
                    if (spawn.type !== 4)
                        continue;
                    const obj = rom.objects[spawn.id];
                    if (obj.data[25] === 0x20 + this.type) {
                        shopLocation = location;
                        break;
                    }
                }
            }
            this.location = shopLocation;
        }
        const readPrice = rom.shopDataTablesAddress ?
            i => rom.prg[this.pricesAddress + i] / 32 :
            i => readLittleEndian(rom.prg, this.pricesAddress + 2 * i);
        this.contents = tuple(rom.prg, this.contentsAddress, CONTENTS_COUNTS[this.type]);
        this.prices = seq(PRICES_COUNTS[this.type], readPrice);
        this.used = this.location !== 0xff;
    }
    get contentsAddress() {
        const base = CONTENTS_ADDRESSES[this.type](this.rom.shopDataTablesAddress, this.rom.shopCount);
        return base + 4 * this.index;
    }
    get pricesAddress() {
        const shopTable = this.rom.shopDataTablesAddress;
        const base = PRICES_ADDRESSES[this.type](shopTable, this.rom.shopCount);
        return base + (shopTable ? 1 : 2) * PRICES_COUNTS[this.type] * this.index;
    }
    updateShopkeeper() {
        throw new Error('not implemented');
    }
    write(writer) {
        const shopData = this.rom.shopDataTablesAddress;
        const prg = writer.rom;
        const writePrice = shopData ?
            (i, p) => prg[this.pricesAddress + i] = Math.round(p * 32) :
            (i, p) => writeLittleEndian(prg, this.pricesAddress + 2 * i, p);
        for (let i = 0; i < CONTENTS_COUNTS[this.type]; i++) {
            prg[this.contentsAddress + i] =
                this.contents[i] != null ? this.contents[i] : 0xff;
        }
        for (let i = 0; i < PRICES_COUNTS[this.type]; i++) {
            writePrice(i, this.prices[i] || 0);
        }
        if (shopData) {
            const shopLocations = shopData + this.rom.shopCount * 17;
            prg[shopLocations + this.id] = this.location;
        }
    }
}
const VANILLA_SHOP_LOCATIONS = 0x21f54;
const VANILLA_SHOP_INDICES = 0x21f75;
const VANILLA_ARMOR_SHOP_ITEMS = 0x21da4;
const VANILLA_ARMOR_SHOP_PRICES = 0x21dd0;
const VANILLA_TOOL_SHOP_ITEMS = 0x21e28;
const VANILLA_TOOL_SHOP_PRICES = 0x21e54;
const VANILLA_INN_PRICES = 0x21eac;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9yb20vc2hvcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFDLE1BQU0sV0FBVyxDQUFDO0FBTzFFLE1BQU0sQ0FBTixJQUFZLFFBS1g7QUFMRCxXQUFZLFFBQVE7SUFDbEIseUNBQVMsQ0FBQTtJQUNULHVDQUFRLENBQUE7SUFDUixxQ0FBTyxDQUFBO0lBQ1AsdUNBQVEsQ0FBQTtBQUNWLENBQUMsRUFMVyxRQUFRLEtBQVIsUUFBUSxRQUtuQjtBQUVELE1BQU0sVUFBVSxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRWhGLE1BQU0sa0JBQWtCLEdBQWdEO0lBQ3RFLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLHdCQUF3QjtJQUN2RCxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLHVCQUF1QjtJQUNsRSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbEIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0NBQ25CLENBQUM7QUFFRixNQUFNLGVBQWUsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBRXJDLE1BQU0sZ0JBQWdCLEdBQWdEO0lBQ3BF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SSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7U0FDOUM7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLHNCQUFzQixHQUFHLE9BQU8sQ0FBQztBQUN2QyxNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQztBQUNyQyxNQUFNLHdCQUF3QixHQUFHLE9BQU8sQ0FBQztBQUN6QyxNQUFNLHlCQUF5QixHQUFHLE9BQU8sQ0FBQztBQUMxQyxNQUFNLHVCQUF1QixHQUFHLE9BQU8sQ0FBQztBQUN4QyxNQUFNLHdCQUF3QixHQUFHLE9BQU8sQ0FBQztBQUN6QyxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RW50aXR5fSBmcm9tICcuL2VudGl0eS5qcyc7XG5pbXBvcnQge3JlYWRMaXR0bGVFbmRpYW4sIHNlcSwgdHVwbGUsIHdyaXRlTGl0dGxlRW5kaWFufSBmcm9tICcuL3V0aWwuanMnO1xuaW1wb3J0IHtXcml0ZXJ9IGZyb20gJy4vd3JpdGVyLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuXG4vLyBTaG9wcyBhcmUgc3RyaXBlZDogdG9vbCwgYXJtb3IsIGlubiwgcGF3blxuLy8gU28gdGhlIHRvb2wgc2hvcHMgaGF2ZSBJRCAwLCA0LCA4LCAuLi4sIDQwOyBldGNcblxuZXhwb3J0IGVudW0gU2hvcFR5cGUge1xuICBBUk1PUiA9IDAsXG4gIFRPT0wgPSAxLFxuICBJTk4gPSAyLFxuICBQQVdOID0gMyxcbn1cblxuY29uc3QgU0hPUF9UWVBFUyA9IFtTaG9wVHlwZS5BUk1PUiwgU2hvcFR5cGUuVE9PTCwgU2hvcFR5cGUuSU5OLCBTaG9wVHlwZS5QQVdOXTtcblxuY29uc3QgQ09OVEVOVFNfQUREUkVTU0VTOiAoKGJhc2U6IG51bWJlciwgY291bnQ6IG51bWJlcikgPT4gbnVtYmVyKVtdID0gW1xuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlIDogVkFOSUxMQV9BUk1PUl9TSE9QX0lURU1TLFxuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlICsgNCAqIGNvdW50IDogVkFOSUxMQV9UT09MX1NIT1BfSVRFTVMsXG4gIChiYXNlLCBjb3VudCkgPT4gMCxcbiAgKGJhc2UsIGNvdW50KSA9PiAwLFxuXTtcblxuY29uc3QgQ09OVEVOVFNfQ09VTlRTID0gWzQsIDQsIDAsIDBdO1xuXG5jb25zdCBQUklDRVNfQUREUkVTU0VTOiAoKGJhc2U6IG51bWJlciwgY291bnQ6IG51bWJlcikgPT4gbnVtYmVyKVtdID0gW1xuICAoYmFzZSwgY291bnQpID0+IGJhc2UgPyBiYXNlICsgOCAqIGNvdW50IDogVkFOSUxMQV9BUk1PUl9TSE9QX1BSSUNFUyxcbiAgKGJhc2UsIGNvdW50KSA9PiBiYXNlID8gYmFzZSArIDEyICogY291bnQgOiBWQU5JTExBX1RPT0xfU0hPUF9QUklDRVMsXG4gIChiYXNlLCBjb3VudCkgPT4gYmFzZSA/IGJhc2UgKyAxNiAqIGNvdW50IDogVkFOSUxMQV9JTk5fUFJJQ0VTLFxuICAoYmFzZSwgY291bnQpID0+IDAsXG5dO1xuXG5jb25zdCBQUklDRVNfQ09VTlRTID0gWzQsIDQsIDEsIDBdO1xuXG5leHBvcnQgY2xhc3MgU2hvcCBleHRlbmRzIEVudGl0eSB7XG5cbiAgcmVhZG9ubHkgdXNlZDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgbG9jYXRpb246IG51bWJlcjtcbiAgcmVhZG9ubHkgaW5kZXg6IG51bWJlcjtcbiAgcmVhZG9ubHkgdHlwZTogU2hvcFR5cGU7XG5cbiAgLy8gTGlzdCBvZiB1cCB0byA0IGl0ZW0gSURzIGJlaW5nIHNvbGQgYXQgdGhpcyBzaG9wLlxuICBjb250ZW50czogbnVtYmVyW107XG5cbiAgLy8gTWVhbmluZyBkZXBlbmRzIG9uIHdoZXRoZXIgc2hvcHMgYXJlIG5vcm1hbGl6ZWQuICBJZiBzbyB0aGVuIHRoaXMgaXNcbiAgLy8gdGhlIGFkanVzdG1lbnQgZnJvbSB0aGUgYmFzZSBwcmljZSwgYXMgYSBmcmFjdGlvbi4gIElmIG5vdCB0aGVuIHRoaXNcbiAgLy8gaXMganVzdCB0aGUgMTYtYml0IHByaWNlLlxuICBwcmljZXM6IG51bWJlcltdO1xuXG4gIGNvbnN0cnVjdG9yKHJvbTogUm9tLCBpZDogbnVtYmVyKSB7XG4gICAgc3VwZXIocm9tLCBpZCk7XG5cbiAgICB0aGlzLnR5cGUgPSBTSE9QX1RZUEVTW2lkICYgM107XG4gICAgdGhpcy5pbmRleCA9IGlkID4+PiAyO1xuXG4gICAgaWYgKHJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3MpIHtcbiAgICAgIC8vIE5vcm1hbGl6ZWQgcHJpY2VzIC0gY29uc3RydWN0IHRoZSB0YWJsZSBsb2NhdGlvbnNcbiAgICAgIGNvbnN0IGJhc2UgPSByb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzO1xuICAgICAgY29uc3QgY291bnQgPSByb20uc2hvcENvdW50O1xuICAgICAgY29uc3QgbG9jYXRpb25UYWJsZSA9IGJhc2UgKyAxNyAqIGNvdW50O1xuICAgICAgdGhpcy5sb2NhdGlvbiA9IHJvbS5wcmdbbG9jYXRpb25UYWJsZSArIGlkXTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVmFuaWxsYSBzaG9wczogbmVlZCB0byBkbyBhIG1vcmUgaW52b2x2ZWQgc2VhcmNoIGZvciBzaG9wIGxvY2F0aW9uLlxuICAgICAgbGV0IHNob3BMb2NhdGlvbiA9IDB4ZmY7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDMzICYmIHNob3BMb2NhdGlvbiA9PT0gMHhmZjsgaSsrKSB7XG4gICAgICAgIGlmIChyb20ucHJnW1ZBTklMTEFfU0hPUF9JTkRJQ0VTICsgaV0gIT09IHRoaXMuaW5kZXgpIGNvbnRpbnVlO1xuICAgICAgICBjb25zdCBsb2NhdGlvbiA9IHJvbS5wcmdbVkFOSUxMQV9TSE9QX0xPQ0FUSU9OUyArIGldO1xuICAgICAgICBmb3IgKGNvbnN0IHNwYXduIG9mIHJvbS5sb2NhdGlvbnNbbG9jYXRpb25dLnNwYXducykge1xuICAgICAgICAgIGlmIChzcGF3bi50eXBlICE9PSA0KSBjb250aW51ZTtcbiAgICAgICAgICBjb25zdCBvYmogPSByb20ub2JqZWN0c1tzcGF3bi5pZF07XG4gICAgICAgICAgaWYgKG9iai5kYXRhWzI1XSA9PT0gMHgyMCArIHRoaXMudHlwZSkge1xuICAgICAgICAgICAgc2hvcExvY2F0aW9uID0gbG9jYXRpb247XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMubG9jYXRpb24gPSBzaG9wTG9jYXRpb247XG4gICAgfVxuXG4gICAgY29uc3QgcmVhZFByaWNlOiAoaTogbnVtYmVyKSA9PiBudW1iZXIgPVxuICAgICAgICByb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzID9cbiAgICAgICAgICAgIGkgPT4gcm9tLnByZ1t0aGlzLnByaWNlc0FkZHJlc3MgKyBpXSAvIDMyIDpcbiAgICAgICAgICAgIGkgPT4gcmVhZExpdHRsZUVuZGlhbihyb20ucHJnLCB0aGlzLnByaWNlc0FkZHJlc3MgKyAyICogaSk7XG4gICAgdGhpcy5jb250ZW50cyA9IHR1cGxlKHJvbS5wcmcsIHRoaXMuY29udGVudHNBZGRyZXNzLCBDT05URU5UU19DT1VOVFNbdGhpcy50eXBlXSk7XG4gICAgdGhpcy5wcmljZXMgPSBzZXEoUFJJQ0VTX0NPVU5UU1t0aGlzLnR5cGVdLCByZWFkUHJpY2UpO1xuICAgIHRoaXMudXNlZCA9IHRoaXMubG9jYXRpb24gIT09IDB4ZmY7XG4gIH1cblxuICAvLyBwcml2YXRlIGlzTm9ybWFsaXplZCgpOiBib29sZWFuIHtcbiAgLy8gICByZXR1cm4gISF0aGlzLnJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3M7XG4gIC8vIH1cblxuICBnZXQgY29udGVudHNBZGRyZXNzKCk6IG51bWJlciB7XG4gICAgY29uc3QgYmFzZSA9IENPTlRFTlRTX0FERFJFU1NFU1t0aGlzLnR5cGVdKHRoaXMucm9tLnNob3BEYXRhVGFibGVzQWRkcmVzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb20uc2hvcENvdW50KTtcbiAgICByZXR1cm4gYmFzZSArIDQgKiB0aGlzLmluZGV4O1xuICB9XG5cbiAgZ2V0IHByaWNlc0FkZHJlc3MoKTogbnVtYmVyIHtcbiAgICBjb25zdCBzaG9wVGFibGUgPSB0aGlzLnJvbS5zaG9wRGF0YVRhYmxlc0FkZHJlc3M7XG4gICAgY29uc3QgYmFzZSA9IFBSSUNFU19BRERSRVNTRVNbdGhpcy50eXBlXShzaG9wVGFibGUsIHRoaXMucm9tLnNob3BDb3VudCk7XG4gICAgcmV0dXJuIGJhc2UgKyAoc2hvcFRhYmxlID8gMSA6IDIpICogUFJJQ0VTX0NPVU5UU1t0aGlzLnR5cGVdICogdGhpcy5pbmRleDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSBzcGF3bnMgZm9yIHRoZSBnaXZlbiBsb2NhdGlvbiB0byBpbmNsdWRlIGFuIGFwcHJvcHJpYXRlXG4gICAqIHNob3BrZWVwZXIuICBTaG91bGQgYmUgY2FsbGVkIGFmdGVyIGNoYW5naW5nIGxvY2F0aW9ucy5cbiAgICovXG4gIHVwZGF0ZVNob3BrZWVwZXIoKTogdm9pZCB7XG4gICAgLy8gaG93IHRvIGRldGVybWluZSBzaG9wIHR5cGU/XG4gICAgLy8gICAtPiBsb29rIGF0IGxvY2F0aW9uJ3Mgc3Bhd24gZGF0YSAtPiBvYmplY3QgdHlwZSA0LCBpZCA9PiBkYXRhICQ2MjBcbiAgICAvLyAgICAgIDIzID0gcGF3biwgMjEgPSB0b29scywgMjIgPSBpbm4sIDIwID0gYXJtb3JcbiAgICAvLyAgIHJldXNlIHRoZSBnZW5lcmljIG9iamVjdHMgNDAuLjQzLCByZXB1cnBvc2UgdGhlIHNwZWNpYWwgb25lcy5cbiAgICAvLyAgIHdlIGNhbiBhbHNvIG1ha2UgbmV3IG9uZXMgYXMgbmVlZGVkIHVzaW5nIHRoZSB1bnVzZWQgb2JqZWN0IHNsb3RzXG4gICAgLy8gd2UgY291bGQgYWx0ZXJuYXRpdmVseSBtYWtlIGxvY2F0aW9uIGFuZC9vciB0eXBlIGEgZ2V0dGVyL3NldHRlciBwYWlyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdub3QgaW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIHdyaXRlKHdyaXRlcjogV3JpdGVyKTogdm9pZCB7XG4gICAgLy8gVE9ETzogdGhyb3cgYW4gZXJyb3IgaWYgc2hvcGtlZXBlciBkb2Vzbid0IG1hdGNoP1xuICAgIGNvbnN0IHNob3BEYXRhID0gdGhpcy5yb20uc2hvcERhdGFUYWJsZXNBZGRyZXNzO1xuICAgIGNvbnN0IHByZyA9IHdyaXRlci5yb207XG4gICAgY29uc3Qgd3JpdGVQcmljZTogKGk6IG51bWJlciwgcHJpY2U6IG51bWJlcikgPT4gdm9pZCA9XG4gICAgICAgIHNob3BEYXRhID9cbiAgICAgICAgICAgIChpLCBwKSA9PiBwcmdbdGhpcy5wcmljZXNBZGRyZXNzICsgaV0gPSBNYXRoLnJvdW5kKHAgKiAzMikgOlxuICAgICAgICAgICAgKGksIHApID0+IHdyaXRlTGl0dGxlRW5kaWFuKHByZywgdGhpcy5wcmljZXNBZGRyZXNzICsgMiAqIGksIHApO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ09OVEVOVFNfQ09VTlRTW3RoaXMudHlwZV07IGkrKykge1xuICAgICAgcHJnW3RoaXMuY29udGVudHNBZGRyZXNzICsgaV0gPVxuICAgICAgICAgIHRoaXMuY29udGVudHNbaV0gIT0gbnVsbCA/IHRoaXMuY29udGVudHNbaV0gOiAweGZmO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IFBSSUNFU19DT1VOVFNbdGhpcy50eXBlXTsgaSsrKSB7XG4gICAgICB3cml0ZVByaWNlKGksIHRoaXMucHJpY2VzW2ldIHx8IDApO1xuICAgIH1cbiAgICAvLyBUT0RPOiBoYW5kbGUgdmFuaWxsYSB3cml0ZSAobG9jYXRpb24gKyBpbmRleCwgc2tpcHBpbmcgdW51c2VkKVxuICAgIGlmIChzaG9wRGF0YSkge1xuICAgICAgY29uc3Qgc2hvcExvY2F0aW9ucyA9IHNob3BEYXRhICsgdGhpcy5yb20uc2hvcENvdW50ICogMTc7XG4gICAgICBwcmdbc2hvcExvY2F0aW9ucyArIHRoaXMuaWRdID0gdGhpcy5sb2NhdGlvbjtcbiAgICB9XG4gIH1cbn1cblxuY29uc3QgVkFOSUxMQV9TSE9QX0xPQ0FUSU9OUyA9IDB4MjFmNTQ7XG5jb25zdCBWQU5JTExBX1NIT1BfSU5ESUNFUyA9IDB4MjFmNzU7XG5jb25zdCBWQU5JTExBX0FSTU9SX1NIT1BfSVRFTVMgPSAweDIxZGE0O1xuY29uc3QgVkFOSUxMQV9BUk1PUl9TSE9QX1BSSUNFUyA9IDB4MjFkZDA7XG5jb25zdCBWQU5JTExBX1RPT0xfU0hPUF9JVEVNUyA9IDB4MjFlMjg7XG5jb25zdCBWQU5JTExBX1RPT0xfU0hPUF9QUklDRVMgPSAweDIxZTU0O1xuY29uc3QgVkFOSUxMQV9JTk5fUFJJQ0VTID0gMHgyMWVhYztcbiJdfQ==