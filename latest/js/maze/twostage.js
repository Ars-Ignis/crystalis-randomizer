import { Monogrid } from './monogrid.js';
import { CaveShuffle } from './cave.js';
import { OK } from './maze.js';
import { hex, seq } from '../rom/util.js';
export class TwoStageCaveShuffle extends CaveShuffle {
    constructor() {
        super(...arguments);
        this.maxAttempts = 250;
    }
    initialFill(a) {
        let result;
        if ((result = this.initialFillEarly(a)), !result.ok)
            return result;
        this.initialFillLate(a);
        if ((result = this.connectEarlyToLate(a)), !result.ok)
            return result;
        a.count =
            [...a.grid.screens()]
                .filter(pos => a.grid.get(pos + 0x808)).length;
        return OK;
    }
    initialFillEarly(a) {
        const g = new Monogrid(a.h, a.w, this.getValidEarlyScreens());
        let attempts = 0;
        const target = this.targetEarly();
        while (attempts++ < 20 && g.size < target) {
            if (g.addPath(this.random, target))
                attempts = 0;
        }
        a.grid.data = g.toGrid(this.early).data;
        this.addAllFixed(a);
        return OK;
    }
    initialFillLate(a) {
        for (let y = 0; y < a.h; y++) {
            for (let x = 0; x < a.w; x++) {
                const c = (y << 12 | x << 4 | 0x808);
                if (!a.grid.get(c))
                    a.grid.set(c, 'c');
            }
        }
        for (let y = 0; y < a.h; y++) {
            for (let x = 0; x < a.w; x++) {
                for (const d of [8, 0x800]) {
                    const c = (y << 12 | x << 4 | 0x808);
                    const c1 = c + d;
                    const c2 = c + 2 * d;
                    if (!a.grid.isBorder(c1) && !a.grid.get(c1) &&
                        a.grid.get(c) === 'c' && a.grid.get(c2) === 'c') {
                        a.grid.set(c1, 'c');
                    }
                }
            }
        }
    }
    connectEarlyToLate(a) {
        for (const s of this.random.ishuffle(a.grid.screens())) {
            for (const d of [8, 0x800]) {
                const c = s | 0x808;
                const c1 = c + d;
                const c2 = c + 2 * d;
                if (a.grid.isBorder(c1) || a.grid.get(c1))
                    continue;
                a.grid.set(c1, 'c');
                const s1 = this.extract(a.grid, c - 0x808);
                const s2 = this.extract(a.grid, c2 - 0x808);
                if (!this.orig.tileset.getMetascreensFromTileString(s1).length ||
                    !this.orig.tileset.getMetascreensFromTileString(s2).length) {
                    a.grid.set(c1, '');
                }
            }
        }
        return OK;
    }
    pruneDisconnected(a) {
        const parts = new Set(a.grid.partition().values());
        let size = 0;
        for (const part of parts) {
            const early = [...part].some(c => a.grid.get(c) === this.early);
            if (early) {
                size += [...part].filter(c => (c & 0x808) === 0x808).length;
            }
            else {
                for (const c of part) {
                    if (a.fixed.has(c)) {
                        return { ok: false, fail: `fixed tile ${hex(c)} disconnected` };
                    }
                    a.grid.set(c, '');
                }
            }
        }
        if (size < this.params.size) {
            console.error(a.grid.show());
            return { ok: false, fail: 'too much disconnected' };
        }
        return OK;
    }
    addAllFixed(a) {
        for (let i = 0; i < a.grid.data.length; i++) {
            if (a.grid.data[i])
                a.fixed.add(a.grid.coord(i));
        }
    }
    getValidEarlyScreens() {
        if (!this.validEarlyScreens) {
            const valid = new Set();
            for (const s of this.orig.tileset) {
                const index = s.edgeIndex(this.early);
                if (index != null)
                    valid.add(index);
            }
            this.validEarlyScreens = valid;
        }
        return this.validEarlyScreens;
    }
    addEarlyFeatures(a) {
        var _a, _b;
        if (!this.addArenas(a, (_b = (_a = this.params.features) === null || _a === void 0 ? void 0 : _a.arena) !== null && _b !== void 0 ? _b : 0)) {
            return { ok: false, fail: 'addArenas' };
        }
        let result;
        if ((result = this.pruneDisconnected(a)), !result.ok)
            return result;
        return super.addEarlyFeatures(a);
    }
}
export class SaberaPalaceShuffle extends TwoStageCaveShuffle {
    constructor() {
        super(...arguments);
        this.early = 'w';
        this.maxAttempts = 250;
    }
    targetEarly() {
        var _a;
        const target = (_a = this.params.features) === null || _a === void 0 ? void 0 : _a.wide;
        return target != null ? target + 2 + this.random.nextInt(3) : 0;
    }
    initialFillEarly(a) {
        var _a, _b;
        const g = new Monogrid(a.h, a.w);
        g.fill();
        const all = seq(g.data.length).slice(g.w);
        const stair = this.random.pick(all);
        if (!g.deleteEdge(stair, 1))
            return { ok: false, fail: `initial stair` };
        if (!g.deleteEdge(stair, 2))
            return { ok: false, fail: `initial stair` };
        if (!g.deleteEdge(stair, 3))
            return { ok: false, fail: `initial stair` };
        g.fixed.add(stair);
        const allSet = new Set(all);
        allSet.delete(stair);
        const arenas = [];
        for (const pos of this.random.ishuffle(allSet)) {
            function del(p) {
                if (!g.delete(p))
                    return false;
                g.fixed.add(p);
                return true;
            }
            const targetArenas = (_b = (_a = this.params.features) === null || _a === void 0 ? void 0 : _a.arena) !== null && _b !== void 0 ? _b : 0;
            if (arenas.length >= targetArenas)
                break;
            if (pos > g.data.length - 2 * g.w)
                continue;
            if (g.fixed.has(pos))
                continue;
            const l = !g.isBorder(pos, 1);
            const r = !g.isBorder(pos, 3);
            if (l && g.fixed.has(pos - 1))
                continue;
            if (r && g.fixed.has(pos + 1))
                continue;
            if (g.fixed.has(pos - g.w))
                continue;
            if (g.fixed.has(pos + g.w))
                continue;
            if (!(g.data[pos] & 4))
                continue;
            if (!del(pos - g.w))
                return { ok: false, fail: `initial arena` };
            if (l && !del(pos - 1))
                return { ok: false, fail: `initial arena` };
            if (r && !del(pos + 1))
                return { ok: false, fail: `initial arena` };
            const d = pos + g.w;
            if ((g.data[d] & 5) !== 5)
                return { ok: false, fail: `initial arena` };
            if (!g.deleteEdge(d, 1))
                return { ok: false, fail: `initial arena` };
            if (!g.deleteEdge(d, 3))
                return { ok: false, fail: `initial arena` };
            g.deleteEdge(d + g.w, 2);
            g.fixed.add(d);
            arenas.push(pos);
            g.fixed.add(pos);
        }
        if (!g.refine(this.random, this.targetEarly())) {
            return { ok: false, fail: `refine` };
        }
        const bad = new Set();
        for (let i = 1; i < 16; i++) {
            if (!this.getValidEarlyScreens().has(i))
                bad.add(i);
        }
        if (!g.consolidateFixed(this.random, bad)) {
            return { ok: false, fail: `consolidate` };
        }
        a.grid.data = g.toGrid('w').data;
        function set(i, v) {
            const x = i % g.w;
            const y = (i - x) / g.w;
            const c = (y << 12 | x << 4 | 0x808);
            a.grid.set(c, v);
            for (const d of [-0x808, -0x800, -0x7f8, -8, 0, 8, 0x7f8, 0x800, 0x808]) {
                a.fixed.add(c + d);
            }
        }
        set(stair, '>');
        for (const a of arenas) {
            set(a, 'a');
        }
        let size = 3;
        for (const s of a.grid.screens()) {
            if (a.grid.get(s + 0x808))
                size++;
        }
        a.size = size;
        return OK;
    }
    addStairs(a, up, down) {
        return super.addStairs(a, up, down ? down - 1 : 0);
    }
    addArenas() { return true; }
    connectEarlyToLate(a) {
        for (let y = 0; y < a.h; y++) {
            const row = y << 12 | 0x808;
            for (let x = 0; x < a.w; x++) {
                const c = (row | x << 4);
                if (a.grid.get(c) === 'a') {
                    a.grid.set(c - 0x800, 'c');
                }
            }
        }
        return OK;
    }
    preinfer(a) {
        const map = new Map();
        for (let i = 0; i < a.grid.data.length; i++) {
            if (a.grid.data[i] === 'w')
                map.set(a.grid.coord(i), '');
        }
        const parts = a.grid.partition(map);
        const ups = new Set();
        for (const [c, s] of parts) {
            if (a.grid.get(c) === '<')
                ups.add(s);
        }
        if (ups.size < 2)
            return { ok: false, fail: `stairs bunched` };
        return OK;
    }
    refineMetascreens(a, meta) {
        for (const pos of meta.allPos()) {
            const scr = meta.get(pos);
            if (scr.hasFeature('arena')) {
                meta.set(pos, meta.rom.metascreens.fortressArena_through);
            }
        }
        return OK;
    }
    refineEdges() { return true; }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHdvc3RhZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvbWF6ZS90d29zdGFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXpDLE9BQU8sRUFBRSxXQUFXLEVBQXNCLE1BQU0sV0FBVyxDQUFDO0FBQzVELE9BQU8sRUFBVSxFQUFFLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdkMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQVcsTUFBTSxnQkFBZ0IsQ0FBQztBQUtuRCxNQUFNLE9BQWdCLG1CQUFvQixTQUFRLFdBQVc7SUFBN0Q7O1FBQ0UsZ0JBQVcsR0FBRyxHQUFHLENBQUM7SUErSHBCLENBQUM7SUF6SEMsV0FBVyxDQUFDLENBQUk7UUFDZCxJQUFJLE1BQW9CLENBQUM7UUFDekIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQUUsT0FBTyxNQUFNLENBQUM7UUFDbkUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFBRSxPQUFPLE1BQU0sQ0FBQztRQUVyRSxDQUFDLENBQUMsS0FBSztZQUNILENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2lCQUNoQixNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsS0FBa0IsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ3BFLE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELGdCQUFnQixDQUFD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QUU7Z0JBQzNCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLHFCQUFxQixDQUFDLENBQUM7YUFDM0Q7U0FDRjtRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELFdBQVcsS0FBSyxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUM7Q0FDL0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb25vZ3JpZCB9IGZyb20gJy4vbW9ub2dyaWQuanMnO1xuaW1wb3J0IHsgR3JpZEluZGV4LCBHcmlkQ29vcmQgfSBmcm9tICcuL2dyaWQuanMnO1xuaW1wb3J0IHsgQ2F2ZVNodWZmbGUsIENhdmVTaHVmZmxlQXR0ZW1wdCB9IGZyb20gJy4vY2F2ZS5qcyc7XG5pbXBvcnQgeyBSZXN1bHQsIE9LIH0gZnJvbSAnLi9tYXplLmpzJztcbmltcG9ydCB7IGhleCwgc2VxLCBNdXRhYmxlIH0gZnJvbSAnLi4vcm9tL3V0aWwuanMnO1xuaW1wb3J0IHsgTWV0YWxvY2F0aW9uIH0gZnJvbSAnLi4vcm9tL21ldGFsb2NhdGlvbi5qcyc7XG5cbnR5cGUgQSA9IENhdmVTaHVmZmxlQXR0ZW1wdDtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFR3b1N0YWdlQ2F2ZVNodWZmbGUgZXh0ZW5kcyBDYXZlU2h1ZmZsZSB7XG4gIG1heEF0dGVtcHRzID0gMjUwO1xuICBhYnN0cmFjdCBlYXJseTogc3RyaW5nO1xuICB2YWxpZEVhcmx5U2NyZWVucz86IFNldDxudW1iZXI+O1xuXG4gIGFic3RyYWN0IHRhcmdldEVhcmx5KCk6IG51bWJlcjtcblxuICBpbml0aWFsRmlsbChhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBsZXQgcmVzdWx0OiBSZXN1bHQ8dm9pZD47XG4gICAgaWYgKChyZXN1bHQgPSB0aGlzLmluaXRpYWxGaWxsRWFybHkoYSkpLCAhcmVzdWx0Lm9rKSByZXR1cm4gcmVzdWx0O1xuICAgIHRoaXMuaW5pdGlhbEZpbGxMYXRlKGEpO1xuICAgIGlmICgocmVzdWx0ID0gdGhpcy5jb25uZWN0RWFybHlUb0xhdGUoYSkpLCAhcmVzdWx0Lm9rKSByZXR1cm4gcmVzdWx0O1xuICAgIC8vIHVwZGF0ZSBjb3VudFxuICAgIGEuY291bnQgPVxuICAgICAgICBbLi4uYS5ncmlkLnNjcmVlbnMoKV1cbiAgICAgICAgICAgIC5maWx0ZXIocG9zID0+IGEuZ3JpZC5nZXQocG9zICsgMHg4MDggYXMgR3JpZENvb3JkKSkubGVuZ3RoO1xuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGluaXRpYWxGaWxsRWFybHkoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgY29uc3QgZyA9IG5ldyBNb25vZ3JpZChhLmgsIGEudywgdGhpcy5nZXRWYWxpZEVhcmx5U2NyZWVucygpKTtcbiAgICBsZXQgYXR0ZW1wdHMgPSAwO1xuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMudGFyZ2V0RWFybHkoKTtcbiAgICB3aGlsZSAoYXR0ZW1wdHMrKyA8IDIwICYmIGcuc2l6ZSA8IHRhcmdldCkge1xuICAgICAgaWYgKGcuYWRkUGF0aCh0aGlzLnJhbmRvbSwgdGFyZ2V0KSkgYXR0ZW1wdHMgPSAwO1xuICAgIH1cblxuICAgIGEuZ3JpZC5kYXRhID0gZy50b0dyaWQodGhpcy5lYXJseSkuZGF0YTtcbiAgICB0aGlzLmFkZEFsbEZpeGVkKGEpO1xuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGluaXRpYWxGaWxsTGF0ZShhOiBBKSB7XG4gICAgLy8gQWRkIGNhdmUgc2NyZWVucyB3aGVyZSBwb3NzaWJsZVxuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgYS5oOyB5KyspIHtcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgYS53OyB4KyspIHtcbiAgICAgICAgY29uc3QgYyA9ICh5IDw8IDEyIHwgeCA8PCA0IHwgMHg4MDgpIGFzIEdyaWRDb29yZDtcbiAgICAgICAgaWYgKCFhLmdyaWQuZ2V0KGMpKSBhLmdyaWQuc2V0KGMsICdjJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ29ubmVjdCBhbGwgdGhlICdjJyBzY3JlZW5zLCBkb24ndCBjb25uZWN0IHRvICdyJ1xuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgYS5oOyB5KyspIHtcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgYS53OyB4KyspIHtcbiAgICAgICAgZm9yIChjb25zdCBkIG9mIFs4LCAweDgwMF0pIHtcbiAgICAgICAgICBjb25zdCBjID0gKHkgPDwgMTIgfCB4IDw8IDQgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgICAgIGNvbnN0IGMxID0gYyArIGQgYXMgR3JpZENvb3JkO1xuICAgICAgICAgIGNvbnN0IGMyID0gYyArIDIgKiBkIGFzIEdyaWRDb29yZDtcbiAgICAgICAgICBpZiAoIWEuZ3JpZC5pc0JvcmRlcihjMSkgJiYgIWEuZ3JpZC5nZXQoYzEpICYmXG4gICAgICAgICAgICAgIGEuZ3JpZC5nZXQoYykgPT09ICdjJyAmJiBhLmdyaWQuZ2V0KGMyKSA9PT0gJ2MnKSB7XG4gICAgICAgICAgICBhLmdyaWQuc2V0KGMxLCAnYycpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbm5lY3RFYXJseVRvTGF0ZShhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBBZGQgY29ubmVjdGlvbnMgYmV0d2VlbiBsYW5kIGFuZCB3YXRlclxuICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLnJhbmRvbS5pc2h1ZmZsZShhLmdyaWQuc2NyZWVucygpKSkge1xuICAgICAgZm9yIChjb25zdCBkIG9mIFs4LCAweDgwMF0pIHtcbiAgICAgICAgY29uc3QgYyA9IHMgfCAweDgwOCBhcyBHcmlkQ29vcmQ7XG4gICAgICAgIGNvbnN0IGMxID0gYyArIGQgYXMgR3JpZENvb3JkO1xuICAgICAgICBjb25zdCBjMiA9IGMgKyAyICogZCBhcyBHcmlkQ29vcmQ7XG4gICAgICAgIGlmIChhLmdyaWQuaXNCb3JkZXIoYzEpIHx8IGEuZ3JpZC5nZXQoYzEpKSBjb250aW51ZTtcbiAgICAgICAgLy8gQ2hlY2sgaWYgYWRkaW5nIGMxIGlzIHZhbGlkXG4gICAgICAgIGEuZ3JpZC5zZXQoYzEsICdjJyk7XG4gICAgICAgIGNvbnN0IHMxID0gdGhpcy5leHRyYWN0KGEuZ3JpZCwgYyAtIDB4ODA4IGFzIEdyaWRDb29yZCk7XG4gICAgICAgIGNvbnN0IHMyID0gdGhpcy5leHRyYWN0KGEuZ3JpZCwgYzIgLSAweDgwOCBhcyBHcmlkQ29vcmQpO1xuICAgICAgICBpZiAoIXRoaXMub3JpZy50aWxlc2V0LmdldE1ldGFzY3JlZW5zRnJvbVRpbGVTdHJpbmcoczEpLmxlbmd0aCB8fFxuICAgICAgICAgICAgIXRoaXMub3JpZy50aWxlc2V0LmdldE1ldGFzY3JlZW5zRnJvbVRpbGVTdHJpbmcoczIpLmxlbmd0aCkge1xuICAgICAgICAgIGEuZ3JpZC5zZXQoYzEsICcnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICBwcnVuZURpc2Nvbm5lY3RlZChhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAvLyBQcnVuZSBhbnl0aGluZyBub3QgYXR0YWNoZWQgdG8gcml2ZXIsIG1ha2Ugc3VyZSBpdCdzIGJpZyBlbm91Z2guXG4gICAgY29uc3QgcGFydHMgPSBuZXcgU2V0KGEuZ3JpZC5wYXJ0aXRpb24oKS52YWx1ZXMoKSk7XG4gICAgbGV0IHNpemUgPSAwO1xuICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0cykge1xuICAgICAgY29uc3QgZWFybHkgPSBbLi4ucGFydF0uc29tZShjID0+IGEuZ3JpZC5nZXQoYykgPT09IHRoaXMuZWFybHkpO1xuICAgICAgaWYgKGVhcmx5KSB7XG4gICAgICAgIHNpemUgKz0gWy4uLnBhcnRdLmZpbHRlcihjID0+IChjICYgMHg4MDgpID09PSAweDgwOCkubGVuZ3RoO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9yIChjb25zdCBjIG9mIHBhcnQpIHtcbiAgICAgICAgICBpZiAoYS5maXhlZC5oYXMoYykpIHtcbiAgICAgICAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgZml4ZWQgdGlsZSAke2hleChjKX0gZGlzY29ubmVjdGVkYH07XG4gICAgICAgICAgfVxuICAgICAgICAgIGEuZ3JpZC5zZXQoYywgJycpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzaXplIDwgdGhpcy5wYXJhbXMuc2l6ZSkge1xuICAgICAgY29uc29sZS5lcnJvcihhLmdyaWQuc2hvdygpKTtcbiAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiAndG9vIG11Y2ggZGlzY29ubmVjdGVkJ307XG4gICAgfVxuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIGFkZEFsbEZpeGVkKGE6IEEpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEuZ3JpZC5kYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoYS5ncmlkLmRhdGFbaV0pIGEuZml4ZWQuYWRkKGEuZ3JpZC5jb29yZChpIGFzIEdyaWRJbmRleCkpO1xuICAgIH1cbiAgfVxuXG4gIGdldFZhbGlkRWFybHlTY3JlZW5zKCk6IFNldDxudW1iZXI+IHtcbiAgICBpZiAoIXRoaXMudmFsaWRFYXJseVNjcmVlbnMpIHtcbiAgICAgIGNvbnN0IHZhbGlkID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5vcmlnLnRpbGVzZXQpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSBzLmVkZ2VJbmRleCh0aGlzLmVhcmx5KTtcbiAgICAgICAgaWYgKGluZGV4ICE9IG51bGwpIHZhbGlkLmFkZChpbmRleCk7XG4gICAgICB9XG4gICAgICB0aGlzLnZhbGlkRWFybHlTY3JlZW5zID0gdmFsaWQ7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnZhbGlkRWFybHlTY3JlZW5zO1xuICB9XG5cbiAgYWRkRWFybHlGZWF0dXJlcyhhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuYWRkQXJlbmFzKGEsIHRoaXMucGFyYW1zLmZlYXR1cmVzPy5hcmVuYSA/PyAwKSkge1xuICAgICAgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6ICdhZGRBcmVuYXMnfTtcbiAgICB9XG4gICAgbGV0IHJlc3VsdDogUmVzdWx0PHZvaWQ+XG4gICAgaWYgKChyZXN1bHQgPSB0aGlzLnBydW5lRGlzY29ubmVjdGVkKGEpKSwgIXJlc3VsdC5vaykgcmV0dXJuIHJlc3VsdDtcbiAgICByZXR1cm4gc3VwZXIuYWRkRWFybHlGZWF0dXJlcyhhKTtcbiAgfVxufVxuXG5cblxuZXhwb3J0IGNsYXNzIFNhYmVyYVBhbGFjZVNodWZmbGUgZXh0ZW5kcyBUd29TdGFnZUNhdmVTaHVmZmxlIHtcbiAgZWFybHkgPSAndyc7XG4gIG1heEF0dGVtcHRzID0gMjUwO1xuXG4gIHRhcmdldEVhcmx5KCkge1xuICAgIC8vIEFkZHMgKzIgYmVjYXVzZSBhcmVuYXMgbXVzdCBjb21lIGZyb20gd2lkZSBzY3JlZW5zLlxuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMucGFyYW1zLmZlYXR1cmVzPy53aWRlO1xuICAgIHJldHVybiB0YXJnZXQgIT0gbnVsbCA/IHRhcmdldCArIDIgKyB0aGlzLnJhbmRvbS5uZXh0SW50KDMpIDogMDtcbiAgfVxuXG4gIC8vIGluaXRpYWxGaWxsRWFybHkoYTogQSk6IFJlc3VsdDx2b2lkPiB7XG5cbiAgLy8gICAvLyBUT0RPIC0gcmFuZG9tIHVwZnJvbnQgbG9jIGZvciBhcmVuYXMgYW5kIGRvd25zdGFpciwgY29ubmVjdCB3LyBwYXRocz9cbiAgLy8gICAvLyAgICAgIC0gbmVlZCBhIG1vcmUgcmFuZG9tIGRpcmVjdGVkIHBhdGguXG5cbiAgLy8gICBjb25zdCByID0gc3VwZXIuaW5pdGlhbEZpbGxFYXJseShhKTtcbiAgLy8gICBpZiAoIXIub2spIHJldHVybiByO1xuICAvLyAgIC8vIEZpbmQgc29tZXdoZXJlIGZvciB0aGUgZG93bnN0YWlycy5cbiAgLy8gICBmb3IgKGNvbnN0IGMgb2YgdGhpcy5yYW5kb20uaXNodWZmbGUoYS5ncmlkLnNjcmVlbnMoKSkpIHtcbiAgLy8gICAgIGNvbnN0IGUgPSB0aGlzLmV4dHJhY3QoYS5ncmlkLCBjKTtcbiAgLy8gICAgIGlmIChlID09PSAnIHcgIHcgICAgJykge1xuICAvLyAgICAgICBhLmdyaWQuc2V0KGMgKyAweDgwOCBhcyBHcmlkQ29vcmQsICc+Jyk7XG4gIC8vICAgICAgIHJldHVybiBPSztcbiAgLy8gICAgIH0gZWxzZSBpZiAoYyA+Pj4gMTIgPCBhLmggLSAxICYmXG4gIC8vICAgICAgICAgICAgICAgIC8gW3cgXSB3d3cgICAvLnRlc3QoZSkgJiZcbiAgLy8gICAgICAgICAgICAgICAgIS9cXFMvLnRlc3QodGhpcy5leHRyYWN0KGEuZ3JpZCwgYyArIDB4MTAwMCBhcyBHcmlkQ29vcmQpKSkge1xuICAvLyAgICAgICBhLmdyaWQuc2V0KGMgKyAweDEwMDggYXMgR3JpZENvb3JkLCAndycpO1xuICAvLyAgICAgICBhLmdyaWQuc2V0KGMgKyAweDE4MDggYXMgR3JpZENvb3JkLCAnPicpO1xuICAvLyAgICAgICByZXR1cm4gT0s7XG4gIC8vICAgICB9XG4gIC8vICAgfVxuICAvLyAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgY291bGQgbm90IHBsYWNlIGRvd25zdGFpcmB9O1xuICAvLyB9XG5cbiAgaW5pdGlhbEZpbGxFYXJseShhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBjb25zdCBnID0gbmV3IE1vbm9ncmlkKGEuaCwgYS53KTtcbiAgICBnLmZpbGwoKTtcbiAgICBjb25zdCBhbGwgPSBzZXEoZy5kYXRhLmxlbmd0aCkuc2xpY2UoZy53KTtcbiAgICBjb25zdCBzdGFpciA9IHRoaXMucmFuZG9tLnBpY2soYWxsKTtcbiAgICBpZiAoIWcuZGVsZXRlRWRnZShzdGFpciwgMSkpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgaW5pdGlhbCBzdGFpcmB9O1xuICAgIGlmICghZy5kZWxldGVFZGdlKHN0YWlyLCAyKSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBpbml0aWFsIHN0YWlyYH07XG4gICAgaWYgKCFnLmRlbGV0ZUVkZ2Uoc3RhaXIsIDMpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgc3RhaXJgfTtcbiAgICBnLmZpeGVkLmFkZChzdGFpcik7XG4gICAgY29uc3QgYWxsU2V0ID0gbmV3IFNldChhbGwpO1xuICAgIGFsbFNldC5kZWxldGUoc3RhaXIpO1xuICAgIGNvbnN0IGFyZW5hczogbnVtYmVyW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHBvcyBvZiB0aGlzLnJhbmRvbS5pc2h1ZmZsZShhbGxTZXQpKSB7XG4gICAgICBmdW5jdGlvbiBkZWwocDogbnVtYmVyKSB7XG4gICAgICAgIGlmICghZy5kZWxldGUocCkpIHJldHVybiBmYWxzZTtcbiAgICAgICAgZy5maXhlZC5hZGQocCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgdGFyZ2V0QXJlbmFzID0gdGhpcy5wYXJhbXMuZmVhdHVyZXM/LmFyZW5hID8/IDA7XG4gICAgICBpZiAoYXJlbmFzLmxlbmd0aCA+PSB0YXJnZXRBcmVuYXMpIGJyZWFrO1xuICAgICAgaWYgKHBvcyA+IGcuZGF0YS5sZW5ndGggLSAyICogZy53KSBjb250aW51ZTtcbiAgICAgIGlmIChnLmZpeGVkLmhhcyhwb3MpKSBjb250aW51ZTtcbiAgICAgIGNvbnN0IGwgPSAhZy5pc0JvcmRlcihwb3MsIDEpO1xuICAgICAgY29uc3QgciA9ICFnLmlzQm9yZGVyKHBvcywgMyk7XG4gICAgICBpZiAobCAmJiBnLmZpeGVkLmhhcyhwb3MgLSAxKSkgY29udGludWU7XG4gICAgICBpZiAociAmJiBnLmZpeGVkLmhhcyhwb3MgKyAxKSkgY29udGludWU7XG4gICAgICBpZiAoZy5maXhlZC5oYXMocG9zIC0gZy53KSkgY29udGludWU7XG4gICAgICBpZiAoZy5maXhlZC5oYXMocG9zICsgZy53KSkgY29udGludWU7XG4gICAgICBpZiAoIShnLmRhdGFbcG9zXSAmIDQpKSBjb250aW51ZTtcbiAgICAgIGlmICghZGVsKHBvcyAtIGcudykpIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgaW5pdGlhbCBhcmVuYWB9O1xuICAgICAgaWYgKGwgJiYgIWRlbChwb3MgLSAxKSkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBpbml0aWFsIGFyZW5hYH07XG4gICAgICBpZiAociAmJiAhZGVsKHBvcyArIDEpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgYXJlbmFgfTtcbiAgICAgIGNvbnN0IGQgPSBwb3MgKyBnLnc7XG4gICAgICBpZiAoKGcuZGF0YVtkXSAmIDUpICE9PSA1KSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgYXJlbmFgfTtcbiAgICAgIGlmICghZy5kZWxldGVFZGdlKGQsIDEpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgYXJlbmFgfTtcbiAgICAgIGlmICghZy5kZWxldGVFZGdlKGQsIDMpKSByZXR1cm4ge29rOiBmYWxzZSwgZmFpbDogYGluaXRpYWwgYXJlbmFgfTtcbiAgICAgIGcuZGVsZXRlRWRnZShkICsgZy53LCAyKTtcbiAgICAgIGcuZml4ZWQuYWRkKGQpO1xuICAgICAgYXJlbmFzLnB1c2gocG9zKTtcbiAgICAgIGcuZml4ZWQuYWRkKHBvcyk7XG4gICAgfVxuICAgIGlmICghZy5yZWZpbmUodGhpcy5yYW5kb20sIHRoaXMudGFyZ2V0RWFybHkoKSkpIHtcbiAgICAgIHJldHVybiB7b2s6IGZhbHNlLCBmYWlsOiBgcmVmaW5lYH07XG4gICAgfVxuICAgIGNvbnN0IGJhZCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgMTY7IGkrKykge1xuICAgICAgaWYgKCF0aGlzLmdldFZhbGlkRWFybHlTY3JlZW5zKCkuaGFzKGkpKSBiYWQuYWRkKGkpO1xuICAgIH1cbiAgICBpZiAoIWcuY29uc29saWRhdGVGaXhlZCh0aGlzLnJhbmRvbSwgYmFkKSkge1xuICAgICAgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBjb25zb2xpZGF0ZWB9O1xuICAgIH1cbiAgICBhLmdyaWQuZGF0YSA9IGcudG9HcmlkKCd3JykuZGF0YTtcbiAgICBmdW5jdGlvbiBzZXQoaTogbnVtYmVyLCB2OiBzdHJpbmcpIHtcbiAgICAgIGNvbnN0IHggPSBpICUgZy53O1xuICAgICAgY29uc3QgeSA9IChpIC0geCkgLyBnLnc7XG4gICAgICBjb25zdCBjID0gKHkgPDwgMTIgfCB4IDw8IDQgfCAweDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgYS5ncmlkLnNldChjLCB2KTtcbiAgICAgIGZvciAoY29uc3QgZCBvZiBbLTB4ODA4LCAtMHg4MDAsIC0weDdmOCwgLTgsIDAsIDgsIDB4N2Y4LCAweDgwMCwgMHg4MDhdKSB7XG4gICAgICAgIGEuZml4ZWQuYWRkKGMgKyBkIGFzIEdyaWRDb29yZCk7XG4gICAgICB9XG4gICAgfVxuICAgIHNldChzdGFpciwgJz4nKTtcbiAgICBmb3IgKGNvbnN0IGEgb2YgYXJlbmFzKSB7XG4gICAgICBzZXQoYSwgJ2EnKTtcbiAgICB9XG4gICAgbGV0IHNpemUgPSAzO1xuICAgIGZvciAoY29uc3QgcyBvZiBhLmdyaWQuc2NyZWVucygpKSB7XG4gICAgICBpZiAoYS5ncmlkLmdldChzICsgMHg4MDggYXMgR3JpZENvb3JkKSkgc2l6ZSsrO1xuICAgIH1cbiAgICAoYSBhcyBNdXRhYmxlPHR5cGVvZiBhPikuc2l6ZSA9IHNpemU7XG4gICAgcmV0dXJuIE9LO1xuICB9XG5cbiAgYWRkU3RhaXJzKGE6IEEsIHVwPzogbnVtYmVyLCBkb3duPzogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHN1cGVyLmFkZFN0YWlycyhhLCB1cCwgZG93biA/IGRvd24gLSAxIDogMCk7XG4gIH1cblxuICBhZGRBcmVuYXMoKSB7IHJldHVybiB0cnVlOyB9XG5cbiAgY29ubmVjdEVhcmx5VG9MYXRlKGE6IEEpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgYS5oOyB5KyspIHtcbiAgICAgIGNvbnN0IHJvdyA9IHkgPDwgMTIgfCAweDgwODtcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgYS53OyB4KyspIHtcbiAgICAgICAgY29uc3QgYyA9IChyb3cgfCB4IDw8IDQpIGFzIEdyaWRDb29yZDtcbiAgICAgICAgaWYgKGEuZ3JpZC5nZXQoYykgPT09ICdhJykge1xuICAgICAgICAgIGEuZ3JpZC5zZXQoYyAtIDB4ODAwIGFzIEdyaWRDb29yZCwgJ2MnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gT0s7XG4gIH1cblxuICBwcmVpbmZlcihhOiBBKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBjb25zdCBtYXAgPSBuZXcgTWFwPEdyaWRDb29yZCwgc3RyaW5nPigpO1xuICAgIGZvciAobGV0IGkgPSAwIGFzIEdyaWRJbmRleDsgaSA8IGEuZ3JpZC5kYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoYS5ncmlkLmRhdGFbaV0gPT09ICd3JykgbWFwLnNldChhLmdyaWQuY29vcmQoaSksICcnKTtcbiAgICB9XG4gICAgY29uc3QgcGFydHMgPSBhLmdyaWQucGFydGl0aW9uKG1hcCk7XG4gICAgY29uc3QgdXBzID0gbmV3IFNldDxTZXQ8R3JpZENvb3JkPj4oKTtcbiAgICBmb3IgKGNvbnN0IFtjLCBzXSBvZiBwYXJ0cykge1xuICAgICAgaWYgKGEuZ3JpZC5nZXQoYykgPT09ICc8JykgdXBzLmFkZChzKTtcbiAgICB9XG4gICAgaWYgKHVwcy5zaXplIDwgMikgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGBzdGFpcnMgYnVuY2hlZGB9O1xuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIHJlZmluZU1ldGFzY3JlZW5zKGE6IEEsIG1ldGE6IE1ldGFsb2NhdGlvbik6IFJlc3VsdDx2b2lkPiB7XG4gICAgZm9yIChjb25zdCBwb3Mgb2YgbWV0YS5hbGxQb3MoKSkge1xuICAgICAgY29uc3Qgc2NyID0gbWV0YS5nZXQocG9zKTtcbiAgICAgIGlmIChzY3IuaGFzRmVhdHVyZSgnYXJlbmEnKSkge1xuICAgICAgICBtZXRhLnNldChwb3MsIG1ldGEucm9tLm1ldGFzY3JlZW5zLmZvcnRyZXNzQXJlbmFfdGhyb3VnaCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBPSztcbiAgfVxuXG4gIHJlZmluZUVkZ2VzKCkgeyByZXR1cm4gdHJ1ZTsgfVxufVxuIl19