import { Grid } from './grid.js';
import { hex } from '../rom/util.js';
const [] = [hex];
export const OK = { ok: true, value: undefined };
export class MazeShuffles {
    constructor(rom, random) {
        this.rom = rom;
        this.random = random;
        this.shuffles = [];
    }
    add(...shuffles) {
        this.shuffles.push(...shuffles);
    }
    shuffleAll() {
        for (const shuffle of this.shuffles) {
            shuffle.shuffle(this.random);
        }
        for (const shuffle of this.shuffles) {
            if (shuffle.meta)
                shuffle.finish();
        }
        for (const loc of this.rom.locations) {
            loc.meta.shufflePits(this.random);
        }
    }
}
export class AbstractMazeShuffle {
    constructor(loc, params) {
        this.maxAttempts = 250;
        this.attempt = 0;
        this.meta = undefined;
        this.grid = new Grid(1, 1);
        this.fixed = new Set();
        this.w = 0;
        this.h = 0;
        this.size = 0;
        this.count = 0;
        this.exitMap = [];
        this.loc = loc;
        this.orig = loc.meta;
        this.params = params !== null && params !== void 0 ? params : this.survey(this.orig);
    }
    reset() {
        this.meta = undefined;
        const h = this.pickHeight();
        const w = this.pickWidth();
        const size = this.pickSize();
        const grid = new Grid(h, w);
        grid.data.fill('');
        Object.assign(this, { h, w, size, grid, fixed: new Set(),
            count: 0, exitMap: [] });
    }
    shuffle(random) {
        if (!this.loc.used || this.meta || this.attempt > this.maxAttempts)
            return;
        Object.assign(this, { random });
        while (++this.attempt <= this.maxAttempts) {
            this.reset();
            const result = this.build();
            if (result.ok)
                return;
            console.log(`Shuffle failed ${this.loc}: ${result.fail}`);
        }
        console.error(`Completely failed to map shuffle ${this.loc}`);
    }
    finish() {
        if (!this.meta || this.meta === this.loc.meta)
            return;
        this.finishInternal();
    }
    finishInternal() {
        if (!this.meta)
            throw new Error(`impossible`);
        this.meta.transferFlags(this.loc.meta, this.random);
        const mappedExits = [];
        for (const [pred, pos, type] of this.exitMap) {
            for (const [opos, otype, spec] of mappedExits) {
                if (pred(opos, otype)) {
                    mappedExits.push([pos, type, spec]);
                    break;
                }
            }
        }
        this.meta.transferExits(this.loc.meta, this.random);
        for (const [srcPos, srcType, spec] of mappedExits) {
            const dest = this.meta.rom.locations[spec[0] >>> 8].meta;
            const destPos = spec[0] & 0xff;
            const destType = spec[1];
            this.meta.attach(srcPos, dest, destPos, srcType, destType);
        }
        this.meta.transferSpawns(this.loc.meta, this.random);
        this.meta.transferPits(this.loc.meta);
        this.loc.meta = this.meta;
    }
    pickHeight() {
        return Math.max(1, Math.min(16, this.orig.height +
            Math.floor((this.random.nextInt(6) - 1) / 3)));
    }
    pickWidth() {
        return Math.max(1, Math.min(8, this.orig.width +
            Math.floor((this.random.nextInt(6) - 1) / 3)));
    }
    pickSize() {
        return this.params.size + (this.random.nextInt(5) < 2 ? 1 : 0);
    }
    insertTile(pos, tile) {
        const s = this.posToGrid(pos);
        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                const g = s + r * 0x800 + c * 8;
                if (this.fixed.has(g))
                    return false;
                const v = this.grid.get(g);
                if (v && v !== tile[r * 3 + c])
                    return false;
            }
        }
        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                const g = s + r * 0x800 + c * 8;
                this.grid.set(g, tile[r * 3 + c]);
            }
        }
        return true;
    }
    posToGrid(pos, offset = 0) {
        const y = pos >>> 4;
        const x = pos & 0xf;
        return (y << 12 | x << 4) + offset;
    }
    insertPattern(pattern, { top = 0, bottom = 0, left = 0, right = 0 } = {}) {
        const ph = (pattern.length - 1) >>> 1;
        const pw = (pattern[0].length - 1) >>> 1;
        const dh = top + bottom;
        const dw = left + right;
        if (this.h < ph + dh)
            return { ok: false, fail: `too short` };
        if (this.w < pw + dw)
            return { ok: false, fail: `too narrow` };
        const y0 = this.random.nextInt(this.h - ph - 1 - dh) + top;
        const x0 = this.random.nextInt(this.w - pw - 1 - dh) + left;
        const c0 = (y0 + 1) << 12 | (x0 + 1) << 4;
        Grid.writeGrid2d(this.grid, c0, pattern);
        for (let y = 0x3000; y <= 0x5000; y += 0x800) {
            for (let x = 0x30; x <= 0x40; x += 0x8) {
                this.fixed.add(c0 + (y | x));
            }
        }
        return { ok: true, value: undefined };
    }
    extract(g, c, { h = 3, w = 3, replace = undefined, } = {}) {
        const index = g.index(c);
        let out = '';
        const end = index + h * g.row;
        const { row } = g;
        for (let r = index; r < end; r += row) {
            for (let i = r; i < r + w; i++) {
                if (replace) {
                    const s = replace.get(g.coord(i));
                    if (s != null) {
                        out += (s || ' ');
                        continue;
                    }
                }
                out += (g.data[i] || ' ');
            }
        }
        return out;
    }
    canSet(c, v) {
        return this.canSetAll(new Map([[c, v]]));
    }
    canSetAll(replace) {
        const screens = new Set();
        for (const c of replace.keys()) {
            if (this.fixed.has(c))
                return false;
            const s = (c & ~0x808);
            const y = s >>> 12;
            const x = (s >>> 4) & 0xf;
            if (x < this.w && y < this.h)
                screens.add(s);
            if (!(c & 8) && y < this.h && x)
                screens.add(s - 0x10);
            if (!(c & 0x800) && x < this.w && y)
                screens.add(s - 0x1000);
            if (!(c & 0x808) && x && y)
                screens.add(s - 0x1010);
        }
        for (const s of screens) {
            const tile = this.extract(this.grid, s, { replace });
            if (!this.orig.tileset.getMetascreensFromTileString(tile).length) {
                return false;
            }
        }
        return true;
    }
    addAllFixed() {
        for (let i = 0; i < this.grid.data.length; i++) {
            if (this.grid.data[i])
                this.fixed.add(this.grid.coord(i));
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF6ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9tYXplL21hemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBd0IsTUFBTSxXQUFXLENBQUM7QUFFdkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTXJDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFvQmpCLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBaUIsRUFBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsQ0FBQztBQUU3RCxNQUFNLE9BQU8sWUFBWTtJQUV2QixZQUFxQixHQUFRLEVBQVcsTUFBYztRQUFqQyxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQVcsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUQ3QyxhQUFRLEdBQWtCLEVBQUUsQ0FBQztJQUNtQixDQUFDO0lBRTFELEdBQUcsQ0FBQyxHQUFHLFFBQXVCO1FBQzVCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUdELFVBQVU7UUFDUixLQUFLLE1BQU0sT0FBTyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbkMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDOUI7UUFDRCxLQUFLLE1BQU0sT0FBTyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbkMsSUFBSSxPQUFPLENBQUMsSUFBSTtnQkFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDcEM7UUFFRCxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQ3BDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNuQztJQUNILENB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QUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBYyxDQUFDLENBQUMsQ0FBQztTQUN4RTtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdyaWQsIEdyaWRDb29yZCwgR3JpZEluZGV4IH0gZnJvbSAnLi9ncmlkLmpzJztcbmltcG9ydCB7IFJhbmRvbSB9IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQgeyBoZXggfSBmcm9tICcuLi9yb20vdXRpbC5qcyc7XG5pbXBvcnQgeyBNZXRhbG9jYXRpb24sIFBvcywgRXhpdFNwZWMgfSBmcm9tICcuLi9yb20vbWV0YWxvY2F0aW9uLmpzJztcbmltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnLi4vcm9tL2xvY2F0aW9uLmpzJztcbmltcG9ydCB7IENvbm5lY3Rpb25UeXBlIH0gZnJvbSAnLi4vcm9tL21ldGFzY3JlZW5kYXRhLmpzJztcbmltcG9ydCB7IFJvbSB9IGZyb20gJy4uL3JvbS5qcyc7XG5cbmNvbnN0IFtdID0gW2hleF07XG5cbnR5cGUgRmVhdHVyZSA9XG4gICAgLy8gY2F2ZXNcbiAgICAnYXJlbmEnIHwgJ2JyaWRnZScgfCAnb3ZlcicgfCAncGl0JyB8ICdyYW1wJyB8ICdyaXZlcicgfCAnc3Bpa2UnIHxcbiAgICAnc3RhdHVlJyB8ICd1bmRlcicgfCAnd2FsbCcgfCAnd2lkZScgfFxuICAgIC8vIG92ZXJ3b3JsZFxuICAgICdjYXZlJyB8ICdzaG9ydEdyYXNzJyB8ICdsb25nR3Jhc3MnIHwgJ2ljZUJyaWRnZScgfCAnd29vZEJyaWRnZScgfCAnY2FueW9uJztcblxuZXhwb3J0IGludGVyZmFjZSBTdXJ2ZXkge1xuICByZWFkb25seSBpZDogbnVtYmVyO1xuICByZWFkb25seSBtZXRhOiBNZXRhbG9jYXRpb247XG4gIHJlYWRvbmx5IHNpemU6IG51bWJlcjtcbiAgcmVhZG9ubHkgZWRnZXM/OiBudW1iZXJbXTsgLy8gW3RvcCwgbGVmdCwgYm90dG9tLCByaWdodF1cbiAgcmVhZG9ubHkgc3RhaXJzPzogbnVtYmVyW107IC8vIFt1cCwgZG93bl1cbiAgLy9wb2k/OiBudW1iZXI7XG4gIHJlYWRvbmx5IGZlYXR1cmVzPzoge1tmIGluIEZlYXR1cmVdPzogbnVtYmVyfTsgLy8gYSwgciwgcywgcCwgYiwgd1xufVxuXG5leHBvcnQgdHlwZSBSZXN1bHQ8VD4gPSB7b2s6IHRydWUsIHZhbHVlOiBUfSB8IHtvazogZmFsc2UsIGZhaWw6IHN0cmluZ307XG5leHBvcnQgY29uc3QgT0s6IFJlc3VsdDx2b2lkPiA9IHtvazogdHJ1ZSwgdmFsdWU6IHVuZGVmaW5lZH07XG5cbmV4cG9ydCBjbGFzcyBNYXplU2h1ZmZsZXMge1xuICByZWFkb25seSBzaHVmZmxlczogTWF6ZVNodWZmbGVbXSA9IFtdO1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSwgcmVhZG9ubHkgcmFuZG9tOiBSYW5kb20pIHt9XG5cbiAgYWRkKC4uLnNodWZmbGVzOiBNYXplU2h1ZmZsZVtdKSB7XG4gICAgdGhpcy5zaHVmZmxlcy5wdXNoKC4uLnNodWZmbGVzKTtcbiAgfVxuXG4gIC8vIFNodWZmbGVzIGFsbCB0aGUgbWF6ZXMuXG4gIHNodWZmbGVBbGwoKSB7XG4gICAgZm9yIChjb25zdCBzaHVmZmxlIG9mIHRoaXMuc2h1ZmZsZXMpIHtcbiAgICAgIHNodWZmbGUuc2h1ZmZsZSh0aGlzLnJhbmRvbSk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qgc2h1ZmZsZSBvZiB0aGlzLnNodWZmbGVzKSB7XG4gICAgICBpZiAoc2h1ZmZsZS5tZXRhKSBzaHVmZmxlLmZpbmlzaCgpO1xuICAgIH1cbiAgICAvLyBTaHVmZmxlIHRoZSBwaXRzIGF0IHRoZSBlbmQuLi5cbiAgICBmb3IgKGNvbnN0IGxvYyBvZiB0aGlzLnJvbS5sb2NhdGlvbnMpIHtcbiAgICAgIGxvYy5tZXRhLnNodWZmbGVQaXRzKHRoaXMucmFuZG9tKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBNYXplU2h1ZmZsZSB7XG4gIG1ldGE6IE1ldGFsb2NhdGlvbnx1bmRlZmluZWQ7XG4gIHNodWZmbGUocmFuZG9tOiBSYW5kb20pOiB2b2lkO1xuICBmaW5pc2goKTogdm9pZDtcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFic3RyYWN0TWF6ZVNodWZmbGUge1xuICAvLyBTaHVmZmxlLWxldmVsIGNvbnN0YW50cy5cbiAgcmVhZG9ubHkgbG9jOiBMb2NhdGlvbjtcbiAgcmVhZG9ubHkgcmFuZG9tITogUmFuZG9tO1xuICByZWFkb25seSBvcmlnOiBNZXRhbG9jYXRpb247XG4gIHJlYWRvbmx5IG1heEF0dGVtcHRzOiBudW1iZXIgPSAyNTA7XG4gIHJlYWRvbmx5IHBhcmFtczogU3VydmV5O1xuXG4gIC8vIFNodWZmbGUgc3RhdGUuXG4gIGF0dGVtcHQgPSAwO1xuXG4gIC8vIE91dHB1dC4gIENhbiBiZSBjbGVhcmVkIHRvIGZvcmNlIGEgcmVzaHVmZmxlLlxuICBtZXRhOiBNZXRhbG9jYXRpb258dW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gIC8vIEF0dGVtcHQgc3RhdGUgdmFyaWFibGVzLlxuICAvLyBOT1RFOiBUaGVzZSBhcmUgbWFya2VkIGFzIHJlYWRvbmx5LCBidXQgdGhleSBhcmUgY2xlYXJlZCBieSByZXNldCgpLiAgVGhlXG4gIC8vIGJlbmVmaXQgb2YgbWFya2luZyB0aGVtIHJlYWRvbmx5IG91dHdlaWdocyB0aGUgdWdsaW5lc3Mgb2YgbXV0YXRpbmcgdGhlbS5cbiAgcmVhZG9ubHkgZ3JpZCA9IG5ldyBHcmlkPHN0cmluZz4oMSwgMSk7XG4gIHJlYWRvbmx5IGZpeGVkID0gbmV3IFNldDxHcmlkQ29vcmQ+KCk7XG4gIHJlYWRvbmx5IHc6IG51bWJlciA9IDA7XG4gIHJlYWRvbmx5IGg6IG51bWJlciA9IDA7XG4gIHJlYWRvbmx5IHNpemU6IG51bWJlciA9IDA7XG4gIGNvdW50ID0gMDtcbiAgLy8gRW50cmllcyBhcmUgW3ByZWRpY2F0ZSBmb3Igb3JpZyBleGl0LCBuZXcgcG9zLCBuZXcgdHlwZV0gLSBpZiBhIG1hdGNoaW5nXG4gIC8vIGV4aXQgaXMgZm91bmQgaW4gdGhlIG9yaWdpbmFsIG1ldGFsb2NhdGlvbiwgaXQncyBtb3ZlZCB0byB0aGUgbmV3IHBvc2l0aW9uLlxuICByZWFkb25seSBleGl0TWFwOiBBcnJheTxyZWFkb25seSBbKHA6IFBvcywgdDogQ29ubmVjdGlvblR5cGUpID0+IGJvb2xlYW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIC0gYWRkIGRlc3QgdG8gcHJlZGljYXRlP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9zLCBDb25uZWN0aW9uVHlwZV0+ID0gW107XG5cbiAgY29uc3RydWN0b3IobG9jOiBMb2NhdGlvbiwgcGFyYW1zPzogU3VydmV5KSB7XG4gICAgdGhpcy5sb2MgPSBsb2M7XG4gICAgdGhpcy5vcmlnID0gbG9jLm1ldGE7XG4gICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgPz8gdGhpcy5zdXJ2ZXkodGhpcy5vcmlnKTtcbiAgfVxuXG4gIC8qKiBSZXNldHMgdGhlIGF0dGVtcHQgc3RhdGUuICovXG4gIHJlc2V0KCkge1xuICAgIHRoaXMubWV0YSA9IHVuZGVmaW5lZDtcbiAgICBjb25zdCBoID0gdGhpcy5waWNrSGVpZ2h0KCk7XG4gICAgY29uc3QgdyA9IHRoaXMucGlja1dpZHRoKCk7XG4gICAgY29uc3Qgc2l6ZSA9IHRoaXMucGlja1NpemUoKTtcbiAgICBjb25zdCBncmlkID0gbmV3IEdyaWQoaCwgdyk7XG4gICAgZ3JpZC5kYXRhLmZpbGwoJycpO1xuICAgIC8vIE5PVEU6IHZpb2xhdGVzIHJlYWRvbmx5XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7aCwgdywgc2l6ZSwgZ3JpZCwgZml4ZWQ6IG5ldyBTZXQoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogMCwgZXhpdE1hcDogW119KTtcbiAgfVxuXG4gIHNodWZmbGUocmFuZG9tOiBSYW5kb20pIHtcbiAgICBpZiAoIXRoaXMubG9jLnVzZWQgfHwgdGhpcy5tZXRhIHx8IHRoaXMuYXR0ZW1wdCA+IHRoaXMubWF4QXR0ZW1wdHMpIHJldHVybjtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtyYW5kb219KTtcbiAgICB3aGlsZSAoKyt0aGlzLmF0dGVtcHQgPD0gdGhpcy5tYXhBdHRlbXB0cykge1xuICAgICAgdGhpcy5yZXNldCgpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5idWlsZCgpO1xuICAgICAgaWYgKHJlc3VsdC5vaykgcmV0dXJuO1xuICAgICAgY29uc29sZS5sb2coYFNodWZmbGUgZmFpbGVkICR7dGhpcy5sb2N9OiAke3Jlc3VsdC5mYWlsfWApO1xuICAgIH1cbiAgICAvL3Rocm93IG5ldyBFcnJvcihgQ29tcGxldGVseSBmYWlsZWQgdG8gbWFwIHNodWZmbGUgJHtsb2N9YCk7XG4gICAgY29uc29sZS5lcnJvcihgQ29tcGxldGVseSBmYWlsZWQgdG8gbWFwIHNodWZmbGUgJHt0aGlzLmxvY31gKTtcbiAgfVxuXG4gIGFic3RyYWN0IHN1cnZleShtZXRhOiBNZXRhbG9jYXRpb24pOiBTdXJ2ZXk7XG5cbiAgYWJzdHJhY3QgYnVpbGQoKTogUmVzdWx0PHZvaWQ+O1xuXG4gIGZpbmlzaCgpIHsgLy8gZmluYWxcbiAgICBpZiAoIXRoaXMubWV0YSB8fCB0aGlzLm1ldGEgPT09IHRoaXMubG9jLm1ldGEpIHJldHVybjtcbiAgICB0aGlzLmZpbmlzaEludGVybmFsKCk7XG4gIH1cblxuICBmaW5pc2hJbnRlcm5hbCgpIHtcbiAgICBpZiAoIXRoaXMubWV0YSkgdGhyb3cgbmV3IEVycm9yKGBpbXBvc3NpYmxlYCk7XG4gICAgdGhpcy5tZXRhLnRyYW5zZmVyRmxhZ3ModGhpcy5sb2MubWV0YSwgdGhpcy5yYW5kb20pO1xuICAgIGNvbnN0IG1hcHBlZEV4aXRzOiBBcnJheTxbUG9zLCBDb25uZWN0aW9uVHlwZSwgRXhpdFNwZWNdPiA9IFtdO1xuICAgIGZvciAoY29uc3QgW3ByZWQsIHBvcywgdHlwZV0gb2YgdGhpcy5leGl0TWFwKSB7XG4gICAgICBmb3IgKGNvbnN0IFtvcG9zLCBvdHlwZSwgc3BlY10gb2YgbWFwcGVkRXhpdHMpIHtcbiAgICAgICAgaWYgKHByZWQob3Bvcywgb3R5cGUpKSB7XG4gICAgICAgICAgbWFwcGVkRXhpdHMucHVzaChbcG9zLCB0eXBlLCBzcGVjXSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5tZXRhLnRyYW5zZmVyRXhpdHModGhpcy5sb2MubWV0YSwgdGhpcy5yYW5kb20pO1xuICAgIGZvciAoY29uc3QgW3NyY1Bvcywgc3JjVHlwZSwgc3BlY10gb2YgbWFwcGVkRXhpdHMpIHtcbiAgICAgIGNvbnN0IGRlc3QgPSB0aGlzLm1ldGEucm9tLmxvY2F0aW9uc1tzcGVjWzBdID4+PiA4XS5tZXRhO1xuICAgICAgY29uc3QgZGVzdFBvcyA9IHNwZWNbMF0gJiAweGZmO1xuICAgICAgY29uc3QgZGVzdFR5cGUgPSBzcGVjWzFdO1xuICAgICAgdGhpcy5tZXRhLmF0dGFjaChzcmNQb3MsIGRlc3QsIGRlc3RQb3MsIHNyY1R5cGUsIGRlc3RUeXBlKTtcbiAgICB9XG4gICAgdGhpcy5tZXRhLnRyYW5zZmVyU3Bhd25zKHRoaXMubG9jLm1ldGEsIHRoaXMucmFuZG9tKTtcbiAgICB0aGlzLm1ldGEudHJhbnNmZXJQaXRzKHRoaXMubG9jLm1ldGEpO1xuICAgIC8vbmV3TWV0YS5yZXBsYWNlTW9uc3RlcnModGhpcy5yYW5kb20pO1xuICAgIHRoaXMubG9jLm1ldGEgPSB0aGlzLm1ldGE7XG4gIH1cblxuICBwaWNrSGVpZ2h0KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIE1hdGgubWF4KDEsIE1hdGgubWluKDE2LCB0aGlzLm9yaWcuaGVpZ2h0ICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcigodGhpcy5yYW5kb20ubmV4dEludCg2KSAtIDEpIC8gMykpKTtcbiAgfVxuXG4gIHBpY2tXaWR0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLm1heCgxLCBNYXRoLm1pbig4LCB0aGlzLm9yaWcud2lkdGggK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKCh0aGlzLnJhbmRvbS5uZXh0SW50KDYpIC0gMSkgLyAzKSkpO1xuICB9XG5cbiAgcGlja1NpemUoKTogbnVtYmVyIHtcbiAgICAvLyA0MCUgY2hhbmNlIG9mICsxIHNpemVcbiAgICByZXR1cm4gdGhpcy5wYXJhbXMuc2l6ZSArICh0aGlzLnJhbmRvbS5uZXh0SW50KDUpIDwgMiA/IDEgOiAwKTtcbiAgfVxuXG4gIGluc2VydFRpbGUocG9zOiBQb3MsIHRpbGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHMgPSB0aGlzLnBvc1RvR3JpZChwb3MpO1xuICAgIGZvciAobGV0IHIgPSAwOyByIDwgMzsgcisrKSB7XG4gICAgICBmb3IgKGxldCBjID0gMDsgYyA8IDM7IGMrKykge1xuICAgICAgICBjb25zdCBnID0gcyArIHIgKiAweDgwMCArIGMgKiA4IGFzIEdyaWRDb29yZDtcbiAgICAgICAgaWYgKHRoaXMuZml4ZWQuaGFzKGcpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGNvbnN0IHYgPSB0aGlzLmdyaWQuZ2V0KGcpO1xuICAgICAgICBpZiAodiAmJiB2ICE9PSB0aWxlW3IgKiAzICsgY10pIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChsZXQgciA9IDA7IHIgPCAzOyByKyspIHtcbiAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgMzsgYysrKSB7XG4gICAgICAgIGNvbnN0IGcgPSBzICsgciAqIDB4ODAwICsgYyAqIDggYXMgR3JpZENvb3JkO1xuICAgICAgICB0aGlzLmdyaWQuc2V0KGcsIHRpbGVbciAqIDMgKyBjXSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcG9zVG9HcmlkKHBvczogUG9zLCBvZmZzZXQ6IG51bWJlciA9IDApOiBHcmlkQ29vcmQge1xuICAgIGNvbnN0IHkgPSBwb3MgPj4+IDQ7XG4gICAgY29uc3QgeCA9IHBvcyAmIDB4ZjtcbiAgICByZXR1cm4gKHkgPDwgMTIgfCB4IDw8IDQpICsgb2Zmc2V0IGFzIEdyaWRDb29yZDtcbiAgfVxuXG4gIGluc2VydFBhdHRlcm4ocGF0dGVybjogcmVhZG9ubHkgc3RyaW5nW10sXG4gICAgICAgICAgICAgICAge3RvcCA9IDAsIGJvdHRvbSA9IDAsIGxlZnQgPSAwLCByaWdodCA9IDB9ID0ge30pOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGNvbnN0IHBoID0gKHBhdHRlcm4ubGVuZ3RoIC0gMSkgPj4+IDE7XG4gICAgY29uc3QgcHcgPSAocGF0dGVyblswXS5sZW5ndGggLSAxKSA+Pj4gMTtcbiAgICBjb25zdCBkaCA9IHRvcCArIGJvdHRvbTtcbiAgICBjb25zdCBkdyA9IGxlZnQgKyByaWdodDtcbiAgICBpZiAodGhpcy5oIDwgcGggKyBkaCkgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGB0b28gc2hvcnRgfTtcbiAgICBpZiAodGhpcy53IDwgcHcgKyBkdykgcmV0dXJuIHtvazogZmFsc2UsIGZhaWw6IGB0b28gbmFycm93YH07XG4gICAgY29uc3QgeTAgPSB0aGlzLnJhbmRvbS5uZXh0SW50KHRoaXMuaCAtIHBoIC0gMSAtIGRoKSArIHRvcDtcbiAgICBjb25zdCB4MCA9IHRoaXMucmFuZG9tLm5leHRJbnQodGhpcy53IC0gcHcgLSAxIC0gZGgpICsgbGVmdDtcbiAgICBjb25zdCBjMCA9ICh5MCArIDEpIDw8IDEyIHwgKHgwICsgMSkgPDwgNDtcbiAgICBHcmlkLndyaXRlR3JpZDJkKHRoaXMuZ3JpZCwgYzAgYXMgR3JpZENvb3JkLCBwYXR0ZXJuKTtcbiAgICBmb3IgKGxldCB5ID0gMHgzMDAwOyB5IDw9IDB4NTAwMDsgeSArPSAweDgwMCkge1xuICAgICAgZm9yIChsZXQgeCA9IDB4MzA7IHggPD0gMHg0MDsgeCArPSAweDgpIHtcbiAgICAgICAgdGhpcy5maXhlZC5hZGQoYzAgKyAoeSB8IHgpIGFzIEdyaWRDb29yZCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7b2s6IHRydWUsIHZhbHVlOiB1bmRlZmluZWR9O1xuICB9XG5cbiAgLyoqIEV4dHJhY3QgYSAzeDMgc2VjdGlvbiBpbnRvIGEgKGjDl3cpLWNoYXJhY3RlciBzdHJpbmcuICovXG4gIGV4dHJhY3QoZzogR3JpZDxhbnk+LCBjOiBHcmlkQ29vcmQsXG4gICAgICAgICAge2ggPSAzLCB3ID0gMyxcbiAgICAgICAgICAgcmVwbGFjZSA9IHVuZGVmaW5lZCBhcyBNYXA8R3JpZENvb3JkLCBzdHJpbmc+fHVuZGVmaW5lZCxcbiAgICAgICAgICB9ID0ge30pOiBzdHJpbmcge1xuICAgIGNvbnN0IGluZGV4ID0gZy5pbmRleChjKTtcbiAgICBsZXQgb3V0ID0gJyc7XG4gICAgY29uc3QgZW5kID0gaW5kZXggKyBoICogZy5yb3c7XG4gICAgY29uc3Qge3Jvd30gPSBnO1xuICAgIGZvciAobGV0IHIgPSBpbmRleCBhcyBudW1iZXI7IHIgPCBlbmQ7IHIgKz0gcm93KSB7XG4gICAgICBmb3IgKGxldCBpID0gcjsgaSA8IHIgKyB3OyBpKyspIHtcbiAgICAgICAgaWYgKHJlcGxhY2UpIHtcbiAgICAgICAgICBjb25zdCBzID0gcmVwbGFjZS5nZXQoZy5jb29yZChpIGFzIEdyaWRJbmRleCkpO1xuICAgICAgICAgIGlmIChzICE9IG51bGwpIHtcbiAgICAgICAgICAgIG91dCArPSAocyB8fCAnICcpO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG91dCArPSAoZy5kYXRhW2ldIHx8ICcgJyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBjYW5TZXQoYzogR3JpZENvb3JkLCB2OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5jYW5TZXRBbGwobmV3IE1hcChbW2MsIHZdXSkpO1xuICB9XG5cbiAgY2FuU2V0QWxsKHJlcGxhY2U6IE1hcDxHcmlkQ29vcmQsIHN0cmluZz4pOiBib29sZWFuIHtcbiAgICBjb25zdCBzY3JlZW5zID0gbmV3IFNldDxHcmlkQ29vcmQ+KCk7XG4gICAgZm9yIChjb25zdCBjIG9mIHJlcGxhY2Uua2V5cygpKSB7XG4gICAgICBpZiAodGhpcy5maXhlZC5oYXMoYykpIHJldHVybiBmYWxzZTtcbiAgICAgIGNvbnN0IHMgPSAoYyAmIH4weDgwOCkgYXMgR3JpZENvb3JkO1xuICAgICAgY29uc3QgeSA9IHMgPj4+IDEyO1xuICAgICAgY29uc3QgeCA9IChzID4+PiA0KSAmIDB4ZjtcbiAgICAgIGlmICh4IDwgdGhpcy53ICYmIHkgPCB0aGlzLmgpIHNjcmVlbnMuYWRkKHMpO1xuICAgICAgaWYgKCEoYyAmIDgpICYmIHkgPCB0aGlzLmggJiYgeCkgc2NyZWVucy5hZGQocyAtIDB4MTAgYXMgR3JpZENvb3JkKTtcbiAgICAgIGlmICghKGMgJiAweDgwMCkgJiYgeCA8IHRoaXMudyAmJiB5KSBzY3JlZW5zLmFkZChzIC0gMHgxMDAwIGFzIEdyaWRDb29yZCk7XG4gICAgICBpZiAoIShjICYgMHg4MDgpICYmIHggJiYgeSkgc2NyZWVucy5hZGQocyAtIDB4MTAxMCBhcyBHcmlkQ29vcmQpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IHMgb2Ygc2NyZWVucykge1xuICAgICAgY29uc3QgdGlsZSA9IHRoaXMuZXh0cmFjdCh0aGlzLmdyaWQsIHMsIHtyZXBsYWNlfSk7XG4gICAgICBpZiAoIXRoaXMub3JpZy50aWxlc2V0LmdldE1ldGFzY3JlZW5zRnJvbVRpbGVTdHJpbmcodGlsZSkubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhZGRBbGxGaXhlZCgpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZ3JpZC5kYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAodGhpcy5ncmlkLmRhdGFbaV0pIHRoaXMuZml4ZWQuYWRkKHRoaXMuZ3JpZC5jb29yZChpIGFzIEdyaWRJbmRleCkpO1xuICAgIH1cbiAgfVxufVxuIl19