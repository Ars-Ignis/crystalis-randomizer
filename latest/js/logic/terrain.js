import { DefaultMap, iters } from '../util.js';
import { Requirement } from './requirement.js';
export class Terrains {
    constructor(rom) {
        this.rom = rom;
        this.tiles = new DefaultMap((effects) => makeTile(this.rom, effects));
        this.bosses = new DefaultMap((flag) => new BossTerrain(flag));
        this.statues = new Map();
        this.flags = new DefaultMap((base) => new DefaultMap((flag) => new DefaultMap((alt) => new FlagTerrain(base, flag, alt))));
        this.meets = new DefaultMap((left) => new DefaultMap((right) => new MeetTerrain(left, right)));
        this._seamless = new DefaultMap((t) => new SeamlessTerrain(t));
    }
    tile(effects) {
        return effects & 0x04 ? undefined : this.tiles.get(effects);
    }
    boss(flag, isRage) {
        if (isRage) {
            return this.rage || (this.rage = new RageTerrain(flag, this.rom.flags.RageSkip.id));
        }
        return this.bosses.get(flag);
    }
    statue(req) {
        const label = Requirement.label(req);
        let terrain = this.statues.get(label);
        if (!terrain)
            this.statues.set(label, terrain = new StatueTerrain(req));
        return terrain;
    }
    flag(base, flag, alt) {
        if (!base)
            base = CLOSED;
        return this.flags.get(base).get(flag).get(alt);
    }
    meet(left, right) {
        return this.meets.get(left).get(right);
    }
    seamless(delegate) {
        return this._seamless.get(delegate);
    }
    label(terrain, rom) {
        if (terrain.label)
            return terrain.label(rom);
        return 'Terrain';
    }
}
export var Terrain;
(function (Terrain) {
    Terrain.FLY = 0x02;
    Terrain.BLOCKED = 0x04;
    Terrain.SLOPE = 0x20;
    Terrain.PAIN = 0x80;
    Terrain.BITS = 0xa6;
    Terrain.SWAMP = 0x100;
    Terrain.BARRIER = 0x200;
    Terrain.SLOPE8 = 0x400;
    Terrain.SLOPE9 = 0x800;
    Terrain.DOLPHIN = 0x1000;
    function label(t, rom) {
        var _a, _b;
        return (_b = (_a = t.label) === null || _a === void 0 ? void 0 : _a.call(t, rom)) !== null && _b !== void 0 ? _b : 'Terrain';
    }
    Terrain.label = label;
})(Terrain || (Terrain = {}));
class SeamlessTerrain {
    constructor(_delegate) {
        this._delegate = _delegate;
        this.enter = _delegate.enter;
        this.exit = _delegate.exit;
    }
    label(rom) {
        return `Seamless(${Terrain.label(this._delegate, rom)})`;
    }
}
class SimpleTerrain {
    constructor(enter, exit = Requirement.OPEN) {
        this.enter = enter;
        this.exit = [[0xf, exit]];
    }
    get kind() { return 'Simple'; }
    label(rom) {
        const terr = [];
        if (!Requirement.isOpen(this.enter)) {
            terr.push(`enter = ${debugLabel(this.enter, rom)}`);
        }
        if (!Requirement.isOpen(this.exit[0][1])) {
            terr.push(`exit = ${debugLabel(this.exit[0][1], rom)}`);
        }
        return `${this.kind}(${terr.join(', ')})`;
    }
}
class SouthTerrain {
    constructor(enter, exit) {
        this.enter = enter;
        this.exit =
            exit ?
                [[0xb, exit], [0x4, Requirement.OPEN]] :
                [[0xf, Requirement.OPEN]];
    }
    get kind() { return 'South'; }
    label(rom) {
        if (this.exit.length === 1) {
            return SimpleTerrain.prototype.label.call(this, rom);
        }
        const terr = [];
        if (!Requirement.isOpen(this.enter)) {
            terr.push(`enter = ${debugLabel(this.enter, rom)}`);
        }
        if (!Requirement.isOpen(this.exit[0][1])) {
            terr.push(`other = ${debugLabel(this.exit[0][1], rom)}`);
        }
        if (!Requirement.isOpen(this.exit[1][1])) {
            terr.push(`south = ${debugLabel(this.exit[1][1], rom)}`);
        }
        return `${this.kind}(${terr.join(', ')})`;
    }
}
function makeTile(rom, effects) {
    let enter = Requirement.OPEN;
    let exit = undefined;
    if ((effects & Terrain.DOLPHIN) && (effects & Terrain.FLY)) {
        if (effects & Terrain.SLOPE) {
            exit = rom.flags.ClimbWaterfall.r;
        }
        enter = [[rom.flags.CurrentlyRidingDolphin.c], [rom.flags.Flight.c]];
    }
    else {
        if (effects & Terrain.SLOPE9) {
            exit = rom.flags.ClimbSlope9.r;
        }
        else if (effects & Terrain.SLOPE8) {
            exit = rom.flags.ClimbSlope8.r;
        }
        else if (effects & Terrain.SLOPE) {
            exit = rom.flags.ClimbSlope10.r;
        }
        if (effects & Terrain.FLY)
            enter = rom.flags.Flight.r;
    }
    if (effects & Terrain.SWAMP) {
        enter = enter.map((cs) => [rom.flags.TravelSwamp.c, ...cs]);
    }
    if (effects & Terrain.PAIN) {
        enter = enter.map((cs) => [rom.flags.CrossPain.c, ...cs]);
    }
    if (effects & Terrain.BARRIER) {
        enter = enter.map((cs) => [rom.flags.ShootingStatue.c, ...cs]);
    }
    return new SouthTerrain(enter, exit);
}
class BossTerrain extends SimpleTerrain {
    constructor(_flag) {
        super(Requirement.OPEN, [[_flag]]);
        this._flag = _flag;
    }
    get kind() { return 'Boss'; }
}
class StatueTerrain extends SouthTerrain {
    constructor(_req) {
        super(Requirement.OPEN, _req);
        this._req = _req;
    }
    get kind() { return 'Statue'; }
}
class RageTerrain {
    constructor(_rageFlag, _rageSkipFlag) {
        this._rageFlag = _rageFlag;
        this._rageSkipFlag = _rageSkipFlag;
        this.enter = Requirement.OPEN;
        this.exit =
            [[0xb, [[_rageFlag], [_rageSkipFlag]]],
                [0x4, Requirement.OPEN]];
    }
    label() { return `Rage`; }
}
class FlagTerrain extends SimpleTerrain {
    constructor(base, flag, alt) {
        if (base.exit.length !== 1 || alt.exit.length !== 1) {
            throw new Error('bad flag');
        }
        const f = [[flag]];
        const enter = flag >= 0 ? Requirement.meet(alt.enter, f) : alt.enter;
        const exit = flag >= 0 ? Requirement.meet(alt.exit[0][1], f) : alt.exit[0][1];
        super(Requirement.or(base.enter, enter), Requirement.or(base.exit[0][1], exit));
    }
    get kind() { return 'Flag'; }
}
const CLOSED = new SimpleTerrain(Requirement.CLOSED, Requirement.CLOSED);
function directionIndex(t) {
    const ind = [];
    for (let i = 0; i < t.exit.length; i++) {
        for (let b = 0; b < 4; b++) {
            if (t.exit[i][0] & (1 << b))
                ind[b] = i;
        }
    }
    for (let b = 0; b < 4; b++) {
        if (ind[b] == null) {
            throw new Error(`Bad terrain: ${t.exit.map(e => e[0]).join(',')}`);
        }
    }
    return ind;
}
class MeetTerrain {
    constructor(left, right) {
        this.left = left;
        this.right = right;
        const leftInd = directionIndex(left);
        const rightInd = directionIndex(right);
        const sources = new Set();
        const exit = [];
        for (let i = 0; i < 4; i++) {
            sources.add(leftInd[i] << 2 | rightInd[i]);
        }
        for (const source of sources) {
            const [d0, r0] = left.exit[source >> 2];
            const [d1, r1] = right.exit[source & 3];
            exit.push([d0 & d1, Requirement.meet(r0, r1)]);
        }
        this.enter = Requirement.meet(left.enter, right.enter);
        this.exit = exit;
    }
    get kind() { return 'Terrain'; }
    label(rom) {
        if (this.exit.length === 1) {
            return SimpleTerrain.prototype.label.call(this, rom);
        }
        const terr = [];
        if (!Requirement.isOpen(this.enter)) {
            terr.push(`enter = ${debugLabel(this.enter, rom)}`);
        }
        for (const [dirs, req] of this.exit) {
            const dirstring = [dirs & 1 ? 'N' : '', dirs & 2 ? 'W' : '',
                dirs & 4 ? 'S' : '', dirs & 8 ? 'E' : ''].join('');
            terr.push(`exit${dirstring} = ${debugLabel(req, rom)}`);
        }
        return `${this.kind}(${terr.join(', ')})`;
    }
}
export function debugLabel(r, rom) {
    const css = [...r];
    const s = css.map(cs => iters.isEmpty(cs) ? 'open' :
        [...cs].map((c) => { var _a; return (_a = rom.flags[c]) === null || _a === void 0 ? void 0 : _a.debug; }).join(' & '))
        .join(') | (');
    return css.length > 1 ? `(${s})` : css.length ? s : 'never';
}
Terrain.debugLabel = debugLabel;
if (typeof window === 'object')
    window.debugLabel = debugLabel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9sb2dpYy90ZXJyYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxVQUFVLEVBQUUsS0FBSyxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBQzdDLE9BQU8sRUFBWSxXQUFXLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUV4RCxNQUFNLE9BQU8sUUFBUTtJQXVCbkIsWUFBcUIsR0FBUTtRQUFSLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFuQlosVUFBSyxHQUNsQixJQUFJLFVBQVUsQ0FDVixDQUFDLE9BQWUsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUN6QyxXQUFNLEdBQ25CLElBQUksVUFBVSxDQUFrQixDQUFDLElBQVksRUFBRSxFQUFFLENBQUMsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM1RCxZQUFPLEdBQUcsSUFBSSxHQUFHLEVBQW1CLENBQUM7UUFDckMsVUFBSyxHQUNsQixJQUFJLFVBQVUsQ0FDVixDQUFDLElBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxVQUFVLENBQzdCLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FBQyxJQUFJLFVBQVUsQ0FDNUIsQ0FBQyxHQUFZLEVBQUUsRUFBRSxDQUFDLElBQUksV0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckQsVUFBSyxHQUNsQixJQUFJLFVBQVUsQ0FDVixDQUFDLElBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxVQUFVLENBQzdCLENBQUMsS0FBYyxFQUFFLEVBQUUsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlDLGNBQVMsR0FDdEIsSUFBSSxVQUFVLENBQW1CLENBQUMsQ0FBVSxFQUFFLEVBQUUsQ0FBQyxJQUFJLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRzdDLENBQUM7SUFFakMsSUFBSSxDQUFDLE9BQWU7UUFDbEIsT0FBTyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRCxJQUFJLENBQUMsSUFBWSxFQUFFLE1BQWU7UUFDaEMsSUFBSSxNQUFNLEVBQUU7WUFDVixPQUFPLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksV0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNyRjtRQUNELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUdELE1BQU0sQ0FBQyxHQUF1QjtRQUM1QixNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxPQUFPO1lBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sR0FBRyxJQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLE9BQU8sT0FBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxJQUFJLENBQUMsSUFBdUIsRUFBRSxJQUFZLEVBQUUsR0FBWTtRQUN0RCxJQUFJLENBQUMsSUFBSTtZQUFFLElBQUksR0FBRyxNQUFNLENBQUM7UUFDekIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxJQUFJLENBQUMsSUFBYSxFQUFFLEtBQWM7UUFFaEMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELFFBQVEsQ0FBQyxRQUFpQjtRQUN4QixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBZ0IsRUFBRSxHQUFRO1FBQzlCLElBQUksT0FBTyxDQUFDLEtBQUs7WUFBRSxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0MsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBV0QsTUFBTSxLQUFXLE9BQU8sQ0F3QnZCO0FBeEJELFdBQWlCLE9BQU87SUFHVCxXQUFHLEdBQUcsSUFBSSxDQUFDO0lBQ1gsZUFBTyxHQUFHLElBQUksQ0FBQztJQUdmLGFBQUssR0FBRyxJQUFJLENBQUM7SUFFYixZQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ1osWUFBSSxHQUFHLElBQUksQ0FBQztJQUdaLGFBQUssR0FBRyxLQUFLLENBQUM7SUFDZCxlQUFPLEdBQUcsS0FBSyxDQUFDO0lBRWhCLGNBQU0sR0FBRyxLQUFLLENBQUM7SUFDZixjQUFNLEdBQUcsS0FBSyxDQUFDO0lBRWYsZUFBTyxHQUFHLE1BQU0sQ0FBQztJQUU5QixTQUFnQixLQUFLLENBQUMsQ0FBVSxFQUFFLEdBQVE7O1FBQ3hDLG1CQUFPLENBQUMsQ0FBQyxLQUFLLCtDQUFQLENBQUMsRUFBUyxHQUFHLG9DQUFLLFNBQVMsQ0FBQztJQUNyQyxDQUFDO0lBRmUsYUFBSyxRQUVwQixDQUFBO0FBQ0gsQ0FBQyxFQXhCZ0IsT0FBTyxLQUFQLE9BQU8sUUF3QnZCO0FBRUQsTUFBTSxlQUFlO0lBR25CLFlBQXFCLFNBQWtCO1FBQWxCLGNBQVMsR0FBVCxTQUFTLENBQVM7UUFDckMsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDO1FBQzdCLElBQUksQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQztJQUM3QixDQUFDO0lBRUQsS0FBSyxDQUFDLEdBQVE7UUFDWixPQUFPLFlBQVksT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUM7SUFDM0QsQ0FBQztDQUNGO0FBR0QsTUFBTSxhQUFhO0lBRWpCLFlBQXFCLEtBQXlCLEVBQ2xDLE9BQTJCLFdBQVcsQ0FBQyxJQUFJO1FBRGxDLFVBQUssR0FBTCxLQUFLLENBQW9CO1FBRTVDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLElBQUksS0FBSyxPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFFL0IsS0FBSyxDQUFDLEdBQVE7UUFDWixNQUFNLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDckQ7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN6RDtRQUNELE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUM1QyxDQUFDO0NBQ0Y7QUFHRCxNQUFNLFlBQVk7SUFFaEIsWUFBcUIsS0FBeUIsRUFBRSxJQUF5QjtRQUFwRCxVQUFLLEdBQUwsS0FBSyxDQUFvQjtRQUM1QyxJQUFJLENBQUMsSUFBSTtZQUNMLElBQUksQ0FBQyxDQUFDO2dCQUNGLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDeEMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsSUFBSSxJQUFJLEtBQUssT0FBTyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBRTlCLEtBQUssQ0FBQyxHQUFRO1FBQ1osSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDMUIsT0FBTyxhQUFhLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQzdEO1FBQ0QsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNuQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3JEO1FBQ0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDMUQ7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMxRDtRQUNELE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUM1QyxDQUFDO0NBQ0Y7QUFHRCxTQUFTLFFBQVEsQ0FBQyxHQUFRLEVBQUUsT0FBZTtJQUN6QyxJQUFJLEtBQUssR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDO0lBQzdCLElBQUksSUFBSSxHQUFHLFNBQVMsQ0FBQztJQUVyQixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDMUQsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRTtZQUMzQixJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1NBQ25DO1FBQ0QsS0FBSyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUN0RTtTQUFNO1FBQ0wsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUM1QixJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1NBQ2hDO2FBQU0sSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNuQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1NBQ2hDO2FBQU0sSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRTtZQUNsQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1NBQ2pDO1FBQ0QsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUc7WUFBRSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0tBQ3ZEO0lBQ0QsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRTtRQUMzQixLQUFLLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FDYixDQUFDLEVBQXdCLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztLQUNyRTtJQUNELElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUU7UUFDMUIsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQ2IsQ0FBQyxFQUF3QixFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDbkU7SUFDRCxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxFQUFFO1FBQzdCLEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxDQUNiLENBQUMsRUFBd0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQ3hFO0lBQ0QsT0FBTyxJQUFJLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUdELE1BQU0sV0FBWSxTQUFRLGFBQWE7SUFDckMsWUFBcUIsS0FBYTtRQUNoQyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsS0FBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUQ3QixVQUFLLEdBQUwsS0FBSyxDQUFRO0lBRWxDLENBQUM7SUFFRCxJQUFJLElBQUksS0FBSyxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUM7Q0FDOUI7QUFFRCxNQUFNLGFBQWMsU0FBUSxZQUFZO0lBQ3RDLFlBQXFCLElBQXdCO1FBQzNDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRFgsU0FBSSxHQUFKLElBQUksQ0FBb0I7SUFFN0MsQ0FBQztJQUVELElBQUksSUFBSSxLQUFLLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQztDQUNoQztBQUlELE1BQU0sV0FBVztJQUdmLFlBQXFCLFNBQWlCLEVBQVcsYUFBcUI7UUFBakQsY0FBUyxHQUFULFNBQVMsQ0FBUTtRQUFXLGtCQUFhLEdBQWIsYUFBYSxDQUFRO1FBRjdELFVBQUssR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBR2hDLElBQUksQ0FBQyxJQUFJO1lBQ1AsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsU0FBc0IsQ0FBQyxFQUFFLENBQUMsYUFBMEIsQ0FBQyxDQUFDLENBQUM7Z0JBQy9ELENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxLQUFLLEtBQUssT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDO0NBQzNCO0FBRUQsTUFBTSxXQUFZLFNBQVEsYUFBYTtJQUNyQyxZQUFZLElBQWEsRUFBRSxJQUFZLEVBQUUsR0FBWTtRQUduRCxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDbkQsTUFBTSxJQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUM3QjtRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFpQixDQUFDLENBQUMsQ0FBQztRQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUM7UUFDckUsTUFBTSxJQUFJLEdBQ04sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEVBQ2pDLFdBQVcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxJQUFJLElBQUksS0FBSyxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUM7Q0FDOUI7QUFDRCxNQUFNLE1BQU0sR0FBRyxJQUFJLGFBQWEsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUd6RSxTQUFTLGNBQWMsQ0FBQyxDQUFVO0lBQ2hDLE1BQU0sR0FBRyxHQUFhLEVBQUUsQ0FBQztJQUN6QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDdEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMxQixJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDekM7S0FDRjtJQUNELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDMUIsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxFQUFFO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNwRTtLQUNGO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBRUQsTUFBTSxXQUFXO0lBR2YsWUFBcUIsSUFBYSxFQUFXLEtBQWM7UUFBdEMsU0FBSSxHQUFKLElBQUksQ0FBUztRQUFXLFVBQUssR0FBTCxLQUFLLENBQVM7UUFJekQsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QyxNQUFNLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQ2xDLE1BQU0sSUFBSSxHQUFpRCxFQUFFLENBQUM7UUFDOUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMxQixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDNUM7UUFDRCxLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRTtZQUM1QixNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3hDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2hEO1FBQ0QsSUFBSSxDQUFDLEtBQUssR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFFRCxJQUFJLElBQUksS0FBSyxPQUFPLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFFaEMsS0FBSyxDQUFDLEdBQVE7UUFDWixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUMxQixPQUFPLGFBQWEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDN0Q7UUFDRCxNQUFNLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDckQ7UUFDRCxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUNuQyxNQUFNLFNBQVMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDeEMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdEUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLFNBQVMsTUFBTSxVQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN6RDtRQUNELE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUM1QyxDQUFDO0NBQ0Y7QUFHRCxNQUFNLFVBQVUsVUFBVSxDQUFDLENBQWMsRUFBRSxHQUFRO0lBQ2pELE1BQU0sR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNuQixNQUFNLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FDUCxDQUFDLENBQVksRUFBRSxFQUFFLHdCQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLDBDQUFFLEtBQUssR0FBQSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3BFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQixPQUFPLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUM5RCxDQUFDO0FBRUEsT0FBZSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7QUFDekMsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRO0lBQUcsTUFBYyxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7RGVmYXVsdE1hcCwgaXRlcnN9IGZyb20gJy4uL3V0aWwuanMnO1xuaW1wb3J0IHtDb25kaXRpb24sIFJlcXVpcmVtZW50fSBmcm9tICcuL3JlcXVpcmVtZW50LmpzJztcblxuZXhwb3J0IGNsYXNzIFRlcnJhaW5zIHtcblxuICAvLyBBZ2dyZXNzaXZlIG1lbW9pemF0aW9uIHByZXZlbnRzIGluc3RhbnRpYXRpbmcgdGhlIHNhbWUgdGVycmFpbiB0d2ljZS5cbiAgLy8gVGhpcyBhbGxvd3MgcmVmZXJlbmNlIGVxdWFsaXR5IHRvIHRlbGwgd2hlbiB0d28gdGVycmFpbnMgYXJlIHRoZSBzYW1lLlxuICBwcml2YXRlIHJlYWRvbmx5IHRpbGVzID1cbiAgICAgIG5ldyBEZWZhdWx0TWFwPG51bWJlciwgVGVycmFpbj4oXG4gICAgICAgICAgKGVmZmVjdHM6IG51bWJlcikgPT4gbWFrZVRpbGUodGhpcy5yb20sIGVmZmVjdHMpKTtcbiAgcHJpdmF0ZSByZWFkb25seSBib3NzZXMgPVxuICAgICAgbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBUZXJyYWluPigoZmxhZzogbnVtYmVyKSA9PiBuZXcgQm9zc1RlcnJhaW4oZmxhZykpO1xuICBwcml2YXRlIHJlYWRvbmx5IHN0YXR1ZXMgPSBuZXcgTWFwPHN0cmluZywgVGVycmFpbj4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBmbGFncyA9XG4gICAgICBuZXcgRGVmYXVsdE1hcDxUZXJyYWluLCBEZWZhdWx0TWFwPG51bWJlciwgRGVmYXVsdE1hcDxUZXJyYWluLCBUZXJyYWluPj4+KFxuICAgICAgICAgIChiYXNlOiBUZXJyYWluKSA9PiBuZXcgRGVmYXVsdE1hcChcbiAgICAgICAgICAgICAgKGZsYWc6IG51bWJlcikgPT4gbmV3IERlZmF1bHRNYXAoXG4gICAgICAgICAgICAgICAgICAoYWx0OiBUZXJyYWluKSA9PiBuZXcgRmxhZ1RlcnJhaW4oYmFzZSwgZmxhZywgYWx0KSkpKTtcbiAgcHJpdmF0ZSByZWFkb25seSBtZWV0cyA9XG4gICAgICBuZXcgRGVmYXVsdE1hcDxUZXJyYWluLCBEZWZhdWx0TWFwPFRlcnJhaW4sIFRlcnJhaW4+PihcbiAgICAgICAgICAobGVmdDogVGVycmFpbikgPT4gbmV3IERlZmF1bHRNYXAoXG4gICAgICAgICAgICAgIChyaWdodDogVGVycmFpbikgPT4gbmV3IE1lZXRUZXJyYWluKGxlZnQsIHJpZ2h0KSkpO1xuICBwcml2YXRlIHJlYWRvbmx5IF9zZWFtbGVzcyA9XG4gICAgICBuZXcgRGVmYXVsdE1hcDxUZXJyYWluLCBUZXJyYWluPigodDogVGVycmFpbikgPT4gbmV3IFNlYW1sZXNzVGVycmFpbih0KSk7XG4gIHByaXZhdGUgcmFnZTogUmFnZVRlcnJhaW58dW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tKSB7fVxuXG4gIHRpbGUoZWZmZWN0czogbnVtYmVyKTogVGVycmFpbnx1bmRlZmluZWQge1xuICAgIHJldHVybiBlZmZlY3RzICYgMHgwNCA/IHVuZGVmaW5lZCA6IHRoaXMudGlsZXMuZ2V0KGVmZmVjdHMpO1xuICB9XG5cbiAgYm9zcyhmbGFnOiBudW1iZXIsIGlzUmFnZTogYm9vbGVhbik6IFRlcnJhaW4ge1xuICAgIGlmIChpc1JhZ2UpIHtcbiAgICAgIHJldHVybiB0aGlzLnJhZ2UgfHwgKHRoaXMucmFnZSA9IG5ldyBSYWdlVGVycmFpbihmbGFnLCB0aGlzLnJvbS5mbGFncy5SYWdlU2tpcC5pZCkpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5ib3NzZXMuZ2V0KGZsYWcpO1xuICB9XG5cbiAgLy8gTk9URTogYWxzbyB1c2VkIGZvciB0cmlnZ2Vyc1xuICBzdGF0dWUocmVxOiBSZXF1aXJlbWVudC5Gcm96ZW4pOiBUZXJyYWluIHtcbiAgICBjb25zdCBsYWJlbCA9IFJlcXVpcmVtZW50LmxhYmVsKHJlcSk7XG4gICAgbGV0IHRlcnJhaW4gPSB0aGlzLnN0YXR1ZXMuZ2V0KGxhYmVsKTtcbiAgICBpZiAoIXRlcnJhaW4pIHRoaXMuc3RhdHVlcy5zZXQobGFiZWwsIHRlcnJhaW4gPSBuZXcgU3RhdHVlVGVycmFpbihyZXEpKTtcbiAgICByZXR1cm4gdGVycmFpbiE7XG4gIH1cblxuICBmbGFnKGJhc2U6IFRlcnJhaW58dW5kZWZpbmVkLCBmbGFnOiBudW1iZXIsIGFsdDogVGVycmFpbik6IFRlcnJhaW4ge1xuICAgIGlmICghYmFzZSkgYmFzZSA9IENMT1NFRDtcbiAgICByZXR1cm4gdGhpcy5mbGFncy5nZXQoYmFzZSkuZ2V0KGZsYWcpLmdldChhbHQpO1xuICB9XG5cbiAgbWVldChsZWZ0OiBUZXJyYWluLCByaWdodDogVGVycmFpbik6IFRlcnJhaW4ge1xuICAgIC8vIFRPRE8gLSBtZW1vaXplIHByb3Blcmx5PyAgb25seSBhbGxvdyB0d28/XG4gICAgcmV0dXJuIHRoaXMubWVldHMuZ2V0KGxlZnQpLmdldChyaWdodCk7XG4gIH1cblxuICBzZWFtbGVzcyhkZWxlZ2F0ZTogVGVycmFpbikge1xuICAgIHJldHVybiB0aGlzLl9zZWFtbGVzcy5nZXQoZGVsZWdhdGUpO1xuICB9XG5cbiAgbGFiZWwodGVycmFpbjogVGVycmFpbiwgcm9tOiBSb20pIHtcbiAgICBpZiAodGVycmFpbi5sYWJlbCkgcmV0dXJuIHRlcnJhaW4ubGFiZWwocm9tKTtcbiAgICByZXR1cm4gJ1RlcnJhaW4nO1xuICB9XG59XG5cbnR5cGUgRGlyTWFzayA9IG51bWJlcjtcbi8vIE5PVEU6IG1pc3NpbmcgZGlyZWN0aW9ucyBhcmUgZm9yYmlkZGVuLlxudHlwZSBFeGl0UmVxdWlyZW1lbnRzID0gUmVhZG9ubHlBcnJheTxyZWFkb25seSBbRGlyTWFzaywgUmVxdWlyZW1lbnQuRnJvemVuXT47XG5leHBvcnQgaW50ZXJmYWNlIFRlcnJhaW4ge1xuICBlbnRlcjogUmVxdWlyZW1lbnQuRnJvemVuO1xuICBleGl0OiBFeGl0UmVxdWlyZW1lbnRzO1xuICBsYWJlbD86IChyb206IFJvbSkgPT4gc3RyaW5nO1xufVxuXG5leHBvcnQgbmFtZXNwYWNlIFRlcnJhaW4ge1xuICAvLyBCdWlsdC1pbiB0ZXJyYWluIGJpdHNcbiAgLy8gMHgwMSA9PiBwaXRcbiAgZXhwb3J0IGNvbnN0IEZMWSA9IDB4MDI7XG4gIGV4cG9ydCBjb25zdCBCTE9DS0VEID0gMHgwNDtcbiAgLy8gMHgwOCA9PiBmbGFnIGFsdGVybmF0ZVxuICAvLyAweDEwID0+IGJlaGluZFxuICBleHBvcnQgY29uc3QgU0xPUEUgPSAweDIwO1xuICAvLyAweDQwID0+IHNsb3dcbiAgZXhwb3J0IGNvbnN0IFBBSU4gPSAweDgwO1xuICBleHBvcnQgY29uc3QgQklUUyA9IDB4YTY7XG5cbiAgLy8gQ3VzdG9tIHRlcnJhaW4gYml0c1xuICBleHBvcnQgY29uc3QgU1dBTVAgPSAweDEwMDtcbiAgZXhwb3J0IGNvbnN0IEJBUlJJRVIgPSAweDIwMDsgLy8gc2hvb3Rpbmcgc3RhdHVlc1xuICAvLyBzbG9wZSAwLi41ID0+IG5vIHJlcXVpcmVtZW50c1xuICBleHBvcnQgY29uc3QgU0xPUEU4ID0gMHg0MDA7IC8vIHNsb3BlIDYuLjhcbiAgZXhwb3J0IGNvbnN0IFNMT1BFOSA9IDB4ODAwOyAvLyBzbG9wdCA5XG4gIC8vIHNsb3BlIDEwKyA9PiBmbGlnaHQgb25seVxuICBleHBvcnQgY29uc3QgRE9MUEhJTiA9IDB4MTAwMDtcblxuICBleHBvcnQgZnVuY3Rpb24gbGFiZWwodDogVGVycmFpbiwgcm9tOiBSb20pIHtcbiAgICByZXR1cm4gdC5sYWJlbD8uKHJvbSkgPz8gJ1RlcnJhaW4nO1xuICB9XG59XG5cbmNsYXNzIFNlYW1sZXNzVGVycmFpbiBpbXBsZW1lbnRzIFRlcnJhaW4ge1xuICByZWFkb25seSBlbnRlcjogUmVxdWlyZW1lbnQuRnJvemVuO1xuICByZWFkb25seSBleGl0OiBFeGl0UmVxdWlyZW1lbnRzO1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBfZGVsZWdhdGU6IFRlcnJhaW4pIHtcbiAgICB0aGlzLmVudGVyID0gX2RlbGVnYXRlLmVudGVyO1xuICAgIHRoaXMuZXhpdCA9IF9kZWxlZ2F0ZS5leGl0O1xuICB9XG5cbiAgbGFiZWwocm9tOiBSb20pIHtcbiAgICByZXR1cm4gYFNlYW1sZXNzKCR7VGVycmFpbi5sYWJlbCh0aGlzLl9kZWxlZ2F0ZSwgcm9tKX0pYDtcbiAgfVxufVxuXG4vLyBCYXNpYyB0ZXJyYWluIHdpdGggYW4gZW50cmFuY2UgYW5kL29yIHVuZGlyZWN0ZWQgZXhpdCBjb25kaXRpb25cbmNsYXNzIFNpbXBsZVRlcnJhaW4gaW1wbGVtZW50cyBUZXJyYWluIHtcbiAgcmVhZG9ubHkgZXhpdDogRXhpdFJlcXVpcmVtZW50cztcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgZW50ZXI6IFJlcXVpcmVtZW50LkZyb3plbixcbiAgICAgICAgICAgICAgZXhpdDogUmVxdWlyZW1lbnQuRnJvemVuID0gUmVxdWlyZW1lbnQuT1BFTikge1xuICAgIHRoaXMuZXhpdCA9IFtbMHhmLCBleGl0XV07XG4gIH1cblxuICBnZXQga2luZCgpIHsgcmV0dXJuICdTaW1wbGUnOyB9XG5cbiAgbGFiZWwocm9tOiBSb20pIHtcbiAgICBjb25zdCB0ZXJyID0gW107XG4gICAgaWYgKCFSZXF1aXJlbWVudC5pc09wZW4odGhpcy5lbnRlcikpIHtcbiAgICAgIHRlcnIucHVzaChgZW50ZXIgPSAke2RlYnVnTGFiZWwodGhpcy5lbnRlciwgcm9tKX1gKTtcbiAgICB9XG4gICAgaWYgKCFSZXF1aXJlbWVudC5pc09wZW4odGhpcy5leGl0WzBdWzFdKSkge1xuICAgICAgdGVyci5wdXNoKGBleGl0ID0gJHtkZWJ1Z0xhYmVsKHRoaXMuZXhpdFswXVsxXSwgcm9tKX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGAke3RoaXMua2luZH0oJHt0ZXJyLmpvaW4oJywgJyl9KWA7XG4gIH1cbn1cblxuLy8gQmFzaWMgdGVycmFpbiB3aXRoIGFuIGVudHJhbmNlIGFuZC9vciBub24tc291dGggZXhpdCBjb25kaXRpb25cbmNsYXNzIFNvdXRoVGVycmFpbiBpbXBsZW1lbnRzIFRlcnJhaW4ge1xuICByZWFkb25seSBleGl0OiBFeGl0UmVxdWlyZW1lbnRzO1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBlbnRlcjogUmVxdWlyZW1lbnQuRnJvemVuLCBleGl0PzogUmVxdWlyZW1lbnQuRnJvemVuKSB7XG4gICAgdGhpcy5leGl0ID1cbiAgICAgICAgZXhpdCA/XG4gICAgICAgICAgICBbWzB4YiwgZXhpdF0sIFsweDQsIFJlcXVpcmVtZW50Lk9QRU5dXSA6XG4gICAgICAgICAgICBbWzB4ZiwgUmVxdWlyZW1lbnQuT1BFTl1dO1xuICB9XG5cbiAgZ2V0IGtpbmQoKSB7IHJldHVybiAnU291dGgnOyB9XG5cbiAgbGFiZWwocm9tOiBSb20pIHtcbiAgICBpZiAodGhpcy5leGl0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgcmV0dXJuIFNpbXBsZVRlcnJhaW4ucHJvdG90eXBlLmxhYmVsLmNhbGwodGhpcyBhcyBhbnksIHJvbSk7XG4gICAgfVxuICAgIGNvbnN0IHRlcnIgPSBbXTtcbiAgICBpZiAoIVJlcXVpcmVtZW50LmlzT3Blbih0aGlzLmVudGVyKSkge1xuICAgICAgdGVyci5wdXNoKGBlbnRlciA9ICR7ZGVidWdMYWJlbCh0aGlzLmVudGVyLCByb20pfWApO1xuICAgIH1cbiAgICBpZiAoIVJlcXVpcmVtZW50LmlzT3Blbih0aGlzLmV4aXRbMF1bMV0pKSB7XG4gICAgICB0ZXJyLnB1c2goYG90aGVyID0gJHtkZWJ1Z0xhYmVsKHRoaXMuZXhpdFswXVsxXSwgcm9tKX1gKTtcbiAgICB9XG4gICAgaWYgKCFSZXF1aXJlbWVudC5pc09wZW4odGhpcy5leGl0WzFdWzFdKSkge1xuICAgICAgdGVyci5wdXNoKGBzb3V0aCA9ICR7ZGVidWdMYWJlbCh0aGlzLmV4aXRbMV1bMV0sIHJvbSl9YCk7XG4gICAgfVxuICAgIHJldHVybiBgJHt0aGlzLmtpbmR9KCR7dGVyci5qb2luKCcsICcpfSlgO1xuICB9XG59XG5cbi8vIE1ha2UgYSB0ZXJyYWluIGZyb20gYSB0aWxlZWZmZWN0cyB2YWx1ZSwgYXVnbWVudGVkIHdpdGggYSBmZXcgZGV0YWlscy5cbmZ1bmN0aW9uIG1ha2VUaWxlKHJvbTogUm9tLCBlZmZlY3RzOiBudW1iZXIpOiBUZXJyYWluIHtcbiAgbGV0IGVudGVyID0gUmVxdWlyZW1lbnQuT1BFTjtcbiAgbGV0IGV4aXQgPSB1bmRlZmluZWQ7XG5cbiAgaWYgKChlZmZlY3RzICYgVGVycmFpbi5ET0xQSElOKSAmJiAoZWZmZWN0cyAmIFRlcnJhaW4uRkxZKSkge1xuICAgIGlmIChlZmZlY3RzICYgVGVycmFpbi5TTE9QRSkge1xuICAgICAgZXhpdCA9IHJvbS5mbGFncy5DbGltYldhdGVyZmFsbC5yO1xuICAgIH1cbiAgICBlbnRlciA9IFtbcm9tLmZsYWdzLkN1cnJlbnRseVJpZGluZ0RvbHBoaW4uY10sIFtyb20uZmxhZ3MuRmxpZ2h0LmNdXTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoZWZmZWN0cyAmIFRlcnJhaW4uU0xPUEU5KSB7XG4gICAgICBleGl0ID0gcm9tLmZsYWdzLkNsaW1iU2xvcGU5LnI7XG4gICAgfSBlbHNlIGlmIChlZmZlY3RzICYgVGVycmFpbi5TTE9QRTgpIHtcbiAgICAgIGV4aXQgPSByb20uZmxhZ3MuQ2xpbWJTbG9wZTgucjtcbiAgICB9IGVsc2UgaWYgKGVmZmVjdHMgJiBUZXJyYWluLlNMT1BFKSB7XG4gICAgICBleGl0ID0gcm9tLmZsYWdzLkNsaW1iU2xvcGUxMC5yO1xuICAgIH1cbiAgICBpZiAoZWZmZWN0cyAmIFRlcnJhaW4uRkxZKSBlbnRlciA9IHJvbS5mbGFncy5GbGlnaHQucjtcbiAgfVxuICBpZiAoZWZmZWN0cyAmIFRlcnJhaW4uU1dBTVApIHsgLy8gc3dhbXBcbiAgICBlbnRlciA9IGVudGVyLm1hcChcbiAgICAgICAgKGNzOiByZWFkb25seSBDb25kaXRpb25bXSkgPT4gW3JvbS5mbGFncy5UcmF2ZWxTd2FtcC5jLCAuLi5jc10pO1xuICB9XG4gIGlmIChlZmZlY3RzICYgVGVycmFpbi5QQUlOKSB7IC8vIHBhaW4gdGlsZXNcbiAgICBlbnRlciA9IGVudGVyLm1hcChcbiAgICAgICAgKGNzOiByZWFkb25seSBDb25kaXRpb25bXSkgPT4gW3JvbS5mbGFncy5Dcm9zc1BhaW4uYywgLi4uY3NdKTtcbiAgfVxuICBpZiAoZWZmZWN0cyAmIFRlcnJhaW4uQkFSUklFUikgeyAvLyBzaG9vdGluZyBzdGF0dWVzXG4gICAgZW50ZXIgPSBlbnRlci5tYXAoXG4gICAgICAgIChjczogcmVhZG9ubHkgQ29uZGl0aW9uW10pID0+IFtyb20uZmxhZ3MuU2hvb3RpbmdTdGF0dWUuYywgLi4uY3NdKTtcbiAgfVxuICByZXR1cm4gbmV3IFNvdXRoVGVycmFpbihlbnRlciwgZXhpdCk7XG59XG5cbi8vIEJvc3NlcyBjYW4gYmUgZW50ZXJlZCBmb3IgZnJlZSBidXQgb25seSBleGl0ZWQgYnkga2lsbGluZyB0aGUgYm9zcy5cbmNsYXNzIEJvc3NUZXJyYWluIGV4dGVuZHMgU2ltcGxlVGVycmFpbiB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IF9mbGFnOiBudW1iZXIpIHtcbiAgICBzdXBlcihSZXF1aXJlbWVudC5PUEVOLCBbW19mbGFnIGFzIENvbmRpdGlvbl1dKTtcbiAgfVxuXG4gIGdldCBraW5kKCkgeyByZXR1cm4gJ0Jvc3MnOyB9XG59XG5cbmNsYXNzIFN0YXR1ZVRlcnJhaW4gZXh0ZW5kcyBTb3V0aFRlcnJhaW4ge1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBfcmVxOiBSZXF1aXJlbWVudC5Gcm96ZW4pIHtcbiAgICBzdXBlcihSZXF1aXJlbWVudC5PUEVOLCBfcmVxKTtcbiAgfVxuXG4gIGdldCBraW5kKCkgeyByZXR1cm4gJ1N0YXR1ZSc7IH1cbn1cblxuLy8gUmFnZSBjYW4gYmUgYWx3YXlzIGJlIGV4aXRlZCBzb3V0aCwgYnV0IGNhbiBhbHNvIGJlIGV4aXRlZCBub3J0aFxuLy8gaWYgUmFnZSBza2lwIGlzIGFjdGl2ZS5cbmNsYXNzIFJhZ2VUZXJyYWluIGltcGxlbWVudHMgVGVycmFpbiB7XG4gIHJlYWRvbmx5IGVudGVyID0gUmVxdWlyZW1lbnQuT1BFTjtcbiAgcmVhZG9ubHkgZXhpdDogRXhpdFJlcXVpcmVtZW50cztcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgX3JhZ2VGbGFnOiBudW1iZXIsIHJlYWRvbmx5IF9yYWdlU2tpcEZsYWc6IG51bWJlcikge1xuICAgIHRoaXMuZXhpdCA9XG4gICAgICBbWzB4YiwgW1tfcmFnZUZsYWcgYXMgQ29uZGl0aW9uXSwgW19yYWdlU2tpcEZsYWcgYXMgQ29uZGl0aW9uXV1dLFxuICAgICAgIFsweDQsIFJlcXVpcmVtZW50Lk9QRU5dXTtcbiAgfVxuXG4gIGxhYmVsKCkgeyByZXR1cm4gYFJhZ2VgOyB9XG59XG5cbmNsYXNzIEZsYWdUZXJyYWluIGV4dGVuZHMgU2ltcGxlVGVycmFpbiB7XG4gIGNvbnN0cnVjdG9yKGJhc2U6IFRlcnJhaW4sIGZsYWc6IG51bWJlciwgYWx0OiBUZXJyYWluKSB7XG4gICAgLy8gTk9URTogYmFzZSBhbmQgYWx0IG11c3QgYm90aCBiZSBzaW1wbGUgdGVycmFpbnMhXG4gICAgLy8gSWYgZmxhZyBpcyAtMSB0aGVuIGRvbid0IGNvbnNpZGVyIGl0IChpdCdzIHVudHJhY2tlZCkuXG4gICAgaWYgKGJhc2UuZXhpdC5sZW5ndGggIT09IDEgfHwgYWx0LmV4aXQubGVuZ3RoICE9PSAxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JhZCBmbGFnJyk7XG4gICAgfVxuICAgIGNvbnN0IGYgPSBbW2ZsYWcgYXMgQ29uZGl0aW9uXV07XG4gICAgY29uc3QgZW50ZXIgPSBmbGFnID49IDAgPyBSZXF1aXJlbWVudC5tZWV0KGFsdC5lbnRlciwgZikgOiBhbHQuZW50ZXI7XG4gICAgY29uc3QgZXhpdCA9XG4gICAgICAgIGZsYWcgPj0gMCA/IFJlcXVpcmVtZW50Lm1lZXQoYWx0LmV4aXRbMF1bMV0sIGYpIDogYWx0LmV4aXRbMF1bMV07XG4gICAgc3VwZXIoUmVxdWlyZW1lbnQub3IoYmFzZS5lbnRlciwgZW50ZXIpLFxuICAgICAgICAgIFJlcXVpcmVtZW50Lm9yKGJhc2UuZXhpdFswXVsxXSwgZXhpdCkpO1xuICB9XG5cbiAgZ2V0IGtpbmQoKSB7IHJldHVybiAnRmxhZyc7IH1cbn1cbmNvbnN0IENMT1NFRCA9IG5ldyBTaW1wbGVUZXJyYWluKFJlcXVpcmVtZW50LkNMT1NFRCwgUmVxdWlyZW1lbnQuQ0xPU0VEKTtcblxuLyoqIFJldHVybnMgYSBtYXAgZnJvbSBEaXIgdG8gaW5kZXggaW4gdGhlIGV4aXQgbWFwLiAqL1xuZnVuY3Rpb24gZGlyZWN0aW9uSW5kZXgodDogVGVycmFpbik6IG51bWJlcltdIHtcbiAgY29uc3QgaW5kOiBudW1iZXJbXSA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHQuZXhpdC5sZW5ndGg7IGkrKykge1xuICAgIGZvciAobGV0IGIgPSAwOyBiIDwgNDsgYisrKSB7XG4gICAgICBpZiAodC5leGl0W2ldWzBdICYgKDEgPDwgYikpIGluZFtiXSA9IGk7XG4gICAgfVxuICB9XG4gIGZvciAobGV0IGIgPSAwOyBiIDwgNDsgYisrKSB7IC8vIHNhbml0eSBjaGVja1xuICAgIGlmIChpbmRbYl0gPT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGVycmFpbjogJHt0LmV4aXQubWFwKGUgPT4gZVswXSkuam9pbignLCcpfWApO1xuICAgIH1cbiAgfVxuICByZXR1cm4gaW5kO1xufVxuXG5jbGFzcyBNZWV0VGVycmFpbiBpbXBsZW1lbnRzIFRlcnJhaW4ge1xuICByZWFkb25seSBlbnRlcjogUmVxdWlyZW1lbnQuRnJvemVuO1xuICByZWFkb25seSBleGl0OiBFeGl0UmVxdWlyZW1lbnRzO1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBsZWZ0OiBUZXJyYWluLCByZWFkb25seSByaWdodDogVGVycmFpbikge1xuICAgIC8vIFRoaXMgaXMgdHJpY2t5OiB3ZSBuZWVkIHRvIGZpZ3VyZSBvdXQgd2hpY2ggZXhpdHMgYXJlIGluIGNvbW1vbiBhbmRcbiAgICAvLyBub3QgcmVwZWF0IHdvcmsuICBTbyBidWlsZCB1cCBhIHJldmVyc2UgbWFwIG9mIGRpcmVjdGlvbi10by1pbmRleCxcbiAgICAvLyB0aGVuIGtlZXAgdHJhY2sgb2YgYWxsIHRoZSB1bmlxdWUgY29tYmluYXRpb25zLlxuICAgIGNvbnN0IGxlZnRJbmQgPSBkaXJlY3Rpb25JbmRleChsZWZ0KTtcbiAgICBjb25zdCByaWdodEluZCA9IGRpcmVjdGlvbkluZGV4KHJpZ2h0KTtcbiAgICBjb25zdCBzb3VyY2VzID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgY29uc3QgZXhpdDogQXJyYXk8cmVhZG9ubHkgW251bWJlciwgUmVxdWlyZW1lbnQuRnJvemVuXT4gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgc291cmNlcy5hZGQobGVmdEluZFtpXSA8PCAyIHwgcmlnaHRJbmRbaV0pO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKSB7XG4gICAgICBjb25zdCBbZDAsIHIwXSA9IGxlZnQuZXhpdFtzb3VyY2UgPj4gMl07XG4gICAgICBjb25zdCBbZDEsIHIxXSA9IHJpZ2h0LmV4aXRbc291cmNlICYgM107XG4gICAgICBleGl0LnB1c2goW2QwICYgZDEsIFJlcXVpcmVtZW50Lm1lZXQocjAsIHIxKV0pO1xuICAgIH1cbiAgICB0aGlzLmVudGVyID0gUmVxdWlyZW1lbnQubWVldChsZWZ0LmVudGVyLCByaWdodC5lbnRlcik7XG4gICAgdGhpcy5leGl0ID0gZXhpdDtcbiAgfVxuXG4gIGdldCBraW5kKCkgeyByZXR1cm4gJ1RlcnJhaW4nOyB9XG5cbiAgbGFiZWwocm9tOiBSb20pOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLmV4aXQubGVuZ3RoID09PSAxKSB7XG4gICAgICByZXR1cm4gU2ltcGxlVGVycmFpbi5wcm90b3R5cGUubGFiZWwuY2FsbCh0aGlzIGFzIGFueSwgcm9tKTtcbiAgICB9XG4gICAgY29uc3QgdGVyciA9IFtdO1xuICAgIGlmICghUmVxdWlyZW1lbnQuaXNPcGVuKHRoaXMuZW50ZXIpKSB7XG4gICAgICB0ZXJyLnB1c2goYGVudGVyID0gJHtkZWJ1Z0xhYmVsKHRoaXMuZW50ZXIsIHJvbSl9YCk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgW2RpcnMsIHJlcV0gb2YgdGhpcy5leGl0KSB7XG4gICAgICBjb25zdCBkaXJzdHJpbmcgPSBbZGlycyAmIDEgPyAnTicgOiAnJywgZGlycyAmIDIgPyAnVycgOiAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICBkaXJzICYgNCA/ICdTJyA6ICcnLCBkaXJzICYgOCA/ICdFJyA6ICcnXS5qb2luKCcnKTtcbiAgICAgIHRlcnIucHVzaChgZXhpdCR7ZGlyc3RyaW5nfSA9ICR7ZGVidWdMYWJlbChyZXEsIHJvbSl9YCk7XG4gICAgfVxuICAgIHJldHVybiBgJHt0aGlzLmtpbmR9KCR7dGVyci5qb2luKCcsICcpfSlgO1xuICB9XG59XG5cbi8vIE5PVEU6IHRoaXMga2luZCBvZiB3YW50cyB0byBiZSBpbiBSZXF1aXJlbWVudCwgYnV0IGl0J3Mgcm9tLXNwZWNpZmljLi4uXG5leHBvcnQgZnVuY3Rpb24gZGVidWdMYWJlbChyOiBSZXF1aXJlbWVudCwgcm9tOiBSb20pOiBzdHJpbmcge1xuICBjb25zdCBjc3MgPSBbLi4ucl07XG4gIGNvbnN0IHMgPSBjc3MubWFwKGNzID0+IGl0ZXJzLmlzRW1wdHkoY3MpID8gJ29wZW4nIDpcbiAgICAgICAgICAgICAgICAgICAgWy4uLmNzXS5tYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAoYzogQ29uZGl0aW9uKSA9PiByb20uZmxhZ3NbY10/LmRlYnVnKS5qb2luKCcgJiAnKSlcbiAgICAgIC5qb2luKCcpIHwgKCcpO1xuICByZXR1cm4gY3NzLmxlbmd0aCA+IDEgPyBgKCR7c30pYCA6IGNzcy5sZW5ndGggPyBzIDogJ25ldmVyJztcbn1cblxuKFRlcnJhaW4gYXMgYW55KS5kZWJ1Z0xhYmVsID0gZGVidWdMYWJlbDtcbmlmICh0eXBlb2Ygd2luZG93ID09PSAnb2JqZWN0JykgKHdpbmRvdyBhcyBhbnkpLmRlYnVnTGFiZWwgPSBkZWJ1Z0xhYmVsO1xuIl19