import { DefaultMap, iters } from '../util.js';
import { Requirement } from './requirement.js';
export class Terrains {
    constructor(rom) {
        this.rom = rom;
        this.tiles = new DefaultMap((effects) => makeTile(this.rom, effects));
        this.bosses = new DefaultMap((flag) => new BossTerrain(flag));
        this.statues = new Map();
        this.flags = new DefaultMap((base) => new DefaultMap((flag) => new DefaultMap((alt) => new FlagTerrain(base, flag, alt))));
        this.meets = new DefaultMap((left) => new DefaultMap((right) => new MeetTerrain(left, right)));
        this._seamless = new DefaultMap((t) => new SeamlessTerrain(t));
    }
    tile(effects) {
        return effects & 0x04 ? undefined : this.tiles.get(effects);
    }
    boss(flag) {
        return this.bosses.get(flag);
    }
    statue(req) {
        const label = Requirement.label(req);
        let terrain = this.statues.get(label);
        if (!terrain)
            this.statues.set(label, terrain = new StatueTerrain(req));
        return terrain;
    }
    flag(base, flag, alt) {
        if (!base)
            base = CLOSED;
        return this.flags.get(base).get(flag).get(alt);
    }
    meet(left, right) {
        return this.meets.get(left).get(right);
    }
    seamless(delegate) {
        return this._seamless.get(delegate);
    }
    label(terrain, rom) {
        if (terrain.label)
            return terrain.label(rom);
        return 'Terrain';
    }
}
export var Terrain;
(function (Terrain) {
    Terrain.FLY = 0x02;
    Terrain.BLOCKED = 0x04;
    Terrain.SLOPE = 0x20;
    Terrain.PAIN = 0x80;
    Terrain.BITS = 0xa6;
    Terrain.SWAMP = 0x100;
    Terrain.BARRIER = 0x200;
    Terrain.SLOPE8 = 0x400;
    Terrain.SLOPE9 = 0x800;
    Terrain.DOLPHIN = 0x1000;
    function label(t, rom) {
        var _a, _b;
        return (_b = (_a = t.label) === null || _a === void 0 ? void 0 : _a.call(t, rom)) !== null && _b !== void 0 ? _b : 'Terrain';
    }
    Terrain.label = label;
})(Terrain || (Terrain = {}));
class SeamlessTerrain {
    constructor(_delegate) {
        this._delegate = _delegate;
        this.enter = _delegate.enter;
        this.exit = _delegate.exit;
    }
    label(rom) {
        return `Seamless(${Terrain.label(this._delegate, rom)})`;
    }
}
class SimpleTerrain {
    constructor(enter, exit = Requirement.OPEN) {
        this.enter = enter;
        this.exit = [[0xf, exit]];
    }
    get kind() { return 'Simple'; }
    label(rom) {
        const terr = [];
        if (!Requirement.isOpen(this.enter)) {
            terr.push(`enter = ${debugLabel(this.enter, rom)}`);
        }
        if (!Requirement.isOpen(this.exit[0][1])) {
            terr.push(`exit = ${debugLabel(this.exit[0][1], rom)}`);
        }
        return `${this.kind}(${terr.join(', ')})`;
    }
}
class SouthTerrain {
    constructor(enter, exit) {
        this.enter = enter;
        this.exit =
            exit ?
                [[0xb, exit], [0x4, Requirement.OPEN]] :
                [[0xf, Requirement.OPEN]];
    }
    get kind() { return 'South'; }
    label(rom) {
        if (this.exit.length === 1) {
            return SimpleTerrain.prototype.label.call(this, rom);
        }
        const terr = [];
        if (!Requirement.isOpen(this.enter)) {
            terr.push(`enter = ${debugLabel(this.enter, rom)}`);
        }
        if (!Requirement.isOpen(this.exit[0][1])) {
            terr.push(`other = ${debugLabel(this.exit[0][1], rom)}`);
        }
        if (!Requirement.isOpen(this.exit[1][1])) {
            terr.push(`south = ${debugLabel(this.exit[1][1], rom)}`);
        }
        return `${this.kind}(${terr.join(', ')})`;
    }
}
function makeTile(rom, effects) {
    let enter = Requirement.OPEN;
    let exit = undefined;
    if ((effects & Terrain.DOLPHIN) && (effects & Terrain.FLY)) {
        if (effects & Terrain.SLOPE) {
            exit = rom.flags.ClimbWaterfall.r;
        }
        enter = [[rom.flags.CurrentlyRidingDolphin.c], [rom.flags.Flight.c]];
    }
    else {
        if (effects & Terrain.SLOPE9) {
            exit = rom.flags.ClimbSlope9.r;
        }
        else if (effects & Terrain.SLOPE8) {
            exit = rom.flags.ClimbSlope8.r;
        }
        else if (effects & Terrain.SLOPE) {
            exit = rom.flags.Flight.r;
        }
        if (effects & Terrain.FLY)
            enter = rom.flags.Flight.r;
    }
    if (effects & Terrain.SWAMP) {
        enter = enter.map((cs) => [rom.flags.TravelSwamp.c, ...cs]);
    }
    if (effects & Terrain.PAIN) {
        enter = enter.map((cs) => [rom.flags.CrossPain.c, ...cs]);
    }
    if (effects & Terrain.BARRIER) {
        enter = enter.map((cs) => [rom.flags.ShootingStatue.c, ...cs]);
    }
    return new SouthTerrain(enter, exit);
}
class BossTerrain extends SimpleTerrain {
    constructor(_flag) {
        super(Requirement.OPEN, [[_flag]]);
        this._flag = _flag;
    }
    get kind() { return 'Boss'; }
}
class StatueTerrain extends SouthTerrain {
    constructor(_req) {
        super(Requirement.OPEN, _req);
        this._req = _req;
    }
    get kind() { return 'Statue'; }
}
class FlagTerrain extends SimpleTerrain {
    constructor(base, flag, alt) {
        if (base.exit.length !== 1 || alt.exit.length !== 1) {
            throw new Error('bad flag');
        }
        const f = [[flag]];
        const enter = flag >= 0 ? Requirement.meet(alt.enter, f) : alt.enter;
        const exit = flag >= 0 ? Requirement.meet(alt.exit[0][1], f) : alt.exit[0][1];
        super(Requirement.or(base.enter, enter), Requirement.or(base.exit[0][1], exit));
    }
    get kind() { return 'Flag'; }
}
const CLOSED = new SimpleTerrain(Requirement.CLOSED, Requirement.CLOSED);
function directionIndex(t) {
    const ind = [];
    for (let i = 0; i < t.exit.length; i++) {
        for (let b = 0; b < 4; b++) {
            if (t.exit[i][0] & (1 << b))
                ind[b] = i;
        }
    }
    for (let b = 0; b < 4; b++) {
        if (ind[b] == null) {
            throw new Error(`Bad terrain: ${t.exit.map(e => e[0]).join(',')}`);
        }
    }
    return ind;
}
class MeetTerrain {
    constructor(left, right) {
        this.left = left;
        this.right = right;
        const leftInd = directionIndex(left);
        const rightInd = directionIndex(right);
        const sources = new Set();
        const exit = [];
        for (let i = 0; i < 4; i++) {
            sources.add(leftInd[i] << 2 | rightInd[i]);
        }
        for (const source of sources) {
            const [d0, r0] = left.exit[source >> 2];
            const [d1, r1] = right.exit[source & 3];
            exit.push([d0 & d1, Requirement.meet(r0, r1)]);
        }
        this.enter = Requirement.meet(left.enter, right.enter);
        this.exit = exit;
    }
    get kind() { return 'Terrain'; }
    label(rom) {
        if (this.exit.length === 1) {
            return SimpleTerrain.prototype.label.call(this, rom);
        }
        const terr = [];
        if (!Requirement.isOpen(this.enter)) {
            terr.push(`enter = ${debugLabel(this.enter, rom)}`);
        }
        for (const [dirs, req] of this.exit) {
            const dirstring = [dirs & 1 ? 'N' : '', dirs & 2 ? 'W' : '',
                dirs & 4 ? 'S' : '', dirs & 8 ? 'E' : ''].join('');
            terr.push(`exit${dirstring} = ${debugLabel(req, rom)}`);
        }
        return `${this.kind}(${terr.join(', ')})`;
    }
}
export function debugLabel(r, rom) {
    const css = [...r];
    const s = css.map(cs => iters.isEmpty(cs) ? 'open' :
        [...cs].map((c) => { var _a; return (_a = rom.flags[c]) === null || _a === void 0 ? void 0 : _a.debug; }).join(' & '))
        .join(') | (');
    return css.length > 1 ? `(${s})` : css.length ? s : 'never';
}
Terrain.debugLabel = debugLabel;
if (typeof window === 'object')
    window.debugLabel = debugLabel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9sb2dpYy90ZXJyYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxVQUFVLEVBQUUsS0FBSyxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBQzdDLE9BQU8sRUFBWSxXQUFXLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUV4RCxNQUFNLE9BQU8sUUFBUTtJQXNCbkIsWUFBcUIsR0FBUTtRQUFSLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFsQlosVUFBSyxHQUNsQixJQUFJLFVBQVUsQ0FDVixDQUFDLE9BQWUsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUN6QyxXQUFNLEdBQ25CLElBQUksVUFBVSxDQUFrQixDQUFDLElBQVksRUFBRSxFQUFFLENBQUMsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM1RCxZQUFPLEdBQUcsSUFBSSxHQUFHLEVBQW1CLENBQUM7UUFDckMsVUFBSyxHQUNsQixJQUFJLFVBQVUsQ0FDVixDQUFDLElBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxVQUFVLENBQzdCLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FBQyxJQUFJLFVBQVUsQ0FDNUIsQ0FBQyxHQUFZLEVBQUUsRUFBRSxDQUFDLElBQUksV0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckQsVUFBSyxHQUNsQixJQUFJLFVBQVUsQ0FDVixDQUFDLElBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxVQUFVLENBQzdCLENBQUMsS0FBYyxFQUFFLEVBQUUsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlDLGNBQVMsR0FDdEIsSUFBSSxVQUFVLENBQW1CLENB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QUcsQ0FBQyxDQUFDLENBQUM7SUFDbkIsTUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQ1AsQ0FBQyxDQUFZLEVBQUUsRUFBRSx3QkFBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQywwQ0FBRSxLQUFLLEdBQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNwRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbkIsT0FBTyxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDOUQsQ0FBQztBQUVBLE9BQWUsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0FBQ3pDLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUTtJQUFHLE1BQWMsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSb219IGZyb20gJy4uL3JvbS5qcyc7XG5pbXBvcnQge0RlZmF1bHRNYXAsIGl0ZXJzfSBmcm9tICcuLi91dGlsLmpzJztcbmltcG9ydCB7Q29uZGl0aW9uLCBSZXF1aXJlbWVudH0gZnJvbSAnLi9yZXF1aXJlbWVudC5qcyc7XG5cbmV4cG9ydCBjbGFzcyBUZXJyYWlucyB7XG5cbiAgLy8gQWdncmVzc2l2ZSBtZW1vaXphdGlvbiBwcmV2ZW50cyBpbnN0YW50aWF0aW5nIHRoZSBzYW1lIHRlcnJhaW4gdHdpY2UuXG4gIC8vIFRoaXMgYWxsb3dzIHJlZmVyZW5jZSBlcXVhbGl0eSB0byB0ZWxsIHdoZW4gdHdvIHRlcnJhaW5zIGFyZSB0aGUgc2FtZS5cbiAgcHJpdmF0ZSByZWFkb25seSB0aWxlcyA9XG4gICAgICBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIFRlcnJhaW4+KFxuICAgICAgICAgIChlZmZlY3RzOiBudW1iZXIpID0+IG1ha2VUaWxlKHRoaXMucm9tLCBlZmZlY3RzKSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgYm9zc2VzID1cbiAgICAgIG5ldyBEZWZhdWx0TWFwPG51bWJlciwgVGVycmFpbj4oKGZsYWc6IG51bWJlcikgPT4gbmV3IEJvc3NUZXJyYWluKGZsYWcpKTtcbiAgcHJpdmF0ZSByZWFkb25seSBzdGF0dWVzID0gbmV3IE1hcDxzdHJpbmcsIFRlcnJhaW4+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZmxhZ3MgPVxuICAgICAgbmV3IERlZmF1bHRNYXA8VGVycmFpbiwgRGVmYXVsdE1hcDxudW1iZXIsIERlZmF1bHRNYXA8VGVycmFpbiwgVGVycmFpbj4+PihcbiAgICAgICAgICAoYmFzZTogVGVycmFpbikgPT4gbmV3IERlZmF1bHRNYXAoXG4gICAgICAgICAgICAgIChmbGFnOiBudW1iZXIpID0+IG5ldyBEZWZhdWx0TWFwKFxuICAgICAgICAgICAgICAgICAgKGFsdDogVGVycmFpbikgPT4gbmV3IEZsYWdUZXJyYWluKGJhc2UsIGZsYWcsIGFsdCkpKSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWVldHMgPVxuICAgICAgbmV3IERlZmF1bHRNYXA8VGVycmFpbiwgRGVmYXVsdE1hcDxUZXJyYWluLCBUZXJyYWluPj4oXG4gICAgICAgICAgKGxlZnQ6IFRlcnJhaW4pID0+IG5ldyBEZWZhdWx0TWFwKFxuICAgICAgICAgICAgICAocmlnaHQ6IFRlcnJhaW4pID0+IG5ldyBNZWV0VGVycmFpbihsZWZ0LCByaWdodCkpKTtcbiAgcHJpdmF0ZSByZWFkb25seSBfc2VhbWxlc3MgPVxuICAgICAgbmV3IERlZmF1bHRNYXA8VGVycmFpbiwgVGVycmFpbj4oKHQ6IFRlcnJhaW4pID0+IG5ldyBTZWFtbGVzc1RlcnJhaW4odCkpO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJvbTogUm9tKSB7fVxuXG4gIHRpbGUoZWZmZWN0czogbnVtYmVyKTogVGVycmFpbnx1bmRlZmluZWQge1xuICAgIHJldHVybiBlZmZlY3RzICYgMHgwNCA/IHVuZGVmaW5lZCA6IHRoaXMudGlsZXMuZ2V0KGVmZmVjdHMpO1xuICB9XG5cbiAgYm9zcyhmbGFnOiBudW1iZXIpOiBUZXJyYWluIHtcbiAgICByZXR1cm4gdGhpcy5ib3NzZXMuZ2V0KGZsYWcpO1xuICB9XG5cbiAgLy8gTk9URTogYWxzbyB1c2VkIGZvciB0cmlnZ2Vyc1xuICBzdGF0dWUocmVxOiBSZXF1aXJlbWVudC5Gcm96ZW4pOiBUZXJyYWluIHtcbiAgICBjb25zdCBsYWJlbCA9IFJlcXVpcmVtZW50LmxhYmVsKHJlcSk7XG4gICAgbGV0IHRlcnJhaW4gPSB0aGlzLnN0YXR1ZXMuZ2V0KGxhYmVsKTtcbiAgICBpZiAoIXRlcnJhaW4pIHRoaXMuc3RhdHVlcy5zZXQobGFiZWwsIHRlcnJhaW4gPSBuZXcgU3RhdHVlVGVycmFpbihyZXEpKTtcbiAgICByZXR1cm4gdGVycmFpbiE7XG4gIH1cblxuICBmbGFnKGJhc2U6IFRlcnJhaW58dW5kZWZpbmVkLCBmbGFnOiBudW1iZXIsIGFsdDogVGVycmFpbik6IFRlcnJhaW4ge1xuICAgIGlmICghYmFzZSkgYmFzZSA9IENMT1NFRDtcbiAgICByZXR1cm4gdGhpcy5mbGFncy5nZXQoYmFzZSkuZ2V0KGZsYWcpLmdldChhbHQpO1xuICB9XG5cbiAgbWVldChsZWZ0OiBUZXJyYWluLCByaWdodDogVGVycmFpbik6IFRlcnJhaW4ge1xuICAgIC8vIFRPRE8gLSBtZW1vaXplIHByb3Blcmx5PyAgb25seSBhbGxvdyB0d28/XG4gICAgcmV0dXJuIHRoaXMubWVldHMuZ2V0KGxlZnQpLmdldChyaWdodCk7XG4gIH1cblxuICBzZWFtbGVzcyhkZWxlZ2F0ZTogVGVycmFpbikge1xuICAgIHJldHVybiB0aGlzLl9zZWFtbGVzcy5nZXQoZGVsZWdhdGUpO1xuICB9XG5cbiAgbGFiZWwodGVycmFpbjogVGVycmFpbiwgcm9tOiBSb20pIHtcbiAgICBpZiAodGVycmFpbi5sYWJlbCkgcmV0dXJuIHRlcnJhaW4ubGFiZWwocm9tKTtcbiAgICByZXR1cm4gJ1RlcnJhaW4nO1xuICB9XG59XG5cbnR5cGUgRGlyTWFzayA9IG51bWJlcjtcbi8vIE5PVEU6IG1pc3NpbmcgZGlyZWN0aW9ucyBhcmUgZm9yYmlkZGVuLlxudHlwZSBFeGl0UmVxdWlyZW1lbnRzID0gUmVhZG9ubHlBcnJheTxyZWFkb25seSBbRGlyTWFzaywgUmVxdWlyZW1lbnQuRnJvemVuXT47XG5leHBvcnQgaW50ZXJmYWNlIFRlcnJhaW4ge1xuICBlbnRlcjogUmVxdWlyZW1lbnQuRnJvemVuO1xuICBleGl0OiBFeGl0UmVxdWlyZW1lbnRzO1xuICBsYWJlbD86IChyb206IFJvbSkgPT4gc3RyaW5nO1xufVxuXG5leHBvcnQgbmFtZXNwYWNlIFRlcnJhaW4ge1xuICAvLyBCdWlsdC1pbiB0ZXJyYWluIGJpdHNcbiAgLy8gMHgwMSA9PiBwaXRcbiAgZXhwb3J0IGNvbnN0IEZMWSA9IDB4MDI7XG4gIGV4cG9ydCBjb25zdCBCTE9DS0VEID0gMHgwNDtcbiAgLy8gMHgwOCA9PiBmbGFnIGFsdGVybmF0ZVxuICAvLyAweDEwID0+IGJlaGluZFxuICBleHBvcnQgY29uc3QgU0xPUEUgPSAweDIwO1xuICAvLyAweDQwID0+IHNsb3dcbiAgZXhwb3J0IGNvbnN0IFBBSU4gPSAweDgwO1xuICBleHBvcnQgY29uc3QgQklUUyA9IDB4YTY7XG5cbiAgLy8gQ3VzdG9tIHRlcnJhaW4gYml0c1xuICBleHBvcnQgY29uc3QgU1dBTVAgPSAweDEwMDtcbiAgZXhwb3J0IGNvbnN0IEJBUlJJRVIgPSAweDIwMDsgLy8gc2hvb3Rpbmcgc3RhdHVlc1xuICAvLyBzbG9wZSAwLi41ID0+IG5vIHJlcXVpcmVtZW50c1xuICBleHBvcnQgY29uc3QgU0xPUEU4ID0gMHg0MDA7IC8vIHNsb3BlIDYuLjhcbiAgZXhwb3J0IGNvbnN0IFNMT1BFOSA9IDB4ODAwOyAvLyBzbG9wdCA5XG4gIC8vIHNsb3BlIDEwKyA9PiBmbGlnaHQgb25seVxuICBleHBvcnQgY29uc3QgRE9MUEhJTiA9IDB4MTAwMDtcblxuICBleHBvcnQgZnVuY3Rpb24gbGFiZWwodDogVGVycmFpbiwgcm9tOiBSb20pIHtcbiAgICByZXR1cm4gdC5sYWJlbD8uKHJvbSkgPz8gJ1RlcnJhaW4nO1xuICB9XG59XG5cbmNsYXNzIFNlYW1sZXNzVGVycmFpbiBpbXBsZW1lbnRzIFRlcnJhaW4ge1xuICByZWFkb25seSBlbnRlcjogUmVxdWlyZW1lbnQuRnJvemVuO1xuICByZWFkb25seSBleGl0OiBFeGl0UmVxdWlyZW1lbnRzO1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBfZGVsZWdhdGU6IFRlcnJhaW4pIHtcbiAgICB0aGlzLmVudGVyID0gX2RlbGVnYXRlLmVudGVyO1xuICAgIHRoaXMuZXhpdCA9IF9kZWxlZ2F0ZS5leGl0O1xuICB9XG5cbiAgbGFiZWwocm9tOiBSb20pIHtcbiAgICByZXR1cm4gYFNlYW1sZXNzKCR7VGVycmFpbi5sYWJlbCh0aGlzLl9kZWxlZ2F0ZSwgcm9tKX0pYDtcbiAgfVxufVxuXG4vLyBCYXNpYyB0ZXJyYWluIHdpdGggYW4gZW50cmFuY2UgYW5kL29yIHVuZGlyZWN0ZWQgZXhpdCBjb25kaXRpb25cbmNsYXNzIFNpbXBsZVRlcnJhaW4gaW1wbGVtZW50cyBUZXJyYWluIHtcbiAgcmVhZG9ubHkgZXhpdDogRXhpdFJlcXVpcmVtZW50cztcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgZW50ZXI6IFJlcXVpcmVtZW50LkZyb3plbixcbiAgICAgICAgICAgICAgZXhpdDogUmVxdWlyZW1lbnQuRnJvemVuID0gUmVxdWlyZW1lbnQuT1BFTikge1xuICAgIHRoaXMuZXhpdCA9IFtbMHhmLCBleGl0XV07XG4gIH1cblxuICBnZXQga2luZCgpIHsgcmV0dXJuICdTaW1wbGUnOyB9XG5cbiAgbGFiZWwocm9tOiBSb20pIHtcbiAgICBjb25zdCB0ZXJyID0gW107XG4gICAgaWYgKCFSZXF1aXJlbWVudC5pc09wZW4odGhpcy5lbnRlcikpIHtcbiAgICAgIHRlcnIucHVzaChgZW50ZXIgPSAke2RlYnVnTGFiZWwodGhpcy5lbnRlciwgcm9tKX1gKTtcbiAgICB9XG4gICAgaWYgKCFSZXF1aXJlbWVudC5pc09wZW4odGhpcy5leGl0WzBdWzFdKSkge1xuICAgICAgdGVyci5wdXNoKGBleGl0ID0gJHtkZWJ1Z0xhYmVsKHRoaXMuZXhpdFswXVsxXSwgcm9tKX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGAke3RoaXMua2luZH0oJHt0ZXJyLmpvaW4oJywgJyl9KWA7XG4gIH1cbn1cblxuLy8gQmFzaWMgdGVycmFpbiB3aXRoIGFuIGVudHJhbmNlIGFuZC9vciBub24tc291dGggZXhpdCBjb25kaXRpb25cbmNsYXNzIFNvdXRoVGVycmFpbiBpbXBsZW1lbnRzIFRlcnJhaW4ge1xuICByZWFkb25seSBleGl0OiBFeGl0UmVxdWlyZW1lbnRzO1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBlbnRlcjogUmVxdWlyZW1lbnQuRnJvemVuLCBleGl0PzogUmVxdWlyZW1lbnQuRnJvemVuKSB7XG4gICAgdGhpcy5leGl0ID1cbiAgICAgICAgZXhpdCA/XG4gICAgICAgICAgICBbWzB4YiwgZXhpdF0sIFsweDQsIFJlcXVpcmVtZW50Lk9QRU5dXSA6XG4gICAgICAgICAgICBbWzB4ZiwgUmVxdWlyZW1lbnQuT1BFTl1dO1xuICB9XG5cbiAgZ2V0IGtpbmQoKSB7IHJldHVybiAnU291dGgnOyB9XG5cbiAgbGFiZWwocm9tOiBSb20pIHtcbiAgICBpZiAodGhpcy5leGl0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgcmV0dXJuIFNpbXBsZVRlcnJhaW4ucHJvdG90eXBlLmxhYmVsLmNhbGwodGhpcyBhcyBhbnksIHJvbSk7XG4gICAgfVxuICAgIGNvbnN0IHRlcnIgPSBbXTtcbiAgICBpZiAoIVJlcXVpcmVtZW50LmlzT3Blbih0aGlzLmVudGVyKSkge1xuICAgICAgdGVyci5wdXNoKGBlbnRlciA9ICR7ZGVidWdMYWJlbCh0aGlzLmVudGVyLCByb20pfWApO1xuICAgIH1cbiAgICBpZiAoIVJlcXVpcmVtZW50LmlzT3Blbih0aGlzLmV4aXRbMF1bMV0pKSB7XG4gICAgICB0ZXJyLnB1c2goYG90aGVyID0gJHtkZWJ1Z0xhYmVsKHRoaXMuZXhpdFswXVsxXSwgcm9tKX1gKTtcbiAgICB9XG4gICAgaWYgKCFSZXF1aXJlbWVudC5pc09wZW4odGhpcy5leGl0WzFdWzFdKSkge1xuICAgICAgdGVyci5wdXNoKGBzb3V0aCA9ICR7ZGVidWdMYWJlbCh0aGlzLmV4aXRbMV1bMV0sIHJvbSl9YCk7XG4gICAgfVxuICAgIHJldHVybiBgJHt0aGlzLmtpbmR9KCR7dGVyci5qb2luKCcsICcpfSlgO1xuICB9XG59XG5cbi8vIE1ha2UgYSB0ZXJyYWluIGZyb20gYSB0aWxlZWZmZWN0cyB2YWx1ZSwgYXVnbWVudGVkIHdpdGggYSBmZXcgZGV0YWlscy5cbmZ1bmN0aW9uIG1ha2VUaWxlKHJvbTogUm9tLCBlZmZlY3RzOiBudW1iZXIpOiBUZXJyYWluIHtcbiAgbGV0IGVudGVyID0gUmVxdWlyZW1lbnQuT1BFTjtcbiAgbGV0IGV4aXQgPSB1bmRlZmluZWQ7XG5cbiAgaWYgKChlZmZlY3RzICYgVGVycmFpbi5ET0xQSElOKSAmJiAoZWZmZWN0cyAmIFRlcnJhaW4uRkxZKSkge1xuICAgIGlmIChlZmZlY3RzICYgVGVycmFpbi5TTE9QRSkge1xuICAgICAgZXhpdCA9IHJvbS5mbGFncy5DbGltYldhdGVyZmFsbC5yO1xuICAgIH1cbiAgICBlbnRlciA9IFtbcm9tLmZsYWdzLkN1cnJlbnRseVJpZGluZ0RvbHBoaW4uY10sIFtyb20uZmxhZ3MuRmxpZ2h0LmNdXTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoZWZmZWN0cyAmIFRlcnJhaW4uU0xPUEU5KSB7XG4gICAgICBleGl0ID0gcm9tLmZsYWdzLkNsaW1iU2xvcGU5LnI7XG4gICAgfSBlbHNlIGlmIChlZmZlY3RzICYgVGVycmFpbi5TTE9QRTgpIHtcbiAgICAgIGV4aXQgPSByb20uZmxhZ3MuQ2xpbWJTbG9wZTgucjtcbiAgICB9IGVsc2UgaWYgKGVmZmVjdHMgJiBUZXJyYWluLlNMT1BFKSB7XG4gICAgICBleGl0ID0gcm9tLmZsYWdzLkZsaWdodC5yO1xuICAgIH1cbiAgICBpZiAoZWZmZWN0cyAmIFRlcnJhaW4uRkxZKSBlbnRlciA9IHJvbS5mbGFncy5GbGlnaHQucjtcbiAgfVxuICBpZiAoZWZmZWN0cyAmIFRlcnJhaW4uU1dBTVApIHsgLy8gc3dhbXBcbiAgICBlbnRlciA9IGVudGVyLm1hcChcbiAgICAgICAgKGNzOiByZWFkb25seSBDb25kaXRpb25bXSkgPT4gW3JvbS5mbGFncy5UcmF2ZWxTd2FtcC5jLCAuLi5jc10pO1xuICB9XG4gIGlmIChlZmZlY3RzICYgVGVycmFpbi5QQUlOKSB7IC8vIHBhaW4gdGlsZXNcbiAgICBlbnRlciA9IGVudGVyLm1hcChcbiAgICAgICAgKGNzOiByZWFkb25seSBDb25kaXRpb25bXSkgPT4gW3JvbS5mbGFncy5Dcm9zc1BhaW4uYywgLi4uY3NdKTtcbiAgfVxuICBpZiAoZWZmZWN0cyAmIFRlcnJhaW4uQkFSUklFUikgeyAvLyBzaG9vdGluZyBzdGF0dWVzXG4gICAgZW50ZXIgPSBlbnRlci5tYXAoXG4gICAgICAgIChjczogcmVhZG9ubHkgQ29uZGl0aW9uW10pID0+IFtyb20uZmxhZ3MuU2hvb3RpbmdTdGF0dWUuYywgLi4uY3NdKTtcbiAgfVxuICByZXR1cm4gbmV3IFNvdXRoVGVycmFpbihlbnRlciwgZXhpdCk7XG59XG5cbmNsYXNzIEJvc3NUZXJyYWluIGV4dGVuZHMgU2ltcGxlVGVycmFpbiB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IF9mbGFnOiBudW1iZXIpIHtcbiAgICBzdXBlcihSZXF1aXJlbWVudC5PUEVOLCBbW19mbGFnIGFzIENvbmRpdGlvbl1dKTtcbiAgfVxuXG4gIGdldCBraW5kKCkgeyByZXR1cm4gJ0Jvc3MnOyB9XG59XG5cbmNsYXNzIFN0YXR1ZVRlcnJhaW4gZXh0ZW5kcyBTb3V0aFRlcnJhaW4ge1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBfcmVxOiBSZXF1aXJlbWVudC5Gcm96ZW4pIHtcbiAgICBzdXBlcihSZXF1aXJlbWVudC5PUEVOLCBfcmVxKTtcbiAgfVxuXG4gIGdldCBraW5kKCkgeyByZXR1cm4gJ1N0YXR1ZSc7IH1cbn1cblxuY2xhc3MgRmxhZ1RlcnJhaW4gZXh0ZW5kcyBTaW1wbGVUZXJyYWluIHtcbiAgY29uc3RydWN0b3IoYmFzZTogVGVycmFpbiwgZmxhZzogbnVtYmVyLCBhbHQ6IFRlcnJhaW4pIHtcbiAgICAvLyBOT1RFOiBiYXNlIGFuZCBhbHQgbXVzdCBib3RoIGJlIHNpbXBsZSB0ZXJyYWlucyFcbiAgICAvLyBJZiBmbGFnIGlzIC0xIHRoZW4gZG9uJ3QgY29uc2lkZXIgaXQgKGl0J3MgdW50cmFja2VkKS5cbiAgICBpZiAoYmFzZS5leGl0Lmxlbmd0aCAhPT0gMSB8fCBhbHQuZXhpdC5sZW5ndGggIT09IDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignYmFkIGZsYWcnKTtcbiAgICB9XG4gICAgY29uc3QgZiA9IFtbZmxhZyBhcyBDb25kaXRpb25dXTtcbiAgICBjb25zdCBlbnRlciA9IGZsYWcgPj0gMCA/IFJlcXVpcmVtZW50Lm1lZXQoYWx0LmVudGVyLCBmKSA6IGFsdC5lbnRlcjtcbiAgICBjb25zdCBleGl0ID1cbiAgICAgICAgZmxhZyA+PSAwID8gUmVxdWlyZW1lbnQubWVldChhbHQuZXhpdFswXVsxXSwgZikgOiBhbHQuZXhpdFswXVsxXTtcbiAgICBzdXBlcihSZXF1aXJlbWVudC5vcihiYXNlLmVudGVyLCBlbnRlciksXG4gICAgICAgICAgUmVxdWlyZW1lbnQub3IoYmFzZS5leGl0WzBdWzFdLCBleGl0KSk7XG4gIH1cblxuICBnZXQga2luZCgpIHsgcmV0dXJuICdGbGFnJzsgfVxufVxuY29uc3QgQ0xPU0VEID0gbmV3IFNpbXBsZVRlcnJhaW4oUmVxdWlyZW1lbnQuQ0xPU0VELCBSZXF1aXJlbWVudC5DTE9TRUQpO1xuXG4vKiogUmV0dXJucyBhIG1hcCBmcm9tIERpciB0byBpbmRleCBpbiB0aGUgZXhpdCBtYXAuICovXG5mdW5jdGlvbiBkaXJlY3Rpb25JbmRleCh0OiBUZXJyYWluKTogbnVtYmVyW10ge1xuICBjb25zdCBpbmQ6IG51bWJlcltdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdC5leGl0Lmxlbmd0aDsgaSsrKSB7XG4gICAgZm9yIChsZXQgYiA9IDA7IGIgPCA0OyBiKyspIHtcbiAgICAgIGlmICh0LmV4aXRbaV1bMF0gJiAoMSA8PCBiKSkgaW5kW2JdID0gaTtcbiAgICB9XG4gIH1cbiAgZm9yIChsZXQgYiA9IDA7IGIgPCA0OyBiKyspIHsgLy8gc2FuaXR5IGNoZWNrXG4gICAgaWYgKGluZFtiXSA9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0ZXJyYWluOiAke3QuZXhpdC5tYXAoZSA9PiBlWzBdKS5qb2luKCcsJyl9YCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBpbmQ7XG59XG5cbmNsYXNzIE1lZXRUZXJyYWluIGltcGxlbWVudHMgVGVycmFpbiB7XG4gIHJlYWRvbmx5IGVudGVyOiBSZXF1aXJlbWVudC5Gcm96ZW47XG4gIHJlYWRvbmx5IGV4aXQ6IEV4aXRSZXF1aXJlbWVudHM7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGxlZnQ6IFRlcnJhaW4sIHJlYWRvbmx5IHJpZ2h0OiBUZXJyYWluKSB7XG4gICAgLy8gVGhpcyBpcyB0cmlja3k6IHdlIG5lZWQgdG8gZmlndXJlIG91dCB3aGljaCBleGl0cyBhcmUgaW4gY29tbW9uIGFuZFxuICAgIC8vIG5vdCByZXBlYXQgd29yay4gIFNvIGJ1aWxkIHVwIGEgcmV2ZXJzZSBtYXAgb2YgZGlyZWN0aW9uLXRvLWluZGV4LFxuICAgIC8vIHRoZW4ga2VlcCB0cmFjayBvZiBhbGwgdGhlIHVuaXF1ZSBjb21iaW5hdGlvbnMuXG4gICAgY29uc3QgbGVmdEluZCA9IGRpcmVjdGlvbkluZGV4KGxlZnQpO1xuICAgIGNvbnN0IHJpZ2h0SW5kID0gZGlyZWN0aW9uSW5kZXgocmlnaHQpO1xuICAgIGNvbnN0IHNvdXJjZXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBjb25zdCBleGl0OiBBcnJheTxyZWFkb25seSBbbnVtYmVyLCBSZXF1aXJlbWVudC5Gcm96ZW5dPiA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICBzb3VyY2VzLmFkZChsZWZ0SW5kW2ldIDw8IDIgfCByaWdodEluZFtpXSk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qgc291cmNlIG9mIHNvdXJjZXMpIHtcbiAgICAgIGNvbnN0IFtkMCwgcjBdID0gbGVmdC5leGl0W3NvdXJjZSA+PiAyXTtcbiAgICAgIGNvbnN0IFtkMSwgcjFdID0gcmlnaHQuZXhpdFtzb3VyY2UgJiAzXTtcbiAgICAgIGV4aXQucHVzaChbZDAgJiBkMSwgUmVxdWlyZW1lbnQubWVldChyMCwgcjEpXSk7XG4gICAgfVxuICAgIHRoaXMuZW50ZXIgPSBSZXF1aXJlbWVudC5tZWV0KGxlZnQuZW50ZXIsIHJpZ2h0LmVudGVyKTtcbiAgICB0aGlzLmV4aXQgPSBleGl0O1xuICB9XG5cbiAgZ2V0IGtpbmQoKSB7IHJldHVybiAnVGVycmFpbic7IH1cblxuICBsYWJlbChyb206IFJvbSk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMuZXhpdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIHJldHVybiBTaW1wbGVUZXJyYWluLnByb3RvdHlwZS5sYWJlbC5jYWxsKHRoaXMgYXMgYW55LCByb20pO1xuICAgIH1cbiAgICBjb25zdCB0ZXJyID0gW107XG4gICAgaWYgKCFSZXF1aXJlbWVudC5pc09wZW4odGhpcy5lbnRlcikpIHtcbiAgICAgIHRlcnIucHVzaChgZW50ZXIgPSAke2RlYnVnTGFiZWwodGhpcy5lbnRlciwgcm9tKX1gKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBbZGlycywgcmVxXSBvZiB0aGlzLmV4aXQpIHtcbiAgICAgIGNvbnN0IGRpcnN0cmluZyA9IFtkaXJzICYgMSA/ICdOJyA6ICcnLCBkaXJzICYgMiA/ICdXJyA6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgIGRpcnMgJiA0ID8gJ1MnIDogJycsIGRpcnMgJiA4ID8gJ0UnIDogJyddLmpvaW4oJycpO1xuICAgICAgdGVyci5wdXNoKGBleGl0JHtkaXJzdHJpbmd9ID0gJHtkZWJ1Z0xhYmVsKHJlcSwgcm9tKX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGAke3RoaXMua2luZH0oJHt0ZXJyLmpvaW4oJywgJyl9KWA7XG4gIH1cbn1cblxuLy8gTk9URTogdGhpcyBraW5kIG9mIHdhbnRzIHRvIGJlIGluIFJlcXVpcmVtZW50LCBidXQgaXQncyByb20tc3BlY2lmaWMuLi5cbmV4cG9ydCBmdW5jdGlvbiBkZWJ1Z0xhYmVsKHI6IFJlcXVpcmVtZW50LCByb206IFJvbSk6IHN0cmluZyB7XG4gIGNvbnN0IGNzcyA9IFsuLi5yXTtcbiAgY29uc3QgcyA9IGNzcy5tYXAoY3MgPT4gaXRlcnMuaXNFbXB0eShjcykgPyAnb3BlbicgOlxuICAgICAgICAgICAgICAgICAgICBbLi4uY3NdLm1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgIChjOiBDb25kaXRpb24pID0+IHJvbS5mbGFnc1tjXT8uZGVidWcpLmpvaW4oJyAmICcpKVxuICAgICAgLmpvaW4oJykgfCAoJyk7XG4gIHJldHVybiBjc3MubGVuZ3RoID4gMSA/IGAoJHtzfSlgIDogY3NzLmxlbmd0aCA/IHMgOiAnbmV2ZXInO1xufVxuXG4oVGVycmFpbiBhcyBhbnkpLmRlYnVnTGFiZWwgPSBkZWJ1Z0xhYmVsO1xuaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnKSAod2luZG93IGFzIGFueSkuZGVidWdMYWJlbCA9IGRlYnVnTGFiZWw7XG4iXX0=