import { hex } from '../rom/util.js';
import { buildTradeInMap } from './shuffletrades.js';
import { fail } from '../assert.js';
export function fixDialog(rom) {
    replaceMessage('03:06', ',', '');
    const tradeIns = buildTradeInMap(rom);
    const zebu = rom.npcs[0x5e];
    if (zebu.data[0] < 0x41)
        unmagic('00:1b');
    replaceMessage('00:1b', '[41:Refresh]', item(zebu.data[0]));
    const akahanaTradeIn = tradeIns.get(0x82);
    if (akahanaTradeIn) {
        replaceMessage('02:01', 'an unusual statue', vague(akahanaTradeIn));
        replaceMessage('02:02', 'a statue', `the ${commonNoun(akahanaTradeIn)}`);
    }
    const gasMaskSlot = rom.prg[0x3d7fe];
    replaceMessage('02:02', '[29:Gas Mask]', item(gasMaskSlot));
    const telepathySlot = rom.prg[0x367f4];
    if (telepathySlot < 0x41)
        unmagic('03:01');
    replaceMessage('03:01', '[43:Telepathy]', item(telepathySlot));
    const tornel = rom.npcs[0x5f];
    const tornelTradeIn = findTornelTradeIn(tornel);
    replaceMessage('03:01', '[06:Tornado Bracelet]', item(tornelTradeIn));
    replaceMessage('05:0a', '[06:Tornado Bracelet]', item(tornelTradeIn));
    replaceMessage('05:0a', '[44:Teleport]', item(tornel.data[0]));
    const fogLampTradeIn = tradeIns.get(0x64);
    if (fogLampTradeIn != null) {
        replaceMessage('09:01', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:04', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:05', '[35:Fog Lamp]', item(fogLampTradeIn));
        replaceMessage('09:06', 'lamp', commonNoun(fogLampTradeIn));
    }
    const queen = rom.npcs[0x38];
    replaceMessage('0a:0c', '[28:Flute of Lime]', item(queen.data[0]));
    const recoverSlot = rom.prg[0x3d1f9];
    if (recoverSlot < 0x41)
        unmagic('0b:01');
    replaceMessage('0b:01', '[45:Recover]', item(recoverSlot));
    const barrierSlot = rom.prg[0x3d6d9];
    if (barrierSlot < 0x41) {
        replaceMessage('0b:01', 'teach you\n the magic of', 'give you\n ');
        unmagic('1d:12');
    }
    replaceMessage('0b:01', '[46:Barrier]', item(barrierSlot));
    replaceMessage('1d:12', '[46:Barrier]', item(barrierSlot));
    let fogLampCaveLoot = findLoot(0x4f, 0x4e, 0x4d, 0x4c, 0x47, 0x46, 0x45, 0x44, 0x4b, 0x4a, 0x49, 0x48);
    if (fogLampCaveLoot >= 0) {
        replaceMessage('0d:00', '[35:Fog Lamp]', item(fogLampCaveLoot));
    }
    else {
        replaceMessage('0d:00', 'that a [35:Fog Lamp] was', 'there was treasure');
    }
    const rageTradeIn = rom.npcs[0xc3].localDialogs.get(-1)[0].condition & 0xff;
    const rageItem = rom.prg[0x3d337];
    replaceMessage('0e:03', '[02:Sword of Water]', item(rageTradeIn));
    replaceMessage('0e:03', '[09:Ball of Water]', item(rageItem));
    replaceMessage('10:0c', 'that\'s', 'is');
    replaceMessage('10:0c', /, is in the\+lighthouse/, '');
    const aryllisTradeIn = tradeIns.get(0x23);
    if (aryllisTradeIn != null) {
        replaceMessage('12:05', '[3c:Kirisa Plant]', item(aryllisTradeIn));
        replaceMessage('12:10', 'the plant', `the ${commonNoun(aryllisTradeIn)}`);
        replaceMessage('12:10', '[3c:Kirisa Plant]', item(aryllisTradeIn));
        const clue = `Our illustrious chief seeks ${vague(aryllisTradeIn)}.`;
        replaceMessage('12:09', /[^]*/, clue);
        replaceMessage('12:0a', /[^]*/, clue);
    }
    const lovePendantTradeIn = tradeIns.get(0x74);
    if (lovePendantTradeIn != null) {
        replaceMessage('13:02', '[3b:Love Pendant]', item(lovePendantTradeIn));
        replaceMessage('13:00', 'pendant', commonNoun(lovePendantTradeIn));
    }
    const changeSlot = rom.prg[0x3d6de];
    if (changeSlot < 0x41) {
        replaceMessage('13:02', 'teach\s+you the magic of', 'bestow\n upon you the');
    }
    replaceMessage('13:02', '[47:Change]', item(changeSlot));
    const ivoryStatueTradeIn = tradeIns.get(0x75);
    if (ivoryStatueTradeIn != null) {
        replaceMessage('18:06', '[3d:Ivory Statue]', item(ivoryStatueTradeIn));
        replaceMessage('18:07', '[3d:Ivory Statue]', item(ivoryStatueTradeIn));
    }
    replaceMessage('18:06', `It's in a room`, '{0b:Karmine} is');
    const flightSlot = rom.prg[0x3d18f];
    if (flightSlot < 0x41)
        replaceMessage('18:07', 'teach', 'give');
    replaceMessage('18:07', '[48:Flight]', item(flightSlot));
    const paralysisSlot = rom.prg[0x3d655];
    if (paralysisSlot < 0x41)
        unmagic('1c:10');
    replaceMessage('1c:10', '[42:Paralysis]', item(paralysisSlot));
    replaceMessage('20:06', 'Statue of Gold', item(0x3a));
    function unmagic(mid) {
        replaceMessage(mid, 'teach you the magic of', 'bestow upon you the');
    }
    function item(id) {
        const item = itemget(id);
        return `[${hex(item.id)}:${item.messageName}]`;
    }
    function replaceMessage(mid, pat, repl) {
        const [part, index] = mid.split(':').map(x => parseInt(x, 16));
        const msg = rom.messages.parts[part][index];
        msg.text = msg.text.replace(pat, repl);
    }
    function findLoot(...locs) {
        const conditions = [
            (item) => BOWS.has(item),
            (item) => SWORD_OR_MAGIC.has(item),
            (item) => itemget(item).unique,
        ];
        for (const cond of conditions) {
            for (const id of locs) {
                const loc = rom.locations[id];
                for (const spawn of loc.spawns) {
                    if (spawn.isChest() && spawn.id <= 0x48 && cond(spawn.id)) {
                        return spawn.id;
                    }
                }
            }
        }
        return -1;
    }
    function itemget(id) {
        const itemget = rom.itemGets[id];
        return rom.items[itemget.itemId];
    }
}
const BOWS = new Set([0x3e, 0x3f, 0x40]);
const SWORD_OR_MAGIC = new Set([0x00, 0x01, 0x02, 0x03, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48]);
function findTornelTradeIn(tornel) {
    for (const ds of tornel.localDialogs.values()) {
        for (let i = 2; i < ds.length; i++) {
            const item = ~ds[i].condition;
            if (item > 0x204 && item <= 0x20c && !(item & 1))
                return item & 0xff;
        }
    }
    return 0x06;
}
function vague(id) {
    switch (id) {
        case 0x25: return 'an unusual statue';
        case 0x28: return 'a rare instrument';
        case 0x35: return 'a brilliant lamp';
        case 0x3b: return 'a beautiful charm';
        case 0x3c: return 'a fragrant plant';
        case 0x3d: return 'an exotic statue';
    }
    fail();
    return 'a valuable item';
}
function commonNoun(id) {
    switch (id) {
        case 0x25: return 'statue';
        case 0x28: return 'instrument';
        case 0x35: return 'lamp';
        case 0x3b: return 'pendant';
        case 0x3c: return 'plant';
        case 0x3d: return 'statue';
    }
    fail();
    return 'item';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZml4ZGlhbG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3MvZml4ZGlhbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuQyxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUdsQyxNQUFNLFVBQVUsU0FBUyxDQUFDLEdBQVE7SUFFaEMsY0FBYyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFakMsTUFBTSxRQUFRLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBR3RDLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUk7UUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTVELE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUMsSUFBSSxjQUFjLEVBQUU7UUFDbEIsY0FBYyxDQUFDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUNwRSxjQUFjLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDMUU7SUFFRCxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3JDLGNBQWMsQ0FB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QztJQUNQLE9BQU8saUJBQWlCLENBQUM7QUFDM0IsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLEVBQVU7SUFDNUIsUUFBUSxFQUFFLEVBQUU7UUFDVixLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sUUFBUSxDQUFDO1FBQzNCLEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxZQUFZLENBQUM7UUFDL0IsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLE1BQU0sQ0FBQztRQUN6QixLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sU0FBUyxDQUFDO1FBQzVCLEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxPQUFPLENBQUM7UUFDMUIsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLFFBQVEsQ0FBQztLQUM1QjtJQUNELElBQUksRUFBRSxDQUFDO0lBQ1AsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtJdGVtfSBmcm9tICcuLi9yb20vaXRlbS5qcyc7XG5pbXBvcnQge05wY30gZnJvbSAnLi4vcm9tL25wYy5qcyc7XG5pbXBvcnQge2hleH0gZnJvbSAnLi4vcm9tL3V0aWwuanMnO1xuaW1wb3J0IHtidWlsZFRyYWRlSW5NYXB9IGZyb20gJy4vc2h1ZmZsZXRyYWRlcy5qcyc7XG5pbXBvcnQge2ZhaWx9IGZyb20gJy4uL2Fzc2VydC5qcyc7XG5cbi8qKiBGaW5kcyByZWZlcmVuY2VzIHRvIGdpdmVuIGl0ZW1zIGFuZCByZXBsYWNlcyBpdCB3aXRoIHRoZSBhY3R1YWwgaXRlbXMuICovXG5leHBvcnQgZnVuY3Rpb24gZml4RGlhbG9nKHJvbTogUm9tKSB7XG4gIC8vIFN0b20ncyBcIkknbGwsIGJlIHdhaXRpbmcuLi5cIiBkaWFsb2cgLSB0aGUgY29tbWEgaXMganVzdCB3cm9uZy5cbiAgcmVwbGFjZU1lc3NhZ2UoJzAzOjA2JywgJywnLCAnJyk7XG5cbiAgY29uc3QgdHJhZGVJbnMgPSBidWlsZFRyYWRlSW5NYXAocm9tKTtcbiAgLy8gTk9URTogd2UgbmVlZCB0byBoYXJkY29kZSBvcmlnaW5hbCBuYW1lcyBpbiBjYXNlIHRoZXkgd2VyZSBzaHVmZmxlZC5cblxuICBjb25zdCB6ZWJ1ID0gcm9tLm5wY3NbMHg1ZV07XG4gIGlmICh6ZWJ1LmRhdGFbMF0gPCAweDQxKSB1bm1hZ2ljKCcwMDoxYicpO1xuICByZXBsYWNlTWVzc2FnZSgnMDA6MWInLCAnWzQxOlJlZnJlc2hdJywgaXRlbSh6ZWJ1LmRhdGFbMF0pKTtcblxuICBjb25zdCBha2FoYW5hVHJhZGVJbiA9IHRyYWRlSW5zLmdldCgweDgyKTtcbiAgaWYgKGFrYWhhbmFUcmFkZUluKSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzAyOjAxJywgJ2FuIHVudXN1YWwgc3RhdHVlJywgdmFndWUoYWthaGFuYVRyYWRlSW4pKTtcbiAgICByZXBsYWNlTWVzc2FnZSgnMDI6MDInLCAnYSBzdGF0dWUnLCBgdGhlICR7Y29tbW9uTm91bihha2FoYW5hVHJhZGVJbil9YCk7XG4gIH1cblxuICBjb25zdCBnYXNNYXNrU2xvdCA9IHJvbS5wcmdbMHgzZDdmZV07XG4gIHJlcGxhY2VNZXNzYWdlKCcwMjowMicsICdbMjk6R2FzIE1hc2tdJywgaXRlbShnYXNNYXNrU2xvdCkpO1xuXG4gIGNvbnN0IHRlbGVwYXRoeVNsb3QgPSByb20ucHJnWzB4MzY3ZjRdO1xuICBpZiAodGVsZXBhdGh5U2xvdCA8IDB4NDEpIHVubWFnaWMoJzAzOjAxJyk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwMzowMScsICdbNDM6VGVsZXBhdGh5XScsIGl0ZW0odGVsZXBhdGh5U2xvdCkpO1xuXG4gIGNvbnN0IHRvcm5lbCA9IHJvbS5ucGNzWzB4NWZdO1xuICBjb25zdCB0b3JuZWxUcmFkZUluID0gZmluZFRvcm5lbFRyYWRlSW4odG9ybmVsKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzAzOjAxJywgJ1swNjpUb3JuYWRvIEJyYWNlbGV0XScsIGl0ZW0odG9ybmVsVHJhZGVJbikpO1xuICByZXBsYWNlTWVzc2FnZSgnMDU6MGEnLCAnWzA2OlRvcm5hZG8gQnJhY2VsZXRdJywgaXRlbSh0b3JuZWxUcmFkZUluKSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwNTowYScsICdbNDQ6VGVsZXBvcnRdJywgaXRlbSh0b3JuZWwuZGF0YVswXSkpO1xuXG4gIGNvbnN0IGZvZ0xhbXBUcmFkZUluID0gdHJhZGVJbnMuZ2V0KDB4NjQpO1xuICBpZiAoZm9nTGFtcFRyYWRlSW4gIT0gbnVsbCkge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwOTowMScsICdbMzU6Rm9nIExhbXBdJywgaXRlbShmb2dMYW1wVHJhZGVJbikpO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwOTowNCcsICdbMzU6Rm9nIExhbXBdJywgaXRlbShmb2dMYW1wVHJhZGVJbikpO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwOTowNScsICdbMzU6Rm9nIExhbXBdJywgaXRlbShmb2dMYW1wVHJhZGVJbikpO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcwOTowNicsICdsYW1wJywgY29tbW9uTm91bihmb2dMYW1wVHJhZGVJbikpO1xuICB9XG5cbiAgY29uc3QgcXVlZW4gPSByb20ubnBjc1sweDM4XTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBhOjBjJywgJ1syODpGbHV0ZSBvZiBMaW1lXScsIGl0ZW0ocXVlZW4uZGF0YVswXSkpO1xuICAvLyBUT0RPIC0gY29uc2lkZXIgcmVwbGFjaW5nIDBhOjBkIGJ1dCB3ZSBuZWVkIHRvIGFsc28gcmVwbGFjZSBjb25kaXRpb24/XG4gIGNvbnN0IHJlY292ZXJTbG90ID0gcm9tLnByZ1sweDNkMWY5XTtcbiAgaWYgKHJlY292ZXJTbG90IDwgMHg0MSkgdW5tYWdpYygnMGI6MDEnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBiOjAxJywgJ1s0NTpSZWNvdmVyXScsIGl0ZW0ocmVjb3ZlclNsb3QpKTtcblxuICBjb25zdCBiYXJyaWVyU2xvdCA9IHJvbS5wcmdbMHgzZDZkOV07XG4gIGlmIChiYXJyaWVyU2xvdCA8IDB4NDEpIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMGI6MDEnLCAndGVhY2ggeW91XFxuIHRoZSBtYWdpYyBvZicsICdnaXZlIHlvdVxcbiAnKTtcbiAgICB1bm1hZ2ljKCcxZDoxMicpO1xuICB9XG4gIHJlcGxhY2VNZXNzYWdlKCcwYjowMScsICdbNDY6QmFycmllcl0nLCBpdGVtKGJhcnJpZXJTbG90KSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcxZDoxMicsICdbNDY6QmFycmllcl0nLCBpdGVtKGJhcnJpZXJTbG90KSk7XG5cbiAgLy8gTG9vayBmb3IgYSBrZXkgaXRlbSBpbiB0aGUgZm9nIGxhbXAva2lyaXNhIHBsYW50IGNhdmVzLlxuICAvLyBPcmRlciBpcyBiYWNrIG9mIGZvZyBsYW1wLCBraXJpc2EgYmFjay10by1mcm9udCwgdGhlbiBmcm9udCBvZiBmb2cgbGFtcFxuICBsZXQgZm9nTGFtcENhdmVMb290ID0gZmluZExvb3QoMHg0ZiwgMHg0ZSwgMHg0ZCwgMHg0YywgMHg0NywgMHg0NiwgMHg0NSwgMHg0NCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDB4NGIsIDB4NGEsIDB4NDksIDB4NDgpO1xuICBpZiAoZm9nTGFtcENhdmVMb290ID49IDApIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMGQ6MDAnLCAnWzM1OkZvZyBMYW1wXScsIGl0ZW0oZm9nTGFtcENhdmVMb290KSk7XG4gIH0gZWxzZSB7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzBkOjAwJywgJ3RoYXQgYSBbMzU6Rm9nIExhbXBdIHdhcycsICd0aGVyZSB3YXMgdHJlYXN1cmUnKTtcbiAgfVxuXG4gIGNvbnN0IHJhZ2VUcmFkZUluID0gcm9tLm5wY3NbMHhjM10ubG9jYWxEaWFsb2dzLmdldCgtMSkhWzBdLmNvbmRpdGlvbiAmIDB4ZmY7XG4gIGNvbnN0IHJhZ2VJdGVtID0gcm9tLnByZ1sweDNkMzM3XTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzBlOjAzJywgJ1swMjpTd29yZCBvZiBXYXRlcl0nLCBpdGVtKHJhZ2VUcmFkZUluKSk7XG4gIHJlcGxhY2VNZXNzYWdlKCcwZTowMycsICdbMDk6QmFsbCBvZiBXYXRlcl0nLCBpdGVtKHJhZ2VJdGVtKSk7XG5cbiAgLy8gVE9ETyAtIG1lc3NhZ2UgMTA6MGMgaXMgb25seSBoYWxmLWNvcnJlY3QuICBJZiBpdGVtIG5hbWVzIGFyZSByYW5kb21pemVkXG4gIC8vIHRoZW4gZXZlbiB3aXRob3V0IGEgbG9jYXRpb24gdGhlIG1lc3NhZ2UgaXMgc3RpbGwgdXNlZnVsLiAgU28ganVzdCBkbyB0aGF0XG4gIC8vIGZvciBub3csIGFuZCB3ZSBjYW4gZmluZCBhIHdheSB0byBoaW50IGxhdGVyLlxuICByZXBsYWNlTWVzc2FnZSgnMTA6MGMnLCAndGhhdFxcJ3MnLCAnaXMnKTtcbiAgcmVwbGFjZU1lc3NhZ2UoJzEwOjBjJywgLywgaXMgaW4gdGhlXFwrbGlnaHRob3VzZS8sICcnKTtcblxuICBjb25zdCBhcnlsbGlzVHJhZGVJbiA9IHRyYWRlSW5zLmdldCgweDIzKTtcbiAgaWYgKGFyeWxsaXNUcmFkZUluICE9IG51bGwpIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTI6MDUnLCAnWzNjOktpcmlzYSBQbGFudF0nLCBpdGVtKGFyeWxsaXNUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzEyOjEwJywgJ3RoZSBwbGFudCcsIGB0aGUgJHtjb21tb25Ob3VuKGFyeWxsaXNUcmFkZUluKX1gKTtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTI6MTAnLCAnWzNjOktpcmlzYSBQbGFudF0nLCBpdGVtKGFyeWxsaXNUcmFkZUluKSk7XG4gICAgLy8gVE9ETyAtIHJlZnMgaW4gMTI6MDkgYW5kIDEyOjBhIGhhdmUgbG9jYXRpb24sIHRvby5cbiAgICAvLyByZXBsYWNlTWVzc2FnZSgnMTI6MDknLCAvXFxzKlxcbi4qLywgJy4nKTtcbiAgICAvLyByZXBsYWNlTWVzc2FnZSgnMTI6MGEnLCAvXFxzKlxcbi4qLywgJy4nKTtcbiAgICBjb25zdCBjbHVlID0gYE91ciBpbGx1c3RyaW91cyBjaGllZiBzZWVrcyAke3ZhZ3VlKGFyeWxsaXNUcmFkZUluKX0uYDtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTI6MDknLCAvW15dKi8sIGNsdWUpO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxMjowYScsIC9bXl0qLywgY2x1ZSk7XG4gIH1cblxuICBjb25zdCBsb3ZlUGVuZGFudFRyYWRlSW4gPSB0cmFkZUlucy5nZXQoMHg3NCk7XG4gIGlmIChsb3ZlUGVuZGFudFRyYWRlSW4gIT0gbnVsbCkge1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxMzowMicsICdbM2I6TG92ZSBQZW5kYW50XScsIGl0ZW0obG92ZVBlbmRhbnRUcmFkZUluKSk7XG4gICAgcmVwbGFjZU1lc3NhZ2UoJzEzOjAwJywgJ3BlbmRhbnQnLCBjb21tb25Ob3VuKGxvdmVQZW5kYW50VHJhZGVJbikpO1xuICB9XG4gIGNvbnN0IGNoYW5nZVNsb3QgPSByb20ucHJnWzB4M2Q2ZGVdO1xuICBpZiAoY2hhbmdlU2xvdCA8IDB4NDEpIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTM6MDInLCAndGVhY2hcXHMreW91IHRoZSBtYWdpYyBvZicsICdiZXN0b3dcXG4gdXBvbiB5b3UgdGhlJyk7XG4gIH1cbiAgcmVwbGFjZU1lc3NhZ2UoJzEzOjAyJywgJ1s0NzpDaGFuZ2VdJywgaXRlbShjaGFuZ2VTbG90KSk7XG5cbiAgY29uc3QgaXZvcnlTdGF0dWVUcmFkZUluID0gdHJhZGVJbnMuZ2V0KDB4NzUpO1xuICBpZiAoaXZvcnlTdGF0dWVUcmFkZUluICE9IG51bGwpIHtcbiAgICByZXBsYWNlTWVzc2FnZSgnMTg6MDYnLCAnWzNkOkl2b3J5IFN0YXR1ZV0nLCBpdGVtKGl2b3J5U3RhdHVlVHJhZGVJbikpO1xuICAgIHJlcGxhY2VNZXNzYWdlKCcxODowNycsICdbM2Q6SXZvcnkgU3RhdHVlXScsIGl0ZW0oaXZvcnlTdGF0dWVUcmFkZUluKSk7XG4gIH1cbiAgcmVwbGFjZU1lc3NhZ2UoJzE4OjA2JywgYEl0J3MgaW4gYSByb29tYCwgJ3swYjpLYXJtaW5lfSBpcycpO1xuICBjb25zdCBmbGlnaHRTbG90ID0gcm9tLnByZ1sweDNkMThmXTtcbiAgaWYgKGZsaWdodFNsb3QgPCAweDQxKSByZXBsYWNlTWVzc2FnZSgnMTg6MDcnLCAndGVhY2gnLCAnZ2l2ZScpO1xuICByZXBsYWNlTWVzc2FnZSgnMTg6MDcnLCAnWzQ4OkZsaWdodF0nLCBpdGVtKGZsaWdodFNsb3QpKTtcblxuICBjb25zdCBwYXJhbHlzaXNTbG90ID0gcm9tLnByZ1sweDNkNjU1XTtcbiAgaWYgKHBhcmFseXNpc1Nsb3QgPCAweDQxKSB1bm1hZ2ljKCcxYzoxMCcpO1xuICByZXBsYWNlTWVzc2FnZSgnMWM6MTAnLCAnWzQyOlBhcmFseXNpc10nLCBpdGVtKHBhcmFseXNpc1Nsb3QpKTtcblxuICByZXBsYWNlTWVzc2FnZSgnMjA6MDYnLCAnU3RhdHVlIG9mIEdvbGQnLCBpdGVtKDB4M2EpKTtcblxuICAvLyBUT0RPIC0gY29uc2lkZXIgd2FycGluZyBvbiBhIHJhbmRvbSBzd29yZD8gLSBtZXNzYWdlIDFjOjExXG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIGZ1bmN0aW9uIHVubWFnaWMobWlkOiBzdHJpbmcpIHtcbiAgICByZXBsYWNlTWVzc2FnZShtaWQsICd0ZWFjaCB5b3UgdGhlIG1hZ2ljIG9mJywgJ2Jlc3RvdyB1cG9uIHlvdSB0aGUnKTtcbiAgfVxuICBmdW5jdGlvbiBpdGVtKGlkOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGNvbnN0IGl0ZW0gPSBpdGVtZ2V0KGlkKTtcbiAgICByZXR1cm4gYFske2hleChpdGVtLmlkKX06JHtpdGVtLm1lc3NhZ2VOYW1lfV1gO1xuICB9XG4gIGZ1bmN0aW9uIHJlcGxhY2VNZXNzYWdlKG1pZDogc3RyaW5nLCBwYXQ6IHN0cmluZyB8IFJlZ0V4cCwgcmVwbDogc3RyaW5nKSB7XG4gICAgY29uc3QgW3BhcnQsIGluZGV4XSA9IG1pZC5zcGxpdCgnOicpLm1hcCh4ID0+IHBhcnNlSW50KHgsIDE2KSk7XG4gICAgY29uc3QgbXNnID0gcm9tLm1lc3NhZ2VzLnBhcnRzW3BhcnRdW2luZGV4XTtcbiAgICBtc2cudGV4dCA9IG1zZy50ZXh0LnJlcGxhY2UocGF0LCByZXBsKTtcbiAgfVxuICBmdW5jdGlvbiBmaW5kTG9vdCguLi5sb2NzOiBudW1iZXJbXSkge1xuICAgIGNvbnN0IGNvbmRpdGlvbnMgPSBbXG4gICAgICAoaXRlbTogbnVtYmVyKSA9PiBCT1dTLmhhcyhpdGVtKSxcbiAgICAgIChpdGVtOiBudW1iZXIpID0+IFNXT1JEX09SX01BR0lDLmhhcyhpdGVtKSxcbiAgICAgIChpdGVtOiBudW1iZXIpID0+IGl0ZW1nZXQoaXRlbSkudW5pcXVlLFxuICAgIF07XG5cbiAgICBmb3IgKGNvbnN0IGNvbmQgb2YgY29uZGl0aW9ucykge1xuICAgICAgZm9yIChjb25zdCBpZCBvZiBsb2NzKSB7XG4gICAgICAgIGNvbnN0IGxvYyA9IHJvbS5sb2NhdGlvbnNbaWRdO1xuICAgICAgICBmb3IgKGNvbnN0IHNwYXduIG9mIGxvYy5zcGF3bnMpIHtcbiAgICAgICAgICBpZiAoc3Bhd24uaXNDaGVzdCgpICYmIHNwYXduLmlkIDw9IDB4NDggJiYgY29uZChzcGF3bi5pZCkpIHtcbiAgICAgICAgICAgIHJldHVybiBzcGF3bi5pZDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIGZ1bmN0aW9uIGl0ZW1nZXQoaWQ6IG51bWJlcik6IEl0ZW0ge1xuICAgIGNvbnN0IGl0ZW1nZXQgPSByb20uaXRlbUdldHNbaWRdO1xuICAgIHJldHVybiByb20uaXRlbXNbaXRlbWdldC5pdGVtSWRdO1xuICB9XG59XG5cbmNvbnN0IEJPV1MgPSBuZXcgU2V0KFsweDNlLCAweDNmLCAweDQwXSk7XG5jb25zdCBTV09SRF9PUl9NQUdJQyA9IG5ldyBTZXQoWzB4MDAsIDB4MDEsIDB4MDIsIDB4MDMsIDB4NDEsIDB4NDIsIDB4NDMsIDB4NDQsIDB4NDUsIDB4NDYsIDB4NDcsIDB4NDhdKTtcblxuZnVuY3Rpb24gZmluZFRvcm5lbFRyYWRlSW4odG9ybmVsOiBOcGMpOiBudW1iZXIge1xuICAvLyBFeHBlY3RlZCBzdHJ1Y3R1cmU6XG4gIC8vICAgLi4uXG4gIC8vICAgTk9UIGJyYWNlbGV0IC0+IC4uLlxuICAvLyAgIE5PVCBiYWxsIC0+IC4uLlxuICAvLyAgIC0+IGdpdmUgaXRlbVxuICBmb3IgKGNvbnN0IGRzIG9mIHRvcm5lbC5sb2NhbERpYWxvZ3MudmFsdWVzKCkpIHtcbiAgICBmb3IgKGxldCBpID0gMjsgaSA8IGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpdGVtID0gfmRzW2ldLmNvbmRpdGlvbjtcbiAgICAgIC8vIExvb2sgZm9yIGFueSBuZWdhdGl2ZSBjb25kaXRpb24gb24gYSBicmFjZWxldCAoZG9lc24ndCBtYXR0ZXIgd2hlcmUpXG4gICAgICBpZiAoaXRlbSA+IDB4MjA0ICYmIGl0ZW0gPD0gMHgyMGMgJiYgIShpdGVtICYgMSkpIHJldHVybiBpdGVtICYgMHhmZjtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIDB4MDY7IC8vIGRlZmF1bHQgdG8gdG9ybmFkbyBicmFjZWxldFxufVxuXG5mdW5jdGlvbiB2YWd1ZShpZDogbnVtYmVyKTogc3RyaW5nIHtcbiAgc3dpdGNoIChpZCkge1xuICAgIGNhc2UgMHgyNTogcmV0dXJuICdhbiB1bnVzdWFsIHN0YXR1ZSc7XG4gICAgY2FzZSAweDI4OiByZXR1cm4gJ2EgcmFyZSBpbnN0cnVtZW50JztcbiAgICBjYXNlIDB4MzU6IHJldHVybiAnYSBicmlsbGlhbnQgbGFtcCc7XG4gICAgY2FzZSAweDNiOiByZXR1cm4gJ2EgYmVhdXRpZnVsIGNoYXJtJztcbiAgICBjYXNlIDB4M2M6IHJldHVybiAnYSBmcmFncmFudCBwbGFudCc7XG4gICAgY2FzZSAweDNkOiByZXR1cm4gJ2FuIGV4b3RpYyBzdGF0dWUnO1xuICB9XG4gIGZhaWwoKTtcbiAgcmV0dXJuICdhIHZhbHVhYmxlIGl0ZW0nO1xufVxuXG5mdW5jdGlvbiBjb21tb25Ob3VuKGlkOiBudW1iZXIpOiBzdHJpbmcge1xuICBzd2l0Y2ggKGlkKSB7XG4gICAgY2FzZSAweDI1OiByZXR1cm4gJ3N0YXR1ZSc7XG4gICAgY2FzZSAweDI4OiByZXR1cm4gJ2luc3RydW1lbnQnO1xuICAgIGNhc2UgMHgzNTogcmV0dXJuICdsYW1wJztcbiAgICBjYXNlIDB4M2I6IHJldHVybiAncGVuZGFudCc7XG4gICAgY2FzZSAweDNjOiByZXR1cm4gJ3BsYW50JztcbiAgICBjYXNlIDB4M2Q6IHJldHVybiAnc3RhdHVlJztcbiAgfVxuICBmYWlsKCk7XG4gIHJldHVybiAnaXRlbSc7XG59XG5cbi8vIGZ1bmN0aW9uIHJlcGxhY2VEaWFsb2cobnBjOiBOcGMsIG9yaWc6IG51bWJlciB8IFJlZ0V4cCwgcmVwbGFjZW1lbnRJZDogbnVtYmVyKSB7XG4vLyAgIGNvbnN0IHJvbSA9IG5wYy5yb207XG4vLyAgIGNvbnN0IHBhdCA9IG9yaWcgaW5zdGFuY2VvZiBSZWdFeHAgPyBvcmlnIDogcGF0dGVybihyb20uaXRlbXNbb3JpZ10pO1xuLy8gICBjb25zdCByZXBsID0gcmVwbGFjZW1lbnQocm9tLml0ZW1zW3JlcGxhY2VtZW50SWRdKTtcbi8vICAgZm9yIChjb25zdCBkcyBvZiBucGMubG9jYWxEaWFsb2dzLnZhbHVlcygpKSB7XG4vLyAgICAgZm9yIChjb25zdCBkIG9mIGRzKSB7XG4vLyAgICAgICBjb25zdCBtaWQgPSBkLm1lc3NhZ2U7XG4vLyAgICAgICByZXBsYWNlTWVzc2FnZShyb20sIG1pZC5wYXJ0LCBtaWQuaW5kZXgsIHBhdCwgcmVwbCk7XG4vLyAgICAgfVxuLy8gICB9XG4vLyB9XG5cbi8vIGNvbnN0IHBhdHRlcm46IHsoaWQ6IG51bWJlciwgbmFtZTogc3RyaW5nKTogUmVnRXhwO1xuLy8gICAgICAgICAgICAgICAgIChpdGVtOiBJdGVtKTogUmVnRXhwfSA9XG4vLyAgICAgKGl0ZW06IG51bWJlciB8IEl0ZW0sIG5hbWU/OiBzdHJpbmcpID0+IHtcbi8vICAgICAgIG5hbWUgPSBuYW1lIHx8IChpdGVtIGFzIEl0ZW0pLm1lc3NhZ2VOYW1lO1xuLy8gICAgICAgY29uc3QgaWQgPSBoZXgoaXRlbSBpbnN0YW5jZW9mIEl0ZW0gPyBpdGVtLmlkIDogaXRlbSk7XG4vLyAgICAgICByZXR1cm4gbmV3IFJlZ0V4cChgXFxcXFske2lkfTpbXlxcXFxdXSpcXFxcXXwke25hbWUucmVwbGFjZSgvXFxzKy9nLCAnXFxcXHMrJyl9YCxcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICdnJyk7XG4vLyAgICAgfTtcblxuLy8gZnVuY3Rpb24gcmVwbGFjZW1lbnQoaXRlbTogSXRlbSk6IHN0cmluZyB7XG4vLyAgIHJldHVybiBgWyR7aGV4KGl0ZW0uaWQpfToke2l0ZW0ubWVzc2FnZU5hbWV9XWA7XG4vLyB9XG4iXX0=