import { Metalocation } from '../rom/metalocation.js';
import { DefaultMap } from '../util.js';
const HOUSE_ICON = 0x06;
const TALL_HOUSE_ICON = 0x21;
const icons = new Map([
    ['pawn', 0x36],
    ['inn', 0x37],
    ['armor', 0x38],
    ['tool', 0x39],
    ['tavern', 0x3b],
]);
const shops = new Set(['inn', 'armor', 'tool', 'pawn']);
const compat = new Set([...shops, 'house', 'tavern']);
export function shuffleHouses(rom, flags, random) {
    var _a, _b, _c;
    const { locations: { Nadare, } } = rom;
    const byType = new DefaultMap(() => []);
    const byLocPos = new DefaultMap(() => []);
    const screens = new DefaultMap(() => new Set());
    for (const location of rom.locations) {
        if (!location.used)
            continue;
        if (location.data.houseType == null)
            continue;
        for (const [pos, type, spec] of location.meta.exits()) {
            if (type === 'edge:bottom' || shops.has(location.data.houseType) ||
                (location.meta.tileset === rom.metatilesets.fortress &&
                    type === 'stair:down')) {
                const house = {
                    type: location.data.houseType,
                    inside: [location.id << 8 | pos, type],
                    outside: spec,
                };
                let locpos = spec[0];
                byLocPos.get(locpos).push(house);
                byType.get(location.data.houseType).push(house);
                const screen = rom.locations[locpos >>> 8].screens[(locpos >>> 4) & 0xf][locpos & 0xf];
                screens.get(screen).add(locpos);
            }
        }
    }
    const secondPass = new Map();
    const firstPass = new Map();
    for (const [scr, locposs] of screens) {
        if (locposs.size >= 2 || scr === 0x64) {
            firstPass.set(scr, locposs);
        }
        else {
            secondPass.set(scr, locposs);
        }
    }
    const hasInn = new Set();
    for (const [, locposs] of [...firstPass, ...secondPass]) {
        const map = new Map();
        let first = true;
        for (const locpos of locposs) {
            for (const house of byLocPos.get(locpos)) {
                let eligible = first && compat.has(house.type) ?
                    [...compat].map(t => byType.get(t)) :
                    [byType.get((_a = map.get(house.outside[1])) !== null && _a !== void 0 ? _a : house.type)];
                eligible = eligible.filter(x => x.length);
                const allowInn = [...locposs].every(lp => !hasInn.has(lp >>> 8));
                if (!allowInn && eligible.length > 1) {
                    eligible = eligible.filter(x => x !== byType.get('inn'));
                }
                const replacement = random.pickAndRemove(...eligible);
                if (replacement.type === 'inn') {
                    for (const lp of locposs) {
                        hasInn.add(lp >>> 8);
                    }
                }
                map.set(house.outside[1], replacement.type);
                Metalocation.connect(rom, house.outside, replacement.inside);
                if (!first)
                    continue;
                if (icons.get(house.type) === icons.get(replacement.type))
                    continue;
                const outside = rom.locations[house.outside[0] >>> 8];
                if (outside === Nadare)
                    continue;
                const exits = Metalocation.findExitTiles(rom, house.outside);
                if (exits.length > 1)
                    continue;
                let coord = exits[0] - 0x20;
                if ((exits[0] & 0xf0) < 0x20)
                    coord -= 0x0f10;
                const pos = coord >> 8;
                const tile = coord & 0xff;
                const icon = (_b = icons.get(replacement.type)) !== null && _b !== void 0 ? _b : (((_c = outside.meta.get(pos).data.tallHouses) === null || _c === void 0 ? void 0 : _c.includes(tile)) ?
                    TALL_HOUSE_ICON : HOUSE_ICON);
                rom.screens[outside.screens[pos >> 4][pos & 0xf]].tiles[tile] = icon;
            }
            first = false;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZWhvdXNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9wYXNzL3NodWZmbGVob3VzZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBOEJBLE9BQU8sRUFBVyxZQUFZLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUk5RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBUXhDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQztBQUN4QixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUM7QUFDN0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQW9CO0lBQ3ZDLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztJQUNkLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQztJQUNiLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQztJQUNmLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztJQUNkLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQztDQUNqQixDQUFDLENBQUM7QUFFSCxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBWSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDbkUsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQVksQ0FBQyxHQUFHLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUVqRSxNQUFNLFVBQVUsYUFBYSxDQUFDLEdBQVEsRUFBRSxLQUFjLEVBQUUsTUFBYzs7SUFDcEUsTUFBTSxFQUFDLFNBQVMsRUFBRSxFQUNvQyxNQUFNLEdBQzNELEVBQUMsR0FBRyxHQUFHLENBQUM7SUFFVCxNQUFNLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBcUIsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDNUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxVQUFVLENBQWtCLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxD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VUFBVSxDQUFDLENBQUM7Z0JBQ2pDLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQzthQUN0RTtZQUNELEtBQUssR0FBRyxLQUFLLENBQUM7U0FDZjtLQUNGO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNodWZmbGUgaG91c2Uvc2hvcC9zaGVkL3BhbGFjZSBlbnRyYW5jZXMuXG4vLyBUaGlzIGlzIHRyaWNreSBmb3IgYSBudW1iZXIgb2YgcmVhc29ucy4gIFdlIG5lZWQgdG8gcGF5IGF0dGVudGlvbiB0b1xuLy8ga2VlcCB0aGUgcmlnaHQgaWNvbiBhYm92ZSBlYWNoIGRvb3IsIHdoaWNoIGlzIGV4dHJhIHRyaWNreSBmb3IgdGhlXG4vLyAodmFuaWxsYSkgNSBzY3JlZW5zIHRoYXQgc2hhcmUgdHdvIHRvd25zLiAgVGhpcyBjYW4gYmUgbWl0aWdhdGVkIGJ5XG4vLyBleHBhbmRpbmcgdGhlIHNjcmVlbiBzcGFjZSBpbnRvIHRoZSBleHRyYSBST00gYXJlYSwgYnV0IGl0J3MgbmljZSB0b1xuLy8gc3RpbGwgd29yayB3aXRob3V0IHRoYXQuXG5cbi8vIE5PVEU6IEl0J3MgcG9zc2libGUgdGhhdCB3ZSBzaHVmZmxlIGFsbCB0aGUgc3BoZXJlLTAgY2hlY2tzIGF3YXkgZnJvbVxuLy8gTGVhZi4gIElmIHRoZXJlJ3Mgbm8gZXh0cmEgcGFzc2FnZSB0aGVuIHdlIG1heSBlbmQgdXAgd2l0aCBhbiBpbXBvc3NpYmxlXG4vLyBzaHVmZmxlLiAgSW4gdGhhdCBjYXNlLCB3ZSBuZWVkIHRvIGZpbmQgYSB3YXkgdG8gcmVncm91cC4gIEZvciBub3csIHRoZVxuLy8gZWFzaWVzdCBvcHRpb24gbWF5IGJlIHRvIGxlYXZlIHRob3NlIHR3byBob3VzZXMgb3V0IG9mIHRoZSBzaHVmZmxlLi4uXG5cblxuLy8gTk9URTogdGhlcmUncyBhIGJ1ZyB3aGVuIGVudHJhbmNlcyBhcmUgb3V0IG9mIG9yZGVyXG4vLyAgIC0gd2FycCB0byB0b3ducyBjb21lcyBvdXQgb2YgZG9vclxuLy8gICAtIGJvYXQgYnJva2VuIGlmIG5vdCBlbnRyYW5jZSAwIChlLmcuIGxpZ2h0aG91c2Ugb3IgYm9hdCBob3VzZSlcbi8vIC0+IG1pZ2h0IGJlIG5pY2UgdG8gZml4IGJvYXQsIGJ1dCBnZW5lcmFsbHkgd2UndmUgaGFkIGFsbCBzb3J0cyBvZlxuLy8gICAgaXNzdWVzIGZyb20gZW50cmFuY2UgcmVvcmRlcmluZyAtIHdlIHNob3VsZCB0cnkgdG8gZml4IGl0IHNvXG4vLyAgICB0aGF0IHRoZSBlbnRyYW5jZSB0eXBlcyBhcmUgcHJlc2VydmVkIGFzIG11Y2ggYXMgcG9zc2libGVcbi8vICAgIChpLmUuIGVkZ2UvZGlyZWN0aW9uIHZzIGRvb3IsIGV0Yylcbi8vICAgLSBjYW4gd2UgZGVmZXIgdGhlIGRlY2lzaW9uIG9mIHdoaWNoIGVudHJhbmNlIG51bWJlciB0byB1c2Vcbi8vICAgICB1bnRpbCBhIGxpdHRsZSBsYXRlciwgYW5kIGp1c3QgaW5kaXJlY3QgaXQgZm9yIGEgd2hpbGU/XG4vLyAgIC0gaWYgbWF6ZSBzaHVmZmxlIGlzIG9uLCBpdCBjb3VsZCBiZSBoYXJkIHRvIGZpZ3VyZSBvdXQgd2hpY2hcbi8vICAgICBpcyB3aGljaD8gZXhjZXB0IHdlIGRvIGtub3cgdGhlIGV4aXQgdHlwZXMgYW5kIHRoZSBudW1iZXJcbi8vICAgICBiZWZvcmUgd2UgYXNzaWduIGFueXRoaW5nLi4uIHNvIG1ha2UgYSBtYXBwaW5nIGFuZCB0aGVuIGZpbGxcbi8vICAgICBpbiBhbnkgZ2Fwcy5cblxuXG5pbXBvcnQge1JhbmRvbX0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtFeGl0U3BlYywgTWV0YWxvY2F0aW9ufSBmcm9tICcuLi9yb20vbWV0YWxvY2F0aW9uLmpzJztcbmltcG9ydCB7SG91c2VUeXBlfSBmcm9tICcuLi9yb20vbG9jYXRpb24uanMnO1xuaW1wb3J0IHtDb25uZWN0aW9uVHlwZX0gZnJvbSAnLi4vcm9tL21ldGFzY3JlZW5kYXRhLmpzJztcbmltcG9ydCB7RmxhZ1NldH0gZnJvbSAnLi4vZmxhZ3NldC5qcyc7XG5pbXBvcnQgeyBEZWZhdWx0TWFwIH0gZnJvbSAnLi4vdXRpbC5qcyc7XG5cbmludGVyZmFjZSBIb3VzZSB7XG4gIHR5cGU6IEhvdXNlVHlwZTtcbiAgaW5zaWRlOiBFeGl0U3BlYztcbiAgb3V0c2lkZTogRXhpdFNwZWM7XG59XG5cbmNvbnN0IEhPVVNFX0lDT04gPSAweDA2O1xuY29uc3QgVEFMTF9IT1VTRV9JQ09OID0gMHgyMTtcbmNvbnN0IGljb25zID0gbmV3IE1hcDxIb3VzZVR5cGUsIG51bWJlcj4oW1xuICBbJ3Bhd24nLCAweDM2XSxcbiAgWydpbm4nLCAweDM3XSxcbiAgWydhcm1vcicsIDB4MzhdLFxuICBbJ3Rvb2wnLCAweDM5XSxcbiAgWyd0YXZlcm4nLCAweDNiXSxcbl0pO1xuXG5jb25zdCBzaG9wcyA9IG5ldyBTZXQ8SG91c2VUeXBlPihbJ2lubicsICdhcm1vcicsICd0b29sJywgJ3Bhd24nXSk7XG5jb25zdCBjb21wYXQgPSBuZXcgU2V0PEhvdXNlVHlwZT4oWy4uLnNob3BzLCAnaG91c2UnLCAndGF2ZXJuJ10pO1xuXG5leHBvcnQgZnVuY3Rpb24gc2h1ZmZsZUhvdXNlcyhyb206IFJvbSwgZmxhZ3M6IEZsYWdTZXQsIHJhbmRvbTogUmFuZG9tKSB7XG4gIGNvbnN0IHtsb2NhdGlvbnM6IHtcbiAgICAvKkJvYXRIb3VzZSwgTGVhZl9FbGRlckhvdXNlLCBMZWFmX1N0dWRlbnRIb3VzZSwgKi8gTmFkYXJlLCAvKkdvYV9Ib3VzZSwqL1xuICB9fSA9IHJvbTtcbiAgLy8gRmlyc3Qgb3JkZXIgb2YgYnVzaW5lc3M6IGNvbGxlY3QgYWxsIHRoZSBjb25uZWN0aW9ucy5cbiAgY29uc3QgYnlUeXBlID0gbmV3IERlZmF1bHRNYXA8SG91c2VUeXBlLCBIb3VzZVtdPigoKSA9PiBbXSk7XG4gIGNvbnN0IGJ5TG9jUG9zID0gbmV3IERlZmF1bHRNYXA8bnVtYmVyLCBIb3VzZVtdPigoKSA9PiBbXSk7IC8vIGtleTogTG9jUG9zXG4gIGNvbnN0IHNjcmVlbnMgPSBuZXcgRGVmYXVsdE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigoKSA9PiBuZXcgU2V0KCkpOyAvLyBTY3JJZCAtPiBMb2NQb3NcbiAgZm9yIChjb25zdCBsb2NhdGlvbiBvZiByb20ubG9jYXRpb25zKSB7XG4gICAgaWYgKCFsb2NhdGlvbi51c2VkKSBjb250aW51ZTtcbiAgICBpZiAobG9jYXRpb24uZGF0YS5ob3VzZVR5cGUgPT0gbnVsbCkgY29udGludWU7XG4gICAgLy8gUHJldmVudCBpbXBvc3NpYmxlIHNodWZmbGVzIGJ5IGVuc3VyaW5nIGl0ZW1zIGluIHNwaGVyZS0wXG4gICAgLy8gTm90ZTogaWYgd2UgaGF2ZSB0aGUgR0JDIGNhdmUsIHdlIGNvdWxkIHBvdGVudGlhbGx5IGxldCB0aGVzZVxuICAgIC8vIGhvdXNlcyBmbG9hdCwgc2luY2Ugd2UncmUgZ3VhcmFudGVlZCB0d28gZXh0cmEgY2hlY2tzICh0aG91Z2hcbiAgICAvLyBtaW1pY3MgYXJlIHNodWZmbGVkIGVhcmx5IG5vdywgc28gdGhhdCBjb3VsZCBzdGlsbCBjYXVzZSBhIHByb2JsZW0pLlxuICAgIC8vaWYgKGxvY2F0aW9uID09PSBMZWFmX0VsZGVySG91c2UgfHwgbG9jYXRpb24gPT09IExlYWZfU3R1ZGVudEhvdXNlKSBjb250aW51ZTtcbiAgICAvLyBUaGVyZSdzIHNvbWV0aGluZyBnbGl0Y2h5IGFib3V0IHRoaXMgb25lIC0gd2hlbiB3ZSBlbWVyZ2UsXG4gICAgLy8gdGhlIHNjcmVlbiBzY3JvbGxzIGFuZCBsb2Nrcy5cbiAgICAvL2lmIChsb2NhdGlvbiA9PT0gQm9hdEhvdXNlKSBjb250aW51ZTtcblxuICAgIC8vIEZvciBub24tc2hvcHMsIGZpbmQgdGhlIGJvdHRvbSBlZGdlXG4gICAgZm9yIChjb25zdCBbcG9zLCB0eXBlLCBzcGVjXSBvZiBsb2NhdGlvbi5tZXRhLmV4aXRzKCkpIHtcbiAgICAgIGlmICh0eXBlID09PSAnZWRnZTpib3R0b20nIHx8IHNob3BzLmhhcyhsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSkgfHxcbiAgICAgICAgIChsb2NhdGlvbi5tZXRhLnRpbGVzZXQgPT09IHJvbS5tZXRhdGlsZXNldHMuZm9ydHJlc3MgJiZcbiAgICAgICAgICB0eXBlID09PSAnc3RhaXI6ZG93bicpKSB7XG4gICAgICAgIGNvbnN0IGhvdXNlOiBIb3VzZSA9IHtcbiAgICAgICAgICB0eXBlOiBsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSxcbiAgICAgICAgICBpbnNpZGU6IFtsb2NhdGlvbi5pZCA8PCA4IHwgcG9zLCB0eXBlXSxcbiAgICAgICAgICBvdXRzaWRlOiBzcGVjLFxuICAgICAgICB9O1xuICAgICAgICBsZXQgbG9jcG9zID0gc3BlY1swXTtcbiAgICAgICAgLy8gQ2hlY2sgb3V0c2lkZSBzcGVjIGZvciBzaHlyb24uLi5cbiAgICAgICAgLy8gaWYgKGxvY2F0aW9uID09PSBTaHlyb24gJiZcbiAgICAgICAgLy8gICAgIChsb2NhdGlvbi5kYXRhLmhvdXNlVHlwZSA9PT0gJ2FybW9yJyB8fFxuICAgICAgICAvLyAgICAgIGxvY2F0aW9uLmRhdGEuaG91c2VUeXBlID09PSAndG9vbCcpKSB7XG4gICAgICAgIC8vICAgbG9jcG9zIC09IDB4MTA7IC8vIGljb24gaXMgYWN0dWFsbHkgb24gcHJldmlvdXMgc2NyZWVuXG4gICAgICAgIC8vIH1cbiAgICAgICAgYnlMb2NQb3MuZ2V0KGxvY3BvcykucHVzaChob3VzZSk7XG4gICAgICAgIGJ5VHlwZS5nZXQobG9jYXRpb24uZGF0YS5ob3VzZVR5cGUpLnB1c2goaG91c2UpO1xuICAgICAgICBjb25zdCBzY3JlZW4gPSByb20ubG9jYXRpb25zW2xvY3BvcyA+Pj4gOF0uc2NyZWVuc1sobG9jcG9zID4+PiA0KSAmIDB4Zl1bbG9jcG9zICYgMHhmXTtcbiAgICAgICAgc2NyZWVucy5nZXQoc2NyZWVuKS5hZGQobG9jcG9zKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBUd28gcGFzc2VzOiAxLiBvbmx5IGhhbmRsZSBvdmVybG9hZGVkIHNjcmVlbnM7IDIuIGFsbCB0aGUgcmVzdC5cbiAgY29uc3Qgc2Vjb25kUGFzcyA9IG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKTtcbiAgY29uc3QgZmlyc3RQYXNzID0gbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpO1xuICBmb3IgKGNvbnN0IFtzY3IsIGxvY3Bvc3NdIG9mIHNjcmVlbnMpIHtcbiAgICAvLyBOT1RFOiBzdHVkZW50L2Jyb2thaGFuYSBzaG91bGQgYmUgaW4gZmlyc3QgcGFzcy5cbiAgICBpZiAobG9jcG9zcy5zaXplID49IDIgfHwgc2NyID09PSAweDY0KSB7XG4gICAgICBmaXJzdFBhc3Muc2V0KHNjciwgbG9jcG9zcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNlY29uZFBhc3Muc2V0KHNjciwgbG9jcG9zcyk7XG4gICAgfVxuICB9XG4gIGNvbnN0IGhhc0lubiA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICBmb3IgKGNvbnN0IFssIGxvY3Bvc3NdIG9mIFsuLi5maXJzdFBhc3MsIC4uLnNlY29uZFBhc3NdKSB7XG4gICAgLy9jb25zb2xlLmxvZyhgc2h1ZmZsaW5nIHNjcmVlbiAke3Njci50b1N0cmluZygxNil9OiAke1suLi5sb2Nwb3NzXS5tYXAobD0+bC50b1N0cmluZygxNikpLmpvaW4oJywnKX1gKTtcbiAgICBjb25zdCBtYXAgPSBuZXcgTWFwPENvbm5lY3Rpb25UeXBlLCBIb3VzZVR5cGU+KCk7XG4gICAgbGV0IGZpcnN0ID0gdHJ1ZTtcbiAgICBmb3IgKGNvbnN0IGxvY3BvcyBvZiBsb2Nwb3NzKSB7XG4gICAgICBmb3IgKGNvbnN0IGhvdXNlIG9mIGJ5TG9jUG9zLmdldChsb2Nwb3MpKSB7XG4gICAgICAgIGxldCBlbGlnaWJsZSA9IGZpcnN0ICYmIGNvbXBhdC5oYXMoaG91c2UudHlwZSkgP1xuICAgICAgICAgIFsuLi5jb21wYXRdLm1hcCh0ID0+IGJ5VHlwZS5nZXQodCkpIDpcbiAgICAgICAgICBbYnlUeXBlLmdldChtYXAuZ2V0KGhvdXNlLm91dHNpZGVbMV0pID8/IGhvdXNlLnR5cGUpXTtcbiAgICAgICAgZWxpZ2libGUgPSBlbGlnaWJsZS5maWx0ZXIoeCA9PiB4Lmxlbmd0aCk7XG4gICAgICAgIC8vIEF2b2lkIG1vcmUgdGhhbiBvbmUgaW5uIHBlciB0b3duLCBzaW5jZSB0aGF0J3MgbGFtZS5cbiAgICAgICAgY29uc3QgYWxsb3dJbm4gPSBbLi4ubG9jcG9zc10uZXZlcnkobHAgPT4gIWhhc0lubi5oYXMobHAgPj4+IDgpKTtcbiAgICAgICAgaWYgKCFhbGxvd0lubiAmJiBlbGlnaWJsZS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgZWxpZ2libGUgPSBlbGlnaWJsZS5maWx0ZXIoeCA9PiB4ICE9PSBieVR5cGUuZ2V0KCdpbm4nKSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gTk9URTogaWYgc3R1ZGVudCBpcyBzdGF5aW5nIHB1dCB0aGVuIGRvbid0IHNodWZmbGUgYnJva2FoYW5hIHRvIGEgbm9uLWhvdXNlXG4gICAgICAgIC8vIFRPRE8gLSBiZXR0ZXIgY29uZGl0aW9uLCBwYXJ0aWN1bGFybHkgaWYgd2UgX2RvXyBzaHVmZmxlIHN0dWRlbnQgb3IgaWYgd2Ugc3BsaXQgc2NyZWVuc1xuICAgICAgICAvLyBpZiAoKGhvdXNlLm91dHNpZGVbMF0gPj4+IDgpID09PSBHb2FfSG91c2UuaWQgJiYgYnlUeXBlLmdldCgnaG91c2UnKS5sZW5ndGgpIHtcbiAgICAgICAgLy8gICBlbGlnaWJsZSA9IFtieVR5cGUuZ2V0KCdob3VzZScpXTtcbiAgICAgICAgLy8gfVxuICAgICAgICAvLyBUT0RPIC0gYWxzbyBjb25zaWRlciBwcmV2ZW50aW5nIG11bHRpcGxlIGlubnMgaW4gdGhlIHNhbWUgdG93bj9cbiAgICAgICAgY29uc3QgcmVwbGFjZW1lbnQgPSByYW5kb20ucGlja0FuZFJlbW92ZSguLi5lbGlnaWJsZSk7XG4gICAgICAgIGlmIChyZXBsYWNlbWVudC50eXBlID09PSAnaW5uJykge1xuICAgICAgICAgIGZvciAoY29uc3QgbHAgb2YgbG9jcG9zcykge1xuICAgICAgICAgICAgaGFzSW5uLmFkZChscCA+Pj4gOCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG1hcC5zZXQoaG91c2Uub3V0c2lkZVsxXSwgcmVwbGFjZW1lbnQudHlwZSk7XG4gICAgICAgIC8vIE1ha2UgdGhlIGNvbm5lY3Rpb25cbiAgICAgICAgLy9jb25zb2xlLmxvZyhgY29ubmVjdCAke3JvbS5sb2NhdGlvbnNbaG91c2Uub3V0c2lkZVswXT4+PjhdLm5hbWV9ICR7aG91c2Uub3V0c2lkZVswXS50b1N0cmluZygxNil9ICR7aG91c2Uub3V0c2lkZVsxXX0gLS0gJHtyb20ubG9jYXRpb25zW3JlcGxhY2VtZW50Lmluc2lkZVswXT4+PjhdLm5hbWV9ICR7cmVwbGFjZW1lbnQuaW5zaWRlWzBdLnRvU3RyaW5nKDE2KX0gJHtyZXBsYWNlbWVudC5pbnNpZGVbMV19YCk7XG4gICAgICAgIE1ldGFsb2NhdGlvbi5jb25uZWN0KHJvbSwgaG91c2Uub3V0c2lkZSwgcmVwbGFjZW1lbnQuaW5zaWRlKTtcbiAgICAgICAgLy8gUmVwbGFjZSB0aGUgaWNvblxuICAgICAgICBpZiAoIWZpcnN0KSBjb250aW51ZTtcbiAgICAgICAgaWYgKGljb25zLmdldChob3VzZS50eXBlKSA9PT0gaWNvbnMuZ2V0KHJlcGxhY2VtZW50LnR5cGUpKSBjb250aW51ZTtcbiAgICAgICAgY29uc3Qgb3V0c2lkZSA9IHJvbS5sb2NhdGlvbnNbaG91c2Uub3V0c2lkZVswXSA+Pj4gOF07XG4gICAgICAgIGlmIChvdXRzaWRlID09PSBOYWRhcmUpIGNvbnRpbnVlO1xuICAgICAgICBjb25zdCBleGl0cyA9IE1ldGFsb2NhdGlvbi5maW5kRXhpdFRpbGVzKHJvbSwgaG91c2Uub3V0c2lkZSk7XG4gICAgICAgIGlmIChleGl0cy5sZW5ndGggPiAxKSBjb250aW51ZTtcbiAgICAgICAgbGV0IGNvb3JkID0gZXhpdHNbMF0gLSAweDIwO1xuICAgICAgICBpZiAoKGV4aXRzWzBdICYgMHhmMCkgPCAweDIwKSBjb29yZCAtPSAweDBmMTA7IC8vIGZ1bm55IHZlcnRpY2FsIG1hdGhcbiAgICAgICAgY29uc3QgcG9zID0gY29vcmQgPj4gODtcbiAgICAgICAgY29uc3QgdGlsZSA9IGNvb3JkICYgMHhmZjtcbiAgICAgICAgY29uc3QgaWNvbiA9IGljb25zLmdldChyZXBsYWNlbWVudC50eXBlKSA/P1xuICAgICAgICAgIChvdXRzaWRlLm1ldGEuZ2V0KHBvcykuZGF0YS50YWxsSG91c2VzPy5pbmNsdWRlcyh0aWxlKSA/XG4gICAgICAgICAgIFRBTExfSE9VU0VfSUNPTiA6IEhPVVNFX0lDT04pO1xuICAgICAgICByb20uc2NyZWVuc1tvdXRzaWRlLnNjcmVlbnNbcG9zID4+IDRdW3BvcyAmIDB4Zl1dLnRpbGVzW3RpbGVdID0gaWNvbjtcbiAgICAgIH1cbiAgICAgIGZpcnN0ID0gZmFsc2U7XG4gICAgfVxuICB9XG59XG4iXX0=