import { Buffer } from './buffer.js';
import { Token } from './token.js';
export class Tokenizer {
    constructor(str, file = 'input.s', opts = {}) {
        this.file = file;
        this.opts = opts;
        this.buffer = new Buffer(str);
    }
    next() {
        let tok = this.token();
        while (Token.eq(tok, Token.EOL)) {
            tok = this.token();
        }
        const stack = [[]];
        let depth = 0;
        while (!Token.eq(tok, Token.EOL) && !Token.eq(tok, Token.EOF)) {
            if (Token.eq(tok, Token.LC)) {
                stack[depth++].push(tok);
                stack.push([]);
            }
            else if (Token.eq(tok, Token.RC)) {
                if (!depth)
                    throw new Error(`Missing open curly: ${Token.nameAt(tok)}`);
                const inner = stack.pop();
                const source = stack[--depth].pop().source;
                const token = { token: 'grp', inner };
                if (source)
                    token.source = source;
                stack[depth].push(token);
            }
            else {
                stack[depth].push(tok);
            }
            tok = this.token();
        }
        if (depth) {
            const open = stack[depth - 1].pop();
            throw new Error(`Missing close curly: ${Token.nameAt(open)}`);
        }
        return stack[0].length ? stack[0] : undefined;
    }
    token() {
        while (this.buffer.space() ||
            this.buffer.token(/^;.*/) ||
            (this.opts.lineContinuations && this.buffer.token(/^\\\n/))) { }
        if (this.buffer.eof())
            return Token.EOF;
        const source = {
            file: this.file,
            line: this.buffer.line,
            column: this.buffer.column,
        };
        try {
            const tok = this.tokenInternal();
            if (!this.opts.skipSourceAnnotations)
                tok.source = source;
            return tok;
        }
        catch (err) {
            const { file, line, column } = source;
            let last = this.buffer.group();
            last = last ? ` near '${last}'` : '';
            err.message += `\n  at ${file}:${line}:${column}${last}`;
            throw err;
        }
    }
    tokenInternal() {
        if (this.buffer.newline())
            return { token: 'eol' };
        if (this.buffer.token(/^@+[a-z0-9_]*/i) ||
            this.buffer.token(/^((::)?[a-z_][a-z0-9_]*)+/i)) {
            return this.strTok('ident');
        }
        if (this.buffer.token(/^\.[a-z]+/i))
            return this.strTok('cs');
        if (this.buffer.token(/^:(\++|-+)/))
            return this.strTok('ident');
        if (this.buffer.token(/^(:|\++|-+|&&?|\|\|?|[#*/,=~!^]|<[<>=]?|>[>=]?)/)) {
            return this.strTok('op');
        }
        if (this.buffer.token('['))
            return { token: 'lb' };
        if (this.buffer.token('{'))
            return { token: 'lc' };
        if (this.buffer.token('('))
            return { token: 'lp' };
        if (this.buffer.token(']'))
            return { token: 'rb' };
        if (this.buffer.token('}'))
            return { token: 'rc' };
        if (this.buffer.token(')'))
            return { token: 'rp' };
        if (this.buffer.token(/^["']/))
            return this.tokenizeStr();
        if (this.buffer.token(/^[$%]?[0-9a-z_]+/i))
            return this.tokenizeNum();
        throw new Error(`Syntax error`);
    }
    tokenizeStr() {
        const b = this.buffer;
        const m = b.match();
        const end = m[0];
        let str = '';
        while (!b.lookingAt(end)) {
            if (b.eof())
                throw new Error(`EOF while looking for ${end}`);
            if (b.token(/^\\u([0-9a-f]{4})/i)) {
                str += String.fromCodePoint(parseInt(b.group(1), 16));
            }
            else if (b.token(/^\\x([0-9a-f]{2})/i)) {
                str += String.fromCharCode(parseInt(b.group(1), 16));
            }
            else if (b.token(/^\\(.)/)) {
                str += b.group(1);
            }
            else {
                b.token(/^./);
                str += b.group(0);
            }
        }
        b.token(end);
        return { token: 'str', str };
    }
    strTok(token) {
        return { token, str: this.buffer.group() };
    }
    tokenizeNum(str = this.buffer.group()) {
        if (this.opts.numberSeparators)
            str = str.replace(/_/g, '');
        if (str[0] === '$')
            return parseHex(str.substring(1));
        if (str[0] === '%')
            return parseBin(str.substring(1));
        if (str[0] === '0')
            return parseOct(str);
        return parseDec(str);
    }
}
function parseHex(str) {
    if (!/^[0-9a-f]+$/i.test(str))
        throw new Error(`Bad hex number: $${str}`);
    return { token: 'num', num: Number.parseInt(str, 16) };
}
function parseDec(str) {
    if (!/^[0-9]+$/.test(str))
        throw new Error(`Bad decimal number: ${str}`);
    return { token: 'num', num: Number.parseInt(str, 10) };
}
function parseOct(str) {
    if (!/^[0-7]+$/.test(str))
        throw new Error(`Bad octal number: ${str}`);
    return { token: 'num', num: Number.parseInt(str, 8) };
}
function parseBin(str) {
    if (!/^[01]+$/.test(str))
        throw new Error(`Bad binary number: %${str}`);
    return { token: 'num', num: Number.parseInt(str, 2) };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5pemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL2FzbS90b2tlbml6ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNuQyxPQUFPLEVBQWMsS0FBSyxFQUFjLE1BQU0sWUFBWSxDQUFDO0FBRTNELE1BQU0sT0FBTyxTQUFTO0lBR3BCLFlBQVksR0FBVyxFQUNGLE9BQU8sU0FBUyxFQUNoQixPQUEwQixFQUFFO1FBRDVCLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsU0FBSSxHQUFKLElBQUksQ0FBd0I7UUFDL0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRUQsSUFBSTtRQUNGLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN2QixPQUFPLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUUvQixHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3BCO1FBRUQsTUFBTSxLQUFLLEdBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5QixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzdELElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUMzQixLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3pCLEtBQUss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RSxNQUFNLElBQUksS0FBSyxDQUFDLHVCQUF1QixHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hFLE9BQU8sRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBQyxDQUFDO0FBQ3RELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0J1ZmZlcn0gZnJvbSAnLi9idWZmZXIuanMnO1xuaW1wb3J0IHtTdHJpbmdUb2tlbiwgVG9rZW4sIFRva2VuU291cmNlfSBmcm9tICcuL3Rva2VuLmpzJztcblxuZXhwb3J0IGNsYXNzIFRva2VuaXplciBpbXBsZW1lbnRzIFRva2VuU291cmNlIHtcbiAgcmVhZG9ubHkgYnVmZmVyOiBCdWZmZXI7XG5cbiAgY29uc3RydWN0b3Ioc3RyOiBzdHJpbmcsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IGZpbGUgPSAnaW5wdXQucycsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IG9wdHM6IFRva2VuaXplci5PcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmJ1ZmZlciA9IG5ldyBCdWZmZXIoc3RyKTtcbiAgfVxuXG4gIG5leHQoKTogVG9rZW5bXXx1bmRlZmluZWQge1xuICAgIGxldCB0b2sgPSB0aGlzLnRva2VuKCk7XG4gICAgd2hpbGUgKFRva2VuLmVxKHRvaywgVG9rZW4uRU9MKSkge1xuICAgICAgLy8gU2tpcCBFT0xzIGF0IGJlZ2lubmluZyBvZiBsaW5lLlxuICAgICAgdG9rID0gdGhpcy50b2tlbigpO1xuICAgIH1cbiAgICAvLyBHcm91cCBjdXJseSBicmFjZSBncm91cHMgaW50byBhIHNpbmdsZSBlZmZlY3RpdmUgdG9rZW4uXG4gICAgY29uc3Qgc3RhY2s6IFRva2VuW11bXSA9IFtbXV07XG4gICAgbGV0IGRlcHRoID0gMDtcbiAgICB3aGlsZSAoIVRva2VuLmVxKHRvaywgVG9rZW4uRU9MKSAmJiAhVG9rZW4uZXEodG9rLCBUb2tlbi5FT0YpKSB7XG4gICAgICBpZiAoVG9rZW4uZXEodG9rLCBUb2tlbi5MQykpIHtcbiAgICAgICAgc3RhY2tbZGVwdGgrK10ucHVzaCh0b2spO1xuICAgICAgICBzdGFjay5wdXNoKFtdKTtcbiAgICAgIH0gZWxzZSBpZiAoVG9rZW4uZXEodG9rLCBUb2tlbi5SQykpIHtcbiAgICAgICAgaWYgKCFkZXB0aCkgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIG9wZW4gY3VybHk6ICR7VG9rZW4ubmFtZUF0KHRvayl9YCk7XG4gICAgICAgIGNvbnN0IGlubmVyID0gc3RhY2sucG9wKCkhO1xuICAgICAgICBjb25zdCBzb3VyY2UgPSBzdGFja1stLWRlcHRoXS5wb3AoKSEuc291cmNlO1xuICAgICAgICBjb25zdCB0b2tlbjogVG9rZW4gPSB7dG9rZW46ICdncnAnLCBpbm5lcn07XG4gICAgICAgIGlmIChzb3VyY2UpIHRva2VuLnNvdXJjZSA9IHNvdXJjZTtcbiAgICAgICAgc3RhY2tbZGVwdGhdLnB1c2godG9rZW4pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RhY2tbZGVwdGhdLnB1c2godG9rKTtcbiAgICAgIH1cbiAgICAgIHRvayA9IHRoaXMudG9rZW4oKTtcbiAgICB9XG4gICAgaWYgKGRlcHRoKSB7XG4gICAgICBjb25zdCBvcGVuID0gc3RhY2tbZGVwdGggLSAxXS5wb3AoKSE7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgY2xvc2UgY3VybHk6ICR7VG9rZW4ubmFtZUF0KG9wZW4pfWApO1xuICAgIH1cbiAgICByZXR1cm4gc3RhY2tbMF0ubGVuZ3RoID8gc3RhY2tbMF0gOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIHRva2VuKCk6IFRva2VuIHtcbiAgICAvLyBza2lwIHdoaXRlc3BhY2VcbiAgICB3aGlsZSAodGhpcy5idWZmZXIuc3BhY2UoKSB8fFxuICAgICAgICAgICB0aGlzLmJ1ZmZlci50b2tlbigvXjsuKi8pIHx8XG4gICAgICAgICAgICh0aGlzLm9wdHMubGluZUNvbnRpbnVhdGlvbnMgJiYgdGhpcy5idWZmZXIudG9rZW4oL15cXFxcXFxuLykpKSB7fVxuICAgIGlmICh0aGlzLmJ1ZmZlci5lb2YoKSkgcmV0dXJuIFRva2VuLkVPRjtcblxuICAgIC8vIHJlbWVtYmVyIHBvc2l0aW9uIG9mIG5vbi13aGl0ZXNwYWNlXG4gICAgY29uc3Qgc291cmNlID0ge1xuICAgICAgZmlsZTogdGhpcy5maWxlLFxuICAgICAgbGluZTogdGhpcy5idWZmZXIubGluZSxcbiAgICAgIGNvbHVtbjogdGhpcy5idWZmZXIuY29sdW1uLFxuICAgIH07XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRvayA9IHRoaXMudG9rZW5JbnRlcm5hbCgpO1xuICAgICAgaWYgKCF0aGlzLm9wdHMuc2tpcFNvdXJjZUFubm90YXRpb25zKSB0b2suc291cmNlID0gc291cmNlO1xuICAgICAgcmV0dXJuIHRvaztcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnN0IHtmaWxlLCBsaW5lLCBjb2x1bW59ID0gc291cmNlO1xuICAgICAgbGV0IGxhc3QgPSB0aGlzLmJ1ZmZlci5ncm91cCgpO1xuICAgICAgbGFzdCA9IGxhc3QgPyBgIG5lYXIgJyR7bGFzdH0nYCA6ICcnO1xuICAgICAgZXJyLm1lc3NhZ2UgKz0gYFxcbiAgYXQgJHtmaWxlfToke2xpbmV9OiR7Y29sdW1ufSR7bGFzdH1gO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdG9rZW5JbnRlcm5hbCgpOiBUb2tlbiB7XG4gICAgaWYgKHRoaXMuYnVmZmVyLm5ld2xpbmUoKSkgcmV0dXJuIHt0b2tlbjogJ2VvbCd9O1xuICAgIGlmICh0aGlzLmJ1ZmZlci50b2tlbigvXkArW2EtejAtOV9dKi9pKSB8fFxuICAgICAgICB0aGlzLmJ1ZmZlci50b2tlbigvXigoOjopP1thLXpfXVthLXowLTlfXSopKy9pKSkge1xuICAgICAgcmV0dXJuIHRoaXMuc3RyVG9rKCdpZGVudCcpO1xuICAgIH1cbiAgICBpZiAodGhpcy5idWZmZXIudG9rZW4oL15cXC5bYS16XSsvaSkpIHJldHVybiB0aGlzLnN0clRvaygnY3MnKTtcbiAgICBpZiAodGhpcy5idWZmZXIudG9rZW4oL146KFxcKyt8LSspLykpIHJldHVybiB0aGlzLnN0clRvaygnaWRlbnQnKTtcbiAgICBpZiAodGhpcy5idWZmZXIudG9rZW4oL14oOnxcXCsrfC0rfCYmP3xcXHxcXHw/fFsjKi8sPX4hXl18PFs8Pj1dP3w+Wz49XT8pLykpIHtcbiAgICAgIHJldHVybiB0aGlzLnN0clRvaygnb3AnKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuYnVmZmVyLnRva2VuKCdbJykpIHJldHVybiB7dG9rZW46ICdsYid9O1xuICAgIGlmICh0aGlzLmJ1ZmZlci50b2tlbigneycpKSByZXR1cm4ge3Rva2VuOiAnbGMnfTtcbiAgICBpZiAodGhpcy5idWZmZXIudG9rZW4oJygnKSkgcmV0dXJuIHt0b2tlbjogJ2xwJ307XG4gICAgaWYgKHRoaXMuYnVmZmVyLnRva2VuKCddJykpIHJldHVybiB7dG9rZW46ICdyYid9O1xuICAgIGlmICh0aGlzLmJ1ZmZlci50b2tlbignfScpKSByZXR1cm4ge3Rva2VuOiAncmMnfTtcbiAgICBpZiAodGhpcy5idWZmZXIudG9rZW4oJyknKSkgcmV0dXJuIHt0b2tlbjogJ3JwJ307XG4gICAgaWYgKHRoaXMuYnVmZmVyLnRva2VuKC9eW1wiJ10vKSkgcmV0dXJuIHRoaXMudG9rZW5pemVTdHIoKTtcbiAgICBpZiAodGhpcy5idWZmZXIudG9rZW4oL15bJCVdP1swLTlhLXpfXSsvaSkpIHJldHVybiB0aGlzLnRva2VuaXplTnVtKCk7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTeW50YXggZXJyb3JgKTtcbiAgfVxuXG4gIHByaXZhdGUgdG9rZW5pemVTdHIoKTogVG9rZW4ge1xuICAgIGNvbnN0IGIgPSB0aGlzLmJ1ZmZlcjtcbiAgICBjb25zdCBtID0gYi5tYXRjaCgpITtcbiAgICBjb25zdCBlbmQgPSBtWzBdO1xuICAgIGxldCBzdHIgPSAnJztcbiAgICB3aGlsZSAoIWIubG9va2luZ0F0KGVuZCkpIHtcbiAgICAgIGlmIChiLmVvZigpKSB0aHJvdyBuZXcgRXJyb3IoYEVPRiB3aGlsZSBsb29raW5nIGZvciAke2VuZH1gKTtcbiAgICAgIGlmIChiLnRva2VuKC9eXFxcXHUoWzAtOWEtZl17NH0pL2kpKSB7XG4gICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNvZGVQb2ludChwYXJzZUludChiLmdyb3VwKDEpISwgMTYpKTtcbiAgICAgIH0gZWxzZSBpZiAoYi50b2tlbigvXlxcXFx4KFswLTlhLWZdezJ9KS9pKSkge1xuICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludChiLmdyb3VwKDEpISwgMTYpKTtcbiAgICAgIH0gZWxzZSBpZiAoYi50b2tlbigvXlxcXFwoLikvKSkge1xuICAgICAgICBzdHIgKz0gYi5ncm91cCgxKSE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBiLnRva2VuKC9eLi8pO1xuICAgICAgICBzdHIgKz0gYi5ncm91cCgwKSE7XG4gICAgICB9XG4gICAgfVxuICAgIGIudG9rZW4oZW5kKTtcbiAgICByZXR1cm4ge3Rva2VuOiAnc3RyJywgc3RyfTtcbiAgfVxuXG4gIHByaXZhdGUgc3RyVG9rKHRva2VuOiBTdHJpbmdUb2tlblsndG9rZW4nXSk6IFRva2VuIHtcbiAgICByZXR1cm4ge3Rva2VuLCBzdHI6IHRoaXMuYnVmZmVyLmdyb3VwKCkhfTtcbiAgfVxuXG4gIHByaXZhdGUgdG9rZW5pemVOdW0oc3RyOiBzdHJpbmcgPSB0aGlzLmJ1ZmZlci5ncm91cCgpISk6IFRva2VuIHtcbiAgICBpZiAodGhpcy5vcHRzLm51bWJlclNlcGFyYXRvcnMpIHN0ciA9IHN0ci5yZXBsYWNlKC9fL2csICcnKTtcbiAgICBpZiAoc3RyWzBdID09PSAnJCcpIHJldHVybiBwYXJzZUhleChzdHIuc3Vic3RyaW5nKDEpKTtcbiAgICBpZiAoc3RyWzBdID09PSAnJScpIHJldHVybiBwYXJzZUJpbihzdHIuc3Vic3RyaW5nKDEpKTtcbiAgICBpZiAoc3RyWzBdID09PSAnMCcpIHJldHVybiBwYXJzZU9jdChzdHIpO1xuICAgIHJldHVybiBwYXJzZURlYyhzdHIpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlSGV4KHN0cjogc3RyaW5nKTogVG9rZW4ge1xuICBpZiAoIS9eWzAtOWEtZl0rJC9pLnRlc3Qoc3RyKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgaGV4IG51bWJlcjogJCR7c3RyfWApO1xuICByZXR1cm4ge3Rva2VuOiAnbnVtJywgbnVtOiBOdW1iZXIucGFyc2VJbnQoc3RyLCAxNil9O1xufVxuXG5mdW5jdGlvbiBwYXJzZURlYyhzdHI6IHN0cmluZyk6IFRva2VuIHtcbiAgaWYgKCEvXlswLTldKyQvLnRlc3Qoc3RyKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgZGVjaW1hbCBudW1iZXI6ICR7c3RyfWApO1xuICByZXR1cm4ge3Rva2VuOiAnbnVtJywgbnVtOiBOdW1iZXIucGFyc2VJbnQoc3RyLCAxMCl9O1xufVxuXG5mdW5jdGlvbiBwYXJzZU9jdChzdHI6IHN0cmluZyk6IFRva2VuIHtcbiAgaWYgKCEvXlswLTddKyQvLnRlc3Qoc3RyKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgb2N0YWwgbnVtYmVyOiAke3N0cn1gKTtcbiAgcmV0dXJuIHt0b2tlbjogJ251bScsIG51bTogTnVtYmVyLnBhcnNlSW50KHN0ciwgOCl9O1xufVxuXG5mdW5jdGlvbiBwYXJzZUJpbihzdHI6IHN0cmluZyk6IFRva2VuIHtcbiAgaWYgKCEvXlswMV0rJC8udGVzdChzdHIpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBiaW5hcnkgbnVtYmVyOiAlJHtzdHJ9YCk7XG4gIHJldHVybiB7dG9rZW46ICdudW0nLCBudW06IE51bWJlci5wYXJzZUludChzdHIsIDIpfTtcbn1cblxuZXhwb3J0IG5hbWVzcGFjZSBUb2tlbml6ZXIge1xuICBleHBvcnQgaW50ZXJmYWNlIE9wdGlvbnMge1xuICAgIC8vIGNhc2VJbnNlbnNpdGl2ZT86IGJvb2xlYW47IC8vIGhhbmRsZSBlbHNld2hlcmU/XG4gICAgbGluZUNvbnRpbnVhdGlvbnM/OiBib29sZWFuO1xuICAgIG51bWJlclNlcGFyYXRvcnM/OiBib29sZWFuO1xuICAgIHNraXBTb3VyY2VBbm5vdGF0aW9ucz86IGJvb2xlYW47XG4gIH1cbn1cbiJdfQ==