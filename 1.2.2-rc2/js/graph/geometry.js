import { iters } from '../util.js';
export function TileId(x) { return x; }
(function (TileId) {
    function from({ id }, { x, y }) {
        const xs = x >>> 8;
        const xt = (x >>> 4) & 0xf;
        const ys = y >>> 8;
        const yt = (y >>> 4) & 0xf;
        return (id << 16 | ys << 12 | xs << 8 | yt << 4 | xt);
    }
    TileId.from = from;
    function add(tile, dy, dx) {
        let t = tile;
        if (dy) {
            let y = (t & 0xf0) + (dy << 4);
            while (y >= 0xf0) {
                if ((t & 0xf000) >= 0xf000)
                    return -1;
                y -= 0xf0;
                t += 0x1000;
            }
            while (y < 0) {
                if (!(t & 0xf000))
                    return -1;
                y += 0xf0;
                t -= 0x1000;
            }
            t = t & ~0xf0 | y;
        }
        if (dx) {
            let x = (t & 0xf) + dx;
            while (x >= 0x10) {
                if ((t & 0xf00) >= 0x700)
                    return -1;
                x -= 0x10;
                t += 0x100;
            }
            while (x < 0) {
                if (!(t & 0xf00))
                    return -1;
                x += 0x10;
                t -= 0x100;
            }
            t = t & ~0xf | x;
        }
        return t;
    }
    TileId.add = add;
})(TileId || (TileId = {}));
export function ScreenId(x) { return x; }
(function (ScreenId) {
    ScreenId.from = (tileOrLoc, coord) => {
        if (typeof tileOrLoc === 'number' || !coord) {
            return (Number(tileOrLoc) >>> 8);
        }
        const loc = tileOrLoc;
        return (loc.id << 8 | (coord.y >>> 8) << 4 | coord.x >>> 8);
    };
    function fromTile(tile) {
        return (tile >>> 8);
    }
    ScreenId.fromTile = fromTile;
})(ScreenId || (ScreenId = {}));
export function TilePair(x) { return x; }
(function (TilePair) {
    function of(from, to) {
        return (from * (1 << 24) + to);
    }
    TilePair.of = of;
    function split(pair) {
        return [Math.floor(pair / (1 << 24)),
            pair % (1 << 24)];
    }
    TilePair.split = split;
})(TilePair || (TilePair = {}));
export class Neighbors {
    constructor(tiles, exits) {
        this.tiles = tiles;
        this.exits = exits;
        this.south = new Set();
        this.other = new Set();
    }
    addAdjacent(lo, hi, vertical) {
        const lo1 = this.tiles.find(lo);
        const hi1 = this.tiles.find(hi);
        if (!this.exits.has(hi)) {
            this.other.add(TilePair.of(hi1, lo1));
        }
        if (!this.exits.has(lo)) {
            (vertical ? this.south : this.other).add(TilePair.of(lo1, hi1));
        }
    }
    addExit(from, to) {
        from = this.tiles.find(from);
        to = this.tiles.find(to);
        this.other.add(TilePair.of(from, to));
    }
    *[Symbol.iterator]() {
        const seen = new Set();
        let south = true;
        for (const exit of iters.concat(this.south, [-1], this.other)) {
            if (exit === -1) {
                south = false;
                continue;
            }
            let [from, to] = TilePair.split(exit);
            from = this.tiles.find(from);
            to = this.tiles.find(to);
            const normalized = TilePair.of(from, to);
            if (seen.has(normalized))
                continue;
            seen.add(normalized);
            yield { from, to, south };
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvbWV0cnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvanMvZ3JhcGgvZ2VvbWV0cnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLFlBQVksQ0FBQztBQWFqQyxNQUFNLFVBQVUsTUFBTSxDQUFDLENBQVMsSUFBWSxPQUFPLENBQVcsQ0FBQyxDQUFDLENBQUM7QUFFakUsV0FBaUIsTUFBTTtJQUNyQixTQUFnQixJQUFJLENBQUMsRUFBQyxFQUFFLEVBQVcsRUFBRSxFQUFDLENBQUMsRUFBRSxDQUFDLEVBQWE7UUFDckQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDM0IsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDM0IsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFXLENBQUM7SUFDbEUsQ0FBQztJQU5lLFdBQUksT0FNbkIsQ0FBQTtJQUVELFNBQWdCLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBVSxFQUFFLEVBQVU7UUFDdEQsSUFBSSxDQUFDLEdBQVcsSUFBSSxDQUFDO1FBQ3JCLElBQUksRUFBRSxFQUFFO1lBQ04sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDL0IsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFO2dCQUNoQixJQUFJLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJ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b25kaXRpb24uanMnOyAvLyBOT1RFOiBjeWNsZVxuaW1wb3J0IHtMb2NhdGlvbn0gZnJvbSAnLi4vcm9tL2xvY2F0aW9uLmpzJztcbmltcG9ydCB7VW5pb25GaW5kfSBmcm9tICcuLi91bmlvbmZpbmQuanMnO1xuaW1wb3J0IHtpdGVyc30gZnJvbSAnLi4vdXRpbC5qcyc7XG5cbi8vIEltcGxlbWVudGVkIGJ5IEVudHJhbmNlLCBFeGl0LCBTcGF3biwgZXRjLi4uXG5pbnRlcmZhY2UgQ29vcmRpbmF0ZSB7XG4gIHg6IG51bWJlcjtcbiAgeTogbnVtYmVyO1xufVxuXG4vLyAyNC1iaXQgdW5pcXVlIElEIGZvciBhIHNpbmdsZSB0aWxlOlxuLy8gICBMTExMTExMTCBZWVlZWFhYWCB5eXl5eHh4eFxuLy8gd2hlcmUgTCBpcyA4LWJpdCBsb2NhdGlvbiBJRCwgKFksIFgpIGlzIHNjcmVlbiwgYW5kICh5LCB4KSBpcyB0aWxlLlxuZXhwb3J0IHR5cGUgVGlsZUlkID0gbnVtYmVyICYge19fdGlsZUlkX186IG5ldmVyfTtcblxuZXhwb3J0IGZ1bmN0aW9uIFRpbGVJZCh4OiBudW1iZXIpOiBUaWxlSWQgeyByZXR1cm4geCBhcyBUaWxlSWQ7IH1cblxuZXhwb3J0IG5hbWVzcGFjZSBUaWxlSWQge1xuICBleHBvcnQgZnVuY3Rpb24gZnJvbSh7aWR9OiBMb2NhdGlvbiwge3gsIHl9OiBDb29yZGluYXRlKTogVGlsZUlkIHtcbiAgICBjb25zdCB4cyA9IHggPj4+IDg7XG4gICAgY29uc3QgeHQgPSAoeCA+Pj4gNCkgJiAweGY7XG4gICAgY29uc3QgeXMgPSB5ID4+PiA4O1xuICAgIGNvbnN0IHl0ID0gKHkgPj4+IDQpICYgMHhmO1xuICAgIHJldHVybiAoaWQgPDwgMTYgfCB5cyA8PCAxMiB8IHhzIDw8IDggfCB5dCA8PCA0IHwgeHQpIGFzIFRpbGVJZDtcbiAgfVxuXG4gIGV4cG9ydCBmdW5jdGlvbiBhZGQodGlsZTogVGlsZUlkLCBkeTogbnVtYmVyLCBkeDogbnVtYmVyKTogVGlsZUlkIHtcbiAgICBsZXQgdDogbnVtYmVyID0gdGlsZTtcbiAgICBpZiAoZHkpIHtcbiAgICAgIGxldCB5ID0gKHQgJiAweGYwKSArIChkeSA8PCA0KTtcbiAgICAgIHdoaWxlICh5ID49IDB4ZjApIHtcbiAgICAgICAgaWYgKCh0ICYgMHhmMDAwKSA+PSAweGYwMDApIHJldHVybiAtMSBhcyBUaWxlSWQ7XG4gICAgICAgIHkgLT0gMHhmMDtcbiAgICAgICAgdCArPSAweDEwMDA7XG4gICAgICB9XG4gICAgICB3aGlsZSAoeSA8IDApIHtcbiAgICAgICAgaWYgKCEodCAmIDB4ZjAwMCkpIHJldHVybiAtMSBhcyBUaWxlSWQ7XG4gICAgICAgIHkgKz0gMHhmMFxuICAgICAgICB0IC09IDB4MTAwMDtcbiAgICAgIH1cbiAgICAgIHQgPSB0ICYgfjB4ZjAgfCB5O1xuICAgIH1cbiAgICBpZiAoZHgpIHtcbiAgICAgIGxldCB4ID0gKHQgJiAweGYpICsgZHg7XG4gICAgICB3aGlsZSAoeCA+PSAweDEwKSB7XG4gICAgICAgIGlmICgodCAmIDB4ZjAwKSA+PSAweDcwMCkgcmV0dXJuIC0xIGFzIFRpbGVJZDtcbiAgICAgICAgeCAtPSAweDEwO1xuICAgICAgICB0ICs9IDB4MTAwO1xuICAgICAgfVxuICAgICAgd2hpbGUgKHggPCAwKSB7XG4gICAgICAgIGlmICghKHQgJiAweGYwMCkpIHJldHVybiAtMSBhcyBUaWxlSWQ7XG4gICAgICAgIHggKz0gMHgxMFxuICAgICAgICB0IC09IDB4MTAwO1xuICAgICAgfVxuICAgICAgdCA9IHQgJiB+MHhmIHwgeDtcbiAgICB9XG4gICAgcmV0dXJuIHQgYXMgVGlsZUlkO1xuICB9XG59XG5cbi8vIDE2LWJpdCB1bmlxdWUgSUQgZm9yIGEgc2luZ2xlIHNjcmVlbjpcbi8vICAgTExMTExMTEwgWVlZWVhYWFhcbi8vIHdoZXJlIEwgaXMgOC1iaXQgbG9jYXRpb24gSUQsIChZLCBYKSBpcyBzY3JlZW4uXG5leHBvcnQgdHlwZSBTY3JlZW5JZCA9IG51bWJlciAmIHtfX3NjcmVlbklkX186IG5ldmVyfTtcblxuZXhwb3J0IGZ1bmN0aW9uIFNjcmVlbklkKHg6IG51bWJlcik6IFNjcmVlbklkIHsgcmV0dXJuIHggYXMgU2NyZWVuSWQ7IH1cblxuZXhwb3J0IG5hbWVzcGFjZSBTY3JlZW5JZCB7XG4gIGV4cG9ydCBjb25zdCBmcm9tOiB7KHRpbGU6IFRpbGVJZCk6IFNjcmVlbklkO1xuICAgICAgICAgICAgICAgICAgICAgIChsb2M6IExvY2F0aW9uLCBjb29yZGluOiBDb29yZGluYXRlKTogU2NyZWVuSWR9ID1cbiAgICAodGlsZU9yTG9jOiBUaWxlSWQgfCBMb2NhdGlvbiwgY29vcmQ/OiBDb29yZGluYXRlKTogU2NyZWVuSWQgPT4ge1xuICAgICAgaWYgKHR5cGVvZiB0aWxlT3JMb2MgPT09ICdudW1iZXInIHx8ICFjb29yZCkge1xuICAgICAgICByZXR1cm4gKE51bWJlcih0aWxlT3JMb2MpID4+PiA4KSBhcyBTY3JlZW5JZDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGxvYyA9IHRpbGVPckxvYyBhcyBMb2NhdGlvbjtcbiAgICAgIHJldHVybiAobG9jLmlkIDw8IDggfCAoY29vcmQueSA+Pj4gOCkgPDwgNCB8IGNvb3JkLnggPj4+IDgpIGFzIFNjcmVlbklkO1xuICAgIH07XG4gIGV4cG9ydCBmdW5jdGlvbiBmcm9tVGlsZSh0aWxlOiBUaWxlSWQpOiBTY3JlZW5JZCB7XG4gICAgcmV0dXJuICh0aWxlID4+PiA4KSBhcyBTY3JlZW5JZDtcbiAgfVxufVxuXG4vLyA0OC1iaXQgY29ubmVjdGlvbiBiZXR3ZWVuIHR3byB0aWxlcy5cbmV4cG9ydCB0eXBlIFRpbGVQYWlyID0gbnVtYmVyICYge19fdGlsZVBhaXJfXzogbmV2ZXJ9O1xuXG5leHBvcnQgZnVuY3Rpb24gVGlsZVBhaXIoeDogbnVtYmVyKTogVGlsZVBhaXIgeyByZXR1cm4geCBhcyBUaWxlUGFpcjsgfVxuXG5leHBvcnQgbmFtZXNwYWNlIFRpbGVQYWlyIHtcbiAgZXhwb3J0IGZ1bmN0aW9uIG9mKGZyb206IFRpbGVJZCwgdG86IFRpbGVJZCk6IFRpbGVQYWlyIHtcbiAgICByZXR1cm4gKGZyb20gKiAoMSA8PCAyNCkgKyB0bykgYXMgVGlsZVBhaXI7XG4gIH1cblxuICBleHBvcnQgZnVuY3Rpb24gc3BsaXQocGFpcjogVGlsZVBhaXIpOiBbVGlsZUlkLCBUaWxlSWRdIHtcbiAgICByZXR1cm4gW01hdGguZmxvb3IocGFpciAvICgxIDw8IDI0KSkgYXMgVGlsZUlkLFxuICAgICAgICAgICAgcGFpciAlICgxIDw8IDI0KSBhcyBUaWxlSWRdO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBOZWlnaGJvcnMge1xuICAvLyBoaWdoIDI0ID0gZnJvbSwgbG93IDI0ID0gdG9cbiAgcHJpdmF0ZSByZWFkb25seSBzb3V0aCA9IG5ldyBTZXQ8VGlsZVBhaXI+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgb3RoZXIgPSBuZXcgU2V0PFRpbGVQYWlyPigpO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHRpbGVzOiBVbmlvbkZpbmQ8VGlsZUlkPiwgcHJpdmF0ZSByZWFkb25seSBleGl0czogU2V0PFRpbGVJZD4pIHt9XG5cbiAgLy8gTk9URTogbG8gPCBoaSBpcyByZXF1aXJlZCwgc28gdGhhdCBsby0+aGkgaXMgc291dGggaWYgdmVydGljYWxcbiAgYWRkQWRqYWNlbnQobG86IFRpbGVJZCwgaGk6IFRpbGVJZCwgdmVydGljYWw6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBjb25zdCBsbzEgPSB0aGlzLnRpbGVzLmZpbmQobG8pO1xuICAgIGNvbnN0IGhpMSA9IHRoaXMudGlsZXMuZmluZChoaSk7XG4gICAgaWYgKCF0aGlzLmV4aXRzLmhhcyhoaSkpIHtcbiAgICAgIHRoaXMub3RoZXIuYWRkKFRpbGVQYWlyLm9mKGhpMSwgbG8xKSk7XG4gICAgfVxuICAgIGlmICghdGhpcy5leGl0cy5oYXMobG8pKSB7XG4gICAgICAodmVydGljYWwgPyB0aGlzLnNvdXRoIDogdGhpcy5vdGhlcikuYWRkKFRpbGVQYWlyLm9mKGxvMSwgaGkxKSk7XG4gICAgfVxuICB9XG5cbiAgYWRkRXhpdChmcm9tOiBUaWxlSWQsIHRvOiBUaWxlSWQpOiB2b2lkIHtcbiAgICBmcm9tID0gdGhpcy50aWxlcy5maW5kKGZyb20pO1xuICAgIHRvID0gdGhpcy50aWxlcy5maW5kKHRvKTtcbiAgICB0aGlzLm90aGVyLmFkZChUaWxlUGFpci5vZihmcm9tLCB0bykpO1xuICB9XG5cbiAgKiBbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPHtmcm9tOiBUaWxlSWQsIHRvOiBUaWxlSWQsIHNvdXRoOiBib29sZWFufT4ge1xuICAgIGNvbnN0IHNlZW4gPSBuZXcgU2V0KCk7XG4gICAgbGV0IHNvdXRoID0gdHJ1ZTtcbiAgICBmb3IgKGNvbnN0IGV4aXQgb2YgaXRlcnMuY29uY2F0KHRoaXMuc291dGgsIFstMSBhcyBUaWxlUGFpcl0sIHRoaXMub3RoZXIpKSB7XG4gICAgICBpZiAoZXhpdCA9PT0gLTEpIHtcbiAgICAgICAgc291dGggPSBmYWxzZTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBsZXQgW2Zyb20sIHRvXSA9IFRpbGVQYWlyLnNwbGl0KGV4aXQpO1xuICAgICAgZnJvbSA9IHRoaXMudGlsZXMuZmluZChmcm9tKTtcbiAgICAgIHRvID0gdGhpcy50aWxlcy5maW5kKHRvKTtcbiAgICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBUaWxlUGFpci5vZihmcm9tLCB0byk7XG4gICAgICBpZiAoc2Vlbi5oYXMobm9ybWFsaXplZCkpIGNvbnRpbnVlO1xuICAgICAgc2Vlbi5hZGQobm9ybWFsaXplZCk7XG4gICAgICB5aWVsZCB7ZnJvbSwgdG8sIHNvdXRofTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBHZW9tZXRyeSB7XG4gIHRlcnJhaW5zOiBNYXA8VGlsZUlkLCBUZXJyYWluPjtcbiAgZG9tYWluczogVW5pb25GaW5kPFRpbGVJZD47XG4gIGVkZ2VzOiBJdGVyYWJsZTxbVGlsZUlkLCBUaWxlSWQsIGJvb2xlYW5dPjtcbn1cblxuLy8gdHlwZSBCdWlsZEdlb21ldHJ5ID0gKHJvbTogUm9tLCBvdmVybGF5OiBPdmVybGF5KSA9PiBHZW9tZXRyeTtcbi8vIHR5cGUgQ29tcHV0ZVJvdXRlcyA9IChnOiBHZW9tZXRyeSkgPT4gUm91dGVzO1xuLy8gdHlwZSBSb3V0ZXMgPSBNYXA8VGlsZUlkLCBNdXRhYmxlUmVxdWlyZW1lbnQ+O1xuLy8gdHlwZSBBZGRDaGVja3MgPSAoZzogR2VvbWV0cnksIHI6IFJvdXRlcywgY2hlY2tzOiBDaGVja1tdKTogR3JhcGg7XG5cbi8vIHByb2JhYmx5IGNvbWJpbmUgZ2VvbWV0cnkgYW5kIGNvbmRpdGlvbiBpbnRvIGZpbGVzIHR5cGVzLlxuLy8gdGhlbiBnZW9tZXRyeSB3aWxsIGhhdmUgZ2VvbWV0cnkgYW5kIHRoZXNlIGZ1bmN0aW9uc1xuLy8gLT4gV29ybGQ/IChtYXliZSBSb3V0ZXMgPT4gV29ybGQpXG4iXX0=