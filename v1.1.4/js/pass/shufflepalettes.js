import { paletteTypes } from '../rom/tileset.js';
import { seq } from '../rom/util.js';
export function shufflePalettes(rom, flags, random) {
    new Shuffle(rom, flags, random).shuffle();
}
class Shuffle {
    constructor(rom, flags, random) {
        this.rom = rom;
        this.flags = flags;
        this.random = random;
    }
    shuffle() {
        this.shuffleBackgrounds();
    }
    shuffleBackgrounds() {
        if (!this.flags.shuffleSpritePalettes())
            return;
        function eq(a, b) {
            return a.tilePalettes[0] === b.tilePalettes[0] &&
                a.tilePalettes[1] === b.tilePalettes[1] &&
                a.tilePalettes[2] === b.tilePalettes[2] &&
                a.tileEffects === b.tileEffects;
        }
        const partitions = this.rom.locations.partition(x => x, eq, true);
        const pal = [new Map(), new Map()];
        for (const part of partitions) {
            const l = part[1];
            for (let i = 0; i < 2; i++) {
                for (let j = 0; j < 2; j++) {
                    let set = pal[i].get(l.tilePatterns[j]);
                    if (!set)
                        pal[i].set(l.tilePatterns[j], set = new Set());
                    set.add(l.tilePalettes[i]);
                }
            }
        }
        for (const part of partitions) {
            const l = part[1];
            const s = [new Set(), new Set()];
            for (let i = 0; i < 2; i++) {
                s[i] = new Set([...pal[i].get(l.tilePatterns[0]),
                    ...pal[i].get(l.tilePatterns[1]),]);
            }
            const p0 = this.random.pick([...s[0]]);
            const p1 = this.random.pick([...s[1]]);
            for (const loc of part[0]) {
                loc.tilePalettes[0] = p0;
                loc.tilePalettes[1] = p1;
            }
        }
    }
    shuffleBackgrounds2() {
        if (!this.flags.shuffleSpritePalettes())
            return;
        function eq(a, b) {
            return a.tilePalettes[0] === b.tilePalettes[0] &&
                a.tilePalettes[1] === b.tilePalettes[1] &&
                a.tilePalettes[2] === b.tilePalettes[2];
        }
        const paletteSets = [new Set(), new Set()];
        for (const loc of this.rom.locations) {
            if (!loc.used)
                continue;
            const tileset = this.rom.tilesets[(loc.tileset & 0x7f) >> 2];
            const types = paletteTypes(tileset.id, loc.id);
            for (let i = 0; i < 3; i++) {
                for (let i = 0; i < types[i]; i++) {
                    paletteSets[i].add(loc.tilePalettes[i]);
                }
            }
        }
        const partitions = this.rom.locations.partition(x => x, eq, true);
        const palettes = paletteSets.map(s => [...s]);
        for (const part of partitions) {
            const rep = part[1];
            const repTypes = paletteTypes(rep.tileset, rep.id);
            for (let attempt = 0; attempt < 1000; attempt++) {
                const pals = seq(3, i => !repTypes[i] ? rep.tilePalettes[i] :
                    this.random.pick(palettes[repTypes[i] - 1]));
                const ps = pals.map(p => this.rom.palettes[p].colors);
                let found = true;
                for (const loc of part[0]) {
                    const [, , , validator] = paletteTypes(loc.tileset, loc.id);
                    if (validator && !validator(ps[0], ps[1], ps[2])) {
                        found = false;
                        break;
                    }
                }
                if (found) {
                    for (const loc of part[0]) {
                        loc.tilePalettes = [pals[0], pals[1], pals[2]];
                    }
                }
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZXBhbGV0dGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Bhc3Mvc2h1ZmZsZXBhbGV0dGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUMvQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFHbkMsTUFBTSxVQUFVLGVBQWUsQ0FBQyxHQUFRLEVBQUUsS0FBYyxFQUFFLE1BQWM7SUFDdEUsSUFBSSxPQUFPLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM1QyxDQUFDO0FBRUQsTUFBTSxPQUFPO0lBQ1gsWUFBcUIsR0FBUSxFQUNSLEtBQWMsRUFDZCxNQUFjO1FBRmQsUUFBRyxHQUFILEdBQUcsQ0FBSztRQUNSLFVBQUssR0FBTCxLQUFLLENBQVM7UUFDZCxXQUFNLEdBQU4sTUFBTSxDQUFRO0lBQUcsQ0FBQztJQUV2QyxPQUFPO1FBQ0wsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELGtCQUFrQjtRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRTtZQUFFLE9BQU87UUFFaEQsU0FBUyxFQUFFLENBQUMsQ0FBVyxFQUFFLENBQVc7WUFDbEMsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUMxQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUN2QyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUl2QyxDQUFDLENBQUMsV0FBVyxLQUFLLENBQUMs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QyxDQUFDLENBQUMsQ0FBQyxFQUFFO3dCQUNoRCxLQUFLLEdBQUcsS0FBSyxDQUFDO3dCQUNkLE1BQU07cUJBQ1A7aUJBQ0Y7Z0JBQ0QsSUFBSSxLQUFLLEVBQUU7b0JBQ1QsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQ3pCLEdBQUcsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUNoRDtpQkFDRjthQUNGO1NBQ0Y7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0ZsYWdTZXR9IGZyb20gJy4uL2ZsYWdzZXQuanMnO1xuaW1wb3J0IHtSYW5kb219IGZyb20gJy4uL3JhbmRvbS5qcyc7XG5pbXBvcnQge1JvbX0gZnJvbSAnLi4vcm9tLmpzJztcbmltcG9ydCB7TG9jYXRpb259IGZyb20gJy4uL3JvbS9sb2NhdGlvbi5qcyc7XG5pbXBvcnQge3BhbGV0dGVUeXBlc30gZnJvbSAnLi4vcm9tL3RpbGVzZXQuanMnO1xuaW1wb3J0IHtzZXF9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcblxuLy8gU2h1ZmZsZSB0aGUgcGFsZXR0ZXMuXG5leHBvcnQgZnVuY3Rpb24gc2h1ZmZsZVBhbGV0dGVzKHJvbTogUm9tLCBmbGFnczogRmxhZ1NldCwgcmFuZG9tOiBSYW5kb20pIHtcbiAgbmV3IFNodWZmbGUocm9tLCBmbGFncywgcmFuZG9tKS5zaHVmZmxlKCk7XG59XG5cbmNsYXNzIFNodWZmbGUge1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSByb206IFJvbSxcbiAgICAgICAgICAgICAgcmVhZG9ubHkgZmxhZ3M6IEZsYWdTZXQsXG4gICAgICAgICAgICAgIHJlYWRvbmx5IHJhbmRvbTogUmFuZG9tKSB7fVxuXG4gIHNodWZmbGUoKSB7XG4gICAgdGhpcy5zaHVmZmxlQmFja2dyb3VuZHMoKTtcbiAgfVxuXG4gIHNodWZmbGVCYWNrZ3JvdW5kcygpIHtcbiAgICBpZiAoIXRoaXMuZmxhZ3Muc2h1ZmZsZVNwcml0ZVBhbGV0dGVzKCkpIHJldHVybjtcblxuICAgIGZ1bmN0aW9uIGVxKGE6IExvY2F0aW9uLCBiOiBMb2NhdGlvbik6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuIGEudGlsZVBhbGV0dGVzWzBdID09PSBiLnRpbGVQYWxldHRlc1swXSAmJlxuICAgICAgICAgIGEudGlsZVBhbGV0dGVzWzFdID09PSBiLnRpbGVQYWxldHRlc1sxXSAmJlxuICAgICAgICAgIGEudGlsZVBhbGV0dGVzWzJdID09PSBiLnRpbGVQYWxldHRlc1syXSAmJlxuICAgICAgICAgIC8vIGEudGlsZVBhdHRlcm5zWzBdID09PSBiLnRpbGVQYXR0ZXJuc1swXSAmJlxuICAgICAgICAgIC8vIGEudGlsZVBhdHRlcm5zWzFdID09PSBiLnRpbGVQYXR0ZXJuc1sxXSAmJlxuICAgICAgICAgIC8vIGEudGlsZXNldCA9PT0gYi50aWxlc2V0ICYmXG4gICAgICAgICAgYS50aWxlRWZmZWN0cyA9PT0gYi50aWxlRWZmZWN0cztcbiAgICB9XG5cbiAgICAvLyBjb25zdCBwYWxldHRlcyA9IFtcbiAgICAvLyAgIDB4MDEsIDB4MDcsIFxuXG4gICAgLy8gLy8gS2V5OiAodGlsZUlkL3NjcmVlbklkKSA8PCA4IHwgdGlsZXNldFxuICAgIC8vIC8vIFZhbHVlOiBTZXQ8fnBhdHRlcm4gfCBwYWxldHRlPlxuICAgIC8vIGNvbnN0IHRpbGVDYWNoZSA9IG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKTtcbiAgICAvLyBjb25zdCBzY3JlZW5DYWNoZSA9IG5ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKTtcblxuICAgIC8vIGZ1bmN0aW9uIHNjcmVlbkRhdGEoc2NyZWVuOiBudW1iZXIsIHRpbGVzZXQ6IG51bWJlcikge1xuXG4gICAgLy8gfVxuXG4gICAgLy8gZm9yIChjb25zdCBsb2Mgb2Ygcm9tLmxvY2F0aW9ucykge1xuICAgIC8vICAgaWYgKCFsb2MudXNlZCkgY29udGludWU7XG4gICAgLy8gICBjb25zdCB0aWxlc2V0ID0gcm9tLnRpbGVzZXRzWyhsb2MudGlsZXNldCAmIDB4N2YpID4+IDJdO1xuICAgIC8vICAgZm9yIChjb25zdCBzY3JlZW4gb2YgbG9jLmFsbFNjcmVlbnMoKSkge1xuICAgIC8vICAgICBjb25zdCBncmFwaGljcyA9IG5ldyBTZXQoKTtcbiAgICAvLyAgICAgZm9yIChjb25zdCB0aWxlIG9mIHNjcmVlbi50aWxlcykge1xuICAgIC8vICAgICAgIGNvbnN0IHRpbGVJZCA9IHRpbGUgPDwgOCB8IHRpbGVzZXQuaWQ7XG4gICAgLy8gICAgICAgY29uc3QgcHJldiA9IHRpbGVDYWNoZS5nZXQodGlsZUlkKTtcbiAgICAvLyAgICAgICBpZiAocHJldikge1xuICAgIC8vICAgICAgICAgZm9yIChjb25zdCBnIG9mIHByZXYpIGdyYXBoaWNzLmFkZChnKTtcbiAgICAvLyAgICAgICAgIGNvbnRpbnVlO1xuICAgIC8vICAgICAgIH1cbiAgICAvLyAgICAgICBjb25zdCBzZXQgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICAvLyAgICAgICBmb3IgKGNvbnN0IHF1YWQgb2YgdGlsZXNldC50aWxlcykge1xuICAgIC8vICAgICAgICAgc2V0LmFkZCh+cXVhZFt0aWxlXSk7XG4gICAgLy8gICAgICAgICBncmFwaGljcy5hZGQofnF1YWRbdGlsZV0pO1xuICAgIC8vICAgICAgIH1cbiAgICAvLyAgICAgICBzZXQuYWRkKHRpbGVzZXQuYXR0cnNbdGlsZV0pO1xuICAgIC8vICAgICAgIGdyYXBoaWNzLmFkZCh0aWxlc2V0LmF0dHJzW3RpbGVdKTtcbiAgICAvLyAgICAgICB0aWxlQ2FjaGUuc2V0KHRpbGVJZCwgc2V0KTtcbiAgICAvLyAgICAgfVxuICAgIC8vICAgfVxuICAgIC8vIH1cblxuICAgIGNvbnN0IHBhcnRpdGlvbnMgPSB0aGlzLnJvbS5sb2NhdGlvbnMucGFydGl0aW9uKHggPT4geCwgZXEsIHRydWUpO1xuXG4gICAgY29uc3QgcGFsID0gW25ldyBNYXA8bnVtYmVyLCBTZXQ8bnVtYmVyPj4oKSwgbmV3IE1hcDxudW1iZXIsIFNldDxudW1iZXI+PigpXTtcblxuICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0aXRpb25zKSB7XG4gICAgICBjb25zdCBsID0gcGFydFsxXTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjsgaSsrKSB7XG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMjsgaisrKSB7XG4gICAgICAgICAgLy8gVE9ETyAtIGNoZWNrIHRoYXQgcGF0dGVybnMgYW5kIHBhbGV0dGVzIGFjdHVhbGx5IFVTRUQ/XG4gICAgICAgICAgbGV0IHNldCA9IHBhbFtpXS5nZXQobC50aWxlUGF0dGVybnNbal0pO1xuICAgICAgICAgIGlmICghc2V0KSBwYWxbaV0uc2V0KGwudGlsZVBhdHRlcm5zW2pdLCBzZXQgPSBuZXcgU2V0KCkpO1xuICAgICAgICAgIHNldC5hZGQobC50aWxlUGFsZXR0ZXNbaV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhcnRpdGlvbnMpIHtcbiAgICAgIGNvbnN0IGwgPSBwYXJ0WzFdO1xuICAgICAgY29uc3QgcyA9IFtuZXcgU2V0PG51bWJlcj4oKSwgbmV3IFNldDxudW1iZXI+KCldO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyOyBpKyspIHtcbiAgICAgICAgc1tpXSA9IG5ldyBTZXQ8bnVtYmVyPihbLi4ucGFsW2ldLmdldChsLnRpbGVQYXR0ZXJuc1swXSkhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5wYWxbaV0uZ2V0KGwudGlsZVBhdHRlcm5zWzFdKSEsXSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHAwID0gdGhpcy5yYW5kb20ucGljayhbLi4uc1swXV0pO1xuICAgICAgY29uc3QgcDEgPSB0aGlzLnJhbmRvbS5waWNrKFsuLi5zWzFdXSk7XG4gICAgICBmb3IgKGNvbnN0IGxvYyBvZiBwYXJ0WzBdKSB7XG4gICAgICAgIGxvYy50aWxlUGFsZXR0ZXNbMF0gPSBwMDtcbiAgICAgICAgbG9jLnRpbGVQYWxldHRlc1sxXSA9IHAxO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIFRPRE8gLSB0aGlzIGFsZ29yaXRobSBpcyBtdWNoIGxlc3Mgc2F0aXNmeWluZy5cbiAgc2h1ZmZsZUJhY2tncm91bmRzMigpIHtcbiAgICBpZiAoIXRoaXMuZmxhZ3Muc2h1ZmZsZVNwcml0ZVBhbGV0dGVzKCkpIHJldHVybjtcblxuICAgIGZ1bmN0aW9uIGVxKGE6IExvY2F0aW9uLCBiOiBMb2NhdGlvbik6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuIGEudGlsZVBhbGV0dGVzWzBdID09PSBiLnRpbGVQYWxldHRlc1swXSAmJlxuICAgICAgICAgIGEudGlsZVBhbGV0dGVzWzFdID09PSBiLnRpbGVQYWxldHRlc1sxXSAmJlxuICAgICAgICAgIGEudGlsZVBhbGV0dGVzWzJdID09PSBiLnRpbGVQYWxldHRlc1syXTtcbiAgICAgICAgICAvLyBhLnRpbGVQYXR0ZXJuc1swXSA9PT0gYi50aWxlUGF0dGVybnNbMF0gJiZcbiAgICAgICAgICAvLyBhLnRpbGVQYXR0ZXJuc1sxXSA9PT0gYi50aWxlUGF0dGVybnNbMV0gJiZcbiAgICAgICAgICAvLyBhLnRpbGVzZXQgPT09IGIudGlsZXNldCAmJlxuICAgICAgICAgIC8vIGEudGlsZUVmZmVjdHMgPT09IGIudGlsZUVmZmVjdHM7XG4gICAgfVxuXG4gICAgLy8gY29uc3QgcGFsZXR0ZXMgPSBbXG4gICAgLy8gICAweDAxLCAweDA3LCBcblxuICAgIC8vIC8vIEtleTogKHRpbGVJZC9zY3JlZW5JZCkgPDwgOCB8IHRpbGVzZXRcbiAgICAvLyAvLyBWYWx1ZTogU2V0PH5wYXR0ZXJuIHwgcGFsZXR0ZT5cbiAgICAvLyBjb25zdCB0aWxlQ2FjaGUgPSBuZXcgTWFwPG51bWJlciwgU2V0PG51bWJlcj4+KCk7XG4gICAgLy8gY29uc3Qgc2NyZWVuQ2FjaGUgPSBuZXcgTWFwPG51bWJlciwgU2V0PG51bWJlcj4+KCk7XG5cbiAgICAvLyBmdW5jdGlvbiBzY3JlZW5EYXRhKHNjcmVlbjogbnVtYmVyLCB0aWxlc2V0OiBudW1iZXIpIHtcblxuICAgIC8vIH1cblxuICAgIGNvbnN0IHBhbGV0dGVTZXRzID0gW25ldyBTZXQ8bnVtYmVyPigpLCBuZXcgU2V0PG51bWJlcj4oKV07XG5cbiAgICBmb3IgKGNvbnN0IGxvYyBvZiB0aGlzLnJvbS5sb2NhdGlvbnMpIHtcbiAgICAgIGlmICghbG9jLnVzZWQpIGNvbnRpbnVlO1xuICAgICAgY29uc3QgdGlsZXNldCA9IHRoaXMucm9tLnRpbGVzZXRzWyhsb2MudGlsZXNldCAmIDB4N2YpID4+IDJdO1xuICAgICAgY29uc3QgdHlwZXMgPSBwYWxldHRlVHlwZXModGlsZXNldC5pZCwgbG9jLmlkKTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgKHR5cGVzW2ldIGFzIG51bWJlcik7IGkrKykge1xuICAgICAgICAgIHBhbGV0dGVTZXRzW2ldLmFkZChsb2MudGlsZVBhbGV0dGVzW2ldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHBhcnRpdGlvbnMgPSB0aGlzLnJvbS5sb2NhdGlvbnMucGFydGl0aW9uKHggPT4geCwgZXEsIHRydWUpO1xuXG4gICAgY29uc3QgcGFsZXR0ZXMgPSBwYWxldHRlU2V0cy5tYXAocyA9PiBbLi4uc10pO1xuICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0aXRpb25zKSB7XG4gICAgICBjb25zdCByZXAgPSBwYXJ0WzFdOyAvLyByZXByZXNlbnRhdGl2ZSBsb2NhdGlvblxuICAgICAgY29uc3QgcmVwVHlwZXM6IG51bWJlcltdID0gcGFsZXR0ZVR5cGVzKHJlcC50aWxlc2V0LCByZXAuaWQpIGFzIGFueTtcbiAgICAgIGZvciAobGV0IGF0dGVtcHQgPSAwOyBhdHRlbXB0IDwgMTAwMDsgYXR0ZW1wdCsrKSB7XG4gICAgICAgIGNvbnN0IHBhbHMgPSBzZXEoMywgaSA9PiAhcmVwVHlwZXNbaV0gPyByZXAudGlsZVBhbGV0dGVzW2ldIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJhbmRvbS5waWNrKHBhbGV0dGVzW3JlcFR5cGVzW2ldIC0gMV0pKTtcbiAgICAgICAgY29uc3QgcHMgPSBwYWxzLm1hcChwID0+IHRoaXMucm9tLnBhbGV0dGVzW3BdLmNvbG9ycyk7XG4gICAgICAgIGxldCBmb3VuZCA9IHRydWU7XG4gICAgICAgIGZvciAoY29uc3QgbG9jIG9mIHBhcnRbMF0pIHtcbiAgICAgICAgICBjb25zdCBbLCwsIHZhbGlkYXRvcl0gPSBwYWxldHRlVHlwZXMobG9jLnRpbGVzZXQsIGxvYy5pZCk7XG4gICAgICAgICAgaWYgKHZhbGlkYXRvciAmJiAhdmFsaWRhdG9yKHBzWzBdLCBwc1sxXSwgcHNbMl0pKSB7XG4gICAgICAgICAgICBmb3VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChmb3VuZCkge1xuICAgICAgICAgIGZvciAoY29uc3QgbG9jIG9mIHBhcnRbMF0pIHtcbiAgICAgICAgICAgIGxvYy50aWxlUGFsZXR0ZXMgPSBbcGFsc1swXSwgcGFsc1sxXSwgcGFsc1syXV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=