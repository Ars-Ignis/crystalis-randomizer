import { Bits } from '../bits.js';
import { seq } from '../rom/util.js';
import { iters } from '../util.js';
class GenericFill {
    constructor() {
        this.slots = [];
        this.items = [];
    }
    set(slot, item) {
        if (this.slots[slot] != null)
            throw new Error(`already filled slot ${slot}`);
        if (this.items[item] != null)
            throw new Error(`already filled item ${item}`);
        this.slots[slot] = item;
        this.items[item] = slot;
    }
    hasSlot(slot) {
        return this.slots[slot] != null;
    }
    hasItem(item) {
        return this.items[item] != null;
    }
}
function expandFill(g, f) {
    const out = new GenericFill();
    for (let i = g.fixed; i < g.items.length; i++) {
        const s = f.items[i];
        out.set(g.slots[s].item, g.items[i].item);
    }
    return out;
}
export function newFill() {
    return new GenericFill();
}
export function traverse(graph, fill, has) {
    has = Bits.clone(has);
    const reachable = new Set();
    const queue = new Set();
    for (let i = 0; i < graph.slots.length; i++) {
        if (graph.graph[i] == null) {
            console.dir(graph);
            throw new Error(`adding bad node ${i} (${graph.slots[i].name}) from slot`);
        }
        queue.add(i);
    }
    for (const n of queue) {
        queue.delete(n);
        if (reachable.has(n))
            continue;
        const needed = graph.graph[n];
        if (needed == null)
            throw new Error(`not in graph: ${n}`);
        for (let i = 0, len = needed.length; i < len; i++) {
            if (!Bits.containsAll(has, needed[i]))
                continue;
            reachable.add(n);
            const item = n < graph.fixed ? n : fill.slots[n];
            if (item != null) {
                has = Bits.with(has, item);
                for (const j of graph.unlocks[item] || []) {
                    if (graph.graph[j] == null) {
                        console.dir(graph);
                        throw new Error(`adding bad node ${j} from unlock ${item}`);
                    }
                    queue.add(j);
                }
            }
            break;
        }
    }
    return reachable;
}
export function traverseFill(graph, fill) {
    const items = [];
    for (const i of graph.items) {
        if (i.item != null)
            items[i.item] = i.index;
    }
    const slots = [];
    for (const s of graph.slots) {
        if (s.item != null && fill.slots[s.item] != null) {
            slots[s.index] = items[fill.slots[s.item]];
        }
    }
    const out = [];
    let has = Bits.of();
    const reachable = new Set();
    const queue = new Set();
    for (let i = 0; i < graph.slots.length; i++) {
        queue.add(i);
    }
    for (const n of queue) {
        queue.delete(n);
        if (reachable.has(n))
            continue;
        const needed = graph.graph[n];
        for (let i = 0, len = needed.length; i < len; i++) {
            if (!Bits.containsAll(has, needed[i]))
                continue;
            out.push([n, ...Bits.bits(needed[i])]);
            reachable.add(n);
            const item = n < graph.fixed ? n : slots[n];
            if (item != null) {
                has = Bits.with(has, item);
                for (const j of graph.unlocks[item] || []) {
                    queue.add(j);
                }
            }
            break;
        }
    }
    return out;
}
var Type;
(function (Type) {
    Type[Type["EMPTY"] = 0] = "EMPTY";
    Type[Type["MIMIC"] = 1] = "MIMIC";
    Type[Type["CONSUMABLE"] = 2] = "CONSUMABLE";
    Type[Type["KEY"] = 3] = "KEY";
    Type[Type["BOSS_DROP"] = 4] = "BOSS_DROP";
    Type[Type["NPC"] = 5] = "NPC";
    Type[Type["MAGIC"] = 6] = "MAGIC";
    Type[Type["TRIGGER"] = 7] = "TRIGGER";
})(Type || (Type = {}));
export class ShuffleRules {
    constructor(rom, flags) {
        this.rom = rom;
        this.pools = new Map();
        const triggers = new Set([0x41, 0x42, 0x46]);
        const chests = new Set();
        const bossDrops = new Set();
        for (const l of rom.locations) {
            if (!l.used)
                continue;
            for (const s of l.spawns) {
                if (s.isInvisible()) {
                    bossDrops.add(s.id);
                }
                else if (s.isChest()) {
                    if (l.bossId() != null) {
                        bossDrops.add(s.id);
                    }
                    else {
                        chests.add(s.id);
                    }
                }
            }
        }
        for (const b of rom.bosses) {
            if (b.drop != null)
                bossDrops.add(b.drop);
        }
        this.slotTypes = seq(0x7c, i => {
            if (triggers.has(i))
                return Type.TRIGGER;
            if (i >= 0x70)
                return Type.MIMIC;
            if (i <= 0x48 && i >= 0x41)
                return Type.MAGIC;
            const item = rom.items[i];
            if (chests.has(i))
                return item && item.unique ? Type.KEY : Type.CONSUMABLE;
            if (bossDrops.has(i))
                return Type.BOSS_DROP;
            return item && item.unique ? Type.NPC : Type.EMPTY;
        });
        const poolFlags = flags.get('S') || [];
        for (let i = 0; i < poolFlags.length; i++) {
            const flag = poolFlags[i];
            if (/c/.test(flag)) {
                this.pools.set(Type.CONSUMABLE, i + 1);
            }
            if (/t/.test(flag)) {
                this.pools.set(Type.MIMIC, i + 1);
            }
            if (/k/.test(flag)) {
                this.pools.set(Type.KEY, i + 1);
                this.pools.set(Type.BOSS_DROP, i + 1);
                this.pools.set(Type.NPC, i + 1);
            }
            if (/m/.test(flag)) {
                this.pools.set(Type.MAGIC, i + 1);
                this.pools.set(Type.TRIGGER, i + 1);
            }
        }
    }
    fits(slot, item) {
        if (slot === item)
            return true;
        const slotType = this.slotTypes[slot] || Type.EMPTY;
        const slotPool = this.pools.get(slotType);
        if (slotPool == null)
            return false;
        let itemPool;
        if (item >= 0x70) {
            if (slotType > Type.KEY)
                return false;
            itemPool = this.pools.get(Type.MIMIC);
        }
        else if (item <= 0x48 && item >= 0x41) {
            itemPool = this.pools.get(Type.MAGIC);
        }
        else if (item < 0x41 && this.rom.items[item].unique) {
            itemPool = this.pools.get(Type.KEY);
        }
        else if (this.pools.get(Type.CONSUMABLE) == null &&
            this.slotTypes[item] === Type.BOSS_DROP) {
            itemPool = this.pools.get(Type.BOSS_DROP);
        }
        else {
            if (slotType === Type.TRIGGER)
                return false;
            itemPool = this.pools.get(Type.CONSUMABLE);
        }
        if (itemPool == null)
            return false;
        if (slotPool === itemPool)
            return true;
        return (itemPool === this.pools.get(Type.CONSUMABLE));
    }
    shouldShuffle(id) {
        return this.pools.get(this.slotTypes[id] || 0) != null;
    }
    isEarly(slot) {
        const slotType = this.slotTypes[slot] || Type.EMPTY;
        if (slotType >= Type.TRIGGER)
            return true;
        const pool = this.pools.get(slotType);
        const consumablePool = this.pools.get(Type.CONSUMABLE);
        const mimicPool = this.pools.get(Type.MIMIC);
        return pool !== consumablePool && pool !== mimicPool;
    }
}
export class AssumedFill {
    constructor(rom, flags) {
        this.rom = rom;
        this.flags = flags;
        this.shuffleRules = new ShuffleRules(rom, flags);
    }
    fits(slot, item) {
        return this.shuffleRules.fits(slot, item);
    }
    items(graph, random) {
        const arr = [];
        for (const item of graph.items) {
            if (item.item == null)
                continue;
            let count = 1;
            if (item.item === 0x00 || item.item === 0x01)
                count = 5;
            if (item.item === 0x02)
                count = 10;
            if (item.item === 0x03 || item.item === 0x48)
                count = 15;
            for (let i = 0; i < count; i++)
                arr.push(item.index);
        }
        random.shuffle(arr);
        return arr;
    }
    async shuffle(graph, random, progress, attempts = 2000) {
        if (progress)
            progress.addTasks(Math.floor(attempts / 100));
        for (let attempt = 0; attempt < attempts; attempt++) {
            if (progress && (attempt % 100 === 99)) {
                await new Promise(requestAnimationFrame);
                progress.addCompleted(1);
            }
            const items = this.items(graph, random);
            let has = Bits.from(new Set(items));
            const fill = new GenericFill();
            const itemIndex = new Map();
            const slotIndex = new Map();
            const nonShuffledItems = [];
            for (let i = graph.fixed; i < graph.items.length; i++) {
                const id = graph.items[i].item;
                if (id == null)
                    continue;
                itemIndex.set(id, i);
                if (!this.shuffleRules.shouldShuffle(id))
                    nonShuffledItems.push(id);
            }
            for (let s = graph.fixed; s < graph.slots.length; s++) {
                const id = graph.slots[s].item;
                if (id != null)
                    slotIndex.set(id, s);
            }
            for (const id of nonShuffledItems) {
                const i = itemIndex.get(id);
                const s = slotIndex.get(id);
                if (s == null || i == null)
                    continue;
                fill.set(s, i);
                has = Bits.without(has, i);
            }
            if (this.flags.guaranteeSword()) {
                const sword = random.nextInt(4);
                const i = itemIndex.get(sword);
                const s = slotIndex.get(0);
                if (i != null && s != null && !fill.hasSlot(s) && !fill.hasItem(i)) {
                    fill.set(s, i);
                    has = Bits.without(has, i);
                }
            }
            if (!this.fillInternal(graph, random, fill, items, has, Math.floor(attempt / 5)))
                continue;
            const final = traverse(graph, fill, Bits.of());
            if (final.size !== graph.slots.length) {
                console.error('unexpected size mismatch!', final, graph);
                continue;
            }
            const out = this.fill(graph, expandFill(graph, fill), random);
            if (out == null)
                continue;
            if (progress)
                progress.addCompleted(Math.floor((attempts - attempt) / 100));
            return out;
        }
        return null;
    }
    fillInternal(graph, random, fill, items, has, backSteps) {
        for (let bit = items.pop(); bit != null; bit = items.pop()) {
            if (!Bits.has(has, bit))
                continue;
            const itemId = graph.items[bit].item;
            if (itemId == null)
                throw new Error(`bad item: ${Object.entries(graph.items[bit])}`);
            has = Bits.without(has, bit);
            const reachable = [...traverse(graph, fill, has)];
            random.shuffle(reachable);
            let found = false;
            for (const slot of reachable) {
                const slotId = graph.slots[slot].item;
                if (slotId == null)
                    continue;
                if (!fill.hasSlot(slot) && this.fits(slotId, itemId)) {
                    fill.set(slot, bit);
                    found = true;
                    break;
                }
            }
            if (found)
                continue;
            if (backSteps-- > 0) {
                for (const slot of reachable) {
                    const slotId = graph.slots[slot].item;
                    if (slotId == null)
                        continue;
                    if (this.fits(slotId, itemId)) {
                        const previousItem = fill.slots[slot];
                        fill.slots[slot] = fill.items[previousItem] = undefined;
                        has = Bits.with(has, previousItem);
                        items.push(previousItem);
                        random.shuffle(items);
                        fill.set(slot, bit);
                        found = true;
                        break;
                    }
                }
                if (found)
                    continue;
            }
            return false;
        }
        return true;
    }
    fill(graph, fill, random) {
        const validItems = new Set();
        for (const slot of graph.slots) {
            if (slot.item != null)
                validItems.add(slot.item);
        }
        const uniques = [];
        const consumables = [];
        const mimics = [];
        const earlySlots = [];
        const otherSlots = [];
        for (let i = 0; i < 0x7c; i++) {
            if (i < 0x70 && !validItems.has(i)) {
                if (fill.hasSlot(i) !== fill.hasItem(i))
                    console.error('MISMATCH', i);
                continue;
            }
            if (!fill.hasSlot(i) && !fill.hasItem(i) && !this.shuffleRules.shouldShuffle(i)) {
                fill.set(i, i);
                continue;
            }
            if (!fill.hasSlot(i)) {
                if (this.shuffleRules.isEarly(i)) {
                    earlySlots.push(i);
                }
                else {
                    otherSlots.push(i);
                }
            }
            if (!fill.hasItem(i)) {
                if (i <= 0x48 && this.rom.items[i].unique) {
                    uniques.push(i);
                }
                else if (i < 0x70) {
                    consumables.push(i);
                }
                else {
                    mimics.push(i);
                }
            }
        }
        random.shuffle(earlySlots);
        random.shuffle(otherSlots);
        random.shuffle(uniques);
        random.shuffle(consumables);
        for (const item of iters.concat(uniques, mimics, consumables)) {
            let found = false;
            for (const slots of [earlySlots, otherSlots]) {
                if (found)
                    break;
                for (const slot of slots) {
                    if (this.fits(slot, item)) {
                        fill.set(slot, item);
                        found = true;
                        slots.splice(slots.indexOf(slot), 1);
                        break;
                    }
                }
            }
            if (!found) {
                return null;
            }
        }
        return fill;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2h1ZmZsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qcy9ncmFwaC9zaHVmZmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFJaEMsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFtRWpDLE1BQU0sV0FBVztJQUFqQjtRQUVFLFVBQUssR0FBZ0IsRUFBRSxDQUFDO1FBRXhCLFVBQUssR0FBZ0IsRUFBRSxDQUFDO0lBZ0IxQixDQUFDO0lBZEMsR0FBRyxDQUFDLElBQU8sRUFBRSxJQUFPO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM3RSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsdUJBQXVCLElBQUksRUFBRSxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFPO1FBQ2IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztJQUNsQyxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQU87UUFDYixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0lBQ2xDLENBQUM7Q0FDRjtBQU9ELFNBQVMsVUFBVSxDQUFDLENBQVEsRUFBRSxDQUFZO0lBQ3hDLE1B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S0FBSyxNQUFNLEtBQUssSUFBSSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsRUFBRTtnQkFDNUMsSUFBSSxLQUFLO29CQUFFLE1BQU07Z0JBQ2pCLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO29CQUN4QixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBYSxFQUFFO3dCQUNyQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQzt3QkFDckIsS0FBSyxHQUFHLElBQUksQ0FBQzt3QkFDYixLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7d0JBQ3JDLE1BQU07cUJBQ1A7aUJBQ0Y7YUFDRjtZQUNELElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBRVYsT0FBTyxJQUFJLENBQUM7YUFDYjtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBCYXNpYyBncmFwaCBzaHVmZmxlIGFsZ29yaXRobVxuaW1wb3J0IHtCaXRzfSBmcm9tICcuLi9iaXRzLmpzJztcbmltcG9ydCB7RmxhZ1NldH0gZnJvbSAnLi4vZmxhZ3NldC5qcyc7XG5pbXBvcnQge1JhbmRvbX0gZnJvbSAnLi4vcmFuZG9tLmpzJztcbmltcG9ydCB7Um9tfSBmcm9tICcuLi9yb20uanMnO1xuaW1wb3J0IHtzZXF9IGZyb20gJy4uL3JvbS91dGlsLmpzJztcbmltcG9ydCB7aXRlcnN9IGZyb20gJy4uL3V0aWwuanMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNodWZmbGUge1xuICBzaHVmZmxlKGdyYXBoOiBHcmFwaCxcbiAgICAgICAgICByYW5kb206IFJhbmRvbSxcbiAgICAgICAgICBwcm9ncmVzcz86IFByb2dyZXNzVHJhY2tlcixcbiAgICAgICAgICBhdHRlbXB0cz86IG51bWJlcik6IFByb21pc2U8RmlsbCB8IG51bGw+O1xufVxuZXhwb3J0IGludGVyZmFjZSBQcm9ncmVzc1RyYWNrZXIge1xuICBhZGRUYXNrcyh0YXNrczogbnVtYmVyKTogdm9pZDtcbiAgYWRkQ29tcGxldGVkKHRhc2tzOiBudW1iZXIpOiB2b2lkO1xufVxuXG5leHBvcnQgdHlwZSBTbG90SW5kZXggPSBudW1iZXIgJiB7X19zbG90SW5kZXhfXzogbmV2ZXJ9O1xuZXhwb3J0IHR5cGUgSXRlbUluZGV4ID0gbnVtYmVyICYge19faXRlbUluZGV4X186IG5ldmVyfTtcbmV4cG9ydCB0eXBlIFNsb3RJZCA9IG51bWJlciAmIHtfX3Nsb3RJZF9fOiBuZXZlcn07XG5leHBvcnQgdHlwZSBJdGVtSWQgPSBudW1iZXIgJiB7X19pdGVtSWRfXzogbmV2ZXJ9O1xuXG5leHBvcnQgdHlwZSBLZXllZDxfSywgVj4gPSBBcnJheTxWPjtcbmV4cG9ydCB0eXBlIFJlYWRvbmx5S2V5ZWQ8X0ssIFY+ID0gUmVhZG9ubHlBcnJheTxWPjtcblxuLy8gZGVjbGFyZSBjb25zdCBzOiBTbG90SW5kZXg7XG4vLyBkZWNsYXJlIGNvbnN0IGk6IEl0ZW1JbmRleDtcbi8vIGNvbnN0IGE6IEtleWVkPFNsb3RJbmRleCwgSXRlbUluZGV4PiA9IFtdO1xuLy8gY29uc3QgeCA9IGFbc107XG4vLyBjb25zdCBbXSA9IFtzLCBpLCBhLCB4XTtcblxuZXhwb3J0IGludGVyZmFjZSBOb2RlIHtcbiAgaXRlbT86IG51bWJlcjsgLy8gb25seSBzZXQgZm9yIGxlZ2l0IGl0ZW1zL3Nsb3RzXG4gIG5hbWU6ICBzdHJpbmc7XG4gIGNvbmRpdGlvbjogbnVtYmVyOyAvLyBmbGFnL2NvbmRpdGlvbiBudW1iZXIgZm9yIHRyYWNraW5nIHRoaXMgbm9kZSAoZS5nLiAweDI0OCBmb3IgZmxpZ2h0KVxuICBpbmRleDogbnVtYmVyO1xufVxuZXhwb3J0IGludGVyZmFjZSBTbG90Tm9kZSBleHRlbmRzIE5vZGUge1xuICBpdGVtPzogU2xvdElkO1xuICBpbmRleDogU2xvdEluZGV4O1xufVxuZXhwb3J0IGludGVyZmFjZSBJdGVtTm9kZSBleHRlbmRzIE5vZGUge1xuICBpdGVtPzogSXRlbUlkO1xuICBpbmRleDogSXRlbUluZGV4O1xufVxuXG4vLyB0eXBlIEtleWVkPEssIFY+ID0gQXJyYXk8Vj47IC8vICYge19fa2V5ZWRfXzogKGs6IEspID0+IFYsIF9fd3JpdGVhYmxlX186IG5ldmVyfTtcbi8vIHR5cGUgUmVhZG9ubHlLZXllZDxLLCBWPiA9IFJlYWRvbmx5QXJyYXk8Vj47IC8vICYge19fa2V5ZWRfXzogKGs6IEspID0+IFZ9O1xuLy8gZnVuY3Rpb24gS2V5ZWQ8SywgVj4oYTogVltdKTogS2V5ZWQ8SywgVj4geyByZXR1cm4gYSBhcyBhbnk7IH1cbi8vIG5hbWVzcGFjZSBLZXllZCB7XG4vLyAgIC8vIGV4cG9ydCBjb25zdCB0b0FycmF5OiB7PEssIFY+KGE6IEtleWVkPEssIFY+KTogQXJyYXk8Vj4sXG4vLyAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgPEssIFY+KGE6IFJlYWRvbmx5S2V5ZWQ8SywgVj4pOiBSZWFkb25seUFycmF5PFY+fSA9IChhOiBhbnkpID0+IGE7XG4vLyAgIGV4cG9ydCBmdW5jdGlvbiBnZXQ8SywgVj4oYTogUmVhZG9ubHlLZXllZDxLLCBWPiwgazogSyk6IFYge1xuLy8gICAgIHJldHVybiAoYSBhcyBhbnkpW2tdO1xuLy8gICB9XG4vLyAgIGV4cG9ydCBmdW5jdGlvbiBzZXQ8SywgVj4oYTogS2V5ZWQ8SywgVj4sIGs6IEssIHY6IFYpOiB2b2lkIHtcbi8vICAgICAoYSBhcyBhbnkpW2tdID0gdjtcbi8vICAgfVxuLy8gfVxuXG5leHBvcnQgaW50ZXJmYWNlIEdyYXBoIHtcbiAgcmVhZG9ubHkgZml4ZWQ6IG51bWJlcjsgIC8vIGluZGV4IGJlZm9yZSB3aGljaCBzbG90cyAmIGRlcHMgYXJlIHRoZSBzYW1lP1xuICByZWFkb25seSBzbG90czogUmVhZG9ubHlLZXllZDxTbG90SW5kZXgsIFNsb3ROb2RlPjtcbiAgcmVhZG9ubHkgaXRlbXM6IFJlYWRvbmx5S2V5ZWQ8SXRlbUluZGV4LCBJdGVtTm9kZT47XG4gIC8qKiBNYXAgZnJvbSBsb2NhdGlvbiB0byBETkYgb2YgaXRlbXMgcmVxdWlyZWQgdG8gcmVhY2guICovXG4gIHJlYWRvbmx5IGdyYXBoOiBSZWFkb25seUtleWVkPFNsb3RJbmRleCwgcmVhZG9ubHkgQml0c1tdPjtcbiAgLyoqIE1hcCBmcm9tIGl0ZW0gdG8gbG9jYXRpb25zIHRoYXQgbWF5IG5vdyBiZSByZWFjaGFibGUuICovXG4gIHJlYWRvbmx5IHVubG9ja3M6IFJlYWRvbmx5S2V5ZWQ8SXRlbUluZGV4LCByZWFkb25seSBTbG90SW5kZXhbXT47XG4gIHJlYWRvbmx5IHJvbTogUm9tO1xufVxuXG5jbGFzcyBHZW5lcmljRmlsbDxTIGV4dGVuZHMgbnVtYmVyLCBJIGV4dGVuZHMgbnVtYmVyPiB7XG4gIC8qKiBNYXBzIGxvY2F0aW9uIHRvIGl0ZW0uICovXG4gIHNsb3RzOiBLZXllZDxTLCBJPiA9IFtdO1xuICAvKiogTWFwcyBpdGVtIHRvIGxvY2F0aW9uLiAqL1xuICBpdGVtczogS2V5ZWQ8SSwgUz4gPSBbXTtcblxuICBzZXQoc2xvdDogUywgaXRlbTogSSkge1xuICAgIGlmICh0aGlzLnNsb3RzW3Nsb3RdICE9IG51bGwpIHRocm93IG5ldyBFcnJvcihgYWxyZWFkeSBmaWxsZWQgc2xvdCAke3Nsb3R9YCk7XG4gICAgaWYgKHRoaXMuaXRlbXNbaXRlbV0gIT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBhbHJlYWR5IGZpbGxlZCBpdGVtICR7aXRlbX1gKTtcbiAgICB0aGlzLnNsb3RzW3Nsb3RdID0gaXRlbTtcbiAgICB0aGlzLml0ZW1zW2l0ZW1dID0gc2xvdDtcbiAgfVxuXG4gIGhhc1Nsb3Qoc2xvdDogUyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnNsb3RzW3Nsb3RdICE9IG51bGw7XG4gIH1cblxuICBoYXNJdGVtKGl0ZW06IEkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtc1tpdGVtXSAhPSBudWxsO1xuICB9XG59XG5cbmV4cG9ydCB0eXBlIEZpbGwgPSBHZW5lcmljRmlsbDxTbG90SWQsIEl0ZW1JZD47XG4vL2V4cG9ydCBjb25zdCBGaWxsOiB7bmV3KCk6IEZpbGx9ID0gR2VuZXJpY0ZpbGw7XG5leHBvcnQgdHlwZSBJbmRleEZpbGwgPSBHZW5lcmljRmlsbDxTbG90SW5kZXgsIEl0ZW1JbmRleD47XG5cbi8qKiBDb252ZXJ0cyBhbiBJbmRleEZpbGwgdG8gYSBmdWxsIEZpbGwuICovXG5mdW5jdGlvbiBleHBhbmRGaWxsKGc6IEdyYXBoLCBmOiBJbmRleEZpbGwpOiBGaWxsIHtcbiAgY29uc3Qgb3V0ID0gbmV3IEdlbmVyaWNGaWxsPFNsb3RJZCwgSXRlbUlkPigpO1xuICBmb3IgKGxldCBpID0gZy5maXhlZDsgaSA8IGcuaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBzOiBTbG90SW5kZXggPSBmLml0ZW1zW2ldO1xuICAgIG91dC5zZXQoZy5zbG90c1tzXS5pdGVtISwgZy5pdGVtc1tpXS5pdGVtISk7XG4gIH1cbiAgcmV0dXJuIG91dDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5ld0ZpbGw8UyBleHRlbmRzIG51bWJlciwgSSBleHRlbmRzIG51bWJlcj4oKTogR2VuZXJpY0ZpbGw8UywgST4ge1xuICByZXR1cm4gbmV3IEdlbmVyaWNGaWxsKCk7XG59XG5cblxuLyoqIEByZXR1cm4gVGhlIHNldCBvZiByZWFjaGFibGUgc2xvdHMuICovXG5leHBvcnQgZnVuY3Rpb24gdHJhdmVyc2UoZ3JhcGg6IEdyYXBoLCBmaWxsOiBJbmRleEZpbGwsIGhhczogQml0cyk6IFNldDxTbG90SW5kZXg+IHtcbiAgLy8gTk9URTogd2UgY2FuJ3QgdXNlIGlzQXJyYXkgYmVjYXVzZSB0aGUgbm9uLWJpZ2ludCBwb2x5ZmlsbCBJUyBhbiBhcnJheVxuICBoYXMgPSBCaXRzLmNsb25lKGhhcyk7XG4gIGNvbnN0IHJlYWNoYWJsZSA9IG5ldyBTZXQ8U2xvdEluZGV4PigpO1xuICBjb25zdCBxdWV1ZSA9IG5ldyBTZXQ8U2xvdEluZGV4PigpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGdyYXBoLnNsb3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKGdyYXBoLmdyYXBoW2ldID09IG51bGwpIHtjb25zb2xlLmRpcihncmFwaCk7dGhyb3cgbmV3IEVycm9yKGBhZGRpbmcgYmFkIG5vZGUgJHtpfSAoJHtncmFwaC5zbG90c1tpXS5uYW1lfSkgZnJvbSBzbG90YCk7fVxuICAgIHF1ZXVlLmFkZChpIGFzIFNsb3RJbmRleCk7XG4gIH1cbiAgZm9yIChjb25zdCBuIG9mIHF1ZXVlKSB7XG4gICAgcXVldWUuZGVsZXRlKG4pO1xuICAgIGlmIChyZWFjaGFibGUuaGFzKG4pKSBjb250aW51ZTtcbiAgICAvLyBjYW4gd2UgcmVhY2ggaXQ/XG4gICAgY29uc3QgbmVlZGVkID0gZ3JhcGguZ3JhcGhbbl07XG4gICAgaWYgKG5lZWRlZCA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYG5vdCBpbiBncmFwaDogJHtufWApO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBuZWVkZWQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIGlmICghQml0cy5jb250YWluc0FsbChoYXMsIG5lZWRlZFtpXSkpIGNvbnRpbnVlO1xuICAgICAgcmVhY2hhYmxlLmFkZChuKTtcbiAgICAgIGNvbnN0IGl0ZW0gPSBuIDwgZ3JhcGguZml4ZWQgPyBuIDogZmlsbC5zbG90c1tuXTtcbiAgICAgIGlmIChpdGVtICE9IG51bGwpIHtcbiAgICAgICAgaGFzID0gQml0cy53aXRoKGhhcywgaXRlbSk7XG4gICAgICAgIGZvciAoY29uc3QgaiBvZiBncmFwaC51bmxvY2tzW2l0ZW1dIHx8IFtdKSB7XG4gICAgICAgICAgaWYgKGdyYXBoLmdyYXBoW2pdID09IG51bGwpIHtjb25zb2xlLmRpcihncmFwaCk7dGhyb3cgbmV3IEVycm9yKGBhZGRpbmcgYmFkIG5vZGUgJHtqfSBmcm9tIHVubG9jayAke2l0ZW19YCk7fVxuICAgICAgICAgIHF1ZXVlLmFkZChqKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIHJldHVybiByZWFjaGFibGU7XG59XG5cbi8vIFRPRE8gLSB0aGlzIGlzIGEgbG90IG9mIGNvcHkgcGFzdGEsIHdlIHNob3VsZCBjb25zb2xpZGF0ZSFcbi8qKiBDb3B5IG9mIHRyYXZlcnNlIGJ1dCBvdXRwdXRzIGEgaHVtYW4tcmVhZGFibGUgcGF0aC4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0cmF2ZXJzZUZpbGwoZ3JhcGg6IEdyYXBoLCBmaWxsOiBGaWxsKTogbnVtYmVyW11bXSB7XG4gIGNvbnN0IGl0ZW1zID0gW107XG4gIGZvciAoY29uc3QgaSBvZiBncmFwaC5pdGVtcykge1xuICAgIGlmIChpLml0ZW0gIT0gbnVsbCkgaXRlbXNbaS5pdGVtXSA9IGkuaW5kZXg7XG4gIH1cbiAgY29uc3Qgc2xvdHMgPSBbXTtcbiAgZm9yIChjb25zdCBzIG9mIGdyYXBoLnNsb3RzKSB7XG4gICAgaWYgKHMuaXRlbSAhPSBudWxsICYmIGZpbGwuc2xvdHNbcy5pdGVtXSAhPSBudWxsKSB7XG4gICAgICBzbG90c1tzLmluZGV4XSA9IGl0ZW1zW2ZpbGwuc2xvdHNbcy5pdGVtXV07XG4gICAgfVxuICB9XG4gIGNvbnN0IG91dCA9IFtdO1xuXG4gIGxldCBoYXMgPSBCaXRzLm9mKClcbiAgY29uc3QgcmVhY2hhYmxlID0gbmV3IFNldDxTbG90SW5kZXg+KCk7XG4gIGNvbnN0IHF1ZXVlID0gbmV3IFNldDxTbG90SW5kZXg+KCk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JhcGguc2xvdHMubGVuZ3RoOyBpKyspIHtcbiAgICBxdWV1ZS5hZGQoaSBhcyBTbG90SW5kZXgpO1xuICB9XG4gIGZvciAoY29uc3QgbiBvZiBxdWV1ZSkge1xuICAgIHF1ZXVlLmRlbGV0ZShuKTtcbiAgICBpZiAocmVhY2hhYmxlLmhhcyhuKSkgY29udGludWU7XG4gICAgLy8gY2FuIHdlIHJlYWNoIGl0P1xuICAgIGNvbnN0IG5lZWRlZCA9IGdyYXBoLmdyYXBoW25dO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBuZWVkZWQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIGlmICghQml0cy5jb250YWluc0FsbChoYXMsIG5lZWRlZFtpXSkpIGNvbnRpbnVlO1xuICAgICAgb3V0LnB1c2goW24sIC4uLkJpdHMuYml0cyhuZWVkZWRbaV0pXSk7XG4gICAgICByZWFjaGFibGUuYWRkKG4pO1xuICAgICAgY29uc3QgaXRlbSA9IG4gPCBncmFwaC5maXhlZCA/IG4gOiBzbG90c1tuXTtcbiAgICAgIGlmIChpdGVtICE9IG51bGwpIHtcbiAgICAgICAgaGFzID0gQml0cy53aXRoKGhhcywgaXRlbSk7XG4gICAgICAgIGZvciAoY29uc3QgaiBvZiBncmFwaC51bmxvY2tzW2l0ZW1dIHx8IFtdKSB7XG4gICAgICAgICAgcXVldWUuYWRkKGopO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG91dDtcbn1cblxuLy8gU2h1ZmZsZSBtb2Rlczpcbi8vICAxLiBrZXkgaXRlbSBzaHVmZmxlIFNrKHQpXG4vLyAgMi4gZnVsbCBzaHVmZmxlIFNmKHQpXG4vLyBGb3Igbm93IHdlIHByb3h5IGEgZmV3IHRoaW5ncyBmb3IgdGhpcy4uLlxuXG4vLyBTbG90IHByb3BlcnRpZXM6XG4vLyAgMS4gY29uc3VtYWJsZSBvciBrZXlcbi8vICAyLiBjaGVzdCAoaW5jbC4gYm9zcyBkcm9wcywgbWF5IGJlIGNvbnN1bWFibGUpXG4vLyAgMy4gdHJpZ2dlciAoYWx3YXlzIGtleSwgbXVzdCBiZSBrZXkpXG4vLyAgNC4gbWltaWNcblxuLy8gUnVsZXM6XG4vLyAgLSBJZiBrZXkgc2h1ZmZsZSB0aGVuIGluaXRpYWwgZmlsbCBpZ25vcmVzIGFsbCBub24ta2V5IHNsb3RzXG4vLyAgLSBJZiB0cmFwIHNodWZmbGUgb2ZmIHRoZW4gaWdub3JlIG1pbWljIHNsb3RzXG4vLyAgLSBDb25zdW1hYmxlcyBtYXkgbm90IGdvIGludG8gdHJpZ2dlcnNcbi8vICAtIE1pbWljcyBtYXkgbm90IGdvIGludG8gbnBjcywgdHJpZ2dlcnMsIG9yIGJvc3MgZHJvcHMuXG4vLyAgLSBXZSB0cmVhdCBpbnZpc2libGUgY2hlc3RzIGxpa2UgYm9zcyBkcm9wcy5cblxuZW51bSBUeXBlIHtcbiAgRU1QVFkgPSAwLFxuICBNSU1JQyA9IDEsXG4gIENPTlNVTUFCTEUgPSAyLFxuICBLRVkgPSAzLFxuICBCT1NTX0RST1AgPSA0LFxuICBOUEMgPSA1LFxuICBNQUdJQyA9IDYsXG4gIFRSSUdHRVIgPSA3LFxufVxuXG5leHBvcnQgY2xhc3MgU2h1ZmZsZVJ1bGVzIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzbG90VHlwZXM6IFJlYWRvbmx5S2V5ZWQ8U2xvdElkIHwgSXRlbUlkLCBUeXBlIHwgdW5kZWZpbmVkPjtcbiAgcHJpdmF0ZSByZWFkb25seSBwb29scyA9IG5ldyBNYXA8VHlwZSwgbnVtYmVyPigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcm9tOiBSb20sIGZsYWdzOiBGbGFnU2V0KSB7XG4gICAgY29uc3QgdHJpZ2dlcnMgPSBuZXcgU2V0KFsweDQxLCAweDQyLCAweDQ2XSk7XG4gICAgY29uc3QgY2hlc3RzID0gbmV3IFNldCgpO1xuICAgIGNvbnN0IGJvc3NEcm9wcyA9IG5ldyBTZXQoKTtcbiAgICBmb3IgKGNvbnN0IGwgb2Ygcm9tLmxvY2F0aW9ucykge1xuICAgICAgaWYgKCFsLnVzZWQpIGNvbnRpbnVlO1xuICAgICAgZm9yIChjb25zdCBzIG9mIGwuc3Bhd25zKSB7XG4gICAgICAgIGlmIChzLmlzSW52aXNpYmxlKCkpIHtcbiAgICAgICAgICBib3NzRHJvcHMuYWRkKHMuaWQpO1xuICAgICAgICB9IGVsc2UgaWYgKHMuaXNDaGVzdCgpKSB7XG4gICAgICAgICAgaWYgKGwuYm9zc0lkKCkgIT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gTm9uLWRyb3AgY2hlc3RzIG9uIGJvc3Mgc2NyZWVucyBhbHNvIGRvbid0IHdvcmsgZm9yIG1pbWljcyxcbiAgICAgICAgICAgIC8vIHNvIGNvdW50IHRob3NlIGNoZXN0cyBhcyBib3NzIGRyb3BzLCB0b28gKGUuZy4gc3Rvcm0gYnJhY2VsZXQpXG4gICAgICAgICAgICBib3NzRHJvcHMuYWRkKHMuaWQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjaGVzdHMuYWRkKHMuaWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IGIgb2Ygcm9tLmJvc3Nlcykge1xuICAgICAgaWYgKGIuZHJvcCAhPSBudWxsKSBib3NzRHJvcHMuYWRkKGIuZHJvcCk7XG4gICAgfVxuXG4gICAgdGhpcy5zbG90VHlwZXMgPSBzZXEoMHg3YywgaSA9PiB7XG4gICAgICBpZiAodHJpZ2dlcnMuaGFzKGkpKSByZXR1cm4gVHlwZS5UUklHR0VSO1xuICAgICAgaWYgKGkgPj0gMHg3MCkgcmV0dXJuIFR5cGUuTUlNSUM7XG4gICAgICBpZiAoaSA8PSAweDQ4ICYmIGkgPj0gMHg0MSkgcmV0dXJuIFR5cGUuTUFHSUM7XG4gICAgICBjb25zdCBpdGVtID0gcm9tLml0ZW1zW2ldO1xuICAgICAgaWYgKGNoZXN0cy5oYXMoaSkpIHJldHVybiBpdGVtICYmIGl0ZW0udW5pcXVlID8gVHlwZS5LRVkgOiBUeXBlLkNPTlNVTUFCTEU7XG4gICAgICBpZiAoYm9zc0Ryb3BzLmhhcyhpKSkgcmV0dXJuIFR5cGUuQk9TU19EUk9QO1xuICAgICAgcmV0dXJuIGl0ZW0gJiYgaXRlbS51bmlxdWUgPyBUeXBlLk5QQyA6IFR5cGUuRU1QVFk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBwb29sRmxhZ3MgPSBmbGFncy5nZXQoJ1MnKSB8fCBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xGbGFncy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgZmxhZyA9IHBvb2xGbGFnc1tpXTtcbiAgICAgIGlmICgvYy8udGVzdChmbGFnKSkge1xuICAgICAgICB0aGlzLnBvb2xzLnNldChUeXBlLkNPTlNVTUFCTEUsIGkgKyAxKTtcbiAgICAgIH1cbiAgICAgIGlmICgvdC8udGVzdChmbGFnKSkge1xuICAgICAgICB0aGlzLnBvb2xzLnNldChUeXBlLk1JTUlDLCBpICsgMSk7XG4gICAgICB9XG4gICAgICBpZiAoL2svLnRlc3QoZmxhZykpIHtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5LRVksIGkgKyAxKTtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5CT1NTX0RST1AsIGkgKyAxKTtcbiAgICAgICAgdGhpcy5wb29scy5zZXQoVHlwZS5OUEMsIGkgKyAxKTtcbiAgICAgIH1cbiAgICAgIGlmICgvbS8udGVzdChmbGFnKSkge1xuICAgICAgICB0aGlzLnBvb2xzLnNldChUeXBlLk1BR0lDLCBpICsgMSk7XG4gICAgICAgIHRoaXMucG9vbHMuc2V0KFR5cGUuVFJJR0dFUiwgaSArIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZpdHMoc2xvdDogU2xvdElkLCBpdGVtOiBJdGVtSWQpOiBib29sZWFuIHtcbiAgICAvLyBWYW5pbGxhIHBsYWNlbWVudCBpcyBhbHdheXMgbGVnYWwuXG4gICAgaWYgKHNsb3QgYXMgbnVtYmVyID09PSBpdGVtKSByZXR1cm4gdHJ1ZTtcbiAgICBjb25zdCBzbG90VHlwZSA9IHRoaXMuc2xvdFR5cGVzW3Nsb3RdIHx8IFR5cGUuRU1QVFk7XG4gICAgY29uc3Qgc2xvdFBvb2wgPSB0aGlzLnBvb2xzLmdldChzbG90VHlwZSk7XG4gICAgaWYgKHNsb3RQb29sID09IG51bGwpIHJldHVybiBmYWxzZTtcbiAgICAvLyBUT0RPIC0gYWNjb3VudCBmb3IgbmV3IE1BR0lDIHR5cGUgYW5kIHVzZSBwb29scyBpbnN0ZWFkIVxuICAgIGxldCBpdGVtUG9vbDtcbiAgICBpZiAoaXRlbSA+PSAweDcwKSB7XG4gICAgICAvLyBNaW1pY3MgLSBjYW4gbmV2ZXIgc2hvdyB1cCBleGNlcHQgaW4gbm9uLWJvc3MtZHJvcCBjaGVzdHMuXG4gICAgICBpZiAoc2xvdFR5cGUgPiBUeXBlLktFWSkgcmV0dXJuIGZhbHNlO1xuICAgICAgaXRlbVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLk1JTUlDKTtcbiAgICB9IGVsc2UgaWYgKGl0ZW0gPD0gMHg0OCAmJiBpdGVtID49IDB4NDEpIHtcbiAgICAgIC8vIE1hZ2ljcyAtIGNhbiBiZSBhbnl3aGVyZS5cbiAgICAgIGl0ZW1Qb29sID0gdGhpcy5wb29scy5nZXQoVHlwZS5NQUdJQyk7XG4gICAgfSBlbHNlIGlmIChpdGVtIDwgMHg0MSAmJiB0aGlzLnJvbS5pdGVtc1tpdGVtXS51bmlxdWUpIHtcbiAgICAgIC8vIFVuaXF1ZSBpdGVtIC0gY2FuIGJlIGFueXdoZXJlLlxuICAgICAgaXRlbVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLktFWSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBvb2xzLmdldChUeXBlLkNPTlNVTUFCTEUpID09IG51bGwgJiZcbiAgICAgICAgICAgICAgIHRoaXMuc2xvdFR5cGVzW2l0ZW1dID09PSBUeXBlLkJPU1NfRFJPUCkge1xuICAgICAgLy8gSWYgY29uc3VtYWJsZXMgYXJlICpub3QqIHNodWZmbGVkIHRoZW4gYWxsIGJvc3MgZHJvcGFcbiAgICAgIC8vIG5lZWQgdG8gYmUgdHJlYXRlZCBhcyBrZXkgaXRlbXMsIG5vdCBjb25zdW1hYmxlcy5cbiAgICAgIGl0ZW1Qb29sID0gdGhpcy5wb29scy5nZXQoVHlwZS5CT1NTX0RST1ApXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIENvbnN1bWFibGVzIC0gY2Fubm90IGJlIG9uIGFuIE5QQywgTWFnaWMsIG9yIFRyaWdnZXIuXG4gICAgICBpZiAoc2xvdFR5cGUgPT09IFR5cGUuVFJJR0dFUikgcmV0dXJuIGZhbHNlO1xuICAgICAgaXRlbVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLkNPTlNVTUFCTEUpO1xuICAgIH1cbiAgICBpZiAoaXRlbVBvb2wgPT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xuXG4gICAgLy8gTm8gaGFyZCBibG9ja2VyLCBzbyBjaGVjayBmb3Igc2FtZSBwb29sLlxuICAgIGlmIChzbG90UG9vbCA9PT0gaXRlbVBvb2wpIHJldHVybiB0cnVlO1xuXG4gICAgLy8gRGlmZmVyZW50IHBvb2xzLCBidXQgd2UgbmVlZCB0byBzaHVmZmxlIHNvbWUgY29uc3VtYWJsZXNcbiAgICAvLyBpbnRvIGtleSBpdGVtIHNsb3RzIG9jY2FzaW9uYWxseS5cbiAgICByZXR1cm4gKGl0ZW1Qb29sID09PSB0aGlzLnBvb2xzLmdldChUeXBlLkNPTlNVTUFCTEUpKTtcblxuICAvLyAgICAgaWYgKCF0aGlzLnNodWZmbGVGdWxsKSByZXR1cm4gc2xvdFR5cGUgPj0gVHlwZS5LRVk7XG4gIC8vICAgICBpZiAoIXRoaXMuc2h1ZmZsZVRyYXBzKSByZXR1cm4gc2xvdFR5cGUgIT09IFR5cGUuTUlNSUM7XG4gIC8vICAgICByZXR1cm4gdHJ1ZTtcbiAgLy8gICB9XG4gIC8vICAgLy8gQ29uc3VtYWJsZVxuICAvLyAgIC8vIGlmICh1bmlxdWVzTGVmdCAmJiBzbG90VHlwZSA+IFR5cGUuQ09OU1VNQUJMRSkgcmV0dXJuIGZhbHNlO1xuICAvLyAgIGlmICghdGhpcy5zaHVmZmxlVHJhcHMpIHJldHVybiBzbG90VHlwZSAhPT0gVHlwZS5NSU1JQztcbiAgLy8gICByZXR1cm4gc2xvdFR5cGUgIT09IFR5cGUuVFJJR0dFUjtcblxuXG4gIC8vIC8vIG1pbWljXG4gIC8vICAgICBpZiAoIXRoaXMuc2h1ZmZsZVRyYXBzKSByZXR1cm4gc2xvdFR5cGUgPT09IFR5cGUuTUlNSUM7XG4gIC8vICAgICBpZiAoIXRoaXMuc2h1ZmZsZUZ1bGwpIHJldHVybiBzbG90VHlwZSA8PSBUeXBlLkNPTlNVTUFCTEU7XG4gIC8vICAgICByZXR1cm4gc2xvdFR5cGUgPD0gVHlwZS5LRVk7XG5cbiAgfVxuXG4gIHNob3VsZFNodWZmbGUoaWQ6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnBvb2xzLmdldCh0aGlzLnNsb3RUeXBlc1tpZF0gfHwgMCkgIT0gbnVsbDtcbiAgfVxuXG4gIGlzRWFybHkoc2xvdDogU2xvdElkKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2xvdFR5cGUgPSB0aGlzLnNsb3RUeXBlc1tzbG90XSB8fCBUeXBlLkVNUFRZO1xuXG4gICAgLy8gRWFybHkgc2xvdHM6XG4gICAgLy8gIC0gVHJpZ2dlciBzbG90cyBhcmUgYWx3YXlzIGVhcmx5LCBmb3IgYWxsIGZsYWdzLCBzaW5jZSB0aGV5IGNhbm5vdCBnZXRcbiAgICAvLyAgICBjb25zdW1hYmxlcyAob3IgbWltaWNzKS5cbiAgICAvLyAgLSBUT0RPIC0gY29uc2lkZXIgYSBjb21wcm9taXNlIGZ1bGwtc2h1ZmZsZSBmbGFnL21vZGUgd2hlcmUgTlBDcyBkb24ndFxuICAgIC8vICAgIGV2ZXIgaGF2ZSBjb25zdW1hYmxlcy5cbiAgICAvLyAgLSBPdGhlcndpc2UgYW55IHNsb3QgdHlwZSB0aGF0IGRvZXMgbm90IHNodWZmbGUgdy8gY29uc3VtYWJsZXMgbmVlZHNcbiAgICAvLyAgICB0byBiZSBlYXJseS5cblxuICAgIGlmIChzbG90VHlwZSA+PSBUeXBlLlRSSUdHRVIpIHJldHVybiB0cnVlO1xuICAgIGNvbnN0IHBvb2wgPSB0aGlzLnBvb2xzLmdldChzbG90VHlwZSk7XG4gICAgY29uc3QgY29uc3VtYWJsZVBvb2wgPSB0aGlzLnBvb2xzLmdldChUeXBlLkNPTlNVTUFCTEUpO1xuICAgIGNvbnN0IG1pbWljUG9vbCA9IHRoaXMucG9vbHMuZ2V0KFR5cGUuTUlNSUMpO1xuICAgIHJldHVybiBwb29sICE9PSBjb25zdW1hYmxlUG9vbCAmJiBwb29sICE9PSBtaW1pY1Bvb2w7XG5cbiAgICAvLyByZXR1cm4gc2xvdFR5cGUgPiAoZnVsbFNodWZmbGUgPyBUeXBlLk5QQyA6IFR5cGUuQ09OU1VNQUJMRSk7XG4gIH1cbn1cblxuXG4vLyBUT0RPIC0gcHVsbCBvdXQgYSBiYXNlIGNsYXNzIHdpdGggZml0cywgZXRjLlxuZXhwb3J0IGNsYXNzIEFzc3VtZWRGaWxsIGltcGxlbWVudHMgU2h1ZmZsZSB7XG4gIC8vIFRPRE8gLSBvdGhlciBjb25maWd1cmF0aW9uP1xuXG4gIHJlYWRvbmx5IHNodWZmbGVSdWxlczogU2h1ZmZsZVJ1bGVzO1xuIFxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJvbTogUm9tLFxuICAgICAgICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGZsYWdzOiBGbGFnU2V0KSB7XG4gICAgdGhpcy5zaHVmZmxlUnVsZXMgPSBuZXcgU2h1ZmZsZVJ1bGVzKHJvbSwgZmxhZ3MpO1xuICAgIC8vIEZpcnN0IGNvbXB1dGUgYSB0YWJsZSBvZiBhbGxvd2VkIGxvY2F0aW9ucywgYW5kIHdoZXRoZXIgaXRlbXMgYXJlIHVuaXF1ZS5cblxuICAgIC8vIEZvciBlYWNoIHNsb3QsIGZpZ3VyZSBvdXQgKGEpIGlzIGl0IGEgY2hlc3QgKG9yIG1pbWljKSwgKGIpIGlzIGl0IGEgdHJpZ2dlciBzcXVhcmUuXG4gICAgLy8gSWYgbmVpdGhlciB0aGVuIGl0J3MgYW4gTlBDIG9yIGJvc3Nkcm9wLlxuXG4gIH1cblxuICBwcml2YXRlIGZpdHMoc2xvdDogU2xvdElkLCBpdGVtOiBJdGVtSWQgLyogLCB1bmlxdWVzTGVmdDogYm9vbGVhbiAqLyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnNodWZmbGVSdWxlcy5maXRzKHNsb3QsIGl0ZW0pO1xuICB9XG5cbiAgLy8gTm90ZTogZHVwbGljYXRlcyBhcmUgYWxsb3dlZC5cbiAgcHJvdGVjdGVkIGl0ZW1zKGdyYXBoOiBHcmFwaCwgcmFuZG9tOiBSYW5kb20pOiBJdGVtSW5kZXhbXSB7XG4gICAgY29uc3QgYXJyID0gW107XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGdyYXBoLml0ZW1zKSB7XG4gICAgICBpZiAoaXRlbS5pdGVtID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgbGV0IGNvdW50ID0gMTtcbiAgICAgIGlmIChpdGVtLml0ZW0gPT09IDB4MDAgfHwgaXRlbS5pdGVtID09PSAweDAxKSBjb3VudCA9IDU7XG4gICAgICBpZiAoaXRlbS5pdGVtID09PSAweDAyKSBjb3VudCA9IDEwO1xuICAgICAgaWYgKGl0ZW0uaXRlbSA9PT0gMHgwMyB8fCBpdGVtLml0ZW0gPT09IDB4NDgpIGNvdW50ID0gMTU7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIGFyci5wdXNoKGl0ZW0uaW5kZXgpO1xuICAgIH1cbiAgICByYW5kb20uc2h1ZmZsZShhcnIpO1xuICAgIHJldHVybiBhcnI7XG4gIH1cblxuICBhc3luYyBzaHVmZmxlKGdyYXBoOiBHcmFwaCxcbiAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbiAgICAgICAgICAgICAgICBwcm9ncmVzcz86IFByb2dyZXNzVHJhY2tlcixcbiAgICAgICAgICAgICAgICBhdHRlbXB0czogbnVtYmVyID0gMjAwMCk6IFByb21pc2U8RmlsbCB8IG51bGw+IHtcbiAgICBpZiAocHJvZ3Jlc3MpIHByb2dyZXNzLmFkZFRhc2tzKE1hdGguZmxvb3IoYXR0ZW1wdHMgLyAxMDApKTtcbiAgICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8IGF0dGVtcHRzOyBhdHRlbXB0KyspIHtcbiAgICAgIC8vIGVuc3VyZSBVSSB1cGRhdGVzXG4gICAgICBpZiAocHJvZ3Jlc3MgJiYgKGF0dGVtcHQgJSAxMDAgPT09IDk5KSkge1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXF1ZXN0QW5pbWF0aW9uRnJhbWUpO1xuICAgICAgICBwcm9ncmVzcy5hZGRDb21wbGV0ZWQoMSk7XG4gICAgICB9XG4gICAgICBjb25zdCBpdGVtcyA9IHRoaXMuaXRlbXMoZ3JhcGgsIHJhbmRvbSk7XG4gICAgICBsZXQgaGFzID0gQml0cy5mcm9tKG5ldyBTZXQoaXRlbXMpKTtcbiAgICAgIGNvbnN0IGZpbGw6IEluZGV4RmlsbCA9IG5ldyBHZW5lcmljRmlsbCgpO1xuXG4gICAgICAvLyBJbml0aWFsaXplIGZpbGwgd2l0aCBub24tc2h1ZmZsZWQgaXRlbXMuXG4gICAgICBjb25zdCBpdGVtSW5kZXggPSBuZXcgTWFwPEl0ZW1JZCB8IFNsb3RJZCwgSXRlbUluZGV4PigpO1xuICAgICAgY29uc3Qgc2xvdEluZGV4ID0gbmV3IE1hcDxJdGVtSWQgfCBTbG90SWQsIFNsb3RJbmRleD4oKTtcbiAgICAgIGNvbnN0IG5vblNodWZmbGVkSXRlbXM6IEl0ZW1JZFtdID0gW107XG4gICAgICBmb3IgKGxldCBpID0gZ3JhcGguZml4ZWQgYXMgSXRlbUluZGV4OyBpIDwgZ3JhcGguaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgaWQgPSBncmFwaC5pdGVtc1tpXS5pdGVtO1xuICAgICAgICBpZiAoaWQgPT0gbnVsbCkgY29udGludWU7XG4gICAgICAgIGl0ZW1JbmRleC5zZXQoaWQsIGkpO1xuICAgICAgICBpZiAoIXRoaXMuc2h1ZmZsZVJ1bGVzLnNob3VsZFNodWZmbGUoaWQpKSBub25TaHVmZmxlZEl0ZW1zLnB1c2goaWQpO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGxldCBzID0gZ3JhcGguZml4ZWQgYXMgU2xvdEluZGV4OyBzIDwgZ3JhcGguc2xvdHMubGVuZ3RoOyBzKyspIHtcbiAgICAgICAgY29uc3QgaWQgPSBncmFwaC5zbG90c1tzXS5pdGVtO1xuICAgICAgICBpZiAoaWQgIT0gbnVsbCkgc2xvdEluZGV4LnNldChpZCwgcyk7XG4gICAgICB9XG5cbiAgICAgIGZvciAoY29uc3QgaWQgb2Ygbm9uU2h1ZmZsZWRJdGVtcykge1xuICAgICAgICBjb25zdCBpID0gaXRlbUluZGV4LmdldChpZCk7XG4gICAgICAgIGNvbnN0IHMgPSBzbG90SW5kZXguZ2V0KGlkKTtcbiAgICAgICAgaWYgKHMgPT0gbnVsbCB8fCBpID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgICBmaWxsLnNldChzLCBpKTtcbiAgICAgICAgaGFzID0gQml0cy53aXRob3V0KGhhcywgaSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmZsYWdzLmd1YXJhbnRlZVN3b3JkKCkpIHtcbiAgICAgICAgLy8gcGljayBhIHN3b3JkIGF0IHJhbmRvbSBhbmQgcHV0IGl0IGluIHNsb3QgMFxuICAgICAgICBjb25zdCBzd29yZCA9IHJhbmRvbS5uZXh0SW50KDQpIGFzIEl0ZW1JZDtcbiAgICAgICAgY29uc3QgaSA9IGl0ZW1JbmRleC5nZXQoc3dvcmQpO1xuICAgICAgICBjb25zdCBzID0gc2xvdEluZGV4LmdldCgwIGFzIFNsb3RJZCk7IC8vIGVsZGVyIG5vcm1hbGwgZ2l2ZXMgc3dvcmQgb2Ygd2luZFxuICAgICAgICBpZiAoaSAhPSBudWxsICYmIHMgIT0gbnVsbCAmJiAhZmlsbC5oYXNTbG90KHMpICYmICFmaWxsLmhhc0l0ZW0oaSkpIHtcbiAgICAgICAgICBmaWxsLnNldChzLCBpKTtcbiAgICAgICAgICBoYXMgPSBCaXRzLndpdGhvdXQoaGFzLCBpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBUT0RPOiBpZiBleGl0cyBzaHVmZmxlZCB0aGVuIGZpbmQgYSBzbG90IGluIHplcm8tc3BoZXJlLlxuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMuZmlsbEludGVybmFsKGdyYXBoLCByYW5kb20sIGZpbGwsIGl0ZW1zLCBoYXMsIE1hdGguZmxvb3IoYXR0ZW1wdCAvIDUpKSkgY29udGludWU7XG5cbiAgICAgIGNvbnN0IGZpbmFsID0gdHJhdmVyc2UoZ3JhcGgsIGZpbGwsIEJpdHMub2YoKSk7XG4gICAgICBpZiAoZmluYWwuc2l6ZSAhPT0gZ3JhcGguc2xvdHMubGVuZ3RoKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ3VuZXhwZWN0ZWQgc2l6ZSBtaXNtYXRjaCEnLCBmaW5hbCwgZ3JhcGgpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG91dCA9IHRoaXMuZmlsbChncmFwaCwgZXhwYW5kRmlsbChncmFwaCwgZmlsbCksIHJhbmRvbSk7XG4gICAgICBpZiAob3V0ID09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgaWYgKHByb2dyZXNzKSBwcm9ncmVzcy5hZGRDb21wbGV0ZWQoTWF0aC5mbG9vcigoYXR0ZW1wdHMgLSBhdHRlbXB0KSAvIDEwMCkpO1xuICAgICAgcmV0dXJuIG91dDtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcm90ZWN0ZWQgZmlsbEludGVybmFsKGdyYXBoOiBHcmFwaCxcbiAgICAgICAgICAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICBmaWxsOiBJbmRleEZpbGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXM6IEl0ZW1JbmRleFtdLFxuICAgICAgICAgICAgICAgICAgICAgICAgIGhhczogQml0cyxcbiAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrU3RlcHM6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGZvciAobGV0IGJpdDogSXRlbUluZGV4IHwgdW5kZWZpbmVkID0gaXRlbXMucG9wKCk7IGJpdCAhPSBudWxsOyBiaXQgPSBpdGVtcy5wb3AoKSkge1xuICAgICAgaWYgKCFCaXRzLmhhcyhoYXMsIGJpdCkpIGNvbnRpbnVlOyAvLyBpdGVtIGFscmVhZHkgcGxhY2VkOiBza2lwXG4gICAgICBjb25zdCBpdGVtSWQgPSBncmFwaC5pdGVtc1tiaXRdLml0ZW07XG4gICAgICBpZiAoaXRlbUlkID09IG51bGwpIHRocm93IG5ldyBFcnJvcihgYmFkIGl0ZW06ICR7T2JqZWN0LmVudHJpZXMoZ3JhcGguaXRlbXNbYml0XSl9YCk7XG4gICAgICBoYXMgPSBCaXRzLndpdGhvdXQoaGFzLCBiaXQpO1xuICAgICAgY29uc3QgcmVhY2hhYmxlID0gWy4uLnRyYXZlcnNlKGdyYXBoLCBmaWxsLCBoYXMpXTtcbiAgICAgIHJhbmRvbS5zaHVmZmxlKHJlYWNoYWJsZSk7XG4gICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAoY29uc3Qgc2xvdCBvZiByZWFjaGFibGUpIHtcbiAgICAgICAgY29uc3Qgc2xvdElkID0gZ3JhcGguc2xvdHNbc2xvdF0uaXRlbTtcbiAgICAgICAgaWYgKHNsb3RJZCA9PSBudWxsKSBjb250aW51ZTtcbiAgICAgICAgaWYgKCFmaWxsLmhhc1Nsb3Qoc2xvdCkgJiYgdGhpcy5maXRzKHNsb3RJZCwgaXRlbUlkIC8qLCB0cnVlKi8pKSB7IC8vIHNsb3QgIT09IHRoaXMud2luICYmXG4gICAgICAgICAgZmlsbC5zZXQoc2xvdCwgYml0KTtcbiAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChmb3VuZCkgY29udGludWU7XG4gICAgICBpZiAoYmFja1N0ZXBzLS0gPiAwKSB7XG4gICAgICAgIC8vIHRha2UgYSBiYWNrIHN0ZXAuXG4gICAgICAgIGZvciAoY29uc3Qgc2xvdCBvZiByZWFjaGFibGUpIHtcbiAgICAgICAgICBjb25zdCBzbG90SWQgPSBncmFwaC5zbG90c1tzbG90XS5pdGVtO1xuICAgICAgICAgIGlmIChzbG90SWQgPT0gbnVsbCkgY29udGludWU7XG4gICAgICAgICAgaWYgKHRoaXMuZml0cyhzbG90SWQsIGl0ZW1JZCkpIHtcbiAgICAgICAgICAgIGNvbnN0IHByZXZpb3VzSXRlbSA9IGZpbGwuc2xvdHNbc2xvdF07XG4gICAgICAgICAgICBmaWxsLnNsb3RzW3Nsb3RdID0gZmlsbC5pdGVtc1twcmV2aW91c0l0ZW1dID0gdW5kZWZpbmVkIGFzIGFueTtcbiAgICAgICAgICAgIGhhcyA9IEJpdHMud2l0aChoYXMsIHByZXZpb3VzSXRlbSk7XG4gICAgICAgICAgICBpdGVtcy5wdXNoKHByZXZpb3VzSXRlbSk7XG4gICAgICAgICAgICByYW5kb20uc2h1ZmZsZShpdGVtcyk7XG4gICAgICAgICAgICBmaWxsLnNldChzbG90LCBiaXQpO1xuICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChmb3VuZCkgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyBUT0RPIC0gaXQgbG9va3MgbGlrZSB3ZSdyZSBwbGFjaW5nIHJhbmRvbSBpdGVtcyBpbiBtYWdpYyBzbG90cyB3aGVuIFNtIGlzIG9mZj8hP1xuICAgICAgLy8gICAgIC0tLS0+IGZpZ3VyZSBvdXQgd2hhdCB3YXMgcGxhY2VkIGluIGl0cyBzcG90P1xuICAgICAgLy8gY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHBsYWNlIGtleSBpdGVtICR7aXRlbUlkfTogYXZhaWxhYmxlICR7cmVhY2hhYmxlLm1hcChzID0+IGdyYXBoLnNsb3RzW3NdLml0ZW0pfWApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKiBGaWxzIHRoZSByZW1haW5pbmcgc2xvdHMgd2l0aCBub24tcHJvZ3Jlc3Npb24gaXRlbXMuICovXG4gIHByaXZhdGUgZmlsbChncmFwaDogR3JhcGgsIGZpbGw6IEZpbGwsIHJhbmRvbTogUmFuZG9tKTogRmlsbCB8IG51bGwge1xuICAgIC8vIEZpZ3VyZSBvdXQgd2hhdCBzdGlsbCBuZWVkcyB0byBiZSBmaWxsZWQuICBXaWxsIGJlIG1vc3RsdSBjb25zdW1hYmxlcyBvciBtaW1pY3MuXG4gICAgLy8gU3RhcnQgd2l0aCB1bmlxdWUgaXRlbXMgc2luY2Ugd2UgaGF2ZSBydWxlcyB0byBwcmV2ZW50IHB1dHRpbmcgdW5pcXVlcyBpbiBub24tdW5pcXVlXG4gICAgLy8gc2xvdHMgKGlmIHRoZSBmbGFnIGlzIHNldCkgYnV0IG5vdCB2aWNlIHZlcnNhLlxuICAgIGNvbnN0IHZhbGlkSXRlbXMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgICBmb3IgKGNvbnN0IHNsb3Qgb2YgZ3JhcGguc2xvdHMpIHtcbiAgICAgIGlmIChzbG90Lml0ZW0gIT0gbnVsbCkgdmFsaWRJdGVtcy5hZGQoc2xvdC5pdGVtKTtcbiAgICB9XG5cbiAgICBjb25zdCB1bmlxdWVzOiBJdGVtSWRbXSA9IFtdO1xuICAgIGNvbnN0IGNvbnN1bWFibGVzOiBJdGVtSWRbXSA9IFtdO1xuICAgIGNvbnN0IG1pbWljczogSXRlbUlkW10gPSBbXTtcbiAgICAvLyBlYXJseVNsb3RzIGFyZSBmaWxsZWQgZmlyc3QsIGlmIHRoZXkncmUgbm9uLWVtcHR5LlxuICAgIGNvbnN0IGVhcmx5U2xvdHM6IFNsb3RJZFtdID0gW107XG4gICAgY29uc3Qgb3RoZXJTbG90czogU2xvdElkW10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMCBhcyBTbG90SWQgJiBJdGVtSWQ7IGkgPCAweDdjOyBpKyspIHtcbiAgICAgIGlmIChpIDwgMHg3MCAmJiAhdmFsaWRJdGVtcy5oYXMoaSkpIHtcbiAgICAgICAgaWYgKGZpbGwuaGFzU2xvdChpKSAhPT0gZmlsbC5oYXNJdGVtKGkpKSBjb25zb2xlLmVycm9yKCdNSVNNQVRDSCcsaSk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKCFmaWxsLmhhc1Nsb3QoaSkgJiYgIWZpbGwuaGFzSXRlbShpKSAmJiAhdGhpcy5zaHVmZmxlUnVsZXMuc2hvdWxkU2h1ZmZsZShpKSkge1xuICAgICAgICBmaWxsLnNldChpLCBpKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoIWZpbGwuaGFzU2xvdChpKSkge1xuICAgICAgICBpZiAodGhpcy5zaHVmZmxlUnVsZXMuaXNFYXJseShpKSkge1xuICAgICAgICAgIGVhcmx5U2xvdHMucHVzaChpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdGhlclNsb3RzLnB1c2goaSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghZmlsbC5oYXNJdGVtKGkpKSB7XG4gICAgICAgIGlmIChpIDw9IDB4NDggJiYgdGhpcy5yb20uaXRlbXNbaV0udW5pcXVlKSB7XG4gICAgICAgICAgdW5pcXVlcy5wdXNoKGkpO1xuICAgICAgICB9IGVsc2UgaWYgKGkgPCAweDcwKSB7XG4gICAgICAgICAgY29uc3VtYWJsZXMucHVzaChpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtaW1pY3MucHVzaChpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByYW5kb20uc2h1ZmZsZShlYXJseVNsb3RzKTtcbiAgICByYW5kb20uc2h1ZmZsZShvdGhlclNsb3RzKTtcbiAgICByYW5kb20uc2h1ZmZsZSh1bmlxdWVzKTtcbiAgICByYW5kb20uc2h1ZmZsZShjb25zdW1hYmxlcyk7XG5cbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlcnMuY29uY2F0KHVuaXF1ZXMsIG1pbWljcywgY29uc3VtYWJsZXMpKSB7XG4gICAgICAvLyBUcnkgdG8gcGxhY2UgdGhlIGl0ZW0sIHN0YXJ0aW5nIHdpdGggZWFybGllcyBmaXJzdC5cbiAgICAgIC8vIE1pbWljcyBjb21lIGJlZm9yZSBjb25zdW1hYmxlcyBiZWNhdXNlIHRoZXJlJ3MgZmV3ZXIgcGxhY2VzIHRoZXkgY2FuIGdvLlxuICAgICAgLy8gU2luY2Uga2V5IHNsb3RzIGFyZSBhbGxvd2VkIHRvIGNvbnRhaW4gY29uc3VtYWJsZXMgKGV2ZW4gaW4gZnVsbCBzaHVmZmxlKSxcbiAgICAgIC8vIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgdGhlIHVuaXF1ZXMgZ28gaW50byB0aG9zZSBzbG90cyBmaXJzdC5cbiAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgICAgZm9yIChjb25zdCBzbG90cyBvZiBbZWFybHlTbG90cywgb3RoZXJTbG90c10pIHtcbiAgICAgICAgaWYgKGZvdW5kKSBicmVhaztcbiAgICAgICAgZm9yIChjb25zdCBzbG90IG9mIHNsb3RzKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZml0cyhzbG90LCBpdGVtIC8qLCBmYWxzZSovKSkge1xuICAgICAgICAgICAgZmlsbC5zZXQoc2xvdCwgaXRlbSk7XG4gICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICBzbG90cy5zcGxpY2Uoc2xvdHMuaW5kZXhPZihzbG90KSwgMSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgLy8gY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGZpbGwgZXh0cmEgaXRlbSAke2l0ZW19LiBTbG90czogJHtlYXJseVNsb3RzfSwgJHtvdGhlclNsb3RzfWApO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZpbGw7XG4gIH1cbn1cblxuLy8gZXhwb3J0IGNsYXNzIEZvcndhcmRGaWxsIGV4dGVuZHMgQXNzdW1lZEZpbGwge1xuLy8gICBwcm90ZWN0ZWQgZmlsbEludGVybmFsKGdyYXBoOiBHcmFwaCxcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICByYW5kb206IFJhbmRvbSxcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxsOiBJbmRleEZpbGwsXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXM6IEl0ZW1JbmRleFtdLFxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgIGhhczogQml0cyk6IGJvb2xlYW4ge1xuLy8gICAgIHdoaWxlICghQml0cy5lbXB0eShoYXMpKSB7XG4vLyAgICAgICAvLyBXaGF0J3MgcmVhY2hhYmxlIHdpdGggbm90aGluZz9cbi8vICAgICAgIGNvbnN0IHJlYWNoYWJsZSA9IFsuLi50cmF2ZXJzZShncmFwaCwgZmlsbCwgQml0cy5vZigpKV07XG4vLyAgICAgICAvLyBXaGF0IGFyZSB0aGUgaW1tZWRpYXRlIGJsb2Nrcz8hPyBOZWVkIHRvIGFkZCBhbiBBUEkgdG8gZ2V0IHRoZXNlP1xuLy8gICAgICAgLy8gVHJhbnNsYXRlIHJlYWNoYWJibGUgaW50byBhIFwiaGFzXCJcbi8vICAgICAgIGxldCBnZXR0YWJsZSA9IEJpdHMuZnJvbShcbi8vICAgICAgICAgICByZWFjaGFibGUubWFwKHMgPT4gcyA8IGdyYXBoLmZpeGVkID8gcyA6IGZpbGwuc2xvdHNbc10pLmZpbHRlcihpID0+IGkpKTtcbi8vICAgICAgIGxldCB1bmxvY2tzID0gbmV3IFNldDxJdGVtSW5kZXg+KCk7XG4vLyAgICAgICBjb25zdCB1bmxvY2tzMiA9IG5ldyBTZXQ8SXRlbUluZGV4PigpO1xuLy8gICAgICAgZm9yIChsZXQgcyA9IDAgYXMgU2xvdEluZGV4OyBzIDwgZ3JhcGguZ3JhcGgubGVuZ3RoOyBzKyspIHtcbi8vICAgICAgICAgZm9yIChjb25zdCByb3V0ZSBvZiBncmFwaC5ncmFwaFtzXSkge1xuLy8gICAgICAgICAgIGNvbnN0IGJpdHMgPSBCaXRzLmJpdHMoQml0cy5kaWZmZXJlbmNlKHJvdXRlLCBnZXR0YWJsZSkpIGFzIEl0ZW1JbmRleFtdO1xuLy8gICAgICAgICAgIGlmIChiaXRzLmxlbmd0aCA9PT0gMSkgdW5sb2Nrcy5hZGQoYml0c1swXSk7XG4vLyAgICAgICAgICAgaWYgKGJpdHMubGVuZ3RoID09PSAyKSB7XG4vLyAgICAgICAgICAgICB1bmxvY2tzMi5hZGQoYml0c1swXSk7XG4vLyAgICAgICAgICAgICB1bmxvY2tzMi5hZGQoYml0c1sxXSk7XG4vLyAgICAgICAgICAgICAvLyBUT0RPIC0gbXVsdGltYXAsIGFuZCB0aGVuIGdvIHdpdGggaXRlbSB0aGF0J3MgbGVhc3QgZXZlbnRmdWxcbi8vICAgICAgICAgICB9XG4vLyAgICAgICAgIH0gICAgICAgIFxuLy8gICAgICAgfVxuXG4vLyAgICAgICAvLyBQaWNrIGFuIHVubG9ja2FibGUgYW5kIGEgc2xvdC5cbi8vICAgICAgIGNvbnN0IGFsbEl0ZW1zID0gWy4uLih1bmxvY2tzLnNpemUgPyB1bmxvY2tzIDogdW5sb2NrczIpXTtcbi8vICAgICAgIGNvbnN0IGl0ZW0gPSBhbGxJdGVtc1tyYW5kb20ubmV4dEludChhbGxJdGVtcy5sZW5ndGgpXTtcbiAgICAgIFxuLy8gICAgIC8vICAgcmFuZG9tLnNodWZmbGUocmVhY2hhYmxlKTtcbi8vICAgICAvLyAgIGxldCBmb3VuZCA9IGZhbHNlO1xuLy8gICAgIC8vICAgZm9yIChjb25zdCBzbG90IG9mIHJlYWNoYWJsZSkge1xuLy8gICAgIC8vICAgICBjb25zdCBzbG90SWQgPSBncmFwaC5zbG90c1tzbG90XS5pdGVtO1xuLy8gICAgIC8vICAgICBpZiAoc2xvdElkID09IG51bGwpIGNvbnRpbnVlO1xuLy8gICAgIC8vICAgICBpZiAoIWZpbGwuaGFzU2xvdChzbG90KSAmJiB0aGlzLmZpdHMoc2xvdElkLCBpdGVtSWQgLyosIHRydWUqLykpIHsgLy8gc2xvdCAhPT0gdGhpcy53aW4gJiZcbi8vICAgICAvLyAgICAgICBmaWxsLnNldChzbG90LCBiaXQpO1xuLy8gICAgIC8vICAgICAgIGZvdW5kID0gdHJ1ZTtcbi8vICAgICAvLyAgICAgICBicmVhaztcbi8vICAgICAvLyAgICAgfVxuLy8gICAgIC8vICAgfVxuLy8gICAgIC8vICAgaWYgKCFmb3VuZCkge1xuXG4vLyAgICAgLy8gICAgIC8vIFRPRE8gLSBpdCBsb29rcyBsaWtlIHdlJ3JlIHBsYWNpbmcgcmFuZG9tIGl0ZW1zIGluIG1hZ2ljIHNsb3RzIHdoZW4gU20gaXMgb2ZmPyE/XG4vLyAgICAgLy8gICAgIC8vICAgICAtLS0tPiBmaWd1cmUgb3V0IHdoYXQgd2FzIHBsYWNlZCBpbiBpdHMgc3BvdD9cblxuLy8gICAgIC8vICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gcGxhY2Uga2V5IGl0ZW0gJHtpdGVtSWR9OiBhdmFpbGFibGUgJHtyZWFjaGFibGUubWFwKHMgPT4gZ3JhcGguc2xvdHNbc10uaXRlbSl9YCk7XG4vLyAgICAgLy8gICAgIHJldHVybiBmYWxzZTtcbi8vICAgICAvLyAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgXG4vLyAgICAgLy8gfVxuXG5cbi8vICAgICBmb3IgKGxldCBiaXQ6IEl0ZW1JbmRleCB8IHVuZGVmaW5lZCA9IGl0ZW1zLnBvcCgpOyBiaXQgIT0gbnVsbDsgYml0ID0gaXRlbXMucG9wKCkpIHtcbi8vICAgICAgIGlmICghQml0cy5oYXMoaGFzLCBiaXQpKSBjb250aW51ZTsgLy8gaXRlbSBhbHJlYWR5IHBsYWNlZDogc2tpcFxuLy8gICAgICAgY29uc3QgaXRlbUlkID0gZ3JhcGguaXRlbXNbYml0XS5pdGVtO1xuLy8gICAgICAgaWYgKGl0ZW1JZCA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYGJhZCBpdGVtOiAke09iamVjdC5lbnRyaWVzKGdyYXBoLml0ZW1zW2JpdF0pfWApO1xuLy8gICAgICAgaGFzID0gQml0cy53aXRob3V0KGhhcywgYml0KTtcbi8vICAgICAgIGNvbnN0IHJlYWNoYWJsZSA9IFsuLi50cmF2ZXJzZShncmFwaCwgZmlsbCwgaGFzKV07XG4vLyAgICAgICByYW5kb20uc2h1ZmZsZShyZWFjaGFibGUpO1xuLy8gICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4vLyAgICAgICBmb3IgKGNvbnN0IHNsb3Qgb2YgcmVhY2hhYmxlKSB7XG4vLyAgICAgICAgIGNvbnN0IHNsb3RJZCA9IGdyYXBoLnNsb3RzW3Nsb3RdLml0ZW07XG4vLyAgICAgICAgIGlmIChzbG90SWQgPT0gbnVsbCkgY29udGludWU7XG4vLyAgICAgICAgIGlmICghZmlsbC5oYXNTbG90KHNsb3QpICYmIHRoaXMuZml0cyhzbG90SWQsIGl0ZW1JZCAvKiwgdHJ1ZSovKSkgeyAvLyBzbG90ICE9PSB0aGlzLndpbiAmJlxuLy8gICAgICAgICAgIGZpbGwuc2V0KHNsb3QsIGJpdCk7XG4vLyAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuLy8gICAgICAgICAgIGJyZWFrO1xuLy8gICAgICAgICB9XG4vLyAgICAgICB9XG4vLyAgICAgICBpZiAoIWZvdW5kKSB7XG5cbi8vICAgICAgICAgLy8gVE9ETyAtIGl0IGxvb2tzIGxpa2Ugd2UncmUgcGxhY2luZyByYW5kb20gaXRlbXMgaW4gbWFnaWMgc2xvdHMgd2hlbiBTbSBpcyBvZmY/IT9cbi8vICAgICAgICAgLy8gICAgIC0tLS0+IGZpZ3VyZSBvdXQgd2hhdCB3YXMgcGxhY2VkIGluIGl0cyBzcG90P1xuXG4vLyAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBwbGFjZSBrZXkgaXRlbSAke2l0ZW1JZH06IGF2YWlsYWJsZSAke3JlYWNoYWJsZS5tYXAocyA9PiBncmFwaC5zbG90c1tzXS5pdGVtKX1gKTtcbi8vICAgICAgICAgcmV0dXJuIGZhbHNlO1xuLy8gICAgICAgfVxuLy8gICAgIH1cbi8vICAgICByZXR1cm4gdHJ1ZTtcbi8vICAgfVxuLy8gfVxuIl19